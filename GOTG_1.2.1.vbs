'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWNNNXXK0000KKK0OOOOOOOOOOkkOkkkkkkO0OOOO0KXXNNWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMWWNNXXXKKXXXXXXXXXXXXXXXXXNNXNXXXXXXKKKKKKK000OOOkkkkkkkOOOO00KKXNNWMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMWWNXKKK000000KKXNNNWWWWWWXOkxxdddkXNNX0dccc:::cokKK0OdooxOOOOkkkkkxxxxxxxxkO00KXNWMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMWNNXK00OOOOO000KKK0Oxdoc:lkNWWNd.....  'xXXXk'   ... .cOK0k;..lOOOxc,,,;:coxkkkxxxxdddxkO0KXNWMMMMMMMMMMMMM
'MMMMMMMMMWNKK0OOOOO0000OxodOKK0o'....  :KWWNd. ;oo, .dXXXk'  'dkc. :OKKk; .lOOko.  ..  .lkOkdc:clddddddxxxkOKXNWMMMMMMMM
'MMMMMWXK0OOkOOOOOkocok0x' ,kKK0c..;dl. ;KWWNo. .,'. 'kXXXk'  ,kKo. :0KKk, .lOOOo. .::' .:xkkl.  .:c;,cdddddoooxk0XNWMMMM
'MWNK0OkOOOkxdkOOOd' ,x0d. ,kKK0c. ...  ;KWWNd. .;;. 'kXXXk'  ,k0l. :0KKk; .lO0Oo.  ... .:xkxl.   .,. ,dxddocclooodxO0XWM
'XOOkOOkdl;'..lOOOd. ,x0d. ,kKK0c. 'c:. ;KWWNd..lXKc .dXXXk'  .,,.  :OKKk; .lOOOo. .;;. .:xkkl.  . .. 'oxdo,...';:loodxk0
'OkOOxc'...';cxOO0d. ,x0d. ,kKK0c..oXO, ;KWWNd..dXXo.,kXXXO:','....;x000k:..lOOOo. ,dd; .:xkko. .'.   'ldxd,  .....;lddoo
'kkOOo. .ldoc:dO00d. 'dxc. ,kKK0l..dNKl:dXWWWKkkKNNK00XXXKOO00xoxOO0K0000kooxOOOd:,:dd;..:xxko. .c,   .lodd, .':;,',looll
'dk0Oo. ,xk:..lO0Od. ......lOKKKkdkKNNNXNNNXXK00OkkxxdddddOKOxxdollooooodddxxxkkkxxxxxdlloxxxl'.'ll.  'loddc'....',:loolc
'dkOOo. ,xx; .lOOOxc',:clox0000Okkxdolc::;;,'........   'd0d,.'cl,.     .......''',,;;:cloodddollooc'.,lddoc;;;,'. 'lolll
'dkOOo. .,'. .oO000OOOOOkdol:;,'...                    'd0o.   'lo,.                    ....',;:clooooooodo,. ...  .looll
'dO0Oo.  ..;cdO0Okxol:,'...           ................'dOo. ....'lo;.    ..                      ..',;:clodoc;'..  ,odool
'dOOOkl:ldkOkxdc;'..      ...........'...............'oOo. 'lo:..,ll,.      ..      ..                 ..';cllllc::coooll
'dkO000Okdc;'..   .................'lx:............ .lko. 'oxxd;..,ll'...          .;:..                    ..',:clllllll
'xOOOOd;..      ...................;d0k:............ckd'..okxxxl'..;oc.           .;l:,.     .                   .':llllc
'kOO0k:      ......................ldx0k:..........:kx,..lkkxxxdc. .:oc.         .;ol:;.                ...        ,oddol
'OO00O:.  ..............'.........;dl,lOOc........;xk:..:xkkkxxdo:. .cl;.       .:oc',;,..                         ,loolc
'Ok00Oc.  ........................cd:..cOOc......'oOl. ,dkkkkxxddo;..,ll'.     .:l:. .;;.                         .,lllcc
'Ok00Ol.  ..............;,.......'od;. .;xOl'....cOx, .okkkkkxxdddl'..:oc.    'cl;.  .,:'.      .'.     ...    .. .,lllcl
'Ok00Oo.  .............'od;......,dd;.  .,dOd,..,xOc..:kOOkkkkxdddo:..'co;. .,cc,.   .,:,.     .;:'     ..        .;lll:o
'OxOOOd.  .............;dOk:.....;xd;..'...oOx:'lOd' ,dOOOkkkkxxdddo,..;ol'.;lc'.... .':;.    .;lc'.              .;llccd
'0xOOOd'   ............;dk0Oc....:xx:..lx;..ckkxOOc..ckOOOkkkkkxxxddc...coccl:. .,;'..,c;.   .:ol:'.              .:lllck
'KkOOOx,   .......... .:dookOl'..;xx:..lKOc..,d0Kx' 'dOOkkkkxxxxxxddo,..;odl;. .;::'..,c;. .'cl:,;,. .            .cllcck
'XkkOOk:.   ......... .:dc.'okd;.;dkc..c0X0o'..lkl..ckOOOOkdoldxdxddd:..'cc'..':c:;. .,c,..;lc'..;;.              'cllcl0
'NkxOOkc.   ......... .:o:. .;ddccdko'.;OXXKx;..,'.'dOOOOOko;;lddxdddl'..'. .:lccc;. .;c;,cl;.  .;,.   ..        .,lllcdX
'WOxOOOo.  .......... .:dc.   .:dxkkd,.,kXXKKOc.. .:kOOOOOkc'.:ddxdddd:....,cllccc,. .:clc:'   .';,.   ...       .;lllcdN
'W0xkOOx,  .......... .;dl. ....'lxkx;..oKXKKK0d,..oOOOOOOx:..;dxxxdddl,..:oollcc:'. 'cc:,. .. .';,.    ... ..   .:ollcdN
'MKxkOOk;   ...........,oo,..lo'..,oxc..c0XKKKK0kccx0OOOOOd,..'lxxxdddo:;cooollcc;. .,:,. ..'. .,;'.     .       'coollOW
'MXkkOOkc.   ..... ....'ld:..l0Ol'..:c' 'xXKKKKKK0O00OOOOOo'. .cdxdddddoodddollcc,. .,. .';:,. .;;'.       ..   .,cllcdXM
'MWOxOOOo.   .,,.      .:dl..,kK0xc......l0KKKKKKKK00OOOOkc.. .:dxddddddddooollc:. .....:llc'..';;.      ..'..  .:llllkWM
'MMKxkOOx;   .;ol,.    .,od;..l000Od:....;kKKKKKKKK00OOOOx:....;oxdddddddoooollc,. ...;cccc;. .,:'.......,c:... 'colllOWM
'MMXkkOOkc.   'lkxl,.   .cdl. 'd000Oko;...l0KKKKKKK000OOOd,....,oxxxxddddoooool;. ..,:cccc:'..';;......,clc,....,ooolo0MM
'MMNOxkOOo.   .:dxkko;...,ld:..;xOOOOOko;.,x0KKKKKK00OOOOo'....'oxxxxddddoooolc'..,:cccccc;. .;;'. ..;cllc;'....;lllcdXMM
'MMMKxkOOx;   .,ol;:oxdc,':oo,..ckOOOOOOko:lOKKKKKK00OOOkc......cddddddddooool;',:ccc:ccc:...,;,..,:c:;',:;....'cllllOWMM
'MMMNkxOOkl.   .ll'...;lddoddl'..lkOOOOO00OxO0KKKKKK00OOx:......:dddddddoooooc:ccccccccc:'..'::::::,....,:,....;lllcoXMMM
'MMMW0xkOOx,   .:o:.  ...;coddc'..lkOkOO0000KKKKKKKK00OOd,......,odddddoooooollcc:ccccc:,...;c:;,.... .'::'....:lllckWMMM
'MMMMXkkOOkc.   ,ol' .::'...';:;..'lkkOO000KK0KKKKKK00OOo'......'ldddddoooooollcc::c:c:,...,,'....','..:c;....,lllcoKMMMM
'MMMMW0xkOOd'   .cd:..ckxoc,...... .lkOO000K00KKKKKK000kc........cddddddooooollcc:::::'.......',;::;..'::,....:lllckWMMMM
'MMMMMXkkOOkc.   ,oc. ,dkkxdol:,.....lkO00000KKKKKKKK00k:........;dddddddoooolccc:::;.....',;:::::;'..;c;'...,lllcl0MMMMM
'MMMMMW0xkOOx,   .co,..ckkxdddddol:,''ck00kodOKKKKXKK00x,........,oddddddoool::cc::,..',::cc::::::,..'::,....:llllkWMMMMM
'MMMMMMNkxOOOl.  .,o:. 'okxxddddddxxxooxO00o,:x0KXXKK00o'........'lddddddooc,':c:::;;:ccccc::::::;...;:;'...,lllcoKMMMMMM
'MMMMMMW0xO00k,   .:l,..;dxxddddddxxkkOO000Oc..:xKXXKKOc..........cdddddoc,..;lcc::cccccccc::::::,..'::,...'cllll0WMMMMMM
'MMMMMMMNOk00Oo.  .'lc. .cxxddddddxxkkkO0000k:..'lkKKKk:..........;ddddl;...;llcc::ccccccc::::::;...;:;'...;lllcxNMMMMMMM
'MMMMMMMMXkkOOk:.  .;l;. 'oxddddddxxkkkO00000x;. .'oO0x;..........,odo:'...,llccc:ccccccccc::::;'..,:;'...,llllo0MMMMMMMM
'MMMMMMMMW0xkOOd,   .:l,..;dxdddddxxkkOO00KKK0x,.  .,ol'..........'cc'....,lolcc:::::cccccc::::,..';;'...'cllllOWMMMMMMMM
'MMMMMMMMMNOxOOkl.   .cc'..cdxdddxxxkOOO000K0K0d,..................'.....'coolccc::::ccccc::::;...,;,'...:lollxNMMMMMMMMM
'MMMMMMMMMMXkxOOkc.   ,lc. .lddddxxxkkOO00K00KK0o'......................'cooolcc:::::::::::::;'..,;''...,lolcoKMMMMMMMMMM
'MMMMMMMMMMMXkocc:.   .,c;..,ldddxxxkkOO00KK00KK0l'........'''.........':ooollcc::::::cccc::;'..,,'.....;;;cxKWMMMMMMMMMM
'MMMMMMMMMMMMKo::,..   .... ..,,,;;:cloodxkOOO00KOc........'''''''''...:oolllc::;;,,,,,,,'''....'..''.....'lXMMMMMMMMMMMM
'MMMMMMMMMMMMWOxkkxl.               .......'',;::c:'......''''''''''..';;,,''.........................;:cclkNMMMMMMMMMMMM
'MMMMMMMMMMMMMNOxOOOl.   .',..     ...  ................'''''''''''..........................',,''...:looldXMMMMMMMMMMMMM
'MMMMMMMMMMMMMMNOxOOkc.  .'cl,...''.................'''.''..'''.'''..................'',,'..';,'....;looldKMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMXkkOOkc.  .'cl,..;odol:;,'...........''......'...''.............',,;::::;..',,'....;looldKWMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMXkkOOk:.  .'cl,..;oxkkOOkxoc;,'.........'..'''............',;;::cc::::,...,,'....,looloKWMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMXkkOOk:.  .'cl;..,oxkOO0KKK0Okdoc:,................',;:cllllcc:::::;,...,,'''..,loolo0WMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMXkkOOk:. ..'co:..,okOO0KKKKKKKXXXKOxc'........';cloodoolllccc::::;'...,,'''..;looldKWMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMXkkOOkc. ..'coc'.'lkO0KKKKKKKXXNNNNO;........;odddooollllccc:::;'..',,'''..;oooloKWMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMXOkOOkl. ...:ol,..ck0KKKKKKKKXNNNNKl........cdddoooollllccc::,...',,'','.:oooldKWMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMNOkO0Oo'. ..,ll;..;dOKKKKKKKXXNNNXx'......'ldddooolllllcc:;'...'''....'codolxXMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMW0kO00x;. ..'coc'..ckKKKKKKXXNWNNO:......:ddddoooollllc:;...',''....,lddookNMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMWKkk00Ol.....;lo;..;d0KKKKXXNNWNKo......lxddooooolllc:,...,,'.....;oddod0WMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMXOk0KKx,. ..'cdl,..ck0KKKXNNWNXk,....,oxdddooolllc;...',,'....'cdddodKWMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMN0kOKKOc.  ..:odc'.'lOKKXXNWNX0c....;dxdddoooll:'..',,'.....,lddookXMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMWXOOKK0d,. ..'cxxc..,oOKXNNNNKd'...cxxxddool:,..',;,'....'cdddoo0WMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMN0OKXXOc.  ..,okx:..,oOXNNNXO;..,dkxxddoc,..';:;'.....;ldxdokXWMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKO0XNXx;. ...:xkd:..,o0NNNKl'.cxkxxoc,..';::,.....,cdxddd0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN00KNNKd,....':dkxc'.,lOXXxccdkxo:'..';c:,'....'cdxxddkXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX00XWNKo'.....;oxxl,.':dkkkko:'..,:c:,'....':oxxddxKWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWK0KNWN0l'.....,lxkxc'.,::;..':cc:,'''..':oxxxdx0NMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNK0XNWN0l'.....,cxOOd:'.';lol:,''''.':dOOkddONMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNKKXNWN0o,....',:okOkxxoc:,,','',:dkkkxxOXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNK0KNNN0o;...''',cool;,,,,'';ldkOkxxOXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNK0KNNNKx:'..''',,,,,,',:okOOkxxOXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNKKKNNNXOo;''',,,'';lx0KKOkk0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNXKKNWWNKxc,'.':oO000OkOKNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXKKXWWWN0kxk0KK0OkOKWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNKKXNWWNNNK0Ok0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWXKXXNNKOOKNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX0OOO0NMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
' ****************************************************************
'                         VISUAL PINBALL X
'                 Guardians of the Galaxy Script
'           By Daphishbowl and Mr H
'             (Started from JPSalas GhostBusters)
'                         Version 1.2.1
'
' Special thanks to:
'   Arngrim         DOF help
'   Nailbuster        Amazing work on the PUP framework and helping me get all those nice little features working so it feels like the real thing,
'   Rik           Amazing testing
'   Orbital Group     Awesome help with my first table and alpha testing (John M, G5K, Pinballfan2018, Scott, Bambi, Brian, James,  .. the names go on)
'   VAAS          PupFrame
'   wAxx          Physics and tweaks
'   Ashtone6        Awesome highres photos of the real table
'   Al            Help cleaning up Pup Graphics
'   MPT3k         Gameplay from real table
'   Terry         Massive amount of support and help for release
' ****************************************************************
Option Explicit
Randomize

Const bCompetitionMode      = False ' Start with Competition Rules (Cant select mode from Drain, Only save progress if > 50%)
Const bUsePlungerForSternKey  = False ' Defaults to Right Magna Button but you can use Plunger button also
Const kBallSearchTimeout    = 15000 '  Start ball search after 15 seconds of no activity
Const DMDMode         = 2   ' 0=None, 1 = Ultra, 2=PUP (make sure you set PuPDMDDriverType below)
Const doCallouts        = False ' Play random GOTG callouts during the game
Const bUseClelandMusic      = False ' Use the Cleland music update
Const bNudgeShake       = True  ' Nudge table for SSF when the motor "shakes"
Const bFlipperSkipEnabled     = True  ' Skip scenes
Const AlternateSettings     = 0   ' Reserved for different setting preferences
                    ' 0=Default,1=wAxx (Dark Settings)
Const FontScale         = 1   ' Scales the PupFonts up/down for different sized DMDs    [Desktop 0.75]
Const FontScaleDmd        = 1   ' Scales the SlimDMDFonts up/down for different sized DMDs  [Desktop 0.5]
Const osbactive         = 0   ' Orbital Scoreboard: Set to 0 for off, 1 for only player 1 to be sent, 2 for all scores to be sent.
                    '     See link to create obs.vbs: https://docs.orbitalpin.com/vpx-user-settings
Const VRRoom          = False ' Turns on VR Room and Cabinet.   VPVR must also be set for desktop play.
Const AltBlades         = True  ' Displays alternate sideblades.

'**************************
'   UltraDMD USER Config
'**************************
Const UseFullColor = "True"       ' ULTRA: Enable full Color on UltraDMD "True" / "False"
Const UltraDMDVideos = True       ' ULTRA: Works on my DMDv3 but seems it causes issues on others
'**************************
'   PinUp Player USER Config
'**************************
dim PuPDMDDriverType: PuPDMDDriverType=0   ' 0=LCD DMD, 1=RealDMD (For FULLDMD use the batch scripts in the pup pack)
dim useRealDMDScale : useRealDMDScale=0    ' 0 or 1 for RealDMD scaling.  Choose which one you prefer.
dim useDMDVideos    : useDMDVideos=True    ' true or false to use DMD splash videos.
Dim pGameName       : pGameName="gotg"     ' pupvideos foldername, probably set to cGameName in realworld
'***********TABLE VOLUME LEVELS *********
' [Value is from 0 to 1 where 1 is full volume.
' NOTE: you can go past 1 to amplify sounds]

' Desktop Volumes
'Const VolBGMusic = 0.5  ' Volume for Video Clips
'Const VolMusic1 = 0.4  ' Volume for Cleland or Original Gameplay music
' Cab Volumes
Const VolBGMusic = 0.9  ' Volume for Video Clips
Const VolMusic1 = 0.7 ' Volume for Cleland or Original Gameplay music

Const VolDef = 0.2    ' Default volume for callouts
Const VolSfx = 0.2    ' Volume for table Sound effects


Const BallSize = 50    ' 50 is the normal size
Const BallMass = 1.3     ' 1 is normal ball

'********* UltraDMD **************
Dim UltraDMD:UltraDMD=0
Const UltraDMD_VideoMode_Stretch = 0
Const UltraDMD_VideoMode_Top = 1
Const UltraDMD_VideoMode_Middle = 2
Const UltraDMD_VideoMode_Bottom = 3
Const UltraDMD_Animation_FadeIn = 0
Const UltraDMD_Animation_FadeOut = 1
Const UltraDMD_Animation_ZoomIn = 2
Const UltraDMD_Animation_ZoomOut = 3
Const UltraDMD_Animation_ScrollOffLeft = 4
Const UltraDMD_Animation_ScrollOffRight = 5
Const UltraDMD_Animation_ScrollOnLeft = 6
Const UltraDMD_Animation_ScrollOnRight = 7
Const UltraDMD_Animation_ScrollOffUp = 8
Const UltraDMD_Animation_ScrollOffDown = 9
Const UltraDMD_Animation_ScrollOnUp = 10
Const UltraDMD_Animation_ScrollOnDown = 11
Const UltraDMD_Animation_None = 14
Const UltraDMD_deOn = 1500

'********* End UltraDMD **************

Const BlinkIntFast   = 70
Const BlinkIntDef    = 125
Const BlinkIntSlow   = 500
Const BlinkPatternDef  = 10
Const BlinkPatternSlow = 100

Dim luts, lutpos
luts = array("ColorGradeLUT256x16_1to1", "ColorGradeLUT_Bright2", "ColorGradeLUT_Bright", "ColorGradeLUT256x16_ConSat", "ColorGradeLUT256x16_HalfSat" )
lutpos = 0

'********* VR Room **************

If VRRoom = True Then 'Turns on VR Room and Cabinet
  Dim VRThings
  for each VRThings in VRStuff:VRThings.visible = 1:Next
  Flasherbase5.X = 468
  Flasherbase5.Y = 2330
  Flasherbase5.Z = 150
  Flasherlit5.X = 468
  Flasherlit5.Y = 2330
  Flasherlit5.Z = 150
  Flasherbase5.Size_X = 30
  Flasherbase5.Size_Z = 30
  Flasherlit5.Size_X = 30
  Flasherlit5.Size_Z = 30
  Flasherflash5.X = 468
  Flasherflash5.Y = 2330
  Flasherflash5.Height = 194
  FlasherFlash5_5.X = 468
  FlasherFlash5_5.Y = 2330
  FlasherFlash5_5.Height = 195
Else
for each VRThings in VRStuff:VRThings.visible = 0:Next
hadron001.height = 170
hadron001.Visible = True
Flasherbase5.X = 468
Flasherbase5.Y = 2330
Flasherbase5.Z = 150
Flasherlit5.X = 468
Flasherlit5.Y = 2330
Flasherlit5.Z = 150
Flasherbase5.Size_X = 22
Flasherbase5.Size_Z = 22
Flasherlit5.Size_X = 22
Flasherlit5.Size_Z = 22
Flasherflash5.X = 468
Flasherflash5.Y = 2330
Flasherflash5.Height = 194
FlasherFlash5_5.X = 468
FlasherFlash5_5.Y = 2330
FlasherFlash5_5.Height = 195
FireButtonBase.visible = 0


' Flasherbase5.X = 435
' Flasherbase5.Y = 2205
' Flasherbase5.Z = 70
' Flasherlit5.X = 435
' Flasherlit5.Y = 2205
' Flasherlit5.Z = 70
' Flasherbase5.Size_X = 20
' Flasherbase5.Size_Z = 20
' Flasherlit5.Size_X = 20
' Flasherlit5.Size_Z = 20
' Flasherflash5.X = 435
' Flasherflash5.Y = 2215
' Flasherflash5.Height = 120
' FlasherFlash5_5.X = 435
' FlasherFlash5_5.Y = 2205
' FlasherFlash5_5.Height = 121
End If

If AltBlades = True Then 'Displays alternate sideblades
  PinCab_Blades.image = "PinCab_Blades_GOTG"
End If

' DOF Notes
' DOF 129, DOFPulse
' DOF 140, DOFOn
' DOF 140, DOFOff
' PlaySoundAt SoundFXDOF("fx_flipperup", 101, [DOFOn, DOFOff, DOFPulse],
'   [DOFContactors, DOFKnocker, DOFChimes, DOFBell, DOFGear, DOFShaker, DOFFlippers, DOFTargets, DOFDropTargets]), LeftFlipper
' DOF are EXXX since this is an EM table
'

' Load the core.vbs for supporting Subs and functions
LoadCoreFiles

Sub LoadCoreFiles
    On Error Resume Next
    ExecuteGlobal GetTextFile("core.vbs")
    If Err Then MsgBox "Can't open core.vbs"
    ExecuteGlobal GetTextFile("controller.vbs")
    If Err Then MsgBox "You need the controller.vbs in order to run this table, available in the vp10 package"
    On Error Goto 0

  '============================'  Orbital Scoreboard'============================
  if osbactive = 1 or osbactive = 2 Then
    On Error Resume Next
    ExecuteGlobal GetTextFile("osb.vbs")
    On Error Goto 0
  end if

End Sub

Dim bDebugMode:bDebugMode = False   ' Magna buttons perform debug functions
' Define any Constants
Const cGameName = "gotg_2020"   ' Match DOF Config Tool
Const TableName = "gotg"
Const myVersion = "1.2.1"
Const MaxPlayers = 4      ' Max Players = 4 for now

' Define Global Variables
Dim bClelandMusic:bClelandMusic=bUseClelandMusic
Dim PlayersPlayingGame
Dim CurrentPlayer
Dim Credits
Dim BonusPoints(4)      '
Dim BonusHeldPoints(4)
Dim BonusMultiplier
Dim PlayMultiplier
Dim ModePoints
Dim ModePointsSave      ' Save off mode points for use later
Dim WizardModePoints
Dim WizardBonusPoints
Dim bBonusHeld
Dim BallsRemaining(4)
Dim ExtraBallsAwards(4)
Dim Score(4)
Dim HighScore(4)
Dim HighScoreName(4)
Dim TiltCount(4)
Dim Jackpot
Dim SuperJackpot
Dim Tilt
Dim TiltSensitivity
Dim Tilted
Dim TotalGamesPlayed
Dim mBalls2Eject
Dim SkillshotValue
Dim bCreatedBall  ' we just created a ball
Dim bAutoPlunger  ' Auto fire
Dim bAutoPlunged  ' Did AutoPlunger Fire
Dim bInstantInfo
Dim BumperMultiplier
dim bLaneSaverEnabled
Dim FlipperSkipCmd    ' Command to when you FlipperSkip
Dim VolMusic

Dim BonusArrowHits(9)   ' Holds the total # of hits during game play
Dim BonusModeTotal(9)   ' Holds the total bonus during gameplay
Dim BonusModeValue(9)   ' Holds the bonus value that will get added to the next mode bonus

' Define Game Control Variables
Dim LastSwitchHit
Dim BallsOnPlayfield
Dim BallsInLock       ' These are jsut virtual ones in groot
Dim RealBallsInLock     ' These are actually locked on the table
Dim BallsInHole
Dim GrootMBFinished       ' Did we complete GrootMB
Dim GrootMultiBallCount     ' How many times have we completed Groot MB
Dim GrootMBLocks        ' How many Groot Lock we have done during this groot MB. We can only lock it a total of 3 times in MB
Dim GrootMultiBallToggle
Dim OrbTarget1Toggle
Dim OrbMultiBallCount     ' How many times have we completed ORB MB
Dim OrbMultiBallProgress
Dim OrbMBJackpotHits
Dim OrbMBJackpot
Dim bOrbMultiBall
Dim bOrbDisabled
Dim SpellGuardians
Dim SpellRampage


' Define Game Flags
Dim bFreePlay
Dim bGameInPlay
Dim bGameInPlayHidden     ' We disable the table but this gets set to catch some special cases
Dim bShowMatch
Dim bOnTheFirstBall
Dim bBallInPlungerLane
Dim bBallSaverActive
Dim BallSaverActiveBuffer   ' Allows lanes to kick in ball saver
Dim bBallSaverReady
Dim bMultiBallMode
Dim bMusicOn

dim SuperSkillShotIndex
Dim bSkillshotsReady(3)

Dim bSkillshotReady
Dim bSkillShotPlayedOnce
Dim bExtraBallWonThisBall
Dim bJustStarted
dim bsTrough
Dim bSkipWaitVideo

Dim plungerIM 'used mostly as an autofire plunger
Dim ttable, cbleft, cbright
Dim x
'Dim HadronCount
Dim HadronEnforcerCount
'Dim Controller
Dim bTableReady
Dim bUseUltraDMD
Dim bUsePUPDMD
dim bPupStarted
dim sndGeneralHit
dim baHadronLightsSaved
dim baRampLightsSaved
dim baLightsSaved
dim HadronLightsSaveColor()
dim RampLightsSaveColor()
dim LightsSaveColor()
Dim YakaPops
Dim MusicDir

'*****************************************
'      Structure to save/restore all player data before moving to a new ones
' ***************************************

Const StackSize = 4   ' How Many Modes can be stacked  - Higher priority wins
Const kStack_Pri0 = 0   ' Base Modes
Const kStack_Pri1 = 1     ' Groot/Orb MB
Const kStack_Pri2 = 2     ' Wizard Modes
Const kStack_Pri3 = 3   ' Skillshot
Class cArrowState
  Public ArrowColor
  Public ArrowState
  Public MultipState
  Public NameState
End Class
Class cStack
  Public bStackActive         ' Is there a mode here actually stacked?
  Public ModeIndex          ' What is the index of this mode?
  Public ArrowStates(9)       ' What are the arrow states for this mode
  'This event is called when an instance of the class is instantiated
  Private Sub Class_Initialize(  )
    dim i
    For i = 0 to 8
      set ArrowStates(i) = New cArrowState
    Next
  End Sub
  Public Sub Reset()
    dim i
    bStackActive = False
    ModeIndex = -1
    For i = 0 to 8
      ArrowStates(i).ArrowColor = ""
      ArrowStates(i).ArrowState = 0
      ArrowStates(i).MultipState = 0  ' Color is always Green
      ArrowStates(i).NameState = 0  ' Color is always name color
    Next
  End Sub

  Public Function GetArrowState(light)
    dim lIndex
    lIndex = GetModeIndex(light.name)
    GetArrowState = ArrowStates(lIndex).ArrowState
  End Function
  Public Sub SetArrowState(light, state)
    dim lIndex
    lIndex = GetModeIndex(light.name)
    ArrowStates(lIndex).ArrowState = state
  End Sub

  Public Sub Enable (NewModeIndex)
    bStackActive = True
    ModeIndex = NewModeIndex
  End Sub


  Public Sub Disable()
    Reset
  End Sub
End Class
Public StackState(4)      ' Stores which modes are actually in play (stacked)

Sub SetLightColorRestore(light, lIndex)
  Dim finalColor
  Dim finalState
  Dim i
  if lIndex = -1 then           ' Got get it if they didnt already have it
    lIndex = GetModeIndex(light.name)
  End if

  finalState = 0
  finalColor = "white"          ' Should never need this line but just in case
  for i = 0 to StackSize-1        ' Set the real color and state based on the stack  (higher in the stack is higher prioroty)
    if StackState(i).bStackActive then
'     if StackState(i).ArrowStates(lIndex).ArrowColor <> "" then
'       finalColor = StackState(i).ArrowStates(lIndex).ArrowColor
'     End If
      if StackState(i).ArrowStates(lIndex).ArrowState <> 0 then
        finalState = StackState(i).ArrowStates(lIndex).ArrowState
        finalColor = StackState(i).ArrowStates(lIndex).ArrowColor
'debug.print "Stack: " & i & " lindex:" & lIndex & " state:" & finalState & " color:" & finalColor
      End If
    End If
  Next
'debug.print "SetLightColorRestore " & light.name & " state:" & finalState & " color:" & finalColor

  SetLightColor light, finalColor, finalState
End Sub

Sub SSetLightColor(stackIndex, light, color, state)   ' StackSetLightColor
  dim lIndex
  lIndex = GetModeIndex(light.name)
'debug.print "SSetLightColor " & stackIndex & " idx:" & lIndex & " " & light.name & " state:" & state
  if lIndex <> -1 then  ' We should never hit this
    StackState(stackIndex).ArrowStates(lIndex).ArrowColor = color
    StackState(stackIndex).ArrowStates(lIndex).ArrowState = state
    SetLightColorRestore light, lIndex
  else
'   MsgBox "Light Color Error:" & light.name & " idx:" & stackIndex & " " & lIndex
    debug.print "Light Color Error:" & light.name & " idx:" & stackIndex & " " & lIndex
  End If
End Sub

Const kYondu = 0
Const kRonan = 1
Const kRocket = 2
Const kNebula = 3
Const kGroot = 4
Const kBroker = 5
Const kGamora = 6
Const kDrax = 7
Const kStarLord = 8
Dim PlayerState(5)
Class TableState
  ' These should hold state of the current mode
  Public sBumperMultiplier
  Public bFirstBall
  Public ArrowColor
  Public lArrowStates(9)
  Public lNameStates(9)
  Public lHadronStates(5)
  Public lNovaStates(5)     ' Progress toward Multiplier2x
  Public lNovaStatesKyln(5)   ' Progress to Mode 5
  Public lGrootStabStates(2)
  Public lGrootMBState      ' If Groot Mouth is open and light is blinking
  Public bExtraball_1       ' Triggered - Groot or Orb MB Extra Ball
  Public bExtraball_2       ' Triggered 3 Modes are started
  Public bExtraball_3       ' Triggered 6 Modes are complete

  ' Holds global info
  Public SModeProgress(8)     ' 8 modes
  Public SModePercent(8)
  Public SMode2Progress(8)    ' 8 modes
  Public SMode2Percent(8)
  Public SbImmolationProgress(9)  ' Immolation progress
  'Public GrootProgress(8)    ' How far through Orb are we (One for drop and one for back DropDrop)
  'Public OrbProgress(8)    ' How far through Groot are we (for for mouth open and one for lock)

  Public GuardianCount    ' Spell GUARDIANS
  Public RampageCount     ' Spell RAMPAGE

  Public GrootFinish      ' Did we finish GrootMB
  Public GrootCount     ' Number of times we completed Groot
  Public bGrootMBToggle   ' If we are on the second mouth hit
  Public GrootMBInLock    ' Number of balls in Groot MB Lock
  Public OrbCount       ' Number of times we completed Orbs
  Public OrbMBProgress    ' How far through OrbMB we are
  Public bOrbTargetDropped  ' Is the OrbTarget Dropped?
  Dim bSXandarDone
  Dim bSXandarReady
  Dim SXandarCount
  Dim SYakaPops       ' How many pops left if we are on Yaka Arrow

  Dim bSImmolationDone
  dim bSImmolationReady
  Dim SImmolationCount

  dim bSCherryBombReady
  Dim SCherryBombCount
  dim bSCherryBombDone
  Dim SSkillshotValue

  Dim HadronCount

  Dim bCountDownEnabled   ' Countdown Time info
  Dim CountdownValue

  Public bQQFirstTime     ' Have we dont quills quest once?
  Public bOrbTargetDisabled ' If we are in the middle of quills quest this could be disabled (Hidden safe guard for Target disabled)
  Public bModeSelect
  Public SPlayerMode
  Public SPlayerMode2

  Public Sub Reset()
    dim i, j
    for i = 0 to 4
      lNovaStates(i) = 0
      lNovaStatesKyln(i) = 2
    Next
    bExtraball_1 = False
    bExtraball_2 = False
    bExtraball_3 = False
    SSkillshotValue = 250000

    SPlayerMode = -1
    SPlayerMode2 = -1
    bFirstBall = True
  End Sub

  Public Sub Save() ' Grab all the current Table states and save into this player
    dim i
    sBumperMultiplier = BumperMultiplier
    ArrowColor = modeRampColor
    lArrowStates(kYondu) = lYonduArrow.state
    lArrowStates(kRonan) = lRonanArrow.state
    lArrowStates(kRocket) = lRocketArrow.state
    lArrowStates(kNebula) = lNebulaArrow.state
    lArrowStates(kGroot) = lgr_a.state
    lArrowStates(kBroker) = lBrokerArrow.state
    lArrowStates(kGamora) = lGamoraArrow.state
    lArrowStates(kDrax) = lDraxArrow.state
    lArrowStates(kStarLord) = lStarLordArrow.state

    lNameStates(kYondu) = lYonduName.state
    lNameStates(kRonan) = lRonanName.state
    lNameStates(kRocket) = lRocketName.state
    lNameStates(kNebula) = lNebulaName.state
    lNameStates(kGroot) = lgr.state
    lNameStates(kBroker) = lBrokerName.state
    lNameStates(kGamora) = lGamoraName.state
    lNameStates(kDrax) = lDraxName.state
    lNameStates(kStarLord) = lStarLordName.state

    lHadronStates(0) = lHadron0.state
    lHadronStates(1) = lHadron1.state
    lHadronStates(2) = lHadron2.state
    lHadronStates(3) = lHadron3.state
    lHadronStates(4) = lHadron4.state

    'lNovaStatesKyln ' Stored during game
    'lNovaStates ' Stored during game

    lGrootStabStates(0) = l023.state
    lGrootStabStates(1) = l019.state
    lGrootMBState = lgr_mb.state

    for i = 0 to 8
      SModeProgress(i) = ModeProgress(i)
      SModePercent(i) = ModePercent(i)
      SMode2Progress(i) = Mode2Progress(i)
      SMode2Percent(i) = Mode2Percent(i)
    Next
    for i = 0 to 9
      SbImmolationProgress(i) = bImmolationProgress(i)
    Next
    GuardianCount = SpellGuardians
    RampageCount = SpellRampage
    GrootCount = GrootMultiBallCount
    GrootFinish = GrootMBFinished
    bGrootMBToggle = GrootMultiBallToggle
    GrootMBInLock = BallsInLock
    OrbCount = OrbMultiBallCount
    OrbMBProgress = OrbMultiBallProgress
    bOrbTargetDropped = OrbTarget1.IsDropped
    bQQFirstTime = bQuillsQuestFirstTime
    bOrbTargetDisabled = OrbTarget1Disabled.Collidable

    SYakaPops = YakaPops
    SSkillshotValue = SkillshotValue
    bSXandarDone = bXandarDone
    bSXandarReady= bXandarReady
    SXandarCount = XandarCount

    bSImmolationDone = bImmolationDone
    bSImmolationReady= bImmolationReady
    SImmolationCount = ImmolationCount

    bSCherryBombReady= bCherryBombReady
    bSCherryBombDone = bCherryBombDone
    SCherryBombCount = CherryBombCount
    HadronCount = HadronEnforcerCount

    bCountDownEnabled = ModeCountdownTimer.Enabled
    CountdownValue = ModeCountdownTimer.UserValue
    bModeSelect = bPlayerModeSelect
    SPlayerMode = PlayerMode
    SPlayerMode2 = PlayerMode2
  End Sub

  Public Sub Restore()  ' Retore all the Table states
    Dim i
    if PlayersPlayingGame = 1 then exit sub ' Just in case I missed something We dont have to do this on single player

    BumperMultiplier = sBumperMultiplier
    modeRampColor = ArrowColor
    SetLightColor lYonduArrow, modeRampColor, lArrowStates(kYondu)
    SetLightColor lRonanArrow, modeRampColor, lArrowStates(kRonan)
    SetLightColor lRocketArrow, modeRampColor, lArrowStates(kRocket)
    SetLightColor lNebulaArrow, modeRampColor, lArrowStates(kNebula)
    SetLightColor lgr_a, modeRampColor, lArrowStates(kGroot)
    SetLightColor lBrokerArrow, modeRampColor, lArrowStates(kBroker)
    SetLightColor lGamoraArrow, modeRampColor, lArrowStates(kGamora)
    SetLightColor lDraxArrow, modeRampColor, lArrowStates(kDrax)
    SetLightColor lStarLordArrow, modeRampColor, lArrowStates(kStarLord)

    SetLightColor lYonduName, "white", lNameStates(kYondu)
    SetLightColor lRonanName, "white", lNameStates(kRonan)
    SetLightColor lRocketName, "white", lNameStates(kRocket)
    SetLightColor lNebulaName, "white", lNameStates(kNebula)
    SetLightColor lgr, "white", lNameStates(kGroot)
    SetLightColor lBrokerName, "white", lNameStates(kBroker)
    SetLightColor lGamoraName, "white", lNameStates(kGamora)
    SetLightColor lDraxName, "white", lNameStates(kDrax)
    SetLightColor lStarLordName, "white", lNameStates(kStarLord)

    SetLightColor lHadron0, "yellow", lHadronStates(0):tgHadron0.UserValue = lHadronStates(0) = 2
    SetLightColor lHadron1, "yellow", lHadronStates(1):tgHadron1.UserValue = lHadronStates(1) = 2
    SetLightColor lHadron2, "yellow", lHadronStates(2):tgHadron2.UserValue = lHadronStates(2) = 2
    SetLightColor lHadron3, "yellow", lHadronStates(3):tgHadron3.UserValue = lHadronStates(3) = 2
    SetLightColor lHadron4, "yellow", lHadronStates(4):tgHadron4.UserValue = lHadronStates(4) = 2

    'lNovaStatesKyln ' Stored during game
    'lNovaStates ' Stored during game

    l023.state = lGrootStabStates(0)
    l019.state = lGrootStabStates(1)
    lgr_mb.state = lGrootMBState
    if lgr_mb.state = 2 Then
      GrootMouth_Drop True
    Else
      GrootMouth_Drop False
    End If

    for i = 0 to 8
      ModeProgress(i) = SModeProgress(i)
      ModePercent(i) = SModePercent(i)
      Mode2Progress(i) = SMode2Progress(i)
      Mode2Percent(i) = SMode2Percent(i)
    Next
    for i = 0 to 9
      bImmolationProgress(i) = SbImmolationProgress(i)
    Next

    SpellGuardians = GuardianCount
    SpellRampage = RampageCount
    GrootMultiBallCount = GrootCount
    GrootMBFinished = GrootFinish
    GrootMultiBallToggle = bGrootMBToggle
    BallsInLock = GrootMBInLock
    OrbMultiBallCount = OrbCount
    OrbMultiBallProgress = OrbMBProgress
    OrbTarget1.IsDropped = bOrbTargetDropped
    if OrbTarget1.IsDropped then
      LightShootOrb.State = 2
    Else
      LightShootOrb.State = 0
    End IF
    bQuillsQuestFirstTime = bQQFirstTime
    OrbTarget1Disabled.Collidable = bOrbTargetDisabled

    YakaPops = SYakaPops
    SkillshotValue = SSkillshotValue

    bXandarDone = bSXandarDone
    bXandarReady= bSXandarReady
    XandarCount = SXandarCount

    bImmolationDone = bSImmolationDone
    bImmolationReady= bSImmolationReady
    ImmolationCount = SImmolationCount

    bCherryBombReady= bSCherryBombReady
    bCherryBombDone = bSCherryBombDone
    CherryBombCount = SCherryBombCount

    HadronEnforcerCount = HadronCount

    'ModeCountdownTimer.Enabled = bCountDownEnabled     ' Dont restore this since we start it once they hit the ball
    ModeCountdownTimer.UserValue = CountdownValue
    bPlayerModeSelect = bModeSelect
    PlayerMode = SPlayerMode
    PlayerMode2 = SPlayerMode2
    if ModeCountdownTimer.Enabled then
      SetBackglassTimer(ModeCountdownTimer.UserValue)
    End If

    ' Put PUP in the right mode
    playclear pOverVid
    bSkipWaitVideo=True
      StopPlayerModeVideo
    bSkipWaitVideo=False
    if bPlayerModeSelect then
      pBGPlayerSelect
    else
      WaitPlayerMode
      StartPlayerModeVideo True   ' TBD Make this skip to the correct position if PUP ever supports it
      pausemedia pBackglass
      pausemedia pMusic
    End if

    ' Set other lights back up
    if OrbMultiBallCount > 0 then SetLightColor Light033, "purple", 1 ' Light Orb Multiball
    if GrootFinish > 0 then SetLightColor Light030, "green", 1  ' Light Groot Multiball
    if bXandarDone then SetLightColor Light031, "white", 1
    if bXandarReady then SetLightColor Light031, "white", 2
    if bImmolationDone then SetLightColor Light029, "white", 1
    if bImmolationReady then SetLightColor Light029, "white", 2
    if bCherryBombReady then SetLightColor lStarLordArrow, "red", 1

    Light020.State = 0
    Light021.State = 0
    Light022.State = 0
    Light023.State = 0
    Light024.State = 0
    Light025.State = 0
    Light026.State = 0
    Light026.State = 0

    SetModeLights   ' Set the mode light on the playfield
    if PlayerMode=0 Then Light020.State = 2
    if PlayerMode=1 Then Light021.State = 2
    if PlayerMode=2 Then Light022.State = 2
    if PlayerMode=3 Then Light023.State = 2
    if PlayerMode=4 Then Light024.State = 2
    if PlayerMode=5 Then Light025.State = 2
    if PlayerMode=6 Then Light026.State = 2
    if PlayerMode=7 Then Light027.State = 2

  End Sub
End Class

Sub TableState_Init(Index)
  Set PlayerState(Index) = New TableState
  PlayerState(Index).Reset
End Sub
Sub StackState_Init(Index)
  Set StackState(Index) = New cStack
  StackState(Index).Reset
End Sub


const defBallSaverTime = 11   ' In seconds
Dim BallSaverTime
BallSaverTime = defBallSaverTime
Const MaxMultiplier = 10 'limit to 10x in this game
Const BallsPerGame = 3   ' 3 or 5
Const MaxMultiballs = 5  ' max number of balls during multiballs


'********************
' nFozzy Flipper Physics
'********************
dim LF:Set LF = New FlipperPolarity
dim RF:Set RF = New FlipperPolarity
InitPolarity
Sub InitPolarity()

  dim x, a : a = Array(LF, RF)
  for each x in a
    'safety coefficient (diminishes polarity correction only)
    x.AddPoint "Ycoef", 0, RightFlipper.Y-65, 1 'disabled
    x.AddPoint "Ycoef", 1, RightFlipper.Y-11, 1

    x.enabled = True
    x.TimeDelay = 44
  Next

  rf.report "Velocity"
  addpt "Velocity", 0, 0,   1
  addpt "Velocity", 1, 0.2,   1.07
  addpt "Velocity", 2, 0.41, 1.05
  addpt "Velocity", 3, 0.44, 1
  addpt "Velocity", 4, 0.65,  1.0'0.982
  addpt "Velocity", 5, 0.702, 0.968
  addpt "Velocity", 6, 0.95,  0.968
  addpt "Velocity", 7, 1.03,  0.945


  rf.report "Polarity"
  AddPt "Polarity", 0, 0, 0
  AddPt "Polarity", 1, 0.16, -4.7
  AddPt "Polarity", 2, 0.33, -4.7
  AddPt "Polarity", 3, 0.37, -4.7 '4.2
  AddPt "Polarity", 4, 0.41, -4.7
  AddPt "Polarity", 5, 0.45, -4.7 '4.2
  AddPt "Polarity", 6, 0.576,-4.7
  AddPt "Polarity", 7, 0.66, -2.8'-2.1896
  AddPt "Polarity", 8, 0.743, -1.5
  AddPt "Polarity", 9, 0.81, -1.5
  AddPt "Polarity", 10, 0.88, 0

  LF.Object = LeftFlipper
  LF.EndPoint = EndPointLp  'you can use just a coordinate, or an object with a .x property. Using a couple of simple primitive objects
  RF.Object = RightFlipper
  RF.EndPoint = EndPointRp
End Sub

Sub TriggerLF_Hit() : LF.Addball activeball : End Sub
Sub TriggerLF_UnHit() : LF.PolarityCorrect activeball : End Sub
Sub TriggerRF_Hit() : RF.Addball activeball : End Sub
Sub TriggerRF_UnHit() : RF.PolarityCorrect activeball : End Sub


Sub FlipperMPT3K(Flipper)
  Flipper.Strength = 2250
  Flipper.Elasticity = 0.76
  Flipper.ElasticityFalloff = 0.2
  Flipper.Friction = 0.75
  Flipper.Return=0.1
  Flipper.RampUp=0
  Flipper.EOSTorque=0.75
End Sub

Sub FlipperDap(Flipper)
' table1.Gravity=1
' table1.Friction=0.04
' table1.Elasticity=0
' table1.ElasticityFalloff=0.2
  Flipper.Strength = 3000
  Flipper.Elasticity = 0.76
  Flipper.ElasticityFalloff = 0.2
  Flipper.Friction = 0.75
  Flipper.Return=0.1
  Flipper.RampUp=0
  Flipper.EOSTorque=0.75
End Sub

'********************
' Magnet
'********************

Dim mMagnaSave

'Sub mMagnaSave_Hit()
' PlaySoundAt SoundFXDOF("fx_bumper", 107, DOFPulse, DOFContactors), Bumper001
' 'mMagnaSave.AddBall ActiveBall
' vpmtimer.addtimer 1000, "MagnetDone '"
' SetLightColor lMagnet, "white", 0
'End Sub
'
'Sub MagnetDone
' mMagnaSave.RemoveBall ActiveBall
' mMagnaSave.MagnetOn = False
' SetLightColor lMagnet, "white", 0
'End Sub
'Sub MagnaSave_UnHit():
' mMagnaSave.RemoveBall ActiveBall
'End Sub

' *********************************************************************
'                Visual Pinball Defined Script Events
' *********************************************************************

Sub Table1_Init()
    LoadEM
    Dim i
    Randomize

  ReDim GrootMBJackpotHits(aRampLights.count)
  Redim HadronLightsSaveColor(aHadronLights.count, 3)
  Redim RampLightsSaveColor(aRampLights.count, 3)
  Redim LightsSaveColor(aLights.count, 3)
  baLightsSaved=False
  baRampLightsSaved = False
  baHadronLightsSaved = False

  if AlternateSettings = 1 then  ' wAxx
    table1.EnvironmentImage = "shinyenvironment"  ' Seems to make the Metal Ramps black

    ' Note: Disabling Reflect elements on PF removes the Groot lights from filling in and detail on inserts when off
    table1.ReflectElementsOnPlayfield = False

    'FlipperMPT3K LeftFlipper
    'FlipperMPT3K RightFlipper
  End If

  'aHadronLightsSave
  'aHadronLightsRestore

  ' TBD need to look into this
  vpmNudge.TiltSwitch = 14
    vpmNudge.Sensitivity = 1
    vpmNudge.TiltObj = Array(Bumper001, bumper002, bumper003, LeftSlingshot, RightSlingshot)

  bTableReady=False
  bUseUltraDMD=False
  bUsePUPDMD=False
  bPupStarted=False
  if DMDMode = 1 then
    bUseUltraDMD= True
    set PuPlayer = New PinupNULL
  elseif DMDMode = 2 Then
    bUsePUPDMD = True
  Else
    set PuPlayer = New PinupNULL
  End if

' if bClelandMusic then     ' For those that dont like the Cleland update
'   MusicDir="Topper"
'   VolMusic=VolMusic1
' Else
'   MusicDir="Topper.orig"
'   VolMusic=VolMusic1   '*.9
' End If

  'Set Controller = CreateObject("B2S.Server")
  'Controller.B2SName = "GOTG"
  'Controller.Run
  if b2son then
    Controller.B2SSetData 1,1
    Controller.B2SSetData 2,1
    Controller.B2SSetData 3,1
    Controller.B2SSetData 4,1
    Controller.B2SSetData 5,1
    Controller.B2SSetData 6,1
    Controller.B2SSetData 7,1
    Controller.B2SSetData 8,1
  End if

    'Impulse Plunger as autoplunger
    Const IMPowerSetting = 45 ' Plunger Power
    Const IMTime = 1.1        ' Time in seconds for Full Plunge
    Set plungerIM = New cvpmImpulseP
    With plungerIM
        .InitImpulseP swplunger, IMPowerSetting, IMTime
        .Random 1.5
        .InitExitSnd SoundFX("fx_kicker", DOFContactors), SoundFX("fx_solenoid", DOFContactors)
        .CreateEvents "plungerIM"
    End With

    ' Misc. VP table objects Initialisation, droptargets, animations...
    VPObjects_Init

    'load saved values, highscore, names, jackpot
    Loadhs

    'Init main variables
  TableState_Init(0)
  TableState_Init(1)
  TableState_Init(2)
  TableState_Init(3)
  TableState_Init(4)
  for i = 0 to StackSize
    StackState_Init(i)
  Next
  SkillshotValue=250000

    ' initalise the DMD display
    DMD_Init

    ' freeplay or coins
    bFreePlay = False ' coins yes or no?

    ' initialse any other flags
    bOnTheFirstBall = False
    bBallInPlungerLane = False
    bBallSaverActive = False
  BallSaverActiveBuffer = 0
    bBallSaverReady = False
    bMultiBallMode = False
    bGameInPlay = False
  bGameInPlayHidden = False
  bShowMatch = False
  bCreatedBall = False
    bAutoPlunger = False
  bAutoPlunged = False
    bMusicOn = True
    BallsOnPlayfield = 0
  RealBallsInLock=0
    BallsInLock = 0
    BallsInHole = 0
  SpellGuardians = 0
  SpellRampage=0
    LastSwitchHit = ""
    Tilt = 0
    TiltSensitivity = 6
    Tilted = False
    bBonusHeld = False
    bJustStarted = True
    bInstantInfo = False

  'Set bsTrough = New cvpmBallStack
  'bsTrough.InitKick KickerRocket, 160, 10

  Set mMagnaSave = New cvpmMagnet
    With mMagnaSave
       .InitMagnet MagnaSave, 24  ' was 60 power
       .GrabCenter = False
       .MagnetOn = 0
       .CreateEvents "mMagnaSave"
    End With
  mMagnaSave.MagnetOn = False
  DOF 142, DOFOff


  if bUsePUPDMD Then
    PuPInit
  Else
    pupDMDUpdate.Enabled = False
  End if

  if bUseUltraDMD Then
    PlayDMDScene "vidIntro.mp4", 9000
    vpmtimer.addtimer 4500, "bTableReady = True '"
  Else
    bTableReady = True
  End If
  bPupStarted=True

    EndOfGame()
  setUpgradeLight(True) ' Turn this back on for attract

End Sub

Private Function BigMod(Value1, Value2)
    BigMod = Value1 - (Int(Value1 / Value2) * Value2)
End Function

'******
' Keys
'******
Sub tmrHoldKey_Timer()    ' Reset the game with Ball in lane
  tmrHoldKey.Enabled = False
  ' TBD Destroy balls

  If bBallInPlungerLane and BallsOnPlayfield = 1 Then
    PlaySoundVol "start", VolDef
    bResetCurrentGame=True
    if bUsePupDMD then
      PuPlayer.PlayStop pOverVid            ' Stop overlay if there is one
      PuPlayer.SetLoop pOverVid, 0
    End If
    ResetForNewGame()
  End If
End Sub

Sub Table1_KeyDown(ByVal Keycode)
  dim musicMode
  if bTableReady=False then Exit Sub  ' If the ultraDMD hasnt finished intro then things look weird

  if bBallInPlungerLane and keycode = StartGameKey then
    tmrHoldKey.Enabled = False
    tmrHoldKey.Enabled = True
  End If

  If (keycode = RightMagnaSave) and bGameInPlay=False then
    lutpos = lutpos + 1 : If lutpos > ubound(luts) Then lutpos = 0 : end if
    table1.ColorGradeImage = luts(lutpos)
    TextBox001.Text = table1.ColorGradeImage
  End if

' Pup Testing
' Bonus Screen
' if (keycode = 17) then ' w key
'   dim i
'   for i = 0 to 9
'     BonusArrowHits(i) = 100
'   next
'        DMDflush
'   GrootMBJackpot = 0
'   PuPlayer.LabelShowPage pBonusScreen,1,0,"":PuPlayer.LabelShowPage pBackglass, 2,0,""
'   pDMDEvent(kDMD_BonusBG)
'   playmedia "Video-0x007A-2.mp4", "PupVideos", pBonusScreen, "", -1, "", 1, 1
'   tmrEndOfBallBonus.Interval = 800
'   tmrEndOfBallBonus.UserValue = 0   ' Timer will start EndOfBall2 when it is done
'   tmrEndOfBallBonus.Enabled = true
' End if
' Rocket Kicker Test
' if (keycode = 17) then ' w key
'   RocketKicker.CreateSizedball BallSize / 2
'   RocketKicker.Kick 145, 85
' End if
' End Modes
' if (keycode = 17) then
'   PlayerMode=1
'   ModePercent(1)=100
'   ModePoints = 9999
'   ShowPlayerModeComplete(-1)
'   PlayerMode2=1
'   bSecondMode=True
'   StartPlayerModeVideo False
'   ShowPlayerModeComplete(-1)
' End if

    If Keycode = AddCreditKey Then
    musicMode=""
    if LFPress=1 then       'In Game toggle to CLELAND Music mode (Press Credit while holding Left Flipper)
      if bClelandMusic then
        bClelandMusic=False
        musicMode="^Original"
      Else
        bClelandMusic=True
        musicMode="^Cleland"
      End If
      DMDFlush
      DMD "_", CL(1, "CREDITS: " & Credits & musicMode), "", eNone, eNone, eNone, 500, True, "fx_coin"
    else
      Credits = Credits + 1
      DOF 140, DOFOn
      If(Tilted = False)Then
        DMDFlush
        DMD "_", CL(1, "CREDITS: " & Credits), "", eNone, eNone, eNone, 500, True, "fx_coin"
        'If NOT bGameInPlay Then ShowTableInfo
      End If
    End if
    End If

    If keycode = PlungerKey Then
        Plunger.Pullback: PlaysoundAt "fx_plungerpull", Plunger
    End If

  If keycode = LeftFlipperKey Then LFPress = 1
  If keycode = RightFlipperKey Then rfpress = 1

    If keycode = LeftTiltKey Then Nudge 90, 6:PlaySound "fx_nudge", 0, 1, -0.1, 0.25:CheckTilt
    If keycode = RightTiltKey Then Nudge 270, 6:PlaySound "fx_nudge", 0, 1, 0.1, 0.25:CheckTilt
    If keycode = CenterTiltKey Then Nudge 0, 7:PlaySound "fx_nudge", 0, 1, 1, 0.25:CheckTilt

    If hsbModeActive Then
        EnterHighScoreKey(keycode)
        Exit Sub
    End If

    ' Table specific
  if keycode <> PlungerKey then bSkillshotsReady(1) = False   ' Cancel Skillshot2 (you touched a key)

  If bGameInPlay AND NOT Tilted Then
    ' Normal flipper action
        If keycode = LeftFlipperKey Then SolLFlipper 1:StartInstantInfo(keycode)
        If keycode = RightFlipperKey Then SolRFlipper 1:StartInstantInfo(keycode)

    ' Select Player Mode
    if (bPlayerModeSelect) and bInstantInfo=False Then
      SelectPlayerMode(keycode)
    end If

    ' Debug mode
    If (keycode = LeftMagnaSave or keycode = RightMagnaSave) then
      HandleDebugDown(keycode)
    End If

    '  Hadron, Start Mode, fire ball
    If keycode = RightMagnaSave or keycode = LockBarKey or _
      (keycode = PlungerKey and bUsePlungerForSternKey) Then

      if bPlayerModeSelect and bBallInPlungerLane = False then  ' They selected a new player mode (kick the ball from the scoop)
        StartPlayerMode()
        RotateSong()
        vpmtimer.addtimer 2000, "LeftScoopExit '"
        exit sub
      elseif bAutoPlunger=False and bBallInPlungerLane = True then  ' Auto fire ball with stern key
        plungerIM.Strength = 60
        'plungerIM.InitImpulseP swplunger, 60, 0    ' Change impulse power while we are here
        PlungerIM.AutoFire
        DOF 125, DOFPulse
        DOF 112, DOFPulse
        plungerIM.Strength = 45
        'plungerIM.InitImpulseP swplunger, 45, 1.1
      Else
        CheckHadron True        ' Hadron Enforcer
      end if
    End if

        If keycode = StartGameKey Then    ' startkey
            If((PlayersPlayingGame < MaxPlayers)AND(bOnTheFirstBall = True))Then

                If(bFreePlay = True)Then
                    PlayersPlayingGame = PlayersPlayingGame + 1
                    TotalGamesPlayed = TotalGamesPlayed + 1
                    DMDFlush
                    DMD "_", CL(1, PlayersPlayingGame & " PLAYERS"), "", eNone, eBlink, eNone, 500, True, "start"
                Else
                    If(Credits > 0)then
                        PlayersPlayingGame = PlayersPlayingGame + 1
                        TotalGamesPlayed = TotalGamesPlayed + 1
                        Credits = Credits - 1
            If Credits < 1 Then DOF 140, DOFOff
                        DMD "_", CL(1, PlayersPlayingGame & " PLAYERS"), "", eNone, eBlink, eNone, 500, True, "start"
                    Else
                        ' Not Enough Credits to start a game.
                        'DOF 140, DOFOff
                        DMDFlush
                        DMD CL(0, "CREDITS " & Credits), CL(1, "INSERT COIN"), "", eNone, eBlink, eNone, 500, True, ""
                    End If
                End If
        UpdateNumberPlayers ' Update the screen layout on pup for multiple players

            End If
        End If
    ElseIf bShowMatch = False then ' (Also bGameInPlay=False)
    If keycode = StartGameKey Then
      If(bFreePlay = True)Then
        If(BallsOnPlayfield = 0)Then
          ResetForNewGame()
        End If
      Else
        If(Credits > 0)Then
          If(BallsOnPlayfield = 0)Then
            Credits = Credits - 1
            If Credits < 1 Then DOF 140, DOFOff
            ResetForNewGame()
          End If
        Else
          ' Not Enough Credits to start a game.
          'DOF 140, DOFOff
          DMDFlush
          DMD CL(0, "CREDITS " & Credits), CL(1, "INSERT COIN"), "", eNone, eBlink, eNone, 500, True, ""
          'ShowTableInfo
        End If
      End If
    End If
  ElseIf bShowMatch and keycode = StartGameKey Then   'Skip Show Match
    playclear pOverVid
    StopSound "Match-Score"
    EndOfGame()
    End If ' If (GameInPlay)

End Sub

Sub Table1_KeyUp(ByVal keycode)
  Dim NextCmd
  tmrHoldKey.Enabled = False
    If keycode = PlungerKey Then
        Plunger.Fire: PlaysoundAt "fx_plunger", Plunger
    End If

    If hsbModeActive Then
    InstantInfoTimer.Enabled = False
    bInstantInfo = False
        Exit Sub
    End If

    ' Table specific

    If bGameInPLay AND NOT Tilted Then

    if LFPress=1 and RFPress = 1 then ' Pressed both at the same time
      if bFlipperSkipEnabled and FlipperSkipCmd<>"" then
debug.print "Skip Command >"&FlipperSkipCmd&"<"
        NextCmd = FlipperSkipCmd
        FlipperSkipCmd=""
        Execute NextCmd
      End If
    End If

    If (keycode = LeftMagnaSave or keycode = RightMagnaSave) then
      HandleDebugUp(keycode)
    End If

    If keycode = LeftFlipperKey Then
      lfpress = 0
      leftflipper.eostorqueangle = EOSA
      leftflipper.eostorque = EOST
    End If
    If keycode = RightFlipperKey Then
      rfpress = 0
      rightflipper.eostorqueangle = EOSA
      rightflipper.eostorque = EOST
    End If

        If keycode = LeftFlipperKey Then
            SolLFlipper 0
      EndFlipperStatus(keycode)
        End If
        If keycode = RightFlipperKey Then
            SolRFlipper 0
      EndFlipperStatus(keycode)
        End If
  Else
    If keycode = LeftFlipperKey Then lfpress = 0
    If keycode = RightFlipperKey Then rfpress = 0
    End If
End Sub

Sub TimerPlunger_Timer()
 'debug.print plunger.position
  VR_Primary_plunger.Y = 94.1 + (5* Plunger.Position) -20
End Sub

' DONT FORGET TO CLEAR FlipperSkipCmd when you are past this stage.
'   What this means is once you move on to the next command (without skipping) you need to clear this otherwise
'   when you hit both flippers during gameplay it will call the command you put
Sub SetFlipperSkipCmd(Cmd)
  if FlipperSkipCmd="" then
    FlipperSkipCmd=Cmd
  End If
End Sub

sub StartInstantInfo(keycode)
debug.print "Start Instant " & keycode & " " & bInstantInfo
  if bInstantInfo = False Then ' I am already in instantinfo
    InstantInfoTimer.Interval = 8000
    InstantInfoTimer.Enabled = True
    InstantInfoTimer.UserValue=keycode
  End If
End Sub

Sub InstantInfoTimer_Timer
    InstantInfoTimer.Enabled = False
    bInstantInfo = True
debug.print "Instant Info timer"
  PuPlayer.LabelShowPage pOverVid, 1,0,""
  'PuPlayer.LabelShowPage pBackglass, 2,0,""
' if bPlayerModeSelect Then
'   pDMDEvent(kDMD_Attract)
' End If
  pCurAttractPos=0
  pInAttract=true
  pAttractNext
End Sub

Sub EndFlipperStatus(keycode)
    If bInstantInfo Then
debug.print "EndInstantInfo check" & keycode & " " & InstantInfoTimer.UserValue
    if (keycode=InstantInfoTimer.UserValue) then  ' They let go of the key
debug.print "EndInstantInfo"
      InstantInfoTimer.Enabled = False
      bInstantInfo=False
      PuPlayer.LabelShowPage pBackglass,1,0,""
      pInAttract=false
      playclear pOverVid
      PuPlayer.LabelSet pOverVid,"OverMessage1","",1,""
      PuPlayer.LabelSet pOverVid,"OverMessage2","",1,""
      PuPlayer.LabelSet pOverVid,"OverMessage3","",1,""
      RefreshPlayerMode
      if bPlayerModeSelect Then
        pDMDEvent(kDMD_PlayerSelect)
      End If
    Else ' They pressed the other flipper so cycle faster
      PriorityReset=2000
      pAttractNext
    End If
  Else
'debug.print "Stop Instant " & keycode
    InstantInfoTimer.Enabled = False
    End If
End Sub

'*************
' Pause Table
'*************

Sub table1_Paused
End Sub

Sub table1_unPaused
End Sub

Sub table1_Exit
  if b2son then Controller.Stop
    Savehs
End Sub

'********************
'     Flippers
'********************

Sub SolLFlipper(Enabled)
    If Enabled Then
        PlaySoundAt SoundFXDOF("fx_flipperup", 101, DOFOn, DOFFlippers), LeftFlipper
        'LeftFlipper.RotateToEnd
    LF.fire 'LeftFlipper.RotateToEnd
    RotateLaneLightsLeft
    Else
        PlaySoundAt SoundFXDOF("fx_flipperdown", 101, DOFOff, DOFFlippers), LeftFlipper
        LeftFlipper.RotateToStart
    End If
End Sub

Sub SolRFlipper(Enabled)
    If Enabled Then
        PlaySoundAt SoundFXDOF("fx_flipperup", 102, DOFOn, DOFFlippers), RightFlipper
        'RightFlipper.RotateToEnd
        RF.fire 'RightFlipper.RotateToEnd
        RotateLaneLightsRight
    Else
        PlaySoundAt SoundFXDOF("fx_flipperdown", 102, DOFOff, DOFFlippers), RightFlipper
        RightFlipper.RotateToStart
    End If
End Sub

' flippers hit Sound

Sub LeftFlipper_Collide(parm)
  if bUseUltraDMD then AddScore 1 ' Keep the display from blanking
    PlaySound "fx_rubber_flipper", 0, parm / 10, pan(ActiveBall), 0, Pitch(ActiveBall), 0, 0, AudioFade(ActiveBall)
End Sub

Sub RightFlipper_Collide(parm)
  if bUseUltraDMD then AddScore 1 ' Keep the display from blanking
    PlaySound "fx_rubber_flipper", 0, parm / 10, pan(ActiveBall), 0, Pitch(ActiveBall), 0, 0, AudioFade(ActiveBall)
End Sub

Sub RotateLaneLightsLeft()
  if PlayerMode = 5 then  ' Escape Kyln
debug.print "lNovaStatesKyln(0)" & PlayerState(CurrentPlayer).lNovaStatesKyln(0) & " " & PlayerState(CurrentPlayer).lNovaStatesKyln(1)
    if PlayerState(CurrentPlayer).lNovaStatesKyln(0) = 2 and PlayerState(CurrentPlayer).lNovaStatesKyln(1) = 0 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStatesKyln(0) = 0
      PlayerState(CurrentPlayer).lNovaStatesKyln(1) = 2
    elseif PlayerState(CurrentPlayer).lNovaStatesKyln(0) = 0 and PlayerState(CurrentPlayer).lNovaStatesKyln(1) = 2 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStatesKyln(0) = 2
      PlayerState(CurrentPlayer).lNovaStatesKyln(1) = 0
    End If

    if PlayerState(CurrentPlayer).lNovaStatesKyln(3) = 2 and PlayerState(CurrentPlayer).lNovaStatesKyln(4) = 0 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStatesKyln(3) = 0
      PlayerState(CurrentPlayer).lNovaStatesKyln(4) = 2
    elseif PlayerState(CurrentPlayer).lNovaStatesKyln(3) = 0 and PlayerState(CurrentPlayer).lNovaStatesKyln(4) = 2 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStatesKyln(3) = 2
      PlayerState(CurrentPlayer).lNovaStatesKyln(4) = 0
    End If

    SetLightColor lNova_sw2, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(0)
    SetLightColor lNova_sw3, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(1)
    SetLightColor lNova_sw8, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(3)
    SetLightColor lNova_sw9, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(4)
  elseif bSkillshotsReady(0) or bSkillshotsReady(1) then
debug.print "bSkillshotsReady: " & bSkillshotsReady(0) & " " & bSkillshotsReady(0) & " Nova " & lNova_sw8.UserValue & " " & lNova_sw9.UserValue
    if bBallInPlungerLane=False and SkillshotValue > 250000 then SkillshotValue = SkillshotValue - 50000   ' goes down by 50K each time you move it
    if lNova_sw9.UserValue = 2 then ' Blinking is skillshot
      lNova_sw8.UserValue = 2
      lNova_sw9.UserValue = 0
    Else
      lNova_sw8.UserValue = 0
      lNova_sw9.UserValue = 2
    End If
    if bPlayerModeSelect = False and PlayerMode <> 5 then
      SetLightColor lNova_sw8, "orange", lNova_sw8.UserValue
      SetLightColor lNova_sw9, "orange", lNova_sw9.UserValue
    End If
  else
debug.print "bSkillshotsReady: " & bSkillshotsReady(0) & "Nova " & PlayerState(CurrentPlayer).lNovaStates(3) & " " & PlayerState(CurrentPlayer).lNovaStates(4)

    if PlayerState(CurrentPlayer).lNovaStates(0) = 1 and PlayerState(CurrentPlayer).lNovaStates(1) = 0 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStates(0) = 0
      PlayerState(CurrentPlayer).lNovaStates(1) = 1
    elseif PlayerState(CurrentPlayer).lNovaStates(0) = 0 and PlayerState(CurrentPlayer).lNovaStates(1) = 1 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStates(0) = 1
      PlayerState(CurrentPlayer).lNovaStates(1) = 0
    End If

    if PlayerState(CurrentPlayer).lNovaStates(3) = 1 and PlayerState(CurrentPlayer).lNovaStates(4) = 0 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStates(3) = 0
      PlayerState(CurrentPlayer).lNovaStates(4) = 1
    elseif PlayerState(CurrentPlayer).lNovaStates(3) = 0 and PlayerState(CurrentPlayer).lNovaStates(4) = 1 then ' Selected (toggle)
      PlayerState(CurrentPlayer).lNovaStates(3) = 1
      PlayerState(CurrentPlayer).lNovaStates(4) = 0
    End If

    SetLightColor lNova_sw2, "orange", PlayerState(CurrentPlayer).lNovaStates(0)
    SetLightColor lNova_sw3, "orange", PlayerState(CurrentPlayer).lNovaStates(1)
    SetLightColor lNova_sw8, "orange", PlayerState(CurrentPlayer).lNovaStates(3)
    SetLightColor lNova_sw9, "orange", PlayerState(CurrentPlayer).lNovaStates(4)
  End If
End Sub

Sub RotateLaneLightsRight()
  RotateLaneLightsLeft() ' There are only 2 lanes
End Sub


'*********
' Queue - This could be used for anything but I use it to queue  priority=1 items up with the option to have 1 Priority=2 item queued or running
'       Thought here is Pri 1 items need to be shown, Pri 2 items can be shown if an item is running
'
'   NOTE - Since VPMtimer is limited to 20 concurrent timers you need a timer called tmrQueue to ensure items dont get dropped
' QueueScene
'   Command=vbscript command    ex:   "RunFunction ""Test"", 123  '"
'   Length=milliseconds before running the next item in the queue
'   Priority=Number, 0 being highest
'
'*********
dim PupQueue(20, 3)     ' Size=20,  Fields are 0=Command, 1=Priority, 2=time
dim PupQueueEndPos      ' Size of the queue (-1 = Empty)
dim QueueActive       ' We are actively running something
Dim QueueCurrentTime    ' How much time is this one going to run (Just used for gtting the queue time)
QueueActive=False
PupQueueEndPos=-1
Sub QueueFlush()
  PupQueueEndPos=-1
  QueueActive=False
End Sub
Function getQueueTime()   ' Returns how much time left on queue
  Dim time,i
  time = 0
debug.print "GetQueueTime:" & now
debug.print "GetQueueTime:" & QueueCurrentTime & " " & QueueActive
  if QueueActive and QueueCurrentTime <> 0 then time = (DateDiff("s", now, QueueCurrentTime) * 1000)
debug.print "GetQueueTime Active:" & time

  for i = 0 to PupQueueEndPos
    time = time + PupQueue(i, 2)
  Next
  getQueueTime = time
debug.print "GetQueueTime ret:" & time
End Function
Sub QueuePop()
  if PupQueueEndPos = -1 then exit sub
  PupQueue(0, 1 )=99
  SortPupQueue
  PupQueue(PupQueueEndPos,0 )=""
  PupQueue(PupQueueEndPos,2 )=0
  PupQueueEndPos=PupQueueEndPos-1

Debug.print "--Q-Dump Pop---"
  Dim xx
  for xx = 0 to PupQueueEndPos
    debug.print xx & " " & PupQueue(xx, 0) & " " & PupQueue(xx, 1) & " " & PupQueue(xx, 2)
  Next
Debug.print "--Q-Dump Pop---"


End Sub

Sub QueueScene(Command, msecLen, priority)
debug.print "Queue Scene " & Command & " Len: " & msecLen
  if PupQueueEndPos < UBound(PupQueue, 1) then
    PupQueueEndPos=PupQueueEndPos+1
  End if
  ' NOTE: If it is full we overwrite the lowest priority (Optionally we could make the queue bigger)
  PupQueue(PupQueueEndPos,0 )=Command
  PupQueue(PupQueueEndPos,1 )=priority
  PupQueue(PupQueueEndPos,2 )=msecLen
  SortPupQueue

Debug.print "--Q-Dump---"
  Dim xx
  for xx = 0 to PupQueueEndPos
    debug.print xx & " " & PupQueue(xx, 0) & " " & PupQueue(xx, 1) & " " & PupQueue(xx, 2)
  Next
Debug.print "--Q-Dump---"

  RunQueue True
End Sub

Sub tmrQueue_Timer
  tmrQueue.Enabled = False
  RunQueue False
End Sub

Sub RunQueue(bNewItem)
  dim qCmd, qTime
debug.print "Run Queue " & QueueActive & " " & bNewItem & " " & Now
  if QueueActive = False or bNewItem=False then   ' Nothing is running Or we just finished running something
    if PupQueueEndPos <> -1 then
      QueueActive = True
      qCmd=PupQueue(0, 0)
      qTime=PupQueue(0, 2)
debug.print "Exec " & qCmd
      Execute qCmd
debug.print "Timer " & qTime
      if qTime > 0 then
        QueueCurrentTime = DateAdd("s",qTime/1000, now)
debug.print QueueCurrentTime
        tmrQueue.Interval = qTime
        tmrQueue.Enabled = True
        'vpmtimer.addtimer cInt(qTime), "RunQueue False '"
        QueuePop
      Else      ' No timer just run the next item in the queue
        QueueCurrentTime = 0
        QueuePop
        RunQueue False
      End If
    Else
debug.print "Queue Empty Deacivated"
      QueueActive = False
    End If
  End if
End Sub

Sub SortPupQueue
  dim a, j, temp1, temp2, temp3
  for a = PupQueueEndPos - 1 To 0 Step -1
    for j= 0 to a
      if PupQueue(j, 1)>PupQueue(j+1, 1) then
        temp1=PupQueue(j+1,0 )
        temp2=PupQueue(j+1,1 )
        temp3=PupQueue(j+1,2 )
        PupQueue(j+1,0 )=PupQueue(j,0 )
        PupQueue(j+1,1 )=PupQueue(j,1 )
        PupQueue(j+1,2 )=PupQueue(j,2 )
        PupQueue(j, 0 )=temp1
        PupQueue(j, 1 )=temp2
        PupQueue(j, 2 )=temp3
      end if
    next
  next

End Sub


'*********
' TILT
'*********

Dim TiltDangerWait
TiltDangerWait=False
Sub SceneTilt(Message)
  TiltDangerWait=True
  playmedia "Video-0x008E.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
  PuPlayer.LabelShowPage pOverVid, 1,0,""
  if TiltCount(CurrentPlayer) = 1 then
    puPlayer.LabelSet pOverVid,"OverMessage1", "" ,1,""
    puPlayer.LabelSet pOverVid,"OverMessage2", Message  ,1,""
    puPlayer.LabelSet pOverVid,"OverMessage3", "" ,1,""
  Else
    puPlayer.LabelSet pOverVid,"OverMessage1", Message  ,1,""
    puPlayer.LabelSet pOverVid,"OverMessage2", "" ,1,""
    puPlayer.LabelSet pOverVid,"OverMessage3", Message  ,1,""
  End If
End Sub

Sub SceneClearTilt()
  TiltDangerWait=False
  puPlayer.LabelSet pOverVid,"OverMessage1", "" ,1,""
  puPlayer.LabelSet pOverVid,"OverMessage2", "" ,1,""
  puPlayer.LabelSet pOverVid,"OverMessage3", "" ,1,""
  playclear pOverVid
End Sub


'NOTE: The TiltDecreaseTimer Subtracts .01 from the "Tilt" variable every round

Sub CheckTilt                                    'Called when table is nudged
    If NOT bGameInPlay Then Exit Sub
  If TiltDangerWait then Exit Sub
    Tilt = Tilt + TiltSensitivity                'Add to tilt count
debug.print "Check Tilt " & Tilt
    TiltDecreaseTimer.Enabled = True
  if Tilt > 15 and TiltCount(CurrentPlayer) < 2 Then
    TiltCount(CurrentPlayer) = TiltCount(CurrentPlayer) + 1

    QueueScene "SceneTilt ""DANGER"" '", 3000, 1
    QueueScene "SceneClearTilt '", 0, 1
  ElseIf Tilt > 15 Then 'If more that 15 then TILT the table
        Tilted = True

    SceneTilt "TILT"
    vpmtimer.addtimer 3000, "SceneClearTilt '"

        DMDFlush
    DisplayDMDText "TILT","", 3000
        DisableTable True
        TiltRecoveryTimer.Enabled = True 'start the Tilt delay to check for all the balls to be drained
    End If
End Sub

Sub TiltDecreaseTimer_Timer
    ' DecreaseTilt
    If Tilt > 0 Then
        Tilt = Tilt - 0.1
    Else
        TiltDecreaseTimer.Enabled = False
    End If
End Sub

Sub DisableTable(Enabled)
    If Enabled Then
        'turn off GI and turn off all the lights
        GiOff
        LightSeqTilt.Play SeqAllOff
        'Disable slings, bumpers etc
        LeftFlipper.RotateToStart
        RightFlipper.RotateToStart
        'Bumper1.Force = 0

        LeftSlingshot.Disabled = 1
        RightSlingshot.Disabled = 1
    Else
        'turn back on GI and the lights
        GiOn
        LightSeqTilt.StopPlay
        'Bumper1.Force = 6
'        LeftSlingshot.Disabled = 0
 '       RightSlingshot.Disabled = 0
        'clean up the buffer display
        DMDFlush
    End If
End Sub

Sub TiltRecoveryTimer_Timer()
    ' if all the balls have been drained then..
    If(BallsOnPlayfield = 0)Then
        ' do the normal end of ball thing (this doesn't give a bonus if the table is tilted)
        EndOfBall()
        TiltRecoveryTimer.Enabled = False
    End If
' else retry (checks again in another second or so)
End Sub




'********************
' Music as wav sounds
'********************

Dim Song
Song = ""

Sub CherrySong
  PlaySong("Song-1")
  SongNum=1
End Sub

Sub RotateSong()
'debug.print "Rotate " & SongNum
  PlaySong "Song-" & SongNum
  SongNum=SongNum+1
  if (SongNum>=4) then SongNum=1
End Sub

'sub PauseSong()
'exit sub
'if bBGPlayingVideo then exit sub ' We are playing a movie
'
' if bUsePUPDMD then
''debug.print "PlayStop (p) " & Song
'   PuPlayer.playpause pDMD
'   bPlayPaused=True
' Else
''debug.print "PlayStop (p) " & Song
'   StopSound Song
' End If
'End Sub

dim bPlayPaused
bPlayPaused = False
Sub PlaySong(name)
'debug.print "PlaySong " & name & " " & song
  dim PlayLength
  if bUsePUPDMD then      ' Use Pup if we have it so we can pause the music
'   PlaySongPup(name)
    exit sub
  End If
  StopSound "m_wait"
  StopSound Song  ' Stop the old song
  if name <> "" then Song = name
  PlayLength = -1
  If Song = "m_end" Then PlayLength = 0
  bPlayPaused=False
  PlaySound Song, PlayLength, VolBGMusic 'this last number is the volume, from 0 to 1
End Sub

'Sub PlaySongPup(name)
'exit sub
' if bBGPlayingVideo then exit sub ' We are playing a movie
' StopSound "m_wait"
' Song = name
' if name = "" and bPlayPaused = False Then
'   ' Do Nothing
''debug.print "KeepPlaying"
' elseif name = "" and bPlayPaused then
''debug.print "PlayResume"
'   PuPlayer.playresume pDMD
'   bPlayPaused=False
' Else
''debug.print "PlayStop/Start"
'   PuPlayer.setbackground pDMD, 0    ' Take out of background mode, stop and start the next song
'   PuPlayer.playstop pDMD
'   PuPlayer.playlistplayex pDMD,"Topper", song + ".mp3", 100 * VolBGMusic, 5
'   'PuPlayer.setloop pDMD, 1
'   PuPlayer.setbackground pDMD, 1    ' Put in background mode so it loops
'    End If
'End Sub

'**********************
'     GI effects
' independent routine
' it turns on the gi
' when there is a ball
' in play
'**********************

Sub aLightsSave()
  Dim a
  dim i
  baLightsSaved = True
  i = 0
  For each a in aLights
    LightsSaveColor(i, 0) = a.name
    LightsSaveColor(i, 1) = a.color
    LightsSaveColor(i, 2) = a.colorfull
    LightsSaveColor(i, 3) = a.state
    i=i+1
  next
End Sub

Sub aLightsRestore()
  Dim a, b

' Not sure why this doesnt work
' for b = 0 to aLights.count-1
'   aLights(aLightSaveColor(b, 0)).color = aLightSaveColor(b, 1)
'   aLights(aLightSaveColor(b, 0)).colorfull = aLightSaveColor(b, 2)
'   aLights(aLightSaveColor(b, 0)).state = aLightSaveColor(b, 3)
' Next
  if baLightsSaved then
    For each a in aLights
      for b = 0 to aLights.count-1
        if LightsSaveColor(b, 0) = a.name then
          a.color = LightsSaveColor(b, 1)
          a.colorfull = LightsSaveColor(b, 2)
          'if a.name = "LightShootAgain" then msgbox "hi"
          'if a.name <> "LightShootAgain" and a.name <> "LightShootAgain2" then ' Dont restore the state on these because they are driven by a timer
          ' a.state = LightsSaveColor(b, 3)
          'End If
          exit for
        End if
      Next
    next
  End If
  baLightsSaved = False
End Sub


Sub aHadronLightsSave()
  Dim a
  dim i
  baLightsSaved = True
  i = 0
  For each a in aHadronLights
    HadronLightsSaveColor(i, 0) = a.name
    HadronLightsSaveColor(i, 1) = a.color
    HadronLightsSaveColor(i, 2) = a.colorfull
    HadronLightsSaveColor(i, 3) = a.state
    i=i+1
  next
End Sub

Sub aHadronLightsRestore()
  Dim a, b

' Not sure why this doesnt work
' for b = 0 to aLights.count-1
'   aLights(aLightSaveColor(b, 0)).color = aLightSaveColor(b, 1)
'   aLights(aLightSaveColor(b, 0)).colorfull = aLightSaveColor(b, 2)
'   aLights(aLightSaveColor(b, 0)).state = aLightSaveColor(b, 3)
' Next
  if baLightsSaved Then ' Make sure we actually saved something
    For each a in aHadronLights
      for b = 0 to aHadronLights.count-1
        if HadronLightsSaveColor(b, 0) = a.name then
          a.color = HadronLightsSaveColor(b, 1)
          a.colorfull = HadronLightsSaveColor(b, 2)
          a.state = HadronLightsSaveColor(b, 3)
          exit for
        End if
      Next
    next
  End If
  baLightsSaved = False
End Sub

Sub aRampLightsSave()
  Dim a
  dim i
  baRampLightsSaved = True
  i = 0
  For each a in aRampLights
    RampLightsSaveColor(i, 0) = a.name
    RampLightsSaveColor(i, 1) = a.color
    RampLightsSaveColor(i, 2) = a.colorfull
    RampLightsSaveColor(i, 3) = a.state
    i=i+1
  next
End Sub

Sub aRampLightsRestore()
  Dim a, b

  for each a in aRampLights
    SetLightColorRestore a, -1
    'SetLightColor a, modeRampColor, -1
    a.Intensity = 10
  Next

' if baRampLightsSaved then
'   For each a in aRampLights
'     for b = 0 to aRampLights.count-1
'       if RampLightsSaveColor(b, 0) = a.name then
'         a.color = RampLightsSaveColor(b, 1)
'         a.colorfull = RampLightsSaveColor(b, 2)
'         a.state = RampLightsSaveColor(b, 3)
'         exit for
'       End if
'     Next
'   next
' End If
  baRampLightsSaved = False
End Sub


Dim OldGiState
OldGiState = -1   'start witht the Gi off

Sub ChangeGi(col) 'changes the gi color
    Dim bulb
    For each bulb in aGILights
        SetLightColor bulb, col, -1
    Next
End Sub

Sub GIUpdateTimer_Timer
    Dim tmp, obj
    tmp = Getballs
    If UBound(tmp) <> OldGiState Then
        OldGiState = Ubound(tmp)
        If UBound(tmp) = 3 Then 'we have 4 captive balls on the table (-1 means no balls, 0 is the first ball, 1 is the second..)
            GiOff               ' turn off the gi if no active balls on the table, we could also have used the variable ballsonplayfield.
        Else
            Gion
        End If
    End If
End Sub

Sub GiOn
    DOF 126, DOFOn
    Dim bulb
    For each bulb in aGiLights
        bulb.State = 1
    Next

  BackWall.Image = "GOTG Backwall ON"
  Primitive009.Image = "GOTG FluroGI ON"
  Primitive006.Image = "GOTG PlasticsLvl1 GI ON"
  Primitive008.Image = "GOTG PlasticsLvl2 GI ON"
  Primitive004.Image = "GOTG Metal Wall Ramp GI ON"
  PlasticRampsA.Image = "GOTG Plastic Ramp A ON"
  PlasticRampsB.Image = "GOTG Plastic Ramp B ON"
  StickerA.Image = "GOTG StickerA ON"
  StickerB.Image = "GOTG StickerB ON"
  StickerC.Image = "GOTG StickerC ON"
  StickerD.Image = "GOTG StickerD ON"
  BumperPlastic1.Image = "GOTG-_0007_BPA-GI-ON"
  BumperPlastic2.Image = "GOTG-_0004_BPB-GI-ON"
  BumperPlastic3.Image = "GOTG-_0001_BPC-GI-ON"
  RocketKickerButton.Image = "GOTG RocketKicker GI ON"
  RampGuardLeft.Image = "GOTG Ramp Metal guides B GI ON"
  RampGuardRight.Image = "GOTG Ramp Metal guides A GI ON"
  LeftFlipperMeta.Image = "GOTG Metal guides GI ON"
  'GOTGSideBlades.Image = "GOTG Sideblades ON"
  PF_GiOFF.Opacity = 0
  PinCab_Backglass.blenddisablelighting = 5
End Sub

Sub GiOff
  BackWall.Image = "GOTG Backwall OFF"
  Primitive009.Image = "GOTG FluroGI OFF"
  Primitive006.Image = "GOTG PlasticsLvl1 GI OFF"
  Primitive008.Image = "GOTG PlasticsLvl2 GI OFF"
  Primitive004.Image = "GOTG Metal Wall Ramp GI OFF"
  PlasticRampsA.Image = "GOTG Plastic Ramp A OFF"
  PlasticRampsB.Image = "GOTG Plastic Ramp B OFF"
  StickerA.Image = "GOTG StickerA OFF"
  StickerB.Image = "GOTG StickerB OFF"
  StickerC.Image = "GOTG StickerC OFF"
  StickerD.Image = "GOTG StickerD OFF"
  BumperPlastic1.Image = "GOTG-_0008_BPA-GI-OFF"
  BumperPlastic2.Image = "GOTG-_0005_BPB-GI-OFF"
  BumperPlastic3.Image = "GOTG-_0002_BPC-GI-OFF"
  'GOTGSideBlades.Image = "GOTG Sideblades OFF"
  RocketKickerButton.Image = "GOTG RocketKicker GI OFF"
  RampGuardLeft.Image = "GOTG Ramp Metal guides B GI OFF"
  RampGuardRight.Image = "GOTG Ramp Metal guides A GI OFF"
    LeftFlipperMeta.Image = "GOTG Metal guides GI OFF"
  PF_GiOFF.Opacity = 100
  PinCab_Backglass.blenddisablelighting = 0.2
    DOF 126, DOFOff
    Dim bulb
    For each bulb in aGiLights
        bulb.State = 0
    Next
End Sub

' GI & light sequence effects

Sub GiEffect(n)
    Select Case n
        Case 0 'all off
            LightSeqGi.Play SeqAlloff
        Case 1 'all blink
            LightSeqGi.UpdateInterval = 4
            LightSeqGi.Play SeqBlinking, , 5, 100
        Case 2 'random
            LightSeqGi.UpdateInterval = 10
            LightSeqGi.Play SeqRandom, 5, , 1000
        Case 3 'upon
            LightSeqGi.UpdateInterval = 4
            LightSeqGi.Play SeqUpOn, 5, 1
        Case 4 ' left-right-left
            LightSeqGi.UpdateInterval = 5
            LightSeqGi.Play SeqLeftOn, 10, 1
            LightSeqGi.UpdateInterval = 5
            LightSeqGi.Play SeqRightOn, 10, 1
    End Select
End Sub

Sub LightEffect(n)
    Select Case n
        Case 0 ' all off
            LightSeqInserts.Play SeqAlloff
        Case 1 'all blink
            LightSeqInserts.UpdateInterval = 4
            LightSeqInserts.Play SeqBlinking, , 5, 100
        Case 2 'random
            LightSeqInserts.UpdateInterval = 10
            LightSeqInserts.Play SeqRandom, 5, , 1000
        Case 3 'upon
            LightSeqInserts.UpdateInterval = 4
            LightSeqInserts.Play SeqUpOn, 10, 1
        Case 4 ' left-right-left
            LightSeqInserts.UpdateInterval = 5
            LightSeqInserts.Play SeqLeftOn, 10, 1
            LightSeqInserts.UpdateInterval = 5
            LightSeqInserts.Play SeqRightOn, 10, 1
    End Select
End Sub

' Flasher Effects

Dim FEStep, FEffect
FEStep = 0
FEffect = 0

Sub FlashEffect(n)
    Select case n
        Case 1:FEStep = 0:FEffect = 1:FlashEffectTimer.Enabled = 1 'all blink
        Case 2:FEStep = 0:FEffect = 2:FlashEffectTimer.Enabled = 1 'random
        Case 3:FEStep = 0:FEffect = 3:FlashEffectTimer.Enabled = 1 'upon
        Case 4:FEStep = 0:FEffect = 4:FlashEffectTimer.Enabled = 1 'ordered random :)
    End Select
End Sub

Sub FlashEffectTimer_Timer()

End Sub

Dim BEStep, BEffect
BEStep = 0
BEffect = 0


' *********************************************************************
'                      Supporting Ball & Sound Functions
' *********************************************************************

Function Vol(ball) ' Calculates the Volume of the sound based on the ball speed
    Vol = Csng(BallVel(ball) ^2 / 2000)
End Function

Function Pan(ball) ' Calculates the pan for a ball based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = ball.x * 2 / table1.width-1
    If tmp > 0 Then
        Pan = Csng(tmp ^10)
    Else
        Pan = Csng(-((- tmp) ^10))
    End If
End Function

Function Pitch(ball) ' Calculates the pitch of the sound based on the ball speed
    Pitch = BallVel(ball) * 20
End Function

Function BallVel(ball) 'Calculates the ball speed
    BallVel = (SQR((ball.VelX ^2) + (ball.VelY ^2)))
End Function

Function AudioFade(ball) 'only on VPX 10.4 and newer
    Dim tmp
    tmp = ball.y * 2 / Table1.height-1
    If tmp > 0 Then
        AudioFade = Csng(tmp ^10)
    Else
        AudioFade = Csng(-((- tmp) ^10))
    End If
End Function

Sub PlaySoundAt(soundname, tableobj) 'play sound at X and Y position of an object, mostly bumpers, flippers and other fast objects
    PlaySound soundname, 0, VolSfx, Pan(tableobj), 0, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtBall(soundname) ' play a sound at the ball position, like rubbers, targets
    PlaySound soundname, 0, Vol(ActiveBall), pan(ActiveBall), 0, Pitch(ActiveBall), 0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtVol(soundname, tableobj, Volume)
  PlaySound soundname, 1, Volume, Pan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

Sub PlaySoundVol(soundname, Volume)
  PlaySound soundname, 1, Volume
End Sub

Sub PlaySoundLoopVol(soundname, Volume)
  PlaySound soundname, -1, Volume
End Sub


'********************************************
'   JP's VP10 Rolling Sounds + Ballshadow
' uses a collection of shadows, aBallShadow
'********************************************

Const tnob = 20 ' total number of balls
Const lob = 0   'number of locked balls
ReDim rolling(tnob)
InitRolling

Sub InitRolling
    Dim i
    For i = 0 to tnob
        rolling(i) = False
    Next
End Sub

Sub RollingUpdate()
    Dim BOT, b, ballpitch, ballvol
    BOT = GetBalls

    ' stop the sound of deleted balls
    For b = UBound(BOT) + 1 to tnob
        rolling(b) = False
        StopSound("fx_ballrolling" & b)
    Next

    ' exit the sub if no balls on the table
    If UBound(BOT) = lob - 1 Then Exit Sub 'there no extra balls on this table

  'debug.print lob & " " & UBound(BOT)

    ' play the rolling sound for each ball and draw the shadow
    For b = lob to UBound(BOT)
    'debug.print "b"

    aBallShadow(b).X = BOT(b).X
    aBallShadow(b).Y = BOT(b).Y

        If BallVel(BOT(b) )> 1 Then
            If BOT(b).z <30 Then
                ballpitch = Pitch(BOT(b) )
                ballvol = Vol(BOT(b) )
            Else
                ballpitch = Pitch(BOT(b) ) + 25000 'increase the pitch on a ramp
                ballvol = Vol(BOT(b) ) * 10
            End If
            rolling(b) = True
            PlaySound("fx_ballrolling" & b), -1, ballvol, Pan(BOT(b) ), 0, ballpitch, 1, 0, AudioFade(BOT(b) )
        Else
            If rolling(b) = True Then
                StopSound("fx_ballrolling" & b)
                rolling(b) = False
            End If
        End If
        ' rothbauerw's Dropping Sounds
        If BOT(b).VelZ < -1 and BOT(b).z < 55 and BOT(b).z > 27 Then 'height adjust for ball drop sounds
            PlaySound "fx_balldrop", 0, ABS(BOT(b).velz)/17, Pan(BOT(b)), 0, Pitch(BOT(b)), 1, 0, AudioFade(BOT(b))
        End If
    Next
End Sub
'**********************
' Ball Collision Sound
'**********************

Sub OnBallBallCollision(ball1, ball2, velocity)
    PlaySound("fx_collide"), 0, Csng(velocity) ^2 / 2000, Pan(ball1), 0, Pitch(ball1), 0, 0, AudioFade(ball1)
End Sub

'******************************
' Diverse Collection Hit Sounds
'******************************

Sub aMetals_Hit(idx):PlaySoundAtBall "fx_MetalHit":End Sub
Sub aRubber_Bands_Hit(idx):PlaySoundAtBall "fx_rubber_band":End Sub
Sub aRubber_Posts_Hit(idx):PlaySoundAtBall "fx_rubber_post":End Sub
Sub aRubber_Pins_Hit(idx):PlaySoundAtBall "fx_rubber_pin":End Sub
Sub aYellowPins_Hit(idx):PlaySoundAtBall "fx_rubber_pin":End Sub
Sub aPlastics_Hit(idx):PlaySoundAtBall "fx_PlasticHit":End Sub
Sub aGates_Hit(idx):PlaySoundAtBall "fx_Gate":End Sub
Sub aWoods_Hit(idx):PlaySoundAtBall "fx_Woodhit":End Sub
Sub aCaptiveWalls_Hit(idx):PlaySoundAtBall "fx_collide":End Sub




' Some quotes from the 2 first movies

Sub PlayQuote_timer() 'one quote each 2 minutes
    Dim Quote
    Quote = "gg_quote" & INT(RND * 30) + 1
    PlaySoundVol Quote, VolDef
End Sub

' *********************************************************************
'                        User Defined Script Events
' *********************************************************************

' Initialise the Table for a
'
Sub ResetForNewGame()
    Dim i

    bGameInPLay = True
  TextBox001.Text=""
  tmrBallSearch.Interval = kBallSearchTimeout
  BallSearchCnt = 0
  tmrBallSearch.Enabled = True

    'resets the score display, and turn off attrack mode
    StopAttractMode
    GiOn

    TotalGamesPlayed = TotalGamesPlayed + 1
    CurrentPlayer = 0
    PlayersPlayingGame = 1
    bOnTheFirstBall = True
  PlayMultiplier = 1
    For i = 0 To MaxPlayers-1
        Score(i) = 0
        BonusPoints(i) = 0
        BonusHeldPoints(i) = 0
        BonusMultiplier = 1
        BallsRemaining(i) = BallsPerGame
        ExtraBallsAwards(i) = 0
    TiltCount(i) = 0
    Next

    ' initialise any other flags
    Tilt = 0

    ' initialise Game variables
    Game_Init()
  UpdateNumberPlayers   ' Do the first one

    ' you may wish to start some music, play a sound, do whatever at this point

    ' set up the start delay to handle any Start of Game Attract Sequence
    vpmtimer.addtimer 1500, "FirstBall '"
End Sub

' This is used to delay the start of a game to allow any attract sequence to
' complete.  When it expires it creates a ball for the player to start playing with

Sub FirstBall
    ' reset the table for a new ball
    ResetForNewPlayerBall()
    ' create a new ball in the shooters lane
  If bResetCurrentGame = False then
    CreateNewBall()
  End If
  bResetCurrentGame = False
End Sub

' (Re-)Initialise the Table for a new ball (either a new ball after the player has
' lost one or we have moved onto the next player (if multiple are playing))

Sub ResetForNewPlayerBall()
    ' make sure the correct display is upto date
    AddScore 0

    ' set the current players bonus multiplier back down to 1X
    SetBonusMultiplier 1
  MultiplierShot = 1
  bShotMultiplierSelect = False
  bWizardMode = False

  ' Clear shot multipliers
  lDrax_m.UserValue =0
  lGamora_m.UserValue =0
  lYando_m.UserValue =0
  lRocket_m.UserValue =0
  lgr_m.UserValue =0
  lNebula_m.UserValue = 0
  lBroker_m.UserValue =0
  lStarLord_m.UserValue =0
  lRonan_m.UserValue =0


    ' reset any drop targets, lights, game modes etc..

    BonusPoints(CurrentPlayer) = 0
    bBonusHeld = False
    bExtraBallWonThisBall = False
  'GrootMouth_Drop(False)
    'ResetNewBallLights()
    'Reset any table specific
    ResetNewBallVariables

    'This is a new ball, so activate the ballsaver
    bBallSaverReady = True

    'and the skillshot
  lNova_sw8.UserValue = 2
  lNova_sw9.UserValue = 0
  bSkillshotSelect = True
    bSkillShotReady = True
debug.print "Reset Skillshot"
  bSkillshotsReady(0) = True    ' First Inlane
  bSkillshotsReady(1) = True    ' First Inlan without touching flippers
  bSkillshotsReady(2) = False   ' Hold Left, Loop around and hit Orb, Right Ramp or Right Orbit
  SuperSkillShotIndex=-1
  if bPlayerModeSelect = False and PlayerMode <> 5 then     ' Set the lights
    SetLightColor lNova_sw8, "orange", lNova_sw8.UserValue
    SetLightColor lNova_sw9, "orange", lNova_sw9.UserValue
  End If

'Change the music ?
End Sub

' Create a new ball on the Playfield

Sub CreateNewBall()
  ' James DOF
  DOF 321, DOFOff
  DOF 322, DOFOff
  DOF 323, DOFOff
  DOF 324, DOFOff

    ' create a ball in the plunger lane kicker.
  bCreatedBall = True
    BallRelease.CreateSizedball BallSize / 2
  BumperMultiplier=BumperMultiplier+1

    ' There is a (or another) ball on the playfield
    BallsOnPlayfield = BallsOnPlayfield + 1

    ' kick it out..
    BallRelease.Kick 290, 10
    PlaySoundAt SoundFXDOF("fx_Ballrel", 121, DOFPulse, DOFContactors), BallRelease

' if there is 2 or more balls then set the multibal flag (remember to check for locked balls and other balls used for animations)
' set the bAutoPlunger flag to kick the ball in play automatically
    If BallsOnPlayfield > 1 Then
        DOF 129, DOFPulse
'debug.print "SETTING MULTIBALL MODE " & BallsOnPlayfield & "!!!!!!!!!!!!!!!!!!"
        bMultiBallMode = True
        bAutoPlunger = True
    End If
End Sub

Sub CreateNewBallGroot()
  BumperMultiplier=BumperMultiplier+1
    ' create a ball in the plunger lane kicker.
    GrootKicker.CreateSizedball BallSize / 2

    ' There is a (or another) ball on the playfield
    BallsOnPlayfield = BallsOnPlayfield + 1

    ' kick it out..
    'GrootKicker.Kick 180, 10
  GrootKicker.Kick (180 + (6*RND-2)), 20
  PlaySoundAt SoundFXDOF("fx_Ballrel", 114, DOFPulse, DOFContactors), GrootKicker
  DOF 112, DOFPulse

' if there is 2 or more balls then set the multibal flag (remember to check for locked balls and other balls used for animations)
' set the bAutoPlunger flag to kick the ball in play automatically
    If BallsOnPlayfield > 1 Then
'debug.print "GROOT SETTING MULTIBALL MODE " & BallsOnPlayfield & "!!!!!!!!!!!!!!!!!!"
        DOF 129, DOFPulse
        bMultiBallMode = True
    End If
End Sub

' Add extra balls to the table with autoplunger
' Use it as AddMultiball 4 to add 4 extra balls to the table

Sub AddMultiball(nballs)
    mBalls2Eject = mBalls2Eject + nballs
    CreateMultiballTimer.Enabled = True
End Sub
Sub AddMultiballFast(nballs)
  if CreateMultiballTimer.Enabled = False then
    CreateMultiballTimer.Interval = 100   ' shortcut the first time through
  End If
   AddMultiball(nballs)
End Sub

' Eject the ball after the delay, AddMultiballDelay
Sub CreateMultiballTimer_Timer()
    ' wait if there is a ball in the plunger lane
  CreateMultiballTimer.Interval = 2000
    If bBallInPlungerLane Then
        Exit Sub
    Else
        If BallsOnPlayfield < MaxMultiballs Then
            CreateNewBall()
            mBalls2Eject = mBalls2Eject -1
            If mBalls2Eject = 0 Then 'if there are no more balls to eject then stop the timer
                Me.Enabled = False
            End If
        Else 'the max number of multiballs is reached, so stop the timer
            mBalls2Eject = 0
            Me.Enabled = False
        End If
    End If
End Sub


Sub BonusAddModeHit(Index)
  if Index <> -1 then   ' We are adding the standard bonus
    Select case index
      case "0"  ' Yando
        BonusArrowHits(index) = BonusArrowHits(index) + 5000
      case "1" ' Ronan
        BonusArrowHits(index) = BonusArrowHits(index) + 4000
      case "2" ' Rocket
        BonusArrowHits(index) = BonusArrowHits(index) + 5000
      case "3" ' Nebula
        BonusArrowHits(index) = BonusArrowHits(index) + 3000
      case "4" ' Groot
        BonusArrowHits(index) = BonusArrowHits(index) + 2000
      case "5" ' Broker
        BonusArrowHits(index) = BonusArrowHits(index) + 3000
      case "6" ' Gamora
        BonusArrowHits(index) = BonusArrowHits(index) + 3000
      case "7" ' Drax
        BonusArrowHits(index) = BonusArrowHits(index) + 4000
      case "8"  ' StarLord
        BonusArrowHits(index) = BonusArrowHits(index) + 5000
    End Select
debug.print "BonusAddModeHit " & index &  " " & BonusArrowHits(index)
    'BonusAddMode(-1) ' Add the default bonus for this
  End if
End Sub

Sub BonusAddMode(value, bDoublePoints)
  Dim BonusIndex
  dim BonusValue
  BonusIndex = 0
  BonusValue = 0
  if PlayerMode <> -1 then
    Select case PlayerMode
      case 0 ' Nebula
        BonusIndex = 3
        BonusValue = 300000
      case 1 ' Ronan
        BonusIndex = 1
        if (BonusModeValue(BonusIndex) = 0) then
          BonusValue = 300000
        else
          BonusValue = 200000
        End If
      case 2 ' Yandu
        BonusIndex = 0
        if (BonusModeValue(BonusIndex) = 0) then
          BonusValue = 1000000
        else
          BonusValue = 500000
        End If
      case 3 ' Star Lord
        BonusIndex = 8
        BonusValue = 0    ' BONUS is the countdown timer
      case 4 ' Drax
        BonusIndex = 7
        BonusValue = 400000
      case 5 ' Rocket
        BonusIndex = 2
        BonusValue = 300000
      case 6 ' Gamora
        BonusIndex = 6
        BonusValue = 400000
      case 7 ' Broker
        BonusIndex = 5
        BonusValue = 400000
    End Select
'debug.print "Bonus " & PlayerMode & " " & BonusIndex & " " & BonusValue & " OldVal: " & BonusModeValue(BonusIndex) & " Double:" & bDoublePoints
    if bDoublePoints then BonusValue = BonusValue * 2

    BonusModeValue(BonusIndex) = BonusModeValue(BonusIndex) + BonusValue
    AddScore BonusModeValue(BonusIndex)
    if value = -1 Then
      BonusModeTotal(BonusIndex) = BonusModeTotal(BonusIndex) +  BonusModeValue(BonusIndex)
    else
      BonusModeTotal(BonusIndex) = BonusModeTotal(BonusIndex) + value
    end if
  End If
End Sub

' The Player has lost his ball (there are no more balls on the playfield).
' Handle any bonus points awarded
Dim tmpBonusTotal
dim bonusCnt
Sub tmrEndOfBallBonus_Timer()
  dim i, a
  dim mode
  dim tmpModeIndex
  dim ModeBonus
  dim bAddedBonus
  Dim bDone
  dim FastBonus
  bDone = False
  mode=0
  i=0
  FastBonus = 0
  tmrEndOfBallBonus.Interval = 510
  tmrEndOfBallBonus.Enabled = False
  bAddedBonus = False

  if tmrEndOfBallBonus.UserValue = 0 then
    aRampLightsSave   ' Save off the ramp colors
  End If

  ' Turn off the Name lights as we cycle through them
  SetLightColor lYonduName, "blue-light", 0
  SetLightColor lYonduArrow, "blue-light", 0
  DOF 300, DOFOff                     ' James DOF
  SetLightColor lRonanName, "yellow", 0
  SetLightColor lRonanArrow, "yellow", 0
  DOF 301, DOFOff                     ' James DOF
  SetLightColor lRocketName, "red", 0
  SetLightColor lRocketArrow, "red", 0
  DOF 302, DOFOff                     ' James DOF
  SetLightColor lNebulaName, "blue", 0
  SetLightColor lNebulaArrow, "blue", 0
  DOF 303, DOFOff                     ' James DOF
  SetLightColor lgr, "green", 0
  SetLightColor lgr_a, "green", 0
  DOF 304, DOFOff                     ' James DOF
  SetLightColor lBrokerName, "cyan", 0
  SetLightColor lBrokerArrow, "cyan", 0
  DOF 305, DOFOff                     ' James DOF
  SetLightColor lGamoraName, "green", 0
  SetLightColor lGamoraArrow, "green", 0
  DOF 306, DOFOff                     ' James DOF
  SetLightColor lDraxName, "amber", 0
  SetLightColor lDraxArrow, "amber", 0
  DOF 307, DOFOff                     ' James DOF
  SetLightColor lStarLordName, "orange", 0
  SetLightColor lStarLordArrow, "orange", 0
  DOF 308, DOFOff                     ' James DOF

  if LFPress = 1 or RFPress = 1 then    ' Holding flippers speed up bonus
    FastBonus = 1000
    tmrEndOfBallBonus.Interval = 100
  End If


'debug.print "Start " & tmrEndOfBallBonus.UserValue
  Select case INT(tmrEndOfBallBonus.UserValue)
    case 0  ' Show Mode Total
      tmpBonusTotal = 0
      bonusCnt=0
      tmrEndOfBallBonus.UserValue = 1.0
      tmrEndOfBallBonus.Interval = 1500 - FastBonus
      DMD FormatScore(ModePoints), CL(1, "MODE POINTS"), "", eBlink, eNone, eNone, 1000, False, "gg_Camera"
debug.print "ModePoints: " & ModePoints
    case 1  ' Scroll through Hit Bonus (1.x)
      mode = CInt((tmrEndOfBallBonus.UserValue - 1) * 10)   ' Get the .x for the second part of mode
      For i = mode to 8
debug.print "BonusIdx: " & i & " " & BonusArrowHits(i)
        if (BonusArrowHits(i) <> 0 or BonusModeTotal(i) <> 0) and bAddedBonus=False then  ' If we have any bonus points
          bAddedBonus=True
          bonusCnt=bonusCnt+1
          'pDMDEvent(kDMD_BonusBG+1+i)

          ModeBonus = BonusArrowHits(i)     ' All the bonus points accumulated for this mode
          tmpModeIndex = Bonus2ModeIndex(i)
          if tmpModeIndex <> -1 then                ' Make sure we got something valid
            if ModePercent(tmpModeIndex) >= 100 or bXandarDone then   ' If you completed the level you get 2x of your total mode bonus points (If we didnt play the level BonusModeTotal will be 0)
              if Light031.state = 1 then ' Xandard complete (add another 0.25)
                ModeBonus = ModeBonus + (BonusModeTotal(i) / 2) + (BonusModeTotal(i) / 4)
              Else
                ModeBonus = ModeBonus + (BonusModeTotal(i) / 2)
              End If
            End If
          End If
          tmpBonusTotal = tmpBonusTotal + ModeBonus
if tmpModeIndex <> -1 then debug.print "BL: " & i & " - HITS: " & BonusArrowHits(i) & " ModeBonus: " & BonusModeTotal(i) & " TotalBonus:" & ModeBonus &  " ModePercent: " & ModePercent(tmpModeIndex) & " " & tmpModeIndex
          DOF 300 +i, DOFOn               ' James DOF
          Select case i
            case 0  ' Yando
              SetLightColor lYonduName, "blue-light", 2
              SetLightColor lYonduArrow, "blue-light", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.1
              DMD CL(1, "YANDU BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "YANDU BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus1", "PuPOverlays\\Bonus1g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':2.3}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval, "PuPlayer.LabelSet pBonusScreen, ""Bonus1"", ""PuPOverlays\\Bonus1.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':2.3}"" '"
            case 1 ' Ronan
              SetLightColor lRonanName, "yellow", 2
              SetLightColor lRonanArrow, "yellow", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.2
              DMD CL(1, "RONAN BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "RONAN BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus2", "PuPOverlays\\Bonus2g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':12}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval,"PuPlayer.LabelSet pBonusScreen, ""Bonus2"", ""PuPOverlays\\Bonus2.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':12}"" '"
            case 2 ' Rocket
              SetLightColor lRocketName, "red", 2
              SetLightColor lRocketArrow, "red", 2
              'PuPlayer.playlistplayex pPopUP2,"PuPOverlays","BonusScreen-2.mp4",0,20
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.3
              DMD CL(1, "ROCKET BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "ROCKET BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus3", "PuPOverlays\\Bonus3g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':21.4}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval,"PuPlayer.LabelSet pBonusScreen, ""Bonus3"", ""PuPOverlays\\Bonus3.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':21.4}"" '"
            case 3 ' Nebula
              SetLightColor lNebulaName, "blue", 2
              SetLightColor lNebulaArrow, "blue", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.4
              DMD CL(1, "NEBULA BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False,"Bonus-" & i+1
              pBgShowBonus "NEBULA BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus4", "PuPOverlays\\Bonus4g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':30.5}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval,"PuPlayer.LabelSet pBonusScreen, ""Bonus4"", ""PuPOverlays\\Bonus4.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':30.5}"" '"
            case 4 ' Groot
              SetLightColor lgr, "green", 2
              SetLightColor lgr_a, "green", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.5
              DMD CL(1, "GROOT BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "GROOT BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus5", "PuPOverlays\\Bonus5g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':39.5}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval,"PuPlayer.LabelSet pBonusScreen, ""Bonus5"", ""PuPOverlays\\Bonus5.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':39.5}"" '"
            case 5 ' Broker
              SetLightColor lBrokerName, "cyan", 2
              SetLightColor lBrokerArrow, "cyan", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.6
              DMD CL(1, "BROKER BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "BROKER BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus6", "PuPOverlays\\Bonus6g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':49}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval,"PuPlayer.LabelSet pBonusScreen, ""Bonus6"", ""PuPOverlays\\Bonus6.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':49}"" '"
            case 6 ' Gamora
              SetLightColor lGamoraName, "green", 2
              SetLightColor lGamoraArrow, "green", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.7
              DMD CL(1, "GAMORA BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "GAMORA BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus7", "PuPOverlays\\Bonus7g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':58.5}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval,"PuPlayer.LabelSet pBonusScreen, ""Bonus7"", ""PuPOverlays\\Bonus7.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':58.5}"" '"
            case 7 ' Drax
              SetLightColor lDraxName, "amber", 2
              SetLightColor lDraxArrow, "amber", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 1.8
              DMD CL(1, "DRAX BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "DRAX BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus8", "PuPOverlays\\Bonus8g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':67.5}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval,"PuPlayer.LabelSet pBonusScreen, ""Bonus8"", ""PuPOverlays\\Bonus8.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':67.5}"" '"
            case 8  ' StarLord
              SetLightColor lStarLordName, "orange", 2
              SetLightColor lStarLordArrow, "orange", 2
'             ModeBonus = BonusArrowHits(i) + (BonusModeTotal(i) / 2)
'             tmpBonusTotal = tmpBonusTotal + ModeBonus
              tmrEndOfBallBonus.UserValue = 2
              DMD CL(1, "STARLORD BONUS"), FormatScore(ModeBonus), "", eBlink, eNone, eNone, 500, False, "Bonus-" & i+1
              pBgShowBonus "STARLORD BONUS", FormatScore(ModeBonus)
              PuPlayer.LabelSet pBonusScreen, "Bonus9", "PuPOverlays\\Bonus9g.png",1,"{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':77}"
              vpmtimer.addtimer tmrEndOfBallBonus.Interval, "PuPlayer.LabelSet pBonusScreen, ""Bonus9"", ""PuPOverlays\\Bonus9.png"",1,""{'mt':2,'color':111111,'width':20, 'height':52,'yalign':0,'ypos':9,'xpos':77}"" '"
          End Select
        End If
      Next
      if bAddedBonus = False then
        tmrEndOfBallBonus.Interval = 200
        tmrEndOfBallBonus.UserValue = 2
      End If
    case 2
      pBgShowBonus "TOTAL BONUS x " & BonusMultiplier, FormatScore(tmpBonusTotal) ' Some reason I have to send this twice???
      tmrEndOfBallBonus.UserValue = 3
    case 3  ' Show Total Bonus
      SetLightColor LightGuardians, "white", 2
      tmrEndOfBallBonus.UserValue = 4
      tmrEndOfBallBonus.Interval = 1000 - FastBonus
      DMD CL(1, "TOTAL BONUS"), FormatScore(tmpBonusTotal), "", eBlink, eNone, eNone, 1000, False,  "Bonus-10"
      pBgShowBonus "TOTAL BONUS x " & BonusMultiplier, FormatScore(tmpBonusTotal)

      AddScore (tmpBonusTotal * BonusMultiplier)
      SetBonusMultiplier 1    ' Push it back down to 1


    case 4
      pDMDEvent(470)
      For i = 0 to 8
        PuPlayer.LabelSet pBonusScreen, "Bonus" & i+1, "", 0,""
      Next
      vpmtimer.addtimer 200, "playclear pBonusScreen '"

      ' Reset xandar if you beat it
      bXandarDone = False

      pBgShowBonus "", " "
      pBgShowBonus "", ""
      SetLightColor LightGuardians, "white", 0
      aRampLightsRestore    ' Restore ramp colors

      pBGGamePlay     ' Change the backglass to the play mode
      pDMDSetPage(pScores)
      WaitPlayerMode
      CheckWizardModesReady

      vpmtimer.addtimer 200, "EndOfBall2 '"
'     debug.print "CLEAR"
      pDMDEvent(kDMD_BonusClear)

      bDone = True
      exit sub
  End Select

tmrEndOfBallBonus.Enabled = True

End Sub

Sub EndOfBall()
    Dim AwardPoints, TotalBonus, ii
    AwardPoints = 0
    TotalBonus = 0
    ' the first ball has been lost. From this point on no new players can join in
    bOnTheFirstBall = False
  if PlayerMode <> -1 Then      ' Pause the countdown timer
    ModeCountdownTimer.Enabled = False
  End If

    ' only process any of this if the table is not tilted.  (the tilt recovery
    ' mechanism will handle any extra balls or end of game)

    If(Tilted = False)Then

        ' Count the bonus. This table uses several bonus
        DMDflush
    GrootMBJackpot = 0

    if bUsePupDMD then PuPlayer.LabelShowPage pBonusScreen,1,0,"":PuPlayer.LabelShowPage pBackglass, 2,0,""

    pDMDEvent(kDMD_BonusBG)
    playmedia "Video-0x007A-2.mp4", "PupVideos", pBonusScreen, "", -1, "", 1, 1
    'This command merged Black and White background with video
    '    ffmpeg -i Video-0x007A.mp4  -i BonusScreen-BW2.png -filter_complex "[1:v]scale=1360:768 [ovrl],[0:v][ovrl]overlay=(main_w-overlay_w)/2:(main_h-overlay_h)/2" -strict -2 ./output.mp4


        ' add a bit of a delay to allow for the bonus points to be shown & added up
    tmrEndOfBallBonus.Interval = 800
    tmrEndOfBallBonus.UserValue = 0   ' Timer will start EndOfBall2 when it is done
    tmrEndOfBallBonus.Enabled = true
    Else
        vpmtimer.addtimer 100, "EndOfBall2 '"
    End If
End Sub

' The Timer which delays the machine to allow any bonus points to be added up
' has expired.  Check to see if there are any extra balls for this player.
' if not, then check to see if this was the last ball (of the currentplayer)
'
Sub EndOfBall2()
  dim i
  dim thisMode
    ' if were tilted, reset the internal tilted flag (this will also
    ' set TiltWarnings back to zero) which is useful if we are changing player LOL
    Tilted = False
    Tilt = 0
  PlayMultiplier = 1
    DisableTable False 'enable again bumpers and slingshots
  If PlayerMode = -1 and bCompetitionMode = False and bCherryBombReady=False Then     ' Dont go into a mode in CherryBomb is ready
    EnablePlayerSelect
  End If

  for i = 0 to 8  ' Clear Bonus counters
    BonusArrowHits(i) = 0

    ' Completing the mode allows you to carryover the BonusModeTotal instead of blanking it
    thisMode = Bonus2ModeIndex(i)
    if thisMode <> -1 then                ' Make sure we got something valid
      if ModePercent(thisMode) < 100 then BonusModeTotal(i) =  0
    End If
    'BonusModeTotal(i) = 0

    BonusModeValue(i) = 0
  next

    ' has the player won an extra-ball ? (might be multiple outstanding)
    If(ExtraBallsAwards(CurrentPlayer) <> 0) and bBallInPlungerLane=False Then  ' Save Extra ball for later if there is a ball in the plunger lane
        debug.print "Extra Ball"

        ' yep got to give it to them
        ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer)- 1

        ' if no more EB's then turn off any shoot again light
        If(ExtraBallsAwards(CurrentPlayer) = 0)Then
            LightShootAgain.State = 0
      LightShootAgain2.State = 0
        End If

        ' You may wish to do a bit of a song AND dance at this point
        DMD "_", CL(1, ("EXTRA BALL")), "_", eNone, eBlink, eNone, 1000, True, "vo_extraball"

    if INT(RND * 2) = 0 then
      pDMDEvent(kDMD_ExtraBall)
    Else
      pDMDEvent(kDMD_ShootAgain)
    End If

        ' Create a new ball in the shooters lane
        CreateNewBall()
    Else ' no extra balls

        BallsRemaining(CurrentPlayer) = BallsRemaining(CurrentPlayer)- 1

        ' was that the last ball ?
        If(BallsRemaining(CurrentPlayer) <= 0) Then       ' GAME OVER
            debug.print "No More Balls, High Score Entry"
      if bUsePupDMD then
        PuPlayer.PlayStop pOverVid            ' Stop overlay if there is one
        PuPlayer.SetLoop pOverVid, 0
      End If
      playclear pAudio
      'StopSound "m_wait"
debug.print "Stopping sound m_wait"
      StopPlayerMode
      StopPlayerMode2

      ' Turn off DOF so we dont accidently leave it on
      PlaySoundAt SoundFXDOF("fx_flipperdown", 101, DOFOff, DOFFlippers), LeftFlipper
      LeftFlipper.RotateToStart
      PlaySoundAt SoundFXDOF("fx_flipperdown", 102, DOFOff, DOFFlippers), RightFlipper
      RightFlipper.RotateToStart

            ' Submit the currentplayers score to the High Score system
            CheckHighScore()
      ' you may wish to play some music at this point
        Else
            ' not the last ball (for that player)
            ' if multiple players are playing then move onto the next one
            EndOfBallComplete()
        End If
    End If
End Sub

' This function is called when the end of bonus display
' (or high score entry finished) AND it either end the game or
' move onto the next player (or the next ball of the same player)
'all of the same player)
'
Sub EndOfBallComplete()
    Dim NextPlayer
  dim Match

    debug.print "EndOfBall - Complete"

    ' are there multiple players playing this game ?
    If(PlayersPlayingGame > 1)Then
        ' then move to the next player
        NextPlayer = CurrentPlayer + 1
        ' are we going from the last player back to the first
        ' (ie say from player 4 back to player 1)
        If(NextPlayer > PlayersPlayingGame-1)Then
            NextPlayer = 0
        End If
    Else
        NextPlayer = CurrentPlayer
    End If

    debug.print "Next Player = " & NextPlayer

    ' is it the end of the game ? (all balls been lost for all players)
    If((BallsRemaining(CurrentPlayer) <= 0)AND(BallsRemaining(NextPlayer) <= 0))Then
        ' you may wish to do some sort of Point Match free game award here
        ' generally only done when not in free play mode

    DisplayDMDText2 "_", "GAME OVER", 20000, 5, 0
    bGameInPLay = False                 ' EndOfGame sets this but need to set early to disable flippers
    bShowMatch = True

    ' Do Match end score code
    Match=10 * INT(RND * 9)
    'Match = Score(CurrentPlayer) mod 100   ' Force Match for testing
    'If Score(CurrentPlayer) mod 100 = Match Then
    if BigMod(Score(CurrentPlayer), 100) = Match then                 ' Handles large scores
      vpmtimer.addtimer 6000, "PlayYouMatched '"
    End If
    if Match = 0 then
      playmedia "Match-00.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
    Else
      playmedia "Match-"&Match&".mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
    End If
    vpmtimer.addtimer 100, "PlaySoundVol ""Match-Score"", VolDef '"
        ' set the machine into game over mode
    if osbactive <> 0 then  ' Orbital takes more time
      vpmtimer.addtimer 9000, "if bShowMatch then EndOfGame() '"
    else
      vpmtimer.addtimer 8000, "if bShowMatch then EndOfGame() '"
    End If

    ' you may wish to put a Game Over message on the desktop/backglass

    Else
        ' set the next player
    PlayerState(CurrentPlayer).bFirstBall = False
    PlayerState(CurrentPlayer).Save
        CurrentPlayer = NextPlayer
    UpdateNumberPlayers       ' Update the Score Sizes
        ' make sure the correct display is up to date
        AddScore 0

        ' reset the playfield for the new player (or new ball)
        ResetForNewPlayerBall()

    PlayerState(CurrentPlayer).Restore

        ' AND create a new ball
        CreateNewBall()

        ' play a sound if more than 1 player
        If PlayersPlayingGame > 1 Then
            PlaySoundVol "say-player" &CurrentPlayer+1, VolDef
            DMD "", CL(1, "PLAYER " &CurrentPlayer+1), "", eNone, eNone, eNone, 800, True, ""
        End If
    End If
End Sub

' This function is called at the End of the Game, it should reset all
' Drop targets, AND eject any 'held' balls, start any attract sequences etc..

Sub EndOfGame()
    debug.print "End Of Game"
  StopPlayerMode
  StopPlayerMode2
    bGameInPLay = False
  bShowMatch = False
  tmrBallSearch.Enabled = False
    ' just ended your game then play the end of game tune
    If NOT bJustStarted Then
        PlaySong "m_end"
    End If
    bJustStarted = False
    ' ensure that the flippers are down
    SolLFlipper 0
    SolRFlipper 0
  LFPress=0
  RFPress=0

  ' Drop the target just in case the ball is behind it (just in Case)
  OrbTarget1.IsDropped = True
  vpmtimer.addtimer 1000, "OrbTargetReset'"

    ' terminate all modes - eject locked balls
    ' most of the modes/timers terminate at the end of the ball
    PlayQuote.Enabled = 0

  PlaySong "m_end"
  playmedia "m_end.mp3", MusicDir, pAudio, "", -1, "", 1, 1

    ' set any lights for the attract mode
    GiOff
  bFlash1Enabled = True
  bFlash2Enabled = True
  bFlash3Enabled = True
  bFlash4Enabled = True
  'tmrRedLightFlash.Enabled = True
  HadronFlash "", True
  pDMDGameOver

' you may wish to light any Game Over Light you may have
End Sub

Sub PlayYouMatched
  PlaySoundVol "YouMatchedPlayAgain", VolDef
  DOF 140, DOFOn
  DMDFlush
  DMD "_", CL(1, "CREDITS: " & Credits), "", eNone, eNone, eNone, 500, True, "fx_coin"
End Sub


Sub UpdateNumberPlayers
  dim text1Size
  dim text2Size
  dim text3Size
  dim text4Size
  if bUsePUPDMD = False then Exit Sub   ' just PUP (for now)
  Select case PlayersPlayingGame
    case 1:
      puPlayer.LabelSet pBackglass,"CurScore",FormatScore(score(0)),1,""
      puPlayer.LabelSet pBackglass,"Play1score","",0,""
      puPlayer.LabelSet pBackglass,"Play2score","",0,""
      puPlayer.LabelSet pBackglass,"Play3score","",0,""
      puPlayer.LabelSet pBackglass,"Play4score","",0,""
    case 2:
      if CurrentPlayer = 0 then text1Size=9*FontScale else text1Size=5*FontScale
      if CurrentPlayer = 1 then text2Size=9*FontScale else text2Size=5*FontScale
      puPlayer.LabelSet pBackglass,"CurScore","",0,""
      puPlayer.LabelSet pBackglass,"Play1score",FormatScore(score(0)),1,"{'mt':2,'size':  "&text1Size&", 'ypos': 100, 'xpos': 30, 'xalign': 0}"
      puPlayer.LabelSet pBackglass,"Play2score",FormatScore(score(1)),1,"{'mt':2,'size':  "&text2Size&", 'ypos': 100, 'xpos': 60, 'xalign': 0}"
      puPlayer.LabelSet pBackglass,"Play3score","0",0,""
      puPlayer.LabelSet pBackglass,"Play4score","0",0,""
    case 3:
      if CurrentPlayer = 0 then text1Size=9*FontScale else text1Size=5*FontScale
      if CurrentPlayer = 1 then text2Size=9*FontScale else text2Size=5*FontScale
      if CurrentPlayer = 2 then text3Size=9*FontScale else text3Size=5*FontScale
      puPlayer.LabelSet pBackglass,"CurScore","",0,""
      puPlayer.LabelSet pBackglass,"Play1score",FormatScore(score(0)),1,"{'mt':2,'size':  "&text1Size&", 'ypos': 100, 'xpos': 20, 'xalign': 0}"
      puPlayer.LabelSet pBackglass,"Play2score",FormatScore(score(1)),1,"{'mt':2,'size':  "&text2Size&", 'ypos': 100, 'xpos': 0,  'xalign': 1}"
      puPlayer.LabelSet pBackglass,"Play3score",FormatScore(score(2)),1,"{'mt':2,'size':  "&text3Size&", 'ypos': 100, 'xpos': 80, 'xalign': 0}"
      puPlayer.LabelSet pBackglass,"Play4score","0",0,""
    case 4:
      if CurrentPlayer = 0 then text1Size=8*FontScale else text1Size=4*FontScale
      if CurrentPlayer = 1 then text2Size=8*FontScale else text2Size=4*FontScale
      if CurrentPlayer = 2 then text3Size=8*FontScale else text3Size=4*FontScale
      if CurrentPlayer = 3 then text4Size=8*FontScale else text4Size=4*FontScale
      puPlayer.LabelSet pBackglass,"CurScore","",0,""
      puPlayer.LabelSet pBackglass,"Play1score",FormatScore(score(0)),1,"{'mt':2,'size':  "&text1Size&", 'ypos': 100, 'xpos':  0, 'xalign': 0}"
      puPlayer.LabelSet pBackglass,"Play2score",FormatScore(score(1)),1,"{'mt':2,'size':  "&text2Size&", 'ypos': 100, 'xpos': 30, 'xalign': 0}"
      puPlayer.LabelSet pBackglass,"Play3score",FormatScore(score(2)),1,"{'mt':2,'size':  "&text3Size&", 'ypos': 100, 'xpos': 60, 'xalign': 0}"
      puPlayer.LabelSet pBackglass,"Play4score",FormatScore(score(3)),1,"{'mt':2,'size':  "&text4Size&", 'ypos': 100, 'xpos':  0, 'xalign': 2}"
  End Select
End sub

Function Balls
    Dim tmp
    tmp = BallsPerGame - BallsRemaining(CurrentPlayer) + 1
    If tmp > BallsPerGame Then
        Balls = BallsPerGame
    Else
        Balls = tmp
    End If
End Function

Sub DoBallSave()
  if bGrootMultiball or bOrbMultiBall or tmrXandar.Enabled or tmrImmolation.Enabled or tmrCherryBomb.Enabled then exit sub  ' Dont play the clip during wizard modes since it shows up 1000 times

  if bUseUltraDMD then
    PlayDMDScene "vidBallSave.mp4", 4000
  Else
    pDMDEvent(kDMD_BallSave)
  End If
  DMD "_", CL(1, "BALL SAVED"), "_", eNone, eBlinkfast, eNone, 800, True, ""
End Sub


' *********************************************************************
'                      Drain / Plunger Functions
' *********************************************************************

' lost a ball ;-( check to see how many balls are on the playfield.
' if only one then decrement the remaining count AND test for End of game
' if more than 1 ball (multi-ball) then kill of the ball but don't create
' a new one
'
Sub Drain_Hit()

'DOF 124, DOFPulse    ' James DOF Commented

Dim tmpBallSaver
Dim queueTime

tmpBallSaver=BallSaverActiveBuffer <> 0
if BallSaverActiveBuffer>0 then BallSaverActiveBuffer = BallSaverActiveBuffer-1


if (LightShootAgain.state = 2 or LightShootAgain2.state =2) and bBallSaverActive=False then
' Msgbox "ERROR BALL SAVE"
  debug.print "ERROR Ball SAVE"
End If

    ' Destroy the ball
    Drain.DestroyBall
      ' Exit Sub ' only for debugging
    BallsOnPlayfield = BallsOnPlayfield - 1

    ' pretend to knock the ball into the ball storage mech
    PlaySoundAt "fx_drain",Drain
    'if Tilted the end Ball modes
    If Tilted Then
        StopEndOfBallModes
    End If
    ' if there is a game in progress AND it is not Tilted
    If(bGameInPLay = True)AND(Tilted = False)Then
        ' is the ball saver active (or did the switch catch us before the timer ran out)
        If bBallSaverActive or tmpBallSaver Then
            ' yep, create a new ball in the shooters lane
            ' we use the Addmultiball in case the multiballs are being ejected
      DOF 134, DOFPulse     ' James DOF
debug.print "Ball Save multiball"
            AddMultiball 1
            ' we kick the ball with the autoplunger
            bAutoPlunger = True
            ' you may wish to put something on a display or play a sound at this point
      DoBallSave
        Else
Debug.print "Drain " & BallsOnPlayfield & " " & RealBallsInLock & " " & bMultiBallMode
      if EndGrootMB(True) then exit Sub ' See if we need to throw more balls back into play

            ' cancel any multiball if on last ball (ie. lost all other balls)
            If(BallsOnPlayfield-RealBallsInLock = 1)Then
                ' AND in a multi-ball??
                If(bMultiBallMode = True)then
                    ' not in multiball mode any more
                    bMultiBallMode = False
                    ChangeGi "white"
                    ' turn off any multiball specific lights
                    'ResetJackpotLights
                    EndGrootMB(False)
          EndQuillMB
          EndImmolation(1)
                End If
            End If

      If(BallsOnPlayfield-RealBallsInLock <= 1)Then ' Stop Orb Multiball
        if (bOrbMultiBall) then ' Reset Orb Stuff
          bMultiBallMode = False          ' Release last locked ball. Stop Multiball
          StopOrbMultiball
        end if
      End If

            ' was that the last ball on the playfield
            If(BallsOnPlayfield - RealBallsInLock = 0)Then
                ' End Modes and timers
        EndGrootMB(False)
        EndXandar
        EndImmolation(0)
        StopPlayerMode2
        if bImmolationWait then     ' They drained all balls but completed immolation. (Verified video)
          bImmolationWait=False
          exit sub  ' We finished immolation
        End if

        'PauseSong
        if PlayerMode <> -1 then
          pausemedia pBackglass
          pausemedia pMusic
debug.print "Start  m_wait-1"
          'PlaySoundLoopVol "m_wait", VolMusic
          playmedia "m_wait.mp3", MusicDir, pAudio, "", -1, "", 1, 1
        End If
                StopEndOfBallModes
                ChangeGi "white"

        queueTime = getQueueTime          ' See if we need to let animations finish playing
        if queueTime = 0 then queueTime = 1500

                ' handle the end of ball (count bonus, change player, high score entry etc..)
                vpmtimer.addtimer queueTime, "EndOfBall '"
            End If

        End If
    End If
End Sub

' The Ball has rolled out of the Plunger Lane and it is pressing down the trigger in the shooters lane
' Check to see if a ball saver mechanism is needed and if so fire it up.

Sub swPlungerRest_Hit()
    debug.print "ball in plunger lane" & bPlayerModeSelect & " " & bAutoPlunger & " " & bCreatedBall
    ' some sound according to the ball position
    PlaySoundAt "fx_sensor", swPlungerRest
    bBallInPlungerLane = True
    ' turn on Launch light is there is one
    'LaunchLight.State = 2
    ' kick the ball in play if the bAutoPlunger flag is on

  if bCreatedBall = False then  ' If we didnt create a ball this must have gone up and back so kick it out automatically
    bAutoPlunger = True
  End if
  bCreatedBall = False

    If bAutoPlunger Then
        debug.print "autofire the ball"
        PlungerIM.AutoFire
        DOF 125, DOFPulse
    DOF 112, DOFPulse
        bAutoPlunger = False
    bAutoPlunged = True
    End If

  if (bPlayerModeSelect) Then
    if PlayerMode = -1 then SelectPlayerMode LeftFlipperKey
    UpdatePlayerMode()
    'PauseSong
    if PlayerState(CurrentPlayer).bFirstBall then
debug.print "Start  m_wait-2"
      'PlaySoundLoopVol "m_wait", VolDef
      playmedia "m_wait2.mp3", MusicDir, pAudio, "", -1, "", 1, 1
    End If
  End If

    ' remember last trigger hit by the ball.
    LastSwitchHit = "swPlungerRest"
End Sub

' The ball is released from the plunger turn off some flags and check for skillshot
Sub swPlungerRest_UnHit()
    bBallInPlungerLane = False
  DOF 125, DOFPulse       ' James DOF

  ResetBallSearch

  'if (bPlayerModeSelect) then pBGGamePlay      ' Change the backglass to the play mode

  ' Need to do this before the check model below because it will set the gate based on the mode
  'MsgBox LeftFlipper.CurrentAngle & " - " & LeftFlipper.EndAngle

  if (bAutoPlunged = False) then    ' Only start the skillshot if it is a manual plunge
    if LeftFlipper.CurrentAngle = LeftFlipper.EndAngle and bWizardMode = False Then ' No skill shot on Wizard Modes
      LoopGateLeft.Open = True    ' If they hold down the left flipper we open the back gate
      bSkillshotsReady(2) = True    ' Enable the third skillshot
      StackState(kStack_Pri3).Enable(-1)
      'msgbox randomNum
      SuperSkillShotIndex = INT(3 * RND)
      Select Case SuperSkillShotIndex
        case 0
          SSetLightColor kStack_Pri3, lBrokerArrow, "white", 2
        case 1
          SSetLightColor kStack_Pri3, lGamoraArrow, "white", 2
        case 2
          SSetLightColor kStack_Pri3, lDraxArrow, "white", 2
      End Select
    End If
    tmrSkillshot.Enabled = True
  End If
  bAutoPlunged =  False

  if (bXandarReady) then        ' There are no modes to start
    PlayerMode = -1
  End if

  ' Check Mode
  if (bPlayerModeSelect) Then
    DOF 300, DOFOff         ' James DOF
    DOF 301, DOFOff
    DOF 302, DOFOff
    DOF 303, DOFOff
    DOF 304, DOFOff
    DOF 305, DOFOff
    DOF 306, DOFOff
    DOF 307, DOFOff
    DOF 308, DOFOff
    pBGGamePlay           ' Change the backglass to the play mode
    aLightsSave           ' Always start the skillshot
    StartPlayerMode()       ' Start the mode and clear bPlayerModeSelect
    RotateSong()
  elseif PlayerMode <> -1 then    ' If a mode is selected we should start the timer back Update
    ModeCountdownTimer.enabled = True

    ' If we are paused resume media
    if bUsePupDMD then
      PuPlayer.PlayStop pOverVid
      PuPlayer.SetLoop pOverVid, 0
    End If
    RefreshPlayerMode
    'StopSound "m_wait"
    playclear pAudio
    resumemedia pBackglass
    resumemedia pMusic
  End If

  ' if there is a need for a ball saver, then start off a timer
    ' only start if it is ready, and it is currently not running, else it will reset the time period
debug.print "Ballsaver Ready:" &  bBallSaverReady & " T:" & BallSaverTime & " Active:" & bBallSaverActive
    If(bBallSaverReady = True)AND(BallSaverTime <> 0)And(bBallSaverActive = False)Then
        EnableBallSaver BallSaverTime
    End If

  if tmrCherryBomb.Enabled then  ' I think it has a countdown from rocket for each one also
    PlaySoundVol "gg_CBLaunch", VolDef
  End if

    If NOT bMultiballMode Then
    PlaySong ""
    End If
' turn off LaunchLight
'LaunchLight.State = 0
End Sub

Sub EnableBallSaver(seconds)
    debug.print "Ballsaver started " & seconds
    ' set our game flag
    bBallSaverActive = True
    bBallSaverReady = False
    ' start the timer
    BallSaverTimerExpired.Interval = 1000 * seconds
    BallSaverTimerExpired.Enabled = True
    BallSaverSpeedUpTimer.Interval = 1000 * seconds -(1000 * seconds) / 3
    BallSaverSpeedUpTimer.Enabled = True
    ' if you have a ball saver light you might want to turn it on at this point (or make it flash)
    LightShootAgain.BlinkInterval = 160
    LightShootAgain.State = 2
  LightShootAgain2.BlinkInterval = 160
  LightShootAgain2.State = 2
End Sub


Sub tmrSkillshot_Timer()
  if tmrSkillshot.Enabled then
    aHadronLightsRestore
    bSkillshotsReady(0) = False   ' First Inlane
    bSkillshotsReady(1) = False   ' First Inlan without touching flippers
    bSkillshotsReady(2) = False   ' Hold Left, Loop around and hit Orb, Right Ramp or Right Orbit
    StackState(kStack_Pri3).Disable
    Select Case SuperSkillShotIndex ' Turn it off
      case 0
        SetLightColorRestore lBrokerArrow, -1
      case 1
        SetLightColorRestore lGamoraArrow, -1
      case 2
        SetLightColorRestore lDraxArrow, -1
    End Select
    if PlayerMode = 5 then      ' Set the state based on progress
      SetLightColor lNova_sw8, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(3)
      SetLightColor lNova_sw9, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(4)
    Else
      'debug.print "SW Off"
      SetLightColor lNova_sw8, "orange", PlayerState(CurrentPlayer).lNovaStates(3)
      SetLightColor lNova_sw9, "orange", PlayerState(CurrentPlayer).lNovaStates(4)
    End If
    if PlayerMode <> 1 then   ' Ronan is the only one that needs to leave back gate open
      LoopGateLeft.Open = False
    End If
    tmrSkillshot.Enabled = False
  End if
End Sub

' The ball saver timer has expired.  Turn it off AND reset the game flag
'
Sub BallSaverTimerExpired_Timer()
debug.print "Ballsaver ended"
  BallSaverTimerExpired.Enabled = False
  vpmtimer.addtimer 1500, "bBallSaverActive = False '"      ' clear the flag after a slight buffer
    ' if you have a ball saver light then turn it off at this point
    LightShootAgain.State = 0
  LightShootAgain2.State = 0
  BallSaverTime = defBallSaverTime
End Sub

Sub BallSaverTimerCancel()
debug.print "Ballsaver Cancel"
  BallSaverTimerExpired.Enabled = False
  bBallSaverActive = False
    ' if you have a ball saver light then turn it off at this point
    LightShootAgain.State = 0
  LightShootAgain2.State = 0
  BallSaverTime = defBallSaverTime
End Sub

Sub BallSaverSpeedUpTimer_Timer()
    debug.print "Ballsaver Speed Up Light"
    BallSaverSpeedUpTimer.Enabled = False
    ' Speed up the blinking
    LightShootAgain.BlinkInterval = 80
    LightShootAgain.State = 2
    LightShootAgain2.BlinkInterval = 80
    LightShootAgain2.State = 2
End Sub

Sub SetBackglassTimer(value)
  if bUsePUPDMD then
    PuPlayer.LabelSet pBackglass,"Time", value    ,1,""
  else
    dim ones
    dim tens
    dim hund
    dim thou

    ones = value Mod 10
    tens = (value Mod 100) \ 10
    hund = (value Mod 1000) \ 100
    thou = (value Mod 10000) \ 1000
    if b2son then
      Controller.B2SSetReel 1, thou
      Controller.B2SSetReel 2, hund
      Controller.B2SSetReel 3, tens
      Controller.B2SSetReel 4, ones
    End If
  End If
End Sub

dim ModeCountdownTimerGrace
Sub ModeCountdownTimer_Timer()

  if ModeCountdownTimer.UserValue >0 then ModeCountdownTimer.UserValue = ModeCountdownTimer.UserValue -1
  SetBackglassTimer(ModeCountdownTimer.UserValue)

  'DMDScore     ' This wont do anything unless the score changes (I thought I would increment the score by 1 point every second but looks weird)
  if (ModeCountdownTimer.UserValue = 20) Then
    PlaySoundVol "YourTimeIsRunningOut", VolDef
  End If
  if ModeCountdownTimer.UserValue <= 5 then
    PlaySoundVol "gg_Guitar-4", VolDef
  End If
  if ModeCountdownTimer.UserValue = 1 then ModeCountdownTimerGrace=2  ' setup 2 second grace period
  if (ModeCountdownTimer.UserValue <= 0) Then
    ModeCountdownTimerGrace=ModeCountdownTimerGrace - 1
    if ModeCountdownTimerGrace <= 0 then
      PlaySoundVol "YourTimeIsUp", VolDef
      StopPlayerMode()
    End If
  End If
End Sub

' *********************************************************************
'                      Supporting Score Functions
' *********************************************************************

' Add points to the score AND update the score board
'
Sub AddScore(points)
  dim multiplierVal
  ResetBallSearch
    If(Tilted = False)Then
    multiplierVal = Multiplier3x * MultiplierShot * PlayMultiplier
debug.print "Add Score: " & points & " x" & multiplierVal
    ModePoints = ModePoints + points * multiplierVal
    if bWizardMode then WizardModePoints = WizardModePoints + points * multiplierVal

        ' add the points to the current players score variable
        Score(CurrentPlayer) = Score(CurrentPlayer) + points * multiplierVal  'only for this table
    if (multiplierVal > 1) then   ' Popup the bonus
      puPlayer.LabelSet pBackglass,"MPx","x" & multiplierVal  ,1,""
      vpmtimer.AddTimer 1500, "puPlayer.LabelSet pBackglass,""MPx"", """" ,1,"""" '"
    End If
    if Multiplier3x <> 1 then
      Multiplier3x = 1  ' 3x only last for next score
      SetLightColor lDrax_m, "green", lDrax_m.UserValue
      SetLightColor lGamora_m, "green", lGamora_m.UserValue
      SetLightColor lYando_m, "green", lYando_m.UserValue
      SetLightColor lRocket_m, "green", lRocket_m.UserValue
      SetLightColor lgr_m, "green", lgr_m.UserValue
      SetLightColor lNebula_m, "green", lNebula_m.UserValue
      SetLightColor lBroker_m, "green", lBroker_m.UserValue
      SetLightColor lStarLord_m, "green", lStarLord_m.UserValue
      SetLightColor lRonan_m, "green", lRonan_m.UserValue
    End If

        ' update the score displays
        DMDScore
    End if

' you may wish to check to see if the player has gotten a replay
End Sub

' Add bonus to the bonuspoints AND update the score board

Sub AddBonus(points)
    If(Tilted = False)Then
        ' add the bonus to the current players bonus variable
        BonusPoints(CurrentPlayer) = BonusPoints(CurrentPlayer) + points
    if BonusPoints(CurrentPlayer) <= 0 then BonusPoints(CurrentPlayer) = 1
        ' update the score displays
        DMDScore
    End if

' you may wish to check to see if the player has gotten a replay
End Sub

' Add some points to the current Jackpot.
'
Sub AddJackpot(points) 'not used in this table
' Jackpots only generally increment in multiball mode AND not tilted
' but this doesn't have to be the case
'If(Tilted = False)Then

' If(bMultiBallMode = True) Then
' Jackpot = Jackpot + points
' you may wish to limit the jackpot to a upper limit, ie..
' If (Jackpot >= 6000) Then
'   Jackpot = 6000
'   End if
'End if
'End if
End Sub

Sub AddSuperJackpot(points)
    If(Tilted = False)Then

        ' If(bMultiBallMode = True) Then
        SuperJackpot = SuperJackpot + points
    ' you may wish to limit the jackpot to a upper limit, ie..
    ' If (Jackpot >= 6000) Then
    '   Jackpot = 6000
    '   End if
    'End if
    End if
End Sub

Sub AddPlayMultiplier(n)
  PlayMultiplier = PlayMultiplier * n
  if PlayMultiplier < 1 then PlayMultiplier = 1 ' Dont go less than 0
End Sub

Sub AddBonusMultiplier(n)
    ' if not at the maximum bonus level
    if(BonusMultiplier + n < MaxMultiplier)then
        SetBonusMultiplier(BonusMultiplier + n)
    if bUsePUPDMD then
      pupDMDDisplay "-", "BONUS|13535251^" & BonusMultiplier & "X|827358^Multiplier|13535251", "" ,1, 0, 10
    Else
      DisplayDMDText2 "BONUS MULTIPLIER",BonusMultiplier & "x", 1000, 11, 0
    End if
    End if
End Sub

' Set the Bonus Multiplier to the specified level AND set any lights accordingly
' There is no bonus multiplier lights in this table

Sub SetBonusMultiplier(Level)
    ' Set the multiplier to the specified level
    BonusMultiplier = Level
End Sub

Sub AwardExtraBall()
    If NOT bExtraBallWonThisBall Then
    QueueScene "playmedia ""Video-0x0040.mp4"", ""PupVideos"", pOverVid , """", -1, """", 1, 1 '", 5000, 1
        DMD "_", CL(1, ("EXTRA BALL WON")), "_", eNone, eBlink, eNone, 1000, True, SoundFXDOF("fx_Knocker", 122, DOFPulse, DOFKnocker)
        ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer) + 1
        bExtraBallWonThisBall = True
        GiEffect 1
        LightEffect 2
    END If
End Sub

Sub AwardSpecial()  ' TBD: Make work for GOTG Specials
    DMD "_", CL(1, ("EXTRA GAME WON")), "_", eNone, eBlink, eNone, 1000, True, SoundFXDOF("fx_Knocker", 122, DOFPulse, DOFKnocker)
    Credits = Credits + 1
    DOF 140, DOFOn
    GiEffect 1
    LightEffect 1
End Sub


'Sub Congratulation()
'    Dim tmp
'    tmp = "vo_congrat" & INT(RND * 21 + 1)
'    PlaySoundVol tmp, VolDef
'End Sub
'*****************************
'    Load / Save / Highscore
'*****************************

Sub Loadhs
  ' Load Orbital scores
  GetScores

    Dim x
    x = LoadValue(TableName, "HighScore1")
    If(x <> "")Then HighScore(0) = CDbl(x)Else HighScore(0) = 100000 End If
    x = LoadValue(TableName, "HighScore1Name")
    If(x <> "")Then HighScoreName(0) = x Else HighScoreName(0) = "AAA" End If
    x = LoadValue(TableName, "HighScore2")
    If(x <> "")then HighScore(1) = CDbl(x)Else HighScore(1) = 100000 End If
    x = LoadValue(TableName, "HighScore2Name")
    If(x <> "")then HighScoreName(1) = x Else HighScoreName(1) = "BBB" End If
    x = LoadValue(TableName, "HighScore3")
    If(x <> "")then HighScore(2) = CDbl(x)Else HighScore(2) = 100000 End If
    x = LoadValue(TableName, "HighScore3Name")
    If(x <> "")then HighScoreName(2) = x Else HighScoreName(2) = "CCC" End If
    x = LoadValue(TableName, "HighScore4")
    If(x <> "")then HighScore(3) = CDbl(x)Else HighScore(3) = 100000 End If
    x = LoadValue(TableName, "HighScore4Name")
    If(x <> "")then HighScoreName(3) = x Else HighScoreName(3) = "DDD" End If
    x = LoadValue(TableName, "Credits")
    If(x <> "")then Credits = CInt(x)Else Credits = 0 End If

    'x = LoadValue(TableName, "Jackpot")
    'If(x <> "") then Jackpot = CDbl(x) Else Jackpot = 200000 End If
    x = LoadValue(TableName, "TotalGamesPlayed")
    If(x <> "")then TotalGamesPlayed = CInt(x)Else TotalGamesPlayed = 0 End If
End Sub

Sub Savehs
    SaveValue TableName, "HighScore1", HighScore(0)
    SaveValue TableName, "HighScore1Name", HighScoreName(0)
    SaveValue TableName, "HighScore2", HighScore(1)
    SaveValue TableName, "HighScore2Name", HighScoreName(1)
    SaveValue TableName, "HighScore3", HighScore(2)
    SaveValue TableName, "HighScore3Name", HighScoreName(2)
    SaveValue TableName, "HighScore4", HighScore(3)
    SaveValue TableName, "HighScore4Name", HighScoreName(3)
    SaveValue TableName, "Credits", Credits
    'SaveValue TableName, "Jackpot", Jackpot
    SaveValue TableName, "TotalGamesPlayed", TotalGamesPlayed
End Sub

Sub Clearhs
HighScore(0) = 100000
HighScoreName(0) = "AAA"
HighScore(1) = 100000
HighScoreName(1) = "BBB"
HighScore(2) = 100000
HighScoreName(2) = "CCC"
HighScore(3) = 100000
HighScoreName(3) = "DDD"
    SaveValue TableName, "HighScore1", HighScore(0)
    SaveValue TableName, "HighScore1Name", HighScoreName(0)
    SaveValue TableName, "HighScore2", HighScore(1)
    SaveValue TableName, "HighScore2Name", HighScoreName(1)
    SaveValue TableName, "HighScore3", HighScore(2)
    SaveValue TableName, "HighScore3Name", HighScoreName(2)
    SaveValue TableName, "HighScore4", HighScore(3)
    SaveValue TableName, "HighScore4Name", HighScoreName(3)
End Sub

' ***********************************************************
'  High Score Initals Entry Functions - based on Black's code
' ***********************************************************

Dim hsbModeActive
Dim hsEnteredName
Dim hsEnteredDigits(3)
Dim hsCurrentDigit
Dim hsValidLetters
Dim hsCurrentLetter
Dim hsLetterFlash

Sub CheckHighscore()
  osbtempscore = Score(CurrentPlayer)

    If Score(CurrentPlayer) > HighScore(0) Then 'add 1 credit for beating the highscore
        AwardSpecial
    End If

  ' Bail out on high score when auto testing
    If AutoQa=False and Score(CurrentPlayer) >= HighScore(3) Then ' Overwrite the lowest
        vpmtimer.addtimer 2000, "PlaySoundVol ""say-greatScore"", VolDef '"
        HighScore(3) = Score(CurrentPlayer)
        'enter player's name
        HighScoreEntryInit()
    Else
    if osbactive <> 0 then
      ' Submit to Orbital
      osbtemp = osbdefinit
      SubmitOSBScore
    End if
        EndOfBallComplete()
    End If
End Sub

Sub HighScoreEntryInit()

  ' Show Yellow Page
  if bUsePUPDMD then
    PuPlayer.LabelShowPage pBackglass, 3,0,""
    pDMDEvent(kDMD_Attract)
    puPlayer.LabelSet pBackglass,"EnterHS1", "Player " & CurrentPlayer+1  ,1,""
    puPlayer.LabelSet pBackglass,"EnterHS2", "Enter Initials" ,1,""
  End If
    hsbModeActive = True
    PlaySoundVol "say-EnterYourInitials2", VolDef
    hsLetterFlash = 0

    hsEnteredDigits(0) = " "
    hsEnteredDigits(1) = " "
    hsEnteredDigits(2) = " "
    hsCurrentDigit = 0

    hsValidLetters = " ABCDEFGHIJKLMNOPQRSTUVWXYZ<+-0123456789"    ' < is used to delete the last letter
    hsCurrentLetter = 1
    DMD_Clearforhighscore()
  DMDId "hsc", "Enter", "Your Name", 999999
    HighScoreDisplayName()

'    HighScoreFlashTimer.Interval = 250
'    HighScoreFlashTimer.Enabled = True
End Sub

Sub EnterHighScoreKey(keycode)
    If keycode = LeftFlipperKey Then
        PlaySoundVol "fx_Previous", VolDef
        hsCurrentLetter = hsCurrentLetter - 1
        if(hsCurrentLetter = 0)then
            hsCurrentLetter = len(hsValidLetters)
        end if
        HighScoreDisplayName()
    End If

    If keycode = RightFlipperKey Then
        PlaySoundVol "fx_Next", VolDef
        hsCurrentLetter = hsCurrentLetter + 1
        if(hsCurrentLetter > len(hsValidLetters))then
            hsCurrentLetter = 1
        end if
        HighScoreDisplayName()
    End If

    If keycode = StartGameKey Then
        if(mid(hsValidLetters, hsCurrentLetter, 1) <> "<")then
            PlaySoundVol "fx_Enter", VolDef

            hsEnteredDigits(hsCurrentDigit) = mid(hsValidLetters, hsCurrentLetter, 1)
            hsCurrentDigit = hsCurrentDigit + 1
            if(hsCurrentDigit = 3)then
                HighScoreCommitName()
            else
                HighScoreDisplayName()
            end if
        else
      PlaySoundVol "fx_Esc", VolDef

            hsEnteredDigits(hsCurrentDigit) = " "
            if(hsCurrentDigit > 0)then
                hsCurrentDigit = hsCurrentDigit - 1
            end if
            HighScoreDisplayName()
        end if
    end if
End Sub

Sub HighScoreDisplayName()
Dim i, TempStr
Dim bugFIX

    TempStr = " >"
    if(hsCurrentDigit> 0) then TempStr = TempStr & hsEnteredDigits(0)
    if(hsCurrentDigit> 1) then TempStr = TempStr & hsEnteredDigits(1)
    if(hsCurrentDigit> 2) then TempStr = TempStr & hsEnteredDigits(2)

    if(hsCurrentDigit <> 3) then
        if(hsLetterFlash <> 0) then
            TempStr = TempStr & "_"
        else
            TempStr = TempStr & mid(hsValidLetters, hsCurrentLetter, 1)
        end if
    end if

    if(hsCurrentDigit <1) then TempStr = TempStr & hsEnteredDigits(1)
    if(hsCurrentDigit <2) then TempStr = TempStr & hsEnteredDigits(2)

    TempStr = TempStr & "< "
  bugFIX=""
  if bUseUltraDMD then    ' Not sure why but ULTRA doesnt update unless both lines change
    if (hsCurrentLetter mod 2) = 0 then
      bugFIX="-"
    else
      bugFIX=" -"
    End If
  End If
  DMDMod "hsc", "YOUR NAME" & bugFIX, Mid(TempStr, 2, 5), 999999
  if bUsePUPDMD then puPlayer.LabelSet pBackglass,"EnterHS3", TempStr,1,""
End Sub

Sub HighScoreCommitName()
    HighScoreFlashTimer.Enabled = False
    hsbModeActive = False

    hsEnteredName = hsEnteredDigits(0) & hsEnteredDigits(1) & hsEnteredDigits(2)
    if(hsEnteredName = "   ")then
        hsEnteredName = "YOU"
    end if

    HighScoreName(3) = hsEnteredName
    SortHighscore
  DMD_Clearforhighscore

  ' Submit to Orbital
  osbtemp = hsEnteredName
  SubmitOSBScore

  if bUsePUPDMD then
    puPlayer.LabelSet pBackglass,"EnterHS1", "",1,""
    puPlayer.LabelSet pBackglass,"EnterHS2", "",1,""
    puPlayer.LabelSet pBackglass,"EnterHS3", "",1,""
  End If
  pBGGamePlay
    EndOfBallComplete()
End Sub

Sub SortHighscore
    Dim tmp, tmp2, i, j
    For i = 0 to 3
        For j = 0 to 2
            If HighScore(j) < HighScore(j + 1)Then
                tmp = HighScore(j + 1)
                tmp2 = HighScoreName(j + 1)
                HighScore(j + 1) = HighScore(j)
                HighScoreName(j + 1) = HighScoreName(j)
                HighScore(j) = tmp
                HighScoreName(j) = tmp2
            End If
        Next
    Next
End Sub

Sub DMD_Clearforhighscore()
  if (bUseUltraDMD) then
    UltraDMD.CancelRendering
    UltraDMD.Clear
  End If
End Sub


' *************************************************************************
' ULTRA DMD Instead of the local DMD display
' *************************************************************************

Sub LoadUltraDMD
  Dim WshShell
  Set WshShell = CreateObject("WScript.Shell")
  WshShell.RegWrite "HKCU\Software\UltraDMD\fullcolor",UseFullColor,"REG_SZ"

  On Error Resume Next
    Set UltraDMD = CreateObject("UltraDMD.DMDObject")
    If UltraDMD is Nothing Then
        MsgBox "No UltraDMD found.  This table MAY run without it."
    bUseUltraDMD=False
        Exit Sub
    End If
  On Error Goto 0

    UltraDMD.Init
  UltraDMD.SetVideoStretchMode 2
    If Not UltraDMD.GetMajorVersion = 1 Then
        MsgBox "Incompatible Version of UltraDMD found."
        Exit Sub
    End If

    If UltraDMD.GetMinorVersion < 1 Then
        MsgBox "Incompatible Version of UltraDMD found. Please update to version 1.1 or newer."
        Exit Sub
    End If

    Dim fso
    Set fso = CreateObject("Scripting.FileSystemObject")
    Dim curDir
    curDir = fso.GetAbsolutePathName(".")
    UltraDMD.SetProjectFolder curDir & "\GOTG.UltraDMD"
  dim vid0

End Sub

Sub DMDClearQueue       ' It looks like if we call this too fast it will cancel the ULTRA DMD logo scene
  if bUseUltraDMD and UltraDMDVideos Then
    If UltraDMD.IsRendering Then
      UltraDMD.CancelRendering
      'UltraDMD.CancelRenderingWithId video
      'UltraDMD.Clear
    End If
  End If
End Sub

Sub PlayDMDScene(video, timeMs)
  if bUseUltraDMD and UltraDMDVideos Then
    ' Note Video needs to not have sounds and must be more then 3 seconds (Export from iMovie, I chose 540p, high quality, Faster compression.
    UltraDMD.DisplayScene00 video, "", 15, "", 15, UltraDMD_Animation_None, timeMs, UltraDMD_Animation_None
    'UltraDMD.DisplayScene00ExWithId video, False, video, "", 15, 15, "", 15, 15, 14, 4000, 14
  End If
End Sub

Sub DisplayDMDText(Line1, Line2, duration)
  'debug.print "DMDText " & Line1 & " " & Line2
  if bUseUltraDMD Then
    UltraDMD.DisplayScene00 "", Line1, 15, Line2, 15, 14, duration, 14
  Elseif bUsePUPDMD Then
    If bPupStarted then
      if Line1 = "" or Line1 = "_" then
        pupDMDDisplay "-", Line2, "" ,Duration/1000, 0, 10
      else
        pupDMDDisplay "-", Line1 & "^" & Line2, "" ,Duration/1000, 0, 10
      End If
    End If
  End If
End Sub

Sub DisplayDMDText2(Line1, Line2, duration, pri, blink)
  if bUseUltraDMD Then
    UltraDMD.DisplayScene00 "", Line1, 15, Line2, 15, 14, duration, 14
  Elseif bUsePUPDMD Then
    If bPupStarted then
      if Line1 = "" or Line1 = "_" then
        pupDMDDisplay "-", Line2, "" ,Duration/1000, blink, pri
      else
        pupDMDDisplay "-", Line1 & "^" & Line2, "" ,Duration/1000, blink, pri
      End If
    End If
  End If
End Sub



Sub DMDId(id, toptext, bottomtext, duration) 'used in the highscore entry routine
  if bUseUltraDMD then
    UltraDMD.DisplayScene00ExwithID id, false, "", toptext, 15, 0, bottomtext, 15, 0, 14, duration, 14
  Elseif bUsePUPDMD Then
    If bPupStarted then pupDMDDisplay "default", toptext & "^" & bottomtext, "" ,Duration/1000, 0, 10
  End If
End Sub

Sub DMDMod(id, toptext, bottomtext, duration) 'used in the highscore entry routine
  if bUseUltraDMD then
    UltraDMD.ModifyScene00Ex id, toptext, bottomtext, duration
  Elseif bUsePUPDMD Then
    If bPupStarted then pupDMDDisplay "default", toptext & "^" & bottomtext, "" ,Duration/1000, 0, 10
  End If
End Sub


' *************************************************************************
'   JP's Reduced Display Driver Functions (based on script by Black)
' only 5 effects: none, scroll left, scroll right, blink and blinkfast
' 3 Lines, treats all 3 lines as text. 3rd line is just 1 character
' Example format:
' DMD "text1","text2","backpicture", eNone, eNone, eNone, 250, True, "sound"
' Short names:
' dq = display queue
' de = display effect
' *************************************************************************

Const eNone = 0        ' Instantly displayed
Const eScrollLeft = 1  ' scroll on from the right
Const eScrollRight = 2 ' scroll on from the left
Const eBlink = 3       ' Blink (blinks for 'TimeOn')
Const eBlinkFast = 4   ' Blink (blinks for 'TimeOn') at user specified intervals (fast speed)

Const dqSize = 64

Dim dqHead
Dim dqTail
Dim deSpeed
Dim deBlinkSlowRate
Dim deBlinkFastRate

Dim dCharsPerLine(2)
Dim dLine(2)
Dim deCount(2)
Dim deCountEnd(2)
Dim deBlinkCycle(2)

Dim dqText(2, 64)
Dim dqEffect(2, 64)
Dim dqTimeOn(64)
Dim dqbFlush(64)
Dim dqSound(64)

Sub DMD_Init() 'default/startup values
    Dim i, j

  if bUseUltraDMD then LoadUltraDMD()

    DMDFlush()
    deSpeed = 20
    deBlinkSlowRate = 5
    deBlinkFastRate = 2
    dCharsPerLine(0) = 20
    dCharsPerLine(1) = 20
    dCharsPerLine(2) = 3
    For i = 0 to 2
        dLine(i) = Space(dCharsPerLine(i))
        deCount(i) = 0
        deCountEnd(i) = 0
        deBlinkCycle(i) = 0
        dqTimeOn(i) = 0
        dqbFlush(i) = True
        dqSound(i) = ""
    Next
    For i = 0 to 2
        For j = 0 to 64
            dqText(i, j) = ""
            dqEffect(i, j) = eNone
        Next
    Next
    DMD dLine(0), dLine(1), dLine(2), eNone, eNone, eNone, 25, True, ""
End Sub

Sub DMDFlush()
  DMDClearQueue
End Sub

Sub DMDScore()
    Dim tmp, tmp1, tmp2
  Dim TimeStr
'    if(dqHead = dqTail)Then
'        tmp = FL(0, "PL " & CurrentPlayer, FormatScore(Score(Currentplayer)))
'        tmp1 = FL(1, "o " & Ghosts(CurrentPlayer) + GhostsHundreds(CurrentPlayer) * 100, " BALL " & Balls)
'        tmp2 = ""
'    End If

    'DMD tmp, tmp1, tmp2, eNone, eNone, eNone, 25, True, ""

  if bUseUltraDMD Then
    If Not UltraDMD.IsRendering Then
      if tmrCherryBomb.Enabled then
        TimeStr = "Time:" & ModeCountdownTimer.UserValue & "(" & CherryBombCount & ")"
      elseif tmrImmolation.Enabled  then
        TimeStr = "Hits:" & ImmolationCount & " Sw:" & SwitchHitCount
      elseif tmrXandar.Enabled  then
        TimeStr = "Hits:" & XandarCount
      elseif PlayerMode = -1 Then
        If bSecondMode then
          if PlayerMode2 = -1 then
            TimeStr = "Select Mode/2nd"
          Else
            if PlayerMode2 = 7 or PlayerMode2 = 2 Then  ' SwitchHits
              TimeStr = Mode2Percent(PlayerMode2) & "%  HITS:" & SwitchHitCount & " 2nd"
            else
              TimeStr = Mode2Percent(PlayerMode2) & "% 2nd"
            end If
          End if
        else
          TimeStr = "Select Mode"
        End If
      elseif PlayerMode = 7 Then  ' SwitchHits
        TimeStr = "Time:" & ModeCountdownTimer.UserValue & "(" & ModePercent(PlayerMode) & ") Sw:" & SwitchHitCount
      else
        TimeStr = "Time:" & ModeCountdownTimer.UserValue & "(" & ModePercent(PlayerMode) & ")"
      end If
      if Score(1) < 2300000000 then     ' UltraDMD cant handle alything greater than 2.4 billion ???? sux
        UltraDMD.DisplayScoreboard PlayersPlayingGame, CurrentPlayer, Score(0), Score(1), Score(2), Score(3), TimeStr, "Ball " & CStr(Balls)
      End if
    End If
  End If
End Sub

Sub DMDScoreNow
    DMDFlush
    DMDScore
End Sub

Sub DMD(Text0, Text1, Text2, Effect0, Effect1, Effect2, TimeOn, bFlush, Sound)
  DisplayDMDText Text0, Text1, TimeOn
  'if bUsePUPDMD and bPupStarted Then pupDMDDisplay "default", Text0 & "^" & Text1, "" ,2, 0, 10
  'if (bUsePUPDMD) Then pupDMDDisplay "attract", Text1 & "^" Text2, "@vidIntro.mp4" ,9, 1,    10
  PlaySoundVol Sound, VolDef
End Sub

Function ExpandLine(TempStr, id) 'id is the number of the dmd line
    If TempStr = "" Then
        TempStr = Space(dCharsPerLine(id))
    Else
        if(Len(TempStr) > Space(dCharsPerLine(id)))Then
            TempStr = Left(TempStr, Space(dCharsPerLine(id)))
        Else
            if(Len(TempStr) < dCharsPerLine(id))Then
                TempStr = TempStr & Space(dCharsPerLine(id)- Len(TempStr))
            End If
        End If
    End If
    ExpandLine = TempStr
End Function

Function FormatScore(ByVal Num) 'it returns a string with commas (as in Black's original font)
    dim i
    dim NumString

    NumString = CStr(abs(Num))

    For i = Len(NumString)-3 to 1 step -3
        if IsNumeric(mid(NumString, i, 1))then
            NumString = left(NumString, i) & "," & right(NumString, Len(NumString)-i)
        end if
    Next
    FormatScore = NumString
End function

Function CL(id, NumString) 'center line
    Dim Temp, TempStr
  NumString = LEFT(NumString, dCharsPerLine(id))
    Temp = (dCharsPerLine(id)- Len(NumString)) \ 2
    TempStr = Space(Temp) & NumString & Space(Temp)
    CL = TempStr
End Function

Function RL(id, NumString) 'right line
    Dim Temp, TempStr
  NumString = LEFT(NumString, dCharsPerLine(id))
    Temp = dCharsPerLine(id)- Len(NumString)
    TempStr = Space(Temp) & NumString
    RL = TempStr
End Function

Function FL(id, aString, bString) 'fill line
    Dim tmp, tmpStr
  aString = LEFT(aString, dCharsPerLine(id))
  bString = LEFT(bString, dCharsPerLine(id))
    tmp = dCharsPerLine(id)- Len(aString)- Len(bString)
  If tmp <0 Then tmp = 0
    tmpStr = aString & Space(tmp) & bString
    FL = tmpStr
End Function

'**************
' Update DMD
'**************

'Sub DMDUpdate(id)
'    Dim digit, value
'
'    Select Case id
'        Case 0 'top text line
'            For digit = 0 to 19
'                DMDDisplayChar mid(dLine(0), digit + 1, 1), digit
'            Next
'        Case 1 'bottom text line
'            For digit = 20 to 39
'                DMDDisplayChar mid(dLine(1), digit -19, 1), digit
'            Next
'        Case 2 ' back image - back animations
'            If dLine(2) = "" Then dLine(2) = "@@@"
'            For digit = 40 to 42
'                DMDDisplayChar mid(dLine(2), digit -39, 1), digit
'            Next
'    End Select
'End Sub
'
'Sub DMDDisplayChar(achar, adigit)
'    If achar = "" Then achar = " "
'    achar = ASC(achar)
'    Digits(adigit).ImageA = Chars(achar)
'End Sub

'****************************
' JP's new DMD using flashers
'****************************

'Dim Digits, Chars(255)
'DMDInit
'
'Sub DMDInit
'    Dim i
'
'        Digits = Array(digit001, digit002, digit003, digit004, digit005, digit006, digit007, digit008, digit009, digit010, _
'            digit011, digit012, digit013, digit014, digit015, digit016, digit017, digit018, digit019, digit020, _
'            digit021, digit022, digit023, digit024, digit025, digit026, digit027, digit028, digit029, digit030, _
'            digit031, digit032, digit033, digit034, digit035, digit036, digit037, digit038, digit039, digit040, _
'            digit041, digit042, digit043)
'
'    For i = 0 to 255:Chars(i) = "dempty":Next
'
'    Chars(32) = "dempty"
'    Chars(35) = "jp1"
'    Chars(36) = "jp2"
'    Chars(37) = "jp3"
'    Chars(38) = "title1"
'    Chars(39) = "title2"
'    Chars(40) = "title3"
'    Chars(46) = "dot"      '.
'    Chars(48) = "d0"       '0
'    Chars(49) = "d1"       '1
'    Chars(50) = "d2"       '2
'    Chars(51) = "d3"       '3
'    Chars(52) = "d4"       '4
'    Chars(53) = "d5"       '5
'    Chars(54) = "d6"       '6
'    Chars(55) = "d7"       '7
'    Chars(56) = "d8"       '8
'    Chars(57) = "d9"       '9
'    Chars(60) = "dless"    '<
'    Chars(61) = "dequal"   '=
'    Chars(62) = "dgreater" '>
'    Chars(64) = "bkempty"  '@
'    Chars(65) = "da"       'A
'    Chars(66) = "db"       'B
'    Chars(67) = "dc"       'C
'    Chars(68) = "dd"       'D
'    Chars(69) = "de"       'E
'    Chars(70) = "df"       'F
'    Chars(71) = "dg"       'G
'    Chars(72) = "dh"       'H
'    Chars(73) = "di"       'I
'    Chars(74) = "dj"       'J
'    Chars(75) = "dk"       'K
'    Chars(76) = "dl"       'L
'    Chars(77) = "dm"       'M
'    Chars(78) = "dn"       'N
'    Chars(79) = "do"       'O
'    Chars(80) = "dp"       'P
'    Chars(81) = "dq"       'Q
'    Chars(82) = "dr"       'R
'    Chars(83) = "ds"       'S
'    Chars(84) = "dt"       'T
'    Chars(85) = "du"       'U
'    Chars(86) = "dv"       'V
'    Chars(87) = "dw"       'W
'    Chars(88) = "dx"       'X
'    Chars(89) = "dy"       'Y
'    Chars(90) = "dz"       'Z
'    Chars(94) = "dup"      '^
'    '    Chars(95) = '_
'    Chars(96) = "d0a"  '0.
'    Chars(97) = "d1a"  '1. 'a
'    Chars(98) = "d2a"  '2. 'b
'    Chars(99) = "d3a"  '3. 'c
'    Chars(100) = "d4a" '4. 'd
'    Chars(101) = "d5a" '5. 'e
'    Chars(102) = "d6a" '6. 'f
'    Chars(103) = "d7a" '7. 'g
'    Chars(104) = "d8a" '8. 'h
'    Chars(105) = "d9a" '9  'i
'    Chars(111) = "do2" 'o
'    Chars(112) = "dp2" 'p 'p dark
'    Chars(113) = "dk2" 'q 'k dark
'    Chars(114) = "de2" 'r 'e dark
'    ' bumper images
'    Chars(131) = "b1"
'    Chars(132) = "b2"
'    Chars(133) = "b3"
'    Chars(134) = "b4"
'    Chars(135) = "b5"
'    Chars(136) = "b6"
'    Chars(137) = "b7"
'    Chars(138) = "b8"
'    Chars(139) = "b9"
'    Chars(140) = "b10"
'    Chars(141) = "b11"
'    Chars(142) = "b12"
'    Chars(143) = "b13"
'    Chars(144) = "b14"
'    Chars(145) = "b15"
'    Chars(146) = "b16"
'    Chars(147) = "b17"
'    Chars(148) = "b18"
'    Chars(149) = "b19"
'    Chars(150) = "b20"
'    Chars(151) = "b21"
'    Chars(152) = "b22"
'    Chars(153) = "b23"
'    Chars(154) = "b24"
'    Chars(155) = "b25"
'    Chars(156) = "b26"
'    Chars(157) = "b27"
'    Chars(158) = "b28"
'    Chars(159) = "b29"
'    Chars(160) = "b30"
'End Sub

'****************************************
' Real Time updatess using the GameTimer
'****************************************
'used for all the real time updates

Sub GameTimer_Timer
    RollingUpdate
' add any other real time update subs, like gates or diverters
End Sub

'********************************************************************************************
' Only for VPX 10.2 and higher.
' FlashForMs will blink light or a flasher for TotalPeriod(ms) at rate of BlinkPeriod(ms)
' When TotalPeriod done, light or flasher will be set to FinalState value where
' Final State values are:   0=Off, 1=On, 2=Return to previous State
'********************************************************************************************

Sub FlashForMs(MyLight, TotalPeriod, BlinkPeriod, FinalState) 'thanks gtxjoe for the first myVersion

    If TypeName(MyLight) = "Light" Then

        If FinalState = 2 Then
            FinalState = MyLight.State 'Keep the current light state
        End If
        MyLight.BlinkInterval = BlinkPeriod
        MyLight.Duration 2, TotalPeriod, FinalState
    ElseIf TypeName(MyLight) = "Flasher" Then

        Dim steps

        ' Store all blink information
        steps = Int(TotalPeriod / BlinkPeriod + .5) 'Number of ON/OFF steps to perform
        If FinalState = 2 Then                      'Keep the current flasher state
            FinalState = ABS(MyLight.Visible)
        End If
        MyLight.UserValue = steps * 10 + FinalState 'Store # of blinks, and final state

        ' Start blink timer and create timer subroutine
        MyLight.TimerInterval = BlinkPeriod
        MyLight.TimerEnabled = 0
        MyLight.TimerEnabled = 1
        ExecuteGlobal "Sub " & MyLight.Name & "_Timer:" & "Dim tmp, steps, fstate:tmp=me.UserValue:fstate = tmp MOD 10:steps= tmp\10 -1:Me.Visible = steps MOD 2:me.UserValue = steps *10 + fstate:If Steps = 0 then Me.Visible = fstate:Me.TimerEnabled=0:End if:End Sub"
    End If
End Sub

'******************************************
' Change light color - simulate color leds
' changes the light color and state
' colors: red, orange, yellow, green, blue, white
'******************************************

Sub SetLightColor(n, col, stat)
    Select Case col
    Case "cyan"
      n.color = RGB(0, 128, 128)
      n.colorfull = RGB(0, 231, 231)
        Case "red"
            n.color = RGB(18, 0, 0)
            n.colorfull = RGB(255, 0, 0)
        Case "orange"
            n.color = RGB(18, 3, 0)
            n.colorfull = RGB(255, 64, 0)
        Case "yellow"
            n.color = RGB(18, 18, 0)
            n.colorfull = RGB(255, 255, 0)
        Case "green"
            n.color = RGB(0, 18, 0)
            n.colorfull = RGB(0, 255, 0)
    Case "green-intense"
            n.color = RGB(0, 255, 0)
            n.colorfull = RGB(0, 255, 0)
        Case "blue"
            n.color = RGB(0, 0, 128)
            n.colorfull = RGB(0, 0, 255)
        Case "blue-light"
            n.color = RGB(18, 18, 18)
            n.colorfull = RGB(18, 18, 255)
        Case "white"
            n.color = RGB(255, 252, 224)
            n.colorfull = RGB(193, 91, 0)
        Case "purple"
            n.color = RGB(128, 0, 128)
            n.colorfull = RGB(255, 0, 255)
        Case "amber"
            n.color = RGB(193, 49, 0)
            n.colorfull = RGB(255, 153, 0)
    End Select
    If stat <> -1 Then
        n.State = 0
        n.State = stat
    End If
End Sub


' ********************************
'   Table info & Attract Mode
' ********************************

'Sub ShowTableInfo
'    Dim tmp
'    'info goes in a loop only stopped by the credits and the startkey
''    If Score(1)Then
''        DMD CL(0, "LAST SCORE"), CL(1, "PLAYER1 " &FormatScore(Score(1))), "", eNone, eNone, eNone, 3000, False, ""
''    End If
''    If Score(2)Then
''        DMD CL(0, "LAST SCORE"), CL(1, "PLAYER2 " &FormatScore(Score(2))), "", eNone, eNone, eNone, 3000, False, ""
''    End If
''    If Score(3)Then
''        DMD CL(0, "LAST SCORE"), CL(1, "PLAYER3 " &FormatScore(Score(3))), "", eNone, eNone, eNone, 3000, False, ""
''    End If
''    If Score(4)Then
''        DMD CL(0, "LAST SCORE"), CL(1, "PLAYER4 " &FormatScore(Score(4))), "", eNone, eNone, eNone, 3000, False, ""
''    End If
'    DMD "", CL(1, "GAME oVER"), "", eNone, eBlink, eNone, 2000, False, ""
'    If bFreePlay Then
'        DMD CL(0, "FREE PLAY"), CL(1, "PRESS START"), "", eNone, eBlink, eNone, 2000, False, ""
'    Else
'        If Credits > 0 Then
'            DMD CL(0, "CREDITS " & Credits), CL(1, "PRESS START"), "", eNone, eBlink, eNone, 2000, False, ""
'        Else
'            DMD CL(0, "CREDITS " & Credits), CL(1, "INSERT COIN"), "", eNone, eBlink, eNone, 2000, False, ""
'        End If
'    End If
''    tmp = chr(35)&chr(36)&chr(37)
''    DMD "", "", tmp, eNone, eNone, eNone, 3000, False, "" 'jpsalas presents
''    tmp = chr(38)&chr(39)&chr(40)
''    DMD "", "", tmp, eNone, eNone, eNone, 4000, False, "" 'title
''    DMD CL(0, "HIGHSCORES"), Space(dCharsPerLine(1)), "", eScrollLeft, eScrollLeft, eNone, 20, False, ""
''    DMD CL(0, "HIGHSCORES"), "", "", eBlinkFast, eNone, eNone, 1000, False, ""
''    DMD CL(0, "HIGHSCORES"), "1> " &HighScoreName(0) & " " &FormatScore(HighScore(0)), "", eNone, eScrollLeft, eNone, 2000, False, ""
''    DMD "_", "2> " &HighScoreName(1) & " " &FormatScore(HighScore(1)), "", eNone, eScrollLeft, eNone, 2000, False, ""
''    DMD "_", "3> " &HighScoreName(2) & " " &FormatScore(HighScore(2)), "", eNone, eScrollLeft, eNone, 2000, False, ""
''    DMD "_", "4> " &HighScoreName(3) & " " &FormatScore(HighScore(3)), "", eNone, eScrollLeft, eNone, 2000, False, ""
''    DMD Space(dCharsPerLine(0)), Space(dCharsPerLine(1)), "", eScrollLeft, eScrollLeft, eNone, 500, False, ""
'End Sub

Sub StartAttractMode(dummy)
  StartLightSeq
  DMDFlush
  'ShowTableInfo
  'StartRainbow "arrows"
End Sub

Sub StopAttractMode
    LightSeqAttract.StopPlay
    'StopRainbow
    DMDScoreNow
'StopSong
End Sub

Sub StartLightSeq()
    'lights sequences
    LightSeqAttract.UpdateInterval = 25
    LightSeqAttract.Play SeqBlinking, , 5, 150
    LightSeqAttract.Play SeqRandom, 40, , 4000
    LightSeqAttract.Play SeqAllOff
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqCircleOutOn, 15, 3
    LightSeqAttract.UpdateInterval = 5
    LightSeqAttract.Play SeqRightOn, 50, 1
    LightSeqAttract.UpdateInterval = 5
    LightSeqAttract.Play SeqLeftOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 40, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 40, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqRightOn, 30, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqLeftOn, 30, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 15, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqCircleOutOn, 15, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 5
    LightSeqAttract.Play SeqStripe1VertOn, 50, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe1VertOn, 50, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe2VertOn, 50, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe1VertOn, 25, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe2VertOn, 25, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 15, 1
End Sub

Sub LightSeqAttract_PlayDone()
    StartLightSeq()
End Sub

Sub LightSeqTilt_PlayDone()
    LightSeqTilt.Play SeqAllOff
End Sub

Sub LightSeqSkillshot_PlayDone()
    LightSeqSkillshot.Play SeqAllOff
End Sub

'*************************
' Rainbow Changing Lights
'*************************

Dim RGBStep, RGBFactor, Red, Green, Blue, RainbowLights

Sub StartRainbow(n)
    RainbowLights = n
    RGBStep = 0
    RGBFactor = 1
    Red = 255
    Green = 0
    Blue = 0
    RainbowTimer.Enabled = 1
End Sub

Sub StopRainbow()
    Dim obj
    RainbowTimer.Enabled = 0
    If RainbowLights = "arrows" Then
        For each obj in aLEDLights
            SetLightColor obj, "white", 0
        Next
    ElseIf RainbowLights = "gi" Then
        For each obj in aGiLights
            SetLightColor obj, "white", 0
        Next
    End If
End Sub

Sub RainbowTimer_Timer 'rainbow led light color changing
    Dim obj
    Select Case RGBStep
        Case 0 'Green
            Green = Green + RGBFactor
            If Green > 255 then
                Green = 255
                RGBStep = 1
            End If
        Case 1 'Red
            Red = Red - RGBFactor
            If Red < 0 then
                Red = 0
                RGBStep = 2
            End If
        Case 2 'Blue
            Blue = Blue + RGBFactor
            If Blue > 255 then
                Blue = 255
                RGBStep = 3
            End If
        Case 3 'Green
            Green = Green - RGBFactor
            If Green < 0 then
                Green = 0
                RGBStep = 4
            End If
        Case 4 'Red
            Red = Red + RGBFactor
            If Red > 255 then
                Red = 255
                RGBStep = 5
            End If
        Case 5 'Blue
            Blue = Blue - RGBFactor
            If Blue < 0 then
                Blue = 0
                RGBStep = 0
            End If
    End Select
    If RainbowLights = "arrows" Then
        For each obj in aLEDLights
            obj.color = RGB(Red \ 10, Green \ 10, Blue \ 10)
            obj.colorfull = RGB(Red, Green, Blue)
        Next
    ElseIf RainbowLights = "gi" Then
        For each obj in aGiLights
            obj.color = RGB(Red \ 10, Green \ 10, Blue \ 10)
            obj.colorfull = RGB(Red, Green, Blue)
        Next
    End If
End Sub

'***********************************************************************
' *********************************************************************
'                     Table Specific Script Starts Here
' *********************************************************************
'***********************************************************************

' droptargets, animations, etc
Sub VPObjects_Init
'    LScoleriTarget.IsDropped = 1
'    RScoleriTarget.IsDropped = 1
' LeftScoopK.IsDropped = 1
' RightScoopK.IsDropped = 1
End Sub

' tables variables and modes init
dim bPlayerModeSelect
dim bWizardMode
dim PlayerMode
Dim bSecondMode
Dim PlayerMode2

Dim bSkillshotSelect 'used to select the skillshot you want
Dim UpperSkillShot
Dim LowerSkillshot
Dim PKELevel 'used in the PKE frenzy, increased by the top lanes, the proton pack targets, right ramp
Dim PKEMult
Dim Ghosts(4)
Dim GhostsHundreds(4)
Dim bSuperJackpot
Dim bDoubleSuperJackpot
Dim bTripleSuperJackpot
Dim bJackpot
Dim bLoopinSupers
Dim HiddenJackpot
Dim bMassHysteria
Dim SpinnerValue
Dim SpinnerLevel
Dim LeftScoleri
Dim RightScoleri
Dim GozerAward
Dim bTerrorDogActive
Dim TerrorDogAward
Dim SymmetricalBookStep
Dim FirestationHoleHits
Dim ModesCompleted
Dim bShotMultiplierSelect
Dim MultiplierShot
Dim Multiplier3x
Dim SpookedLibrarianHits
Dim BackOffManHits
Dim WeGotOneHits
Dim bSlimerSuperJackpot
Dim HeSlimedMeHits
Dim HeSlimedMeValue
Dim TheBallroomHits
Dim WhoBroughttheDogHits
Dim SpookCentralHits
Dim GozerianValue
Dim GozerianHits
Dim StayPuftHits
Dim StayPuftMultiballHits
Dim Gear(5)
Dim ectoHits
Dim NextGhostAward
'Dim SlimerDefeats
Dim JumpSuitHits
Dim LaneBonus
Dim bGrootMultiball
Dim GrootMBJackpotHits()
Dim GrootMBJackpotCnt
Dim GrootMBJackpot
Dim SMBHits
Dim SongNum
Dim BonusLaneSaver
Dim ModeCountdown
Dim HurryUpCounter
dim SwitchHitCount
dim bCherryBombReady
Dim CherryBombCount
dim bCherryBombDone
Dim bImmolationWait
Dim bImmolationDone
dim bImmolationReady
Dim ImmolationCount
dim LastImmolationScore
Dim bImmolationProgress(9)  ' Stores which all lights we have already hit
Dim bImmolationAllMode    ' All Light vs Single Lights

Dim bXandarDone
dim bXandarReady
Dim XandarCount

Dim HurryUpCount
Dim bQuillsQuestFirstTime
Dim bIModeComplete
Dim BallSearchCnt
Dim bGrootBonus3x
Dim bResetCurrentGame
Dim modes50
Dim modesStarted

dim bFlash1Enabled
dim bFlash2Enabled
dim bFlash3Enabled
dim bFlash4Enabled

Sub Game_Init() 'called at the start of a new game
    Dim i

  if bClelandMusic then     ' For those that dont like the Cleland update
    MusicDir="Topper"
    VolMusic=VolMusic1 * 1.3
  Else
    MusicDir="Topper.orig"
    VolMusic=VolMusic1   '*.9
  End If

  ' Disabled this (Rules mention it but actual game seems like it uses flippers to toggle)
  'tmrNovaCorps.Enabled = True

  BallSearchCnt = 0
  modesStarted = 0
  modes50 = 0
  modesCompleted = 0

  bPlayPaused = False
  bSkipWaitVideo = False
  bAutoPlunger=False
  bCreatedBall = False

  baLightsSaved=False
  baRampLightsSaved = False
  baHadronLightsSaved = False

  BallSaverTime = defBallSaverTime
  HurryUpCount=0
  bQuillsQuestFirstTime=False
  CherryBombCount=0
  bCherryBombDone = False
  bCherryBombReady = False

  bIModeComplete=False
  ImmolationCount=0
  LastImmolationScore=0
  bImmolationWait = False
  bImmolationDone = False
  bImmolationReady = False
  bImmolationAllMode = False
  For i = 0 to 8
    bImmolationProgress(i) = False
  Next

  XandarCount=0
  bXandarDone = False
  bXandarReady = False

  HurryUpCounter = 0
  SwitchHitCount = 0
  ModeCountdown = 0
  ModeCountdownTimer.UserValue = 0
  ModeCountdownTimer.Enabled = False
  BonusLaneSaver = 0
  bLaneSaverEnabled = False
  FlipperSkipCmd=""
  'HadronCount=0
  HadronEnforcerCount=0
  BumperMultiplier = 0

  GrootMultiBallCount = 0
  OrbMultiBallProgress = 0
  OrbMultiBallCount = 0
  OrbMBJackpot = 0
  OrbMBJackpotHits = 0
  bOrbMultiBall = False
  bOrbDisabled = False
  OrbTarget1Disabled.Collidable = False
  OrbTarget1Toggle=False

  bGrootBonus3x = False
  tmrGrootMBBonus.Enabled = False
  GrootMultiBallToggle = False
  GrootMultiBallCount = 0
  GrootMultiBallToggle = False
  BallsInLock = 0
  RealBallsInLock=0
  SpellGuardians = 4 ' Start with GUAR
  SpellRampage=0

    bExtraBallWonThisBall = False
    'TurnOffPlayfieldLights()
    'Play some Music
  SongNum = 1
    'PlaySong "Song-" & SongNum
    'Init Variables
  EnablePlayerSelect
  'bPlayerModeSelect = True
  PlayerMode = -1
  bSecondMode = False
  PlayerMode2 = -1
  bWizardMode = False

    bSkillshotSelect = False
    UpperSkillShot = 0
    LowerSkillshot = 0
    PKELevel = 100
    PKEMult = 8
    Jackpot = 1000000
    SuperJackpot = 1000000
    ResetBumpers
'    Ghosts(1) = 0 'captured ghosts
'    Ghosts(2) = 0
'    Ghosts(3) = 0
'    Ghosts(4) = 0
'    GhostsHundreds(1) = 0
'    GhostsHundreds(2) = 0
'    GhostsHundreds(3) = 0
'    GhostsHundreds(4) = 0
'    NextGhostAward = 0
    'InitGhostTarget
    'bSlimerUp = False
    'bPlayfieldSlimed = False
    'SlimerHits = 0
    'SlimerDefeats = 0
'    bSlimerSuperJackpot = False
'    bSuperJackpot = False
'    bDoubleSuperJackpot = False
'    bTripleSuperJackpot = False
'    bJackpot = False
    bLoopinSupers = False
    HiddenJackpot = 0
    bMassHysteria = False
    SpinnerValue = 1000
    SpinnerLevel = 1
    'StorageLights 0
    bMultiBallMode = False
    bBonusHeld = False
    LeftScoleri = 0
    RightScoleri = 0
    GozerAward = 0
    bTerrorDogActive = False
    TerrorDogAward = 4000000
    SymmetricalBookStep = 0
    FirestationHoleHits = 0
  bShotMultiplierSelect = False
    MultiplierShot = 1
    Multiplier3x = 1
'    SpookedLibrarianHits = 0
    BackOffManHits = 0
    WeGotOneHits = 0
    bSlimerSuperJackpot = False
    HeSlimedMeHits = 0
    HeSlimedMeValue = 1000000
    TheBallroomHits = 0
    WhoBroughttheDogHits = 0
    SpookCentralHits = 0
    GozerianValue = 1000000
    GozerianHits = 0
    StayPuftHits = 0
    StayPuftMultiballHits = 0
    Gear(1) = 0
    Gear(2) = 0
    Gear(3) = 0
    Gear(4) = 0
    Gear(5) = 0
    ectoHits = 0
    JumpSuitHits = 0
    LaneBonus = 0
  tmrGrootMouth.Enabled = False
  tmrGrootMouth.UserValue = False
  GrootMouth_Drop(False)
    bGrootMultiball = false
  GrootMBLocks=0
  GrootMBJackpot = 0
  GrootMBJackpotCnt = 0
  For i = 0 to aRampLights.count
    GrootMBJackpotHits(i) = 0
  Next

    SMBHits = 0
  tGrootLeft.UserValue = 0
  tGrootRight.UserValue = 0

  ' Reset game progress
  For i = 0 to 7
    ModeProgress(i) = 0
    ModePercent(i) = 0
    Mode2Progress(i) = 0
    Mode2Percent(i) = 0
  Next

  SetLightColor lHadron0, "yellow", 0
  SetLightColor lHadron1, "yellow", 0
  SetLightColor lHadron2, "yellow", 0
  SetLightColor lHadron3, "yellow", 0
  SetLightColor lHadron4, "yellow", 0

  tgHadron0.UserValue = 0
  tgHadron1.UserValue = 0
  tgHadron2.UserValue = 0
  tgHadron3.UserValue = 0
  tgHadron4.UserValue = 0

  OrbTarget1.IsDropped = False
  OrbTarget2.IsDropped = False

    'Init Delays/Timers
    PlayQuote.Enabled = doCallouts
    'Skillshot Init
    'MainModes Init()

    'Init lights
    'storage facility lights
    ContainerFlasher1. Visible = 0
    ContainerFlasher2. Visible = 0
    ContainerFlasher3. Visible = 0
    ContainerFlasher4. Visible = 0
    ContainerFlasher5. Visible = 0
    ContainerFlasher6. Visible = 0

' ' Reset Switches for shot multiplier
' sw2.UserValue=0
' sw3.UserValue=0
' sw4.UserValue=0
' sw8.UserValue=0
' sw9.UserValue=0

  tgtGuardians.UserValue = 0
  bDebounce = False
  modeRampColor = "white"

  TurnOffPlayfieldLights()
  SetLightColor lgr_a, "green", 1
  setUpgradeLight(True)
  setModeSelectLight(False)
  setExtraBallLight(False)
  setMysteryLight(False)
' flshUpgrade.TimerEnabled = True
' flshModeSelect.TimerEnabled = False
' flshExtraBall.TimerEnabled = False
' flshMystery.TimerEnabled = False

  tmrRovingHadron.Enabled = False
  tmrShotMultiplierStrobe.Enabled = False

  sndGeneralHit = ""

  DMDClearQueue   ' Cancel intro movie if it playing
  pDMDStartGame

  bFlash1Enabled = False
  bFlash2Enabled = False
  bFlash3Enabled = False
  bFlash4Enabled = False
  'tmrRedLightFlash.Enabled = False ' Stop the Big flashers
  tmrHadronLightFlash.Enabled = False

  if bCompetitionMode=False then
    PlayerMode = INT(RND * 7)   ' Start with a random mode unless they override
    UpdatePlayerMode()
  End If

  for i = 0 to 8  ' Clear Bonus counters
    BonusArrowHits(i) = 0
    BonusModeTotal(i) = 0
    BonusModeValue(i) = 0
  next


  ' Reset all the player states
  PlayerState(0).Reset    ' Unused since we are one based
  PlayerState(1).Reset
  PlayerState(2).Reset
  PlayerState(3).Reset
  PlayerState(4).Reset
  PlayerState(1).Save ' Save new state
  PlayerState(2).Save ' Save new state
  PlayerState(3).Save ' Save new state
  PlayerState(4).Save ' Save new state

' TESTING **************************************
  ' Blink the lights 100 times, off for 200 msec, 80 = blink rate (0=slow, 1= fast)
  'LightSeqMultiplier.Interval = 80
  'LightSeqMultiplier.Play SeqBlinking, 0, 100, 200

  'PlayDMDScene "vidOrbOpen.mp4"

  'OrbOpen()
  'vpmtimer.addtimer 3000, "OrbClose '"

  'mMagnaSave.MagnetOn = True
  'SetLightColor lMagnet, "white", 1

  ' Test Cherry Bomb
' ModeProgress(0) = 10
' ModePercent(0) = 100
' ModeProgress(1) = 5
' ModePercent(1) = 100
' ModeProgress(2) = 8
' ModePercent(2) = 100
' ModeProgress(4) = 7
' ModePercent(4) = 90
' HadronEnforcerCount = 100

  'Immolation flash
  'LightSeqImmolation.TimerInterval = 40
  'LightSeqImmolation.Play SeqBlinking, 0, 50, 40   ' 50 time, 40ms on/off

  'HighScoreEntryInit

  'bCherryBombReady = True
  'bImmolationReady = True
  'bXandarReady = True
  'PlayDMDScene "Video-0x0091.mp4", 5000

  ' Test Ramp bounce out
  'BallReleaseTest.CreateSizedball BallSize / 2
  'BallReleaseTest.Kick -18, 70
  'BallReleaseTest.CreateSizedball BallSize / 2
  'BallReleaseTest.Kick 20, 60

  ' Test Ramp bounce out
  'BallReleaseTest2.CreateSizedball BallSize / 2
  'BallReleaseTest2.Kick 16.5, 30

  'puPlayer.LabelSet pBackglass,"MTimer", "3X FOR 20" ,1,""

  'tmrEndOfBallBonus.UserValue = 1.2
  'debug.print ((tmrEndOfBallBonus.UserValue - 1) * 10)
  'tmrEndOfBallBonus.UserValue = 0
  'tmrEndOfBallBonus.Enabled = true


' PuPlayer.playlistplayex pPopUP2,"PuPOverlays","clear.mp4",0,1
'
' pDMDEvent(kDMD_BonusBG)
' pDMDEvent(kDMD_Bonus1)
' pDMDEvent(kDMD_Bonus3)
' pDMDEvent(kDMD_Bonus5)
' pDMDEvent(kDMD_Bonus7)
' pDMDEvent(kDMD_Bonus9)
' vpmtimer.addtimer 2500, "pDMDEvent(kDMD_BonusClear) '"
  'PuPlayer.playlistplayex pPopUP1, "PuPOverlays", "BonusScreen-1.png", 0, 1
  'vpmtimer.addtimer 3000, "PuPlayer.playlistplayex kDMD_BonusBG, ""PuPOverlays"", ""blank.png"", 0, 1' "
  'PuPlayer.playlistplayex pPopUP1, "PuPOverlays", "blank.png", 0, 1

  ' Swipe flash
' Dim interval:interval=3
' dim angle:angle=30
' dim j
' for j = 0 to 6
'   LightSeqGroot.UpdateInterval = interval
'   LightSeqGroot.Play SeqWiperLeftOn, angle,0,-1
'   LightSeqGroot.UpdateInterval = interval
'   LightSeqGroot.Play SeqWiperRightOn, angle,0,-1
' next

  'LightSeqGroot_Playdone

  'LightSeqScoopArrow.Play SeqDiagUpRightOn, 30, 1

  'vpmtimer.addtimer 4200, "pBGPlayVideo ""Video-0x0059.mp4"", 27000 '"
  'PuPEvent(455)
  'PuPEvent(kDMD_BallSave)
' PuPEvent(537)
' vpmtimer.addtimer 5000, "PuPEvent(kDMD_BallSave) '"
' vpmtimer.addtimer 8000, "stopTest '"

' Test Immolation
' ModePercent(1)=55
' ModePercent(2)=50
' ModePercent(3)=52
' ModePercent(4)=56
' ModePercent(5)=78
' Light030.state =1
' Light033.state =1
' DoImmolationI

' ' Test Queue
' QueueScene "Test1", 100, 1
' QueueScene "Test4", 200, 2
' QueueScene "Test2", 300, 1
' QueueScene "Test5", 400, 2
' QueueScene "Test6", 500, 2
' QueueScene "Test3", 600, 1
' dim xx
' Debug.print "Q0"
' for xx = 0 to PupQueueEndPos
'   debug.print xx & " " & PupQueue(xx, 0) & " " & PupQueue(xx, 1) & " " & PupQueue(xx, 2)
' Next
' QueuePop
' Debug.print "Q1"
' for xx = 0 to PupQueueEndPos
'   debug.print xx & " " & PupQueue(xx, 0) & " " & PupQueue(xx, 1) & " " & PupQueue(xx, 2)
' Next
' QueuePop
' Debug.print "Q2"
' for xx = 0 to PupQueueEndPos
'   debug.print xx & " " & PupQueue(xx, 0) & " " & PupQueue(xx, 1) & " " & PupQueue(xx, 2)
' Next
' QueuePop
' QueuePop
' QueuePop
' Debug.print "Q3"
' for xx = 0 to PupQueueEndPos
'   debug.print xx & " " & PupQueue(xx, 0) & " " & PupQueue(xx, 1) & " " & PupQueue(xx, 2)
' Next
' QueuePop

' QueueScene "ScenePlayerModeComplete """& "Video-0x004B.mp4" &""", """&"TEST MODE"&""","""&FormatScore(120000)&""",""TOTAL"" '", 3000, 1
' QueueScene "SceneClearPlayerModeComplete '", 0, 1
' QueueScene "ScenePlayerModeComplete """& "Video-0x0088.mp4" &""", """&"2nd TEST MODE"&""","""&FormatScore(200003)&""",""TOTAL"" '", 3000, 1
' QueueScene "SceneClearPlayerModeComplete '", 0, 1

'ModePercent(1)=100
'QueueScene "SceneFinishMode 4 '", 6000, 1
'QueueScene "SceneClearFinishMode '", 0, 1


  'Lampz.SetLamp 1, True

' puPlayer.LabelSet pBackglass,"Message", 75700000 / 1000000 & "M"  ,1,""
' vpmTimer.addTimer 2000, "puPlayer.LabelSet pBackglass,""Message"", """" ,1,"""" '"  ' Clear it


' puPlayer.LabelSet pBackglass,"PopImg1", "PuPOverlays\\BumperPop.gif", 1,"{'mt':2,'color':111111,'ypos':50,'xpos':5,'width':20, 'height':28, 'anigif':100,'pagenum':1}"
' puPlayer.LabelSet pBackglass, "PopScore1", "10.4K", 1,""
'
' puPlayer.LabelSet pBackglass,"PopImg2", "PuPOverlays\\BumperPop.gif", 1,"{'mt':2,'color':111111,'ypos':40,'xpos':15,'width':20, 'height':28, 'anigif':100,'pagenum':1}"
' puPlayer.LabelSet pBackglass, "PopScore2", "20.4K", 1,""

  'puPlayer.LabelSet pBackglass, "PopScore1", "12.4K", 0,"{'mt':1,'at':2,'ype':150,'len':400,'mlen':400,'tt':3}"

End Sub


'Sub LightSeqImmolation_Playdone()
' LightSeqImmolation.Play SeqMiddleOutHorizOn, 20, 0
'End Sub

Sub LightSeqXandar_PlayDone()
  if (LightSeqXandar.UserValue=0) Then
    LightSeqXandar.UserValue=1
    LightSeqXandar.TimerInterval = 40
    LightSeqXandar.Play SeqBlinking, 0, 15, 40    ' 20 time, 40ms on/off
  End If
End Sub

Sub LightSeqXandarFinale_PlayDone()
  if (LightSeqXandarFinale.UserValue=0) Then
    LightSeqXandarFinale.UserValue = 1
    LightSeqXandarFinale.Play SeqDownOn, 30, 1
  Elseif (LightSeqXandarFinale.UserValue=1) Then
    LightSeqXandarFinale.UserValue = 2
    LightSeqXandarFinale.Play SeqUpOn, 30, 1
  Elseif (LightSeqXandarFinale.UserValue=2) Then
    LightSeqXandarFinale.UserValue = 3
    LightSeqXandarFinale.Play SeqDownOn, 30, 1
  Elseif (LightSeqXandarFinale.UserValue=3) Then
    LightSeqXandarFinale.UserValue = 4
    LightSeqXandarFinale.Play SeqRandom, 30, 1, 3000
  End If
End Sub

Sub StopEndOfBallModes() 'this sub is called after the last ball is drained

End Sub

Sub ResetNewBallVariables()           'reset variables for a new ball or player
    'bPlayfieldSlimed = False
    bSlimerSuperJackpot = False
    bSuperJackpot = False
    bDoubleSuperJackpot = False
    bTripleSuperJackpot = False
    bJackpot = False
    HiddenJackpot = 0
    LaneBonus = 0
    SuperJackpot = 1000000
    PKELevel = 100
End Sub

Sub ResetNewBallLights() 'turn on or off the needed lights before a new ball is released

End Sub

Sub TurnOffPlayfieldLights()
    Dim a
    For each a in aLights
        a.State = 0
    Next
    'Bumper1Light.Visible = 0
    'Bumper2Light.Visible = 0
    'Bumper3Light.Visible = 0
End Sub


Dim FlashLevel1,FlashLevel2, FlashLevel3, FlashLevel4, FlashLevel5

tmrRedLightFlash.Interval = 200
Flasherflash1.TimerInterval = 30
Sub tmrRedLightFlash_Timer
  'tmrRedLightFlash.Enabled = False
  if bFlash1Enabled and Flasherflash1.TimerEnabled=False then FlashLevel1 = 1 : Flasherflash1_Timer : If BallsOnPlayfield > 0 Then DOF 202, DOFPulse
  if bFlash2Enabled and Flasherflash2.TimerEnabled=False then FlashLevel2 = 1 : Flasherflash2_Timer : If BallsOnPlayfield > 0 Then DOF 201, DOFPulse
  if bFlash3Enabled and Flasherflash3.TimerEnabled=False then FlashLevel3 = 1 : Flasherflash3_Timer : If BallsOnPlayfield > 0 Then DOF 200, DOFPulse
  if bFlash4Enabled and Flasherflash4.TimerEnabled=False then FlashLevel4 = 1 : Flasherflash4_Timer : If BallsOnPlayfield > 0 Then DOF 203, DOFPulse
End Sub

Sub RedLightFlashNebula ' Flashes nebula first and then others
  bFlash1Enabled = True
  vpmtimer.addtimer 200, "bFlash3Enabled = True'"
  vpmtimer.addtimer 400, "bFlash2Enabled = True'"
  vpmtimer.addtimer 600, "bFlash4Enabled = True'"
  vpmtimer.addtimer 1500, "bFlash1Enabled = False:bFlash2Enabled = False:bFlash3Enabled = False:bFlash4Enabled = False' "
End Sub

Sub RedLightFlashGamora     ' Flashes Gamora first and then others
  bFlash3Enabled = True
  vpmtimer.addtimer 200, "bFlash1Enabled = True'"
  vpmtimer.addtimer 400, "bFlash2Enabled = True'"
  vpmtimer.addtimer 600, "bFlash4Enabled = True'"
  vpmtimer.addtimer 1500, "bFlash1Enabled = False:bFlash2Enabled = False:bFlash3Enabled = False:bFlash4Enabled = False' "
End Sub

Sub PlayProgress(name)
  PlaySoundVol "gg_RampHit", VolDef

  LightSeqScore.UpdateInterval = 2
  LightSeqScore.Play SeqUpOn, 100, 0
  if name = "lGamoraArrow" or _
    name = "lBrokerArrow" or _
    name = "lDraxArrow" or _
    name = "lStarLordArrow" Then

    RedLightFlashGamora
' Elseif name = "lYonduArrow" or _
'   name = "lNebulaArrow" or _
'   name = "lRocketArrow" or _
'   name = "lRonanArrow" Then
'   RedLightFlashNebula
  Else
    RedLightFlashNebula
  End if

End Sub


Sub HadronFlash(color, enabled)
  if enabled Then
debug.print "Hadron Flash: " & color
    tmrHadronLightFlash.Enabled = False
    If color = "green" then             ' if color is blank just use what the color was before
      Flasherflash5_5.Color = RGB(0,255,0)
      Flasherflash5.ImageA = "domegreenflash"
      Flasherbase5.Image = "domegreenbase"
      Flasherlit5.Image = "domegreenlit"
    elseif color = "white" then
      Flasherflash5_5.Color = RGB(255,255,255)
      Flasherflash5.ImageA = "domewhiteflash"
      Flasherbase5.Image = "domewhitebase"
      Flasherlit5.Image = "domewhitelit"
    elseif color = "cyan" then
      Flasherflash5_5.Color = RGB(0,255,255)
      Flasherflash5.ImageA = "domecyanflash"
      Flasherbase5.Image = "domecyanbase"
      Flasherlit5.Image = "domecyanlit"
    elseif color = "orange" then
      Flasherflash5_5.Color = RGB(255,165,0)
      Flasherflash5.ImageA = "domeorangeflash"
      Flasherbase5.Image = "domeorangebase"
      Flasherlit5.Image = "domeorangelit"
    elseif color = "orangedark" then
      Flasherflash5_5.Color = RGB(204,85,0)
      Flasherflash5.ImageA = "domeorangedarkflash"
      Flasherbase5.Image = "domeorangedarkbase"
      Flasherlit5.Image = "domeorangedarklit"
    elseif color = "red" then
      Flasherflash5_5.Color = RGB(255,0,0)
      Flasherflash5.ImageA = "domeredflash2"
      Flasherbase5.Image = "domeredbase"
      Flasherlit5.Image = "domeredlit"
    elseif color = "blue" then
      Flasherflash5_5.Color = RGB(0,0,255)
      Flasherflash5.ImageA = "domeblueflash"
      Flasherbase5.Image = "domebluebase"
      Flasherlit5.Image = "domebluelit"
    elseif color = "purple" then
      Flasherflash5_5.Color = RGB(128,0,128)
      Flasherflash5.ImageA = "domepurpleflash"
      Flasherbase5.Image = "domepurplebase"
      Flasherlit5.Image = "domepurplelit"
    elseif color = "yellow" then
      Flasherflash5_5.Color = RGB(255,255,0)
      Flasherflash5.ImageA = "domeyellowflash"
      Flasherbase5.Image = "domeyellowbase"
      Flasherlit5.Image = "domeyellowlit"
    elseif color = "white" then
      Flasherflash5_5.Color = RGB(255,255,255)
      Flasherflash5.ImageA = "domewhiteflash"
      Flasherbase5.Image = "domewhitebase"
      Flasherlit5.Image = "domewhitelit"
    End If
    tmrHadronLightFlash.Enabled = True
    DOF 141, DOFOn
  elseif HadronEnforcerCount <= 0 or enabled=False then
    tmrHadronLightFlash.Enabled = False
    DOF 141, DOFOff
  End If
End Sub

Sub tmrHadronLightFlash_Timer
  FlashLevel5 = 1 : Flasherflash5_Timer
  If BallsOnPlayfield > 0 Then DOF 204, DOFPulse
End Sub

Sub Flasherflash1_Timer
  dim flashx3, matdim
  If Flasherflash1.TimerEnabled = False Then
    Flasherflash1.TimerEnabled = True
    FlasherFlash1_1.TimerEnabled = True
    Flasherflash1.visible = 1
    FlasherFlash1_1.visible = 1
    Flasherlit1.visible = 1
  End If
  flashx3 = FlashLevel1 * FlashLevel1 * FlashLevel1
  Flasherflash1.opacity = 3000 * flashx3
  Flasherlit1.BlendDisableLighting = 30 * flashx3
  Flasherbase1.BlendDisableLighting =  flashx3
  FlasherFlash1_1.opacity = 6000 * flashx3
  matdim = Round(10 * FlashLevel2)
  Flasherlit1.material = "domelit" & matdim
  FlashLevel1 = FlashLevel1 * 0.9 - 0.01
  If FlashLevel1 < 0.15 Then
    Flasherlit1.visible = 0
  Else
    Flasherlit1.visible = 1
  end If
  If FlashLevel1 < 0 Then
    Flasherflash1.TimerEnabled = False
    Flasherflash1.visible = 0
    Flasherflash1_1.TimerEnabled = False
    FlasherFlash1_1.visible = 0
  End If
End Sub

Sub Flasherflash2_Timer
  dim flashx3, matdim
  If Flasherflash2.TimerEnabled = False Then
    Flasherflash2.TimerEnabled = True
    FlasherFlash2_2.TimerEnabled = True
    Flasherflash2.visible = 1
    FlasherFlash2_2.visible = 1
    Flasherlit2.visible = 1
  End If
  flashx3 = FlashLevel2 * FlashLevel2 * FlashLevel2
  Flasherflash2.opacity = 3000 * flashx3
  Flasherlit2.BlendDisableLighting = 30 * flashx3
  Flasherbase2.BlendDisableLighting =  flashx3
  FlasherFlash2_2.opacity = 6000 * flashx3
  matdim = Round(10 * FlashLevel2)
  Flasherlit2.material = "domelit" & matdim
  FlashLevel2 = FlashLevel2 * 0.9 - 0.01
  If FlashLevel2 < 0.15 Then
    Flasherlit2.visible = 0
  Else
    Flasherlit2.visible = 1
  end If
  If FlashLevel2 < 0 Then
    Flasherflash2.TimerEnabled = False
    Flasherflash2.visible = 0
    FlasherFlash2_2.TimerEnabled = False
    FlasherFlash2_2.visible = 0
  End If
End Sub


Sub Flasherflash3_Timer
  dim flashx3, matdim
  If Flasherflash3.TimerEnabled = False Then
    Flasherflash3.TimerEnabled = True
    FlasherFlash3_3.TimerEnabled = True
    Flasherflash3.visible = 1
    FlasherFlash3_3.visible = 1
    Flasherlit3.visible = 1
  End If
  flashx3 = FlashLevel3 * FlashLevel3 * FlashLevel3
  Flasherflash3.opacity = 3000 * flashx3
  Flasherlit3.BlendDisableLighting = 30 * flashx3
  Flasherbase3.BlendDisableLighting =  flashx3
  FlasherFlash3_3.opacity = 3000 * flashx3
  matdim = Round(10 * FlashLevel3)
  Flasherlit3.material = "domelit" & matdim
  FlashLevel3 = FlashLevel3 * 0.9 - 0.01
  If FlashLevel3 < 0.15 Then
    Flasherlit3.visible = 0
  Else
    Flasherlit3.visible = 1
  end If
  If FlashLevel3 < 0 Then
    Flasherflash3.TimerEnabled = False
    Flasherflash3.visible = 0
    FlasherFlash3_3.TimerEnabled = False
    FlasherFlash3_3.visible = 0
  End If
End Sub


Sub Flasherflash4_Timer
  dim flashx3, matdim
  If Flasherflash4.TimerEnabled = False Then
    Flasherflash4.TimerEnabled = True
    FlasherFlash4_4.TimerEnabled = True
    Flasherflash4.visible = 1
    FlasherFlash4_4.visible = 1
    Flasherlit4.visible = 1
  End If
  flashx3 = FlashLevel4 * FlashLevel4 * FlashLevel4
  Flasherflash4.opacity = 3000 * flashx3
  Flasherlit4.BlendDisableLighting = 30 * flashx3
  Flasherbase4.BlendDisableLighting =  flashx3
  FlasherFlash4_4.opacity = 6000 * flashx3
  matdim = Round(10 * FlashLevel4)
  Flasherlit4.material = "domelit" & matdim
  FlashLevel4 = FlashLevel4 * 0.9 - 0.01
  If FlashLevel4 < 0.15 Then
    Flasherlit4.visible = 0
  Else
    Flasherlit4.visible = 1
  end If
  If FlashLevel4 < 0 Then
    Flasherflash4.TimerEnabled = False
    Flasherflash4.visible = 0
    FlasherFlash4_4.TimerEnabled = False
    FlasherFlash4_4.visible = 0
  End If
End Sub

Sub Flasherflash5_Timer
  dim flashx3, matdim
  If Flasherflash5.TimerEnabled = False Then
    Flasherflash5.TimerEnabled = True
    Flasherflash5_5.TimerEnabled = True
    Flasherflash5.visible = 1
    Flasherflash5_5.visible = 1
    Flasherlit5.visible = 1
  End If
  flashx3 = FlashLevel5 * FlashLevel5 * FlashLevel5
  Flasherflash5.opacity = 200 * flashx3
  Flasherflash5_5.opacity = 500 * flashx3
  Flasherlit5.BlendDisableLighting = 10 * flashx3
  Flasherbase5.BlendDisableLighting =  flashx3
  matdim = Round(10 * FlashLevel5)
  Flasherlit5.material = "domelit" & matdim
  FlashLevel5 = FlashLevel5 * 0.9 - 0.01
  If FlashLevel5 < 0.15 Then
    Flasherlit5.visible = 0
  Else
    Flasherlit5.visible = 1
  end If
  If FlashLevel5 < 0 Then
    Flasherflash5.TimerEnabled = False
    Flasherflash5_5.TimerEnabled = False
    Flasherflash5.visible = 0
    Flasherflash5_5.visible = 0
  End If
End Sub

sub ResetBallSearch()
  if BallSearchResetting then Exit Sub  ' We are resetting jsut exit for now
  'debug.print "Ball Search Reset"
  tmrBallSearch.Enabled = False ' Reset Ball Search
  BallSearchCnt=0
  tmrBallSearch.Enabled = True
End Sub

dim BallSearchResetting:BallSearchResetting=False
Sub tmrBallSearch_Timer() ' We timed out
  ' See if we are in mode select, a flipper is up that might be holding the ball or a ball is in the lane

  'debug.print "Ball Search"

  if bGameInPlay and bPlayerModeSelect = False and _
    hsbModeActive = False and _
    tmrEndOfBallBonus.Enabled = False and _
    bBallInPlungerLane = False and _
    LeftFlipper.CurrentAngle <> LeftFlipper.EndAngle and _
    RightFlipper.CurrentAngle <> RightFlipper.EndAngle Then

    debug.print "Ball Search - NO ACTIVITY " & BallSearchCnt

    if BallSearchCnt >= 3 Then
      dim Ball
      debug.print "--- listing balls ---"
      For each Ball in GetBalls
        Debug.print "Ball: (" & Ball.x & "," & Ball.y & ")"
      Next
      debug.print "--- listing balls ---"

' TBD Might want to implement this
'     BallsOnPlayfield = 0
'     for each Ball in GetBalls
'       Ball.DestroyBall
'     Next


      BallSearchCnt = 0
      if BallsOnPlayfield > 0 then  ' somehow we might have drained and didnt catch it??
        BallsOnPlayfield = BallsOnPlayfield - 1  ' We cant find the ball (remove one)
      End if
      AddMultiball(1)
      DisplayDMDText "BALL SEARCH FAIL","", 1000
      Exit sub
    End if

    BallSearchResetting=True
    BallSearchCnt = BallSearchCnt + 1
    DisplayDMDText "BALL SEARCH","", 1000
    if OrbTarget1Disabled.Collidable then  ' They didnt hit the drop target so drop it for them and let the ball go
      OrbTarget1Disabled.Collidable = False
      OrbTarget1.IsDropped = True
      vpmtimer.addtimer 1500, "OrbTargetReset:OrbTarget1Disabled.Collidable = True '"
    Else
      OrbTarget1.IsDropped = True
      vpmtimer.addtimer 1500, "OrbTargetReset '"
    End If
    leftScoop.Kick 150, 25
    DOF 123, DOFPulse
    RocketKicker.Kick 165, 90
    DOF 113, DOFPulse
    DOF 112, DOFPulse
    vpmtimer.addtimer 3000, "BallSearchResetting = False '"
  Else
    ResetBallSearch
  End if
End Sub


Sub flshExtraBall_Timer()
'    if flshExtraBall.Visible then
'   flshExtraBall.Visible = False
' Else
'   flshExtraBall.Visible = True
' End If
    if Lampz.State(4) then
    Lampz.SetLamp 4, False
  Else
    Lampz.SetLamp 4, True
  End If
End Sub

Sub setExtraBallLight(bValue)
  if bValue then
    flshExtraBall.TimerEnabled = True
  Else
    flshExtraBall.TimerEnabled = False
    Lampz.SetLamp 4, False
  End If
End Sub

Sub flshMystery_Timer()
'    if flshMystery.Visible then
'   flshMystery.Visible = False
' Else
'   flshMystery.Visible = True
' End If
    if Lampz.State(3) then
    Lampz.SetLamp 3, False
  Else
    Lampz.SetLamp 3, True
  End If
End Sub

Sub setMysteryLight(bValue)
  if bValue then
    flshMystery.TimerEnabled = True
  Else
    flshMystery.TimerEnabled = False
    Lampz.SetLamp 3, False
  End If
End Sub

Sub flshModeSelect_Timer()
'    if flshModeSelect.Visible then
'   flshModeSelect.Visible = False
' Else
'   flshModeSelect.Visible = True
' End If
    if Lampz.State(2) then
    Lampz.SetLamp 2, False
  Else
    Lampz.SetLamp 2, True
  End If
End Sub

Sub setModeSelectLight(bValue)
  if bValue then
    flshModeSelect.TimerEnabled = True
  Else
    flshModeSelect.TimerEnabled = False
    Lampz.SetLamp 2, False
    DOF 300, DOFOff     ' James DOF
    DOF 301, DOFOff
    DOF 302, DOFOff
    DOF 303, DOFOff
    DOF 304, DOFOff
    DOF 305, DOFOff
    DOF 306, DOFOff
    DOF 307, DOFOff
    DOF 308, DOFOff
  End If
End Sub


Sub flshUpgrade_Timer()
'    if flshUpgrade.Visible then
'   flshUpgrade.Visible = False
' Else
'   flshUpgrade.Visible = True
' End If
    if Lampz.State(1) then
    Lampz.SetLamp 1, False
  Else
    Lampz.SetLamp 1, True
  End If
End Sub

Sub setUpgradeLight(bValue)
  if bValue then
    flshUpgrade.TimerEnabled = True
  Else
    flshUpgrade.TimerEnabled = False
    Lampz.SetLamp 1, False
  End If
End Sub

' Add the current hurry up bonus points to our score and start it over (Quills Quest)
Sub HurryUpAddBonus(InitialBonus, AddBonus, NextDelay)
  tmrHurryUp.Enabled=False

  if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Message",  tmrHurryUp.UserValue  ,1,""
  BonusAddMode tmrHurryUp.UserValue, False
  HurryUpCount=HurryUpCount+1
  tmrHurryUp.UserValue=InitialBonus + (AddBonus * HurryUpCount)
  if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Timer",  tmrHurryUp.UserValue  ,1,""
  vpmtimer.addtimer NextDelay, "HurryUpStart2 '"
End Sub

Sub HurryUpStart2()   ' We need this since they could of added a bonus and restarted the timer after we cancelled
  if PlayerMode <> -1 then
    HurryUpStart
  End If
End Sub

Sub HurryUpStart()
  tmrHurryUp.Enabled = True
  if bUsePUPDMD then
    puPlayer.LabelSet pBackglass,"Timer", tmrHurryUp.UserValue  ,1,""
    puPlayer.LabelSet pBackglass,"Message", ""  ,1,""
  End If
End Sub

Sub HurryUpFinish()
  tmrHurryUp.Enabled = False
  if bUsePUPDMD then
    puPlayer.LabelSet pBackglass,"Timer", ""  ,1,""
    puPlayer.LabelSet pBackglass,"Message", ""  ,1,""
  End If
End Sub


Sub tmrHurryUp_Timer()
  if tmrHurryUp.UserValue > 0 then ' 500000 then
    tmrHurryUp.UserValue=tmrHurryUp.UserValue - 4210
    if tmrHurryUp.UserValue < 0 then tmrHurryUp.UserValue = 0
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Timer",  tmrHurryUp.UserValue  ,1,""
  Else
    HurryUpFinish
  End If
End Sub


Sub AwardMystery()
  dim award
  award = INT((kDMD_Myst_MAX-600+1)*Rnd+600)
  if bOrbMultiBall or bGrootMultiball Then
    award = kDMD_Myst_AddABall
  End If
  if award <> kDMD_Myst_BonusMultiplier then    ' This one is based off the current multiplier
    pDMDEvent(award)
  End If

  if (bSecondMode or PlayerMode = -1) and award=kDMD_Myst_AddABall then   ' If we are in player select and you get Add a ball it messes things up so Switch to Extra Ball
    award=kDMD_Myst_BallSaveLit
  End if

  Select Case award
    case kDMD_Myst_Rampage:
      DisplayDMDText2 "MYSTERY","RAMPAGE", 1000, 11, 0
      SpellRampage = 4
      RocketKicker_Hit
    case kDMD_Myst_RampageA:
      DisplayDMDText2 "MYSTERY","RAMPAGE A", 1000, 11, 0
      SpellRampage = 2
      RocketKicker_Hit
    case kDMD_Myst_RampageP:
      DisplayDMDText2 "MYSTERY","RAMPAGE P", 1000, 11, 0
      SpellRampage = 1
      RocketKicker_Hit
    case kDMD_Myst_AddABall:  ' Add Multiball
      DisplayDMDText2 "MYSTERY","Add A Ball", 1000, 11, 0
      AddMultiball 1
    case kDMD_Myst_10Million:
      DisplayDMDText2 "MYSTERY","10 MILLION", 1000, 11, 0
      DOF 128, DOFPulse
      AddScore 10000000
    case kDMD_Myst_SpecialLit:
      DisplayDMDText2 "MYSTERY","SPECIAL", 1000, 11, 0
    case kDMD_Myst_ShotMult:
      DisplayDMDText2 "MYSTERY","Shot Multipier", 1000, 11, 0
    case kDMD_Myst_Orb1:
      DisplayDMDText2 "MYSTERY","ORB 1", 1000, 11, 0
      OrbMultiBallCount = OrbMultiBallCount + 1
      vpmtimer.addtimer 4000, "pDMDEvent(" & kDMD_Orb1Collected + OrbMultiBallCount -1 & ") '"
    case kDMD_Myst_2Million:
      DisplayDMDText2 "MYSTERY","2 MILLION", 1000, 11, 0
      DOF 128, DOFPulse
      AddScore 2000000
    case kDMD_Myst_BonusHold:
      DisplayDMDText2 "MYSTERY","Bonus Hold", 1000, 11, 0
    case kDMD_Myst_IncreasePopB:
      DisplayDMDText2 "MYSTERY","Increase Pop Bumpers", 1000, 11, 0
    case kDMD_Myst_RampageR:
      DisplayDMDText2 "MYSTERY","RAMPAGE R", 1000, 11, 0    '?? I thought we get RAMP by default??
    case kDMD_Myst_BonusXHold:
      DisplayDMDText2 "MYSTERY","Bonus Hold", 1000, 11, 0
    case kDMD_Myst_HadronLit:
      DisplayDMDText2 "MYSTERY","HADRON IS LIT", 1000, 11, 0
    case kDMD_Myst_RampageG:
      DisplayDMDText2 "MYSTERY","RAMPAGE G", 1000, 11, 0
      SpellRampage = 3
      RocketKicker_Hit
    case kDMD_Myst_RampageE:
      DisplayDMDText2 "MYSTERY","RAMPAGE E", 1000, 11, 0
      SpellRampage = 4
      RocketKicker_Hit
    case kDMD_Myst_OrbIsLit:
      DisplayDMDText2 "MYSTERY","ORB IS LIT", 1000, 11, 0
    case kDMD_Myst_HPhoneHurry:
      DisplayDMDText2 "MYSTERY","HURRY", 1000, 11, 0
    case kDMD_Myst_20Million:
      DisplayDMDText2 "MYSTERY","20 MILLION", 1000, 11, 0
      DOF 128, DOFPulse
      AddScore 20000000
    case kDMD_Myst_BallSaveLit:
      AwardExtraBall
    case kDMD_Myst_ExtraBallLit:
      setExtraBallLight(True)
      'flshExtraBall.TimerEnabled = True
    case kDMD_Myst_BonusMultiplier:
      if BonusMultiplier < 10 then
        Select case BonusMultiplier+1
          case 2: playmedia "Video-0x007D.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 3: playmedia "Video-0x0057.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 4: playmedia "Video-0x008B.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 5: playmedia "Video-0x0046.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 6: playmedia "Video-0x0089.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 7: playmedia "Video-0x00B4.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 8: playmedia "Video-0x0022.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 9: playmedia "Video-0x0055.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
          case 10: playmedia "Video-0x0072.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End Select
        AddBonusMultiplier 1

      End If
  End Select

End Sub

'**************************************************
'******** Debug routines
Dim debugEnableCount:debugEnableCount=0
Dim bDebugLeftMagnaDown:bDebugLeftMagnaDown=False
Dim bDebugRightMagnaDown:bDebugRightMagnaDown=False
Sub HandleDebugDown(keycode)
  exit sub
  If KeyCode = LeftMagnaSave then bDebugLeftMagnaDown = True
  If KeyCode = RightMagnaSave then bDebugRightMagnaDown = True
debug.print "DEBUG L:" & bDebugLeftMagnaDown & " R:" & bDebugRightMagnaDown
  if (bDebugMode = False) Then  ' Turn on debug whne you pres magnas together three times
    if (bDebugLeftMagnaDown and bDebugRightMagnaDown) then
      debugEnableCount=debugEnableCount+1
      if debugEnableCount = 3 then
        PlaySoundVol "gg_WeAreTheGOTG", VolDef
        bDebugMode = True
      End If
    End If
    Exit Sub
  End if

  if (bDebugLeftMagnaDown and bDebugRightMagnaDown = False) then
    vpmtimer.addtimer 200, "HandleDebugLeft '"
  Elseif (bDebugLeftMagnaDown = False and bDebugRightMagnaDown) then
    vpmtimer.addtimer 200, "HandleDebugRight '"
  elseif (bDebugLeftMagnaDown and bDebugRightMagnaDown) then  ' Setup for Wizard modes
    if modesCompleted < 4 and bCherryBombDone=False then ' Cherry Bomb
      debug.print "Enable Cherry Bomb"
      ModePercent(0) = 100
      ModePercent(1) = 100
      ModePercent(2) = 100
      ModePercent(3) = 100
    elseif modes50 < 8 then ' Immolation
      debug.print "Enable Immolation"
      bCherryBombReady = False
      bCherryBombDone=True
      'bPlayerModeSelect = False
      ModePercent(0) = 50
      ModePercent(1) = 50
      ModePercent(2) = 50
      ModePercent(3) = 50
      ModePercent(4) = 50
      ModePercent(5) = 50
      ModePercent(6) = 50
      ModePercent(7) = 50
      Light033.state=1:Light030.state=1 ' Groot and ORB
      'HadronEnforcerCount = 100
    elseif modesCompleted<8 then
      debug.print "Enable Xandar"
      EndImmolation(0)
      bImmolationReady = False
      bImmolationDone=True
      ModePercent(0) = 100
      ModePercent(1) = 100
      ModePercent(2) = 100
      ModePercent(3) = 100
      ModePercent(4) = 100
      ModePercent(5) = 100
      ModePercent(6) = 100
      ModePercent(7) = 100
      Light029.state = 1      ' Immolation
    End if
    StopPlayerMode
    if bPlayerModeSelect then   ' Clean up some things
      SelectPlayerMode(LeftFlipperKey)
    End If
  End If
End Sub
Sub HandleDebugUp(keycode)
  exit sub
  If KeyCode = LeftMagnaSave then bDebugLeftMagnaDown = False
  If KeyCode = RightMagnaSave then bDebugRightMagnaDown = False
End Sub

Sub HandleDebugLeft()
  Dim Ball
  if bPlayerModeSelect then exit sub  ' Dont do this when in player select
  if (bDebugLeftMagnaDown and bDebugRightMagnaDown = False) then
    if BallsOnPlayfield = 1 then
      For each Ball in GetBalls
        Ball.VelY = 0
        Ball.VelX = 0
        Ball.VelZ = 0
        Ball.x = 320
        Ball.y = 1820.173
      Next
    End If
  End If
End Sub
Sub HandleDebugRight()
  Dim Ball
  if bPlayerModeSelect then exit sub  ' Dont do this when in player select
  if (bDebugLeftMagnaDown = False and bDebugRightMagnaDown) then
    if BallsOnPlayfield = 1 then
      For each Ball in GetBalls
        Ball.VelY = 0
        Ball.VelX = 0
        Ball.VelZ = 0
        Ball.x = 640
        Ball.y = 1789.111
      Next
    End If
  End If
End Sub

'**************************************************

Sub EnablePlayerSelect()
  bPlayerModeSelect = True
  pBGPlayerSelect
End sub


dim modeRampColor
Sub SelectPlayerMode(keycode)
  Dim cnt
  cnt = 0

    If keycode = LeftFlipperKey Then
        PlaySoundVol "fx_Previous", VolDef
    Do
      cnt=cnt+1
      PlayerMode = (PlayerMode + 1)MOD 8
    Loop While ModePercent(PlayerMode) >= 100 and cnt<8
        UpdatePlayerMode
    End If
    If keycode = RightFlipperKey Then
        PlaySoundVol "fx_Next", VolDef
    Do
      cnt=cnt+1
      PlayerMode = (PlayerMode - 1)
      if (PlayerMode < 0) then PlayerMode=7
    Loop While ModePercent(PlayerMode) >= 100 and cnt<8
        UpdatePlayerMode
    End If
End Sub

Sub UpdatePlayerMode() 'Updates the DMD & lights with the chosen skillshots

debug.print "UpdatePlayerMode " & PlayerMode
    LightSeqSkillshot.Play SeqAllOff
    'turn off lights
  BumperLight001.State = 0
  BumperLight002.State = 0
  BumperLight003.State = 0
    Light020.State = 0:Light020.BlinkInterval=BlinkIntDef:Light020.BlinkPattern=BlinkPatternDef
    Light021.State = 0:Light021.BlinkInterval=BlinkIntDef:Light021.BlinkPattern=BlinkPatternDef
    Light022.State = 0:Light022.BlinkInterval=BlinkIntDef:Light022.BlinkPattern=BlinkPatternDef
    Light023.State = 0:Light023.BlinkInterval=BlinkIntDef:Light023.BlinkPattern=BlinkPatternDef
    Light024.State = 0:Light024.BlinkInterval=BlinkIntDef:Light024.BlinkPattern=BlinkPatternDef
    Light025.State = 0:Light025.BlinkInterval=BlinkIntDef:Light025.BlinkPattern=BlinkPatternDef
    Light026.State = 0:Light026.BlinkInterval=BlinkIntDef:Light026.BlinkPattern=BlinkPatternDef
    Light027.State = 0:Light027.BlinkInterval=BlinkIntDef:Light027.BlinkPattern=BlinkPatternDef

  dim time
  time = 24
  if bUsePUPDMD then time = -1

  '***********************  Turn off last player *****************
  ' Nebula
    DOF 303, DOFOff               ' James DOF
    SetLightColor lGamoraArrow, "purple", 0
    SetLightColor lNebulaArrow, "purple", 0
  ' Ronan
    DOF 301, DOFOff               ' James DOF
    SetLightColor lHadron0, "yellow", 0
    SetLightColor lHadron1, "yellow", 0
    SetLightColor lHadron2, "yellow", 0
    SetLightColor lHadron3, "yellow", 0
    SetLightColor lHadron4, "yellow", 0
    SetLightColor lRonanArrow, "yellow", 0
  ' Yondu
    DOF 300, DOFOff               ' James DOF
    SetLightColor lYonduArrow, "white", 0
    SetLightColor lgr_a, "white", 0
  ' Start Lord
    DOF 308, DOFOff               ' James DOF
    SetLightColor lStarLordArrow, "white", 0
    SetLightColor lRonanArrow, "white", 0
    SetLightColor lRocketArrow, "white", 0
  ' Drax
    DOF 307, DOFOff               ' James DOF
    SetLightColor lDraxArrow, modeRampColor, 0
    SetLightColor lRonanArrow, modeRampColor, 0
  ' Rocket
    DOF 302, DOFOff               ' James DOF
    SetLightColor lRocketArrow, "orange", 0
    SetLightColor lgr_a, "orange", 0

    SetLightColor lNova_sw2, "orange", PlayerState(CurrentPlayer).lNovaStates(0)
    SetLightColor lNova_sw3, "orange", PlayerState(CurrentPlayer).lNovaStates(1)
    SetLightColor lNova_sw4, "orange", PlayerState(CurrentPlayer).lNovaStates(2)
    SetLightColor lNova_sw8, "orange", lNova_sw8.UserValue  ' Override with skill shot
    SetLightColor lNova_sw9, "orange", lNova_sw9.UserValue

  ' Gamora
    DOF 306, DOFOff               ' James DOF
    SetLightColor lGamoraArrow, "green", 0
    SetLightColor lNebulaArrow, "green", 0
  ' Broker
    DOF 305, DOFOff               ' James DOF
    SetLightColor lNebulaArrow, "blue", 0
    SetLightColor lBrokerArrow, "blue", 0

  if bCherryBombReady Then
    SetLightColor lStarLordArrow, "red", 2
  End if

    DMDFlush
  Dim Line1
  if PlayerMode = -1 Then
    Line1 = "Select Mode"
  Else
    Line1 = "Mode Select (" & ModePercent(PlayerMode) & ")"
  End If
    Select Case PlayerMode
    case -1:' No Mode is selected yet
      DisplayDMDText2 "PLEASE SELECT ","A MODE", 20000, 10, 1
'     DMD "PLEASE SELECT", "A MODE", "", eNone, eNone, eNone, time, False, "":Light020.State = 2 ' Focuses on the Ramps
        Case 0: ' Nebula
      DOF 303, DOFOn      ' James DOF
      DMD Line1, CL(0, "Pod Chase"), "", eNone, eNone, eNone, time, False, "":Light020.State = 2 ' Focuses on the Ramps
      modeRampColor = "blue"
      SetLightColor lGamoraArrow, modeRampColor, 1
      SetLightColor lNebulaArrow, modeRampColor, 1
      ModeCountdown = 154 ' seconds
      HadronFlash "blue", True
      pDMDEvent(kDMD_SelPodChase)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress10-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        Case 1: ' Ronan
      DOF 301, DOFOn      ' James DOF
      modeRampColor = "yellow"
      DMD Line1, CL(0, "Sanctuary"), "", eNone, eNone, eNone, time, False, "":Light021.State = 2 ' Focuses on the Left Loop
      SetLightColor lHadron0, "yellow", 1
      SetLightColor lHadron1, "yellow", 1
      SetLightColor lHadron2, "yellow", 1
      SetLightColor lHadron3, "yellow", 1
      SetLightColor lHadron4, "yellow", 1
      SetLightColor lRonanArrow, "yellow", 2
      ModeCountdown = 68 ' seconds
      HadronFlash "yellow", True
      pDMDEvent(kDMD_SelSanctuary)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress5-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        Case 2: ' Yandu
      DOF 300, DOFOn      ' James DOF
      DMD Line1, CL(0, "Yaka Arrow"), "", eNone, eNone, eNone, time, False, "":Light022.State = 2 ' St Bobilee ??
      modeRampColor = "blue-light"
      SetLightColor lYonduArrow, modeRampColor, 1
      SetLightColor lgr_a, modeRampColor, 1
      ModeCountdown = 54 ' seconds
      HadronFlash "white", True
      pDMDEvent(kDMD_SelYakaArrow)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        Case 3: ' Star Lord
      DOF 308, DOFOn      ' James DOF
      DMD Line1, CL(0, "Quills Quest"), "", eNone, eNone, eNone, time, False, "":Light023.State = 2 ' 2 Ball multiball at the beginning. St Bobilee ??
      SetLightColor lStarLordArrow, "yellow", 2
      SetLightColor lRonanArrow, "yellow", 1
      SetLightColor lRocketArrow, "yellow", 1
      modeRampColor = "yellow"
      ModeCountdown = 166 ' seconds
      HadronFlash "orange", True
      pDMDEvent(kDMD_SelQuillsQuest)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress12-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        Case 4: ' Drax
      DOF 307, DOFOn      ' James DOF
      DMD Line1, CL(0, "Knowhere"), "", eNone, eNone, eNone, time, False, "":Light024.State = 2 '
      ModeCountdown = 85 ' seconds
      modeRampColor = "red"
      SetLightColor lDraxArrow, modeRampColor, 2
      SetLightColor lRonanArrow, modeRampColor, 2
      SetLightColor lGamoraArrow, modeRampColor, 1
      SetLightColor lNebulaArrow, modeRampColor, 1
      HadronFlash "red", True
      pDMDEvent(kDMD_SelKnowhere)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8r-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        Case 5: ' Rocket
      DOF 302, DOFOn      ' James DOF
      DMD Line1, CL(0, "Escape Kyln"), "", eNone, eNone, eNone, time, False, "":Light025.State = 2 '
      ModeCountdown = 85 ' seconds
      modeRampColor = "orange"
      SetLightColor lRocketArrow, modeRampColor, 1
      SetLightColor lgr_a, modeRampColor, 1

      SetLightColor lNova_sw2, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(0)
      SetLightColor lNova_sw3, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(1)
      SetLightColor lNova_sw4, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(2)
      SetLightColor lNova_sw8, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(3)
      SetLightColor lNova_sw9, "orange", PlayerState(CurrentPlayer).lNovaStatesKyln(4)
      HadronFlash "orangedark", True
      pDMDEvent(kDMD_SelEscapeKyln)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress7-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"

        Case 6: ' Gamora
      DOF 306, DOFOn      ' James DOF
      DMD Line1, CL(0, "Sibling Rivalry"), "", eNone, eNone, eNone, time, False, "":Light026.State = 2 ' Gamora
      modeRampColor = "green"
      SetLightColor lGamoraArrow, modeRampColor, 2
      SetLightColor lNebulaArrow, modeRampColor, 2
      ModeCountdown = 101 ' seconds
      HadronFlash "green", True
      pDMDEvent(kDMD_SelSibling)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8g-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        Case 7: ' Broker
      DOF 305, DOFOn      ' James DOF
      DMD Line1, CL(0, "Antiquities Shop"), "", eNone, eNone, eNone, time, False, "":Light027.State = 2 '
      modeRampColor = "cyan"
      SetLightColor lNebulaArrow, modeRampColor, 1
      SetLightColor lBrokerArrow, modeRampColor, 2
      ModeCountdown = 61 ' seconds
      HadronFlash "cyan", True
      pDMDEvent(kDMD_SelAntiquities)
      RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress7t-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
    End Select

  if PlayerMode <> -1 Then
    SetBackglassTimer(ModeCountdown)
  End If
  SetModeLights

End Sub

Sub RefreshPlayerMode() 'Refreshed the Progress Image and others since they dissapear when you switch screen and come back
  if bUsePUPDMD then
    Select Case PlayerMode
      case -1:' No Mode is selected yet
      Case 0: ' Nebula
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress10-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
      Case 1: ' Ronan
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress5-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
      Case 2: ' Yandu
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
      Case 3: ' Star Lord
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress12-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
      Case 4: ' Drax
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8r-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
      Case 5: ' Rocket
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress7-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
      Case 6: ' Gamora
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8g-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
      Case 7: ' Broker
        puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress7t-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
    End Select

    if tmrRampage.Enabled then
      puPlayer.LabelSet pBackglass, "RampImg", "PuPOverlays\\Rampage.gif",1,"{'mt':2,'color':111111,'width':11, 'height':21, 'anigif':100,}"
    End If
  End If
End Sub


Function CheckWizardModeStart(trigger_name)
dim a,i,b
CheckWizardModeStart=False
  if trigger_name = "lStarLordArrow" Then ' scoop hit
    ' ******* Handle Cherry Bomb ********   Start Cherry Bomb
    if bCherryBombReady Then
      debug.print "Start Cherry Bomb"
      DMD "Start Mode", CL(0, "Cherry Bomb"), "", eNone, eNone, eNone, 1000, False, ""

      StopPlayerMode
      StopPlayerMode2       ' Stop the mode since CB doesnt stack

      setUpgradeLight(True)
      setModeSelectLight(False)
'     flshUpgrade.TimerEnabled = True
'     flshModeSelect.TimerEnabled = False

      bCherryBombReady = False
      CherryBombCount=0
      tmrCherryBomb.UserValue = 60
      tmrCherryBomb.Interval = 1000
      tmrCherryBomb.Enabled = True
      bWizardMode = True
      WizardModePoints=0
      WizardBonusPoints=0

      EnableOrb(True)           ' Drop the orb Target
      OrbTarget1.isDropped = True

      GrootMouth_Drop(False)        ' Close Groots Mouth in case it is open

      ' Stop ballsaver if it is currently running
      BallSaverTimerCancel

      ' Setup new Ball Saver
      BallSaverTime = 60
      bBallSaverReady = True

      AddMultiball 5 - BallsOnPlayfield
      'ModeCountdownTimer.UserValue = 60
      'ModeCountdownTimer.Enabled = True

      StartPlayerModeVideo False      ' Play cherry video

      LoopGateLeft.Open = True    ' Gates are open for a full orbit shots
      Gate002.Open = True

      StackState(kStack_Pri2).Enable(-1)
      For each a in aRampLights       ' Upgrade so All the arrows count now
        SSetLightColor kStack_Pri2, a, "red", 2
      Next
      CheckWizardModeStart = True
    ' ********* Immolation Mode ready       Start Immolation Mode
    '                       * All Arrows are lit
    '                     * Hit an arrow, Turns off all arrows, except the one you Hit
    '                     * Hit the single lit arrow (Note, Switch hits and "Hadron Enforcer Lit", Spot a Shot from left to right)
    '                     * Arrows you havent hit light up
    elseIf bImmolationReady Then
      debug.print "Start Immolation"
      StopScoopLightSeq
      DMD "Start Mode", CL(0, "Immolation Initiative"), "", eNone, eNone, eNone, 1000, False, ""
      setUpgradeLight(True)
      setModeSelectLight(False)
'     flshUpgrade.TimerEnabled = True
'     flshModeSelect.TimerEnabled = False

      LightSeqImmolation.TimerInterval = 40
      LightSeqImmolation.Play SeqBlinking, 0, 50, 40    ' 50 time, 40ms on/off

      ' TBD: Play Immolation Video
      SwitchHitCount=75
      UpdateSwitchHitCnt SwitchHitCount
      tmrImmolation.Enabled = True
      GrootMouth_Drop(False)          ' Close Groots Mouth in case it is open
      bImmolationReady = False
      ImmolationCount=0
      LastImmolationScore=0
      bBallSaverReady = True
      AddMultiball 3 - BallsOnPlayfield
      bWizardMode = True
      WizardModePoints=0
      WizardBonusPoints=0

      StartPlayerModeVideo False

      StackState(kStack_Pri2).Enable(-1)
      bImmolationAllMode=True
      For each a in aRampLights       ' light ramps (Remember progress)
        select case a.name            ' Mark it so we dont light it up again
          case "lYonduArrow": i=0
          case "lRonanArrow": i=1
          case "lRocketArrow": i=2
          case "lNebulaArrow": i=3
          case "lgr_a": i=4
          case "lBrokerArrow": i=5
          case "lGamoraArrow": i=6
          case "lDraxArrow": i=8
          case "lStarLordArrow": i=8
        End Select

        if bImmolationProgress(i)=False then
          SSetLightColor kStack_Pri2, a, "yellow", 2
        Else
          SSetLightColor kStack_Pri2, a, "yellow", 0
        End if
      Next
      CheckWizardModeStart = True
    ' ********* Xandar Mode ready       Start Save Xandar Mode
    '                   Hit each upper arrow 3 times, Each hit flashes border lights and plays du, duh, duhh, duhha
    '                     All Arrows lights starlord arrow and name. Hit starlord and win the game
    '                   Play Video-0x0091.mp4, flash up, down, up then random (4 seconds Total)
    elseif bXandarReady Then
      debug.print "Start Xanadar"

      StopScoopLightSeq
      DMD "Start Mode", CL(0, "Save Xandar"), "", eNone, eNone, eNone, 1000, False, ""

      setUpgradeLight(True)
      setModeSelectLight(False)
'     flshUpgrade.TimerEnabled = True
'     flshModeSelect.TimerEnabled = False

      ' Multi Step Light Sequence
      LightSeqXandar.UserValue=0
      LightSeqXandar.Play SeqDownOn, 30, 3

      'SwitchHitCount=100
      EnableOrb(True)
      OrbTarget1.isDropped = True           ' Drop the orb Target
      tmrXandar.Enabled = True
      GrootMouth_Drop(False)              ' Close Groots Mouth in case it is open
      bXandarReady = False
      XandarCount=0
      bWizardMode = True
      WizardModePoints=0
      WizardBonusPoints=0

      ' Stop ballsaver if it is currently running
      BallSaverTimerCancel

      ' Setup new Ball Saver
      BallSaverTime = 60            ' Note: initially you get 60 seconds but watching videos something can add another 60 seconds (scoop maybe?)
      bBallSaverReady = True

      AddMultiball 4 - BallsOnPlayfield

      StartPlayerModeVideo False
      StackState(kStack_Pri2).Enable(-1)

      For each a in aRampLights       ' light ramps and set value so we can track progress
        SSetLightColor kStack_Pri2, a, "purple", 2
        'SetLightColor a, modeRampColor, 2
        a.UserValue = 0
      Next
      CheckWizardModeStart = True
    End If
  End If
End Function

Sub CheckWizardModeProgress(trigger_name)
  dim a,b,i
  Dim bValidHit
  dim bFinalShot
  dim hitLight
  Dim holdScore

  if bDebounce then exit sub

  if tmrCherryBomb.Enabled Then ' We are in cherry bomb mode (Should we make this its own mode?)
    if trigger_name = "GrootKicker" then ' Finished CherryBomb

      bDebounce = True
      vpmtimer.addtimer 400, "debounceReset '"

      ' Reset and do it again
      tmrCherryBombMouth.Enabled = False
      CherryBombCount=0
      GrootMouth_Drop(True)           ' Open groots mouth
      For each a in aRampLights         ' Upgrade so All the arrows count now
        SSetLightColor kStack_Pri2, a, "red", 2
      Next
      QueueScene "DoCBombComplete'", 5000, 1
      QueueScene "DoCBombClear'", 0, 1
      vpmtimer.addtimer 1000, "CreateNewBallGroot() '"
      vpmtimer.addtimer 2000, "GrootMouth_Drop(False) '"
      'tmrCherryBomb.UserValue = -1
      'EndCherryBomb    ' Note the player mode take 8 second for all the balls to drain anyway, so modes should be finished
      exit sub
    end if
    For each a in aRampLights   ' Need to hit flashing arrows and turn them solid
      if a.name = trigger_name and StackState(kStack_Pri2).GetArrowState(a) <> 0 then
        'PlaySound "gg_RampHit"
        'LightSeqScore.Play SeqUpOn, 100, 0
        if StackState(kStack_Pri2).GetArrowState(a) = 2 Then      ' Add Score (Is this supposed to go to a jackpot instead?)
          PlayProgress trigger_name
          DOF 128, DOFPulse
          AddScore 3000000
          SSetLightColor kStack_Pri2, a, "red", 1
          CherryBombCount=CherryBombCount+1
        Else
          AddScore 1000000    ' TBD - If you hit it a third time looks like it is only 500K
        End If

        if (CherryBombCount = 9) Then   ' Groot Mouth Opens and closes for final shot
          tmrCherryBombMouth.Enabled = True
          For each b in aRampLights       ' Turn off all arrows except GrootArrow
            SSetLightColor kStack_Pri2, b, "red", 0
          Next
          SSetLightColor kStack_Pri2, lgr_a, "red", 2
        End if
      End If
    Next
  elseif tmrImmolation.Enabled  Then  ' We are in Immolation Mode
    if trigger_name = "switch" Then       ' Find one to spot (Left to Right)
      SwitchHitCount = SwitchHitCount - 1
      if (SwitchHitCount <= 0) then
        if StackState(kStack_Pri2).GetArrowState(lYonduArrow) <> 0 then
          trigger_name = "lYonduArrow"
        elseif StackState(kStack_Pri2).GetArrowState(lRonanArrow) <> 0 then
          trigger_name = "lRonanArrow"
        elseif StackState(kStack_Pri2).GetArrowState(lRocketArrow) <> 0 then
          trigger_name = "lRocketArrow"
        elseif StackState(kStack_Pri2).GetArrowState(lNebulaArrow) <> 0 then
          trigger_name = "lNebulaArrow"
        elseif StackState(kStack_Pri2).GetArrowState(lgr_a) <> 0 then
          trigger_name = "lgr_a"
        elseif StackState(kStack_Pri2).GetArrowState(lBrokerArrow) <> 0 then
          trigger_name = "lBrokerArrow"
        elseif StackState(kStack_Pri2).GetArrowState(lGamoraArrow) <> 0 then
          trigger_name = "lGamoraArrow"
        elseif StackState(kStack_Pri2).GetArrowState(lDraxArrow) <> 0 then
          trigger_name = "lDraxArrow"
        elseif StackState(kStack_Pri2).GetArrowState(lStarLordArrow) <> 0 then
          trigger_name = "lStarLordArrow"
        End If
        BonusAddModeHit(GetBonusIndex(trigger_name))  ' Adds the minor points but more importantly ensures we trigger bonus at the end
      End If
      UpdateSwitchHitCnt SwitchHitCount
    Else                      ' This is really for debugging
      bDebounce = True
      vpmtimer.addtimer 400, "debounceReset '"
    End If

    For each a in aRampLights         ' See which arrow they hit
      if a.name = trigger_name and StackState(kStack_Pri2).GetArrowState(a) <> 0 then
        bValidHit = True
        set hitLight=a
        exit for
      End If
    Next

    if bValidHit Then
      'PlaySound "gg_RampHit"
      'LightSeqScore.Play SeqUpOn, 100, 0
      PlayProgress trigger_name
      ImmolationCount=ImmolationCount+1
      holdScore=0
      Select case ImmolationCount       ' Immolation Scoring is crazy.. This is the best I could determine
        case 1:
          holdScore=1500000
        case 2,8:
          holdScore=(LastImmolationScore*2)+200000
        case 4,6,12,18:
          holdScore=(LastImmolationScore*2)+400000
        case 10,14,16:
          holdScore=LastImmolationScore+200000
        case 3,11,15,17:
          holdScore=LastImmolationScore
        case 7,9,13:
          holdScore=LastImmolationScore/2
        case 5:
          holdScore=LastImmolationScore/4
      End Select
      WizardBonusPoints=WizardBonusPoints+holdScore
      LastImmolationScore=holdScore
      DOF 128, DOFPulse
      AddScore holdScore

      if bImmolationAllMode then              ' When all the lights are on, we turn them all off and then flash the one they hit for a 2nd shot Debug.print "All Mode"
        For each a in aRampLights
          'a.state = 0
          SSetLightColor kStack_Pri2, a, "yellow", 0
        Next
        SSetLightColor kStack_Pri2, hitLight, "yellow", 2
        bImmolationAllMode=False

        select case hitLight.name           ' Mark it so we dont light it up again
          case "lYonduArrow":
            bImmolationProgress(0)=True
          case "lRonanArrow":
            bImmolationProgress(1)=True
          case "lRocketArrow":
            bImmolationProgress(2)=True
          case "lNebulaArrow":
            bImmolationProgress(3)=True
          case "lgr_a":
            bImmolationProgress(4)=True
          case "lBrokerArrow":
            bImmolationProgress(5)=True
          case "lGamoraArrow":
            bImmolationProgress(6)=True
          case "lDraxArrow":
            bImmolationProgress(7)=True
          case "lStarLordArrow":
            bImmolationProgress(8)=True
        End Select
      Else
        bImmolationAllMode=True
        SSetLightColor kStack_Pri2, hitLight, "yellow", 0

        ' Immolation just loops forever If we got the ball just reset progress and go again (If all are true then we Reset)
        bValidHit = False
        For i = 0 to 8
          if bImmolationProgress(i)=False then
            bValidHit=True
debug.print "Immolation arrow not complete:" & i
          End If
        Next
        If bValidHit =False then      ' No more valid hits.  Reset so they can do it again
debug.print "Immolation Complete"
          For i = 0 to 8
            bImmolationProgress(i)=False
          Next

          ' Add the Immolation Bonus first time through  (TBD: Is this every time through???)
          if Light029.state = 2 then
            AddScore WizardBonusPoints
            if BallsOnPlayfield < 6 then
              AddMultiball 1              ' Add a ball for completing
            End If
            if WizardBonusPoints > 1000000 then
              puPlayer.LabelSet pBackglass,"Message", WizardBonusPoints / 1000000 & "M" ,1,""
              vpmTimer.addTimer 2000, "puPlayer.LabelSet pBackglass,""Message"", """" ,1,"""" '"  ' Clear it
            End If
            WizardBonusPoints=0
          End If

          PlaySoundVol "LevelUp-3", VolDef  ' Play sounds so they know they are done
          SetLightColor Light029, "white", 1  ' Mark Immolation as complete
        End If

        ' Reset lights based on progress
        For i = 0 to 8
          if bImmolationProgress(i) = False then
            select case i
              case 0:
                SSetLightColor kStack_Pri2, lYonduArrow, "yellow", 2
              case 1:
                SSetLightColor kStack_Pri2, lRonanArrow, "yellow", 2
              case 2:
                SSetLightColor kStack_Pri2, lRocketArrow, "yellow", 2
              case 3:
                SSetLightColor kStack_Pri2, lNebulaArrow, "yellow", 2
              case 4:
                SSetLightColor kStack_Pri2, lgr_a, "yellow", 2
              case 5:
                SSetLightColor kStack_Pri2, lBrokerArrow, "yellow", 2
              case 6:
                SSetLightColor kStack_Pri2, lGamoraArrow, "yellow", 2
              case 7:
                SSetLightColor kStack_Pri2, lDraxArrow, "yellow", 2
              case 8:
                SSetLightColor kStack_Pri2, lStarLordArrow, "yellow", 2
            End Select
          End If
        Next

      End If

    End If
  elseif tmrXandar.Enabled Then   ' We are in Xandar Mode
debug.print "Xandar:" & trigger_name
    if trigger_name = "lStarLordArrow" and lStarLordArrow.UserValue>=4 then   ' Save XANDAR Super Jackpot
      AddScore 100000000            ' 100M for Xandar complete
      puPlayer.LabelSet pBackglass,"Message", "100M" ,1,""

      'pDMDEvent(kDMD_SaveXandarFinal)
      LightSeqXandarFinale.UserValue = 0
      LightSeqXandarFinale.Play SeqUpOn, 30, 1
      PlayDMDScene "Video-0x0091.mp4", 5040                           ' Pink light show on DMD
      QueueScene "DoXandarComplete'", 5000, 1                           ' Show Pink light show
      QueueScene "DoXandarClear'", 0, 1
      QueueScene "ShowPlayerModeComplete(2) '", 0, 1      ' Show Save Xandar Total      ' Show Mode total
      vpmtimer.addtimer 8200, "EndXandar '"         ' End the Mode

      ' Reset all the modes back to 0 and light the xandar light solid
      for i = 0 to 8
        ModeProgress(i) = 0
        ModePercent(i) = 0
        Mode2Progress(i) = 0
        Mode2Percent(i) = 0
      Next
      SetLightColor Light031, "white", 1        ' Mark Xandar Complete
      SetLightColor Light033, "purple", 0 ' Clear OrbMB
      SetLightColor Light030, "green", 0  ' Clear GrootMB
      SetLightColor Light029, "White", 0  ' Clear Immolation
      XandarCount=0
      Exit sub
    End If
    For each a in aRampLights   ' Need to hit flashing arrows
  '         if a.state=2 then set hitLight=a
      if a.name = trigger_name and StackState(kStack_Pri2).GetArrowState(a)=2 then
        bValidHit = True
        set hitLight=a
        a.UserValue = a.UserValue+1
        exit for
      End If
    Next
  ' No Switch hits
  '       if trigger_name = "switch" Then
  '         SwitchHitCount = SwitchHitCount - 1
  '         if (SwitchHitCount <= 0) then
  '           if Not IsEmpty(hitLight) then       ' Did we find an arrow light to mark off
  '             bValidHit = True
  '             SwitchHitCount = 100
  '           End If
  '         End If
  '       End If

    if bValidHit Then
      'PlaySound "gg_RampHit"
      'LightSeqScore.Play SeqUpOn, 100, 0
      PlayProgress trigger_name
      'msgbox hitLight.UserValue
      if StackState(kStack_Pri2).GetArrowState(hitLight) = 2 Then     ' Add Score (Is this supposed to go to a jackpot instead?)
        DOF 128, DOFPulse
        XandarCount=XandarCount+1
        AddScore 1500000 + (XandarCount*500000)
      End If
      if hitLight.UserValue >= 3 Then   ' three hits turns it off
        SSetLightColor kStack_Pri2, hitLight, modeRampColor, 0
        'SetLightColor hitLight, modeRampColor, 0
debug.print "Finished: " & hitLight.name & " " & hitLight.UserValue
      End If

      bFinalShot=True   ' See if we got all of the arrows
      For each a in aRampLights
        if a.UserValue < 3 Then
debug.print "Not Finished: " & a.name & " " & a.UserValue & " " & StackState(kStack_Pri2).GetArrowState(a)
          bFinalShot=False
          exit For
        End If
      Next
      if bFinalShot then  ' Light Super Jackpot
        PlaySoundVol "gg_SuperJackpot", VolDef
        ' Flash StarLord
        lStarLordArrow.UserValue = 4
        SSetLightColor kStack_Pri2, lStarLordArrow, modeRampColor, 2
        'SetLightColor lStarLordArrow, modeRampColor, 2
      End If
    End If
  End If

End Sub


dim Mode2Percent(8)
dim Mode2Progress(8)
dim ModeProgress(8)
dim ModePercent(8)
dim bModeProgressUpgraded
dim bDebounce
dim bQualifyYando
Sub CheckModeProgress(trigger_name)
  dim bValidHit
  dim bFinalShot
  dim hitLight
  dim a, b, i
  dim thisScore
  dim MB_Multiplier:MB_Multiplier=1
  Dim bModeComplete
  Dim bDoubleBonus
  bDoubleBonus = False
  bModeComplete = False
  bValidHit = False

  if bDebounce Then   ' we cant hit it twice or in between resets
'debug.print "Debounce"
    exit Sub
  End If
'debug.print "Check Mode Progress " & BallSearchCnt


  if BallSearchCnt > 0 then exit sub  ' We are in an error mode skip doing anything
  ResetBallSearch

  If trigger_name = "lStarLordArrow" then
    if flshMystery.TimerEnabled then    ' Check Mystery
      setMysteryLight(False)
      'flshMystery.TimerEnabled = False
      AwardMystery
    Elseif flshExtraBall.TimerEnabled then
      setExtraBallLight(False)
      'flshExtraBall.TimerEnabled = False
      AwardExtraBall
    End If
  End If

  if bGrootMultiball then ' Check MB Lights
    For each a in aRampLights   ' Need to hit flashing arrows and turn them solid

      if trigger_name = "GrootKicker" and tmrCherryBombMouth.Enabled then   ' Final Groot Shot
        EndGrootMB(False)
        GrootMBFinished=True
        'If we got multib all then set the playfield lights
        SetLightColor Light030, "green", 1  ' Light Groot Multiball as done
        exit sub
      End If

      if a.name = trigger_name and StackState(kStack_Pri1).GetArrowState(a) <> 0 then
        'PlaySound "gg_RampHit"
        'LightSeqScore.Play SeqUpOn, 100, 0
        PlayProgress trigger_name

        ' Hit a target 3 times to complere
        i = GetModeIndex(trigger_name)
        GrootMBJackpotHits(i) = GrootMBJackpotHits(i) + 1
        if (GrootMBJackpotHits(i) = 3) then
          SSetLightColor kStack_Pri1, a, modeRampColor, 0
        End if

        ' See if we are done with Groot MB
        For i = 0 to aRampLights.count
          if GrootMBJackpotHits(i) <> 0 then bModeComplete=False
        Next
        if bModeComplete Then ' Groot MB is Complete, start double super jackpot for final shot (use cherrybomb function since it works the same)
          tmrCherryBombMouth.Enabled = True
          For each b in aRampLights       ' Turn off all arrows except GrootArrow
            SSetLightColor kStack_Pri1, b, "green", 0
          Next
          SSetLightColor kStack_Pri1, lgr_a, "green", 2
        End if
        bModeComplete=False   ' Set this back so we dont mess up stacked modes

        ' Process score for this shot
        if bIsModeComplete(i) then MB_Multiplier=5    ' We get 5x multiplier if this mode is completed
        GrootMBJackpotCnt = GrootMBJackpotCnt + 1
        if GrootMBJackpotCnt = 0 then
          thisScore = 300000
        elseif GrootMBJackpotCnt = 9 or GrootMBJackpotCnt = 18 then
          thisScore = (25000 * MB_Multiplier)
          SSetLightColor kStack_Pri1, lgr_a, "green", 1
        else
          thisScore = (25000 * MB_Multiplier)
        end if
        AddScore thisScore
        GrootMBJackpot = GrootMBJackpot + thisScore
        exit for
      End If
    Next
  elseif bOrbMultiBall then
    For each a in aRampLights   ' Need to hit flashing arrows and turn them solid
      'if a.name = trigger_name and a.state <> 0 then
'debug.print "ORB: " & OrbMBJackpotHits & " " & trigger_name
      if a.name = trigger_name and StackState(kStack_Pri1).GetArrowState(a) <> 0 then
        SSetLightColor kStack_Pri1, a, "purple", 0
        if OrbMBJackpotHits = 9 and "lBrokerArrow" = trigger_name then  ' Hit super Jackpot
          PlaySoundVol "gg_SuperJackpot", VolDef
          DOF 128, DOFPulse
          AddScore OrbMBJackpot
          OrbMBJackpot = OrbMBJackpot *2  ' Store this off so the total bonus works
          OrbSuperJackpotExpired()
          SetLightColor Light033, "purple", 1 ' Light Orb Multiball because we finished
          OrbMultiBallCount=OrbMultiBallCount+1
        Else
          AddScore tmrOrbHurryUp.UserValue
          OrbMBJackpot = OrbMBJackpot + tmrOrbHurryUp.UserValue
          PlayProgress trigger_name

          ' TBD : Show PupVideo here

          i = GetModeIndex(trigger_name)
          OrbMBJackpotHits = OrbMBJackpotHits + 1
          Debug.print "Orb Jackpot for " & trigger_name & ":" & OrbMBJackpotHits
          ' TBD: Add a timer for 3 seonds of 2x
          if (OrbMBJackpotHits = 9) Then      ' After you get them all light SuperJackpot
            SSetLightColor kStack_Pri1, lBrokerArrow, "purple", 1
            PlaySoundVol "say-SuperJackpotIsLit", VolDef
            vpmtimer.addtimer 10000, "OrbSuperJackpotExpired '"   ' 10 seconds to hit the super Jackpot
          End if
        End If
        exit for
      End If
    Next
  End if

' if trigger_name = "lStarLordArrow" and _
'   (bCherryBombReady or bImmolationReady or bXandarReady) Then  ' Stop modes and go into Wizard mode
'   bSkipWaitVideo = True ' Dont go into wait because we are just going to start up another mode
'   StopPlayerMode
'   StopPlayerMode2
'   PlayerMode = -1
'   bSkipWaitVideo = False
' End if
  if CheckWizardModeStart(trigger_name) then Exit Sub       ' Wizard Modes Stack so we check here, bail out when we Start
  CheckWizardModeProgress(trigger_name)


debug.print "Check progress 2nd: " & bSecondMode & " " & PlayerMode & " " & trigger_name
  if (bSecondMode) Then
    if trigger_name = "lStarLordArrow" and bMultiBallMode=False Then  ' scoop hit
      StopPlayerMode2
    Else
      CheckModeProgress2nd(trigger_name)
    End If
  else
    if PlayerMode <> -1 Then
      debug.print "Mode Progress: " & ModePercent(PlayerMode)
      if ModePercent(PlayerMode) >= 100 then
        debug.print "Skip Score: " & ModePercent(PlayerMode)
        Exit Sub
      End If
    End If

    Select Case PlayerMode
    case -1:' No Mode Selected
    Case 0: ' Nebula - Pod Chase (10 shots)
      'MsgBox trigger_name
      if trigger_name = "lStarLordArrow" Then ' scoop hit - perform upgrade
        AddScore 500000
        pDMDEvent(kDMD_Upgrade)
        PlaySoundVol "gg_lazer", VolDef
        For each a in aRampLights       ' Upgrade so All the arrows count now
          SSetLightColor kStack_Pri0, a, modeRampColor, 1
        Next
        setUpgradeLight(False)
        'flshUpgrade.TimerEnabled = False
        bModeProgressUpgraded=True
        SetLightColor lNebulaName, "blue", 2
      else
        For each a in aRampLights
          if a.name = trigger_name and StackState(kStack_Pri0).GetArrowState(a) <> 0 then
            bDebounce = True              ' So the ball doesnt roll over twice before we reset
            vpmtimer.addtimer 400, "debounceReset '"

            'PlaySound "gg_RampHit"         ' Play sounds and reset the timer to reset the lights
            'LightSeqScore.Play SeqUpOn, 100, 0
            PlayProgress trigger_name

            BonusAddMode -1, StackState(kStack_Pri0).GetArrowState(a) = 2

            ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
            ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 10) * 100)
            RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress10-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
            if (ModeProgress(PlayerMode) = 10) Then
              ModePercent(PlayerMode) = 100
              bModeComplete = True
            End If
          end if
        Next
      end if
        Case 1: ' Ronan - Sanctuary (5 shots)
      if trigger_name = "lStarLordArrow" Then ' scoop hit - perform upgrade
        ' lRonanArrow spots shots
        setUpgradeLight(True)
        'flshUpgrade.TimerEnabled = True
        bModeProgressUpgraded=True
        SetLightColor lRonanName, "yellow", 2
      Else
        if ((trigger_name = "tgHadron0") or (trigger_name = "tgHadron1") or (trigger_name = "tgHadron2") or _
          (trigger_name = "tgHadron3") or (trigger_name = "tgHadron4")) or  _
          (trigger_name = "lRonanArrow") Then ' We are going up the ramp

          if trigger_name = "lRonanArrow" then
            if StackState(0).GetArrowState(lRonanArrow) = 2 then bDoubleBonus=True
            if bModeProgressUpgraded or bCompetitionMode=False then ' No Competition mode you dont need to upgrade
              bValidHit = true
              if tgHadron0.UserValue = False Then       ' Spot a target for them (if there is one - there should be)
                tgHadron0.UserValue=1
                lHadron0.state = 2
              elseif tgHadron1.UserValue = False Then
                tgHadron1.UserValue=1
                lHadron1.state = 2
              elseif tgHadron2.UserValue = False Then
                tgHadron2.UserValue=1
                lHadron2.state = 2
              elseif tgHadron3.UserValue = False Then
                tgHadron3.UserValue=1
                lHadron3.state = 2
              elseif tgHadron4.UserValue = False Then
                tgHadron4.UserValue=1
                lHadron4.state = 2
              End If
              CheckCount()  ' Update that are state 2 when we spot a shot
            End if
          Elseif ModeProgress(PlayerMode)<5 then
            bValidHit = True
          End if

          if bValidHit then
            BonusAddMode -1, bDoubleBonus
            'PlaySound "gg_RampHit"
            'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds and reset the timer to reset the lights
            PlayProgress trigger_name
            ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
            ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 5) * 100)
            RefreshPlayerMode ' puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress5-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"

            if (ModeProgress(PlayerMode) = 5) Then
              CheckCount()
              ModePercent(PlayerMode) = 100
              bModeComplete = True
            End If
          End If
        end if
      End If
        Case 2: ' Yondu - Yaka Arrow (8 shots)
      ' Scoop makes light blink for more points ???
      if trigger_name = "lStarLordArrow" Then ' scoop hit - perform upgrade
        AddScore 500000
        pDMDEvent(kDMD_Upgrade)
        PlaySoundVol "gg_lazer", VolDef
        SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor, 2
        For each a in aRampLights       ' Upgrade to blinking
          if StackState(kStack_Pri0).GetArrowState(a) <> 0 then
            SSetLightColor kStack_Pri0, a, modeRampColor, 2
          End If
        Next
        SetLightColor lYonduName, "blue-light", 2
        bModeProgressUpgraded=True
        bValidHit=True
      else
        if trigger_name = "GrootKicker" then  ' When Groot mouth closes then light Groot Arrow back up
          SSetLightColor kStack_Pri0, lgr_a, modeRampColor, 1
        End If
        if trigger_name = "lYonduArrow" then
          PlaySoundVol "say-AboballyBo", VolDef
        End If
        if trigger_name = "sw8" or trigger_name = "sw9" or trigger_name = "sw2" or trigger_name = "sw3" or trigger_name = "sw4" then
          bQualifyYando=True
        End If

        'debug.print "Yondu " & trigger_name & " " & LastSwitchHit
        if trigger_name = "bumper" and bQualifyYando then  ' (LastSwitchHit = "sw8" or LastSwitchHit = "sw9") then  ' Spot a shot
          'bDebounce=True
          LastSwitchHit=""
          bQualifyYando=False
          dim newState:newState=1
          if bModeProgressUpgraded then newState=2
          Select case YakaPops
            case 4
              SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor, newState:bValidHit = True
            case 3
              SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor, newState:bValidHit = True
            case 2
              SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, newState:bValidHit = True
            case 1
              SSetLightColor kStack_Pri0, lBrokerArrow, modeRampColor, newState:bValidHit = True
          End Select
          YakaPops = YakaPops -1
          UpdateHitCntMsg "Pops Remaining: ", YakaPops
          'PupDisplay "Pops Remaining " & YakaPops
        end if

        if (bModeProgressUpgraded) and (trigger_name = "tgHadron0" or trigger_name="tgHadron1") then  ' Upgrade allows left hadrons to spot shots
          bValidHit = True
        else
          For each a in aRampLights
if a.name = trigger_name then debug.print "Yondu Arrow: " & trigger_name & " State:" & StackState(kStack_Pri0).GetArrowState(a)
            if a.name = trigger_name and StackState(kStack_Pri0).GetArrowState(a) <> 0 Then   ' Hit Ramp that was lit
              bValidHit=True
              if StackState(kStack_Pri0).GetArrowState(a) = 2 then bDoubleBonus=True
              if trigger_name <> "lYonduArrow" then SSetLightColor kStack_Pri0, a, modeRampColor, 0 'StackState(kStack_Pri0).SetArrowState a, 0
            End If
          Next
        End If
      End if

      if bValidHit then
        'debug.print "HIT " & trigger_name
        'PlaySound "gg_RampHit"
        'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds and reset the timer to reset the lights
        PlayProgress trigger_name

        BonusAddMode -1, bDoubleBonus
        ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
        ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 8) * 100)
        RefreshPlayerMode ' puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        if (ModeProgress(PlayerMode) = 8) Then
          ModePercent(PlayerMode) = 100
          bModeComplete = True
        End If

      End If
        Case 3: ' Star Lord - Quills Quest (12 shots)
      if trigger_name = "lStarLordArrow" and bModeProgressUpgraded = False Then ' scoop hit - perform upgrade
        setUpgradeLight(False)
        'flshUpgrade.TimerEnabled = False
        bModeProgressUpgraded=True

        'PlaySound "gg_RampHit"
        'LightSeqScore.Play SeqUpOn, 100, 0
        PlayProgress trigger_name

        ' Give Progress
        ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
        ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 12) * 100)
        RefreshPlayerMode
        if (ModeProgress(PlayerMode) = 12) Then
          ModePercent(PlayerMode) = 100
          bModeComplete = True
          vpmtimer.addtimer 3000, "QuillsQuestBonus '"    ' Start timer to hit scoop again and get bonus
        End If
        if ModePercent(PlayerMode) > 100 then
          ModePercent(PlayerMode) = 100
        End If

        HurryUpAddBonus 2000000, 250000, 5000
        SetLightColor lStarLordName, "orange", 2
      else
        For each a in aRampLights
if a.name = trigger_name then debug.print "Arrow State: " & StackState(kStack_Pri0).GetArrowState(a)
          if a.name = trigger_name and StackState(kStack_Pri0).GetArrowState(a) <> 0 Then   ' Hit Ramp that was lit
            bDebounce = True            ' so the ball doesnt roll over twice before we reset
            vpmtimer.addtimer 400, "debounceReset '"
            'PlaySound "gg_RampHit"
            'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds and reset the timer to reset the lights
            PlayProgress trigger_name

            tmrQuestRamps.Enabled = False   ' This will kick the debounce and reset the lights to another area
            tmrQuestRamps.Interval = 1000
            tmrQuestRamps.Enabled = True

            ' Capture the Hurry Up Points
            HurryUpAddBonus 2000000, 250000, 5000
            ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
            ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 12) * 100)
            RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress12-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
            if (ModeProgress(PlayerMode) = 12) Then
              ModePercent(PlayerMode) = 100
              bModeComplete = True
              vpmtimer.addtimer 3000, "QuillsQuestBonus '"    ' Start timer to hit scoop again and get bonus
            End If
            if ModePercent(PlayerMode) > 100 then
              ModePercent(PlayerMode) = 100
            End If
          end if
        Next
      End If
        Case 4: ' Drax - Knowhere (8 shots)
      if trigger_name = "lStarLordArrow" Then ' scoop hit - perform upgrade
        AddScore 500000
        pDMDEvent(kDMD_Upgrade)
        PlaySoundVol "gg_lazer", VolDef
        For each a in aRampLights       ' Upgrade so All the arrows
          if StackState(kStack_Pri0).GetArrowState(a) <> 2 then ' Drax and Ronan start out blinking so dont downgrade
            SSetLightColor kStack_Pri0, a, modeRampColor, 1
          End If
        Next
        setUpgradeLight(False)
        'flshUpgrade.TimerEnabled = False
        bModeProgressUpgraded=True
        SetLightColor lDraxName, "amber", 2
      else
        For each a in aRampLights
          if a.name = trigger_name and StackState(kStack_Pri0).GetArrowState(a) <> 0 Then   ' Hit Ramp that was lit
            PlayProgress trigger_name

            if bCompetitionMode then  ' Real game didnt do this
              For each b in aRampLights       ' Turn off the upgrade for all but the primary arrows
                if b.name <> "lRonanArrow" and b.name <> "lDraxArrow" then
                  SSetLightColor kStack_Pri0, b, modeRampColor, 0
                End if
              Next
            Elseif StackState(kStack_Pri0).GetArrowState(a) = 1 then ' Drax and Ronan start out blinking so they wont clear
              SSetLightColor kStack_Pri0, a, modeRampColor, 0
            End if

            ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
            ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 8) * 100)
            RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8r-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
            BonusAddMode -1, StackState(kStack_Pri0).GetArrowState(a) = 2

            if (ModeProgress(PlayerMode) >= 8) Then
              ModePercent(PlayerMode) = 100
              bModeComplete = True
            End If
          End If
        Next
      End If
        Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      if trigger_name = "lStarLordArrow" Then ' scoop hit - 500K Bonus
        AddScore 500000
        pDMDEvent(kDMD_Upgrade)
        SetLightColor lRocketName, "red", 2
      End If

'     debug.print "KYLN Trigger:" & trigger_name & " 2val:" & PlayerState(CurrentPlayer).lNovaStatesKyln(0) & " " & ModeProgress(PlayerMode)
'     debug.print "KYLN Trigger:" & trigger_name & " 3val:" & PlayerState(CurrentPlayer).lNovaStatesKyln(1)
'     debug.print "KYLN Trigger:" & trigger_name & " 4val:" & PlayerState(CurrentPlayer).lNovaStatesKyln(2)
'     debug.print "KYLN Trigger:" & trigger_name & " 8val:" & PlayerState(CurrentPlayer).lNovaStatesKyln(3)
'     debug.print "KYLN Trigger:" & trigger_name & " 9val:" & PlayerState(CurrentPlayer).lNovaStatesKyln(4)

      if (trigger_name <> "lRocketArrow" and ModeProgress(PlayerMode) = 6) Then
        ' Not Rocket
        exit sub ' Rocket must be the last shot
      elseif (trigger_name = "lRocketArrow" and ModeProgress(PlayerMode) = 6) Then
        bValidHit = True
      Elseif trigger_name = "lRocketArrow" Then ' Spot a shot (If It isnt the last one)
        for i = 0 to 4
          if PlayerState(CurrentPlayer).lNovaStatesKyln(i) = 2 then
            bValidHit = True
            PlayerState(CurrentPlayer).lNovaStatesKyln(i) = 0
            exit for
          End If
        Next
      End If
      if trigger_name = "sw2" and PlayerState(CurrentPlayer).lNovaStatesKyln(0) = 2 then PlayerState(CurrentPlayer).lNovaStatesKyln(0) = 0:bValidHit = True
      if trigger_name = "sw3" and PlayerState(CurrentPlayer).lNovaStatesKyln(1) = 2 then PlayerState(CurrentPlayer).lNovaStatesKyln(1) = 0:bValidHit = True
      if trigger_name = "sw4" and PlayerState(CurrentPlayer).lNovaStatesKyln(2) = 2 then PlayerState(CurrentPlayer).lNovaStatesKyln(2) = 0:bValidHit = True
      if trigger_name = "sw8" and PlayerState(CurrentPlayer).lNovaStatesKyln(3) = 2 then PlayerState(CurrentPlayer).lNovaStatesKyln(3) = 0:bValidHit = True
      if trigger_name = "sw9" and PlayerState(CurrentPlayer).lNovaStatesKyln(4) = 2 then PlayerState(CurrentPlayer).lNovaStatesKyln(4) = 0:bValidHit = True
      if trigger_name = "lgr_a" and StackState(kStack_Pri0).GetArrowState(lgr_a) <> 0 Then bValidHit = True

      SetLightColor lNova_sw2, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(0)
      SetLightColor lNova_sw3, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(1)
      SetLightColor lNova_sw4, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(2)
      SetLightColor lNova_sw8, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(3)
      SetLightColor lNova_sw9, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(4)
      if trigger_name = "lgr_a" then SSetLightColor kStack_Pri0, lgr_a, modeRampColor, 0

      if bValidHit Then

        'PlaySound "gg_RampHit"
        'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds
        PlayProgress trigger_name

        ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
        ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 7) * 100)
        RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress7-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        BonusAddMode -1, bDoubleBonus

        if (ModeProgress(PlayerMode) >= 7) Then
          ModePercent(PlayerMode) = 100
          bModeComplete = True
        End If

      End If

        Case 6: ' Gamora - Sibling Rivalry (8 shots)
      if trigger_name = "lStarLordArrow" and bModeProgressUpgraded=False Then   ' scoop hit - perform upgrade
        AddScore 500000
        pDMDEvent(kDMD_Upgrade)
        PlaySoundVol "gg_lazer", VolDef
        bModeProgressUpgraded = True          '' Upgrade Toggles all Left and All right when lit
        SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 0
        SSetLightColor kStack_Pri0, lBrokerArrow, modeRampColor, 1
        SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 2
        SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor, 1
        SSetLightColor kStack_Pri0, lStarLordArrow, modeRampColor, 1
        bModeProgressUpgraded=True
        SetLightColor lGamoraName, "green", 2
      else
        For each a in aRampLights
          if a.name = trigger_name and StackState(kStack_Pri0).GetArrowState(a) <> 0 Then   ' Hit Ramp that was lit
            'PlaySound "gg_RampHit"
            'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds
            PlayProgress trigger_name
            BonusAddMode -1, StackState(kStack_Pri0).GetArrowState(a) =2

            if (bModeProgressUpgraded) then ' Toggle Left and Right
              if (StackState(kStack_Pri0).GetArrowState(lGamoraArrow) <> 0) then
                SSetLightColor kStack_Pri0, lYonduArrow, modeRampColor, 1
                SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 2
                SSetLightColor kStack_Pri0, lRocketArrow, modeRampColor, 1
                SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor, 1
                SSetLightColor kStack_Pri0, lBrokerArrow, modeRampColor, 0
                SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 0
                SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor, 0
                SSetLightColor kStack_Pri0, lStarLordArrow, modeRampColor, 0
              else
                SSetLightColor kStack_Pri0, lYonduArrow, modeRampColor, 0
                SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 0
                SSetLightColor kStack_Pri0, lRocketArrow, modeRampColor, 0
                SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor, 0
                SSetLightColor kStack_Pri0, lBrokerArrow, modeRampColor, 1
                SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 2
                SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor, 1
                SSetLightColor kStack_Pri0, lStarLordArrow, modeRampColor, 1
              End If
            End If

            ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
            ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 8) * 100)
            RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress8g-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
            if (ModeProgress(PlayerMode) >= 8) Then
              ModePercent(PlayerMode) = 100
              bModeComplete = True
              ModePointsSave=ModePoints ' Save this off the 2nd mode bonus
            End If
          End If
        Next
      End If
        Case 7: ' Broker - Antique Shop (7 shots)
      if trigger_name = "lBrokerArrow" then ' Broker is always lit
        bValidHit = True
      elseif trigger_name = "lNebulaArrow" and StackState(kStack_Pri0).GetArrowState(lNebulaArrow) <> 0 then
        if ModeProgress(PlayerMode) < 3 then
          SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 1
          SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 0
        Else
          SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor, 1
          SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 0
        End If
        bValidHit = True
      elseif trigger_name = "lGamoraArrow" and StackState(kStack_Pri0).GetArrowState(lGamoraArrow) <> 0 then
        SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 0
        SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 1
        bValidHit = True
      elseif trigger_name = "lDraxArrow" and StackState(kStack_Pri0).GetArrowState(lDraxArrow) <> 0 then
        SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor, 0
        SSetLightColor kStack_Pri0, lStarLordArrow, modeRampColor, 1
        bValidHit = True
      elseif trigger_name = "lStarLordArrow" and StackState(kStack_Pri0).GetArrowState(lStarLordArrow) <> 0 then
        SetLightColor lBrokerName, "cyan", 1
        SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor, 1
        bValidHit = True
      ' These are all the switch hits
      elseif trigger_name = "switch" or _
        (trigger_name = "tgHadron0") or (trigger_name = "tgHadron1") or (trigger_name = "tgHadron2") or _
        (trigger_name = "tgHadron3") or (trigger_name = "tgHadron4") then
        BonusAddModeHit(GetBonusIndex("lBrokerArrow")) ' Adds minor score, but more importantly ensures we trigger bonus calculation at the end
        SwitchHitCount = SwitchHitCount - 1
        if (SwitchHitCount <= 0) then
          bValidHit = True
          SwitchHitCount = 20
        End If
        UpdateSwitchHitCnt SwitchHitCount
      End If

      if (bValidHit = True) Then
        'PlaySound "gg_RampHit"
        'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds and reset the timer to reset the lights
        PlayProgress trigger_name
        ModeProgress(PlayerMode) = ModeProgress(PlayerMode)+1
        ModePercent(PlayerMode) = CINT((ModeProgress(PlayerMode)  / 7) * 100)
        RefreshPlayerMode 'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress7t-"&ModeProgress(PlayerMode)&".png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"
        BonusAddMode -1, bDoubleBonus

        if (ModeProgress(PlayerMode) >= 7) Then
          ModePercent(PlayerMode) = 100
          bModeComplete = True
        End If
      End If
    End Select

    ' Check if we are 50% through the current level. Show Immolation Progress
    if PlayerMode <> -1 then
      if ModePercent(PlayerMode) >= 50 and bIModeComplete=False Then              ' Just show this once
        DMD "Immolation", CL(0, "Progress"), "", eNone, eNone, eNone, 2000, False, ""
        'pDMDEvent(kDMD_ImmProgress)

        'DoImmolationI
        QueueScene "DoImmolationI '", 6000, 1
        QueueScene "DoImmolationIClear '", 0, 1

        PlaySoundVol "gg_Immolation50", VolDef
        bIModeComplete=True
      End if
    End If

    if bModeComplete Then
      UpdateSwitchHitCnt 0
      PlaySoundVol "ModeComplete", VolDef
      ModeCountdownTimer.Enabled = False  ' Stop the countdown immediatly
      ShowPlayerModeComplete(-1)      ' Show Mode total
      'Finished the level
      bSecondMode = True
      StopPlayerMode
      'vpmtimer.addtimer 9000, "bSecondMode = True:StopPlayerMode '"  ' Start the second mode and stop this mode after the Mode complete clip finishes
    End If
  End If

  CheckHadron False   ' See if we can use the Hadrons, If so light the light

End Sub

Sub DoXandarComplete
  playmedia "Video-0x0091.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
End Sub
Sub DoXandarClear
  puPlayer.LabelSet pBackglass,"Message", "" ,1,""
  playclear pOverVid
End Sub

Sub DoCBombComplete
  playmedia "Video-0x00B1.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
End Sub
Sub DoCBombClear
  playclear pOverVid
End Sub

Sub DoImmolationI()
  ' Add Overlay to video
  ' ffmpeg -i Video-0x00A1.mp4 -i ImmolationProgress.png -filter_complex "[1:v]scale=1360:768 [ovrl],[0:v][ovrl]overlay=(main_w-overlay_w)/2:(main_h-overlay_h)/2" -strict -2 ./output.mp4
  Dim Text
  dim c0,c1,c2,c3,c4,c5,c6,c7,cOrb,cGroot

  if ModePercent(0)<50 then c0=8618883 else c0=16777215
  if ModePercent(1)<50 then c1=8618883 else c1=16777215
  if ModePercent(2)<50 then c2=8618883 else c2=16777215
  if ModePercent(3)<50 then c3=8618883 else c3=16777215
  if ModePercent(4)<50 then c4=8618883 else c4=16777215
  if ModePercent(5)<50 then c5=8618883 else c5=16777215
  if ModePercent(6)<50 then c6=8618883 else c6=16777215
  if ModePercent(7)<50 then c7=8618883 else c7=16777215
  if Light033.state=0 then cOrb=8618883 else cOrb=16777215
  if Light030.state=0 then cGroot=8618883 else cGroot=16777215

  playmedia "Video-0x00A1b.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
  PuPlayer.LabelShowPage pOverVid, 2,0,""
  puPlayer.LabelSet pOverVid,"P0", "Pod Chase"      ,1,"{'mt':2,'color':"&c0&"}"
  puPlayer.LabelSet pOverVid,"P1", "Sanctuary"      ,1,"{'mt':2,'color':"&c1&"}"
  puPlayer.LabelSet pOverVid,"P2", "Yaka Arrow"     ,1,"{'mt':2,'color':"&c2&"}"
  puPlayer.LabelSet pOverVid,"P3", "Quill's Quest"    ,1,"{'mt':2,'color':"&c3&"}"
  puPlayer.LabelSet pOverVid,"P4", "Knowhere"       ,1,"{'mt':2,'color':"&c4&"}"
  puPlayer.LabelSet pOverVid,"P5", "Escape Kyln"      ,1,"{'mt':2,'color':"&c5&"}"
  puPlayer.LabelSet pOverVid,"P6", "Sibling Rivalry"    ,1,"{'mt':2,'color':"&c6&"}"
  puPlayer.LabelSet pOverVid,"P7", "Antiques Shop"    ,1,"{'mt':2,'color':"&c7&"}"
  puPlayer.LabelSet pOverVid,"PGroot", "Groot Multiball"  ,1,"{'mt':2,'color':"&cGroot&"}"
  puPlayer.LabelSet pOverVid,"POrb", "Orb Multiball"    ,1,"{'mt':2,'color':"&cOrb&"}"

  if (PlayerMode <> -1) then
    Select case PlayerMode
      case 0: Text="Pod Chase"
      case 1: Text="Sanctuary"
      case 2: Text="Yaka Arrow"
      case 3: Text="Quill's Quest"
      case 4: Text="Knowhere"
      case 5: Text="Escape Kyln"
      case 6: Text="Sibling Rivalry"
      case 7: Text="Antiques Shop"
    End Select
    puPlayer.LabelSet pOverVid,"P" & PlayerMode, Text ,1,"{'mt':1,'at':1,'fq':250,'len':6000,'fc':16777215}"
  End If

  'vpmtimer.addtimer 6000, "DoImmolationIClear '"
End Sub
Sub DoImmolationIClear()
  puPlayer.LabelSet pOverVid,"P0", "" ,0,""
  puPlayer.LabelSet pOverVid,"P1", "" ,0,""
  puPlayer.LabelSet pOverVid,"P2", "" ,0,""
  puPlayer.LabelSet pOverVid,"P3", "" ,0,""
  puPlayer.LabelSet pOverVid,"P4", "" ,0,""
  puPlayer.LabelSet pOverVid,"P5", "" ,0,""
  puPlayer.LabelSet pOverVid,"P6", "" ,0,""
  puPlayer.LabelSet pOverVid,"P7", "" ,0,""
  puPlayer.LabelSet pOverVid,"P8", "" ,0,""
  puPlayer.LabelSet pOverVid,"POrb", "" ,0,""
  puPlayer.LabelSet pOverVid,"PGroot", "" ,0,""
  playclear pOverVid
  'PuPlayer.LabelShowPage pBackglass, 1,0,""""
End Sub


Sub QuillsQuestBonus()
  if ModeProgress(3) >= 13 Then
    ' Gather bonus for hitting the scoop before the Progress mode changes
    PlaySoundVol "Boom-4", VolDef
    AddScore Score(CurrentPlayer) * 0.10
  End If
End Sub

Sub WaitPlayerMode()  ' chooses the correct wait video
  Dim VideoName
  if PlayerMode <> -1 then
debug.print "Player Wait Mode"
    if bUsePupDMD then
      PuPlayer.playstop pOverVid
      PuPlayer.SetBackGround pOverVid, 0
      PuPlayer.SetLoop pOverVid, 0
      PuPlayer.playstop pOverVid
    End If
    Select Case PlayerMode
      case -1:' No Mode Selected
      Case 0: ' Nebula - Pod Chase (10 shots)
        VideoName = "Video-0x001D.mp4"
      Case 1: ' Ronan - Sanctuary (5 shots)
        VideoName = "Video-0x005C.mp4"
      Case 2: ' Yandu - Yaka Arrow (8 shots)
        VideoName = "Video-0x003B.mp4"
      Case 3: ' Star Lord - Quills Quest (12 shots)
        VideoName = "Video-0x0029.mp4"
      Case 4: ' Drax - Knowhere (8 shots)
        VideoName = "Video-0x0008.mp4"
      Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
        VideoName = "Video-0x000E.mp4"
      Case 6: ' Gamora - Siblng Rvlry (8 shots)
        VideoName = "Video-0x0015.mp4"
      Case 7: ' Broker - Antique Shop (7 shots)
        VideoName = "Video-0x00AB.mp4"
    End Select

    playmedia VideoName, "PupVideos", pOverVid, "", -1, "", 1, 1
    if bUsePupDMD then PuPlayer.SetLoop pOverVid, 1

  End If
End sub

dim tmrFinishModeBlinkCnt
dim tmrFinishModeIndex
Sub tmrFinishMode_Timer()
  dim x,y
  dim rot
  Dim Xrad
  Dim yRad
  Dim xOffset
  Dim yOffset
  Dim Index
  Dim startAngle
  Dim EndAngle
  Dim step
  rot=-0.6
  step=7  '0.09
  xRad=48:yRad=15   ' Circle 2

  Index=tmrFinishModeIndex
  Select case Index
    case 0:       ' Gamora
      xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 35
      startAngle = 240
      EndAngle = -125
    case 1:       ' Ronan
      xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 31
      startAngle = 200
      EndAngle = -230
    case 2:       ' Yandu
      xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 31
      startAngle = 170  ' Decrease=CounterClockwise
      EndAngle = -252   ' Increase=Clockwise
    case 3:       ' Star Lord
      xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 35
      startAngle = 170  ' Decrease=CounterClockwise
      EndAngle = -286   ' Increase=Clockwise
    case 4:       ' Drax
    xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 33
      startAngle = 140  ' Decrease=CounterClockwise
      EndAngle = -310   ' Increase=Clockwise
    case 5:       ' Rocket
      xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 38
      startAngle = 50 ' Decrease=CounterClockwise
      EndAngle = -400   ' Increase=Clockwise
    case 6:       ' Gamora
      xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 38
      startAngle = 20 ' Decrease=CounterClockwise
      EndAngle = -425   ' Increase=Clockwise
    case 7:       ' Broker
      xRad=48:yRad=15   ' Circle 2
      xOffset = 42
      yOffset = 38
      startAngle = -40  ' Decrease=CounterClockwise
      EndAngle = -460   ' Increase=Clockwise
    case 8:       ' Orb
      xRad=48:yRad=23   ' Circle 2
      xOffset = 42
      yOffset = 38
      startAngle = -40  ' Decrease=CounterClockwise
      EndAngle = -440   ' Increase=Clockwise
    case 9:       ' Groot
      xRad=48:yRad=23   ' Circle 2
      xOffset = 42
      yOffset = 38
      startAngle = 150
      EndAngle = -260
  End Select

  ' Convert degrees to radians
  startAngle = startAngle*3.1415926/180
  endAngle = EndAngle*3.1415926/180
  step=step*3.1415926/180
  if tmrFinishMode.UserValue=-1 then
    tmrFinishMode.UserValue = startAngle
  End If

  ' Ellipse formula Width=xRad, Height=yRad, Rotation=rot, tmrFinishMode.UserValue=Degrees in Radians, x/yOffset offset from 0
'debug.print "Val: " & tmrFinishMode.UserValue & " " & (tmrFinishMode.UserValue*180/3.1415926) & " " & step
  x = xOffset+ xRad * cos(tmrFinishMode.UserValue) * cos(rot) - yRad*sin(tmrFinishMode.UserValue)*sin(rot)
  y = yOffset+ xRad * cos(tmrFinishMode.UserValue) * sin(rot) + yRad*sin(tmrFinishMode.UserValue)*cos(rot)
'debug.print EndAngle
  if tmrFinishMode.UserValue > EndAngle then
    tmrFinishModeBlinkCnt=0
    PuPlayer.LabelSet pOverVid, "F"&Index, "PuPOverlays\\CompleteLevel-"&Index&"s.png",1,"{'mt':2,'color':111111,'width':14, 'height':22,'yalign':0,'ypos':" & y & ",'xpos':" & x & "}"
    tmrFinishMode.UserValue=tmrFinishMode.UserValue-step
  Else
'debug.print "BLINK"
    tmrFinishModeBlinkCnt=tmrFinishModeBlinkCnt+1
    tmrFinishMode.Interval = 100
    ' Blink
    if tmrFinishModeBlinkCnt mod 2=0 then
      PuPlayer.LabelSet pOverVid, "F"&Index, "PuPOverlays\\CompleteLevel-"&Index&".png",1,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
    Else
      PuPlayer.LabelSet pOverVid, "F"&Index, "PuPOverlays\\CompleteLevel-"&Index&".png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
    End If
    if tmrFinishModeBlinkCnt > 8 then
      tmrFinishMode.Enabled = False
      PuPlayer.LabelSet pOverVid, "F"&Index, "PuPOverlays\\CompleteLevel-"&Index&".png",1,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
    End If
  end If
End Sub

Sub SceneFinishMode(Mode)
  dim i
  Dim visible
  if Mode = -1 then exit sub ' Just in case
  ' Ovberlay the final onto a video for background
  ' ffmpeg -i Video-0x00A1.mp4 -i CompleteLevel-C.png -filter_complex "[1:v]scale=1360:768 [ovrl],[0:v][ovrl]overlay=(main_w-overlay_w)/2:(main_h-overlay_h)/2" -strict -2 FinishMode.mp4
  playmedia "FinishMode.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1

  PuPlayer.LabelShowPage pOverVid, 3,0,""
    'PuPlayer.LabelSet pOverVid, "F0", "" ,1,"{'mt':1,'at':1,'fq':250,'len':6000}"

  For i = 0 to 9
    if i = 8 then
      if Light033.state = 0 then visible = 0 else visible =1
    elseif i = 9 then
      if Light030.state = 0 then visible = 0 else visible =1
    else
      if ModePercent(i) >= 100 then
        visible = 1
      else
        visible = 0
      End If
    End If
    PuPlayer.LabelSet pOverVid, "F" & i, "PuPOverlays\\CompleteLevel-"&i&".png", visible,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  Next
  PlaySoundVol "gg_FinishMode", VolDef
  tmrFinishMode.UserValue=-1
  tmrFinishModeIndex=Mode
  tmrFinishMode.Interval = 50
  tmrFinishMode.enabled = true

' puPlayer.LabelSet pOverVid,"OverMessage1", "TEST" ,1,""
' puPlayer.LabelSet pOverVid,"OverMessage2", Message2 ,1,""
' puPlayer.LabelSet pOverVid,"OverMessage3", Message3 ,1,""
End Sub

Sub SceneClearFinishMode()
  tmrFinishMode.enabled = False
debug.print "Scene Clear"
  PuPlayer.LabelSet pOverVid, "F0", "PuPOverlays\\CompleteLevel-0.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F1", "PuPOverlays\\CompleteLevel-1.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F2", "PuPOverlays\\CompleteLevel-2.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F3", "PuPOverlays\\CompleteLevel-3.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F4", "PuPOverlays\\CompleteLevel-4.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F5", "PuPOverlays\\CompleteLevel-5.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F6", "PuPOverlays\\CompleteLevel-6.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F7", "PuPOverlays\\CompleteLevel-7.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F8", "PuPOverlays\\CompleteLevel-8.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"
  PuPlayer.LabelSet pOverVid, "F9", "PuPOverlays\\CompleteLevel-9.png",0,"{'mt':2,'color':111111,'width':100, 'height':100,'yalign':0,'ypos':0,'xpos':0}"

  PuPlayer.LabelShowPage pOverVid, 1,0,""
    playclear pOverVid
End Sub

Sub ScenePlayMessage(Media, Message1, Message2, Message3)
  playmedia Media, "PupVideos", pOverVid, "", -1, "", 1, 1
  PuPlayer.LabelShowPage pOverVid, 1,0,""
  puPlayer.LabelSet pOverVid,"OverMessage1", Message1 ,1,""
  puPlayer.LabelSet pOverVid,"OverMessage2", Message2 ,1,""
  puPlayer.LabelSet pOverVid,"OverMessage3", Message3 ,1,""
  'vpmtimer.addtimer 3000, "SceneClearPlayerModeComplete '"
End Sub

Sub SceneClearPlayMessage()
  PuPlayer.LabelSet pOverVid,"OverMessage1","",0,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","",0,""
  PuPlayer.LabelSet pOverVid,"OverMessage3","",0,""
  playclear pOverVid
End Sub

Sub ShowPlayerModeComplete(ExtraMode) ' Show the total for the player mode (ExtraMode: 0=GrootMB, 1=OrbMB, 2=WizardModes, -1=DefaultMode)
  dim ModeStr
  Dim MediaStr
  Dim ScoreVal
  Dim SecondStr
  dim thisMode
  ModeStr=""
  MediaStr=""

  if ExtraMode = 0 Then       ' GrootMB
    ModeStr = "Groot Multiball"
    MediaStr= "Video-0x008E.mp4"
    'playmedia "Video-0x008E.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
    ScoreVal = GrootMBJackpot
  elseif ExtraMode = 1 Then       ' OrbMB
    ModeStr = "Orb Multiball"
    MediaStr= "Video-0x004B.mp4"
    'playmedia "Video-0x004B.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
    ScoreVal = OrbMBJackpot
  elseif ExtraMode= 2 then
    ScoreVal=WizardModePoints
    if tmrXandar.Enabled then
      ModeStr = "Save Xandar"
      MediaStr= "Video-0x004B.mp4"
      'playmedia "Video-0x004B.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
    elseif tmrImmolation.Enabled then
      ModeStr = "Immolation Initiative"
      MediaStr= "Video-0x005A.mp4"
      'playmedia "Video-0x005A.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
    elseif tmrCherryBomb.Enabled then
      ModeStr = "Cherry Bomb"
      MediaStr="Video-0x0092.mp4"
      'playmedia "Video-0x0088.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
    End If
  else
    thisMode = PlayerMode
    if bSecondMode then SecondStr = " 2":thisMode=PlayerMode2     ' Handle 2nd Mode
    'playclear pBackglass
    ScoreVal=ModePoints
    Select Case thisMode
      case -1:' No Mode Selected
      Case 0: ' Nebula - Pod Chase (10 shots)
        'playmedia "Video-0x004B.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x004B.mp4"
        ModeStr ="Pod Chase" & SecondStr
      Case 1: ' Ronan - Sanctuary (5 shots)
        'playmedia "Video-0x0088.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x0088.mp4"
        ModeStr ="Sanctuary" & SecondStr
      Case 2: ' Yandu - Yaka Arrow (8 shots)
        'playmedia "Video-0x005A.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x005A.mp4"
        ModeStr ="Yaka Arrow" & SecondStr
      Case 3: ' Star Lord - Quills Quest (12 shots)
        'playmedia "Video-0x0060.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x0060.mp4"
        ModeStr ="Quills Quest" & SecondStr
      Case 4: ' Drax - Knowhere (8 shots)
        'playmedia "Video-0x0092.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x0092.mp4"
        ModeStr ="Knowhere" & SecondStr
      Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
        'playmedia "Video-0x0065.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x0065.mp4"
        ModeStr ="Escape Kyln" & SecondStr
      Case 6: ' Gamora - Siblng Rvlry (8 shots)
        'playmedia "Video-0x008E.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x008E.mp4"
        ModeStr ="Sibling Rivalry" & SecondStr
      Case 7: ' Broker - Antique Shop (7 shots)
        'playmedia "Video-0x000B.mp4", "PupVideos", pOverVid, "", 3000, "", 1, 1
        MediaStr="Video-0x000B.mp4"
        ModeStr ="Antique Shop" & SecondStr
    End Select
  End If

  if ModeStr <> "" then
    ' Queue up PlayerModeComplete scene
    QueueScene "ScenePlayMessage """&MediaStr&""", """&ModeStr&""","""&FormatScore(ScoreVal)&""",""TOTAL"" '", 3000, 1
    QueueScene "SceneClearPlayMessage '", 0, 1

    if ExtraMode = -1 then
      If PlayerMode <> -1 and bSecondMode=False then  ' PlayerMode2 doesnt do the around the world finish
        if ModePercent(PlayerMode) >= 100 then
          QueueScene "SceneFinishMode " & PlayerMode & " '", 6000, 1
          QueueScene "SceneClearFinishMode '", 0, 1
        End If
      End If
    elseif ExtraMode = 0 and Light030.state = 1 then    ' We completed it
      QueueScene "SceneFinishMode 9 '", 6000, 1
      QueueScene "SceneClearFinishMode '", 0, 1
    elseif ExtraMode = 1 and Light033.state = 1 then    ' We completed it
      QueueScene "SceneFinishMode 8 '", 6000, 1
      QueueScene "SceneClearFinishMode '", 0, 1
    End if
  End If
End sub


Sub StartPlayerModeVideo(bSkipInitial)  ' Play the GamePlay Video - SkipInitial skips the scene where we show the splash for this mode
  Dim overVideo
  Dim bgVideo
  dim newVolume
  newVolume=1
debug.print "Start Player Mode video " & bSecondMode & " " & PlayerMode
  'StopSound "m_wait"
  playclear pAudio

  if bXandarReady then
    StopPlayerModeVideo
  End If

  if tmrXandar.Enabled or tmrImmolation.Enabled or tmrCherryBomb.Enabled then  ' Wizard Mode
    playclear pBackglass
    if tmrXandar.Enabled then
      playmedia "Video-0x0034.mp4", "PupVideos", pBackglass, "", 4200, "Video-0x0059.mp4", 1, 1
      playmedia "Song-2.mp3", MusicDir, pMusic, "", -1, "", 1, 1
    elseif tmrImmolation.Enabled then
      playmedia "Video-0x0064.mp4", "PupVideos", pBackglass, "", -1, "", 1, 1
      playmedia "Song-11.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      PlaySoundVol "say-immolation0x06E5", VolDef
    elseif tmrCherryBomb.Enabled then
      playmedia "Video-0x0026.mp4", "PupVideos", pBackglass, "", 4200, "Video-0x0028.mp4", 1, 1
      playmedia "Song-1.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      'playmedia "default.mp4", "BGDefault", pBackglass, "", 4200, "Video-0x0059.mp4", 1, 1
    End If
  'vpmTimer.AddTimer 1000, "playclear pAudio '"   ' Some reason this can be too fast so kick of another one a second later
  elseif bSecondMode = False then
    playclear pBackglass
    Select Case PlayerMode
      case -1:' No Mode Selected
'       if bXandarReady then
'         StopPlayerModeVideo
'       End If
'
'       if tmrXandar.Enabled then
'         playmedia "Video-0x0034.mp4", "PupVideos", pBackglass, "", 4200, "Video-0x0059.mp4", 1, 1
'         playmedia "Song-2.mp3", MusicDir, pMusic, "", -1, "", 1, 1
'       elseif tmrImmolation.Enabled then
'         playmedia "Video-0x0064.mp4", "PupVideos", pBackglass, "", -1, "", 1, 1
'         playmedia "Song-11.mp3", MusicDir, pMusic, "", -1, "", 1, 1
'         PlaySoundVol "say-immolation0x06E5", VolDef
'       elseif tmrCherryBomb.Enabled then
'         playmedia "Video-0x0026.mp4", "PupVideos", pBackglass, "", 4200, "Video-0x0028.mp4", 1, 1
'         playmedia "Song-1.mp3", MusicDir, pMusic, "", -1, "", 1, 1
'         'playmedia "default.mp4", "BGDefault", pBackglass, "", 4200, "Video-0x0059.mp4", 1, 1
'       End If
      Case 0: ' Nebula - Pod Chase (10 shots)
        if bSkipInitial = False then
          playmedia "Video-0x00AD.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x0047.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 150, 1
        playmedia "Song-10.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      Case 1: ' Ronan - Sanctuary (5 shots)
        if bSkipInitial=False then
          playmedia "Video-0x0054.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x0079.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 150, 1
        playmedia "Song-12.mp3", MusicDir, pMusic, "", -1, "", 1, 1                     ' Needs to be aligned with the video
      Case 2: ' Yandu - Yaka Arrow (8 shots)
        if bSkipInitial = False then
          playmedia "Video-0x0002.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x0090.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 180, 1
        playmedia "Song-7.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      Case 3: ' Star Lord - Quills Quest (12 shots)
        if bSkipInitial = False then
          playmedia "Video-0x0080.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x00A0.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 150, 1
        playmedia "Song-9.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      Case 4: ' Drax - Knowhere (8 shots)
        if bSkipInitial = False then
          playmedia "Video-0x0020.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x009D.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 150, 1
        playmedia "Song-8.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
        if bSkipInitial = False then
          playmedia "Video-0x0016.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x0096.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 150, 1
        playmedia "Song-5.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      Case 6: ' Gamora - Siblng Rvlry (8 shots)
        if bSkipInitial = False then
          playmedia "Video-0x005B.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x0081.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 150, 1
        playmedia "Song-6.mp3", MusicDir, pMusic, "", -1, "", 1, 1
      Case 7: ' Broker - Antique Shop (7 shots)
        if bSkipInitial = False then
          playmedia "Video-0x001B.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
        End If
        playmedia "Video-0x0007.mp4", "PupVideos", pBackglass, "", -1, "", VolBGMusic * 180, 1
        playmedia "Song-13.mp3", MusicDir, pMusic, "", -1, "", 1, 1
    End Select

  Elseif PlayerMode2 <> -1 then
    playclear pBackglass
    Select Case PlayerMode2
      case -1:' No Mode Selected
      Case 0: ' Nebula - Pod Chase (10 shots)
        overVideo = "Video-0x0043.mp4"
        bgVideo = "Video-0x0069.mp4"
        'playmedia "Video-0x0043.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x0069.mp4", 1, 1
      Case 1: ' Ronan - Sanctuary (5 shots)
        overVideo = "Video-0x0045.mp4"
        bgVideo = "Video-0x003C.mp4"
        newVolume=VolBGMusic * 150
        'playmedia "Video-0x0045.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x003C.mp4", 150, 1
      Case 2: ' Yandu - Yaka Arrow (8 shots)
        overVideo = "Video-0x00AA.mp4"
        bgVideo = "Video-0x0001.mp4"
        'playmedia "Video-0x00AA.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x0001.mp4", 1, 1
      Case 3: ' Star Lord - Quills Quest (12 shots)
        overVideo = "Video-0x006B.mp4"
        bgVideo = "Video-0x00B8.mp4"
        'playmedia "Video-0x006B.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x00B8.mp4", 1, 1
      Case 4: ' Drax - Knowhere (8 shots)
        overVideo = "Video-0x00A6.mp4"
        bgVideo = "Video-0x007B.mp4"
        'playmedia "Video-0x00A6.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x007B.mp4", 1, 1
      Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
        overVideo = "Video-0x003A.mp4"
        bgVideo = "Video-0x0049.mp4"
        'playmedia "Video-0x003A.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x0049.mp4", 1, 1
      Case 6: ' Gamora - Siblng Rvlry (8 shots)
        overVideo = "Video-0x00B2.mp4"
        bgVideo = "Video-0x0098.mp4"
        'playmedia "Video-0x00B2.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x0098.mp4", 1, 1
      Case 7: ' Broker - Antique Shop (7 shots)
        overVideo = "Video-0x0005.mp4"
        bgVideo = "Video-0x0067.mp4"
        newVolume=VolBGMusic * 150
        'playmedia "Video-0x0005.mp4", "PupVideos", pBackglass, "", 3540, "Video-0x0067.mp4", 150, 1
    End Select
    newVolume=VolBGMusic * 150
    if PlayerMode2 <> -1 then ' Just make sure
      QueueScene "playmedia """&overVideo&""", ""PupVideos"", pOverVid , """", -1, """", 1, 1 '", 3540, 1
      playmedia bgVideo, "PupVideos", pBackglass, "", -1, "", newVolume , 1
    End if
  End If

End sub

Sub StopPlayerModeVideo() ' chooses the wait video
  if bWizardMode then exit sub
  if bGameInPlay = false then exit sub
Debug.print "Stop PlayerMode Video. (Mix Music/video)"

  playclear pBackglass
  playclear pMusic

  if bSkipWaitVideo = False then
    playmedia "Video-0x000F.mp4", "PupVideos", pBackglass, "", -1, "", 1, 1
debug.print "Start  m_wait-3"
    'PlaySoundLoopVol "m_wait", VolMusic
    playmedia "m_wait2.mp3", MusicDir, pAudio, "", -1, "", 1, 1
  End If

End sub

' This is called when they hit the plunger and when they press start after ball is in the scoop
Sub StartPlayerMode()
debug.print "StartPlayerMode " & PlayerMode
  pDMDSetPage(pScores)
  setUpgradeLight(True)
  setModeSelectLight(False)
' flshUpgrade.TimerEnabled = True
' flshModeSelect.TimerEnabled = False
  bIModeComplete=False
  bSecondMode = False

  dim time
  time = 1000
  sndGeneralHit = ""
  'StopSound "m_wait"
  playclear pAudio
  ModePoints = 0
  bModeProgressUpgraded = False

  bPlayerModeSelect = False
  pBGGamePlay

  bPlayPaused = False   ' Force song to change

  HadronFlash "", False

  if bSkillshotsReady(2) = False Then ' Close the gate before the mode start unless we are doing a skill shot
    LoopGateLeft.Open = False
  End If
  Gate002.Open = False

  if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Message",  ""  ,1,""   ' Clear the select your mission

  if (PlayerMode <> -1) then          ' Add this to the stack
    StackState(kStack_Pri0).Enable(PlayerMode)
  End If

  Select Case PlayerMode
    case -1:' No Mode Selected
    Case 0: ' Nebula - Pod Chase (10 shots)
      DMD "Start Mode", CL(0, "Pod Chase"), "", eNone, eNone, eNone, time, False, ""

      SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 1
      SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 1
        Case 1: ' Ronan - Sanctuary (5 shots)
      DMD "Start Mode", CL(0, "Sanctuary"), "", eNone, eNone, eNone, time, False, ""

      LoopGateLeft.Open = True    ' Gates are open for a full orbit shots
      Gate002.Open = True
      tgHadron0.UserValue = 0
      tgHadron1.UserValue = 0
      tgHadron2.UserValue = 0
      tgHadron3.UserValue = 0
      tgHadron4.UserValue = 0
      SSetLightColor kStack_Pri0, lRonanArrow, "yellow", 2

        Case 2: ' Yandu - Yaka Arrow (8 shots)
      DMD "Start Mode", CL(0, "Yaka Arrow"), "", eNone, eNone, eNone, time, False, ""
      YakaPops = 4
      UpdateHitCntMsg "Pops Remaining: ", YakaPops
      bQualifyYando=False
      SSetLightColor kStack_Pri0, lYonduArrow, modeRampColor, 1
      SSetLightColor kStack_Pri0, lgr_a, modeRampColor, 1
        Case 3: ' Star Lord - Quills Quest (12 shots)
      BallSaverTime = 30

      SSetLightColor kStack_Pri0, lStarLordArrow, "yellow", 2
      SSetLightColor kStack_Pri0, lRonanArrow, "yellow", 1
      SSetLightColor kStack_Pri0, lRocketArrow, "yellow", 1

      ' Start HurryUp
      tmrHurryUp.UserValue=2000000
      vpmtimer.addtimer 1500, "HurryUpStart '"
      HurryUpCount=0
      ' Start timers to switch Arrows
      tmrQuestRamps.Interval = 1000 * INT(RND * 6 + 7)    ' Range 7-12 = (12-7+1) * Rnd + 7
      tmrQuestRamps.Enabled = True
      if bQuillsQuestFirstTime = False Then         ' You only get multiball on the first play
        AddMultiball 1   ' Automatic multiball on start
        EnableOrb(False)
        'OrbTarget1Disabled.Collidable = True ' Disable OrbMB on Quill MB
      End If
      DMD "Start Mode", CL(0, "Quills Quest"), "", eNone, eNone, eNone, time, False, ""

        Case 4: ' Drax - Knowhere (8 shots)
      DMD "Start Mode", CL(0, "Knowhere"), "", eNone, eNone, eNone, time, False, ""

      SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor, 2
      SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor, 2
      SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 1
      SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 1
        Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      LoopGateLeft.Open = False   ' Gates are closed for bumper shots
      Gate002.Open = False
      DMD "Start Mode", CL(0, "Escape Kyln"), "", eNone, eNone, eNone, time, False, ""

      SSetLightColor kStack_Pri0, lRocketArrow, modeRampColor, 1
      SSetLightColor kStack_Pri0, lgr_a, modeRampColor, 1

      SetLightColor lNova_sw2, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(0)
      SetLightColor lNova_sw3, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(1)
      SetLightColor lNova_sw4, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(2)
      SetLightColor lNova_sw8, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(3)
      SetLightColor lNova_sw9, modeRampColor, PlayerState(CurrentPlayer).lNovaStatesKyln(4)
        Case 6: ' Gamora - Siblng Rvlry (8 shots)
      DMD "Start Mode", CL(0, "Sibling Rivalry"), "", eNone, eNone, eNone, time, False, ""
      sndGeneralHit = "gg_lazer"
      SetLightColor lGamoraName, "green", 2
      SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 2
      SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 2

        Case 7: ' Broker - Antique Shop (7 shots)
      SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor, 1
      SSetLightColor kStack_Pri0, lBrokerArrow, modeRampColor, 2

      SwitchHitCount = 20
      UpdateSwitchHitCnt SwitchHitCount
      DMD "Start Mode", CL(0, "Antiquites Shop"), "", eNone, eNone, eNone, time, False, ""
  End Select

  StartPlayerModeVideo False

  ' If this mode are already past 50% then dont show Immolation Screen
  if PlayerMode <> -1 then
    if ModePercent(playerMode) >= 50 Then bIModeComplete=True

    ModeCountdownTimer.UserValue = ModeCountdown
    ModeCountdownTimer.Enabled = True
  End If

  SetModeLights()
End Sub

Function bIsModeComplete(Index)
  If Index >=0 and Index <=7 then
    bIsModeComplete = ModePercent(Index) >= 100
  else
    bIsModeComplete = False
  End if
End Function

Function GetModeIndex(lightArrowName)
  GetModeIndex = -1
  Select Case lightArrowName
    Case "lNebulaArrow": ' Nebula - Pod Chase (10 shots)
      GetModeIndex = 0
        Case "lRonanArrow":  ' Ronan - Sanctuary (5 shots)
      GetModeIndex = 1
        Case "lYonduArrow":  ' Yandu - Yaka Arrow (8 shots)
      GetModeIndex = 2
        Case "lStarLordArrow": ' Star Lord - Quills Quest (12 shots)
      GetModeIndex = 3
        Case "lDraxArrow":   ' Drax - Knowhere (8 shots)
      GetModeIndex = 4
        Case "lRocketArrow": ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      GetModeIndex = 5
        Case "lGamoraArrow": ' Gamora - Siblng Rvlry (8 shots)
      GetModeIndex = 6
        Case "lBrokerArrow": ' Broker - Antique Shop (7 shots)
      GetModeIndex = 7
    case "lgr_a":
      GetModeIndex = 8 ' Groot Arrow (not really used)
  End Select
end Function

Function GetBonusIndex(lightArrowName)
  GetBonusIndex = -1
  Select Case lightArrowName
    Case "lNebulaArrow": ' Nebula - Pod Chase (10 shots)
      GetBonusIndex = 3
        Case "lRonanArrow":  ' Ronan - Sanctuary (5 shots)
      GetBonusIndex = 1
        Case "lYonduArrow":  ' Yandu - Yaka Arrow (8 shots)
      GetBonusIndex = 0
        Case "lStarLordArrow": ' Star Lord - Quills Quest (12 shots)
      GetBonusIndex = 8
        Case "lDraxArrow":   ' Drax - Knowhere (8 shots)
      GetBonusIndex = 7
        Case "lRocketArrow": ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      GetBonusIndex = 2
        Case "lGamoraArrow": ' Gamora - Siblng Rvlry (8 shots)
      GetBonusIndex = 6
        Case "lBrokerArrow": ' Broker - Antique Shop (7 shots)
      GetBonusIndex = 5
    case "lgr_a":
      GetBonusIndex = 4 ' Groot Arrow (not really used)
  End Select
end Function

Function Bonus2ModeIndex(BonusIndex)
  Bonus2ModeIndex = -1
  Select Case BonusIndex
    Case 3: ' Nebula - Pod Chase (10 shots)
      Bonus2ModeIndex = 0
        Case 1:  ' Ronan - Sanctuary (5 shots)
      Bonus2ModeIndex = 1
        Case 0:  ' Yandu - Yaka Arrow (8 shots)
      Bonus2ModeIndex = 2
        Case 8: ' Star Lord - Quills Quest (12 shots)
      Bonus2ModeIndex = 3
        Case 7:    ' Drax - Knowhere (8 shots)
      Bonus2ModeIndex = 4
        Case 2: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      Bonus2ModeIndex = 5
        Case 6: ' Gamora - Siblng Rvlry (8 shots)
      Bonus2ModeIndex = 6
        Case 5: ' Broker - Antique Shop (7 shots)
      Bonus2ModeIndex = 7
    case 4:
      Bonus2ModeIndex = -1 ' Groot Arrow (not really used)
  End Select
debug.print "BonusIndex: " & BonusIndex & " ret:" & Bonus2ModeIndex
end Function

Sub EndImmolation(mode)   ' 1 - Down to 1 Ball, 0 - All Balls Drained
  dim a,i

  if bImmolationWait and mode = 0 then        ' Throw a ball back on the field  (I dont think you can get here)
    bAutoPlunger = True
    bBallSaverReady = True      ' Need to enable ball saver for the next ball
    CreateNewBall()
  end If

  if tmrImmolation.Enabled and (Light029.state = 1 or mode = 0) then  ' Either we finished or we draned everything
debug.print "End Immolation"
    StackState(kStack_Pri2).Disable
    setUpgradeLight(False)
    setModeSelectLight(True)
'   flshUpgrade.TimerEnabled = False
'   flshModeSelect.TimerEnabled = True

    For each a in aRampLights       ' Turn off all the ramp lights to reset the mode
      SetLightColorRestore a, -1
      'SetLightColor a, "white", 0
    Next

    if Light029.state = 1 then      ' We Complete it (TBD: Should this be a competition mode thing?)
      bImmolationDone=True
      ShowPlayerModeComplete(2)   ' Show Immolation Mode total
      bImmolationWait=True
      if mode = 0 then        ' Throw a ball back on the field  (I dont think you can get here)
        bAutoPlunger = True
        bBallSaverReady = True      ' Need to enable ball saver for the next ball
        CreateNewBall()
      end If
    Elseif mode =0 then         ' We didnt finish and they drained all the balls - Set it back up
      bImmolationReady = True
      SetLightColor lStarLordArrow, "white", 0
      SetLightColor Light029, "white", 2
      PlaySoundVol "Bells", VolDef
      PlayScoopLightSeq
    End If
    bWizardMode = False
    StopPlayerModeVideo
    CheckWizardModesReady
    tmrImmolation.Enabled = False
  end if
End Sub

Sub EndXandar()
  dim a
  if tmrXandar.Enabled Then
    bWizardMode = False
    StopPlayerModeVideo
    'pBGPlayVideoDone           ' Stop the video
    PlaySound "YourTimeIsUp"
    setUpgradeLight(False)
    setModeSelectLight(True)
'   flshUpgrade.TimerEnabled = False
'   flshModeSelect.TimerEnabled = True
    OrbTarget1.IsDropped = False
    EnableOrb(True)

    For each a in aRampLights       ' Turn off all the ramp lights to reset the mode
      SSetLightColor kStack_Pri2, a, "white", 0
    Next
    StackState(kStack_Pri2).Disable

    bXandarDone=True
    tmrXandar.Enabled = False
  end if
End Sub

sub EndCherryBomb()
  if tmrCherryBomb.Enabled Then
debug.print "End CherryBomb"
    ModeCountdownTimer.enabled = False    ' Pause the timer
    tmrCherryBomb.UserValue = -1
    puPlayer.LabelSet pBackglass,"Timer", ""  ,1,""

    ShowPlayerModeComplete(2)
    setUpgradeLight(False)
    setModeSelectLight(True)
'   flshUpgrade.TimerEnabled = False
'   flshModeSelect.TimerEnabled = True

    OrbTarget1.IsDropped = False      ' Re-Enable ORB
    EnableOrb(True)
' CAN'T BE IN ORB during Cherry Bomb
'   if (bOrbMultiBall) then         ' Reset Orb MB if we are in it, because CB forces all balls to drain, cant do GrootMB so no need to check that
'     bMultiBallMode = False
'     StopOrbMultiball
'   end if

    bCherryBombDone = True      ' Not sure if you can only do it once or not
    BallSaverTime = defBallSaverTime' Put it back to the original
    BallSaverTimerCancel      ' Stop BallSaver
    bWizardMode=False:StopPlayerModeVideo:bWizardMode=True        ' Must be done before bGameInPlay is set (Force it with boolean)
    bGameInPlayHidden = True
    Table1_KeyUp(LeftFlipperKey)  ' Force Flippers Down
    Table1_KeyUp(RightFlipperKey)
    bGameInPlay = False
    SolLFlipper 0         ' ensure that the flippers are down
    SolRFlipper 0

    mBalls2Eject = 0        ' Kill all the queued up multiballs
    CreateMultiballTimer.Enabled = False
    BallSaverActiveBuffer = 0

    'TBD: Play Red light screen like End Of Game
    'TBD: Flash Light Up and Down
    'TBD: Show Red background screen with Cherry Bomb Totals Summary

    ' whichever is more queue time or 8 seconds
    dim queueTime
    queueTime = getQueueTime          ' See if we need to let animations finish playing
    if queueTime < 8000 then queueTime = 8000
    vpmtimer.addtimer queueTime, "CherryBombDrained'"   ' Let all the balls drain and then put bGameInPlay back and start a ball
  end if
End Sub



Sub StopPlayerMode()
debug.print "StopPlayerMode " & PlayerMode
  bIModeComplete=False
  ModeCountdownTimer.Enabled = False
  setUpgradeLight(False)
  setModeSelectLight(True)
' flshUpgrade.TimerEnabled = False
' flshModeSelect.TimerEnabled = True
  sndGeneralHit = ""

  if bUsePUPDMD then
    ' Turn off mode progress
    puPlayer.LabelSet pBackglass, "ModeProgress", "",0,""
    ' Clear this in case they finished the mode
    puPlayer.LabelSet pBackglass,"HighScore1", "" ,1,""
    puPlayer.LabelSet pBackglass,"HighScore2", "" ,1,""
    puPlayer.LabelSet pBackglass,"HighScore3", "" ,1,""
  End if

  dim a
  For each a in aRampLights       ' Turn off all the ramp lights to reset the mode
    SSetLightColor kStack_Pri0, a, "white", 0
  Next

  For each a in aNameLights       ' Turn off all the Name lights to reset the mode
    a.state = 0
  Next

  Select Case PlayerMode
    case -1:' No Mode Selected
'     if tmrCherryBomb.Enabled Then
'
'       tmrCherryBomb.UserValue = -1
'       puPlayer.LabelSet pBackglass,"Timer", ""  ,1,""
'
'       ShowPlayerModeComplete(2)
'       flshUpgrade.TimerEnabled = False
'       flshModeSelect.TimerEnabled = True
'
'       bCherryBombDone = True      ' Not sure if you can only do it once or not
'       BallSaverTime = defBallSaverTime' Put it back to the original
'       BallSaverTimerCancel      ' Stop BallSaver
'       StopPlayerModeVideo       ' Must be done before bGameInPlay is set
'       bGameInPlay = False
'       SolLFlipper 0         ' ensure that the flippers are down
'       SolRFlipper 0
'
'       mBalls2Eject = 0        ' Kill all the queued up multiballs
'       CreateMultiballTimer.Enabled = False
'       BallSaverActiveBuffer = 0
'
'       'TBD: Play Red light screen like End Of Game
'       'TBD: Flash Light Up and Down
'       'TBD: Show Red background screen with Cherry Bomb Totals Summary
'       vpmtimer.addtimer 8000, "CherryBombDrained'"   ' Let all the balls drain and then put bGameInPlay back and start a ball
'     end if
    Case 0: ' Nebula - Pod Chase (10 shots)
        Case 1: ' Ronan - Sanctuary (5 shots)
      If ModePercent(PlayerMode) < 100 Then ' We didnt complete the mode timer expired, start over
        ModeProgress(PlayerMode) = 0
        ModePercent(PlayerMode) = 0
      End If
        Case 2: ' Yandu - Yaka Arrow (8 shots)
        Case 3: ' Star Lord - Quills Quest (12 shots)
      ' Start timers to switch Arrows
      HurryUpFinish
      tmrQuestRamps.Enabled = False
      BallSaverTime = defBallSaverTime
      bQuillsQuestFirstTime=True
      EnableOrb(True)
      'OrbTarget1Disabled.Collidable = False  ' Enable OrbMB

        Case 4: ' Rocket - Knowhere (8 shots)
      SSetLightColor kStack_Pri0, lRocketArrow, "orange", 0
      SSetLightColor kStack_Pri0, lgr_a, "orange", 0
        Case 5: ' DRAX - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      SetLightColor lNova_sw2, modeRampColor, PlayerState(CurrentPlayer).lNovaStates(0)
      SetLightColor lNova_sw3, modeRampColor, PlayerState(CurrentPlayer).lNovaStates(1)
      SetLightColor lNova_sw4, modeRampColor, PlayerState(CurrentPlayer).lNovaStates(2)
      SetLightColor lNova_sw8, modeRampColor, PlayerState(CurrentPlayer).lNovaStates(3)
      SetLightColor lNova_sw9, modeRampColor, PlayerState(CurrentPlayer).lNovaStates(4)
        Case 6: ' Gamora - Siblng Rvlry (8 shots)
        Case 7: ' Broker - Antique Shop (7 shots)
  End Select

  ' Turn off all the Mode Lights
  Light020.State = 0:Light021.State = 0:Light022.State = 0:Light023.State = 0
  Light024.State = 0:Light025.State = 0:Light026.State = 0:Light027.State = 0

  if PlayerMode <> -1 then
    StackState(kStack_Pri0).Disable  ' Disable this stack level
    if bCompetitionMode and ModePercent(PlayerMode) < 50 then ' If we didnt get at least 50% we dont save (Competition Mode)
      ModePercent(PlayerMode) = 0
      ModeProgress(PlayerMode) = 0
    End If
  End If
  SetModeLights()     ' Set mode lights based on progress
  UpdateSwitchHitCnt 0

  CheckWizardModesReady   ' See if we need to enable wizard modes

  if PlayerMode <> -1 Then  ' Start 2nd Mode
debug.print "2nd Mode? " & ModePercent(PlayerMode) & " 2ndMode:" & bSecondMode
    if ModePercent(PlayerMode) >= 100 and bSecondMode then
      PlayerMode2 = PlayerMode
      StartPlayerMode2
      ' If you drain to 1 ball 2nd mode ends
    Else
      StopPlayerModeVideo
    End if
  End If

  PlayerMode = -1
End Sub


sub CheckWizardModesReady()
  if bWizardMode then exit sub  ' We are in a wizard mode no need to check to enable one

  if modesCompleted >= 4 and bCherryBombDone=False and bGrootMultiball=False and bOrbMultiBall=False Then   ' Dont stack CB
debug.print "Setup CherryBomb"
    SetLightColor lStarLordArrow, "red", 2
    if bCherryBombReady = False Then      ' Dont ring bell if we aready set it
      bCherryBombReady = True
      PlaySoundVol "Bells", VolDef
    End if
  elseif modes50 = 8 and Light033.state <>0 and Light030.state <>0 and bImmolationDone=False Then ' Immolation Mode (all 8 >50, groot and orb multi ball complete)
debug.print "Setup Immolation"
    SetLightColor lStarLordArrow, "white", 0
    SetLightColor Light029, "white", 2
    if bImmolationReady=False then
      bImmolationReady = True
      PlaySoundVol "Bells", VolDef
    End If
    PlayScoopLightSeq
  elseif modesCompleted=8 and Light029.state <>0 Then ' Complete all modes and immolation completed
debug.print "Setup Xandar"
    bXandarReady = True
    SetLightColor lStarLordArrow, "purple", 0
    SetLightColor Light031, "white", 2
    PlayScoopLightSeq
    PlaySoundVol "gg_quote11", VolDef
  End If
End Sub


Sub PlayScoopLightSeq()
  LightSeqScoopArrow.Play SeqDiagUpRightOn, 30, 1
End Sub
Sub StopScoopLightSeq()
  LightSeqScoopArrow.StopPlay
End Sub
Sub LightSeqScoopArrow_Playdone()
  PlayScoopLightSeq
End Sub


Sub SetModeLightComplete(Idx, Light)
  Dim bUpdated:bUpdated = False

  if ModePercent(idx) > 0 then
    modesStarted=modesStarted+1
  End If

  If ModePercent(Idx) >= 50 Then  ' 50% flashes slow
    bUpdated=True
    Light.State = 2
    modes50=modes50+1
    Light.BlinkInterval=BlinkIntSlow
    Light.BlinkPattern=BlinkPatternSlow
  End If
  if ModePercent(Idx) >= 100 Then ' 100% Is Solid
    bUpdated=True
    Light.State = 1
    modesCompleted=modesCompleted+1
    Light.BlinkInterval=BlinkIntDef
    Light.BlinkPattern=BlinkPatternDef
  End If

  if Idx = PlayerMode then  ' Current mode flashes
    bUpdated=True
    Light.State = 2
    Light.BlinkInterval=BlinkIntDef
    Light.BlinkPattern=BlinkPatternDef
  End If

  if bUpdated=False Then
    Light.BlinkInterval=BlinkIntDef
    Light.BlinkPattern=BlinkPatternDef
  End If

End Sub

Sub SetModeLights
  ' Of any of the modes are 1/2 done then Flash
  modesStarted=0
  modes50=0
  modesCompleted=0
  SetModeLightComplete 0, Light020
  SetModeLightComplete 1, Light021
  SetModeLightComplete 2, Light022
  SetModeLightComplete 3, Light023
  SetModeLightComplete 4, Light024
  SetModeLightComplete 5, Light025
  SetModeLightComplete 6, Light026
  SetModeLightComplete 7, Light027

  if modesStarted >=3 and PlayerState(CurrentPlayer).bExtraball_2 = False  then ' started 3 modes
    PlayerState(CurrentPlayer).bExtraball_2 = True
    setExtraBallLight(True)
    'flshExtraBall.TimerEnabled = True
  End If
  if modesCompleted >=6 and PlayerState(CurrentPlayer).bExtraball_3 = False  then ' Finished 6 modes
    PlayerState(CurrentPlayer).bExtraball_3 = True
    setExtraBallLight(True)
    'flshExtraBall.TimerEnabled = True
  End If
End Sub

Sub CheckModeProgress2nd(trigger_name)
  dim bValidHit
  dim a, b, i
  dim hitLight
  Dim bModeComplete
  bModeComplete = False
  bValidHit = False

  if PlayerMode <> -1 Then    ' Just in case we get back in here we bail because we are already 100% progress
    debug.print "Mode Progress: " & ModePercent(PlayerMode)
    if Mode2Percent(PlayerMode) >= 100 then
      debug.print "WE SHOULDNT GET HERE.  Skip Score: " & ModePercent(PlayerMode)
      Exit Sub
    End If
  End If

  Select Case PlayerMode2
    case -1:' No Mode Selected
    Case 0: ' Nebula - Pod Chase (10 shots)  - CHECKED SCORE
      For each a in aRampLights
        if a.name = trigger_name and StackState(kStack_Pri0).GetArrowState(a) <> 0 Then   ' Hit Ramp that was lit
          'PlaySound "gg_RampHit"
          'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds
          PlayProgress trigger_name
          Mode2Progress(PlayerMode2) = Mode2Progress(PlayerMode2)+1
          Mode2Percent(PlayerMode2) = CINT((Mode2Progress(PlayerMode2)  / 10) * 100)
          'AddScore 125000 * Mode2Progress(PlayerMode2)    ' Looks like the 2nd mode is 125k increase for each ramp shot
          AddScore 750000     ' Manu Video

          UpdateHitCntMsg "Ramps Left: ", 10 - Mode2Progress(PlayerMode2)

          if (Mode2Progress(PlayerMode2) >= 10) Then
            Mode2Percent(PlayerMode2) = 100
            bModeComplete = True
          End If
          exit for
        End If
      Next
        Case 1: ' Ronan - Sanctuary (20 shots)
      if trigger_name = "tgHadron0" and lHadron0.state=2  then
        set hitLight=lHadron0
        tgHadron0.UserValue = 0
        bValidHit = true
      end if
      if trigger_name = "tgHadron1" and lHadron1.state=2  then
        set hitLight=lHadron1
        tgHadron1.UserValue = 0
        bValidHit = true
      end if
      if trigger_name = "tgHadron2" and lHadron2.state=2  then
        set hitLight=lHadron2
        tgHadron2.UserValue = 0
        bValidHit = true
      end if
      if trigger_name = "tgHadron3" and lHadron3.state=2  then
        set hitLight=lHadron3
        tgHadron3.UserValue = 0
        bValidHit = true
      end if
      if trigger_name = "tgHadron4" and lHadron4.state=2 then
        set hitLight=lHadron4
        tgHadron4.UserValue = 0
        bValidHit = true
      end if

      if bValidHit then ' Only Roving count as actual hits
        AddScore 1250000
        'SetLightColor hitLight, "yellow", 1

        Mode2Progress(PlayerMode2) = Mode2Progress(PlayerMode2)+1
        Mode2Percent(PlayerMode2) = CINT((Mode2Progress(PlayerMode2)  / 20) * 100)

        UpdateSwitchHitCnt 20-Mode2Progress(PlayerMode2)

        if (Mode2Progress(PlayerMode2) >= 20) Then
          Mode2Percent(PlayerMode2) = 100
          bModeComplete = True
        End If
      End If
        Case 2: ' Yandu - Yaka Arrow (8 shots) - CHECKED SCORE
      if trigger_name = "switch" then
        if SwitchHitCount > 0 then
          SwitchHitCount = SwitchHitCount - 1
          UpdateSwitchHitCnt SwitchHitCount
          'ModePoints = ModePoints + 250000
          AddScore 300000             ' Video show 250K for each switch hit
          Mode2Percent(PlayerMode2) = (SwitchHitCount / 50) * 100
          if SwitchHitCount = 1 then                      ' To get the big bonus you have to hit it before time is up
            SSetLightColor kStack_Pri0, lYonduArrow, modeRampColor, 0
          End If
        Else
          bModeComplete = True
        End If
      elseif trigger_name = "lYonduArrow" then
        DMD "BONUS", CL(0, ModePoints), "", eNone, eNone, eNone, 1500, False, ""
        AddScore ModePoints
        Mode2Percent(PlayerMode2) = 100
        bModeComplete = True
      End If
        Case 3: ' Star Lord - Quills Quest (12 shots)
      ' There really is no 2nd mode for quills quest.  You just shoot the scoop for a hurry up finish
        Case 4: ' Drax - Knowhere (10 shots)
      For each a in aRampLights
        if a.name = trigger_name and StackState(kStack_Pri0).GetArrowState(a) <> 0 Then   ' Loop that was lit
          'PlaySound "gg_RampHit"
          'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds
          PlayProgress trigger_name
          Mode2Progress(PlayerMode2) = Mode2Progress(PlayerMode2)+1
          Mode2Percent(PlayerMode2) = CINT((Mode2Progress(PlayerMode2)  / 10) * 100)
          AddScore 3350000  ' Manu Video

          UpdateHitCntMsg "Loops Left: ", 10 - Mode2Progress(PlayerMode2)

          if (Mode2Progress(PlayerMode2) >= 10) Then
            Mode2Percent(PlayerMode2) = 100
            bModeComplete = True
          End If
          exit for
        End If
      Next
        Case 5: ' Rocket - Escape Kyln (10 super lanes)
      'if a.state <> 0 Then   ' Hit lane (that was lit??)
        if trigger_name = "sw8" or trigger_name = "sw9" or trigger_name = "sw2" or trigger_name = "sw3" or trigger_name = "sw4" then
          'PlaySound "gg_RampHit"
          'LightSeqScore.Play SeqUpOn, 100, 0 ' Play sounds
          PlayProgress trigger_name
          Mode2Progress(PlayerMode2) = Mode2Progress(PlayerMode2)+1
          Mode2Percent(PlayerMode2) = CINT((Mode2Progress(PlayerMode2)  / 10) * 100)
          AddScore 2000000  ' Manu Video
          UpdateSwitchHitCnt 10-Mode2Progress(PlayerMode2)

          if (Mode2Progress(PlayerMode2) >= 10) Then
            Mode2Percent(PlayerMode2) = 100
            bModeComplete = True
          End If
        End If
      'End If
        Case 6: ' Gamora - Siblng Rvlry (10 shots)
      if trigger_name = "lGamoraArrow" then
        DMD "BONUS", CL(0, ModePointsSave), "", eNone, eNone, eNone, 1500, False, ""
        AddScore ModePointsSave
        bModeComplete = True
        SetLightColor lGamoraName, "white", 0
      End If
        Case 7: ' Broker - Antique Shop (100 Switch Hits)
      if trigger_name = "switch" Then
        SwitchHitCount = SwitchHitCount - 1
        if SwitchHitCount Mod 25 = 0 then PlayProgress trigger_name
        UpdateSwitchHitCnt SwitchHitCount

        HurryUpCounter = HurryUpCounter + 10000
        AddScore HurryUpCounter

        Mode2Percent(PlayerMode2) = 100-SwitchHitCount
        Mode2Progress(PlayerMode2) = SwitchHitCount
debug.print "Broker Switch:" &  SwitchHitCount
        if (SwitchHitCount <= 0) then
          bModeComplete = True
          Mode2Percent(PlayerMode2) = 100
        End If
      End If
  End Select

  if bModeComplete then
debug.print "2nd Mode complete"
    ShowPlayerModeComplete(-1)      ' Show 2nd Mode total
    UpdateSwitchHitCnt 0
    PlaySoundVol "LevelUp-3", VolDef
    StopPlayerMode2           ' Stop this mode.
  End If

End Sub

Sub StartPlayerMode2()
  dim time

  if bSkillshotsReady(2) = False Then ' Close the gate before the mode start unless we are doing a skill shot
    LoopGateLeft.Open = False
  End If
  Gate002.Open = False

  puPlayer.LabelSet pBackglass,"TimeLbl", "Timer" ,0,""
  puPlayer.LabelSet pBackglass,"Time",  ""  ,0,""
  pDMDEvent(kDMD_PlayerMode2)

  if PlayerMode2 <> -1 Then
    StackState(kStack_Pri0).Enable(PlayerMode2)
  End If

  ModePoints = 0      ' Reset modepoints
  time = 2000
  Select Case PlayerMode2
    case -1:' No Mode Selected
    Case 0: ' Nebula - Pod Chase (10 shots)
      DMD "Start Mode", CL(0, "Pod Chase 2nd"), "", eNone, eNone, eNone, time, False, ""

      SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 1
      SSetLightColor kStack_Pri0, lNebulaArrow, modeRampColor , 1
      HurryUpCounter = 0
      LoopGateLeft.Open = True    ' Gates are open for a full orbit shots
      Gate002.Open = True
      UpdateHitCntMsg "Ramps Left: ", 10
        Case 1: ' Ronan - Sanctuary (5 shots)
      DMD "Start Mode", CL(0, "Sanctuary 2nd"), "", eNone, eNone, eNone, time, False, ""
      SetLightColor lHadron0, "yellow", 1   ' make one flash to start the roving
      SetLightColor lHadron1, "yellow", 1
      SetLightColor lHadron2, "yellow", 1
      SetLightColor lHadron3, "yellow", 1
      SetLightColor lHadron4, "yellow", 1
      tgHadron0.UserValue = 0
      tgHadron1.UserValue = 0
      tgHadron2.UserValue = 0
      tgHadron3.UserValue = 0
      tgHadron4.UserValue = 0
      rovHadronPos=0
      tmrRovingHadron.Enabled = True
      UpdateSwitchHitCnt 20
        Case 2: ' Yandu - Yaka Arrow (8 shots)
      DMD "Start Mode", CL(0, "Yaka Arrow 2nd"), "", eNone, eNone, eNone, time, False, ""
      SSetLightColor kStack_Pri0, lYonduArrow, modeRampColor , 1
      SwitchHitCount = 50
      UpdateSwitchHitCnt SwitchHitCount
      PlaySoundVol "say-ShootTheTargets", VolDef
        Case 3: ' Star Lord - Quills Quest (12 shots)
      DMD "Start Mode", CL(0, "Quills Quest 2nd"), "", eNone, eNone, eNone, time, False, ""
        Case 4: ' Drax - Knowhere (8 shots)
      DMD "Start Mode", CL(0, "Knowhere 2nd"), "", eNone, eNone, eNone, time, False, ""
      SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor , 1
      SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor , 1
      HurryUpCounter = 0
      LoopGateLeft.Open = True    ' Gates are open for a full orbit shots
      Gate002.Open = True
      UpdateHitCntMsg "Loops Left: ", 10
        Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      DMD "Start Mode", CL(0, "Escape Kyln 2nd"), "", eNone, eNone, eNone, time, False, ""
      SSetLightColor kStack_Pri0, lRonanArrow, modeRampColor , 1
      SSetLightColor kStack_Pri0, lDraxArrow, modeRampColor , 1

      PlayerState(CurrentPlayer).lNovaStates(0)=0   ' Clear it so this mode didnt count progress
      PlayerState(CurrentPlayer).lNovaStates(1)=0
      PlayerState(CurrentPlayer).lNovaStates(2)=0
      PlayerState(CurrentPlayer).lNovaStates(3)=0
      PlayerState(CurrentPlayer).lNovaStates(4)=0
      UpdateSwitchHitCnt 10
      LoopGateLeft.Open = True    ' Gates are open for a full orbit shots
      Gate002.Open = True
        Case 6: ' Gamora - Siblng Rvlry (8 shots)
      UpdateHitCntMsg "Gamora Ramp = ", FormatScore(ModePointsSave)
      DMD "Start Mode", CL(0, "Sibling Rivalry 2nd"), "", eNone, eNone, eNone, time, False, ""
      'SSetLightColor kStack_Pri0, lGamoraArrow, modeRampColor, 1
      SetLightColor lGamoraName, "white", 2
        Case 7: ' Broker - Antique Shop (7 shots)
      DMD "Start Mode", CL(0, "Antiquites Shop 2nd"), "", eNone, eNone, eNone, time, False, ""
      SwitchHitCount = 100
      HurryUpCounter = 10000
      UpdateSwitchHitCnt SwitchHitCount
      PlaySoundVol "say-ShootTheTargets", VolDef
  End Select

  StartPlayerModeVideo False
End Sub

Sub StopPlayerMode2()
  If bSecondMode then
debug.print "StopPlayerMode2 " & PlayerMode
    Dim a
    For each a in aRampLights       ' Turn off all the ramp lights to reset the mode
      SSetLightColor kStack_Pri0, a, "white", 0
    Next

    Select Case PlayerMode2
      case -1:' No Mode Selected
      Case 0: ' Nebula - Pod Chase (10 shots)
      Case 1: ' Ronan - Sanctuary (5 shots)
        tmrRovingHadron.Enabled = False
      Case 2: ' Yandu - Yaka Arrow (8 shots)
      Case 3: ' Star Lord - Quills Quest (12 shots)
      Case 4: ' Drax - Knowhere (8 shots)
      Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
      Case 6: ' Gamora - Siblng Rvlry (10 shots)
        SetLightColor lGamoraName, "white", 0
      Case 7: ' Broker - Antique Shop (7 shots)
    End Select
    StopPlayerModeVideo

    StackState(kStack_Pri0).Disable
  End If

  UpdateSwitchHitCnt 0
  bSecondMode = False
  CheckWizardModesReady ' See of we need to enable wizard modes
End sub

Sub debounceReset()     ' Reset Debounce for those that dont have a timer
  bDebounce = False
End Sub

dim rovHadronPos
Sub tmrRovingHadron_Timer
  select case rovHadronPos
    case 0:
      lHadron0.state = 1
      lHadron1.state = 2
    case 1:
      lHadron1.state = 1
      lHadron2.state = 2
    case 2:
      lHadron2.state = 1
      lHadron3.state = 2
    case 3:
      lHadron3.state = 1
      lHadron4.state = 2
    case 4:
      lHadron4.state = 1
      lHadron0.state = 2
  End Select
  rovHadronPos=rovHadronPos+1
  if rovHadronPos>4 then rovHadronPos=0
End Sub

Sub UpdateSwitchHitCnt(value)
  UpdateHitCntMsg "HITS LEFT: ", value
End Sub
Sub UpdateHitCntMsg(Message, value)
  if bUsePUPDMD and bPupStarted then
    if value&""="0" then
      puPlayer.LabelSet pBackglass,"Timer", ""  ,1,""
    Else
      puPlayer.LabelSet pBackglass,"Timer", Message & value ,1,""
    End If
  End If
End Sub

Sub tmrQuestRamps_Timer
  dim light1
  dim light2
  dim state1
  dim state2
  bDebounce = False

  light1 = INT(8 * RND + 1)   ' Range 7-12 = (12-7+1) * Rnd + 7
  light2 = INT(8 * RND + 1)   ' Range 7-12 = (12-7+1) * Rnd + 7
  Do While light2 = light1
    light2 = INT(8 * RND + 1)   ' Range 7-12 = (12-7+1) * Rnd + 7
  Loop
  state1 = INT(RND * 2 + 1)   ' Range 7-12 = (12-7+1) * Rnd + 7
  state2 = INT(RND * 2 + 1)   ' Range 7-12 = (12-7+1) * Rnd + 7

  dim a
  dim cnt
  cnt = 1
  For each a in aRampLights
    if (a.name <> "lStarLordArrow") then ' Skip Starlord arrow since it is always lit
      if (cnt = light1) then
        SSetLightColor kStack_Pri0, a, "yellow", state1
      Elseif cnt = light2 then
        SSetLightColor kStack_Pri0, a, "yellow", state2
      Else
        SSetLightColor kStack_Pri0, a, "yellow", 0
      end if
      cnt = cnt+1
    End If
  Next

  tmrQuestRamps.Interval = 1000 * INT(RND * 6 + 7)    ' Range 7-12 = (12-7+1) * Rnd + 7
End Sub

Sub tmrCherryBombMouth_Timer
  if GrootMouth_IsDropped Then
    GrootMouth_Drop(False)
  Else
    GrootMouth_Drop(True)
  End If
End Sub

Sub tmrCherryBomb_Timer
  if tmrCherryBomb.UserValue > 0 then
    tmrCherryBomb.UserValue=tmrCherryBomb.UserValue-1
    puPlayer.LabelSet pBackglass,"Timer", "Time remaining: " & tmrCherryBomb.UserValue  ,1,""
    if tmrCherryBomb.UserValue <= 10 Then
      PlaySoundVol "say-" & tmrCherryBomb.UserValue, VolDef
    End if
  Elseif tmrCherryBomb.UserValue <> -1 then
    EndCherryBomb
  End If
End Sub

Sub CherryBombDrained
debug.print "CB Drain Balls: " & BallsOnPlayfield
  puPlayer.LabelSet pBackglass,"Timer", ""  ,1,""
  bGameInPlay = True
  bGameInPlayHidden = False
  bMultiBallMode=False
' BallsOnPlayfield = 0
  bAutoPlunger = False
  bBallSaverReady = True      ' Need to enable ball saver for the next ball
  StackState(kStack_Pri2).Disable
  tmrCherryBombMouth.Enabled = False
  tmrCherryBomb.Enabled = False
  bWizardMode = False

  if PlayerMode <> -1 and bSecondMode=False and ModeCountdownTimer.UserValue > 0 then   ' Still in a mode then restart the video
    aRampLightsRestore    ' Restore ramp colors
    WaitPlayerMode
    StartPlayerModeVideo True   ' TBD Make this skip to the correct position if PUP ever supports it
    pausemedia pBackglass
    pausemedia pMusic
    ModeCountdownTimer.enabled = False    ' Pause the timer
                        ' TBD Find out what the first time I called this it sometimes doesnt work (The drain_unhit is getting called somehow)
  else
    EnablePlayerSelect
  End if

  if (bBallInPlungerLane=False) then
    CreateNewBall() ' Put a ball in the lane
  End If
End Sub


' *********************************************************************
'                        Table Object Hit Events
'
' Any target hit Sub will follow this:
' - play a sound
' - do some physical movement
' - add a score, bonus
' - check some variables/modes this trigger is a member of
' - set the "LastSwicthHit" variable in case it is needed later
' *********************************************************************

' Slingshots has been hit

Dim LStep, RStep

Sub LeftSlingShot_Slingshot
    If Tilted Then Exit Sub
    PlaySoundAt SoundFXDOF("CrispySlingLeft", 103, DOFPulse, DOFContactors), Lemk
    DOF 104, DOFPulse
    LeftSling4.Visible = 1:LeftSling1.Visible = 0
    Lemk.RotX = 26
    LStep = 0
    LeftSlingShot.TimerEnabled = True
    ' add some points
    AddScore 170
    ' add some effect to the table?
    'FlashForMs l20, 1000, 50, 0:FlashForMs l20f, 1000, 50, 0
    'FlashForMs l21, 1000, 50, 0:FlashForMs l21f, 1000, 50, 0
    ' remember last trigger hit by the ball
    LastSwitchHit = "LeftSlingShot"
End Sub

Sub LeftSlingShot_Timer
    Select Case LStep
        Case 1:LeftSLing4.Visible = 0:LeftSLing3.Visible = 1:Lemk.RotX = 14
        Case 2:LeftSLing3.Visible = 0:LeftSLing2.Visible = 1:Lemk.RotX = 2
        Case 3:LeftSLing2.Visible = 0:LeftSling1.Visible = 1:Lemk.RotX = -10:Gi2.State = 1:LeftSlingShot.TimerEnabled = False
    End Select
    LStep = LStep + 1
End Sub

Sub RightSlingShot_Slingshot
    If Tilted Then Exit Sub
    PlaySoundAt SoundFXDOF("CrispySlingRight", 105, DOFPulse, DOFContactors),Remk
    DOF 106, DOFPulse
    RightSling4.Visible = 1:RightSling1.Visible = 0
    Remk.RotX = 26
    RStep = 0
    RightSlingShot.TimerEnabled = True
    ' add some points
    AddScore 170
    ' add some effect to the table?
    'FlashForMs l22, 1000, 50, 0:FlashForMs l22f, 1000, 50, 0
    'FlashForMs l23, 1000, 50, 0:FlashForMs l23f, 1000, 50, 0
    ' remember last trigger hit by the ball
    LastSwitchHit = "RightSlingShot"
End Sub

Sub RightSlingShot_Timer
    Select Case RStep
        Case 1:RightSLing4.Visible = 0:RightSLing3.Visible = 1:Remk.RotX = 14:
        Case 2:RightSLing3.Visible = 0:RightSLing2.Visible = 1:Remk.RotX = 2:
        Case 3:RightSLing2.Visible = 0:RightSLing1.Visible = 1:Remk.RotX = -10:Gi4.State = 1:RightSlingShot.TimerEnabled = False
    End Select
    RStep = RStep + 1
End Sub


'**************
' Guardians Target
'**************
Sub tgtGuardians_Hit()
  if tgtGuardians.UserValue = 1 then exit sub

  SpellGuardians=SpellGuardians+1
  PuPlayer.LabelSet pBackglass, "Guardians2", "PuPOverlays\\GUARDIAN-"&SpellGuardians&".png",1,"{'mt':2,'color':111111,'width':31, 'height':8,'yalign':0,'ypos':0.0,'xpos':50.4}"
  Select Case SpellGuardians
    case 1:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "G","", 1000
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","G" ,1,""
    case 2:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "GU","", 1000
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","U" ,1,""
    case 3:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "GUA","", 1000
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","A" ,1,""
    case 4:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "GUAR","", 1000
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","R" ,1,""
    case 5:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "GUARD","", 1000
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","D" ,1,""
    case 6:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "GUARDI","", 1000
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","I" ,1,""
    case 7:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "GUARDIA","", 1000
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","A" ,1,""
    case 8:
      PlaySoundVol "gg_SpellG", VolDef
      DisplayDMDText "GUARDIAN","", 1000
      SetLightColor LightGuardians, "white", 0
      if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians","N" ,1,""
    case 9:
      AddScore 48890  ' 48890+26110=75K
      PlaySoundVol "gg_SpellG", VolDef
      PlaySoundVol "gg_WeAreTheGOTG", VolDef
      PlaySoundVol "gg_SpellGuardians", VolDef
      AddBonusMultiplier 1
      if bUsePUPDMD then
        puPlayer.LabelSet pBackglass, "Popup1", "BONUS|13535251",1, ""
        puPlayer.LabelSet pBackglass, "Popup2", BonusMultiplier  & "X|827358",1, ""
        puPlayer.LabelSet pBackglass, "Popup3", "Multiplier|13535251",1, ""
        vpmtimer.addtimer 1800, "puPlayer.LabelSet pBackglass, ""Popup1"", """",1, """":puPlayer.LabelSet pBackglass, ""Popup2"", """",1, """":puPlayer.LabelSet pBackglass, ""Popup3"", """",1, """" '"
      End If
      SpellGuardians=0
      vpmtimer.addtimer 1800, "pDMDEvent(kDMD_Myst_IsLit) '"
      'flshMystery.TimerEnabled = True
      setMysteryLight(True)
  End Select
  vpmtimer.addtimer 1200, "tgtGuardians_debounce '"
End Sub


Sub tgtGuardians_debounce
  AddScore 26110
  tgtGuardians.UserValue = 0
  if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Guardians",""  ,1,""
End Sub


Sub SpinnerRonan_Spin()
    If Tilted Then Exit Sub
  CheckModeProgress("switch")
    PlaySoundAt "fx_spinner", SpinnerRonan
    AddScore 1000
End Sub

'*********************
' Catch the Arrow ramps and if their multipliers are flashing mark it and disable multipliers
'*********************
Sub tRonan_m_Hit()
  ' Moved to sw12_hit ' Left Loop
  LastSwitchHit="tRonan_m"
End Sub

Sub tGroot_m_Hit()
  ClearShotMultiplier(lgr_m)
  MultiplierShot = 1    ' Clear shot multiplier
  ' Moved to GrootMouth_Hit
End Sub
Sub tDrax_m_Hit()
  ' Moved to sw11_hit
  LastSwitchHit="tDrax_m"
End Sub
Sub tGamora_m_Hit()
  ClearShotMultiplier(lGamora_m)
  If tmrSkillshot.Enabled and lGamoraArrow.state = 2 Then   ' Hold Left, Loop around and hit Orb, Right Ramp or Right Orbit
    AddScore 1000000
    DOF 127, DOFPulse
    PlaySoundVol "gg_SkillShot", VolDef
    DOF 325, DOFPulse           ' James DOF
    QueueScene "ScenePlayMessage ""SkillShot.mp4"", """","""",""1000000"" '", 2000, 1
    QueueScene "SceneClearPlayMessage '", 0, 1

  End If

  if lGamoraArrow.BlinkInterval = BlinkIntFast Then  MultiplierShot=MultiplierShot*2
  CheckModeProgress "lGamoraArrow"
  LastSwitchHit="tGamora_m"
  Addscore 1170
  BonusAddModeHit(6)
  if lGamoraArrow.BlinkInterval = BlinkIntFast Then  MultiplierShot=MultiplierShot/2

  ' Setup ramp combo
  lNebulaArrow.BlinkInterval = BlinkIntFast
  lNebulaArrow.state = 2
  vpmtimer.addtimer 3500, "rampComboNebula '"
  MultiplierShot = 1    ' Clear shot multiplier
End Sub

Sub tgAntiqueShop_Dropped ' What does the antique target do?? Bonus??
  AddScore 1110
  tgAntiqueShop.isDropped = False
  ' TBD Play Antique Shop Video
End Sub
'Sub tYando_m_Hit()     ' Should this move to tgAntiqueShop_hit? (Seems like in the video it didnt have to get all the way up to Count)
' If lYando_m.State = 2 Then    ' If multilier is flashing
'   ClearShotMultiplier()
'   SetLightColor lYando_m, "green", 1
' End If
' CheckModeProgress "lYonduArrow"
' LastSwitchHit="tYando_m"
'End Sub

sub rampComboGamora
  lGamoraArrow.BlinkInterval = BlinkIntDef
  SetLightColorRestore lGamoraArrow, -1
End Sub
sub rampComboNebula
  lNebulaArrow.BlinkInterval = BlinkIntDef
  SetLightColorRestore lNebulaArrow, -1
End Sub

'Sub tRocket_m_Hit()  ' Dummy function thaat is called from RocketKicker Now
' ClearShotMultiplier(lRocket_m)
' CheckModeProgress "lRocketArrow"
' LastSwitchHit="tRocket_m"
' MultiplierShot = 1    ' Clear shot multiplier
'End Sub
Sub tNebula_m_Hit()
  ClearShotMultiplier(lNebula_m)

  if lNebulaArrow.BlinkInterval = BlinkIntFast Then  MultiplierShot=MultiplierShot*2
  CheckModeProgress "lNebulaArrow"
  LastSwitchHit="tNebula_m"
  Addscore 1170
  BonusAddModeHit(3)
  if lNebulaArrow.BlinkInterval = BlinkIntFast Then  MultiplierShot=MultiplierShot/2

  ' Setup ramp combo
  lGamoraArrow.BlinkInterval = BlinkIntFast
  lGamoraArrow.state = 2
  vpmtimer.addtimer 3500, "rampComboGamora '"
  MultiplierShot = 1    ' Clear shot multiplier
End Sub
Sub tBroker_m_Hit() ' This is really a dummy function now since I switched to the Orb Triggers
  ClearShotMultiplier(lBroker_m)
  CheckModeProgress "lBrokerArrow"
  LastSwitchHit="tBroker_m"
  MultiplierShot = 1    ' Clear shot multiplier
End Sub
'Sub tStarLord_m_Hit()        ' Moved to Left Scoop
' If lStarLord_m.State = 2 Then   ' If multilier is flashing
'   ClearShotMultiplier()
'   SetLightColor lStarLord_m, "green", 1
' End If
' 'LastSwitchHit="tStarLord_m"
' 'CheckModeProgress "lStarLordArrow"   ' You have to get it in the scoop
'End Sub

Dim ShotMultiplierStrobe
Sub ClearShotMultiplier(light)
  If light.State = 2 then ' Blinking Multiplier
    if (tmrShotMultiplierStrobe.Enabled = False) Then   ' Hit a shot on the Multiplier
    ' LightSeqMultiplier.StopPlay()
      light.UserValue =1    ' Mark we hit this one
      SetLightColor lDrax_m, "green", lDrax_m.UserValue
      SetLightColor lGamora_m, "green", lGamora_m.UserValue
      SetLightColor lYando_m, "green", lYando_m.UserValue
      SetLightColor lRocket_m, "green", lRocket_m.UserValue
      SetLightColor lgr_m, "green", lgr_m.UserValue
      SetLightColor lNebula_m, "green", lNebula_m.UserValue
      SetLightColor lBroker_m, "green", lBroker_m.UserValue
      SetLightColor lStarLord_m, "green", lStarLord_m.UserValue
      SetLightColor lRonan_m, "green", lRonan_m.UserValue

      PlaySoundVol "2xMultiplier", VolDef
      'Multiplier2x = Multiplier2x + 1
      bShotMultiplierSelect = False
      vpmtimer.addtimer 1500, "PlaySoundVol ""RovingShotMultiplierIsLit"", VolDef '"
      'AddPlayMultiplier 1
      'Start the moving spot shot
      ShotMultiplierStrobe=0
      tmrShotMultiplierStrobe.Enabled = True
      SetLightColor lDrax_m, "green", 2
    Else                      ' We are in Strobing mode
      tmrShotMultiplierStrobe.Enabled = False
      SetLightColor lDrax_m, "green", lDrax_m.UserValue
      SetLightColor lGamora_m, "green", lGamora_m.UserValue
      SetLightColor lYando_m, "green", lYando_m.UserValue
      SetLightColor lRocket_m, "green", lRocket_m.UserValue
      SetLightColor lgr_m, "green", lgr_m.UserValue
      SetLightColor lNebula_m, "green", lNebula_m.UserValue
      SetLightColor lBroker_m, "green", lBroker_m.UserValue
      SetLightColor lStarLord_m, "green", lStarLord_m.UserValue
      SetLightColor lRonan_m, "green", lRonan_m.UserValue

      PlaySoundVol "3xMultiplier", VolDef
      Multiplier3x = 3            ' 3x is just for this shot
    end If
  elseif light.state =1 then ' Solid lit setup 2x for the shot
    MultiplierShot = 2
  End If
End Sub

Sub tmrShotMultiplierStrobe_Timer
  Select case ShotMultiplierStrobe
    case 0:
      SetLightColor lDrax_m, "green", lDrax_m.UserValue
      SetLightColor lGamora_m, "green", 2
    case 1:
      SetLightColor lGamora_m, "green", lGamora_m.UserValue
      SetLightColor lYando_m, "green", 2
    case 2:
      SetLightColor lYando_m, "green", lYando_m.UserValue
      SetLightColor lRocket_m, "green", 2
    case 3:
      SetLightColor lRocket_m, "green", lRocket_m.UserValue
      SetLightColor lgr_m, "green", 2
    case 4:
      SetLightColor lgr_m, "green", lgr_m.UserValue
      SetLightColor lNebula_m, "green", 2
    case 5:
      SetLightColor lNebula_m, "green", lNebula_m.UserValue
      SetLightColor lBroker_m, "green", 2
    case 6:
      SetLightColor lBroker_m, "green", lBroker_m.UserValue
      SetLightColor lStarLord_m, "green", 2
    case 7:
      SetLightColor lStarLord_m, "green", lStarLord_m.UserValue
      SetLightColor lRonan_m, "green", 2
    case 8:
      SetLightColor lRonan_m, "green", lRonan_m.UserValue
      SetLightColor lDrax_m, "green", 2
  End Select
  ShotMultiplierStrobe=ShotMultiplierStrobe+1
  if ShotMultiplierStrobe>8 then ShotMultiplierStrobe=0

End Sub

Sub CheckShotMultiplier
  if PlayerMode = 5 and PlayerMode2 = -1 then Exit Sub  ' Cant do shot multiplier in Ronan mode

  if bShotMultiplierSelect then debug.print "Already in 2x Multiplier"    ' We can do this for each
  if (PlayerState(CurrentPlayer).lNovaStates(0)=1 and _
    PlayerState(CurrentPlayer).lNovaStates(1)=1 and _
    PlayerState(CurrentPlayer).lNovaStates(2)=1 and _
    PlayerState(CurrentPlayer).lNovaStates(3)=1 and _
    PlayerState(CurrentPlayer).lNovaStates(4)=1) and bShotMultiplierSelect=False and tmrShotMultiplierStrobe.Enabled = False Then

    ' Reset Nova Corp Lights (If we are not in Kyln Mode)     ' TBD - I Think this should stay disabled until they hit one
    if PlayerMode <> 5 then
      SetLightColor lNova_sw2, "orange", 0
      SetLightColor lNova_sw3, "orange", 0
      SetLightColor lNova_sw4, "orange", 0
      SetLightColor lNova_sw8, "orange", 0
      SetLightColor lNova_sw9, "orange", 0
    End If
    PlayerState(CurrentPlayer).lNovaStates(0)=0   ' Clear it so we can hit it again
    PlayerState(CurrentPlayer).lNovaStates(1)=0
    PlayerState(CurrentPlayer).lNovaStates(2)=0
    PlayerState(CurrentPlayer).lNovaStates(3)=0
    PlayerState(CurrentPlayer).lNovaStates(4)=0

    PlaySoundVol "say-MultipliersAreLit", VolDef
    DisplayDMDText "Shot Multipliers","Are Lit", 1000
    bShotMultiplierSelect = True
'   LightSeqMultiplier.Play SeqBlinking, 1, 0

    ' Flash all the ones that are not already lit
    if lDrax_m.UserValue=0 then   SetLightColor lDrax_m, "green", 2
    if lGamora_m.UserValue=0 then SetLightColor lGamora_m, "green", 2
    if lYando_m.UserValue=0 then  SetLightColor lYando_m, "green", 2
    if lRocket_m.UserValue=0 then   SetLightColor lRocket_m, "green", 2
    if lgr_m.UserValue=0 then     SetLightColor lgr_m, "green", 2
    if lNebula_m.UserValue=0 then   SetLightColor lNebula_m, "green", 2
    if lBroker_m.UserValue=0 then   SetLightColor lBroker_m, "green", 2
    if lStarLord_m.UserValue=0 then SetLightColor lStarLord_m, "green", 2
    if lRonan_m.UserValue=0 then  SetLightColor lRonan_m, "green", 2
  end If
End Sub

Sub tmrNovaCorps_Timer    ' Rotate the lit nova corp lights
' if sw2.UserValue = 1 and sw3.UserValue <> 1 then  ' Lower Lanes
'   sw2.UserValue = 0
'   sw3.UserValue = 1
' Elseif sw2.UserValue <> 1 and sw3.UserValue = 1 then
'   sw2.UserValue = 1
'   sw3.UserValue = 0
' End If
' SetLightColor lNova_sw2, "orange", sw2.UserValue
' SetLightColor lNova_sw3, "orange", sw3.UserValue
'
'
' if sw8.UserValue = 1 and sw9.UserValue <> 1 then  ' Upper Lanes
'   sw8.UserValue = 0
'   sw9.UserValue = 1
' Elseif sw8.UserValue <> 1 and sw9.UserValue = 1 then
'   sw8.UserValue = 1
'   sw9.UserValue = 0
' End If
'
' SetLightColor lNova_sw8, "orange", sw8.UserValue
' SetLightColor lNova_sw9, "orange", sw9.UserValue
End Sub


Sub sw1_Hit()
    PlaySoundAt "fx_sensor", sw1
    If Tilted Then Exit Sub
    LaneBonus = LaneBonus + 1
    AddScore 100000
    ' change some light
    'FlashForms l5f, 1000, 40, 0:FlashForms l5, 1000, 40, 0
    LastSwitchHit = "sw1"
  if bBallSaverActive then BallSaverActiveBuffer=BallSaverActiveBuffer+1
' do some check
End Sub

Sub sw2_Hit()
    PlaySoundAt "fx_sensor", sw2
    If Tilted Then Exit Sub
    LaneBonus = LaneBonus + 1
    AddScore 10000
    ' change some light
    'FlashForms l5f, 1000, 40, 0:FlashForms l5, 1000, 40, 0

  LastSwitchHit = "sw2"
  if PlayerMode <> 5 then
    SetLightColor lNova_sw2, "orange", 1
  Else
    BonusAddModeHit(2)    ' This add to bonus on Rocket mode
  End If
  PlayerState(CurrentPlayer).lNovaStates(0) = 1
  CheckModeProgress("sw2")
  CheckShotMultiplier()
End Sub

Sub sw3_Hit()
    PlaySoundAt "fx_sensor", sw3
    If Tilted Then Exit Sub
    LaneBonus = LaneBonus + 1
    AddScore 10000
    ' change some light
    'FlashForms l5f, 1000, 40, 0:FlashForms l5, 1000, 40, 0
  LastSwitchHit = "sw3"
  if PlayerMode <> 5 then
    SetLightColor lNova_sw3, "orange", 1
  Else
    BonusAddModeHit(2)    ' This add to bonus on Rocket mode
  End if
  PlayerState(CurrentPlayer).lNovaStates(1) = 1
  CheckModeProgress("sw3")
  CheckShotMultiplier()
End Sub

Sub sw4_Hit()
    PlaySoundAt "fx_sensor", sw4
    If Tilted Then Exit Sub
    LaneBonus = LaneBonus + 1
    AddScore 10000
    ' change some light
    'FlashForms l6f, 1000, 40, 0:FlashForms l6, 1000, 40, 0
  LastSwitchHit = "sw4"
  if PlayerMode <> 5 then
    SetLightColor lNova_sw4, "orange", 1
  Else
    BonusAddModeHit(2)    ' This add to bonus on Rocket mode
  End if
  PlayerState(CurrentPlayer).lNovaStates(2) = 1

  CheckModeProgress("sw4")
  CheckShotMultiplier()
End Sub


Sub sw6_Hit()
    PlaySoundAt "fx_sensor", sw6
    If Tilted Then Exit Sub
    LaneBonus = LaneBonus + 1
    AddScore 100000
    ' change some light
    'FlashForms l6f, 1000, 40, 0:FlashForms l6, 1000, 40, 0

  if bLaneSaverEnabled then ' Virtual Lane Saver
    pDMDEvent(kDMD_BallSaveAwarded)
    AddScore BonusLaneSaver
    BonusLaneSaver = 0
    SetLightColor lLaneSaver, "yellow", 0
    bLaneSaverEnabled = False
    if bBallSaverActive = False Then
      BallSaverActiveBuffer=BallSaverActiveBuffer+1
    End If
  End if

    LastSwitchHit = "sw6"
' do some check
  if bBallSaverActive then BallSaverActiveBuffer=BallSaverActiveBuffer+1
End Sub

'************
' Other lanes
'************

Sub sw11_Hit() 'right loop
    PlaySoundAt "fx_sensor", sw11
    If Tilted or bSkillshotsReady(2) Then Exit Sub

  if LastSwitchHit = "tDrax_m" Then   ' We are going up the ramp
    ClearShotMultiplier(lDrax_m)
    CheckModeProgress "lDraxArrow"

    If tmrSkillshot.Enabled and lDraxArrow.state = 2 Then   ' Hold Left, Loop around and hit Orb, Right Ramp or Right Orbit
      AddScore 1000000
      DOF 127, DOFPulse
      PlaySoundVol "gg_SkillShot", VolDef

      QueueScene "ScenePlayMessage ""SkillShot.mp4"", """","""",""1000000"" '", 2000, 1
      QueueScene "SceneClearPlayMessage '", 0, 1

    End If
    AddScore 1220
    BonusAddModeHit(7)
    MultiplierShot = 1    ' Clear shot multiplier
  End If
    ' change some extra light, do other checks
    LastSwitchHit = "sw11"
End Sub


Sub sw12_Hit() 'left loop
    PlaySoundAt"fx_sensor", sw12
    If Tilted Then Exit Sub
  if LastSwitchHit = "tRonan_m" Then  ' We are going up the ramp
    ClearShotMultiplier(lRonan_m)
    CheckModeProgress "lRonanArrow"

    AddScore 1220
    BonusAddModeHit(1)
    MultiplierShot = 1    ' Clear shot multiplier
  end if
  bSkillshotsReady(2) = False   ' Mark so they can hit the skill shot
    ' change some light
    LastSwitchHit = "sw12"
' do some check
End Sub

Sub sw13_Hit() 'Yondu tunnel
debug.print "SW13 HIT"
  ' tgAntiqueShop_Dropped     ' What does the antique target do?? Bonus??
  if sw13.UserValue = "debounce" then ' Need a little debounce here because this is like a ramp and hits switch twice going up an down
    exit Sub
  End if
  sw13.UserValue = "debounce"
  vpmtimer.addtimer 1500, "sw13.UserValue = """" '"

  ClearShotMultiplier(lYando_m)
  CheckModeProgress "switch"
  CheckModeProgress "lYonduArrow"
  LastSwitchHit="tYando_m"
  AddScore 2560
  BonusAddModeHit(0)

    ' change some light
    LastSwitchHit = "sw13"
  MultiplierShot = 1    ' Clear shot multiplier
End Sub


'*************
' PKE lanes
'*************

Sub sw8_Hit()
    DOF 130, DOFPulse
    PlaySoundAt "fx_sensor", sw8
    If Tilted Then Exit Sub

  CheckModeProgress("sw8")
  DOF 127, DOFPulse
  if lNova_sw8.state = 2 then
    if bSkillshotsReady(1) then
      AddScore SkillshotValue*2
      PlaySoundVol "gg_SkillShot", VolDef
      pDMDEvent(kDMD_SkillShot1)
      tmrSkillshot_Timer
      DOF 325, DOFPulse   ' James DOF

      QueueScene "ScenePlayMessage ""SkillShot.mp4"", """","""","""&SkillshotValue*2&""" '", 2000, 1
      QueueScene "SceneClearPlayMessage '", 0, 1
      SkillshotValue=SkillshotValue+50000   ' Start out at 250k, Every time you change lanes it goes down 50k until you get to 250, adds 50K each new ball

    elseif bSkillshotsReady(0) Then
      AddScore SkillshotValue
      PlaySoundVol "gg_SkillShot", VolDef
      tmrSkillshot_Timer
      DOF 325, DOFPulse   ' James DOF

      QueueScene "ScenePlayMessage ""SkillShot.mp4"", """","""","""&SkillshotValue&""" '", 2000, 1
      QueueScene "SceneClearPlayMessage '", 0, 1
      SkillshotValue=SkillshotValue+50000   ' Start out at 250k, Every time you change lanes it goes down 50k until you get to 250, adds 50K each new ball

    End If
  End If

  if PlayerMode <> 5 then
    SetLightColor lNova_sw8, "orange", 1
  Else
    BonusAddModeHit(2)    ' This add to bonus on Rocket mode
  End if
  PlayerState(CurrentPlayer).lNovaStates(3) = 1
  CheckShotMultiplier()

    AddScore 5000
    ' change some light
    'Bumper1Light.Visible = 1
    LastSwitchHit = "sw8"
End Sub

Sub sw9_Hit()
    DOF 131, DOFPulse
    PlaySoundAt "fx_sensor", sw9
    If Tilted Then Exit Sub

  CheckModeProgress("sw9")

  if lNova_sw9.state = 2 then
    DOF 127, DOFPulse
    if bSkillshotsReady(1) then
      AddScore SkillshotValue*2
      PlaySoundVol "gg_SkillShot", VolDef
      tmrSkillshot_Timer
      DOF 325, DOFPulse   ' James DOF

      QueueScene "ScenePlayMessage ""SkillShot.mp4"", """","""","""&SkillshotValue*2&""" '", 2000, 1
      QueueScene "SceneClearPlayMessage '", 0, 1
      SkillshotValue=SkillshotValue+50000   ' Start out at 250k, Every time you change lanes it goes down 50k until you get to 250, adds 50K each new ball

    elseif bSkillshotsReady(0) Then
      AddScore SkillshotValue
      PlaySoundVol "gg_SkillShot", VolDef
      tmrSkillshot_Timer
      DOF 325, DOFPulse   ' James DOF

      QueueScene "ScenePlayMessage ""SkillShot.mp4"", """","""","""&SkillshotValue&""" '", 2000, 1
      QueueScene "SceneClearPlayMessage '", 0, 1
      SkillshotValue=SkillshotValue+50000   ' Start out at 250k, Every time you change lanes it goes down 50k until you get to 250, adds 50K each new ball

    End If
  End If

  if PlayerMode <> 5 then
    SetLightColor lNova_sw9, "orange", 1
  Else
    BonusAddModeHit(2)    ' This add to bonus on Rocket mode
  End If
  PlayerState(CurrentPlayer).lNovaStates(4) = 1

  CheckShotMultiplier()

    AddScore 15500
    ' change some light
    'Bumper2Light.Visible = 1
    LastSwitchHit = "sw9"
End Sub

Sub sw10_Hit()
    DOF 120, DOFPulse
    PlaySoundAt "fx_sensor", sw10
    If Tilted Then Exit Sub
    LaneBonus = LaneBonus + 1
    AddScore 10000
    ' change some light
    'Bumper3Light.Visible = 1
    LastSwitchHit = "sw10"
End Sub

'********
' Ramps
'********

Sub LeftRampDone_Hit()
    If Tilted Then Exit Sub

    DOF 210, DOFPulse

End Sub

' you can catch a loop this way
Sub RightRampDone_Hit()

End Sub

'********
' Bumper
'********
Sub tmrPupBumper_Timer
  dim i
  dim bStopTimer
  bStopTimer=True
  for i = 0 to 8
    if BumperPops(i) <> -1 then
      BumperPops(i) = BumperPops(i) -1
      if BumperPops(i) = 0 then
        puPlayer.LabelSet pBackglass,"PopImg" & i, "PuPOverlays\\BumperPopClear.png", 0,""
        puPlayer.LabelSet pBackglass, "PopScore" & i, "", 1,""
        BumperPops(i) =-1
      elseif BumperPops(i) = 1 then ' Loop period so everything is aligned
        bStopTimer=False
      Elseif BumperPops(i) = 2 then ' Start the score moving up
        puPlayer.LabelSet pBackglass, "PopScore" & i, BumperPopsScore(i)/1000 & "K", 0,"{'mt':1,'at':2,'ype':150,'len':400,'mlen':400,'tt':3}"
        bStopTimer=False
      End If
    End if
  Next
  if bStopTimer then tmrPupBumper.Enabled = False
End Sub

dim BumperPopPos
Dim BumperPops(9)
Dim BumperPopsScore(9)
BumperPopPos=0
BumperPops(0)=-1:BumperPops(1)=-1:BumperPops(2)=-1:BumperPops(3)=-1:BumperPops(4)=-1:BumperPops(5)=-1:BumperPops(6)=-1:BumperPops(7)=-1:BumperPops(8)=-1:
Sub FlashPupbumper(Score)
  if BumperPops(BumperPopPos) = -1 then ' If it is available
    BumperPopsScore(BumperPopPos) = score * PlayMultiplier
    dim x,y
    BumperPops(BumperPopPos)=3
    if (BumperPopPos mod 2)=0 then y=50 else y=40
    x=5+BumperPopPos*10
  'debug.print BumperPopPos & " " & x & " " & y
    puPlayer.LabelSet pBackglass,"PopImg" & BumperPopPos, "PuPOverlays\\BumperPop.gif", 1,"{'mt':2,'color':111111,'ypos':"&y&",'xpos':"&x&",'width':24, 'height':32, 'anigif':100,'pagenum':1}"
    puPlayer.LabelSet pBackglass, "PopScore" & BumperPopPos, BumperPopsScore(BumperPopPos)/1000 & "K", 1,""
    tmrPupBumper.Interval = 100
    tmrPupBumper.Enabled = true
  End If
  BumperPopPos=BumperPopPos+1
  if BumperPopPos>8 then BumperPopPos=0
End Sub


' puPlayer.LabelSet pBackglass,"PopImg1", "PuPOverlays\\BumperPop.gif", 1,"{'mt':2,'color':111111,'ypos':50,'xpos':5,'width':20, 'height':28, 'anigif':100,'pagenum':1}"
' puPlayer.LabelSet pBackglass, "PopScore1", "10.4K", 1,""
'
' puPlayer.LabelSet pBackglass,"PopImg2", "PuPOverlays\\BumperPop.gif", 1,"{'mt':2,'color':111111,'ypos':40,'xpos':15,'width':20, 'height':28, 'anigif':100,'pagenum':1}"
' puPlayer.LabelSet pBackglass, "PopScore2", "20.4K", 1,""


Dim b1, b2, b3 'the values of the actual award for each bumper. Get 3 of a kind and get an award

Sub ResetBumpers()
    b1 = INT(RND * 30)
    b2 = INT(RND * 30)
    b3 = INT(RND * 30)
End Sub

Sub Bumper001_Hit
    If Tilted Then Exit Sub
  If sndGeneralHit <> "" then
    PlaySoundAt SoundFXDOF(sndGeneralHit, 107, DOFPulse, DOFContactors), Bumper001
  Else
    PlaySoundAt SoundFXDOF("fx_bumper", 107, DOFPulse, DOFContactors), Bumper001
  End If
    DOF 205, DOFPulse
  BumperLight001.State = 2
    FlashForMs Bumper1Light, 200, 50, 0
  FlashForMs flshLightShootOrb001, 200, 50, 0
  FlashPupBumper 10470 + (1000 * BumperMultiplier)

' BumperPlastic1.Image = "GOTG-_0006_BPA-GI-FLASH-ON"
' vpmtimer.addtimer 300, "BumperPlastic1.Image = ""GOTG-_0007_BPA-GI-ON"" '"

  'FlashForMs BumperFlash1, 500, 50, 0
    AddScore 10470 + (1000 * BumperMultiplier) ' Each ball adds 1000
    If b1 <> b2 AND b1 <> b3 Then
        b1 = (b1 + 1)MOD 30
    End If
    CheckModeProgress("switch")
  CheckModeProgress("bumper")
  LastSwitchHit = "bumper"
End Sub

Sub Bumper002_Hit
    If Tilted Then Exit Sub
    PlaySoundAt SoundFXDOF("fx_bumper", 109, DOFPulse, DOFContactors), Bumper002
    DOF 205, DOFPulse
  BumperLight002.State = 2
    FlashForMs Bumper2Light, 200, 50, 0
  FlashForMs flshLightShootOrb001, 200, 50, 0
  FlashPupBumper 10470 + (1000 * BumperMultiplier)

' BumperPlastic2.Image = "GOTG-_0003_BPB-GI-FLASH-ON"
' vpmtimer.addtimer 300, "BumperPlastic2.Image = ""GOTG-_0004_BPB-GI-ON"" '"
    'FlashForMs BumperFlash, 500, 50, 0:FlashForMs BumperFlash1, 500, 50, 0

    AddScore 10470 + (1000 * BumperMultiplier) ' Each ball adds 1000
    If b2 <> b1 AND b2 <> b3 Then
        b2 = (b2 + 1)MOD 30
    End If
    CheckModeProgress("switch")
  CheckModeProgress("bumper")
  LastSwitchHit = "bumper"
End Sub

Sub Bumper003_Hit
    If Tilted Then Exit Sub
    PlaySoundAt SoundFXDOF("fx_bumper", 111, DOFPulse, DOFContactors), Bumper003
    DOF 205, DOFPulse
  BumperLight003.State = 2
    FlashForMs Bumper3Light, 200, 50, 0
  FlashForMs flshLightShootOrb001, 200, 50, 0
  FlashPupBumper 10470 + (1000 * BumperMultiplier)

' BumperPlastic3.Image = "GOTG-_0000_BPC-GI-FLASH-ON"
' vpmtimer.addtimer 300, "BumperPlastic3.Image = ""GOTG-_0001_BPC-GI-ON"" '"
    'FlashForMs BumperFlash, 500, 50, 0:FlashForMs BumperFlash1, 500, 50, 0

    AddScore 10470 + (1000 * BumperMultiplier) ' Each ball adds 1000
    If b3 <> b1 AND b3 <> b2 Then
        b3 = (b3 + 1)MOD 30
    End If
    CheckModeProgress("switch")
  CheckModeProgress("bumper")
  LastSwitchHit = "bumper"
End Sub

' Check the bumper awards

Sub CheckBumpers()
    ' 1st display the awards
    Dim tmp
    tmp = chr(131 + b1) & chr(131 + b2) & chr(131 + b3)
    DMD "", "", tmp, eNone, eNone, eNone, 100, True, ""

    If b1 = b2 AND b1 = b3 Then 'give award
        'DMD "", "", tmp, eNone, eNone, eBlinkFast, 1000, True, "gb_fanfare"
        'GiveBumperAward
    End If
End Sub

Sub GiveBumperAward()
'    Select Case b1
'        Case 1:l58.State = 2:PlaySound "vo_tobinspiritguideislit" 'Light Tobin's Spirit Guide
'        Case 2:StartTerrorDog                                     'Start Terror Dog
'        Case 3:StartScoleriBrothers                               'Start Scoleri Brothers
'        Case 4:StartScoleriBrothers                               'Start Scoleri Brothers
'        Case 5:LitRandomGhost:LitRandomGhost:LitRandomGhost       'Light Three Ghosts
'        Case 6:LitRandomGhost:LitRandomGhost                      'Light two Ghosts
'        Case 7:StorageLights 1                                    'Light Storage Facility
'        Case 8:Enable2XMultiplier:Enable3XMultiplier              'Light Playfield Multipliers
'        Case 9:l53.State = 2                                      'Light Extra Ball
'        Case 10:AddSuperJackpot 1000000                           'Increase Super Jackpot
'        Case 11:SpinnerLevel = SpinnerLevel + 1                   'Increase Spinner Level
'        Case 12:SpinnerValue = SpinnerValue + 1000                'Increase Spinner Value
'        Case 13:CatchGhost 3                                      'Catch Three Ghosts
'        Case 14:CatchGhost 2                                      'Catch two Ghosts
'        Case 15:CatchGhost 1                                      'Catch One Ghost
'        Case 16:SpinnerValue = SpinnerValue + 1000                'Bump Spinner Value
'        Case 17:bBonusHeld = True                                 'Bonus Held
'        Case 18:AddScore INT(RND * 9 + 1) * 200000                'Bigger Points
'        Case 19:AddScore INT(RND * 9 + 1) * 100000                'Big Points
'        Case 20:AwardSpecial                                      'Award Special
'        Case 21:SpinnerLevel = SpinnerLevel + 1                   'Advance Spinner Level
'        Case 22:AddBonusMultiplier 3                              'Advance Bonus X by 3X
'        Case 23:AddBonusMultiplier 1                              'Advance Bonus X by 1X
'        'Case 24:AddTime                                           'Add Time
'        Case 25                                                   'Lit Add A Ball
'            If bMultiBallMode Then
'                AddMultiball 1
'            Else
'                l57.State = 2
'            End If
'        Case 26:PKELevel = PKELevel + 300 '+300 PKE Level
'        Case 27:PKELevel = PKELevel + 100 '+100 PKE Level
'        Case 28:AddBonusMultiplier 3      '+3 Bonus X
'        Case 29:AddBonusMultiplier 2      '+2 Bonus X
'        Case 30:AddBonusMultiplier 1      '+1 Bonus X
'    End Select

    ResetBumpers
End Sub


'*******************
' Multiplier targets
'*******************


'**************************
' Right Scoop: TBD Rename
'**************************
Dim bLeftScoopSkip
Dim bLeftScoopSkip2
Sub LeftScoop_Hit()
    Dim tmp
  dim bSaveUpgradeState
  bSaveUpgradeState = bModeProgressUpgraded
    PlaySoundAt "fx_kicker_enter",LeftScoop
    If Tilted Then
        LeftScoopExit
        Exit Sub
    End If

  if bImmolationWait then bImmolationWait=False   ' Cleared the last ball on immolation

  ClearShotMultiplier(lStarLord_m)
  AddScore 5070
  BonusAddModeHit(8)

  CheckModeProgress "lStarLordArrow"  ' This will grab the last Starlord Hurry Up
  MultiplierShot = 1    ' Clear shot multiplier

debug.print "Scoop Hit: PlayerMode:" & PlayerMode & " MB:" & bMultiBallMode
  if tmrCherryBomb.Enabled Then ' Go into cherry bomb mode
    CherrySong
debug.print "Scoop Cherry"
  elseif tmrImmolation.Enabled then
    ' Do nothing
debug.print "Scoop Immolation"
  elseif tmrXandar.Enabled then
    ' Do nothing
debug.print "Scoop Xandar"
  elseif bSecondMode then
    ' Do nothing
debug.print "Scoop 2nd Mode"
  elseif PlayerMode = -1 and bMultiBallMode=False Then    ' If we are in multiball dont go into player select
    StopSound Song
    EnablePlayerSelect
    SelectPlayerMode LeftFlipperKey   ' Force them to select a mode
    UpdatePlayerMode()
    Exit Sub  ' Hold the ball until they select the next mode
  End if

  bLeftScoopSkip=False
    vpmtimer.addtimer 1000, "FlashLeftScoop '"
  if bModeProgressUpgraded <> bSaveUpgradeState then  ' They upgraded
    vpmtimer.addtimer 2000 + INT(RND * 2000), "if bLeftScoopSkip=False then FlipperSkipCmd="""":LeftScoopRumble '"
    SetFlipperSkipCmd "bLeftScoopSkip=True:LeftScoopExit '"     ' DONT FORGET TO CLEAR FlipperSkipCmd when you are past this stage
  Else
    vpmtimer.addtimer 2000, "if bLeftScoopSkip=False then FlipperSkipCmd="""":LeftScoopExit '"
    SetFlipperSkipCmd "bLeftScoopSkip=True:LeftScoopExit '"     ' DONT FORGET TO CLEAR FlipperSkipCmd when you are past this stage
  End If
End Sub

Sub FlashLeftScoop
    'FlashForms l5f, 1000, 40, 0
    'FlashForms LibraryFlasher, 1000, 40, 0
    DOF 206, DOFPulse
End Sub

Sub LeftScoopExit
  FlipperSkipCmd="" ' Clear it
  bFlash4Enabled = False
  PlaySoundVol "gg_Camera", VolDef
    leftScoop.Kick 217, 105
  leftScoopk.IsDropped = 0
    PlaySoundAt SoundFXDOF("fx_kicker", 123, DOFPulse, DOFContactors), LeftScoop
  vpmtimer.addtimer 100, "leftScoopK.IsDropped = 1 '"
End Sub

Sub LeftScoopRumble
  bFlash4Enabled = True
  if bNudgeShake then
    Nudge 90, 0.25
    vpmtimer.addtimer 200, "Nudge 270, 0.25 '"
  End If
  ' This is how Avatar does it and you can feel it

  'PlaySoundAtVol SoundFX("fmotor4", DOFGear), sw6, 0.31
  PlaySoundAtVol SoundFXDOF("fmotor4", 132, DOFOn, DOFGear), sw6, 0.31
  vpmtimer.addtimer 1000, "DOFGearStop '"

  PlaySoundVol "ShakeBass", VolDef
  PlaySoundVol "ShakeBass2", VolDef
  vpmtimer.addtimer 1000 + INT(RND * 2000), "LeftScoopExit '"
End Sub


Sub DOFGearStop()
  DOF 132, DOFOff
End Sub


Sub CheckGear() 'when all the gear is collected then start "Are you a god?" mode (mode 12)
    If Gear(1) + Gear(2) + Gear(3) + Gear(4) + Gear(5) = 5 Then
        StartAreYouaGod
    End If
End Sub

' Gear 1: Proton Pack
Sub CheckProtonTargets()
End Sub

Dim HoloPos, HoloDir, HoloStep, HoloRandom, HoloAngle
Sub HologramStop
End Sub

Sub HologramTimer_Timer()
End Sub

Sub HologramTimerExpired_Timer()
    HologramStop
End Sub

'******************
' Catching Ghosts
'******************
' to catch ghosts:

Sub LitRandomGhost() '9 lights. lits a random ghost light
    aCatchGhostLights(INT(RND * 8)).State = 1
End Sub

Sub LitAllGhosts()
    dim lamp
    For each lamp in aCatchGhostLights
        lamp.State = 1
    Next
End Sub


Sub tGrootRight_Hit
  DOF 115, DOFPulse
  if tGrootRight.UserValue = 0 then
    AddScore 26110
    SetLightColor l019, "yellow", 1
    tGrootRight.UserValue=1
    vpmtimer.addtimer 500, "tGrootStab 0'"      ' Add a little debounce (for debugger mostly)
  Else
    AddScore 8610
  End If
End Sub

Sub tGrootLeft_Hit
  DOF 115, DOFPulse
  if tGrootLeft.UserValue = 0 then
    AddScore 26110
    SetLightColor l023, "yellow", 1
    tGrootLeft.UserValue=1
    vpmtimer.addtimer 500, "tGrootStab 1'"
  Else
    AddScore 8610
  End If
End Sub

Sub tGrootStab(bIsRightStab)
  AddScore 10
  PlaySoundVol "gg_Lazer", VolDef
  If tGrootLeft.UserValue=1 and tGrootRight.UserValue=1 then
    if bIsRightStab then
      if BonusLaneSaver = 0 then    ' If you hit left then right stab
        BonusLaneSaver = 575000
      Else
        BonusLaneSaver = BonusLaneSaver + 20000
      End If
    else
      if BonusLaneSaver = 0 then    ' If you hit right then lefy
        BonusLaneSaver = 275000
      Else
        BonusLaneSaver = BonusLaneSaver + 10000
      End If
    End If

    SetLightColor lLaneSaver, "yellow", 2
    SetLightColor l019, "yellow", 0
    SetLightColor l023, "yellow", 0
    bLaneSaverEnabled = True
    tGrootLeft.UserValue = 0
    tGrootRight.UserValue = 0
  End If
  CheckModeProgress("switch")
End Sub

'Sub kLaneSaver_Hit
' vpmtimer.addtimer 100, "LaneSaverKick '"
'End Sub
'
'Sub LaneSaverKick()
' kLaneSaver.Kick -30, 40
' AddScore BonusLaneSaver
' BonusLaneSaver = 0
' SetLightColor lLaneSaver, "yellow", 0
' kLaneSaver.Enabled = False
'End Sub

Sub Target001_Hit()
  PlaySoundVol "gg_hadron", VolDef
End Sub

Sub tgHadron0_Hit()
  DOF 116, DOFPulse
  dim saveCnt:saveCnt=0
  if PlayerMode <> -1 then saveCnt = ModeProgress(PlayerMode)
  if tgHadron0.UserValue = 0 then
    PlaySoundVol "gg_hadron", VolDef
    SetLightColor lHadron0, "yellow", 2
    tgHadron0.UserValue = 1
    CheckModeProgress("tgHadron0")
    if PlayerMode <> -1 then              ' Add a base score if this didnt give progress
      if saveCnt = ModeProgress(PlayerMode) then AddScore 20000
    else
      AddScore 20000
    End If
    if PlayerMode=1 then BonusAddModeHit(1)       ' These are special when we are in ronan mode
    vpmtimer.addtimer 500, "CheckCount '"
  End If
End Sub
Sub tgHadron1_Hit()
  DOF 117, DOFPulse
  dim saveCnt:saveCnt=0
  if PlayerMode <> -1 then saveCnt = ModeProgress(PlayerMode)
  if tgHadron1.UserValue = 0 then
    PlaySoundVol "gg_hadron", VolDef
    SetLightColor lHadron1, "yellow", 2
    tgHadron1.UserValue = 1
    CheckModeProgress("tgHadron1")
    if PlayerMode <> -1 then              ' Add a base score if this didnt give progress
      if saveCnt = ModeProgress(PlayerMode) then AddScore 20000
    else
      AddScore 20000
    End If
    if PlayerMode=1 then BonusAddModeHit(1)       ' These are special when we are in ronan mode
    vpmtimer.addtimer 500, "CheckCount '"
  End if
End Sub
Sub tgHadron2_Hit()
  DOF 117, DOFPulse
  dim saveCnt:saveCnt=0
  if PlayerMode <> -1 then saveCnt = ModeProgress(PlayerMode)
  if tgHadron2.UserValue = 0 then
    PlaySoundVol "gg_hadron", VolDef
    SetLightColor lHadron2, "yellow", 2
    tgHadron2.UserValue = 1
    CheckModeProgress("tgHadron2")
    if PlayerMode <> -1 then              ' Add a base score if this didnt give progress
      if saveCnt = ModeProgress(PlayerMode) then AddScore 20000
    else
      AddScore 20000
    End If
    if PlayerMode=1 then BonusAddModeHit(1)       ' These are special when we are in ronan mode
    vpmtimer.addtimer 500, "CheckCount '"
  End If
End Sub
Sub tgHadron3_Hit()
  DOF 118, DOFPulse
  dim saveCnt:saveCnt=0
  if PlayerMode <> -1 then saveCnt = ModeProgress(PlayerMode)
  if tgHadron3.UserValue = 0 then
    PlaySoundVol "gg_hadron", VolDef
    SetLightColor lHadron3, "yellow", 2
    tgHadron3.UserValue = 1
    CheckModeProgress("tgHadron3")
    if PlayerMode <> -1 then              ' Add a base score if this didnt give progress
      if saveCnt = ModeProgress(PlayerMode) then AddScore 20000
    else
      AddScore 20000
    End If
    if PlayerMode=1 then BonusAddModeHit(1)       ' These are special when we are in ronan mode
    vpmtimer.addtimer 500, "CheckCount '"
  End if
End Sub
Sub tgHadron4_Hit()
  DOF 119, DOFPulse
  dim saveCnt:saveCnt=0
  if PlayerMode <> -1 then saveCnt = ModeProgress(PlayerMode)
  if tgHadron4.UserValue = 0 then
    PlaySoundVol "gg_hadron", VolDef
    SetLightColor lHadron4, "yellow", 2
    tgHadron4.UserValue = 1
    CheckModeProgress("tgHadron4")
    if PlayerMode <> -1 then              ' Add a base score if this didnt give progress
      if saveCnt = ModeProgress(PlayerMode) then AddScore 20000
    else
      AddScore 20000
    End If
    if PlayerMode=1 then BonusAddModeHit(1)       ' These are special when we are in ronan mode
    vpmtimer.addtimer 500, "CheckCount '"
  End If
End Sub

Sub CheckCount()
  ' Whichever one is flashing is the one we hit (make it solid)
  Dim state:state = 1
  if PlayerMode = 1 then state = 0    ' RONAN level inverts the state when hit

  if (lHadron0.state =2) Then lHadron0.State = state
  if (lHadron1.state =2) Then lHadron1.State = state
  if (lHadron2.state =2) Then lHadron2.State = state
  if (lHadron3.state =2) Then lHadron3.State = state
  if (lHadron4.state =2) Then lHadron4.State = state

'debug.print "HadronCheck:" & tgHadron0.UserValue & " " & tgHadron1.UserValue & " " & tgHadron2.UserValue  & " " & tgHadron3.UserValue  & " " & tgHadron4.UserValue
  AddScore 6110   ' Add default points for hadron
  'HadronCount = HadronCount+1
  If tgHadron0.UserValue = 1 and tgHadron1.UserValue = 1 and tgHadron2.UserValue =1 and tgHadron3.UserValue = 1 and tgHadron4.UserValue = 1 Then
    HadronEnforcerCount=HadronEnforcerCount + 3
    HadronFlash "", True
    PlaySoundVol "gg_quote3", VolDef
    tgHadron0.UserValue = 0
    tgHadron1.UserValue = 0
    tgHadron2.UserValue = 0
    tgHadron3.UserValue = 0
    tgHadron4.UserValue = 0
    SetLightColor lHadron0, "yellow", 0
    SetLightColor lHadron1, "yellow", 0
    SetLightColor lHadron2, "yellow", 0
    SetLightColor lHadron3, "yellow", 0
    SetLightColor lHadron4, "yellow", 0
    'HadronCount = 0
    AddScore 20000    ' 20k for lighting hadron  ' Manual test with no mode it was 75000
  End if
End Sub


Sub FakeHadronHit(LightName)
  bDebounce=False             ' Skip debounce so we can slam through these really quickly
  BonusAddModeHit(GetBonusIndex(LightName))
  CheckModeProgress(LightName)
End Sub

Sub CheckHadron(bUseIt)   ' Execute the Hadron Endorcer if we have one
  Dim bUsed
  Dim a
  bUsed = False
  If (HadronEnforcerCount>0) Then
    ' Execute Hadron Enforcer For Wizard Modes
    If tmrCherryBomb.Enabled Then
      For each a in aRampLights   ' Hit the Blinking ones
        if a.state = 2 and Not (a.name = "lgr_a" and CherryBombCount=9) Then  ' Spot everything except Final shot
          bUsed=True
          if bUseIt then FakeHadronHit a.name
          exit for
        End if
      Next
    elseif tmrImmolation.Enabled Then
      For each a in aRampLights   ' Hit the Blinking ones
        if a.state = 2 Then
          bUsed=True
          if bUseIt then FakeHadronHit a.name
          exit for
        End if
      Next
    elseif tmrXandar.Enabled Then
      if lYonduArrow.state = 2 then     ' Prioritize Yando
        bUsed=True
        if bUseIt then FakeHadronHit "lYonduArrow"
      elseif lStarLordArrow.state = 2 then  ' Prioritize StarLord
        bUsed=True
        if bUseIt then FakeHadronHit "lStarLordArrow"
      else                ' Do others
        For each a in aRampLights   ' Hit the Blinking ones
          if a.state = 2 Then
            bUsed=True
            if bUseIt then FakeHadronHit(a.name)
            exit for
          End if
        Next
      end if
    End if

    ' Execute Hadron Enforcer For Standard Modes
    Select Case PlayerMode
      case -1:' No Mode Selected
      Case 0: ' Nebula - Pod Chase (10 shots)
        If ModeProgress(PlayerMode) >= 10 Then
          'TBD: What does it do when mode is done?
        else
          For each a in aRampLights
            if a.state <> 0 Then
              bUsed=True
              if bUseIt then FakeHadronHit a.name
              exit for
              ' TBD Prioritize the ones that are blinking
            End if
          Next
        End If
      Case 1: ' Ronan - Sanctuary (5 shots)
        ' Rules say you cant use Hadrons in Sanctuary
'       If ModeProgress(PlayerMode) >= 5 Then
'         'TBD: What does it do when mode is done?
'       else
'         For each a in aHadrons
'           if a.IsDropped = False then
'             if bUseIt then a.IsDropped = True
'             'tgHadron0_Dropped  - Hopefully this gets triggered automatically when I drop it
'             bUsed=True
'             Exit For
'           End If
'         Next
'         if (bUsed=False) Then
''            LastSwitchHit="sw12"
'           if bUseIt then FakeHadronHit "lRonanArrow"
'           bUsed = True
'         End if
'       End If
      Case 2: ' Yandu - Yaka Arrow (8 shots)
        If ModeProgress(PlayerMode) >= 8 Then
          'TBD: What does it do when mode is done?
        else
          if (bModeProgressUpgraded = False) Then
            if bUseIt then FakeHadronHit "lStarLordArrow"
            bUsed = True
          Else
            if bUseIt then FakeHadronHit "lYonduArrow"
            bUsed = True
'           For each a in aRampLights       ' Upgrade to blinking
'             if a.state <> 0 then
'               CheckModeProgress a.name
'               bUsed = True
'               Exit For
'             End If
'           Next
          End If
        End If
      Case 3: ' Star Lord - Quills Quest (12 shots)
        If ModeProgress(PlayerMode) >= 12 Then
          'TBD: What does it do when mode is done?
        else
          if (bModeProgressUpgraded = False) Then
            if bUseIt then FakeHadronHit "lStarLordArrow"
            bUsed = True
          Else
            For each a in aRampLights       ' Upgrade to blinking
              if a.state <> 0 then
                if bUseIt then FakeHadronHit a.name
                bUsed = True
                Exit For
              End If
            Next
          End If
        End If
      Case 4: ' Drax - Knowhere (8 shots)
        If ModeProgress(PlayerMode) >= 8 Then
          'TBD: What does it do when mode is done?
        else
          if (bModeProgressUpgraded = False) Then
            if bUseIt then FakeHadronHit "lStarLordArrow"
            bUsed = True
          Else
            if bUseIt then FakeHadronHit "lRonanArrow"
            bUsed = True
          End If
        End If
      Case 5: ' Rocket - Escape Kyln (7 shots, Hadron Enforcer works on all except Rocket)
        If ModeProgress(PlayerMode) >= 7 Then
          'TBD: What does it do when mode is done?
        else
          if lgr_a.state <> 0 then ' Hit Groot for them
            if bUseIt then FakeHadronHit "lgr_a"
            bUsed = True
          elseif ModeProgress(PlayerMode) < 6 then ' Last one must be RocketKicker and cant use Hadron on it
            if bUseIt then FakeHadronHit "lRocketArrow"
            bUsed = True
          End If
        End If
      Case 6: ' Gamora - Siblng Rvlry (10 shots)
        If ModeProgress(PlayerMode) >= 10 Then
          'TBD: What does it do when mode is done?
        else
          if (bModeProgressUpgraded = False) Then
            if bUseIt then FakeHadronHit "lStarLordArrow"
            bUsed = True
          Else
            For each a in aRampLights       ' Upgrade to blinking
              if a.state <> 0 then
                if bUseIt then FakeHadronHit a.name
                bUsed = True
                Exit For
              End If
            Next
          End If
        End If
      Case 7: ' Broker - Antique Shop (7 shots)
        If ModeProgress(PlayerMode) >= 7 Then
          'TBD: What does it do when mode is done?
        else
          if bUseIt then FakeHadronHit "lBrokerArrow"
          bUsed = True
        End If
    End Select

debug.print "HadronCheck cnt:" & HadronEnforcerCount & " used:" & bUsed & " useIt:" & bUseIt
    If bUsed and bUseIt Then
      pDMDEvent(kDMD_UseHadron)
      'PlaySound "Lightning-5"
      PlaySoundVol "Hadron-Arrow2", VolDef
      HadronEnforcerCount = HadronEnforcerCount - 1
      if HadronEnforcerCount <= 0 Then
        HadronFlash "", False
      End If
    Elseif bUseIt = False then    ' See if we would have used the Hadron
      if HadronEnforcerCount <= 0 Then
        HadronFlash "", False
      End If
'     if bUsed then
'       HadronFlash "", True
'     else
'       HadronFlash "", False
'     End If
    End If
  End If
End Sub

'******************************************
'  Groot Lock & Multiball (GrootMB)
'******************************************

Sub OrbHurryUpFinish()
  OrbMultiBallProgress = 0
  if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Timer", "" ,1,""
  if tmrOrbHurryUp.UserValue < 50000 then tmrOrbHurryUp.UserValue = 500000
  if bUsePUPDMD then pupDMDDisplay "-", "Orb Bonus" & "^" & tmrOrbHurryUp.UserValue, "" ,2, 0, 10
  AddScore tmrOrbHurryUp.UserValue
  OrbMBJackpot = OrbMBJackpot + tmrOrbHurryUp.UserValue
  tmrOrbHurryUp.Enabled = False

  ' Start Ball Saver
  BallSaverTimerCancel
  bBallSaverReady = True

  if OrbTarget1.IsDropped = False then  ' They didnt hit the drop target so drop it for them and let the ball go
    OrbTarget1.IsDropped = True
  End If
  LoopGateLeft.Open = False               ' Close back gate
  vpmtimer.addtimer 1500, "OrbTargetReset '"
  vpmtimer.addtimer 2000, "EnableOrb(False) '"    ' Disable the orb target once it has had time to drop

  ' Setup Lights for bonus shots
  dim a
  For each a in aRampLights
    SSetLightColor kStack_Pri1, a, "purple", 2
    'a.Intensity = 100
  Next
End Sub


Sub tmrOrbHurryUp_Timer()
  if tmrOrbHurryUp.UserValue > 500000 then
    tmrOrbHurryUp.UserValue=tmrOrbHurryUp.UserValue - 4210
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Timer",  tmrOrbHurryUp.UserValue ,1,""
  Else
    OrbHurryUpFinish
  End If
End Sub

dim bOrbRealHit:bOrbRealHit=False
Sub OrbTarget1_Hit()
  bOrbRealHit=True
End Sub

Sub OrbTarget1_Dropped()  ' Drop the Target In front of the ORB
' PlaySoundVol SoundFXDOF("fx_Target",133,DOFPulse,DOFContactors), VolDef     ' James DOF Removed
  if bGrootMultiball then
'debug.print "bGrootMultiball"
    OrbTarget1.isDropped = False
    bOrbRealHit=False
    exit sub ' Cant start or Make progress during MB or CherryBomb
  End if

debug.print "OrbTarget1_Dropped" & bOrbRealHit
  ' Check Broker Arrow
  if bOrbRealHit then tBroker_m_Hit   ' Only real hits trigger score
  If tmrSkillshot.Enabled and StackState(kStack_Pri3).GetArrowState(lBrokerArrow) = 2 Then    ' Hold Left, Loop around and hit Orb, Right Ramp or Right Orbit
    AddScore 1000000
    DOF 127, DOFPulse
    PlaySoundVol "gg_SkillShot", VolDef
    DOF 325, DOFPulse     ' James DOF

    QueueScene "ScenePlayMessage ""SkillShot.mp4"", """","""",""1000000"" '", 2000, 1
    QueueScene "SceneClearPlayMessage '", 0, 1

  End If

  if (bQuillsQuestFirstTime=False and PlayerMode = 3) or (bOrbMultiBall and bOrbDisabled) then  ' Stop the Orb drop when Arrows are lit
    OrbTarget1.isDropped = False
    bOrbRealHit=False
    Exit Sub
  End if

  if OrbMultiBallCount >= 2 then            ' TBD Need to make it take 2 hits to drop after the second round
    if OrbTarget1Toggle then
      OrbTarget1Toggle=False
    Else
      OrbTarget1Toggle=True
      OrbTarget1.isDropped = False
      bOrbRealHit=False
      Exit Sub
    End If
  End If

  if bGameInPlay = False then exit sub  ' Init reset target triggers this

  LightShootOrb.State = 2
  if OrbMultiBallProgress = 3 and tmrOrbHurryUp.Enabled Then      ' They hit it before the timer, start 3 multiball (otherwise you ony get the 2)

    if ExtraBallsAwards(CurrentPlayer) = 0 and PlayerState(CurrentPlayer).bExtraball_1=False then  ' You get extra ball for first MB
      PlayerState(CurrentPlayer).bExtraball_1 = True
      AwardExtraBall
    End If

    'OrbMultiBallCount=OrbMultiBallCount+1            ' Should set this unless we complete
    RealBallsInLock=RealBallsInLock-1

    OrbHurryUpFinish

    AddMultiball 1                        ' Add 3rd Multiball
        ' we kick the ball with the autoplunger
        bAutoPlunger = True
  elseif bOrbRealHit Then
    playmedia "Video-0x008D.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
    DOF 133, DOFPulse     ' James DOF
  end if

  if bOrbRealHit then
    CheckModeProgress("switch")
    AddScore 20030
    BonusAddModeHit(5)
  End if
  bOrbRealHit=False
End Sub

dim bOrbDebounce  ' This is so you cant hit it twice (usually only happens in the debugger)
bOrbDebounce = False
Sub OrbTarget2_Dropped()  ' Hit the target inside the ORB
' PlaySoundVol SoundFXDOF("fx_Target",133,DOFPulse,DOFContactors), VolDef   ' James DOF Removed
  PlaySoundVol SoundFX("fx_Target", DOFContactors), VolDef
  dim waittime

  ' Check Broker Arrow
  tBroker_m_Hit

  if (bOrbDebounce) then Exit Sub   ' Bail (Changed to dropped instead of hit event..might not need this anymore)
  if (tmrXandar.Enabled) Then     ' Save Xandar doesnt trigger OrbProgress
    OrbTarget2.IsDropped = False
    Exit Sub
  End If
  if tmrCherryBomb.Enabled then     ' Cherry bomb doesnt do ORB
    OrbTarget2.IsDropped = False
    Exit Sub
  End If

  bOrbDebounce = True
  OrbMultiBallProgress = OrbMultiBallProgress + 1

  OrbTarget1.IsDropped = False
  AddScore 100000

  if (OrbMultiBallProgress = 1) then
    playmedia "Video-0x00AF.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
    DOF 321, DOFOn      ' James DOF
    waittime = 2000
  elseif (OrbMultiBallProgress = 2) then
    playmedia "Video-0x002A.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
    DOF 322, DOFOn      ' James DOF
    waittime = 2000
    SetLightColor lBrokerName, "white", 2
  elseif (OrbMultiBallProgress >= 3) Then
    playmedia "Video-0x008F.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1
    DOF 323, DOFOn      ' James DOF
    'aRampLightsSave
    PlayDMDScene "vidOrbOpen.mp4", 3000

    bOrbMultiBall=True
    StackState(kStack_Pri1).Enable(10)
    SetLightColor Light033, "purple", 2   ' Flash Orb Multiball on lower playfield
    GrootMouth_Drop(False)          ' Close Groots Mouth in case it is open

    OrbOpen()
    waittime = 2000 ' Wait for the clip to finish playing
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Timer",  "2000000" ,1,""
  End If

  ' Play Light Sequence
  dim a
  For each a in aRampLights
    SetLightColor a, "purple", -1
    a.Intensity = 100
  Next
  GiOff
  LightSeqOrb.Play SeqCircleInOn, 100, 2
  PlaySoundVol "gg_Orb2", VolDef

  vpmtimer.addtimer waittime, "OrbPauseDone'"
  CheckModeProgress("switch")
End Sub

Sub OrbPauseDone()  ' Drop ball after effects
  bOrbDebounce=False
  GiOn
  OrbLightReset ' Put lights back after show

  if (OrbMultiBallProgress <= 2) Then   ' Release ball
    DOF 321, DOFOff           ' James DOF
    DOF 322, DOFOff
    DOF 323, DOFOff
    PlaySoundVol "gg_OrbReleaseBall", VolDef
    LightShootOrb.State = 0
    SetLightColor lMagnet, "white", 1
    mMagnaSave.MagnetOn = True      ' Turn on magna force
    DOF 142, DOFOn
    OrbTarget1.IsDropped = True

    vpmtimer.addtimer 1500, "OrbTargetReset '"
    vpmtimer.addtimer 2500, "OrbMagnetOff '"
  end if

  if (OrbMultiBallProgress = 3) Then        ' Third time dont release the ball (They have to hit it to start 3 multiball)
    PlaySoundVol "Bells", VolDef
    SSetLightColor kStack_Pri1, lBrokerArrow, "purple", 2
    LightSeqOrb.Play SeqRandom, 100, ,4000
    RealBallsInLock=RealBallsInLock+1

    ' Stop ballsaver if it is currently running
    BallSaverTimerCancel
    ' Setup new Ball Saver
    'BallSaverTime = 60
    bBallSaverReady = True

    LoopGateLeft.Open = True      ' Open Back gate for Hurry up

    tmrOrbHurryUp.UserValue = 2000000 + (500000 * OrbMultiBallCount)  ' 500K additional for each time you completed OrbMB
    vpmtimer.addtimer 3500, "tmrOrbHurryUp.Enabled = True '"    ' Start the Hurry Up (after the ball gets to the top)
    AddMultiball 1                          ' Add Second Multiball
        ' we kick the ball with the autoplunger
        bAutoPlunger = True
    'vpmtimer.addtimer 1000, "OrbLightReset '"  ' Turn the light back to normal
  End If
End Sub

Sub OrbLightReset()
  ' Put the arrows back to their original color
  dim a
  for each a in aRampLights
    SetLightColorRestore a, -1
    'SetLightColor a, modeRampColor, -1
    a.Intensity = 10
  Next
End Sub

sub OrbMagnetOff()
  mMagnaSave.MagnetOn = False
  DOF 142, DOFOff
  SetLightColor lMagnet, "white", 0
End Sub

Sub OrbTargetReset()  ' Put the target back up after we release the ball
  OrbTarget1.IsDropped = False
  OrbTarget2.IsDropped = False
End Sub

Sub OrbOpen()
  if (OrbRight.X < 636) Then
    OrbRight.X = OrbRight.X+2
    OrbLeft.X = OrbLeft.X-2
    vpmtimer.addtimer 100, "OrbOpen'"
  End If
End Sub

Sub OrbClose()
  if (OrbRight.X > 628) Then
    OrbRight.X = OrbRight.X-2
    OrbLeft.X = OrbLeft.X+2
    vpmtimer.addtimer 100, "OrbClose'"
  End If
End Sub

Sub OrbSuperJackpotExpired()
  Debug.print "Orb Super Jackpot Expired"
  OrbMBJackpotHits=0
  ' Setup Lights for bonus shots
  dim a
  For each a in aRampLights
    SSetLightColor kStack_Pri1, a, "blue", 2
    'SetLightColor a, "blue", 2
    a.Intensity = 100
  Next
End Sub

Sub EnableOrb(bEnabled)
  bOrbDisabled=(bEnabled = False)
  OrbTarget1Disabled.Collidable = (bEnabled = False)
End Sub

Sub StopOrbMultiball()
  if RealBallsInLock<>0 then RealBallsInLock=RealBallsInLock-1    ' TBD: Check if this is groot or ORB??
  EnableOrb(True)
  ShowPlayerModeComplete(1) ' Show ORB MB Total
  bOrbMultiBall=False
  StackState(kStack_Pri1).Disable
  OrbMultiBallProgress=0
  LightSeqOrb.StopPlay()
  OrbTarget1.IsDropped = True
  'SetLightColor Light033, "purple", 0      ' Didnt Finish, it just stays flashing
  if tmrOrbHurryUp.Enabled then ' Lost the before timer ran down (Release the Locked ones)
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"Timer", "" ,1,""
    tmrOrbHurryUp.Enabled = False
    if bUsePUPDMD then pupDMDDisplay "-", "Orb Bonus" & "^500000", "" ,2, 0, 10
    AddScore 500000
  End If
  aRampLightsRestore    ' Put the arrows back to their original color
  SetLightColor lBrokerName, "cyan", 0
  'SetLightColorRestore lBrokerName, -1
  vpmtimer.addtimer 1000, "OrbTargetReset' "
  CheckWizardModesReady
  OrbClose
End Sub

Sub tmrGrootMBBonus_Timer()
Dim i
debug.print "Groot MB Timer " & tmrGrootMBBonus.UserValue

  tmrGrootMBBonus.UserValue = tmrGrootMBBonus.UserValue - 1
  if bGrootBonus3x then
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"MTimer", "3X FOR " & tmrGrootMBBonus.UserValue ,1,""
  Else
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"MTimer", "2X FOR " & tmrGrootMBBonus.UserValue ,1,""
  End If
  if tmrGrootMBBonus.UserValue = 0 then
    if (bGrootBonus3x) Then       ' Clear 3x or 2x Play Multipliers
      AddPlayMultiplier 1/3
    Else
      AddPlayMultiplier 1/2
    End If
    bGrootBonus3x = False
    tmrGrootMBBonus.Enabled = False
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"MTimer", ""  ,1,""

    If BallsInLock <> 0 and bGrootMultiball then      ' During MB if we lock any balls we let the go after the timer runs out (If we are still in MB)
debug.print "Groot MB Release " & BallsInLock
      bBallSaverReady = True    ' Turn On Ball Saver
      EnableBallSaver BallSaverTime
      GrootMouth_Drop(True)
      for i = 0 to BallsInLock - 1
        BallsInLock = BallsInLock -1
        vpmtimer.addtimer 1000 + (i*200), "CreateNewBallGroot() '"
      Next
      tmrGrootMouthClose.Interval = 2000
      tmrGrootMouthClose.Enabled = True
    End If

  End If
End Sub

Sub tmrGrootMouth_Timer     ' This actually drops the mouth
  if tmrGrootMouth.UserValue = True Then      ' Drop
    if GrootMouth.z > -30 then
      GrootMouth.z = GrootMouth.z - 5
    Else
      GrootMouth.z = -30
      tmrGrootMouth.Enabled = False
      GrootMouth.Collidable = False
    End If
  Else                    ' Close
    if GrootMouth.z < 19.33 then
      GrootMouth.z = GrootMouth.z + 8
    Else
      'GrootMouth.z = 19.33
      tmrGrootMouth.Enabled = False
    End If
  End If
End Sub

Sub GrootMouth_Drop(value)
  if Value = True Then
    tmrGrootMouth.UserValue = True
    tmrGrootMouth.Enabled = True
  Elseif Value = False Then
    tmrGrootMouth.UserValue = False
    GrootMouth.Collidable = True  ' As it is going up make it collidable
    tmrGrootMouth.Enabled = True
  End If
End Sub

Function GrootMouth_IsDropped()
  GrootMouth_IsDropped = tmrGrootMouth.UserValue
End Function

Sub GrootMouth_Hit()
  ' Default stuff we do every time
  DOF 120, DOFPulse
  CheckModeProgress("lgr_a")
  CheckModeProgress("switch")
  LastSwitchHit="tGroot_m"
  AddScore 1510       ' Default Score
  BonusAddModeHit(4)

  if tmrImmolation.Enabled then Exit Sub  ' Immolation cant drop the mouth
  if tmrCherryBomb.Enabled then Exit Sub  ' Cherry Bomb cant drop the mouth
  if tmrXandar.Enabled  then Exit Sub   ' Save Xandar cant do Groot MB
  if bQuillsQuestFirstTime = False and PlayerMode = 3 then Exit Sub ' Quills Quest Cant drop mouth on MB

  if bOrbMultiBall then Exit Sub  ' Cant do Groot mouth during OrbMB

'debug.print "Groot MB:" & bGrootMultiball & " " & GrootMBLocks

  if (bGrootMultiball) then   ' If we are in MultiBall dont open (confusing here Video doesnt open but rules say it does)
    if GrootMBJackpotCnt=9 or GrootMBJackpotCnt=18 Then
      AddScore 3000000
      GrootMBJackpot = GrootMBJackpot + 3000000
    end if
    if GrootMBLocks >= 3 or bGrootBonus3x then Exit Sub ' You only get 3 locks during MB.  If you have 3x then you have to wait until it is done to get your third lock
  End If

  PlayDMDScene "vidGrootLockIsLit.mp4", 4000
  pDMDEvent(kDMD_GrootLockIsLit)
  PlaySoundVol "GrootHit1-284", VolDef
  if (GrootMultiBallCount >=2) then   ' On the 3rd MultiBall you have to hit the mouth twice
    if (GrootMultiBallToggle=True) Then     '2nd time do it
      GrootMouth_Drop(True)
      tmrGrootMouthClose.Interval = 1000
      DOF 120, DOFPulse           ' James DOF
      GrootMultiBallToggle = False
    Else                    '1st time skip
      GrootMultiBallToggle = True
    end If
  else                  ' Others just drop it the first time
    GrootMouth_Drop(True)
    tmrGrootMouthClose.Interval = 1000
  End If

' if (GrootMouth_IsDropped) Then
'   AddScore 250000
'   Dim a
'   aLightsSave
'   For each a in aRampLights
'     SetLightColor a, "green", -1
'     a.Intensity = 100
'   Next
'   GiOff
'   LightSeqGroot.Play SeqCircleInOn, 12, 0
'   LightSeqGroot.Play SeqWiperLeftOn, 45
' End If
  SetLightColor lgr_mb, "white", 2
  vpmtimer.addtimer 1500, "GrootMouthDone'"

End Sub

Sub PlayGrootMBLightSeq()
  playmedia "Video-0x0084.mp4", "PupVideos", pOverVid, "", -1, "", 1, 1   ' TBD Play the full groot video  Video-0x00B0.mp4

  if bCompetitionMode = False then  ' Shortened because people thought it took too long
    PlayGrootMBLightSeqShort
    Exit Sub
  End if

  ' This is what the original game does
  Dim interval:interval=8
  dim angle:angle=10
  dim j
  for j = 0 to 6
    LightSeqGroot.UpdateInterval = interval
    LightSeqGroot.Play SeqRightOn, angle,0,0
    LightSeqGroot.UpdateInterval = interval
    LightSeqGroot.Play SeqLeftOn, angle,0,0
  next
  LightSeqGroot.UpdateInterval = 5
  LightSeqGroot.Play SeqRandom, 20, ,3000
  GrootMouth_Drop False   ' Close the Mouth
End Sub

Sub PlayGrootMBLightSeqShort()
  Dim interval:interval=8
  dim angle:angle=10
  dim j
  for j = 0 to 3
    LightSeqGroot.UpdateInterval = interval
    LightSeqGroot.Play SeqRightOn, angle,0,0
    LightSeqGroot.UpdateInterval = interval
    LightSeqGroot.Play SeqLeftOn, angle,0,0
  next
  LightSeqGroot.UpdateInterval = 5
  LightSeqGroot.Play SeqRandom, 20, ,1000
  SetFlipperSkipCmd "LightSeqGroot.StopPlay:LightSeqGroot_Playdone '"   ' DONT FORGET TO CLEAR FlipperSkipCmd when you are past this stage
  GrootMouth_Drop False   ' Close the Mouth
End Sub

Sub LightSeqGroot_Playdone()
  FlipperSkipCmd="" ' Clear it
' Dim str
' str = "IAmGroot" & INT(RND * 10) + 1
  vpmtimer.addtimer 100, "PlaySoundVol ""IAmGroot1"", VolDef '"
  SetFlipperSkipCmd "tmrIAmGroot.UserValue=""GROOT"" '"         ' DONT FORGET TO CLEAR FlipperSkipCmd when you are past this stage
  tmrIAmGroot.UserValue = "I"
  tmrIAmGroot.Enabled = True
End Sub

Sub tmrIAmGroot_Timer()
  DOF 321, DOFOff   ' James DOF
  DOF 322, DOFOff
  DOF 323, DOFOff
  DOF 324, DOFOff

  Select case tmrIAmGroot.UserValue
    case "I"
      if GrootMouth.z > 0 then
        GrootMouth.z = GrootMouth.z - 5
      Else
        tmrIAmGroot.UserValue = "I-close"
        DOF 310, DOFPulse         ' James DOF
      End If
    case "I-close"
      if GrootMouth.z < 19.4 then
        GrootMouth.z = GrootMouth.z + 5
      Else
        tmrIAmGroot.UserValue = "Pause1"
      End If
    case "Pause1"
      tmrIAmGroot.UserValue = "AM"
      DOF 311, DOFPulse           ' James DOF
    case "AM"
      if GrootMouth.z > -10 then
        GrootMouth.z = GrootMouth.z - 5
      Else
        tmrIAmGroot.UserValue = "AM-close"
      End If
    case "AM-close"
      if GrootMouth.z < 19.4 then
        GrootMouth.z = GrootMouth.z + 5
      Else
        tmrIAmGroot.UserValue = "Pause2"
      End If
    case "Pause2"
      tmrIAmGroot.UserValue = "Pause3"
    case "Pause3"
      tmrIAmGroot.UserValue = "GROOT"
    case "GROOT"
      DOF 312, DOFPulse           ' James DOF
      FlipperSkipCmd="" ' Clear it
      if GrootMouth.z > -30 then
        GrootMouth.z = GrootMouth.z - 5
      Else
        GrootMouth.z = -30
        tmrIAmGroot.Enabled = False
        GrootMouth.Collidable = False
        tmrGrootMouth.UserValue = True
        vpmtimer.addtimer 1000, "StartGrootMB '"
      End If
  End Select
End Sub

Sub PlayGrootLockLightSeq()
  DOF 133, DOFOff           ' James DOF
  SetLightColor lgr_mb, "white", 0
  LightSeqGrootLock.UpdateInterval = 4
  LightSeqGrootLock.Play SeqUpOn, 100, 0
  LightSeqGrootLock.Play SeqUpOn, 100, 0
End Sub

Sub GrootMouthDone()
  'SetLightColor lgr_a, "green", 0
  'SetLightColor lgr_m, "green", 0
  'SetLightColor lgr, "green", 0
'debug.print "Balls In Lock Mouth Done:" & BallsInLock
  if (BallsInLock=0) then
    SetLightColor lgr_1, "green", 2
  elseif (BallsInLock=1) then
    SetLightColor lgr_2, "green", 2
  elseif (BallsInLock=2) then
    SetLightColor lgr_3, "green", 2
  elseif (BallsInLock=3) then
    SetLightColor lgr_4, "green", 2
  end if
End Sub

Sub tmrGrootMouthClose_Timer()
  if bGrootMultiball then
    OrbMagnetOff
  End If

  GrootMouth_Drop(False)
  tmrGrootMouthClose.Enabled = False
End Sub


'Sub GrootKicker_Hit()
' GrootKicker.DestroyBall
' BallsOnPlayfield = BallsOnPlayfield - 1
' GrootMouth.IsDropped = False
' GrootMouth.TimerEnabled = False
' CreateNewBall()
' 'score 20:BallsUsed=BallsUsed-1:DMD.AddMessage "","*** Skee Balls "&Skeeballs-BallsUsed&" Left ***",1050,""
'   'K20.State=LightStateOn:playsound "targ":CheckSkee:Kicker20.DestroyBall:SkeeKicker.CreateBall:SkeeKicker.kick 0,0
'End Sub

Sub GrootKicker_Hit()
    Dim waittime
    waittime = 100
  CheckModeProgress("GrootKicker")
  GrootKicker.DestroyBall
  BallsOnPlayfield = BallsOnPlayfield - 1
  if tmrCherryBomb.Enabled Then Exit Sub    ' Cherry Bomb final shot so bail out

  PlaySoundVol "gg_lazer", VolDef
  BallsInLock = BallsInLock + 1
  if bGrootMultiball then GrootMBLocks = GrootMBLocks + 1
'debug.print "Balls In Lock:" & BallsInLock
  Select Case BallsInLock
    Case 1
      pDMDEvent(kDMD_GrootBallLock1)
      DMD "", CL(1, "BALL 1 LOCKED"), "", eNone, eBlinkFast, eNone, 1000, True, "say-GrootLock1"
      DOF 321, DOFOn        ' James DOF
      if bGrootMultiball then
        bGrootBonus3x = False
        tmrGrootMBBonus.Enabled = True
        tmrGrootMBBonus.UserValue = 20
        PlaySoundVol "2xMultiplier", VolDef
        AddPlayMultiplier 2
      End if
      GrootMouth_Drop(False)
      SetLightColor lgr_1, "green", 1
      AddScore 100000
      GiOff
      PlayGrootLockLightSeq
      'bBallSaverReady = True
      bAutoPlunger = True
      if (tmrGrootMBBonus.Enabled=False) then vpmtimer.addtimer 2000, "AddMultiballFast(1) '"  ' Dont create a ball if already in MB, timer allows video to play
    Case 2
      pDMDEvent(kDMD_GrootBallLock2)
      DMD "", CL(1, "BALL 2 LOCKED"), "", eNone, eBlinkFast, eNone, 1000, True, "say-GrootLock2"
      DOF 322, DOFOn        ' James DOF
      if bGrootMultiball then
        if tmrGrootMBBonus.Enabled and bGrootBonus3x=False then
          bGrootBonus3x = True
          PlaySoundVol "3xMultiplier", VolDef
          AddPlayMultiplier 3/2         ' Remove the 2x and add the 3x
        Else
          PlaySoundVol "2xMultiplier", VolDef
          AddPlayMultiplier 2
        End If
        tmrGrootMBBonus.Enabled = True
        tmrGrootMBBonus.UserValue = 20
      End if
      GrootMouth_Drop(False)
      SetLightColor lgr_2, "green", 1
      AddScore 200000
      GiOff
      PlayGrootLockLightSeq
      'bBallSaverReady = True
      bAutoPlunger = True
      if (tmrGrootMBBonus.Enabled=False) then vpmtimer.addtimer 3000, "AddMultiballFast(1) '"  ' Dont create a ball if already in MB, timer allows video to play
    Case 3
      DMD "", CL(1, "BALL 3 LOCKED"), "", eNone, eBlinkFast, eNone, 1000, True, "say-GrootLock3"
      DOF 323, DOFOn        ' James DOF
      if GrootMultiBallCount = 0 then       ' First round of MB
        SetLightColor lgr_3, "green", 1
        PlayGrootMBLightSeq
      else                ' Other rounds take 4 hits
        pDMDEvent(kDMD_GrootBallLock3)
        SetLightColor lgr_3, "green", 1
        GrootMouth_Drop(False)
        AddScore 300000
        GiOff
        PlayGrootLockLightSeq
        'bBallSaverReady = True
        bAutoPlunger = True
        vpmtimer.addtimer 2000, "AddMultiballFast(1) '"  ' Timer allows video to play
      End If
    Case 4
      DMD "", CL(1, "BALL 4 LOCKED"), "", eNone, eBlinkFast, eNone, 1000, True, "say-GrootLock4"
      DOF 324, DOFOn        ' James DOF
      SetLightColor lgr_4, "green", 1
      GiOff
      PlayGrootMBLightSeq
  End Select

    'vpmtimer.addtimer waittime, "StorageLockExit '"
End Sub

Sub StartGrootMB() 'Multiball
  dim a, i, str
  StackState(kStack_Pri1).Enable(9)
  aRampLightsSave
  For each a in aRampLights                       ' Upgrade so all arrows are extra
    SSetLightColor kStack_Pri1, a, "green", 1
    i = GetModeIndex(a.name)
    if bIsModeComplete(i) Then    ' Light their name for 5x if they are done
      select case i
        case 0:
          Setlightcolor lNebulaName, "white", 2
        case 1:
          Setlightcolor lRonanName, "white", 2
        case 2:
          Setlightcolor lYonduName, "white", 2
        case 3:
          Setlightcolor lStarLordName, "white", 2
        case 4:
          Setlightcolor lDraxName, "white", 2
        case 5:
          Setlightcolor lRocketName, "white", 2
        case 6:
          Setlightcolor lGamoraName, "white", 2
        case 7:
          Setlightcolor lBrokerName, "white", 2
        case 8:
          Setlightcolor lgr, "white", 2
      End Select
    end if
  Next

  if ExtraBallsAwards(CurrentPlayer) = 0 and PlayerState(CurrentPlayer).bExtraball_1 = False then  ' You get extra ball for first MB
    PlayerState(CurrentPlayer).bExtraball_1 = True
    AwardExtraBall
  End If

' str = "IAmGroot" & INT(RND * 10) + 1
' vpmtimer.addtimer 1500, "PlaySoundVol """ & str & """, VolDef '"

  SetLightColor Light030, "green", 2  ' Flash Groot Multiball
    DMD "", CL(1, "SF MULTIBALL"), "", eNone, eBlinkFast, eNone, 1000, True, "vo_multiball"
  AddScore 200000
    BallsInLock = 0
    bGrootMultiball = True
  GrootMBLocks = 0
  EnableOrb(False)
  'OrbTarget1Disabled.Collidable = True
  GrootMBJackpot=0
  GrootMBJackpotCnt = 0
    SMBHits = 0
  SetLightColor lgr_1, "green", 0
  SetLightColor lgr_2, "green", 0
  SetLightColor lgr_3, "green", 0
  SetLightColor lgr_4, "green", 0
  DOF 321, DOFOff             ' James DOF
  DOF 322, DOFOff
  DOF 323, DOFOff
  ' TBD: Ramp Light are supposed to flash
  'LightSeqGates.Play SeqBlinking, 100, 7, 200


  bBallSaverReady = True        ' Usually this is done on the plunger but we do it here for the grootkicker
  EnableBallSaver BallSaverTime

  mMagnaSave.MagnetOn = True      ' Turn on magna force
  DOF 142, DOFOn

  GrootMultiBallCount = GrootMultiBallCount + 1
  vpmtimer.addtimer 100, "CreateNewBallGroot() '"
  vpmtimer.addtimer 200, "CreateNewBallGroot() '"
  vpmtimer.addtimer 300, "CreateNewBallGroot() '"
  if GrootMultiBallCount > 1 then           ' 4 Multiballs after the first round
    vpmtimer.addtimer 400, "CreateNewBallGroot() '"
  End If
  tmrGrootMouthClose.Interval = 1500
  tmrGrootMouthClose.Enabled = True
End Sub

Function EndGrootMB(checkRelease)
  EndGrootMB=False
  if bGrootMultiball then
debug.print "check Release: " & checkRelease & " pfBalls:" & BallsOnPlayfield & " lock:" &  BallsInLock & " GrootMBBonus:" & tmrGrootMBBonus.Enabled
    ' Release saved balls
    If BallsOnPlayfield=0 and BallsInLock <> 0 and tmrGrootMBBonus.Enabled then     ' During MB if we lock any balls we let them go once we drain (If we are still in MB)
debug.print "Groot MB Release " & BallsInLock
      GrootMouth_Drop(True)
      bBallSaverReady = True    ' Turn On Ball Saver
      EnableBallSaver BallSaverTime
      EndGrootMB=True
      if BallsInLock = 1 and checkRelease then  ' Go ahead and EndGrootMB but keep playing
        checkRelease = False
      End If
      for i = 0 to BallsInLock - 1
        BallsInLock = BallsInLock -1
        vpmtimer.addtimer 1000 + (i*200), "CreateNewBallGroot() '"
      Next
      tmrGrootMouthClose.Interval = 2000
      tmrGrootMouthClose.Enabled = True
    elseif BallsOnPlayfield=1 and BallsInLock <> 0 then   ' We stay in MB because when the ball releases normally we can play MB
      EndGrootMB=True
    End If
    if checkRelease then Exit Function        ' Bail out because we are just checking if we continue

debug.print "Ending GrootMB"
    dim a, i
    for each a in aNameLights ' Turn off the name lights
      a.state=0
    next
    Dim lamp
    StackState(kStack_Pri1).Disable
    aRampLightsRestore        ' Put light back to what they should be for mode (Hopefully)
    ShowPlayerModeComplete(0)   ' show Groot MB total
    bGrootMultiball = False

    GrootMBLocks = 0
    tmrGrootMBBonus.Enabled=False ' Disable the timer but leave whatever balls in there
    if bUsePUPDMD then puPlayer.LabelSet pBackglass,"MTimer", ""  ,1,""
    bGrootBonus3x=False
    bAutoPlunger=False
    EnableOrb(True)
    'OrbTarget1Disabled.Collidable = False
    ContainerFlasher1.Visible = 0
    ContainerFlasher2.Visible = 0
    ContainerFlasher3.Visible = 0
    ContainerFlasher4.Visible = 0
    ContainerFlasher5.Visible = 0
    ContainerFlasher6.Visible = 0
    DOF 321, DOFOff         ' James DOF
    DOF 322, DOFOff
    DOF 323, DOFOff
    DOF 324, DOFOff
    CheckWizardModesReady
  End if
'    For each lamp in aStorageLights
'        lamp.State = 0
'    Next
'    StopRainbow
End Function

Sub EndQuillMB()
  if PlayerMode=3 and bQuillsQuestFirstTime = False then    ' First time through you stop the mode
    bQuillsQuestFirstTime=True
    EnableOrb(True)
    'OrbTarget1Disabled.Collidable = False  ' Enable OrbMB
    StopPlayerMode
  End If
End Sub


Sub StorageLockExit()
    GrootKicker.Kick 180, 10
    DOF 114, DOFPulse
End Sub

Sub Wall034_Timer()
  Wall034.UserValue = Wall034.Uservalue -1
  if Wall034.UserValue=1 then
    RocketGun001.Rotx=5
    RocketHead001.Rotx=5
    RocketBody001.Rotx=5
  elseif Wall034.UserValue=0 then
    RocketGun001.Rotx=0
    RocketHead001.Rotx=0
    RocketBody001.Rotx=0
    Wall034.TimerEnabled = False
  End if
End Sub

Sub RocketKicker_Hit()
  ClearShotMultiplier(lRocket_m)
  AddScore 1110
  BonusAddModeHit(2)
  CheckModeProgress("switch")
  CheckModeProgress("lRocketArrow")

  RocketGun001.Rotx=10
  RocketHead001.Rotx=10
  RocketBody001.Rotx=10
  Wall034.TimerInterval=60
  Wall034.UserValue =1
  Wall034.TimerEnabled = True
  'tRocket_m_Hit  ' Old Trigger function that still has fucntionality
  vpmtimer.addtimer 50, "RocketKickerKick '"

  if SpellRampage < 4 Then
    SpellRampage=SpellRampage+1
    Select Case SpellRampage
      case 1:
        PlaySoundVol "gg_SpellG", VolDef
        puPlayer.LabelSet pBackglass,"Rampage","RAMP" ,1,""
        DisplayDMDText "RAMP","", 1000
      case 2:
        PlaySoundVol "gg_SpellG", VolDef
        DisplayDMDText "RAMPA","", 1000
        puPlayer.LabelSet pBackglass,"Rampage","RAMPA"  ,1,""
      case 3:
        PlaySoundVol "gg_SpellG", VolDef
        DisplayDMDText "RAMPAG","", 1000
        puPlayer.LabelSet pBackglass,"Rampage","RAMPAG" ,1,""
        SetLightColor lRocketArrow, "orange", 2
        SetLightColor l004, "orange", 2
      case 4:
        DisplayDMDText "RAMPAGE","", 1000
        puPlayer.LabelSet pBackglass,"Rampage","RAMPAGE"  ,1,""
        PlaySoundVol "gg_ImOnRampage", VolDef
        DisplayDMDText "2x BONUS","", 1000
        AddPlayMultiplier 2
        SetLightColor l004, "orange", 1
        'SetLightColor LightGuardians, "white", 0
        'SetLightColor LightMystery, "white", 1
        tmrRampage.Interval = 1000
        tmrRampage.UserValue = 30
        tmrRampage.Enabled = True ' Start 30 seconds timer
        puPlayer.LabelSet pBackglass, "RampImg", "PuPOverlays\\Rampage.gif",1,"{'mt':2,'color':111111,'width':11, 'height':21, 'anigif':100,}"
    End Select
    vpmtimer.addtimer 1500, "puPlayer.LabelSet pBackglass,""Rampage"",""""  ,1,"""" '"
  Else
    PlaySoundVol "gg_SpellG", VolDef
    tmrRampage.UserValue = tmrRampage.UserValue + 30
  End If
  LastSwitchHit="tRocket_m"
  MultiplierShot = 1    ' Clear shot multiplier
End Sub

Sub tmrRampage_Timer
  tmrRampage.UserValue = tmrRampage.UserValue -1
  puPlayer.LabelSet pBackglass,"RampTimer", tmrRampage.UserValue  ,1,""     ' TBD: needs foot icon around it

  if tmrRampage.UserValue <= 0 then
    puPlayer.LabelSet pBackglass, "RampImg", "PuPOverlays\\Rampage.gif",0,"{'mt':2,'color':111111,'width':11, 'height':21, 'anigif':100,}"
    puPlayer.LabelSet pBackglass,"RampTimer", ""  ,1,""
    SpellRampage = 0
    AddPlayMultiplier 1/2
    tmrRampage.Enabled = False
    SetLightColor l004, "orange", 0
    'SetLightColor lRocketArrow, "orange", 0
    SetLightColorRestore lRocketArrow, -1     ' Restore the state based on the mode
  End If
End Sub

Sub RocketKickerKick()
  ' Kick out +- 2 degrees
  'RocketKicker.Kick 170, 170 ' (60 + (5*RND-2))
  'RocketKicker.Kick (165 + (5*RND-2)), 90 ' (165 + (5*RND-2))
  RocketKicker.Kick 161, 30   ' ANGLE,  Power
  DOF 113, DOFPulse
  DOF 112, DOFPulse
End Sub


'Sub StorageLights(stat)
'    Dim lamp
'    If stat then
'        DMD "", CL(1, "STORAGE IS LIT"), "", eNone, eBlinkFast, eNone, 1500, True, "vo_storageislit"
'        'FlashEffect 1
'        For each lamp in aStorageLights
'            lamp.State = 2
'        Next
'        'l56.state = 2
'    Else
'        For each lamp in aStorageLights
'            lamp.State = 0
'        Next
'        'l56.state = 0
'    End If
'End Sub



'************************
' Add Time to a Hurry Up
'************************
' this "Add Time" does reset the timer if it is active, but it won't reset the score values

'Sub AddTime()
'    If TerrorDogExpired.Enabled Then
'        TerrorDogExpired.Enabled = 0
'        TerrorDogExpired.Enabled = 1
'        PlaySound "vo_timeadded"
'    End If
'    If GozerHurryUpExpired.Enabled Then
'        GozerHurryUpExpired.Enabled = 0
'        GozerHurryUpExpired.Enabled = 1
'        PlaySound "vo_timeadded"
'    End If
'    If NROEATimerExpired.Enabled Then
'        NROEATimerExpired.Enabled = 0
'        NROEATimerExpired.Enabled = 1
'        PlaySound "vo_timeadded"
'    End If
'    If LoopTimerExpired.Enabled Then
'        LoopTimerExpired.Enabled = 0
'        LoopTimerExpired.Enabled = 1
'        PlaySound "vo_timeadded"
'    End If
'    If PKETimerExpired.Enabled Then
'        PKETimerExpired.Enabled = 0
'        PKETimerExpired.Enabled = 1
'        PlaySound "vo_timeadded"
'    End If
'End Sub




'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  UTILITY - Video Manager & skipper
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'
' Const pTopper=0     ' show,
' Const pDMD=1      ' ForceBack
' Const pBackglass=2    ' ForceBack
' Const pPlayfield=3    ' off
' Const pMusic=4      ' Music Only
' Const pAudio=5      ' Music Only
' Const pCallouts=8   ' Music Only
' Const pOvervid=14   ' ForcePopBack
' Const pGame=15      ' ForcePop - In Game mini game

  dim currentqueue
  dim cineon:cineon = 0
  dim skipped:skipped = 0
  dim bCancelNext:bCancelNext=False
  dim bMediaPaused(19)
  dim bMediaSet(19)
  bMediaPaused(0)=False:bMediaPaused(1)=False:bMediaPaused(2)=False:bMediaPaused(3)=False:bMediaPaused(4)=False:bMediaPaused(5)=False
  bMediaPaused(6)=False:bMediaPaused(7)=False:bMediaPaused(8)=False:bMediaPaused(9)=False:bMediaPaused(10)=False:bMediaPaused(11)=False
  bMediaPaused(12)=False:bMediaPaused(13)=False:bMediaPaused(14)=False:bMediaPaused(15)=False:bMediaPaused(16)=False:bMediaPaused(17)=False
  bMediaPaused(18)=False:bMediaPaused(19)=False
  bMediaSet(0)=False:bMediaSet(1)=False:bMediaSet(2)=False:bMediaSet(3)=False:bMediaSet(4)=False:bMediaSet(5)=False
  bMediaSet(6)=False:bMediaSet(7)=False:bMediaSet(8)=False:bMediaSet(9)=False:bMediaSet(10)=False:bMediaSet(11)=False
  bMediaSet(12)=False:bMediaSet(13)=False:bMediaSet(14)=False:bMediaSet(15)=False:bMediaSet(16)=False:bMediaSet(17)=False
  bMediaSet(18)=False:bMediaSet(19)=False
  sub pausemedia(channel)
    if bUsePUPDMD=False then exit sub

debug.print "pause media ch:" & channel & " current:" & bMediaPaused(channel)
    if bMediaSet(channel) = False then Exit Sub
    if bMediaPaused(channel) = False then
debug.print "pause"
      PuPlayer.playpause channel
      bMediaPaused(channel)=True
    End If
  End Sub

  sub resumemedia(channel)
    if bUsePUPDMD=False then exit sub
debug.print "resume media ch:" & channel & " current:" & bMediaPaused(channel)
    if bMediaSet(channel) = False then Exit Sub
    if bMediaPaused(channel) then
debug.print "resume"
      PuPlayer.playresume channel
      bMediaPaused(channel)=False
    End If
  End Sub

  sub playclear(chan)
    if bUsePUPDMD=False then exit sub
    debug.print "play clear'd " & chan
    bMediaSet(chan) = False
    bMediaPaused(chan) = False

    if chan = pOverVid then
      PuPlayer.PlayStop pOverVid
      'PuPlayer.SetLoop pOverVid, 0
    End If

    if chan = pAudio Then
      'PuPlayer.playlistplayex pAudio,"audioclear","clear.mp3",100,20
      PuPlayer.SetLoop pAudio, 0
      PuPlayer.playstop pAudio
    End If

    if chan = pBonusScreen then
      PuPlayer.SetBackGround chan, 0
      PuPlayer.SetLoop chan, 0
      PuPlayer.playstop chan
    End If

    if chan = pMusic Then
      'PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100,20
      PuPlayer.playstop pMusic
      'PuPlayer.SendMSG "{ ""mt"":301, ""SN"": " & pMusic &", ""FN"":11, ""VL"":0 }"
    End If

    if chan = pBackglass Then
      if currentqueue <> "" then
        bCancelNext = True
debug.print "Clear is cancelling " & currentqueue
      End If
      PuPlayer.SetBackGround pBackglass, 0
      PuPlayer.SetLoop pBackglass, 0
      PuPlayer.playstop pBackglass
    end if
  end Sub


  dim lastvocall:lastvocall=""
  dim noskipper:noskipper=0

  'example playmedia "hs.mp3","audiomultiballs",pAudio,"cineon",10000,"",1,1  // (name,playlist,channel,cinematic,length,nextitem,audiolevel,priority)
  sub playmedia(name,playlist,channel,cinematic,length,nextitem,audiolevel,priority)
    if bUsePUPDMD=False then exit sub
    bMediaSet(channel) = True
    if audiolevel = 1 Then
      if channel = pBackglass Then
        audiolevel = VolBGMusic
        currentqueue = ""
      Elseif channel = pCallouts Then
        audiolevel = VolBGMusic
      Elseif channel = pMusic Then
        audiolevel = VolMusic
      Elseif channel = pAudio Then
        audiolevel = VolBGMusic
      Elseif channel = pOverVid Then
        audiolevel = VolBGMusic
      end If
      audiolevel = audiolevel * 100
    end If

    if channel = pCallouts Then
      if lastvocall = name then exit sub
    end if


    if nextitem = "" Then
      If cinematic = "cineon" Then
        noskipper=1
        vpmtimer.addtimer length, "nextitems '"
      end If
    Else
      currentqueue = "playclear " &channel& ":playmedia """ & nextitem &""","""&playlist&""","&channel&","""",-1,"""", "&audiolevel&",1 '"
      vpmtimer.addtimer length, "nextitems '"
      'vpmtimer.AddTimer length, "playclear " &channel& ":playmedia """ & nextitem &""","""&playlist&""","&channel&","""",-1,"""", "&audiolevel&",1 '"
      'vpmtimer.addtimer length, "nextitems '"
      'currentqueue = nextitem
    end If

    If cinematic = "cineon" and length <> -1 Then
debug.print "ChangeVol pMusic for Cineon"

      skipped=0
      'PuPlayer.playpause 4 ' stop then resume the music
      PuPlayer.SendMSG "{ ""mt"":301, ""SN"": " & pMusic &", ""FN"":11, ""VL"":20 }"
      vpmtimer.addtimer length, "turnitbackupcine '"
      GiOff
      cineon = 1
    end If

debug.print "PlayMedia " & channel & " Dir:" & playlist & " File:" & name & " Vol:" & audiolevel & " Pri:" & priority & " Len:" & length
    PuPlayer.playlistplayex channel,playlist,name,audiolevel,priority
    if channel = pBackglass then PuPlayer.SetBackGround channel, 1
    if channel = pAudio then PuPlayer.SetLoop channel, 1
    if channel = pBonusScreen then PuPlayer.SetLoop channel, 1

    If channel = pCallouts and length <> -1 Then
debug.print "ChangeVol pBackglass Volume for Callouts"
      PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pBackglass&", ""FN"":11, ""VL"":60 }"
      PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pMusic&", ""FN"":11, ""VL"":60 }"
      PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pAudio&", ""FN"":11, ""VL"":60 }"
      vpmtimer.addtimer length, "turnitbackup'"
    end If

    If channel = pOverVid and length <> -1 Then
debug.print "ChangeVol pBackglass for OverVid"
      PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pBackglass&", ""FN"":11, ""VL"":50 }"
      vpmtimer.addtimer length, "turnitbackupvid'"
    end If

    if channel = pCallouts Then
      lastvocall=name
    end if


  end sub

  Sub turnitbackup
debug.print "Change Volume5"

    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pBackglass&", ""FN"":11, ""VL"":"&VolBGMusic&" }"
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pMusic &", ""FN"":11, ""VL"":"&VolMusic&" }"
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pAudio&", ""FN"":11, ""VL"":"&VolSfx&" }"
    debug.print "turnitbackup "
    'puplayer.setvolume pMusic sndtrkvol
  End Sub

  Sub turnitbackupvid
debug.print "Change Volume4"

    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pBackglass&", ""FN"":11, ""VL"":"&VolBGMusic&" }"
    debug.print "turnitbackupvid "
  End Sub

  Sub turnitbackupcine
debug.print "Change Volume3"
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pMusic&", ""FN"":11, ""VL"":"&VolMusic&" }"
    debug.print "turnitbackupcine "
  End Sub

  sub holder
  end sub

  sub nextitems
    if bCancelNext then   ' Cancel the last items that was sent to the queue
debug.print "Cancel Queue"
      bCancelNext=False
      Exit Sub
    End If
debug.print "Executing " & currentqueue
    Execute currentqueue
    currentqueue = ""
    bCancelNext = False   ' Items in queue can trigger a cancel
debug.print "Queue Empty"
'   if skipped = 0 Then
'     noskipper=0
'     'PuPlayer.playresume 4
'debug.print "Change Volume1"
'     PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pMusic&", ""FN"":11, ""VL"":"&VolMusic&" }"
'     gion
'     cineon = 0
'     'looktimer = 0
'     execute currentqueue
'   Elseif skipped = 1 Then
'     'PuPlayer.playresume 4
'debug.print "Change Volume2"
'     PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "&pMusic&", ""FN"":11, ""VL"":"&VolMusic&" }"
'     gion
'     cineon = 0
'     'looktimer = 0
'     skipped = 3
'     execute currentqueue
'     currentqueue = " "
'   end If
  end Sub

  sub vidskipper_timer    ' TBD: Make this work (flippers skip cinematics)
    if cineon = 1  and noskipper = 0 Then
      if ldown = 1 and rdown = 1 Then
        nextitems
        skipped = 1
      end If
    end If
  end Sub


  'logic for skipping
  ' vid starts. is it cinematic?
  ' yes cineon = 1





'******************************************************
'******************************************************
'******************************************************
'******************************************************
'******************************************************
'   FLIPPER CORRECTION SUPPORTING FUNCTIONS
'******************************************************

RightFlipper.timerinterval=1
rightflipper.timerenabled=True

sub RightFlipper_timer()

  If leftflipper.currentangle = leftflipper.endangle and LFPress = 1 then
    leftflipper.eostorqueangle = EOSAnew
    leftflipper.eostorque = EOSTnew
    LeftFlipper.rampup = EOSRampup
    if LFCount = 0 Then LFCount = GameTime
    if GameTime - LFCount < LiveCatch Then
      leftflipper.Elasticity = 0.1
      If LeftFlipper.endangle <> LFEndAngle Then leftflipper.endangle = LFEndAngle
    Else
      leftflipper.Elasticity = FElasticity
    end if
  elseif leftflipper.currentangle > leftflipper.startangle - 0.05  Then
    leftflipper.rampup = SOSRampup
    leftflipper.endangle = LFEndAngle - 3
    leftflipper.Elasticity = FElasticity
    LFCount = 0
  elseif leftflipper.currentangle > leftflipper.endangle + 0.01 Then
    leftflipper.eostorque = EOST
    leftflipper.eostorqueangle = EOSA
    LeftFlipper.rampup = Frampup
    leftflipper.Elasticity = FElasticity
  end if

  If rightflipper.currentangle = rightflipper.endangle and RFPress = 1 then
    rightflipper.eostorqueangle = EOSAnew
    rightflipper.eostorque = EOSTnew
    RightFlipper.rampup = EOSRampup
    if RFCount = 0 Then RFCount = GameTime
    if GameTime - RFCount < LiveCatch Then
      rightflipper.Elasticity = 0.1
      If RightFlipper.endangle <> RFEndAngle Then rightflipper.endangle = RFEndAngle
    Else
      rightflipper.Elasticity = FElasticity
    end if
  elseif rightflipper.currentangle < rightflipper.startangle + 0.05 Then
    rightflipper.rampup = SOSRampup
    rightflipper.endangle = RFEndAngle + 3
    rightflipper.Elasticity = FElasticity
    RFCount = 0
  elseif rightflipper.currentangle < rightflipper.endangle - 0.01 Then
    rightflipper.eostorque = EOST
    rightflipper.eostorqueangle = EOSA
    RightFlipper.rampup = Frampup
    rightflipper.Elasticity = FElasticity
  end if

end sub

dim LFPress, RFPress, EOST, EOSA, EOSTnew, EOSAnew
dim FStrength, Frampup, FElasticity, EOSRampup, SOSRampup
dim RFEndAngle, LFEndAngle, LFCount, RFCount, LiveCatch

EOST = leftflipper.eostorque
EOSA = leftflipper.eostorqueangle
FStrength = LeftFlipper.strength
Frampup = LeftFlipper.rampup
FElasticity = LeftFlipper.elasticity
EOSTnew = 1.0 'FEOST
EOSAnew = 0.2
EOSRampup = 1.5
SOSRampup = 8.5
LiveCatch = 8

LFEndAngle = Leftflipper.endangle
RFEndAngle = RightFlipper.endangle


Sub AddPt(aStr, idx, aX, aY)  'debugger wrapper for adjusting flipper script in-game
  dim a : a = Array(LF, RF)
  dim x : for each x in a
    x.addpoint aStr, idx, aX, aY
  Next
End Sub

'Methods:
'.TimeDelay - Delay before trigger shuts off automatically. Default = 80 (ms)
'.AddPoint - "Polarity", "Velocity", "Ycoef" coordinate points. Use one of these 3 strings, keep coordinates sequential. x = %position on the flipper, y = output
'.Object - set to flipper reference. Optional.
'.StartPoint - set start point coord. Unnecessary, if .object is used.

'Called with flipper -
'ProcessBalls - catches ball data.
' - OR -
'.Fire - fires flipper.rotatetoend automatically + processballs. Requires .Object to be set to the flipper.

Class FlipperPolarity
  Public DebugOn, Enabled
  Private FlipAt  'Timer variable (IE 'flip at 723,530ms...)
  Public TimeDelay  'delay before trigger turns off and polarity is disabled TODO set time!
  private Flipper, FlipperStart, FlipperEnd, LR, PartialFlipCoef
  Private Balls(20), balldata(20)

  dim PolarityIn, PolarityOut
  dim VelocityIn, VelocityOut
  dim YcoefIn, YcoefOut
  Public Sub Class_Initialize
    redim PolarityIn(0) : redim PolarityOut(0) : redim VelocityIn(0) : redim VelocityOut(0) : redim YcoefIn(0) : redim YcoefOut(0)
    Enabled = True : TimeDelay = 50 : LR = 1:  dim x : for x = 0 to uBound(balls) : balls(x) = Empty : set Balldata(x) = new SpoofBall : next
  End Sub

  Public Property let Object(aInput) : Set Flipper = aInput : StartPoint = Flipper.x : End Property
  Public Property Let StartPoint(aInput) : if IsObject(aInput) then FlipperStart = aInput.x else FlipperStart = aInput : end if : End Property
  Public Property Get StartPoint : StartPoint = FlipperStart : End Property
  Public Property Let EndPoint(aInput) : if IsObject(aInput) then FlipperEnd = aInput.x else FlipperEnd = aInput : end if : End Property
  Public Property Get EndPoint : EndPoint = FlipperEnd : End Property

  Public Sub AddPoint(aChooseArray, aIDX, aX, aY) 'Index #, X position, (in) y Position (out)
    Select Case aChooseArray
      case "Polarity" : ShuffleArrays PolarityIn, PolarityOut, 1 : PolarityIn(aIDX) = aX : PolarityOut(aIDX) = aY : ShuffleArrays PolarityIn, PolarityOut, 0
      Case "Velocity" : ShuffleArrays VelocityIn, VelocityOut, 1 :VelocityIn(aIDX) = aX : VelocityOut(aIDX) = aY : ShuffleArrays VelocityIn, VelocityOut, 0
      Case "Ycoef" : ShuffleArrays YcoefIn, YcoefOut, 1 :YcoefIn(aIDX) = aX : YcoefOut(aIDX) = aY : ShuffleArrays YcoefIn, YcoefOut, 0
    End Select
    if gametime > 100 then Report aChooseArray
  End Sub

  Public Sub Report(aChooseArray)   'debug, reports all coords in tbPL.text
    if not DebugOn then exit sub
    dim a1, a2 : Select Case aChooseArray
      case "Polarity" : a1 = PolarityIn : a2 = PolarityOut
      Case "Velocity" : a1 = VelocityIn : a2 = VelocityOut
      Case "Ycoef" : a1 = YcoefIn : a2 = YcoefOut
      case else :tbpl.text = "wrong string" : exit sub
    End Select
    dim str, x : for x = 0 to uBound(a1) : str = str & aChooseArray & " x: " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    tbpl.text = str
  End Sub

  Public Sub AddBall(aBall) : dim x : for x = 0 to uBound(balls) : if IsEmpty(balls(x)) then set balls(x) = aBall : exit sub :end if : Next  : End Sub

  Private Sub RemoveBall(aBall)
    dim x : for x = 0 to uBound(balls)
      if TypeName(balls(x) ) = "IBall" then
        if aBall.ID = Balls(x).ID Then
          balls(x) = Empty
          Balldata(x).Reset
        End If
      End If
    Next
  End Sub

  Public Sub Fire()
    Flipper.RotateToEnd
    processballs
  End Sub

  Public Property Get Pos 'returns % position a ball. For debug stuff.
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        pos = pSlope(Balls(x).x, FlipperStart, 0, FlipperEnd, 1)
      End If
    Next
  End Property

  Public Sub ProcessBalls() 'save data of balls in flipper range
    FlipAt = GameTime
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        balldata(x).Data = balls(x)
        if DebugOn then StickL.visible = True : StickL.x = balldata(x).x    'debug TODO
      End If
    Next
    PartialFlipCoef = ((Flipper.StartAngle - Flipper.CurrentAngle) / (Flipper.StartAngle - Flipper.EndAngle))
    PartialFlipCoef = abs(PartialFlipCoef-1)
    if abs(Flipper.currentAngle - Flipper.EndAngle) < 30 Then
      PartialFlipCoef = 0
    End If
  End Sub
  Private Function FlipperOn() : if gameTime < FlipAt+TimeDelay then FlipperOn = True : End If : End Function 'Timer shutoff for polaritycorrect

  Public Sub PolarityCorrect(aBall)
    if FlipperOn() then
      dim tmp, BallPos, x, IDX, Ycoef : Ycoef = 1
      dim teststr : teststr = "Cutoff"
      tmp = PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1)
      if tmp < 0.1 then 'if real ball position is behind flipper, exit Sub to prevent stucks  'Disabled 1.03, I think it's the Mesh that's causing stucks, not this
        if DebugOn then TestStr = "real pos < 0.1 ( " & round(tmp,2) & ")" : tbpl.text = Teststr
        'RemoveBall aBall
        'Exit Sub
      end if

      'y safety Exit
      if aBall.VelY > -8 then 'ball going down
        if DebugOn then teststr = "y velocity: " & round(aBall.vely, 3) & "exit sub" : tbpl.text = teststr
        RemoveBall aBall
        exit Sub
      end if
      'Find balldata. BallPos = % on Flipper
      for x = 0 to uBound(Balls)
        if aBall.id = BallData(x).id AND not isempty(BallData(x).id) then
          idx = x
          BallPos = PSlope(BallData(x).x, FlipperStart, 0, FlipperEnd, 1)
          'TB.TEXT = balldata(x).id & " " & BALLDATA(X).X & VBNEWLINE & FLIPPERSTART & " " & FLIPPEREND
          if ballpos > 0.65 then  Ycoef = LinearEnvelope(BallData(x).Y, YcoefIn, YcoefOut)        'find safety coefficient 'ycoef' data
        end if
      Next

      'Velocity correction
      if not IsEmpty(VelocityIn(0) ) then
        Dim VelCoef
        if DebugOn then set tmp = new spoofball : tmp.data = aBall : End If
        if IsEmpty(BallData(idx).id) and aBall.VelY < -12 then 'if tip hit with no collected data, do vel correction anyway
          if PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1) > 1.1 then 'adjust plz
            VelCoef = LinearEnvelope(5, VelocityIn, VelocityOut)
            if partialflipcoef < 1 then VelCoef = PSlope(partialflipcoef, 0, 1, 1, VelCoef)
            if Enabled then aBall.Velx = aBall.Velx*VelCoef'VelCoef
            if Enabled then aBall.Vely = aBall.Vely*VelCoef'VelCoef
            if DebugOn then teststr = "tip protection" & vbnewline & "velcoef: " & round(velcoef,3) & vbnewline & round(PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1),3) & vbnewline
            'debug.print teststr
          end if
        Else
     :      VelCoef = LinearEnvelope(BallPos, VelocityIn, VelocityOut)
          if Enabled then aBall.Velx = aBall.Velx*VelCoef
          if Enabled then aBall.Vely = aBall.Vely*VelCoef
        end if
      End If

      'Polarity Correction (optional now)
      if not IsEmpty(PolarityIn(0) ) then
        If StartPoint > EndPoint then LR = -1 'Reverse polarity if left flipper
        dim AddX : AddX = LinearEnvelope(BallPos, PolarityIn, PolarityOut) * LR
        if Enabled then aBall.VelX = aBall.VelX + 1 * (AddX*ycoef*PartialFlipcoef)
      End If
      'debug
      if DebugOn then
        TestStr = teststr & "%pos:" & round(BallPos,2)
        if IsEmpty(PolarityOut(0) ) then
          teststr = teststr & vbnewline & "(Polarity Disabled)" & vbnewline
        else
          teststr = teststr & "+" & round(1 *(AddX*ycoef*PartialFlipcoef),3)
          if BallPos >= PolarityOut(uBound(PolarityOut) ) then teststr = teststr & "(MAX)" & vbnewline else teststr = teststr & vbnewline end if
          if Ycoef < 1 then teststr = teststr &  "ycoef: " & ycoef & vbnewline
          if PartialFlipcoef < 1 then teststr = teststr & "PartialFlipcoef: " & round(PartialFlipcoef,4) & vbnewline
        end if

        teststr = teststr & vbnewline & "Vel: " & round(BallSpeed(tmp),2) & " -> " & round(ballspeed(aBall),2) & vbnewline
        teststr = teststr & "%" & round(ballspeed(aBall) / BallSpeed(tmp),2)
        tbpl.text = TestSTR
      end if
    Else
      'if DebugOn then tbpl.text = "td" & timedelay
    End If
    RemoveBall aBall
  End Sub
End Class

'================================
'Helper Functions


Sub ShuffleArray(ByRef aArray, byVal offset) 'shuffle 1d array
  dim x, aCount : aCount = 0
  redim a(uBound(aArray) )
  for x = 0 to uBound(aArray) 'Shuffle objects in a temp array
    if not IsEmpty(aArray(x) ) Then
      if IsObject(aArray(x)) then
        Set a(aCount) = aArray(x)
      Else
        a(aCount) = aArray(x)
      End If
      aCount = aCount + 1
    End If
  Next
  if offset < 0 then offset = 0
  redim aArray(aCount-1+offset) 'Resize original array
  for x = 0 to aCount-1   'set objects back into original array
    if IsObject(a(x)) then
      Set aArray(x) = a(x)
    Else
      aArray(x) = a(x)
    End If
  Next
End Sub

Sub ShuffleArrays(aArray1, aArray2, offset)
  ShuffleArray aArray1, offset
  ShuffleArray aArray2, offset
End Sub


Function BallSpeed(ball) 'Calculates the ball speed
    BallSpeed = SQR(ball.VelX^2 + ball.VelY^2 + ball.VelZ^2)
End Function

Function PSlope(Input, X1, Y1, X2, Y2)  'Set up line via two points, no clamping. Input X, output Y
  dim x, y, b, m : x = input : m = (Y2 - Y1) / (X2 - X1) : b = Y2 - m*X2
  Y = M*x+b
  PSlope = Y
End Function

Function NullFunctionZ(aEnabled):End Function '1 argument null function placeholder  TODO move me or replac eme

Class spoofball
  Public X, Y, Z, VelX, VelY, VelZ, ID, Mass, Radius
  Public Property Let Data(aBall)
    With aBall
      x = .x : y = .y : z = .z : velx = .velx : vely = .vely : velz = .velz
      id = .ID : mass = .mass : radius = .radius
    end with
  End Property
  Public Sub Reset()
    x = Empty : y = Empty : z = Empty  : velx = Empty : vely = Empty : velz = Empty
    id = Empty : mass = Empty : radius = Empty
  End Sub
End Class


Function LinearEnvelope(xInput, xKeyFrame, yLvl)
  dim y 'Y output
  dim L 'Line
  dim ii : for ii = 1 to uBound(xKeyFrame)  'find active line
    if xInput <= xKeyFrame(ii) then L = ii : exit for : end if
  Next
  if xInput > xKeyFrame(uBound(xKeyFrame) ) then L = uBound(xKeyFrame)  'catch line overrun
  Y = pSlope(xInput, xKeyFrame(L-1), yLvl(L-1), xKeyFrame(L), yLvl(L) )

  'Clamp if on the boundry lines
  'if L=1 and Y < yLvl(LBound(yLvl) ) then Y = yLvl(lBound(yLvl) )
  'if L=uBound(xKeyFrame) and Y > yLvl(uBound(yLvl) ) then Y = yLvl(uBound(yLvl) )
  'clamp 2.0
  if xInput <= xKeyFrame(lBound(xKeyFrame) ) then Y = yLvl(lBound(xKeyFrame) )  'Clamp lower
  if xInput >= xKeyFrame(uBound(xKeyFrame) ) then Y = yLvl(uBound(xKeyFrame) )  'Clamp upper

  LinearEnvelope = Y
End Function






'
''Tracks ball velocity for judging bounce calculations & angle
''apologies to JimmyFingers is this is what his script does. I know his tracks ball velocity too but idk how it works in particular
'dim cor : set cor = New CoRTracker
'cor.debugOn = False
''cor.update() - put this on a low interval timer
'Class CoRTracker
' public DebugOn 'tbpIn.text
' public ballvel
'
' Private Sub Class_Initialize : redim ballvel(0) : End Sub
' 'TODO this would be better if it didn't do the sorting every ms, but instead every time it's pulled for COR stuff
' Public Sub Update() 'tracks in-ball-velocity
'   dim str, b, AllBalls, highestID : allBalls = getballs
'   if uBound(allballs) < 0 then if DebugOn then str = "no balls" : TBPin.text = str : exit Sub else exit sub end if: end if
'   for each b in allballs
'     if b.id >= HighestID then highestID = b.id
'   Next
'
'   if uBound(ballvel) < highestID then redim ballvel(highestID)  'set bounds
'
'   for each b in allballs
'     ballvel(b.id) = BallSpeed(b)
'     if DebugOn then
'       dim s, bs 'debug spacer, ballspeed
'       bs = round(BallSpeed(b),1)
'       if bs < 10 then s = " " else s = "" end if
'       str = str & b.id & ": " & s & bs & vbnewline
'       'str = str & b.id & ": " & s & bs & "z:" & b.z & vbnewline
'     end if
'   Next
'   if DebugOn then str = "ubound ballvels: " & ubound(ballvel) & vbnewline & str : if TBPin.text <> str then TBPin.text = str : end if
' End Sub
'End Class

'****************************************************************************
'PHYSICS DAMPENERS

'These are data mined bounce curves,
'dialed in with the in-game elasticity as much as possible to prevent angle / spin issues.
'Requires tracking ballspeed to calculate COR


Sub dPosts_Hit(idx)
  RubbersD.dampen Activeball
End Sub

Sub dSleeves_Hit(idx)
  SleevesD.Dampen Activeball
End Sub


dim RubbersD : Set RubbersD = new Dampener  'frubber
RubbersD.name = "Rubbers"
RubbersD.debugOn = False  'shows info in textbox "TBPout"
RubbersD.Print = False  'debug, reports in debugger (in vel, out cor)
'cor bounce curve (linear)
'for best results, try to match in-game velocity as closely as possible to the desired curve
'RubbersD.addpoint 0, 0, 0.935  'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 0, 0, 0.96  'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 1, 3.77, 0.96
RubbersD.addpoint 2, 5.76, 0.967  'dont take this as gospel. if you can data mine rubber elasticitiy, please help!
RubbersD.addpoint 3, 15.84, 0.874
RubbersD.addpoint 4, 56, 0.64 'there's clamping so interpolate up to 56 at least

dim SleevesD : Set SleevesD = new Dampener  'this is just rubber but cut down to 85%...
SleevesD.name = "Sleeves"
SleevesD.debugOn = False  'shows info in textbox "TBPout"
SleevesD.Print = False  'debug, reports in debugger (in vel, out cor)
SleevesD.CopyCoef RubbersD, 0.85

Class Dampener
  Public Print, debugOn 'tbpOut.text
  public name, Threshold  'Minimum threshold. Useful for Flippers, which don't have a hit threshold.
  Public ModIn, ModOut
  Private Sub Class_Initialize : redim ModIn(0) : redim Modout(0): End Sub

  Public Sub AddPoint(aIdx, aX, aY)
    ShuffleArrays ModIn, ModOut, 1 : ModIn(aIDX) = aX : ModOut(aIDX) = aY : ShuffleArrays ModIn, ModOut, 0
    if gametime > 100 then Report
  End Sub

  public sub Dampen(aBall)
    if threshold then if BallSpeed(aBall) < threshold then exit sub end if end if
    dim RealCOR, DesiredCOR, str, coef
    DesiredCor = LinearEnvelope(cor.ballvel(aBall.id), ModIn, ModOut )
    RealCOR = BallSpeed(aBall) / cor.ballvel(aBall.id)
    coef = desiredcor / realcor
    if debugOn then str = name & " in vel:" & round(cor.ballvel(aBall.id),2 ) & vbnewline & "desired cor: " & round(desiredcor,4) & vbnewline & _
    "actual cor: " & round(realCOR,4) & vbnewline & "ballspeed coef: " & round(coef, 3) & vbnewline
    if Print then debug.print Round(cor.ballvel(aBall.id),2) & ", " & round(desiredcor,3)

' Thalamus - patched :     aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef
    aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef : aBall.velz = aBall.velz * coef
    if debugOn then TBPout.text = str
  End Sub

  Public Sub CopyCoef(aObj, aCoef) 'alternative addpoints, copy with coef
    dim x : for x = 0 to uBound(aObj.ModIn)
      addpoint x, aObj.ModIn(x), aObj.ModOut(x)*aCoef
    Next
  End Sub


  Public Sub Report()   'debug, reports all coords in tbPL.text
    if not debugOn then exit sub
    dim a1, a2 : a1 = ModIn : a2 = ModOut
    dim str, x : for x = 0 to uBound(a1) : str = str & x & ": " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    TBPout.text = str
  End Sub


End Class

'Tracks ball velocity for judging bounce calculations & angle
'apologies to JimmyFingers is this is what his script does. I know his tracks ball velocity too but idk how it works in particular
dim cor : set cor = New CoRTracker
cor.debugOn = False
'cor.update() - put this on a low interval timer
Class CoRTracker
  public DebugOn 'tbpIn.text
  public ballvel

  Private Sub Class_Initialize : redim ballvel(0) : End Sub
  'TODO this would be better if it didn't do the sorting every ms, but instead every time it's pulled for COR stuff
  Public Sub Update() 'tracks in-ball-velocity
    dim str, b, AllBalls, highestID : allBalls = getballs
    if uBound(allballs) < 0 then if DebugOn then str = "no balls" : TBPin.text = str : exit Sub else exit sub end if: end if
    for each b in allballs
      if b.id >= HighestID then highestID = b.id
    Next

    if uBound(ballvel) < highestID then redim ballvel(highestID)  'set bounds

    for each b in allballs
      ballvel(b.id) = BallSpeed(b)
      if DebugOn then
        dim s, bs 'debug spacer, ballspeed
        bs = round(BallSpeed(b),1)
        if bs < 10 then s = " " else s = "" end if
        str = str & b.id & ": " & s & bs & vbnewline
        'str = str & b.id & ": " & s & bs & "z:" & b.z & vbnewline
      end if
    Next
    if DebugOn then str = "ubound ballvels: " & ubound(ballvel) & vbnewline & str : if TBPin.text <> str then TBPin.text = str : end if
  End Sub
End Class

Sub RDampen_Timer()
  Cor.Update
End Sub

'*********************** END FOZZY Physics
' ***************************************************************************************************



' ***************************************************************************************************
' ******************************  Lampz from funhouse
Dim MaterialWhiteArray: MaterialWhiteArray = Array("BulbWhiteOff", "BulbWhiteOff","BulbWhiteOff","BulbWhiteOn")
Dim MaterialBlueArray: MaterialBlueArray = Array("BulbBlueOff", "BulbBlueOff","BulbBlueOff","BulbBlueOn")
Dim MaterialRedArray: MaterialRedArray = Array("BulbRedOff", "BulbRedOff","BulbRedOff","BulbRedOn")
Dim MaterialYellowArray: MaterialYellowArray = Array("BulbYellowOff", "BulbYellowOff","BulbYellowOff","BulbYellowOn")

Dim NullFader : set NullFader = new NullFadingObject
Dim Lampz : Set Lampz = New LampFader
InitLampsNF              ' Setup lamp assignments
LampTimer.Interval = -1
LampTimer.Enabled = 1
'Lampz.SetLamp 1, True
'Lampz.SetLamp 1, True

Sub LampTimer_Timer()
  dim x, chglamp
  if b2son then chglamp = Controller.ChangedLamps
  If Not IsEmpty(chglamp) Then
    For x = 0 To UBound(chglamp)      'nmbr = chglamp(x, 0), state = chglamp(x, 1)
      Lampz.state(chglamp(x, 0)) = chglamp(x, 1)
    next
  End If
  Lampz.Update1 'update (fading logic only)
End Sub

dim FrameTime, InitFrameTime : InitFrameTime = 0
LampTimer2.Interval = -1
LampTimer2.Enabled = True
Sub LampTimer2_Timer()  'Stealing this random wall's timer for -1 updates
  FrameTime = gametime - InitFrameTime : InitFrameTime = gametime 'Count frametime. Unused atm?
  Lampz.Update 'updates on frametime (Object updates only)
End Sub

Function FlashLevelToIndex(Input, MaxSize)
  FlashLevelToIndex = cInt(MaxSize * Input)
End Function

'***Material Swap***
'Fade material for green, red, yellow colored Bulb prims
Sub FadeMaterialColoredBulb(pri, group, ByVal aLvl) 'cp's script
' if Lampz.UseFunction then aLvl = LampFilter(aLvl) 'Callbacks don't get this filter automatically
  if Lampz.UseFunction then aLvl = Lampz.FilterOut(aLvl)  'Callbacks don't get this filter automatically
    Select case FlashLevelToIndex(aLvl, 3)
    Case 0:pri.Material = group(0) 'Off
    Case 1:pri.Material = group(1) 'Fading...
    Case 2:pri.Material = group(2) 'Fading...
        Case 3:pri.Material = group(3) 'Full
    End Select
  'if tb.text <> pri.image then tb.text = pri.image : debug.print pri.image end If  'debug
pri.blenddisablelighting = aLvl * 1 'Intensity Adjustment
End Sub


'Fade material for red, yellow colored bulb Filiment prims
Sub FadeMaterialColoredFiliment(pri, group, ByVal aLvl) 'cp's script
' if Lampz.UseFunction then aLvl = LampFilter(aLvl) 'Callbacks don't get this filter automatically
  if Lampz.UseFunction then aLvl = Lampz.FilterOut(aLvl)  'Callbacks don't get this filter automatically
    Select case FlashLevelToIndex(aLvl, 3)
    Case 0:pri.Material = group(0) 'Off
    Case 1:pri.Material = group(1) 'Fading...
    Case 2:pri.Material = group(2) 'Fading...
        Case 3:pri.Material = group(3) 'Full
    End Select
  'if tb.text <> pri.image then tb.text = pri.image : debug.print pri.image end If  'debug
pri.blenddisablelighting = aLvl * 50  'Intensity Adjustment
End Sub


Sub InitLampsNF()

  'Filtering (comment out to disable)
  Lampz.Filter = "LampFilter" 'Puts all lamp intensityscale output (no callbacks) through this function before updating

  'Adjust fading speeds (1 / full MS fading time)
  dim x : for x = 0 to 140 : Lampz.FadeSpeedUp(x) = 3/10 : Lampz.FadeSpeedDown(x) = 3/10 : next

  'Lamp Assignments
  'MassAssign is an optional way to do assignments. It'll create arrays automatically / append objects to existing arrays
    Lampz.MassAssign(1)= l80
    Lampz.Callback(1) =         "FadeMaterialColoredBulb pFBase80, MaterialWhiteArray, "
    Lampz.Callback(1) = "FadeMaterialColoredFiliment pFiliment80, MaterialWhiteArray, "

    Lampz.MassAssign(2)= l79
    Lampz.Callback(2) =         "FadeMaterialColoredBulb pFBase79, MaterialYellowArray, "
    Lampz.Callback(2) = "FadeMaterialColoredFiliment pFiliment79, MaterialYellowArray, "

    Lampz.MassAssign(3)= l78
    Lampz.Callback(3) =         "FadeMaterialColoredBulb pFBase78, MaterialBlueArray, "
    Lampz.Callback(3) = "FadeMaterialColoredFiliment pFiliment78, MaterialBlueArray, "

    Lampz.MassAssign(4)= l77
    Lampz.Callback(4) =         "FadeMaterialColoredBulb pFBase77, MaterialRedArray, "
    Lampz.Callback(4) = "FadeMaterialColoredFiliment pFiliment77, MaterialRedArray, "


  'Turn off all lamps on startup
  Lampz.Init  'This just turns state of any lamps to 1

  'Immediate update to turn on GI, turn off lamps
  Lampz.update

End Sub


'====================
'Class jungle nf
'=============

'No-op object instead of adding more conditionals to the main loop
'It also prevents errors if empty lamp numbers are called, and it's only one object
'should be g2g?

Class NullFadingObject : Public Property Let IntensityScale(input) : : End Property : End Class

'version 0.11 - Mass Assign, Changed modulate style
'version 0.12 - Update2 (single -1 timer update) update method for core.vbs
'Version 0.12a - Filter can now be accessed via 'FilterOut'
'Version 0.12b - Changed MassAssign from a sub to an indexed property (new syntax: lampfader.MassAssign(15) = Light1 )
'Version 0.13 - No longer requires setlocale. Callback() can be assigned multiple times per index
' Note: if using multiple 'LampFader' objects, set the 'name' variable to avoid conflicts with callbacks

Class LampFader
  Public FadeSpeedDown(140), FadeSpeedUp(140)
  Private Lock(140), Loaded(140), OnOff(140)
  Public UseFunction
  Private cFilter
  Public UseCallback(140), cCallback(140)
  Public Lvl(140), Obj(140)
  Private Mult(140)
  Public FrameTime
  Private InitFrame
  Public Name

  Sub Class_Initialize()
    InitFrame = 0
    dim x : for x = 0 to uBound(OnOff)  'Set up fade speeds
      FadeSpeedDown(x) = 1/100  'fade speed down
      FadeSpeedUp(x) = 1/80   'Fade speed up
      UseFunction = False
      lvl(x) = 0
      OnOff(x) = False
      Lock(x) = True : Loaded(x) = False
      Mult(x) = 1
    Next
    Name = "LampFaderNF" 'NEEDS TO BE CHANGED IF THERE'S MULTIPLE OF THESE OBJECTS, OTHERWISE CALLBACKS WILL INTERFERE WITH EACH OTHER!!
    for x = 0 to uBound(OnOff)    'clear out empty obj
      if IsEmpty(obj(x) ) then Set Obj(x) = NullFader' : Loaded(x) = True
    Next
  End Sub

  Public Property Get Locked(idx) : Locked = Lock(idx) : End Property   'debug.print Lampz.Locked(100)  'debug
  Public Property Get state(idx) : state = OnOff(idx) : end Property
  Public Property Let Filter(String) : Set cFilter = GetRef(String) : UseFunction = True : End Property
  Public Function FilterOut(aInput) : if UseFunction Then FilterOut = cFilter(aInput) Else FilterOut = aInput End If : End Function
  'Public Property Let Callback(idx, String) : cCallback(idx) = String : UseCallBack(idx) = True : End Property
  Public Property Let Callback(idx, String)
    UseCallBack(idx) = True
    'cCallback(idx) = String 'old execute method
    'New method: build wrapper subs using ExecuteGlobal, then call them
    cCallback(idx) = cCallback(idx) & "___" & String  'multiple strings dilineated by 3x _

    dim tmp : tmp = Split(cCallback(idx), "___")

    dim str, x : for x = 0 to uBound(tmp) 'build proc contents
      'If Not tmp(x)="" then str = str & "  " & tmp(x) & " aLVL" & "  '" & x & vbnewline  'more verbose
      If Not tmp(x)="" then str = str & tmp(x) & " aLVL:"
    Next
'msgbox "Sub " & name & idx & "(aLvl):" & str & "End Sub"
    dim out : out = "Sub " & name & idx & "(aLvl):" & str & "End Sub"
    'if idx = 132 then msgbox out 'debug
    ExecuteGlobal Out

  End Property

  Public Property Let state(ByVal idx, input) 'Major update path
    if Input <> OnOff(idx) then  'discard redundant updates
      OnOff(idx) = input
      Lock(idx) = False
      Loaded(idx) = False
    End If
  End Property

  'Mass assign, Builds arrays where necessary
  'Sub MassAssign(aIdx, aInput)
  Public Property Let MassAssign(aIdx, aInput)
    If typename(obj(aIdx)) = "NullFadingObject" Then 'if empty, use Set
      if IsArray(aInput) then
        obj(aIdx) = aInput
      Else
        Set obj(aIdx) = aInput
      end if
    Else
      Obj(aIdx) = AppendArray(obj(aIdx), aInput)
    end if
  end Property

  Sub SetLamp(aIdx, aOn) : state(aIdx) = aOn : End Sub  'Solenoid Handler

  Public Sub TurnOnStates() 'If obj contains any light objects, set their states to 1 (Fading is our job!)
    dim debugstr
    dim idx : for idx = 0 to uBound(obj)
      if IsArray(obj(idx)) then
        'debugstr = debugstr & "array found at " & idx & "..."
        dim x, tmp : tmp = obj(idx) 'set tmp to array in order to access it
        for x = 0 to uBound(tmp)
          if typename(tmp(x)) = "Light" then DisableState tmp(x)' : debugstr = debugstr & tmp(x).name & " state'd" & vbnewline
          tmp(x).intensityscale = 0.001 ' this can prevent init stuttering
        Next
      Else
        if typename(obj(idx)) = "Light" then DisableState obj(idx)' : debugstr = debugstr & obj(idx).name & " state'd (not array)" & vbnewline
        obj(idx).intensityscale = 0.001 ' this can prevent init stuttering
      end if
    Next
    'debug.print debugstr
  End Sub
  Private Sub DisableState(ByRef aObj) : aObj.FadeSpeedUp = 1000 : aObj.State = 1 : End Sub 'turn state to 1

  Public Sub Init() 'Just runs TurnOnStates right now
    TurnOnStates
  End Sub

  Public Property Let Modulate(aIdx, aCoef) : Mult(aIdx) = aCoef : Lock(aIdx) = False : Loaded(aIdx) = False: End Property
  Public Property Get Modulate(aIdx) : Modulate = Mult(aIdx) : End Property

  Public Sub Update1()   'Handle all boolean numeric fading. If done fading, Lock(x) = True. Update on a '1' interval Timer!
    dim x : for x = 0 to uBound(OnOff)
      if not Lock(x) then 'and not Loaded(x) then
        if OnOff(x) then 'Fade Up
          Lvl(x) = Lvl(x) + FadeSpeedUp(x)
          if Lvl(x) >= 1 then Lvl(x) = 1 : Lock(x) = True
        elseif Not OnOff(x) then 'fade down
          Lvl(x) = Lvl(x) - FadeSpeedDown(x)
          if Lvl(x) <= 0 then Lvl(x) = 0 : Lock(x) = True
        end if
      end if
    Next
  End Sub

  Public Sub Update2()   'Both updates on -1 timer (Lowest latency, but less accurate fading at 60fps vsync)
    FrameTime = gametime - InitFrame : InitFrame = GameTime 'Calculate frametime
    dim x : for x = 0 to uBound(OnOff)
      if not Lock(x) then 'and not Loaded(x) then
        if OnOff(x) then 'Fade Up
          Lvl(x) = Lvl(x) + FadeSpeedUp(x) * FrameTime
          if Lvl(x) >= 1 then Lvl(x) = 1 : Lock(x) = True
        elseif Not OnOff(x) then 'fade down
          Lvl(x) = Lvl(x) - FadeSpeedDown(x) * FrameTime
          if Lvl(x) <= 0 then Lvl(x) = 0 : Lock(x) = True
        end if
      end if
    Next
    Update
  End Sub

  Public Sub Update() 'Handle object updates. Update on a -1 Timer! If done fading, loaded(x) = True
    dim x,xx : for x = 0 to uBound(OnOff)
      if not Loaded(x) then
        if IsArray(obj(x) ) Then  'if array
          If UseFunction then
            for each xx in obj(x) : xx.IntensityScale = cFilter(Lvl(x)*Mult(x)) : Next
          Else
            for each xx in obj(x) : xx.IntensityScale = Lvl(x)*Mult(x) : Next
          End If
        else            'if single lamp or flasher
          If UseFunction then
            obj(x).Intensityscale = cFilter(Lvl(x)*Mult(x))
          Else
            obj(x).Intensityscale = Lvl(x)
          End If
        end if
        if TypeName(lvl(x)) <> "Double" and typename(lvl(x)) <> "Integer" then msgbox "uhh " & 2 & " = " & lvl(x)
        'If UseCallBack(x) then execute cCallback(x) & " " & (Lvl(x)) 'Callback
        If UseCallBack(x) then Proc name & x,Lvl(x)*mult(x) 'Proc
        If Lock(x) Then
          if Lvl(x) = 1 or Lvl(x) = 0 then Loaded(x) = True 'finished fading
        end if
      end if
    Next
  End Sub
End Class

'Lamp Filter
Function LampFilter(aLvl)
  LampFilter = aLvl^1.6 'exponential curve?
End Function


'Helper functions
Sub Proc(string, Callback)  'proc using a string and one argument
  'On Error Resume Next
  dim p : Set P = GetRef(String)
  P Callback
  If err.number = 13 then  msgbox "Proc error! No such procedure: " & vbnewline & string
  if err.number = 424 then msgbox "Proc error! No such Object"
End Sub

Function AppendArray(ByVal aArray, aInput)  'append one value, object, or Array onto the end of a 1 dimensional array
  if IsArray(aInput) then 'Input is an array...
    dim tmp : tmp = aArray
    If not IsArray(aArray) Then 'if not array, create an array
      tmp = aInput
    Else            'Append existing array with aInput array
      Redim Preserve tmp(uBound(aArray) + uBound(aInput)+1) 'If existing array, increase bounds by uBound of incoming array
      dim x : for x = 0 to uBound(aInput)
        if isObject(aInput(x)) then
          Set tmp(x+uBound(aArray)+1 ) = aInput(x)
        Else
          tmp(x+uBound(aArray)+1 ) = aInput(x)
        End If
      Next
    AppendArray = tmp  'return new array
    End If
  Else 'Input is NOT an array...
    If not IsArray(aArray) Then 'if not array, create an array
      aArray = Array(aArray, aInput)
    Else
      Redim Preserve aArray(uBound(aArray)+1) 'If array, increase bounds by 1
      if isObject(aInput) then
        Set aArray(uBound(aArray)) = aInput
      Else
        aArray(uBound(aArray)) = aInput
      End If
    End If
    AppendArray = aArray 'return new array
  End If
End Function

' ******************************  END Lampz from funhouse
' ***************************************************************************************************


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Orbital Scoreboard Code
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

'****************************
' POST SCORES
'****************************
Dim osbtemp
Dim osbtempscore:osbtempscore = 0
if osbactive = 1 or osbactive = 2 Then osbtemp = osbdefinit
Sub SubmitOSBScore
  dim vers
  Dim ver
  vers=split(myVersion,".")     ' Convert x.y.z to x.y
  ver=vers(0) & "." & vers(1)

  On Error Resume Next
  if osbactive = 1 or osbactive = 2 Then
    Dim objXmlHttpMain, Url, strJSONToSend

    Url = "https://hook.integromat.com/82bu988v9grj31vxjklh2e4s6h97rnu0"
    strJSONToSend = "{""auth"":""" & osbkey &""",""player id"": """ & osbid & """,""player initials"": """ & osbtemp &""",""score"": " & CStr(osbtempscore) & ",""table"":"""& TableName & """,""version"":""" & ver & """}"

    Set objXmlHttpMain = CreateObject("Msxml2.ServerXMLHTTP")
    objXmlHttpMain.open "PUT",Url, False
    objXmlHttpMain.setRequestHeader "Content-Type", "application/json"
    objXmlHttpMain.setRequestHeader "application", "application/json"

    objXmlHttpMain.send strJSONToSend
  end if
End Sub

'****************************
' GET SCORES
'****************************
dim worldscores

Sub GetScores()
  if osbactive =0 then exit sub
  if osbkey="" then exit sub
  On Error Resume Next
  Dim objXmlHttpMain, Url, strJSONToSend

  Url = "https://hook.integromat.com/kj765ojs42ac3w4915elqj5b870jrm5c"

  strJSONToSend = "{""auth"":"""& osbkey &""", ""table"":"""& TableName & """}"

  Set objXmlHttpMain = CreateObject("Msxml2.ServerXMLHTTP")
  objXmlHttpMain.open "PUT",Url, False
  objXmlHttpMain.setRequestHeader "Content-Type", "application/json"
  objXmlHttpMain.setRequestHeader "application", "application/json"

  objXmlHttpMain.send strJSONToSend

  worldscores = objXmlHttpMain.responseText
  vpmtimer.addtimer 3000, "showsuccess '"
  debug.print "Got OSB scores"
  'debug.print worldscores
  splitscores
End Sub

Dim scorevar(22)
Dim dailyvar(22)
Dim weeklyvar(22)
Dim alltimevar(42)
sub emptyscores
  dim i
  For i = 0 to 42
    alltimevar(i) = "0"
  Next
  For i = 0 to 22
    weeklyvar(i) = "0"
    dailyvar(i) = "0"
  Next
End Sub
emptyscores


Sub splitscores
  On Error Resume Next
  dim a,scoreset,subset,subit,myNum,daily,weekly,alltime,x
  a = Split(worldscores,": {")
  subset = Split(a(1),"[")

'   debug.print subset(1)
'   debug.print subset(2)
'   debug.print subset(3)
' daily scores
  myNum = 0
  daily = Split(subset(1),": ")
  for each x in daily
    myNum = MyNum + 1
    x = Replace(x, vbCr, "")
    x = Replace(x, vbLf, "")
    x = Replace(x, ",", "")
    x = Replace(x, """", "")
    x = Replace(x, "{", "")
    x = Replace(x, "}", "")
    x = Replace(x, "score", "")
    x = Replace(x, "initials", "")
    x = Replace(x, "weekly", "")
    x = Replace(x, "]", "")
    x = Replace(x, "alltime", "")
    dailyvar(MyNum) = x
    if dailyvar(MyNum) = "" Then
      if MyNum = 2 or 4 or 6 or 8 or 10 or 12 or 14 or 16 or 18 or 20 Then
        dailyvar(MyNum) = "OBS"
      Else
        dailyvar(MyNum) = 0
      end if
    end if
    debug.print "dailyvar(" &MyNum & ")=" & x
  Next

' weekly scores
  myNum = 0
  weekly = Split(subset(2),": ")
  for each x in weekly
    myNum = MyNum + 1
    x = Replace(x, vbCr, "")
    x = Replace(x, vbLf, "")
    x = Replace(x, ",", "")
    x = Replace(x, """", "")
    x = Replace(x, "{", "")
    x = Replace(x, "}", "")
    x = Replace(x, "score", "")
    x = Replace(x, "initials", "")
    x = Replace(x, "weekly", "")
    x = Replace(x, "]", "")
    x = Replace(x, "alltime", "")
    weeklyvar(MyNum) = x
    if weeklyvar(MyNum) = "" Then
      if MyNum = 2 or 4 or 6 or 8 or 10 or 12 or 14 or 16 or 18 or 20 Then
        weeklyvar(MyNum) = "OBS"
      Else
        weeklyvar(MyNum) = 0
      end if
    end if
    debug.print "weeklyvar(" &MyNum & ")=" & x
  Next

' alltime scores
  myNum = 0
  alltime = Split(subset(3),": ")
  for each x in alltime
    myNum = MyNum + 1
    x = Replace(x, vbCr, "")
    x = Replace(x, vbLf, "")
    x = Replace(x, ",", "")
    x = Replace(x, """", "")
    x = Replace(x, "{", "")
    x = Replace(x, "}", "")
    x = Replace(x, "score", "")
    x = Replace(x, "initials", "")
    x = Replace(x, "weekly", "")
    x = Replace(x, "]", "")
    x = Replace(x, "alltime", "")
    alltimevar(MyNum) = x
    if alltimevar(MyNum) = "" Then
      if MyNum = 2 or 4 or 6 or 8 or 10 or 12 or 14 or 16 or 18 or 20 or 22 or 24 or 26 or 28 or 30 or 32 or 34 or 36 or 38 or 40 Then
        alltimevar(MyNum) = "OBS"
      Else
        alltimevar(MyNum) = "0"
      end if
    end if
    debug.print "alltimevar(" &MyNum & ")=" & x
  Next

end Sub


sub showsuccess
  'pNote "Scoreboard","Updated"
  pupDMDDisplay "-","Scoreboard^Updated","",3,0,10
end sub














Class PinupNULL ' Dummy Pinup class so I dont have to keep adding if cases when people dont choose pinup
  Public Sub LabelShowPage(screen, pagenum, vis, Special)
  End Sub
  Public Sub LabelSet(screen, label, text, vis, Special)
  End Sub
  Public Sub playlistplayex(screen, dir, fname, volume, priority)
  End Sub
End Class


'********************* START OF PUPDMD FRAMEWORK v1.0 *************************
'******************** DO NOT MODIFY STUFF BELOW   THIS LINE!!!! ***************
'******************************************************************************
'*****   Create a PUPPack within PUPPackEditor for layout config!!!  **********
'******************************************************************************
'
'
'  Quick Steps:
'      1>  create a folder in PUPVideos with Starter_PuPPack.zip and call the folder "yourgame"
'      2>  above set global variable pGameName="yourgame"
'      3>  copy paste the settings section above to top of table script for user changes.
'      4>  on Table you need to create ONE timer only called pupDMDUpdate and set it to 250 ms enabled on startup.
'      5>  go to your table1_init or table first startup function and call PUPINIT function
'      6>  Go to bottom on framework here and setup game to call the appropriate events like pStartGame (call that in your game code where needed)...etc
'      7>  attractmodenext at bottom is setup for you already,  just go to each case and add/remove as many as you want and setup the messages to show.
'      8>  Have fun and use pDMDDisplay(xxxx)  sub all over where needed.  remember its best to make a bunch of mp4 with text animations... looks the best for sure!
'
'
'Note:  for *Future Pinball* "pupDMDupdate_Timer()" timer needs to be renamed to "pupDMDupdate_expired()"  and then all is good.
'       and for future pinball you need to add the follow lines near top
'Need to use BAM and have com idll enabled.
'       Dim icom : Set icom = xBAM.Get("icom") ' "icom" is name of "icom.dll" in BAM\Plugins dir
'       if icom is Nothing then MSGBOX "Error cannot run without icom.dll plugin"
'       Function CreateObject(className)
'             Set CreateObject = icom.CreateObject(className)
'       End Function


Const HasPuP = True   'dont set to false as it will break pup

Const pTopper=0
Const pDMD=1
Dim pBackglass:pBackglass=5
'Const pBackglass=2
Const pPlayfield=3
Const pMusic=4
Const pAudio=14
Const pCallouts=6
Const pBackglass2=7
Const pPup0=8
Const pBonusScreen = 12
Const pOverVid=13
Const pPopUP1=11
Const pPopUP2=12
Const pPopUP3=13
Const pPopUP4=14
Const pPopUP5=15
Const pPopUP6=16
Const pPopUP7=17
Const pPopUP8=18
Const pPopUP9=19
'Const pOverlayFrame=13

'pages
Const pDMDBlank=0
Const pScores=1
Const pBigLine=2
Const pThreeLines=3
Const pTwoLines=4
Const pTargerLetters=5

'dmdType
Const pDMDTypeLCD=0
Const pDMDTypeReal=1
Const pDMDTypeFULL=2






Dim PuPlayer
dim PUPDMDObject  'for realtime mirroring.
Dim pDMDlastchk: pDMDLastchk= -1    'performance of updates
Dim pDMDCurPage: pDMDCurPage= 0     'default page is empty.
Dim pInAttract : pInAttract=false   'pAttract mode




'*************  starts PUP system,  must be called AFTER b2s/controller running so put in last line of table1_init
Sub PuPInit

on error resume next
Set PuPlayer = CreateObject("PinUpPlayer.PinDisplay")
'puPlayer.Init pBonusScreen, ""
PuPlayer.B2SInit "", pGameName
on error goto 0
if not IsObject(PuPlayer) then bUsePUPDMD=False


if (PuPDMDDriverType=pDMDTypeReal) and (useRealDMDScale=1) Then
       PuPlayer.setScreenEx pDMD,0,0,128,32,0  'if hardware set the dmd to 128,32
End if

PuPlayer.LabelInit pBackglass
PuPlayer.LabelInit pDMD

if PuPDMDDriverType=pDMDTypeReal then
  Set PUPDMDObject = CreateObject("PUPDMDControl.DMD")
  PUPDMDObject.DMDOpen
  PUPDMDObject.DMDPuPMirror
  PUPDMDObject.DMDPuPTextMirror
  PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 1, ""FN"":33 }"             'set pupdmd for mirror and hide behind other pups
  PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 1, ""FN"":32, ""FQ"":3 }"   'set no antialias on font render if real
Else
  PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 2, ""FN"":33 }"             'set pupdmd for mirror and hide behind other pups

END IF



pSetPageLayouts
pDMDSetPage(pDMDBlank)   'set blank text overlay page.
pDMDStartUP        ' firsttime running for like an startup video..




End Sub 'end PUPINIT



'PinUP Player DMD Helper Functions

Sub pDMDLabelHide(labName)
  PuPlayer.LabelSet pDMD,labName,"",0,""
end sub




Sub pDMDScrollBig(msgText,timeSec,mColor)
PuPlayer.LabelShowPage pDMD,2,timeSec,""
PuPlayer.LabelSet pDMD,"Splash",msgText,0,"{'mt':1,'at':2,'xps':1,'xpe':-1,'len':" & (timeSec*1000000) & ",'mlen':" & (timeSec*1000) & ",'tt':0,'fc':" & mColor & "}"
end sub

Sub pDMDScrollBigV(msgText,timeSec,mColor)
PuPlayer.LabelShowPage pDMD,2,timeSec,""
PuPlayer.LabelSet pDMD,"Splash",msgText,0,"{'mt':1,'at':2,'yps':1,'ype':-1,'len':" & (timeSec*1000000) & ",'mlen':" & (timeSec*1000) & ",'tt':0,'fc':" & mColor & "}"
end sub


Sub pDMDSplashScore(msgText,timeSec,mColor)
PuPlayer.LabelSet pDMD,"MsgScore",msgText,0,"{'mt':1,'at':1,'fq':250,'len':"& (timeSec*1000) &",'fc':" & mColor & "}"
end Sub

Sub pDMDSplashScoreScroll(msgText,timeSec,mColor)
PuPlayer.LabelSet pDMD,"MsgScore",msgText,0,"{'mt':1,'at':2,'xps':1,'xpe':-1,'len':"& (timeSec*1000) &", 'mlen':"& (timeSec*1000) &",'tt':0, 'fc':" & mColor & "}"
end Sub

Sub pDMDZoomBig(msgText,timeSec,mColor)  'new Zoom
PuPlayer.LabelShowPage pDMD,2,timeSec,""
PuPlayer.LabelSet pDMD,"Splash",msgText,0,"{'mt':1,'at':3,'hstart':5,'hend':80,'len':" & (timeSec*1000) & ",'mlen':" & (timeSec*500) & ",'tt':5,'fc':" & mColor & "}"
end sub

Sub pDMDTargetLettersInfo(msgText,msgInfo, timeSec)  'msgInfo = '0211'  0= layer 1, 1=layer 2, 2=top layer3.
'this function is when you want to hilite spelled words.  Like B O N U S but have O S hilited as already hit markers... see example.
PuPlayer.LabelShowPage pDMD,5,timeSec,""  'show page 5
Dim backText
Dim middleText
Dim flashText
Dim curChar
Dim i
Dim offchars:offchars=0
Dim spaces:spaces=" "  'set this to 1 or more depends on font space width.  only works with certain fonts
                          'if using a fixed font width then set spaces to just one space.

For i=1 To Len(msgInfo)
    curChar="" & Mid(msgInfo,i,1)
    if curChar="0" Then
            backText=backText & Mid(msgText,i,1)
            middleText=middleText & spaces
            flashText=flashText & spaces
            offchars=offchars+1
    End If
    if curChar="1" Then
            backText=backText & spaces
            middleText=middleText & Mid(msgText,i,1)
            flashText=flashText & spaces
    End If
    if curChar="2" Then
            backText=backText & spaces
            middleText=middleText & spaces
            flashText=flashText & Mid(msgText,i,1)
    End If
Next

if offchars=0 Then 'all litup!... flash entire string
   backText=""
   middleText=""
   FlashText=msgText
end if

PuPlayer.LabelSet pDMD,"Back5"  ,backText  ,1,""
PuPlayer.LabelSet pDMD,"Middle5",middleText,1,""
PuPlayer.LabelSet pDMD,"Flash5" ,flashText ,0,"{'mt':1,'at':1,'fq':150,'len':" & (timeSec*1000) & "}"
end Sub


Sub pDMDSetPage(pagenum)
  If (bUsePUPDMD) then
    Debug.print "Changing Page: " & pagenum
    PuPlayer.LabelShowPage pDMD,pagenum,0,""   'set page to blank 0 page if want off
    PDMDCurPage=pagenum
  End if
end Sub

Sub pHideOverlayText(pDisp)
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "& pDisp &", ""FN"": 34 }"             'hideoverlay text during next videoplay on DMD auto return
end Sub



Sub pDMDShowLines3(msgText,msgText2,msgText3,timeSec)
Dim vis:vis=1
if pLine1Ani<>"" Then vis=0
PuPlayer.LabelShowPage pDMD,3,timeSec,""
PuPlayer.LabelSet pDMD,"Splash3a",msgText,vis,pLine1Ani
PuPlayer.LabelSet pDMD,"Splash3b",msgText2,vis,pLine2Ani
PuPlayer.LabelSet pDMD,"Splash3c",msgText3,vis,pLine3Ani
end Sub


Sub pDMDShowLines2(msgText,msgText2,timeSec)
Dim vis:vis=1
if pLine1Ani<>"" Then vis=0
PuPlayer.LabelShowPage pDMD,4,timeSec,""
PuPlayer.LabelSet pDMD,"Splash4a",msgText,vis,pLine1Ani
PuPlayer.LabelSet pDMD,"Splash4b",msgText2,vis,pLine2Ani
end Sub

Sub pDMDShowCounter(msgText,msgText2,msgText3,timeSec)
Dim vis:vis=1
if pLine1Ani<>"" Then vis=0
PuPlayer.LabelShowPage pDMD,6,timeSec,""
PuPlayer.LabelSet pDMD,"Splash6a",msgText,vis, pLine1Ani
PuPlayer.LabelSet pDMD,"Splash6b",msgText2,vis,pLine2Ani
PuPlayer.LabelSet pDMD,"Splash6c",msgText3,vis,pLine3Ani
end Sub


Sub pDMDShowBig(msgText,timeSec, mColor)
Dim vis:vis=1
if pLine1Ani<>"" Then vis=0
PuPlayer.LabelShowPage pDMD,2,timeSec,""
PuPlayer.LabelSet pDMD,"Splash",msgText,vis,pLine1Ani
end sub


Sub pDMDShowHS(msgText,msgText2,msgText3,timeSec) 'High Score
Dim vis:vis=1
if pLine1Ani<>"" Then vis=0
PuPlayer.LabelShowPage pDMD,7,timeSec,""
PuPlayer.LabelSet pDMD,"Splash7a",msgText,vis,pLine1Ani
PuPlayer.LabelSet pDMD,"Splash7b",msgText2,vis,pLine2Ani
PuPlayer.LabelSet pDMD,"Splash7c",msgText3,vis,pLine3Ani
end Sub


Sub pDMDSetBackFrame(fname)
  PuPlayer.playlistplayex pDMD,"PUPFrames",fname,0,1
end Sub

Sub pDMDStartBackLoop(fPlayList,fname)
  PuPlayer.playlistplayex pDMD,fPlayList,fname,0,1
  PuPlayer.SetBackGround pDMD,1
end Sub

Sub pDMDStopBackLoop
  PuPlayer.SetBackGround pDMD,0
  PuPlayer.playstop pDMD
end Sub


Dim pNumLines

'Theme Colors for Text (not used currenlty,  use the |<colornum> in text labels for colouring.
Dim SpecialInfo
Dim pLine1Color : pLine1Color=8454143
Dim pLine2Color : pLine2Color=8454143
Dim pLine3Color :  pLine3Color=8454143
Dim curLine1Color: curLine1Color=pLine1Color  'can change later
Dim curLine2Color: curLine2Color=pLine2Color  'can change later
Dim curLine3Color: curLine3Color=pLine3Color  'can change later


Dim pDMDCurPriority: pDMDCurPriority =-1
Dim pDMDDefVolume: pDMDDefVolume = 0   'default no audio on pDMD

Dim pLine1
Dim pLine2
Dim pLine3
Dim pLine1Ani
Dim pLine2Ani
Dim pLine3Ani

Dim PriorityReset:PriorityReset=-1
DIM pAttractReset:pAttractReset=-1
DIM pAttractBetween: pAttractBetween=2000 '1 second between calls to next attract page
DIM pDMDVideoPlaying: pDMDVideoPlaying=false


'************************ where all the MAGIC goes,  pretty much call this everywhere  ****************************************
'*************************                see docs for examples                ************************************************
'****************************************   DONT TOUCH THIS CODE   ************************************************************

Sub pupDMDDisplay(pEventID, pText, VideoName,TimeSec, pAni,pPriority)
' pEventID = reference if application,
' pText = "text to show" separate lines by ^ in same string
' VideoName "gameover.mp4" will play in background  "@gameover.mp4" will play and disable text during gameplay.
'       also global variable useDMDVideos=true/false if user wishes only TEXT
' TimeSec how long to display msg in Seconds
' animation if any 0=none 1=Flasher
' also,  now can specify color of each line (when no animation).  "sometext|12345"  will set label to "sometext" and set color to 12345

DIM curPos
  if pDMDCurPriority>pPriority then
    Exit Sub  'if something is being displayed that we don't want interrupted.  same level will interrupt.
    Debug.print "DMD Skipping - Hi Pri"
  End If
  pDMDCurPriority=pPriority
  if timeSec=0 then timeSec=1 'don't allow page default page by accident


  pLine1=""
  pLine2=""
  pLine3=""
  pLine1Ani=""
  pLine2Ani=""
  pLine3Ani=""


  if pAni=1 Then  'we flashy now aren't we
  pLine1Ani="{'mt':1,'at':1,'fq':150,'len':" & (timeSec*1000) &  "}"
  pLine2Ani="{'mt':1,'at':1,'fq':150,'len':" & (timeSec*1000) &  "}"
  pLine3Ani="{'mt':1,'at':1,'fq':150,'len':" & (timeSec*1000) &  "}"
  end If

  curPos=InStr(pText,"^")   'Lets break apart the string if needed
  if curPos>0 Then
     pLine1=Left(pText,curPos-1)
     pText=Right(pText,Len(pText) - curPos)

     curPos=InStr(pText,"^")   'Lets break apart the string
     if curPOS>0 Then
      pLine2=Left(pText,curPos-1)
      pText=Right(pText,Len(pText) - curPos)

      curPos=InStr("^",pText)   'Lets break apart the string
      if curPos>0 Then
       pline3=Left(pText,curPos-1)
      Else
      if pText<>"" Then pline3=pText
      End if
     Else
      if pText<>"" Then pLine2=pText
     End if
  Else
    pLine1=pText  'just one line with no break
  End if


  'lets see how many lines to Show
  pNumLines=0
  if pLine1<>"" then pNumLines=pNumlines+1
  if pLine2<>"" then pNumLines=pNumlines+1
  if pLine3<>"" then pNumLines=pNumlines+1

  if pDMDVideoPlaying Then
        PuPlayer.playstop pDMD
        pDMDVideoPlaying=False
  End if


  if (VideoName<>"") and (useDMDVideos) Then  'we are showing a splash video instead of the text.

    PuPlayer.playlistplayex pDMD,"DMDSplash",VideoName,pDMDDefVolume,pPriority  'should be an attract background (no text is displayed)
    pDMDVideoPlaying=true
  end if 'if showing a splash video with no text


  if StrComp(pEventID,"shownum",1)=0 Then              'check eventIDs
    pDMDShowCounter pLine1,pLine2,pLine3,timeSec
  Elseif StrComp(pEventID,"target",1)=0 Then              'check eventIDs
    pDMDTargetLettersInfo pLine1,pLine2,timeSec
  Elseif StrComp(pEventID,"highscore",1)=0 Then              'check eventIDs
    pDMDShowHS pLine1,pLine2,pline3,timeSec
  Elseif (pNumLines=3) Then                'depends on # of lines which one to use.  pAni=1 will flash.
    pDMDShowLines3 pLine1,pLine2,pLine3,TimeSec
  Elseif (pNumLines=2) Then
    pDMDShowLines2 pLine1,pLine2,TimeSec
  Elseif (pNumLines=1) Then
    pDMDShowBig pLine1,timeSec, curLine1Color
  Else
    pDMDShowBig pLine1,timeSec, curLine1Color
  End if

  PriorityReset=TimeSec*1000
End Sub 'pupDMDDisplay message

Sub pupDMDupdate_Timer()
  pUpdateScores

    if PriorityReset>0 Then  'for splashes we need to reset current prioirty on timer
    PriorityReset=PriorityReset-pupDMDUpdate.interval
    if PriorityReset<=0 Then
            pDMDCurPriority=-1
            if pInAttract then pAttractReset=pAttractBetween ' pAttractNext  call attract next after 1 second
      pDMDVideoPlaying=false
    End if
    End if

    if pAttractReset>0 Then  'for splashes we need to reset current prioirty on timer
    pAttractReset=pAttractReset-pupDMDUpdate.interval
    if pAttractReset<=0 Then
            pAttractReset=-1
            if pInAttract then pAttractNext
    End if
    end if
End Sub

Sub PuPEvent(EventNum)
if hasPUP=false then Exit Sub
PuPlayer.B2SData "E"&EventNum,1  'send event to puppack driver
End Sub


'********************* END OF PUPDMD FRAMEWORK v1.0 *************************
'******************** DO NOT MODIFY STUFF ABOVE THIS LINE!!!! ***************
'****************************************************************************

'*****************************************************************
'   **********  PUPDMD  MODIFY THIS SECTION!!!  ***************
'PUPDMD Layout for each Table1
'Setup Pages.  Note if you use fonts they must be in FONTS folder of the pupVideos\tablename\FONTS  "case sensitive exact naming fonts!"
'*****************************************************************

Sub pSetPageLayouts

DIM dmddef
DIM dmdalt
DIM dmdscr
DIM dmdfixed
DIM digitLCD
DIM guardians

'labelNew <screen#>, <Labelname>, <fontName>,<size%>,<colour>,<rotation>,<xalign>,<yalign>,<xpos>,<ypos>,<PageNum>,<visible>
'***********************************************************************'
'<screen#>, in standard wed set this to pDMD ( or 1)
'<Labelname>, your name of the label. keep it short no spaces (like 8 chars) although you can call it anything really. When setting the label you will use this labelname to access the label.
'<fontName> Windows font name, this must be exact match of OS front name. if you are using custom TTF fonts then double check the name of font names.
'<size%>, Height as a percent of display height. 20=20% of screen height.
'<colour>, integer value of windows color.
'<rotation>, degrees in tenths   (900=90 degrees)
'<xAlign>, 0= horizontal left align, 1 = center horizontal, 2= right horizontal
'<yAlign>, 0 = top, 1 = center, 2=bottom vertical alignment
'<xpos>, this should be 0, but if you want to force a position you can set this. it is a % of horizontal width. 20=20% of screen width.
'<ypos> same as xpos.
'<PageNum> IMPORTANT this will assign this label to this page or group.
'<visible> initial state of label. visible=1 show, 0 = off.

' Overlay
  'puPlayer.LabelInit pOverlayFrame

' Backglass - this is basically the FullLCD-DMD
'   --------------------------------Guardians2------------------------------
' Prgrs | Player             MessageT              Ball
'     |  TimeLbl                  MTimer
'   |  Time
'   | RampTimer/RampImg         Guardians
'   | MPx              Message
'   |                  Timer
'   | Play1Score   Play2Score   CurScore  Play3Score  Play4Score
'   -------------------------------------------------------------------------
'
  digitLCD="DIGIT LCD"
  dmdscr="Impact"    'main scorefont
  guardians="Guardians"

'            Scrn LblName    Fnt          Size  Color             R AxAy X Y pagenum Visible
  puPlayer.LabelInit pBackglass
  ' NOTE THE 2 LINES BELOW ENSURE the TEXT OVERLAPS the IMAGE (Thanks Nailbuster)  - LabelNew: visible=0
  puPlayer.LabelNew pBackglass,"ModeProgress",dmdscr,   10*FontScale,RGB(255, 255, 255)   ,0,0,0 ,0,0    ,1,0         ' Mode Progress Image (NOT VISIBLE)
  puPlayer.LabelSet pBackglass,"ModeProgress", "PuPOverlays\\Progress5-0.png",0,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"

  puPlayer.LabelNew pBackglass,"RampImg",digitLCD,  4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' Rampage Countdown timer Image
  puPlayer.LabelSet pBackglass,"RampImg", "PuPOverlays\\Rampage.gif", 0,"{'mt':2,'color':111111,'width':15, 'height':24, 'anigif':100,'pagenum':1}"

  puPlayer.LabelNew pBackglass,"PopImg0",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg0", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore0",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,10,60  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg1",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg1", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore1",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,20,50  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg2",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg2", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore2",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,30,60  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg3",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg3", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore3",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,40,50  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg4",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg4", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore4",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,50,60  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg5",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg5", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore5",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,60,50  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg6",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg6", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore6",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,70,60  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg7",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg7", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore7",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,80,50  ,1,0         ' PopBumper Score

  puPlayer.LabelNew pBackglass,"PopImg8",guardians, 4,RGB(255, 255, 255)            ,0,0,0 ,0,38  ,1,0          ' PopBumper Image
  puPlayer.LabelSet pBackglass,"PopImg8", "PuPOverlays\\BumperPop.gif", 0,"{'mt':2,'color':111111,'ypos':40,'xpos':10,'width':15, 'height':24, 'anigif':100,'pagenum':1}"
  puPlayer.LabelNew pBackglass,"PopScore8",guardians, 7*FontScale,RGB(255, 255, 255)      ,0,0,0 ,90,60  ,1,0         ' PopBumper Score


  puPlayer.LabelNew pBackglass,"Guardians2",dmdscr,   7*FontScale,RGB(255, 255, 255)  ,0,1,0 ,0,0    ,1,1         ' Image fills in Guardians as you spell it
  puPlayer.LabelNew pBackglass,"MessageT",dmdscr,     7*FontScale,RGB(255, 255, 255)  ,0,1,0 ,0,0    ,1,1           ' Top middle message for "Please select mission"
  puPlayer.LabelNew pBackglass,"Ball"    ,dmdscr,     5*FontScale,RGB(255, 255, 255)  ,0,2,0 ,0,0    ,1,1
  puPlayer.LabelNew pBackglass,"Player"  ,dmdscr,     5*FontScale,RGB(255, 255, 255)  ,0,0,0 ,3,0    ,1,1
  puPlayer.LabelNew pBackglass,"MTimer"  ,dmdscr,     7*FontScale,RGB(255, 255, 255)  ,0,2,0 ,75,13  ,1,1           ' Says 3/2X for XX Seconds
  puPlayer.LabelNew pBackglass,"CurScore",dmdscr,     15*FontScale,RGB(255, 255, 255) ,0,1,2 ,0,0    ,1,1
  puPlayer.LabelNew pBackglass,"Timer"   ,dmdscr,     11*FontScale,RGB(255, 255, 255) ,0,1,0 ,0,75   ,1,1           ' Used for the counddown on the hurry up
  puPlayer.LabelNew pBackglass,"Message" ,dmdscr,     18*FontScale,RGB(255, 255, 255) ,0,1,0 ,0,65   ,1,1           ' Shows how many points we got on the hurry up timer
  puPlayer.LabelNew pBackglass,"Guardians",guardians,   20*FontScale,827358         ,0,1,0 ,0,45   ,1,1           ' Pops up letters when we spell GUARDIANS
  puPlayer.LabelNew pBackglass,"Rampage",guardians,   20*FontScale,255          ,0,1,0 ,0,45   ,1,1           ' Pops up letters when we spell RAMPAGE

  puPlayer.LabelNew pBackglass,"Popup1",guardians,    15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,25   ,1,1         ' Pupup 3 Liner Messages
  puPlayer.LabelNew pBackglass,"Popup2",guardians,    18*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,40   ,1,1         ' Pupup 3 Liner Messages
  puPlayer.LabelNew pBackglass,"Popup3",guardians,    15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,65   ,1,1         ' Pupup 3 Liner Messages

  puPlayer.LabelNew pBackglass,"Play1score",dmdscr,   6*FontScale,RGB(255, 255, 255)    ,0,1,2 ,0,0    ,1,1           ' Not using these yet since they move based on number of players
  puPlayer.LabelNew pBackglass,"Play2score",dmdscr,   6*FontScale,RGB(255, 255, 255)    ,0,1,2 ,0,0    ,1,1
  puPlayer.LabelNew pBackglass,"Play3score",dmdscr,   6*FontScale,RGB(255, 255, 255)    ,0,1,2 ,0,0    ,1,1
  puPlayer.LabelNew pBackglass,"Play4score",dmdscr,   6*FontScale,RGB(255, 255, 255)    ,0,1,2 ,0,0    ,1,1
  puPlayer.LabelNew pBackglass,"TimeLbl",dmdscr,      5*FontScale,RGB(255, 255, 255)    ,0,0,0 ,5,5.2  ,1,1         ' Just has the word Timer
  puPlayer.LabelNew pBackglass,"Time",digitLCD,     8*FontScale,RGB(255, 255, 255)    ,0,0,0 ,5,9.5  ,1,1         ' Shows remaining time
  puPlayer.LabelNew pBackglass,"MPx",guardians,     8*FontScale,111111          ,0,0,0 ,5,75  ,1,1          ' Shows show mulltipliers when it is > 1
  puPlayer.LabelNew pBackglass,"RampTimer",digitLCD,    5*FontScale,RGB(255, 255, 255)    ,0,0,0 ,3.5,46.5  ,1,1          ' Rampage Countdown timer

  'PuPlayer.LabelShowPage pBackglass, 1,0,""

  puPlayer.LabelSet pBackglass,"TimeLbl", "Timer" ,1,""
  'puPlayer.LabelSet pBackglass, "ModeProgress", "PuPOverlays\\Progress5-0.png",1,"{'mt':2,'color':111111,'width':17, 'height':24,'yalign':0,'ypos':4.5,'xpos':0,'pagenum':1}"


  puPlayer.LabelNew pBackglass,"HighScore1",guardians,  15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,25   ,2,1       ' Attract screen so when we show the Bonus we dont see all this info
  puPlayer.LabelNew pBackglass,"HighScore2",guardians,  15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,45   ,2,1       ' Attract screen so when we show the Bonus we dont see all this info
  puPlayer.LabelNew pBackglass,"HighScore3",guardians,  15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,75   ,2,1       ' Attract screen so when we show the Bonus we dont see all this info
  PuPlayer.LabelShowPage pBackglass, 2,0,""


  'PuPlayer.LabelShowPage pBackglass, 1,0,""
  'PuPlayer.LabelSet pBackglass, "Guardians2", "PuPOverlays\\GUARDIAN-1.png",1,"{'mt':2,'color':111111,'width':31, 'height':8,'yalign':0,'ypos':0.0,'xpos':50.4}"


  puPlayer.LabelNew pBackglass,"EnterHS1",guardians,  12*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,25   ,3,1       ' HS Entry
  puPlayer.LabelNew pBackglass,"EnterHS2",guardians,  15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,45   ,3,1       ' HS Entry
  puPlayer.LabelNew pBackglass,"EnterHS3",guardians,  15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,75   ,3,1       ' HS Entry


  ' Page 1 (OverVideo)
  puPlayer.LabelInit pOverVid
  puPlayer.LabelNew pOverVid,"OverMessage1",guardians,  15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,25   ,1,1       '
  puPlayer.LabelNew pOverVid,"OverMessage2",guardians,  18*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,45   ,1,1       '
  puPlayer.LabelNew pOverVid,"OverMessage3",guardians,  15*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,65   ,1,1       '
  PuPlayer.LabelShowPage pOverVid, 1,0,""

  ' Page 2 (OverVideo - Immolation Progress)
'   -------------------------------------------------------------------------
'   |
'   |  P0                         P4
'   |  P1                       P5
'   |  P2                       P6
'   |  P3                       P7
'   |  pOrb                       PGroot
'   |
'   -------------------------------------------------------------------------
  puPlayer.LabelNew pOverVid,"P7",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,0,0 ,10,43   ,2,1        '
  puPlayer.LabelNew pOverVid,"P0",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,0,0 ,10,50   ,2,1        '
  puPlayer.LabelNew pOverVid,"P1",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,0,0 ,10,57   ,2,1        '
  puPlayer.LabelNew pOverVid,"P2",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,0,0 ,10,64   ,2,1        '
  puPlayer.LabelNew pOverVid,"POrb",guardians,      5*FontScale,RGB(255, 255, 255)    ,0,0,0 ,10,71   ,2,1        '
  puPlayer.LabelNew pOverVid,"P6",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,2,0 ,90,43   ,2,1        '
  puPlayer.LabelNew pOverVid,"P5",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,2,0 ,90,50   ,2,1        '
  puPlayer.LabelNew pOverVid,"P4",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,2,0 ,90,57   ,2,1        '
  puPlayer.LabelNew pOverVid,"P3",guardians,        5*FontScale,RGB(255, 255, 255)    ,0,2,0 ,90,64   ,2,1        '
  puPlayer.LabelNew pOverVid,"PGroot",guardians,      5*FontScale,RGB(255, 255, 255)    ,0,2,0 ,90,71   ,2,1        '

  ' Page 3 (OverVideo - Finish Mode)
'   -------------------------------------------------------------------------
'   |
'   | Scattered for Spinning finish
'   |
'   -------------------------------------------------------------------------
  puPlayer.LabelNew pOverVid,"F0",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F1",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F2",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F3",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F4",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F5",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F6",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F7",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F8",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '
  puPlayer.LabelNew pOverVid,"F9",guardians,        5,RGB(255, 255, 255)    ,0,0,0 ,0,0   ,3,1        '



  ' Page 1 (Bonus)
'   -------------------------------------------------------------------------
'   |                   MessageT
'   |
'   |
'   |
'   |                Message1
'   |                  Message2
'   |
'   -------------------------------------------------------------------------
'
  puPlayer.LabelInit pBonusScreen

' puPlayer.LabelNew pBonusScreen,"Blade1" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
' puPlayer.LabelNew pBonusScreen,"Blade2" ,dmdscr,    18,RGB(255, 255, 255)   ,0,2,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus1" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus2" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus3" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus4" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus5" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus6" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus7" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus8" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image
  puPlayer.LabelNew pBonusScreen,"Bonus9" ,dmdscr,    18,RGB(255, 255, 255)   ,0,0,0 ,0,0   ,1,1            ' Bonus Image

  puPlayer.LabelNew pBonusScreen,"Message1" ,dmdscr,    18*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,65   ,1,1           ' Shows the Bonus
  puPlayer.LabelNew pBonusScreen,"Message2" ,dmdscr,    18*FontScale,RGB(255, 255, 255)   ,0,1,0 ,0,78   ,1,1           ' Shows the bonus 2nd line
  PuPlayer.LabelShowPage pBonusScreen,1,0,""

' Testing Blades: 'TBD: Trying to Animate these but cant seem to animate and resize
' pDMDEvent(kDMD_BonusBG)
' playmedia "Video-0x007A-2.mp4", "PupVideos", pBonusScreen, "", -1, "", 1, 1
' PuPlayer.LabelSet pBonusScreen, "Blade1", "PuPOverlays\\BonusScreen-BW-Blade1.png",1,"{'mt':2,'color':111111,'width':99.5, 'height':95,'yalign':0,'ypos':50.5,'xpos':0}"
' PuPlayer.LabelSet pBonusScreen, "Blade1", "PuPOverlays\\BonusScreen-BW-Blade1.png",1,"{'mt':1,'at':2,'xps':-1,'xpe':0,'len':2000,'mlen':2000}"
' PuPlayer.LabelSet pBonusScreen, "Blade2", "PuPOverlays\\BonusScreen-BW-Blade2.png",1,"{'mt':2,'color':111111,'width':99.5, 'height':95,'yalign':0,'ypos':2.8,'xpos':0}"

' PuPlayer.LabelSet pBonusScreen, "Bonus1", "PuPOverlays\\Bonus1.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':3}"
' PuPlayer.LabelSet pBonusScreen, "Bonus2", "PuPOverlays\\Bonus2.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':13}"
' PuPlayer.LabelSet pBonusScreen, "Bonus3", "PuPOverlays\\Bonus3.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':22.5}"
' PuPlayer.LabelSet pBonusScreen, "Bonus4", "PuPOverlays\\Bonus4.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':31.5}"
' PuPlayer.LabelSet pBonusScreen, "Bonus5", "PuPOverlays\\Bonus5.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':40.5}"
' PuPlayer.LabelSet pBonusScreen, "Bonus6", "PuPOverlays\\Bonus6.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':50}"
' PuPlayer.LabelSet pBonusScreen, "Bonus7", "PuPOverlays\\Bonus7.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':59.5}"
' PuPlayer.LabelSet pBonusScreen, "Bonus8", "PuPOverlays\\Bonus8.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':68.2}"
' PuPlayer.LabelSet pBonusScreen, "Bonus9", "PuPOverlays\\Bonus9.png",1,"{'mt':2,'color':111111,'width':18.5, 'height':48.8,'yalign':0,'ypos':10.5,'xpos':78}"


if PuPDMDDriverType=pDMDTypeReal Then 'using RealDMD Mirroring.  **********  128x32 Real Color DMD
  dmdalt="PKMN Pinball"
    dmdfixed="Instruction"
    dmdscr="Impact"    'main scorefont
  dmddef="Gameplay"


  ' Player          Balls
  '         SCORE
  '
  '         Switch    Credits


  'Page 1 (default score display)
  '            Scrn LblName    Fnt    Size  Color       R AxAy X Y pagenum Visible
     PuPlayer.LabelNew pDMD,"Player"  ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,1,0,0, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"Ball"    ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,1,2,0, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"CurScore",dmdscr,50*FontScaleDmd ,RGB(255, 255, 255),0,1,2, 0,68,  1,  0
     PuPlayer.LabelNew pDMD,"Status"  ,dmddef,30*FontScaleDmd ,RGB(255, 255, 255) ,0,0,2, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"Credits" ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,0,2,2, 0,0,  1,  0
' '            Scrn LblName    Fnt    Size  Color  R AxAy X Y pagenum Visible
'      PuPlayer.LabelNew pDMD,"Credits" ,dmddef,20  ,33023  ,0,2,2,95,0,  1,  0
'    PuPlayer.LabelNew pDMD,"Play1"   ,dmdalt,21  ,33023  ,1,0,0,15,0,  1,  0
'    PuPlayer.LabelNew pDMD,"Ball"    ,dmdalt,21  ,33023  ,1,2,0,85,0,  1,  0
'    PuPlayer.LabelNew pDMD,"MsgScore",dmddef,45  ,33023  ,0,1,0, 0,40, 1,  0
'    PuPlayer.LabelNew pDMD,"CurScore",dmdscr,60  ,8454143,0,1,1, 0,0,  1,  0


  'Page 2 (default Text Splash 1 Big Line)
     PuPlayer.LabelNew pDMD,"Splash"  ,dmdalt,40*FontScaleDmd,33023,0,1,1,0,0,2,0

  'Page 3 (default Text Splash 2 and 3 Lines)
     PuPlayer.LabelNew pDMD,"Splash3a",dmddef,30*FontScaleDmd,8454143,0,1,0,0,2,3,0
     PuPlayer.LabelNew pDMD,"Splash3b",dmdalt,30*FontScaleDmd,33023,0,1,0,0,30,3,0
       PuPlayer.LabelNew pDMD,"Splash3c",dmdalt,25*FontScaleDmd,33023,0,1,0,0,55,3,0


  'Page 4 (2 Line Gameplay DMD)
     PuPlayer.LabelNew pDMD,"Splash4a",dmddef,40*FontScaleDmd,8454143,0,1,0,0,0,4,0
       PuPlayer.LabelNew pDMD,"Splash4b",dmddef,30*FontScaleDmd,33023,0,1,2,0,75,4,0

  'Page 5 (3 layer large text for overlay targets function,  must you fixed width font!
    PuPlayer.LabelNew pDMD,"Back5"    ,dmdfixed,80*FontScaleDmd,8421504,0,1,1,0,0,5,0
    PuPlayer.LabelNew pDMD,"Middle5"  ,dmdfixed,80*FontScaleDmd,65535  ,0,1,1,0,0,5,0
    PuPlayer.LabelNew pDMD,"Flash5"   ,dmdfixed,80*FontScaleDmd,65535  ,0,1,1,0,0,5,0

  'Page 6 (3 Lines for big # with two lines,  "19^Orbits^Count")
    PuPlayer.LabelNew pDMD,"Splash6a",dmddef,90*FontScaleDmd,65280,0,0,0,15,1,6,0
    PuPlayer.LabelNew pDMD,"Splash6b",dmddef,50*FontScaleDmd,33023,0,1,0,60,0,6,0
    PuPlayer.LabelNew pDMD,"Splash6c",dmddef,40*FontScaleDmd,33023,0,1,0,60,50,6,0

  'Page 7 (Show High Scores Fixed Fonts)
    PuPlayer.LabelNew pDMD,"Splash7a",dmddef,20*FontScaleDmd,8454143,0,1,0,0,2,7,0
    PuPlayer.LabelNew pDMD,"Splash7b",dmdfixed,40*FontScaleDmd,33023,0,1,0,0,20,7,0
    PuPlayer.LabelNew pDMD,"Splash7c",dmdfixed,40*FontScaleDmd,33023,0,1,0,0,50,7,0


END IF  ' use PuPDMDDriver

if PuPDMDDriverType=pDMDTypeLCD THEN  'Using 4:1 Standard ratio LCD PuPDMD  ************ lcd **************

  'dmddef="Impact"
  dmdalt="PKMN Pinball"
    dmdfixed="Instruction"
  dmdscr="Impact"  'main score font
  dmddef="Impact"

  'Page 1 (default score display)
  '            Scrn LblName    Fnt    Size  Color  R AxAy X Y pagenum Visible
     PuPlayer.LabelNew pDMD,"Player"  ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,1,0,0, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"Ball"    ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,1,2,0, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"CurScore",dmdscr,50*FontScaleDmd ,RGB(255, 255, 255),0,1,2, 0,60,  1,  0
     PuPlayer.LabelNew pDMD,"Status"  ,dmddef,30*FontScaleDmd ,RGB(255, 255, 255) ,0,0,2, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"Credits" ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,0,2,2, 0,0,  1,  0


  'Page 2 (default Text Splash 1 Big Line)
    PuPlayer.LabelNew pDMD,"Splash"  ,dmdalt,40*FontScaleDmd,33023,0,1,1,0,0,2,0

  'Page 3 (default Text 3 Lines)
    PuPlayer.LabelNew pDMD,"Splash3a",dmddef,30*FontScaleDmd,8454143,0,1,0,0,2,3,0
    PuPlayer.LabelNew pDMD,"Splash3b",dmdalt,30*FontScaleDmd,33023,0,1,0,0,30,3,0
    PuPlayer.LabelNew pDMD,"Splash3c",dmdalt,25*FontScaleDmd,33023,0,1,0,0,57,3,0


  'Page 4 (default Text 2 Line)
    PuPlayer.LabelNew pDMD,"Splash4a",dmddef,40*FontScaleDmd,8454143,0,1,0,0,0,4,0
    PuPlayer.LabelNew pDMD,"Splash4b",dmddef,30*FontScaleDmd,33023,0,1,2,0,75,4,0

  'Page 5 (3 layer large text for overlay targets function,  must you fixed width font!
    PuPlayer.LabelNew pDMD,"Back5"    ,dmdfixed,80*FontScaleDmd,8421504,0,1,1,0,0,5,0
    PuPlayer.LabelNew pDMD,"Middle5"  ,dmdfixed,80*FontScaleDmd,65535  ,0,1,1,0,0,5,0
    PuPlayer.LabelNew pDMD,"Flash5"   ,dmdfixed,80*FontScaleDmd,65535  ,0,1,1,0,0,5,0

  'Page 6 (3 Lines for big # with two lines,  "19^Orbits^Count")
    PuPlayer.LabelNew pDMD,"Splash6a",dmddef,90*FontScaleDmd,65280,0,0,0,15,1,6,0
    PuPlayer.LabelNew pDMD,"Splash6b",dmddef,50*FontScaleDmd,33023,0,1,0,60,0,6,0
    PuPlayer.LabelNew pDMD,"Splash6c",dmddef,40*FontScaleDmd,33023,0,1,0,60,50,6,0

  'Page 7 (Show High Scores Fixed Fonts)
    PuPlayer.LabelNew pDMD,"Splash7a",dmddef,20*FontScaleDmd,8454143,0,1,0,0,2,7,0
    PuPlayer.LabelNew pDMD,"Splash7b",dmdfixed,40*FontScaleDmd,33023,0,1,0,0,20,7,0
    PuPlayer.LabelNew pDMD,"Splash7c",dmdfixed,40*FontScaleDmd,33023,0,1,0,0,50,7,0


END IF  ' use PuPDMDDriver

if PuPDMDDriverType=pDMDTypeFULL THEN  'Using FULL BIG LCD PuPDMD  ************ lcd **************

  'dmddef="Impact"
  dmdalt="PKMN Pinball"
    dmdfixed="Instruction"
  dmdscr="Impact"  'main score font
  dmddef="Impact"

  'Page 1 (default score display)
  '            Scrn LblName    Fnt    Size  Color  R AxAy X Y pagenum Visible
     PuPlayer.LabelNew pDMD,"Player"  ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,1,0,0, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"Ball"    ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,1,2,0, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"CurScore",dmdscr,50*FontScaleDmd ,RGB(255, 255, 255),0,1,2, 0,60,  1,  0
     PuPlayer.LabelNew pDMD,"Status"  ,dmddef,30*FontScaleDmd ,RGB(255, 255, 255) ,0,0,2, 0,0,  1,  0
     PuPlayer.LabelNew pDMD,"Credits" ,dmddef,21*FontScaleDmd ,RGB(3, 57, 252)  ,0,2,2, 0,0,  1,  0


  'Page 2 (default Text Splash 1 Big Line)
    PuPlayer.LabelNew pDMD,"Splash"  ,dmdalt,40*FontScaleDmd,33023,0,1,1,0,0,2,0

  'Page 3 (default Text 3 Lines)
    PuPlayer.LabelNew pDMD,"Splash3a",dmddef,30*FontScaleDmd,8454143,0,1,0,0,2,3,0
    PuPlayer.LabelNew pDMD,"Splash3b",dmdalt,30*FontScaleDmd,33023,0,1,0,0,30,3,0
    PuPlayer.LabelNew pDMD,"Splash3c",dmdalt,25*FontScaleDmd,33023,0,1,0,0,57,3,0


  'Page 4 (default Text 2 Line)
    PuPlayer.LabelNew pDMD,"Splash4a",dmddef,40*FontScaleDmd,8454143,0,1,0,0,0,4,0
    PuPlayer.LabelNew pDMD,"Splash4b",dmddef,30*FontScaleDmd,33023,0,1,2,0,75,4,0

  'Page 5 (3 layer large text for overlay targets function,  must you fixed width font!
    PuPlayer.LabelNew pDMD,"Back5"    ,dmdfixed,80*FontScaleDmd,8421504,0,1,1,0,0,5,0
    PuPlayer.LabelNew pDMD,"Middle5"  ,dmdfixed,80*FontScaleDmd,65535  ,0,1,1,0,0,5,0
    PuPlayer.LabelNew pDMD,"Flash5"   ,dmdfixed,80*FontScaleDmd,65535  ,0,1,1,0,0,5,0

  'Page 6 (3 Lines for big # with two lines,  "19^Orbits^Count")
    PuPlayer.LabelNew pDMD,"Splash6a",dmddef,90*FontScaleDmd,65280,0,0,0,15,1,6,0
    PuPlayer.LabelNew pDMD,"Splash6b",dmddef,50*FontScaleDmd,33023,0,1,0,60,0,6,0
    PuPlayer.LabelNew pDMD,"Splash6c",dmddef,40*FontScaleDmd,33023,0,1,0,60,50,6,0

  'Page 7 (Show High Scores Fixed Fonts)
    PuPlayer.LabelNew pDMD,"Splash7a",dmddef,20*FontScaleDmd,8454143,0,1,0,0,2,7,0
    PuPlayer.LabelNew pDMD,"Splash7b",dmdfixed,40*FontScaleDmd,33023,0,1,0,0,20,7,0
    PuPlayer.LabelNew pDMD,"Splash7c",dmdfixed,40*FontScaleDmd,33023,0,1,0,0,50,7,0


END IF  ' use PuPDMDDriver




end Sub 'page Layouts


'*****************************************************************
'        PUPDMD Custom SUBS/Events for each Table1
'     **********    MODIFY THIS SECTION!!!  ***************
'*****************************************************************
'
'
'  we need to somewhere in code if applicable
'
'   call pDMDStartGame,pDMDStartBall,pGameOver,pAttractStart
'
'
'
'
' Background base
const kDMD_Attract      =454
const kDMD_PlayerSelect   =455
const kDMD_PlayerMode   =456
const kDMD_PlayerMode2    =457
const kDMD_BonusBG      =460  ' Shows all the characters in Vertical bars and scrolls through their bonus
const kDMD_Bonus1     =461
const kDMD_Bonus2     =462
const kDMD_Bonus3     =463
const kDMD_Bonus4     =464
const kDMD_Bonus5     =465
const kDMD_Bonus6     =466
const kDMD_Bonus7     =467
const kDMD_Bonus8     =468
const kDMD_Bonus9     =469
const kDMD_BonusClear   =470

'' Background videos
'const kDMD_BGAntiquities =471
'const kDMD_BGSibling   =472    '0x81
'const kDMD_BGEscapeKyln    =473    'Video-0x0096
'const kDMD_BGKnowhere    =474
'const kDMD_BGQuillsQuest =475
'const kDMD_BGYakaArrow   =476
'const kDMD_BGSanctuary   =477
'const kDMD_BGPodChase    =478
'const kDMD_BGThanos      =479
'const kDMD_BGCherryBomb    =480    '
'const kDMD_BGImmolation    =481    '
'const kDMD_BGXandar      =482    ' Video-0x0059

'' Background video wait (Waiting for you to hit the Ball)
'const kDMD_WBGAntiquities  =483
'const kDMD_WBGSibling    =484    '
'const kDMD_WBGEscapeKyln =485    'Video-0x000E.mp4
'const kDMD_WBGKnowhere   =486
'const kDMD_WBGQuillsQuest  =487
'const kDMD_WBGYakaArrow    =488
'const kDMD_WBGSanctuary    =489
'const kDMD_WBGPodChase   =490



' Multiball/Lost Ball
const kDMD_BallLost     =500
const kDMD_GrootBallLock1 =501    ' Video-0x0061 (3.00 seconds)
const kDMD_GrootBallLock2 =502    ' Video-0x009E (3.17 seconds)
const kDMD_GrootBallLock3 =503    ' Video-0x0006 (3.67 seconds)
const kDMD_GrootBallLock4 =504    ' This really doesnt exist because it starts MB
const kDMD_GrootMultiball =505    ' Long: Video-0x00B0   Short:Video-0x0084.mp4
const kDMD_OrbLock1     =506
const kDMD_OrbLock2     =507
const kDMD_OrbLock3     =508
const kDMD_OrbMultiball   =509


'' Once you sart a level it shows the MODE_Start video
'const kDMD_StartAntiquities  =510
'const kDMD_StartSibling    =511    '0x81
'const kDMD_StartEscapeKyln =512    '0x96
'const kDMD_StartKnowhere =513
'const kDMD_StartQuillsQuest  =514
'const kDMD_StartYakaArrow  =515
'const kDMD_StartSanctuary  =516
'const kDMD_StartPodChase =517
'const kDMD_StartThanos   =518

' Each Character slides onto the screen and stays there
'                     In        Out     Wait
const kDMD_SelAntiquities =520    ' Video-0x0066  Video-0x0042  Video-0x0036
const kDMD_SelSibling   =521    ' Video-0x0027  Video-0x0094  Video-0x0077
const kDMD_SelEscapeKyln  =522    ' Video-0x001C  Video-0x0014  Video-0x0025
const kDMD_SelKnowhere    =523    ' Video-0x0041  Video-0x0056  Video-0x001A
const kDMD_SelQuillsQuest =524    ' Video-0x000A  Video-0x0097  Video-0x005D
const kDMD_SelYakaArrow   =525    ' Video-0x0068  Video-0x002C  Video-0x0063
const kDMD_SelSanctuary   =526    ' Video-0x0039          Video-0x0018
const kDMD_SelPodChase    =527    ' Video-0x0013  Video-0x003F  Video-0x0070

' Special Modes
const kDMD_SaveXandarFinal  =530    ' Video-0x0091  (5.40 seconds)
const kDMD_SaveXandar   =531    ' Video-0x0034  (4.00 seconds)
const kDMD_HadronIsQualified=532
const kDMD_Start2nd     =533
const kDMD_StartCherryBomb  =534
const kDMD_StartImmolation  =535    ' Video-0x0079 <- I think  + Video-0x0064
const kDMD_ImmProgress    =536    ' Video-0x00A1  (8.04 seconds)

const kDMD_2MoreToLightSave =540
const kDMD_ExtraBallIsLit =541
const kDMD_HadronIsLit    =542
const kDMD_ExtraBall    =543    ' 0x40
const kDMD_GrootLockIsLit =544    ' Video-0x0076 (3.03 seconds)
const kDMD_BallSaveIsLit  =545    ' Video-0x002F
const kDMD_BallSave     =546    ' 0x0C
const kDMD_1MoreToLightLock =547
const kDMD_2MoreToLightLock =548
const kDMD_EndOfBall    =549    ' 0x7A


const kDMD_1MoreToLightOrb  =550    ' Video-0x006D
const kDMD_2MoreToLightOrb  =551    ' Video-0x009C
const kDMD_3MoreToLightOrb  =552    ' Video-0x007E
const kDMD_4MoreToLightOrb  =553    ' Video-0x0050
const kDMD_5MoreToLightOrb  =554    ' Video-0x0038
const kDMD_Orb1Collected  =555    ' Video-0x00AF
const kDMD_Orb2Collected  =556    ' Video-0x002A
const kDMD_Orb3Collected  =557    ' Video-0x008F
const kDMD_Orb4Collected  =558    ' Video-0x0030
const kDMD_Orb5Collected  =559    ' Video-0x0003
const kDMD_OrbOpened    =560    ' Video-0x0083
const kDMD_OrbIsLit     =561    ' Video-0x008D

const kDMD_Special1     =565
const kDMD_Special2     =566
const kDMD_Token      =567
const kDMD_Upgrade      =568
const kDMD_Radio      =569
const kDMD_UseHadron    =570  ' Draws pink arrows across the screen

' Misc
const kDMD_SkillShot1   =580
const kDMD_ShootAgain   =581  ' Video-0x007F
const kDMD_BallSaveAwarded  =582  ' Video-0x0087.mp4


' 2nd Modes
const kDMD_2StartAntiquities=590  ' Video-0x0005.mp4
const kDMD_2StartSibling  =591
const kDMD_2StartEscapeKyln =592  ' Video-0x003A.mp4
const kDMD_2StartKnowhere =593
const kDMD_2StartQuillsQuest=594
const kDMD_2StartYakaArrow  =595  ' Video-0x00AA.mp4
const kDMD_2StartSanctuary  =596  ' Video-0x00B2.mp4
const kDMD_2StartPodChase =597  ' Video-0x0043.mp4
const kDMD_2StartThanos   =598

const kDMD_Myst_IsLit   =599  ' Video-0x0032.mp4
const kDMD_Myst_MAX     =624    '- Bonus Mysteries Dont Count
const kDMD_Myst_Rampage   =600
const kDMD_Myst_RampageA  =601
const kDMD_Myst_RampageP  =602
const kDMD_Myst_AddABall  =603    '0x00A9.mp4
const kDMD_Myst_10Million =604
const kDMD_Myst_SpecialLit  =605
const kDMD_Myst_ShotMult  =606
const kDMD_Myst_Orb1    =607
const kDMD_Myst_2Million  =608
const kDMD_Myst_BonusHold =609    '0x003D.mp4
const kDMD_Myst_IncreasePopB=610
const kDMD_Myst_RampageR  =611
const kDMD_Myst_BonusXHold  =612    '0x006E.mp4
const kDMD_Myst_HadronLit =613
const kDMD_Myst_RampageG  =614
const kDMD_Myst_RampageE  =615
const kDMD_Myst_OrbIsLit  =616    '
const kDMD_Myst_HPhoneHurry =617    '0x0021.mp4
const kDMD_Myst_20Million =618    '0x23
const kDMD_Myst_ExtraBallLit=619    '0x0058.mp4
const kDMD_Myst_BallSaveLit =620    '0x004C.mp4

const kDMD_Myst_BonusMultiplier=624   'Increments the bonus multiplier  (KEEP THIS AT THE END)
const kDMD_Myst_Bonus2x   =625    '0x007D.mp4
const kDMD_Myst_Bonus3x   =626    '0x0057.mp4
const kDMD_Myst_Bonus4x   =627    '0x008B.mp4
const kDMD_Myst_Bonus5x   =628    '0x0046.mp4
const kDMD_Myst_Bonus6x   =629    '0x0089.mp4
const kDMD_Myst_Bonus7x   =630    '0x00B4.mp4
const kDMD_Myst_Bonus8x   =631    '0x0022.mp4
const kDMD_Myst_Bonus9x   =632    '0x0055.mp4
const kDMD_Myst_Bonus10x  =633    '0x0072.mp4

Sub pDMDStartGame
  Dim fsize
  fsize=10*FontScale
  if bUsePUPDMD then
debug.print "STOP ATTRACT"
    pInAttract=false
    if pDMDVideoPlaying Then
      PuPlayer.playstop pDMD
      pDMDVideoPlaying=False
    End if
    ' Clear the overvideo just in case it is playing
    playclear pOverVid
    PuPlayer.LabelSet pOverVid,"OverMessage1","",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2","",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage3", "", 1, "{'mt':2,'color':"&RGB(255, 255, 255)&", 'size': "&fsize&",'ypos': 65}"
    'PuPlayer.LabelSet pBackglass,"HighScore3","",1,""
    pDMDSetPage(pScores)   'set blank text overlay page.
  end If
end Sub

'Dim bBGPlayingVideo:bBGPlayingVideo=False
'Sub pBGPlayVideo(VideoName, length)
'debug.print "Starting BG Video"
' PauseSong()
' bBGPlayingVideo=True
' dim pPriority:pPriority=1
' PuPlayer.playlistplayex pBackglass,"PuPVideos",VideoName, 100, pPriority  'should be an attract background (no text is displayed)
' PuPlayer.SetBackGround pBackglass, 1
' if length <> -1 then          ' Mode video, we just play until the timer runs out and call stop (Visually looks better)
'   tmrBGVideo.Interval = length
'   tmrBGVideo.Enabled = True
' End If
'End sub
'
'Sub tmrBGVideo_Timer()
' tmrBGVideo.Enabled = False
' pBGPlayVideoDone()
'End Sub
'
'Sub pBGPauseVideo()
'
'End Sub
'
'Sub pBGPlayVideoDone()
'debug.print "Stopping BG Video"
' PuPlayer.SetBackGround pBackglass, 0
' bBGPlayingVideo=False
' pDMDEvent(kDMD_PlayerMode)
' PlaySong ""
'End Sub
'

Sub pBGPlayerSelect
  if bUsePUPDMD then
    PuPlayer.LabelShowPage pBackglass,1,0,""
    PuPlayer.LabelSet pBackglass, "Guardians2", "",0,""
    puPlayer.LabelSet pBackglass,"TimeLbl", "Timer" ,1,""
    pDMDEvent(kDMD_PlayerSelect)
    'bFlashing = True
    puPlayer.LabelSet pBackglass,"MessageT","SELECT YOUR MISSION" ,1,"{'mt':1,'at':1,'fq':250,'len':20000}"
  End If
End Sub

'  "c:\PinballX\ffmpeg.exe" -loop 1 -i BonusScreen-2.png -c:v libx264 -t 8 -pix_fmt yuv420p -vf scale=1920:1080 BonusScreen-2.mp4
'  ffmpeg -r 60 -f image2 -s 1920x1080 -i BonusScreen-2.png -vcodec libx264 -crf 25  -pix_fmt yuv420p -vf scale=1920:1080  BonusScreen-2.mp4
' ffmpeg -r 60 -f image2 -s 1920x1080 -i BonusScreen-2.png -i clear.mp3 -vcodec libx264 -crf 25  -pix_fmt yuv420p -vf scale=1920:1080 -strict -1 -acodec copy BonusScreen-2.mp4
'ffmpeg -r 30 -f image2 -s 1920x1080 -i BonusScreen-2.png -i clear2.mp3 -vcodec libx264 -crf 25 -b 4M -pix_fmt yuv420p -vf scale=1920:1080 -acodec copy BonusScreen-2.mp4

' Must have contrained baseline
' ffmpeg -r 30 -s 1920x1080 -i BonusScreen-2.png -i clear.mp3 -vcodec libx264 -crf 25 -b 4M -pix_fmt yuv420p -vf scale=1920:1080 -profile:v baseline -metadata:s:v:0 language=eng -metadata:s:a:0 language=eng -acodec copy BonusScreen-2.mp4
'GOOD MP4  ffmpeg -r 30 -s 1920x1080 -i BonusScreen-2.png -vcodec libx264 -crf 25 -b 4M -pix_fmt yuv420p -vf scale=1920:1080 -profile:v baseline BonusScreen-2.mp4

'GOOD WEBM ffmpeg -i BonusScreen-2.png -c:v libvpx -pix_fmt yuva420p -b:v 1M -auto-alt-ref 0 BonusScreen-2.webm
' NOTE: need transparency on the Screen to make this work



Sub pBGGamePlay
  if bUsePUPDMD then
    'bFlashing = False
    PuPlayer.LabelShowPage pBackglass,1,0,""
    PuPlayer.LabelSet pBackglass, "Guardians2", "PuPOverlays\\GUARDIAN-"&SpellGuardians&".png",1,"{'mt':2,'color':111111,'width':31, 'height':8,'yalign':0,'ypos':0.0,'xpos':50.4}"
    puPlayer.LabelSet pBackglass,"TimeLbl", "Timer" ,1,""
    pDMDEvent(kDMD_PlayerMode)
    puPlayer.LabelSet pBackglass,"MessageT","",1,""
  End If
End Sub

Sub pBGCutScene
  if bUsePUPDMD then

  End If
End Sub

Sub pBgShowBonus(Message1, Message2)
  if bUsePUPDMD then
debug.print "Showing Bonus: " & Message1 & " - " & Message2
    PuPlayer.LabelSet pBonusScreen,"Message1", Message1 ,1,""
    PuPlayer.LabelSet pBonusScreen,"Message2", Message2 ,1,""
  End If
End Sub

Sub pDMDStartBall
  if bUsePUPDMD then
  End If
end Sub

Sub pDMDEvent(id)
  if bUsePUPDMD then
'debug.print "pDMDEvent " & id
    PuPEvent(id)  ' Send an event to the pup pack the E500 trigger
  End If
End Sub

'Sub pDMDBallLost
' if bUsePUPDMD then
'   PuPEvent(500)  ' Send an event to the pup pack the E500 trigger
' End If
'End Sub

Sub pDMDGameOver
debug.print "Game Over"
  StartAttractMode 1
  if bUsePUPDMD then
    PuPlayer.PlayStop pOverVid
    PuPlayer.SetLoop pOverVid, 0

    playclear pBackglass
    playclear pMusic
    'StopSound "m_wait"   ' Just in case
    playclear pAudio

    PuPlayer.LabelShowPage pBackglass, 2,0,""
    pDMDEvent(kDMD_Attract)
    pAttractStart   ' Take too long to start and kills Game Over
  End If
end Sub

Sub pAttractStart
  if (pInAttract = False) then
    debug.print "STARTING ATTRACT"
    pDMDSetPage(pDMDBlank)   'set blank text overlay page.
    pCurAttractPos=0
    pDMDStartUP
  end if
end Sub

Sub pDMDStartUP
  debug.print "STARTING ATTRACT2"
  pupDMDDisplay "attract","Welcome","@vidIntro.mp4",9,0,10
  pInAttract=true
end Sub

DIM pCurAttractPos: pCurAttractPos=0


'********************** gets called auto each page next and timed already in DMD_Timer.  make sure you use pupDMDDisplay or it wont advance auto.
Sub pAttractNext
pCurAttractPos=pCurAttractPos+1
debug.print "ATTRACT Next" & pCurAttractPos

  if bGameInPlayHidden and bGameInPlay=False then exit sub  ' Special case when Cherry bomb is done we disable the game and let everything drain

  if bGameInPlay Then PriorityReset=2000
  if bGameInPlay and pCurAttractPos=1 then pCurAttractPos=2   ' During InstantInfo skip Intro
  if bGameInPlay and pCurAttractPos=7 then pCurAttractPos=21  ' During InstantInfo skip credits

  Select Case pCurAttractPos
'           Name       Line1^Line2..  Video      T  Flash Priority
  Case 1:
  pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4" ,9, 1,    10
  PuPlayer.LabelShowPage pOverVid, 1,0,""
  PuPlayer.playlistplayex pOverVid,"PupVideos","xattract1.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage3",chr(78)&chr(79)&chr(84)&chr(32)&chr(70)&chr(79)&chr(82)&chr(32)&chr(82)&chr(69)&chr(83)&chr(65)&chr(76)&chr(69),1,"{'mt':2,'color':255, 'size': 4,'ypos': 90}"
' PuPlayer.LabelSet pBackglass,"HighScore1","",1,""
' PuPlayer.LabelSet pBackglass,"HighScore2","",1,"{'mt':2}"
' PuPlayer.LabelSet pBackglass,"HighScore3","",1,""
  Case 2:
  if bGameInPlay=False Then
    pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
    PuPlayer.LabelSet pOverVid,"OverMessage3", "", 1, "{'mt':2,'color':"&RGB(255, 255, 255)&", 'size': 10,'ypos': 65}"
  End If
  playclear pOverVid
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1

  if osbactive = 1 or osbactive = 2 Then
    PuPlayer.LabelSet pOverVid,"OverMessage1","OSB CHAMPION",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",alltimevar(2),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(alltimevar(3)),1,""
  Else
    PuPlayer.LabelSet pOverVid,"OverMessage1","GRAND CHAMPION",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",HighScoreName(0),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(HighScore(0)),1,""
  End If
  Case 3:
  if bGameInPlay=False Then pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4" ,9, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  if osbactive = 1 or osbactive = 2 Then
    PuPlayer.LabelSet pOverVid,"OverMessage1","OSB HIGHSCORE #1",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",alltimevar(4),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(alltimevar(5)),1,""
  Else
    PuPlayer.LabelSet pOverVid,"OverMessage1","HIGH SCORE #1",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",HighScoreName(1),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(HighScore(1)),1,""
  End If
  Case 4:
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  if bGameInPlay=False Then pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  if osbactive = 1 or osbactive = 2 Then
    PuPlayer.LabelSet pOverVid,"OverMessage1","OSB HIGHSCORE #2",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",alltimevar(6),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(alltimevar(7)),1,""
  Else
    PuPlayer.LabelSet pOverVid,"OverMessage1","HIGH SCORE #2",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",HighScoreName(2),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(HighScore(2)),1,""
  End If
  Case 5:
  if bGameInPlay=False Then pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4" ,9, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  if osbactive = 1 or osbactive = 2 Then
    PuPlayer.LabelSet pOverVid,"OverMessage1","OSB HIGHSCORE #3",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",alltimevar(8),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(alltimevar(9)),1,""
  Else
    PuPlayer.LabelSet pOverVid,"OverMessage1","HIGH SCORE #3",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2",HighScoreName(3),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3",FormatScore(HighScore(3)),1,""
  End If
  Case 6:
  if bGameInPlay=False Then pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Games Played",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2",FormatScore(TotalGamesPlayed),1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3"," ",1,""
  Case 7:
  pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4",3, 1,   10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Authors:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Daphishbowl",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","and Mr H",1,""
  Case 8:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Ashtone6",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","Photos",1,""
  Case 9:
  playclear pOverVid
  pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4",3, 1,   10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Angrim",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","DOF",1,""
  Case 10:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","G5K",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","3D help",1,""
  Case 11:
  pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4",3, 1,   10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Nailbuster",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","PuP support",1,""
  Case 12:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Pinballfan2018",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","PuP support",1,""
  Case 13:
  playclear pOverVid
  pupDMDDisplay "attract", "Game Over", "@vidIntro.mp4",3, 1,   10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","AL",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","Graphics Help",1,""
  Case 14:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","wAxx",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","Physics and DT",1,""
  Case 15:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","MPT3K",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","Gameplay Help",1,""
  Case 16:
  pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4",3, 1,   10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Rik",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","Killer testing",1,""
  Case 17:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","VAAS",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","PupFrame",1,""
  Case 18:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Credits:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Frogger73",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","PF Photos",1,""
  Case 19:
  pupDMDDisplay "attract", "Insert Coin", "@vidIntro.mp4",3, 1,   10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Orbital Group",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Scott,Bambi,",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","Brian,James",1,""
  Case 20:
  pupDMDDisplay "attract", "Game Over", "@vidIntro2.mp4",3, 1,    10
  PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
  PuPlayer.LabelSet pOverVid,"OverMessage1","Others:",1,""
  PuPlayer.LabelSet pOverVid,"OverMessage2","Alpha and Beta",1,"{'mt':2}"
  PuPlayer.LabelSet pOverVid,"OverMessage3","Testers",1,""
  case 21:
  if bGameInPlay then
    PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
    PuPlayer.LabelSet pOverVid,"OverMessage1","Hadrons",1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2", HadronEnforcerCount,1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3","",1,""
  else
    pCurAttractPos=0
    pAttractNext 'reset to beginning
  End If
  case 22:
  if bGameInPlay then
    PuPlayer.playlistplayex pOverVid,"PupVideos","Video-0x0065.mp4", 1, 1
    PuPlayer.LabelSet pOverVid,"OverMessage1", "Multipliers", 1,""
    PuPlayer.LabelSet pOverVid,"OverMessage2", "Play: x" & (Multiplier3x * PlayMultiplier),1,"{'mt':2}"
    PuPlayer.LabelSet pOverVid,"OverMessage3", "Bonus: x" & BonusMultiplier,1,""
  else
    pCurAttractPos=0
    pAttractNext 'reset to beginning
  End If
  Case Else
    pCurAttractPos=0
    pAttractNext 'reset to beginning
  end Select

end Sub


'************************ called during gameplay to update Scores ***************************
Sub pUpdateScores  'call this ONLY on timer 300ms is good enough
Dim StatusStr
  if pDMDCurPage <> pScores then Exit Sub

  if tmrCherryBomb.Enabled then
    StatusStr = "Time:" & ModeCountdownTimer.UserValue & "(" & CherryBombCount & ")"
  elseif tmrImmolation.Enabled  then
    StatusStr = "Hits:" & CINT((ImmolationCount / 18) * 100) & "% Sw:" & SwitchHitCount
  elseif tmrXandar.Enabled  then
    StatusStr = "Hits:" & XandarCount
  elseif PlayerMode = -1 Then
    If bSecondMode then
      if PlayerMode2 = -1 then
        StatusStr = "Select Mode/2nd"
      Else
        if PlayerMode2 = 7 or PlayerMode2 = 2 Then  ' SwitchHits
          StatusStr = Mode2Percent(PlayerMode2) & "%  HITS:" & SwitchHitCount & " 2nd"
        else
          StatusStr = Mode2Percent(PlayerMode2) & "% 2nd"
        end If
      End if
    else
      StatusStr = "Select Mode"
    End If
  elseif PlayerMode = 7  Then  ' SwitchHits
    StatusStr = "Time:" & ModeCountdownTimer.UserValue & "  " & ModePercent(PlayerMode) & "%  HITS:" & SwitchHitCount
  else
    StatusStr = "Time:" & ModeCountdownTimer.UserValue & "  " & ModePercent(PlayerMode) & "%"
  end If

  'PuPlayer.LabelSet pBackglass,"Play2","PLAYER 2",1,"{'mt':2}"

  puPlayer.LabelSet pBackglass,"Player",  "Player " & CurrentPlayer+1 ,1,""
  puPlayer.LabelSet pBackglass,"Ball",  "Ball " & Balls  & "    " ,1,""
  Select case PlayersPlayingGame
    case 1:
      puPlayer.LabelSet pBackglass,"CurScore", FormatScore(Score(CurrentPlayer))    ,1,""
    case 2:
      PuPlayer.LabelSet pBackglass,"Play1score",FormatScore(Score(0)),1,""
      PuPlayer.LabelSet pBackglass,"Play2score",FormatScore(Score(1)),1,""
    case 3:
      PuPlayer.LabelSet pBackglass,"Play1score",FormatScore(Score(0)),1,""
      PuPlayer.LabelSet pBackglass,"Play2score",FormatScore(Score(1)),1,""
      PuPlayer.LabelSet pBackglass,"Play3score",FormatScore(Score(2)),1,""
    case 4:
      PuPlayer.LabelSet pBackglass,"Play1score",FormatScore(Score(0)),1,""
      PuPlayer.LabelSet pBackglass,"Play2score",FormatScore(Score(1)),1,""
      PuPlayer.LabelSet pBackglass,"Play3score",FormatScore(Score(2)),1,""
      PuPlayer.LabelSet pBackglass,"Play4score",FormatScore(Score(3)),1,""
  End Select

  puPlayer.LabelSet pDMD,"Player",  "Player " & CurrentPlayer+1       ,1,""
  puPlayer.LabelSet pDMD,"Ball",    "Ball " & Balls             ,1,""
  puPlayer.LabelSet pDMD,"CurScore",  FormatScore(Score(CurrentPlayer))   ,1,""
  puPlayer.LabelSet pDMD,"Status",  StatusStr               ,1,"1"
  puPlayer.LabelSet pDMD,"Credits",   "C  " & Credits             ,1,""

end Sub


'*****************************
' AUTO TESTING
' by:NailBuster
' Global variable "AutoQA" below will switch all this on/off during testing.
'
'*****************************
' NailBusters AutoQA Code and triggers..
' this to do for ROM based:  timeout on keydown.  if 30 seconds, then assume game is over and you add coins/start game key.
' add a timer called AutoQAStartGame.  you can run every 10000 interval.

Dim AutoQA:AutoQa=False                 'Main QA Testing FLAG setting to false will disable all this stuff.
Dim QACoinStartSec:QACoinStartSec=30   'timeout seconds for AutoCoinStartSec
Dim QANumberOfCoins:QANumberOfCoins=1 'number of coins to add for each start
Dim QASecondsDiff

Dim QALastFlipperTime:QALastFlipperTime=Now()
Dim AutoFlipperLeft:AutoFlipperLeft=false
Dim AutoFlipperRight:AutoFlipperRight=false
if AutoQa then TriggerLeftAuto.Enabled = True
if AutoQa then TriggerRightAuto.Enabled = True
if AutoQa then AutoQAStartGame.Enabled = True   ' Start it up if this is enabled

Sub AutoQAStartGame_Timer()                 'this is a timeout when sitting in attract with no flipper presses for 60 seconds, then add coins and start game.
 if AutoQA=false Then Exit Sub

 QASecondsDiff = DateDiff("s",QALastFlipperTime,NOW())

 if QASecondsDiff>QACoinStartSec Then

    'simulate quarters and start game keys
    Dim fx : fx=0
    Dim keydelay : keydelay=100
  Do While fx<QANumberOfCoins
    vpmtimer.addtimer keydelay,"Table1_KeyDown(AddCreditKey) '"
        vpmtimer.addtimer keydelay+200,"Table1_KeyUp(AddCreditKey) '"
        keydelay=keydelay+500
    fx=fx+1
  Loop
    vpmtimer.addtimer keydelay,"Table1_KeyDown(StartGameKey) '"
    vpmtimer.addtimer keydelay+200,"Table1_KeyUp(StartGameKey) '"
    QALastFlipperTime=Now()
  AutoFlipperLeft=false
    AutoFlipperRight=false
 End if

  if QASecondsDiff>30 Then   'safety of stuck up flipers.
   AutoFlipperLeft=false
   AutoFlipperRight=false
  End if

  if bGameInPlay and QASecondsDiff>20 Then   'Press the magna
  vpmtimer.addtimer keydelay,"Table1_KeyDown(RightMagnaSave) '"
  vpmtimer.addtimer keydelay+200,"Table1_KeyUp(RightMagnaSave) '"
  End if

End Sub


Sub TriggerAutoPlunger_Hit()          'add a trigger in front of plunger.  adjust the delay timings if needed.
    if AutoQA=false Then Exit Sub
  vpmtimer.addtimer 10,"Table1_KeyDown(PlungerKey) '"
    vpmtimer.addtimer 700+RND(400),"Table1_KeyUp(PlungerKey) '"
End Sub


Sub FlipperUP(which)  'which=1 left 2 right
QALastFlipperTime=Now()
if which=1 Then
   Table1_KeyDown(LeftFlipperKey)
   vpmtimer.addtimer 200+Rnd(200),"Table1_KeyUP(LeftFlipperKey):AutoFlipperLeft=false  '"
Else
   Table1_KeyDown(RightFlipperKey)
   vpmtimer.addtimer 200+Rnd(200),"Table1_KeyUP(RightFlipperKey):AutoFlipperRight=false  '"
end If

End Sub


Sub TriggerLeftAuto_Hit()
  if AutoQA And AutoFlipperLeft=false then vpmtimer.addtimer 20+Rnd(50),"FlipperUP(1) '"
    AutoFlipperLeft=true
End Sub

Sub TriggerRightAuto_Hit()
  if AutoQA and AutoFlipperRight=false then vpmtimer.addtimer 20+Rnd(20),"FlipperUP(2) '"
    AutoFlipperRight=true
End Sub

Sub TriggerLeftAuto2_Hit()
  TriggerLeftAuto_Hit()
End Sub

Sub TriggerRightAuto2_Hit()
  TriggerRightAuto_Hit()
End Sub
'*****************************************************


'PUPInit  'this should be called in table1_init at bottom after all else b2s/controller running.


'********************  pretty much only use pupDMDDisplay all over ************************
' Sub pupDMDDisplay(pEventID, pText, VideoName,TimeSec, pAni, pPriority)
' pEventID  = reference if application,
' pText     = "text to show" separate lines by ^ in same string
' VideoName = "gameover.mp4" will play in background  "@gameover.mp4" will play and disable text during gameplay.
' also global variable useDMDVideos=true/false if user wishes only TEXT
' TimeSec how long to display msg in Seconds
' animation if any 0=none 1=Flasher
' also,  now can specify color of each line (when no animation).  "sometext|12345"  will set label to "sometext" and set color to 12345
'Samples
'pupDMDDisplay "shoot", "SHOOT AGAIN!", ", 3, 1, 10
'pupDMDDisplay "default", "DATA GADGET LIT", "@DataGadgetLit.mp4", 3, 1, 10
'pupDMDDisplay "shoot", "SHOOT AGAIN!", "@shootagain.mp4", 3, 1, 10
'pupDMDDisplay "balllock", "Ball^Locked|16744448", "", 5, 1, 10             '  5 seconds,  1=flash, 10=priority, ball is first line, locked on second and locked has custom color |
'pupDMDDisplay "balllock","Ball 2^is^Locked", "balllocked2.mp4",3, 1,10     '  3 seconds,  1=flash, play balllocked2.mp4 from dmdsplash folder,
'pupDMDDisplay "balllock","Ball^is^Locked", "@balllocked.mp4",3, 1,10       '  3 seconds,  1=flash, play @balllocked.mp4 from dmdsplash folder, because @ text by default is hidden unless useDmDvideos is disabled.


'pupDMDDisplay "shownum", "3^More To|616744448^GOOOO", "", 5, 1, 10         ' "shownum" is special.  layout is line1=BIG NUMBER and line2,line3 are side two lines.  "4^Ramps^Left"

'pupDMDDisplay "target", "POTTER^110120", "blank.mp4", 10, 0, 10            ' 'target'...  first string is line,  second is 0=off,1=already on, 2=flash on for each character in line (count must match)

'pupDMDDisplay "highscore", "High Score^AAA   2451654^BBB   2342342", "", 5, 0, 10            ' highscore is special  line1=text title like highscore, line2, line3 are fixed fonts to show AAA 123,123,123
'pupDMDDisplay "highscore", "High Score^AAA   2451654|616744448^BBB   2342342", "", 5, 0, 10  ' sames as above but notice how we use a custom color for text |


