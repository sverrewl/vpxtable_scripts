'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMO,.  .xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMk.   .dWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWx.    lXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWX0Od:.      'coxk0XWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKkdl;..   .     ..    ..,lk0KXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMN0o;.   .,:ldO0o.  :0KOl;:cc,....'lOXMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMN0o,. .,cdOKNMMMMMXc .kWMMWWMMWKkxc,.  'o0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMW0dxKWMWKd,. .cd0NMMMMMMMMMMM0:lNMMMWXNWOcxWWN0l.  .:OWMMWK0XMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMO'  .:oc.  ,xXWMMMMMMMMMMMMMMWXNMMW0loOo.'OMMMMWXd,  .:xd:..'xNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMX:         cXMMMMMMMMMMMMMMMMMMMMW0c..:;',dNMMMMMMMNl.        ;0MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMNOo;.      cXMMMMMMMMMMMMMMMMWOO0o...   .c0NMMMMMMWKc       ,dXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMX;   ....,OWMMMMMMMMMMMMW0c..',l:.    .:0MMMMMXo. ..''.  oNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMWd. 'xXX0kdONMMMMMMMMMMMXo..,.:KKc;,.. .oNMMMMMKddk0XNNd. .dNMMMMMMWXK00OkkxxddONMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWNNXXKXWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWNWMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMWk. ,0WMMMMMMMMMMMMMMMMN0l':0NKNWKOo',',kKNMMMMMMMMMMMMMWk. '0MMMMMWk,...       .l0NMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMKl,'...;0MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMXolXMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMM0, 'OWMMMMMMMMMMMMMMMMXl';xXMMMMMWXc.. ':;kWMMMMMMMMMMMMMWk:dO0NMMMMNo.    ..    .;xWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0:    '0MMMMWWWMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMKd:' ;XMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMNl .dWMMMMMMMMMMMMMMMMW0c..;OWMWWMMNOoc.  'OMMMMMMMMMMMMMMMWW0,.xWMMMM0'   .d0:     'OMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMx.   ,KMMMWkoKMMMMMMMMMMMWNWMMMMMMMMMMMMXKNWd.   :XMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMM0' ,KMMMMMMMMMMMMWNWMMMMWx;oXW0c:kNMMW0, .lNWOkNMMMMMMMMMMMMMK; :NMMMMK;   .kWO'     cNMMMMMMMMMMNOoxNNNNNNNNNNNNNNWMMO.   ,KMWKl.'0MMMWNXK00Od;;OMMMMWNK000Oo',0Xl    ,k00XWMMMMMMMMMM
'MMMMMMMMMMMMMMMMM0' lNMMMMMMMMMMMM0okWMNKxckWXo. ..:OWNd. cXNo.lNMMMMMMMMMMMMMWd.,KMMMMXc   .kMWd.    'OMMMMMMMNOl'  ;xc,.'...'''''';OM0,   ,K0c.  .OMMXo'....    oWMXd:... .   .;'       ..:KMMMMMMMMMM
'MMMMMMMMMMMMMMMMXc .xWMMMMMMMMMMMMK;.dNk,;ON0;  .c' .lKXx;,ko..OMMMMMMMMMMMMMMNl '0MMMMNc   .kMMX:    .oWMMMMKo'     :K0:     ..     lNK,   ;KO.   .kMNl    ''    lN0,   .:l,   .,,.     ':ckNMMMMMMMMMM
'MMMMMMMMMMMMMMMM0' .kMMMMMMMMMMMMMWo .ox:xWNo.      .cKMNocl. ,KMMMMMMMMMMMMMMNl '0MMMMWl   .xWMWd.    ;KMMXd'       :XMx.   .x0;    :XX;   ,0K,  'dXWx.   ,0O'   lXc   .xWM0'  'ONo.   ,0WMMMMMMMMMMMMM
'MMMMMMMMMMMMMMWXo. .xWMMMMMMMMMMMMMXc .ckXMMNd.     cXMMXOo. .dWMMMMMMMMMMMMMMNc .xXNNNNl    oWMMk.    '0Nk,  'o:    :XMO'   ,KNl    oNX;   '00' :OKNK;    lN0'   cKc    'xNK,.l0WMk.   :XMMMMMMMMMMMMMM
'MMMMMMMMMMMXoll'    .:dkKWMMMMMMMMMK:   :dddl,.     .lxxdl.  .kWMMMMMMMMWWX0xo;.  ..'.c0l    oWMMk.    'Od.  'OWo    :NM0'   ,KWo. 'dXMK,   .c; .:,'kO.    .lc.   ;KO'     ;ddkWMMMk.   :XMMMMMMMMMMMMMM
'MMMMMMMMMMMk.          ..:dKWMMMMW0;      'oOOkxdookOOkc.     .dNMMMMMMXx:'.          .kl    oWMMx.    ;x,   oWWd.   :NM0,   ,KWd.:KMMMK,          .xO.           'OW0c.    .;kNMMMk.   ;KMMMMMMMMMMMMMM
'MMMMMMMMMMMNxccc:.  'ldxkO0NMMMMNd,'     .,dNWklddcoKM0'       'cOWMMMMWX0Okxc.  .,;;;l0l    oWMXc     ox.  .kMWd.   :XM0,   ,KWOdXMMMMK;     ,:.  .x0,    ;kOOOOOKNMMNk;.     ;kWMk.   '0MMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMWK; ;XMMMMMMMMMMXl'.     ..;kKd,...,clc.  ..  .',xWMMMMMMMMMMO. 'kNWWWWNc    lWWx.    'Od.  .xWK;    ;XM0,   ,KMWWMMMMMX;    :X0,  .dXl    lNMMMMMMMMWko00o'    .xWk.   '0MMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMK;.dWMMMMMMMMMMNx.    ...  ,o:    ..    ..   :KWMMMMMMMMMMWk..xWMMMMMX;    cNK;     lNo    'c'     ;XM0'   .OMMMMMMMMK,   .dM0,  .oWO'   .kWMMMMMXx:.,0MMO.    :Xk.   .kMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMWO''OMMMMMMMMMMMW0;.....          ..       .oXN0kkxdoooolcldxOWMMMMMM0,    .:,     'OMk.     ..    '0Mk.    ;0WMMMMMM0'    oWK,   cNWk.   .cONWWMk.  .oOkc.    ,Kk.    :KWMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMWO;:0MMMMMMMMMMMMXKK0d'               .:xkKWMK:.          .xWMMMMMNO;.         .,lkWMXc    .x0,    ck:      .lONMMW0:.   .oNX;   ,KMW0:.   .',c0O.           .dNK;     ;OWMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMWKlc0WMMMMMMMMMMMMMMNo.              :XMMMMMMK,    .;.    ,0MMMMMNOdddxxxxdxkO0NWMMMMKd:,:OWW0l;;:lolllllllodONMMNkodxxkOXWNo   .lXMMNkc:;:::dXO' .;clllodxkKWMWXxoooxOXMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMNOkXMMMMMMMMMMMMNx;...lkkkkkkd,    .;xNMMMMNo    ;Kk.    :XMMMMMMMMMMMMMMMMMMMMMMMMMMWWWWWMMMWWWMMMMMMMWNWMMMMMMMMMMMN0XWMXxl;''oNMMMMWWWWWMMXooKWMMMWMMWWMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMWWNNWMMMMMMMMMK,  ..lNMMMMWx. ,'   ;KMMMMWd.   ;XNo    .xKOOOOOOOOOOOOOOO000000OXWMW0d:lKMMMMMMMMMMNkc;dWMMWKOkxddl,.lNMMMXkolodddkXWWXK000O0NMMNOo:xXxoxxx0NMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMWWMMMMMMMMMMXc  ...lxxOxc.  ..   lNMMMMMx.   ;XMX:    ;d;.   .;c,.    .:;...  ,oc,.  .OMMMMMMMWXd,   lNMNd.        ;KMM0;        ;KW0o'.. .coc'.  cKdc:,;oKMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMXOxxxl.  .    'ldddkXMMMMMMO.   :XMMk.   'Ok.   ,0W0,    lNk.      ..   .kMMMMMXx:.     lWWd.   ':.   '0MK;    ''    ;0MNl     ..    :X0xxxxxKMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNl  .....kMMMMMMMMMMMM0'   ;XMMK,   .dk.   cXMNc   'OM0'    .dKl   .kMMMNx'  ..    oWO'   .kXc   '0Nl    ;KK:    :XWd    ;O0;   :XMWWMWWWMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo 'dl'..OMMMMMMMMMMMMO'   ;XMMX:    ok.   :XMWo   ,KM0'    :XWd.  .kMMKc. .o0l    oXl    '0Nc   .O0'   .xWMO.   .OWx.  .xWNc   :XMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo.':c;..OMMMMMMMMMMMMO.   ,KMMX:   .dO.   :XMWd.  ,KM0'    :XMk.  .kMK;  .oNMx.   oK:     ,:.   .dd.   .OMM0'   .oWx.  .xWWo   ;XMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo  ;dl.'OMMMMMMMMMMMM0'   ,KMMK;   .kO.   ;KMMd.  ,0M0'    :XMk.  .xWd.  '0MMk.   oK:     .......ol    '0MM0'    :Xx.  .xWWo   ,KMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo....  '0MMMMMMMMMMMM0'   ,KMWx.   ;X0'   '0MWo   '0M0'    ;XMk.   oXc   ;KMWx.   oXl    .xXXXXXXNd.   .OMM0'    lNx.  .dWNl   '0MMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo  ,c' '0MMMMMMMMMMMMk.   '0MK;   .oWK;   .kWO'   '0M0'    ,KM0'   lXc   'OWk'    lNk.   .OMMMMMMM0,   .xWMk.   .xWx.   oWWo   .kMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo.,ll, '0MMMMMMMMMMMWd.   .kXl    '0MX:    ,c.    .OM0'    '0MK,   lXl    ';.     cNNo.   :KWMMMMMWd.   ,0Xc    ;KMx.   cNMd.  .kMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo.';,. '0MMMMMMMMMMMNl     .'    .dWMWo            lNk.    .OMX;   cXx.     ..    ;XMXo.   .lOKXNMMNo.   .'    .kWNl    :XMx.  .kMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo .oo. '0MMMMMMMMMW0c.  ..    ..;xNMMMO,   .cxc    .;'.  ..'OMX:   ,KK;   .:Oo.   .OMMWk,     ..dNMMX:        ,kN0l.  ..cXMO.  .oWMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWo..',. '0MMMMMMMMMWXOkO0000OO0KXWMMMMMWKkxkKWMKkxxkkkkOO000XWMWx.   :kx' .dNWo     cNMMMXkooolodKWMMWXOkkkkOOOXWWKkkOO0KNWMXc   .oXMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWd   '. ;KMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0xo:'..  lNMM0;    ;KMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNOdc;:kWMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNd'.,:::,'lKMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWx.   ,OWMMO' .:0WMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWWMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMK, :KWXd;..xMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM0,    .;ll,.;kNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMX;  :OOc. .kMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWd.      .;kNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMW0o,... .ckNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMNd'   .:kNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM
'MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMK:...oNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMWKd;,dNMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM



'         DarkestDungeon v2.2 - PuP and PUPDMD
' ****************************************************************
' December 2023
' Table Version: 2.2
' PuP and PUPDMD mod: V2.2

' CREDITS:

' JPSalas                       Original Table "Wrath of Olympus"
' MerlinRTP                     VPX Table Lead, PUPDMD, Ruleset Design
' H3rbski1x                     Original Concept,Pup Graphics, Ruleset Design
' Oqqsan                        Table Scripting, 3D Inserts, Popup Targets
' Tastywasps,Rawd               VR Room
' Astronasty                    Playfield Artwork, VR Cabinet Art
' Anthem                        PuP Videos
' Superhac                      Table Scripting, Rules Doc
' JoePicasso                    3D Models
' DarrinVPCLE                   DOF Config
' Smaug                         Attract Video
' nFozzy/Rothbauerw             Physics
' NailBuster                    Pinup Player, PUPDMD
' Arelyel Krele         Advanced Queuing System
' Fleep                         Mechanical Sound Engineering
' PrimeTime5k         Staged Flipper Code
' RetroG33k                     PuPDMD Foundation
' Core Testers          pinballgramps, pinstratsdan, primetime5k,spatolar
' Additional Testers      passion4pins, loadedweapon,pegula0420, 10mmsocket

'
Option Explicit
Randomize
SetLocale 1033

Dim CurrTime,objIEDebugWindow
CurrTime = Timer

' Determine the screen setup based on the pupack setting (e.g. which ,bat file was run)

'Set PuPlayer = CreateObject("PinUpPlayer.PinDisplay")

' Determine the screen setup based on the pupack setting (e.g. which ,bat file was run)
Dim PuPlayer: Set PuPlayer = CreateObject("PinUpPlayer.PinDisplay")

'if PupPlayer.GetRoot = "" Then
' msgbox "No PinUP Installed: Required for Table"
' Table1_exit
'End If

Dim pupPackScreenFile: pupPackScreenFile = PuPlayer.GetRoot & "DarkestDungeon\ScreenType.txt"
Dim ObjFso: Set ObjFso = CreateObject("Scripting.FileSystemObject")
Dim ObjFile: Set ObjFile = ObjFso.OpenTextFile(pupPackScreenFile)
Dim DMDType: DMDType = ObjFile.ReadLine
'Dim DMDType: DMDType = 2

if DMDType = 2 Then
  PupScreen1 = 0 ' Do not use apron pupscreens
Else
  PupScreen1 = 2 ' Use two apron pupscreens
End If
Debug "DMDTYPE = " & DMDType

' Leave set unless you really know what you are doing
dim useRealDMDScale : useRealDMDScale=0    ' 0 or 1 for RealDMD scaling.  Choose which one you prefer.
dim useDMDVideos    : useDMDVideos=true   ' true or false to use DMD splash videos.
Dim pGameName       : pGameName="DarkestDungeon"  'pupvideos foldername, probably set to cGameName in realworld
Const BallBright = 1        '0 - Normal, 1 - Bright
Const VolumeDial = 0.8
Const BallRollVolume = 0.5      'Level of ball rolling volume. Value between 0 and 1
Const RampRollVolume = 0.5      'Level of ramp rolling volume. Value between 0 and 1
Const GameVersion = "2.1"
Const AudioExpiry = 4000      ' Duration of Queue Expiration
Const GenPuPExpiry = 6000
Const ShortPuPExpiry = 5000

Const FlashTime = 50 ' ms used for flashing overlay icons
Const SlowFlashTime = 10 ' ms used for flashing overlay icons

'//////////////////////////////////////////////////////////////////////
'//////////////////////////////////////////////////////////////////////

'Constants

Const BallSize = 50
Const BallMass = 1
Const tnob = 5
Const lob = 0

Const AmbientBallShadowOn = 1
Const DynamicBallShadowsOn = 1
Const RubberizerEnabled = 1
Const TargetBouncerEnabled = 1    '0 = normal standup targets, 1 = bouncy targets
Const TargetBouncerFactor = 0.7   'Level of bounces. Recommmended value of 0.7
Const KickOutDelay = 1200

Dim tablewidth: tablewidth = Table1.width
Dim tableheight: tableheight = Table1.height


'//////////// PLAYER DEFINED CONSTANTS/////////////////////////////////
'//////////////////////////////////////////////////////////////////////
' Choice of ramp types
' wood ramps have iron & wooden planks, other ramps are bronze metal
Const WoodRamps = True
' Radiant MODE - Adds 5 seconds to heartbeat timers, changes outlane posts position
Const Difficulty        = 2    ' 1 - Radiant , 2 - Darkest , 3 - Stygian (easy,med,hard)
Const VRRoomChoice        = 1     ' 1 = Cathedral Room, 2 = Sphere Dungeon
Const StagedFlippers      = 0         '0 = Normal  1 = Staged Flippers
Const MaxDarkness         = 95 ' determines how dark the playfield can get (higher number equals darker : 80-99 is recommended range, Default is 95
Const DefaultDarkness     = 5  ' determines how dark the playfield is outside of dungeons/battles
Dim DarknessSpeed
DarknessSpeed         = 175 ' determines how quickly the table gets dark (lower number equals faster)
Const EnableFlicker       = True
Const EnableLUTSelector     = 1   ' 1 - on; 0 - off; if on then the magnasave button let's you rotate all LUT's
Const FlipperBounce       = .6    ' Recommended values .5-.88 (.88 default nFozzy)
Const MagnetTime        = 30      ' Magnet stays on until right magna save key releases it, or timer runs out value is in seconds
' Magnet variables if you do not have magna save keys
Const UseRflipper         = False   ' Control magnet - Turn on if you don't have magna save buttons
Const AutoMagnetTime      = 20    ' Controls how many seconds the magnet is turned on for when right inlane is hit
Const AutoMagnetOn        = False   ' Controls if right inline turns on magnet automatically
'************************************************CHOOSE FPS***********************************************************************
Const FPS             = 1     ' Slow PC Recommended "0" Fast PC Recommended 1
Const ResetHighScore      = 0   '0 = Keep Scores.  1 = Reset all high scores.  START TABLE ONCE to reset high scores and then set this back to 0
'//////////////////////////////////////////////////////////////////////
dim ScorbitActive
ScorbitActive         = 0   ' Is Scorbit Active
Const     ScorbitShowClaimQR  = 1   ' If Scorbit is active this will show a QR Code  on ball 1 that allows player to claim the active player from the app
Const     ScorbitClaimSmall   = 1   ' Make Claim QR Code smaller for high res backglass
Const     ScorbitUploadLog    = 0   ' Store local log and upload after the game is over
Const     ScorbitAlternateUUID  = 0   ' Force Alternate UUID from Windows Machine and saves it in VPX Users directory (C:\Visual Pinball\User\ScorbitUUID.dat)
'/////////////////////////////////////////////////////////////////////
Const DefaultBall       = 4 ' Determines which ball is loaded as the default ball
                  ' 0 - Silver Glow
                  ' 1 - Purple Glow
                  ' 2 - Green Glow
                  ' 3 - Blue Glow
                  ' 4 - Silver NO Glow
                  ' 5 - Blue Glow
                  ' 6 - Flaming Glow
                  ' 7 - Yellow Glow
                  ' 8 - Gold Glow
                  ' 9 - Pink Glow

'FlexDMD in high or normal quality
'change it to True if you have an LCD screen, 256x64
'or keep it False if you have a real DMD at 128x32 in size
Const FlexDMDHighQuality = True  ' NOT USED IN Darkest Dungeon


'////////////////////////////////////////////////////////////////////////////////////////////////////
'****************************************************************************************************
' DO NOT CHANGE ANYTHING BELOW THIS LINE
'****************************************************************************************************


' Load the core.vbs for supporting Subs and functions
LoadCoreFiles

Sub LoadCoreFiles
    On Error Resume Next
    ExecuteGlobal GetTextFile("core.vbs")
    If Err Then MsgBox "Can't open core.vbs"
    ExecuteGlobal GetTextFile("controller.vbs")
    If Err Then MsgBox "Can't open controller.vbs"
    On Error Goto 0
End Sub

' Define any Constants
Const cGameName = "DarkestDungeon"
Const myVersion = "2.2"
Const MaxPlayers = 4          ' from 1 to 4
Const MaxMultiplier = 10      ' limit playfield multiplier
Const MaxBonusMultiplier = 10 'limit Bonus multiplier
Dim BallsPerGame:  BallsPerGame = 5      ' usually 3 or 5   RTP7
Const MaxMultiballs = 5       ' max number of balls during multiballs
Const TorchReq = 20 ' number of totch hits required to complete phase 1 of InTheDark
Const RampReq = 2 ' number of ramps hits required for each ramp to begin Gambler Mode
Const SpinReq = 20 ' number of spins each side required to begin blacksmith mode
Const BlacksmithTime = 40 ' Number of seconds for each blacksmith shot
Const HeroHealth = 25 ' Base health for heros




'Const AutoFlipper = 1 ' 1 - ON, 0 - OFF (automatically shoots locked magnet ball into upper playfield)


' Define Global Variables

Dim BallSaverTime ' in seconds of the first ball and during the game
Dim RFlipperUsed
Dim RampHitsTotal
Dim TorchMissionMessage
Dim PlayersPlayingGame
Dim CurrentPlayer
Dim Credits
Dim UPFHitCount(4)  ' does not need to be array
'Dim BonusPoints(4)
Dim BonusMultiplier(4)
Dim PlayfieldMultiplier(4)
Dim PFxSeconds
Dim BallsRemaining(4)
Dim ExtraBallsAwards(4)
Dim Score(4)
Dim HighScore(5)
Dim HighScoreName(5)
Dim Jackpot(4)
Dim SuperJackpot(4)
Dim Tilt
Dim debugKB
Dim TiltSensitivity
Dim Tilted
Dim TotalGamesPlayed
Dim mBalls2Eject
Dim SkillshotValue(4)
Dim SuperSkillshotValue(4)
Dim DarkLights(4)           ' D A R K
Dim EOB_Bonus
Dim CurrentDungeonBG


Dim x 'used in loops
Dim CurrMode(4)
Dim b

Dim tmpBalls(7)
Dim LastMode
Dim HelperMessage
Dim BallPos(7, 3)
Dim GIF_CA(4,2,2)  ' GIF array for active Characters (filename alive, filename dead, dead/alive status)
Dim GIF_MA(4,2,2) ' GIF array for active Monsters ( filename alive, filename dead, alive/hurt/dead status)

' Define Queues for Advanced Queing System
Dim EOBQueue : Set EOBQueue = New vpwQueueManager
Dim AudioQueue : Set AudioQueue = New vpwQueueManager
Dim LightSeqQueue : Set LightSeqQueue = New vpwQueueManager
Dim GeneralPuPQueue : Set GeneralPuPQueue = New vpwQueueManager
Dim BallHandlingQueue : Set BallHandlingQueue = New vpwQueueManager
Dim HighScoreQueue : Set HighScoreQueue = New vpwQueueManager
Dim BattleQueue : Set BattleQueue = New vpwQueueManager


' Define Game Control Variables
Dim LastSwitchHit
Dim BallsOnPlayfield
Dim BallsInLock(4)
Dim BallsInHole
Dim MaxHits
'Dim HoldBall
Dim DungeonVidIndex

Dim AF ' used for autoflipper
Dim d ' used to pick dungeon
Dim TorchLevel(5) ' Torch Levels used to determine darkness of table
Dim OldLUT,OldGI

' Define Game Flags
Dim bDungeonsCleared
Dim bBallDown
Dim bInn,bVillage
Dim bSupressDMD
Dim bSupressBGMessages
Dim bSupressRightOrbit
Dim bSupressLeftOrbit
Dim bFreePlay
Dim bGameInPlay
Dim bDungeonSelectMode
Dim bInDungeonSelection
Dim bSuperJackpotReady
Dim bKillUPF
Dim bContinueScreen
Dim bContinueGame
Dim bDungeonsClosed
Dim bEndOfGame
Dim bOnTheFirstBall
Dim bBallInPlungerLane
Dim bBallSaverActive
Dim bBallSaverReady
Dim bMultiBallMode
Dim bMusicOn
Dim bSkillshotReady
Dim bExtraBallWonThisBall
Dim bJackpot
Dim bBonusHeld
Dim bAutoPlunger
Dim bInstantInfo
Dim bAttractMode
Dim bMaxParty
Dim bEOBSupress
Dim bDisplayDev
Dim bBossDefeatedFullParty
Dim bHoldBall
Dim bHoldBallDelay
Dim bBallPossiblyStuck
Dim OrigHwyBID,OrigVesBID,OrigPlaBID,OrigOccBID, OrigCruBID,OrigHouBID,OrigGraBID,OrigJesBID

' core.vbs variables
Dim plungerIM 'used mostly as an autofire plunger during multiballs
Dim mMagnet
Dim cbLeft    'captive ball at the magnet
Dim Centerpoint : Centerpoint = 217.2829

'*************************************************************
' VR Room Auto-Detect
'*************************************************************
Dim VR_Obj, VRMode

If RenderingMode = 2 Then
  VRMode = True
  lrail.Visible = 0
  rrail.Visible = 0
  flasher1.Visible = 0
  flasher2.Visible = 0
  wall8.Visible = 0
  wall8.SideVisible = 0
  wall9.Visible = 0
  wall9.SideVisible = 0
  DarknessLayer2.Visible = 0
  For Each VR_Obj in VRCabinet : VR_Obj.Visible = 1 : Next
  If VRRoomChoice = 1 Then
    For Each VR_Obj in VRCathedralRoom : VR_Obj.Visible = 1 : Next
  Else
    For Each VR_Obj in VRSphereRoom : VR_Obj.Visible = 1 : Next
  End If
  PinCab_Backglass.BlendDisableLighting = 1.50
Else
  For Each VR_Obj in VRCabinet : VR_Obj.Visible = 0 : Next
  For Each VR_Obj in VRSphereRoom : VR_Obj.Visible = 0 : Next
  For Each VR_Obj in VRCathedralRoom : VR_Obj.Visible = 0 : Next
  VRMode = False
End If
' *********************************************************************
'                Visual Pinball Defined Script Events
' *********************************************************************


'===============================   DEBUG CODE ===========================================
'Dim CurrTime,objIEDebugWindow
'CurrTime = Timer
Sub Debug( myDebugText )

' Uncomment the next line to turn off debugging
Exit Sub


  If Not IsObject( objIEDebugWindow ) Then
    Set objIEDebugWindow = CreateObject( "InternetExplorer.Application" )

    objIEDebugWindow.Navigate "about:blank"
    objIEDebugWindow.Visible = True
    'objIEDebugWindow.AutoScroll = True
    objIEDebugWindow.ToolBar = False
    objIEDebugWindow.Width = 1400
    objIEDebugWindow.Height = 500
    objIEDebugWindow.Left = 2100
    objIEDebugWindow.Top = 520
    Do While objIEDebugWindow.Busy
    Loop
    objIEDebugWindow.Document.Title = "My Debug Window"
    objIEDebugWindow.Document.Body.InnerHTML = "<b>Darkest Dungeon Debug Window -TimeStamp: " & CurrTime & "</b></br>"

  End If

objIEDebugWindow.Document.Body.InnerHTML = objIEDebugWindow.Document.Body.InnerHTML & myDebugText & " --TimeStamp:<b> " & CurrTime & "</b><br>" & vbCrLf
objIEDebugWindow.Document.Body.scrollTop = objIEDebugWindow.Document.Body.scrollTop +objIEDebugWindow.Document.Body.scrollHeight
End Sub
'===============================   DEBUG 2 ===========================================
Sub Debug2( myDebugText )

' Uncomment the next line to turn off debugging
Exit Sub


  If Not IsObject( objIEDebugWindow ) Then
    Set objIEDebugWindow = CreateObject( "InternetExplorer.Application" )

    objIEDebugWindow.Navigate "about:blank"
    objIEDebugWindow.Visible = True
    'objIEDebugWindow.AutoScroll = True
    objIEDebugWindow.ToolBar = False
    objIEDebugWindow.Width = 900
    objIEDebugWindow.Height = 500
    objIEDebugWindow.Left = 2100
    objIEDebugWindow.Top = 500
    Do While objIEDebugWindow.Busy
    Loop
    objIEDebugWindow.Document.Title = "My Debug Window"
    objIEDebugWindow.Document.Body.InnerHTML = "<b>Darkest Dungeon Debug Window -TimeStamp: " & CurrTime & "</b></br>"

  End If

objIEDebugWindow.Document.Body.InnerHTML = objIEDebugWindow.Document.Body.InnerHTML & myDebugText & " --TimeStamp:<b> " & CurrTime & "</b><br>" & vbCrLf
objIEDebugWindow.Document.Body.scrollTop = objIEDebugWindow.Document.Body.scrollTop +objIEDebugWindow.Document.Body.scrollHeight
End Sub
'===============================   DEBUG 3 ===========================================
Sub Debug3( myDebugText )

' Uncomment the next line to turn off debugging
Exit Sub


  If Not IsObject( objIEDebugWindow ) Then
    Set objIEDebugWindow = CreateObject( "InternetExplorer.Application" )

    objIEDebugWindow.Navigate "about:blank"
    objIEDebugWindow.Visible = True
    'objIEDebugWindow.AutoScroll = True
    objIEDebugWindow.ToolBar = False
    objIEDebugWindow.Width = 1400
    objIEDebugWindow.Height = 500
    objIEDebugWindow.Left = 2100
    objIEDebugWindow.Top = 500
    Do While objIEDebugWindow.Busy
    Loop
    objIEDebugWindow.Document.Title = "My Debug Window"
    objIEDebugWindow.Document.Body.InnerHTML = "<b>Darkest Dungeon Debug Window -TimeStamp: " & CurrTime & "</b></br>"

  End If

objIEDebugWindow.Document.Body.InnerHTML = objIEDebugWindow.Document.Body.InnerHTML & myDebugText & " --TimeStamp:<b> " & CurrTime & "</b><br>" & vbCrLf
objIEDebugWindow.Document.Body.scrollTop = objIEDebugWindow.Document.Body.scrollTop +objIEDebugWindow.Document.Body.scrollHeight
End Sub
'===============================   END DEBUG CODE ===========================================
Sub Debug4( myDebugText )

' Uncomment the next line to turn off debugging
Exit Sub


  If Not IsObject( objIEDebugWindow ) Then
    Set objIEDebugWindow = CreateObject( "InternetExplorer.Application" )

    objIEDebugWindow.Navigate "about:blank"
    objIEDebugWindow.Visible = True
    'objIEDebugWindow.AutoScroll = True
    objIEDebugWindow.ToolBar = False
    objIEDebugWindow.Width = 1400
    objIEDebugWindow.Height = 500
    objIEDebugWindow.Left = 2100
    objIEDebugWindow.Top = 500
    Do While objIEDebugWindow.Busy
    Loop
    objIEDebugWindow.Document.Title = "My Debug Window"
    objIEDebugWindow.Document.Body.InnerHTML = "<b>Darkest Dungeon Debug Window -TimeStamp: " & CurrTime & "</b></br>"

  End If

objIEDebugWindow.Document.Body.InnerHTML = objIEDebugWindow.Document.Body.InnerHTML & myDebugText & " --TimeStamp:<b> " & CurrTime & "</b><br>" & vbCrLf
objIEDebugWindow.Document.Body.scrollTop = objIEDebugWindow.Document.Body.scrollTop +objIEDebugWindow.Document.Body.scrollHeight
End Sub
'===============================   END DEBUG CODE ===========================================
Sub Debug5( myDebugText )

' Uncomment the next line to turn off debugging
Exit Sub


  If Not IsObject( objIEDebugWindow ) Then
    Set objIEDebugWindow = CreateObject( "InternetExplorer.Application" )

    objIEDebugWindow.Navigate "about:blank"
    objIEDebugWindow.Visible = True
    'objIEDebugWindow.AutoScroll = True
    objIEDebugWindow.ToolBar = False
    objIEDebugWindow.Width = 1400
    objIEDebugWindow.Height = 500
    objIEDebugWindow.Left = 2100
    objIEDebugWindow.Top = 500
    Do While objIEDebugWindow.Busy
    Loop
    objIEDebugWindow.Document.Title = "My Debug Window"
    objIEDebugWindow.Document.Body.InnerHTML = "<b>Darkest Dungeon Debug Window -TimeStamp: " & CurrTime & "</b></br>"

  End If

objIEDebugWindow.Document.Body.InnerHTML = objIEDebugWindow.Document.Body.InnerHTML & myDebugText & " --TimeStamp:<b> " & CurrTime & "</b><br>" & vbCrLf
objIEDebugWindow.Document.Body.scrollTop = objIEDebugWindow.Document.Body.scrollTop +objIEDebugWindow.Document.Body.scrollHeight
End Sub
'===============================   END DEBUG CODE ===========================================

Sub WallsUp
DebugWall1.Visible = 1
DebugWall2.Visible = 1
DebugWall3.Visible = 1
DebugWall1.isDropped = 0
DebugWall2.isDropped = 0
DebugWall3.isDropped = 0
End Sub

Sub WallsDown
DebugWall1.Visible = 0
DebugWall2.Visible = 0
DebugWall3.Visible = 0
DebugWall1.isDropped = 1
DebugWall2.isDropped = 1
DebugWall3.isDropped = 1
End Sub
'===============================================================================================
Sub SetDifficulty
  if Difficulty = 1 Then
    HBMOD = 5
    HBMOD2 = 4
    zCol_Rubber_Peg001.y = 1512
    primitive027.y = 1512
  Elseif Difficulty = 2 Then
    DarknessSpeed = 140
    HBMOD = 3
    HBMOD2 = 3
  Elseif Difficulty = 3 Then
    DarknessSpeed = 140
    HBMOD = 0
    HBMOD2 = 0
  End If
End Sub
'===============================================================================================
'Nail Busters Trigger Script
Const QueueLimit = 50
Dim pReset(50)
Dim pStatement(50)           'holds future scripts
Dim FX



for fx=0 to QueueLimit
    pReset(FX)=0
    pStatement(FX)=""
next

DIM pTriggerCounter:pTriggerCounter=pTriggerScript.interval

Sub pTriggerScript_Timer()
  CurrTime = Timer  ' Used for debug subroutine
  for fx=0 to QueueLimit
       if pReset(fx)>0 Then
          pReset(fx)=pReset(fx)-pTriggerCounter
            if pReset(fx)<=0 Then
            pReset(fx)=0
            'Debug4 "Trigger Call: " & fx &"-"&pStatement(fx)
            execute(pStatement(fx))
          end if
       End if
  next
End Sub


Sub TriggerScript(pTimeMS,pScript) ' This is used to Trigger script after the pTriggerScript Timer on the playfield expires
for fx=0 to QueueLimit
  if pReset(fx)=0 Then
    pReset(fx)=pTimeMS
    pStatement(fx)=pScript
    Exit Sub
  End If
next
MsgBox "Ran out of pTriggers"
end Sub

'TriggerScript 1800, "PuPlayer.LabelSet pBackglass,""WeaponCountBonus"",Weapons(CurrentPlayer) & ""X  100000"" ,1,"""""
'************************
'Glowball
'*************************
Dim GlowAura,GlowIntensity
Dim ChooseBall
 ChooseBall       = 0   ' *** Ball Settings **********
                  ' *** 0 = Normal Ball
                  ' *** 1 = Purple GlowBall
                  ' *** 2 = Green GlowBall
                  ' *** 3 = Blue Glowball
                  ' *** 4 = Flaming Glowball
                  ' *** 5 = Red Glowball
                  ' *** 6 = White Glowball
                  ' *** 7 = Yellow Glowball
                  ' *** 8 = Gold Glowball


'******************
'Additional Ball Settings
'******************

GlowAura=210 'GlowBlob Auroa radius
GlowIntensity=5 'Glowblob intensity


'***********************************************************************************************************************************




'******************************************PUPFLASHERS***********************************

'******************************************LEFT APRON********************************

Sub pupflasher1_Timer()
    pupflasher1.VideoCapUpdate="PUPSCREEN18"
end Sub
'******************************************RIGHT APRON********************************

Sub pupflasher2_Timer()
    pupflasher2.VideoCapUpdate="PUPSCREEN19"
end Sub
'********************************************************************************
If  PupScreen1 = 2 Then
  pupflasher1.VideoCapWidth=200
  pupflasher1.VideoCapHeight=200
  pupflasher1.visible=true
    pupflasher1.TimerEnabled=true
    pupflasher1.TimerInterval=60
    If FPS = 1 Then pupflasher1.timerinterval=40

  pupflasher2.VideoCapWidth=200
  pupflasher2.VideoCapHeight=200
  pupflasher2.visible=true
    pupflasher2.TimerEnabled=true
    pupflasher2.TimerInterval=60
    If FPS = 1 Then pupflasher2.timerinterval=40
End If

if PuPScreen1 = 0 Then
    pupflasher1.visible=false
    pupflasher1.TimerEnabled=false
    pupflasher2.visible=false
    pupflasher2.TimerEnabled=false
End If


'*********************************************************************************
'============================================================================================================
Sub PuP1Helper(ms)
  pupflasher.visible=True
  triggerscript ms, "pupflasher1.visible=False"
End Sub

Sub PuP2Helper(ms)
  pupflasher2.visible=True
  triggerscript ms, "pupflasher2.visible=False"
End Sub

Dim DesktopMode, CabMode, VRRoom, Scratches, VR_Backglass
DesktopMode = Table1.ShowDT
If VRMode = True Then VRRoom = 1 Else VRRoom = 0


Sub Table1_Init()

  ' Check for PinUp Driver Version meeting requriements
  ' Must be version 150 or later
  CheckPupVersion

' Load the chosen ramp type


  if WoodRamps = False Then
    LeftRampRopesOFF
    RightRampRopesOFF
    UPFRampStoneOff
    newRightRampON
    newLeftRampON
    newUPFRAmpOn
  Else
    newRightRampOFF
    newLeftRampOFF
    newUPFRAmpOff
    LeftRampRopesON
    RightRampRopesON
    UPFRampStoneOn
  End If

'RTP8
  RightFlipper.Elasticity = FlipperBounce
  LeftFlipper.Elasticity = FlipperBounce


  if DMDType = 2 Then
    pupflasher1.visible=false
    pupflasher2.visible=false
  End If


    LoadEM

  If ResetHighScore = 1 then Reseths

    Dim i
    Randomize

  Dim BIP
    BIP = 0
    'Impulse Plunger as autoplunger
    Const IMPowerSetting = 45 ' Plunger Power
    Const IMTime = 0.5        ' Time in seconds for Full Plunge
    Set plungerIM = New cvpmImpulseP
    With plungerIM
        .InitImpulseP swplunger, IMPowerSetting, IMTime
        .Random 1.5
        .InitExitSnd SoundFXDOF("Popper", 141, DOFPulse, DOFContactors), SoundFXDOF("fx_solenoid", 141, DOFPulse, DOFContactors)
        .CreateEvents "plungerIM"
    End With

    ' Magnet
    Set mMagnet = New cvpmMagnet
    With mMagnet
        .InitMagnet Magnet, 80
        .GrabCenter = True
        .CreateEvents "mMagnet"
    End With

    Set cbLeft = New cvpmCaptiveBall
    With cbLeft
        .InitCaptive CapTrigger, CapWall, CapKicker, 0
        .ForceTrans = .7
        .MinForce = 3.5
        .CreateEvents "cbLeft"
        .Start
    End With


    ' Misc. VP table objects Initialisation, droptargets, animations...
    VPObjects_Init

    ' load saved values, highscore, names, jackpot
    Credits = 0

    Loadhs

    ' Initalise the DMD display
    'DMD_Init

    ' freeplay or coins
    bFreePlay = True 'we want coins

    if bFreePlay Then DOF 121, DOFOn


    ' Init main variables and any other flags
  Debug "Initiliazing Table"
  WallsDown
  bEOBSupress = False
    bAttractMode = False
    bOnTheFirstBall = False
    bBallInPlungerLane = False
    bBallSaverActive = False
    bBallSaverReady = False
    bMultiBallMode = 0
    PFxSeconds = 0
    bGameInPlay = False
  bDungeonSelectMode = False
    bAutoPlunger = False
    bMusicOn = True
    BallsOnPlayfield = 0
    BallsInHole = 0
    LastSwitchHit = ""
    Tilt = 0
    TiltSensitivity = 6
    Tilted = False
    bBonusHeld = False
    bJackpot = False
    bInstantInfo = False
    ' set any lights for the attract mode
    GiOff

  GameReady = 1


    RealTime.Enabled = 1

  LowerAllDTs


  PUPINIT


  Glowball_Init 'Start Glowballs
  DarknessLayer.Opacity = DefaultDarkness

End Sub

'//////////////////////////////////////////////////////////////////////
'// TIMERS
'//////////////////////////////////////////////////////////////////////
Dim LED_Intensity : LED_Intensity = 100
Dim PLA_LED_Intensity : PLA_LED_Intensity = 200
Dim MON_LED_Intensity : MON_LED_Intensity = 1

' The game timer interval is 10 ms
Sub GameTimer_Timer()

'ramps
  'Primitive126.blenddisablelighting = rramplight.getinplayintensity * 2 + 1
  'rramplight2.intensity = rramplight.getinplayintensity * 2

  DarkD.blenddisablelighting = 0.4 + gi040.GetInPlayIntensity/6
  DarkA.blenddisablelighting = 0.4 + gi040.GetInPlayIntensity/6
  DarkR.blenddisablelighting = 0.4 + gi040.GetInPlayIntensity/6
  DarkK.blenddisablelighting = 0.4 + gi040.GetInPlayIntensity/6
  LFLogo.blenddisablelighting = 0.1 + gi031.GetInPlayIntensity/22
  LFLogo001.blenddisablelighting = 0.1 + gi042.GetInPlayIntensity/22
  RFLogo.blenddisablelighting = 0.1 + gi031.GetInPlayIntensity/22
  RFLogo001.blenddisablelighting = 0.1 + gi050.GetInPlayIntensity/22

  'wall226.blenddisablelighting = 0.4

  Cor.Update            'update ball tracking
  RollingUpdate         'update rolling sounds

  'Round
  pon002.blenddisablelighting = LED_Intensity * li002.GetInPlayIntensity '
  pon003.blenddisablelighting = LED_Intensity * li003.GetInPlayIntensity '
  pon004.blenddisablelighting = LED_Intensity * lix2.GetInPlayIntensity '
  pon005.blenddisablelighting = LED_Intensity * lix4.GetInPlayIntensity '
  pon006.blenddisablelighting = LED_Intensity * lix6.GetInPlayIntensity '
  pon007.blenddisablelighting = LED_Intensity * lix8.GetInPlayIntensity '
  pon008.blenddisablelighting = LED_Intensity * lightshootagain.GetInPlayIntensity '
  pon009.blenddisablelighting = LED_Intensity * li004.GetInPlayIntensity '
  pon010.blenddisablelighting = LED_Intensity * li005.GetInPlayIntensity '
  pon011.blenddisablelighting = LED_Intensity * li015.GetInPlayIntensity '
  pon012.blenddisablelighting = LED_Intensity * li016.GetInPlayIntensity '
  pon013.blenddisablelighting = LED_Intensity * li018.GetInPlayIntensity '
  pon014.blenddisablelighting = LED_Intensity * li017.GetInPlayIntensity '
  pon015.blenddisablelighting = LED_Intensity * li038.GetInPlayIntensity '
  pon016.blenddisablelighting = LED_Intensity * li022.GetInPlayIntensity '
  pon017.blenddisablelighting = LED_Intensity * li021.GetInPlayIntensity '
  pon018.blenddisablelighting = LED_Intensity * li032.GetInPlayIntensity '
  'pon019.blenddisablelighting = LED_Intensity * li019.GetInPlayIntensity '
  'pon020.blenddisablelighting = LED_Intensity * li020.GetInPlayIntensity '
  'pon021.blenddisablelighting = LED_Intensity * li056.GetInPlayIntensity '
  'pon022.blenddisablelighting = LED_Intensity * li054.GetInPlayIntensity '
  'pon023.blenddisablelighting = LED_Intensity * li055.GetInPlayIntensity '
  pLight073.blenddisablelighting = LED_Intensity *li0130.GetInPlayIntensity '

  'Rectangle
  p37a001.blenddisablelighting = LED_Intensity * li045.GetInPlayIntensity '
  p37a002.blenddisablelighting = LED_Intensity * li030.GetInPlayIntensity '
  p37a003.blenddisablelighting = LED_Intensity * li031.GetInPlayIntensity '
  p37a004.blenddisablelighting = LED_Intensity * li026.GetInPlayIntensity '
  p37a005.blenddisablelighting = LED_Intensity * li029.GetInPlayIntensity '
  p37a006.blenddisablelighting = LED_Intensity * li034.GetInPlayIntensity '
  p37a007.blenddisablelighting = LED_Intensity * li027.GetInPlayIntensity '
  p37a008.blenddisablelighting = LED_Intensity * li033.GetInPlayIntensity '
  p37a009.blenddisablelighting = LED_Intensity * li028.GetInPlayIntensity '
  p37a010.blenddisablelighting = LED_Intensity * li047.GetInPlayIntensity '

  'Triangle
  p23a001.blenddisablelighting = LED_Intensity * li060.GetInPlayIntensity '
  p23a002.blenddisablelighting = LED_Intensity * li036.GetInPlayIntensity '
  p23a003.blenddisablelighting = LED_Intensity * li037.GetInPlayIntensity '
  p23a004.blenddisablelighting = LED_Intensity * li039.GetInPlayIntensity '
  p23a005.blenddisablelighting = LED_Intensity * li040.GetInPlayIntensity '
  p23a006.blenddisablelighting = LED_Intensity * li051.GetInPlayIntensity '

  'BobaTargets
  'boba1.blenddisablelighting = Li041.GetInPlayIntensity / 40
  'boba2.blenddisablelighting = Li042.GetInPlayIntensity / 40
  'boba3.blenddisablelighting = Li043.GetInPlayIntensity / 40
  'boba4.blenddisablelighting = Li044.GetInPlayIntensity / 40
  'boba5.blenddisablelighting = Li048.GetInPlayIntensity / 40

  'Heros
  p37a024.blenddisablelighting = PLA_LED_Intensity * li011.GetInPlayIntensity '
  p37a023.blenddisablelighting = PLA_LED_Intensity * li007.GetInPlayIntensity '
  p37a025.blenddisablelighting = PLA_LED_Intensity * li012.GetInPlayIntensity '
  p37a019.blenddisablelighting = PLA_LED_Intensity * li009.GetInPlayIntensity '
  p37a026.blenddisablelighting = PLA_LED_Intensity * li023.GetInPlayIntensity '
  p37a022.blenddisablelighting = PLA_LED_Intensity * li010.GetInPlayIntensity '
  p37a021.blenddisablelighting = PLA_LED_Intensity * li014.GetInPlayIntensity '
  p37a020.blenddisablelighting = PLA_LED_Intensity * li013.GetInPlayIntensity '

  'Monsters
  p23a007.blenddisablelighting = MON_LED_Intensity * li024.GetInPlayIntensity '
  p23a008.blenddisablelighting = MON_LED_Intensity * li025.GetInPlayIntensity '
  p23a009.blenddisablelighting = MON_LED_Intensity * li008.GetInPlayIntensity '
  p23a010.blenddisablelighting = MON_LED_Intensity * li006.GetInPlayIntensity '
  'upper pf
  p61.blenddisablelighting =  LED_Intensity * li061.GetInPlayIntensity
  p62.blenddisablelighting =  LED_Intensity * li062.GetInPlayIntensity
  p63.blenddisablelighting =  LED_Intensity * li063.GetInPlayIntensity
  p64.blenddisablelighting =  LED_Intensity * li064.GetInPlayIntensity
End Sub



' The frame timer interval is -1, so executes at the display frame rate
Sub FrameTimer_Timer()
  FlipperVisualUpdate       'update flipper shadows and primitives
  If DynamicBallShadowsOn Or AmbientBallShadowOn Then DynamicBSUpdate 'update ball shadows

End Sub

'******
' Keys
'******

Sub Table1_KeyDown(ByVal Keycode)


'LUT controls
If keycode = LeftMagnaSave Then bLutActive = True
    If keycode = RightMagnaSave Then
            If bLutActive Then
                if DisableLUTSelector = 0 then
                LUTSet = LUTSet  - 1
                if LutSet < 0 then LUTSet = 16
                SetLUT
                ShowLUT
            End If
        End If
        End If

If keycode = LeftTiltKey Then Nudge 90, 5:SoundNudgeLeft()
If keycode = RightTiltKey Then Nudge 270, 5:SoundNudgeRight()
If keycode = CenterTiltKey Then Nudge 0, 3:SoundNudgeCenter()



    If Keycode = AddCreditKey Then
        If Credits < 99 Then Credits = Credits + 1
        DOF 110, DOFPulse
        if bFreePlay = False Then DOF 121, DOFOn
        If(Tilted = False)Then
 '           DMDFlush
 '           DMD "", CL("CREDITS " & Credits), "", eNone, eNone, eNone, 500, True, "Coin_In_1"
            If NOT bGameInPlay Then ShowTableInfo:Playsound "Coin_In_1"
        End If

    if bGameInPlay And bBallInPlungerLane = True And BallsOnPlayfield < 2 And not bDungeonSelectMode Then
      RuleCardsAvailable = RuleCardsAvailable + 1
      if RuleCardsAvailable Mod 2 = 0 Then TurnOffRulecards
      if RuleCardsAvailable Mod 2 = 1 Then AdvanceRulecard
    End If
    End If

' If Keycode = AddCreditKey And bDungeonSelectMode Then
  If Keycode = LockbarKey And bDungeonSelectMode Then
    HideHelper
    if Mode(CurrentPlayer,DungeonVidIndex*2) < 2 Then 'make sure dungeon is not completed yet
      bDungeonSelectMode = False
      bInDungeonSelection = False
      StartMode DungeonVidIndex*2
    Else
      ' Display a message that dungeon is already closed
      GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Dungeon Already Completed"" ",6,0,0,0,0,False
      if DMDType = 0 Then
        GeneralPupQueue.Add "DisplayDSHelper","DisplayDSHelper",5,100,0,0,0,False
      Else
        GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,100,0,0,0,False
      End If
    End If
  End If

    If keycode = PlungerKey Then
        Plunger.Pullback
        SoundPlungerPull()
    TimerVRPlunger.Enabled = True
    TimerVRPlunger2.Enabled = False
    End If

    If hsbModeActive Then
        EnterHighScoreKey(keycode)
        Exit Sub
    End If

    ' Normal flipper action

  If Missions(CurrentPlayer,2) = 1 And bHoldBall = True and keycode = rightflipperkey Then
    Debug "Gambler kick out retry"
    GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
    GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
    GeneralPupQueue.Add "Pup831","Pupevent 831:DisplayGambleRampHits:HideGamblePoints",40,100,0,0,0,False
    BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
    BallHandlingQueue.Add "bHoldBall-F","bHoldBall = False ",30,KickOutDelay,0,0,0,False
    li038.state = 2 ' turn Quest light back on
    GambleModeTimer.Enabled = 1
    Exit Sub
  End If

  If Missions(CurrentPlayer,2) = 1 and bHoldBall = True and keycode = leftflipperkey Then
    Debug "Balls in hole: " & ballsinhole
    if GMode And Ballsinhole > 0 Then
      HideGamblePoints
      GambleCollect
      Debug "Gambler kick out"
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
      BallHandlingQueue.Add "bHoldBall-F","bHoldBall = False ",30,KickOutDelay,0,0,0,False
      Exit Sub
    End If
  End If

  if keycode = leftflipperkey AND bDungeonSelectMode Then
    dungeonautoselect.Enabled  = False ' Reset timer that autoselect dungeon if no activity
    dungeonautoselect.Enabled  = True
    DungeonVidIndex = DungeonVidIndex - 1
    if DungeonVidIndex < 1 Then DungeonVidIndex = 4

    If Mode(CurrentPlayer,DungeonVidIndex*2) < 2 Then
      GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Fire Key to Select Dungeon"" ",6,0,0,0,0,False
    Else
      GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Dungeon Already Completed"" ",6,0,0,0,0,False
    End If

    if DMDType = 0 Then
      GeneralPupQueue.Add "DisplayDSHelper","DisplayDSHelper",5,100,0,0,0,False
    Else
      GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,100,0,0,0,False
    End If
  PlayDungeonSelection
  End If

  if keycode = rightflipperkey AND bDungeonSelectMode Then
    dungeonautoselect.Enabled  = False ' Reset timer that autoselect dungeon if no activity
    dungeonautoselect.Enabled  = True
    DungeonVidIndex = DungeonVidIndex + 1
    if DungeonVidIndex > 4 Then DungeonVidIndex = 1

    If Mode(CurrentPlayer,DungeonVidIndex*2) < 2 Then
      GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Fire Key to Select Dungeon"" ",6,0,0,0,0,False
    Else
      GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Dungeon Already Completed"" ",6,0,0,0,0,False
    End If

    if DMDType = 0 Then
      GeneralPupQueue.Add "DisplayDSHelper","DisplayDSHelper",5,100,0,0,0,False
    Else
      GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,100,0,0,0,False
    End If
  PlayDungeonSelection
  End If

'RTP3

' This code block is used to see if the player wants to continue from where they left off or collect points and restart from scratch
  if keycode = leftflipperkey AND bContinueScreen Then
    ' Collect points
    if GoldSack(CurrentPlayer) > 0 Then
      GoldSack(CurrentPlayer) = GoldSack(CurrentPlayer) - 1
      Addscore2 1000000
      DisplayFinalScore
      Debug "Post LeftFlipper TG: " & GoldSack(CurrentPlayer)
      if GoldSack(CurrentPlayer) = 0 Then
        triggerscript 3000, "HideFinalScore"
        triggerscript 3000, "stopscorbit"
        CheckHighScore()
      Else
        DisplayContinueMessage
      End If
    Else
      'DisplayFinalScore
      if DMDType = 0 Then
        triggerscript 3000, "HideFinalScore:CheckHighScore()"
      Else
        triggerscript 3000, "HideFinalScore"
        triggerscript 3000, "stopscorbit"
        CheckHighScore()
      End If
      'check high score
    End If
  End If

  if keycode = rightflipperkey AND bContinueScreen Then
    ' Continue Game from where they left offsub
      ' check for high score?
      bContinueGame = True
      triggerscript 5800, "HideContinueMessage"

      if DMDType = 0 Then
        triggerscript 3000, "HideFinalScore:CheckHighScore()"
      Else
        triggerscript 3000, "HideFinalScore"
        triggerscript 3000, "stopscorbit"
        CheckHighScore()
      End If
'     ResetForNewGame()
  End If

' This code block is used to trap the ball in scoop2 until the player decides to continue into the dungeon
  if keycode = rightflipperkey OR keycode = leftflipperkey Then
    if bHoldBall = True And bHoldBallDelay = False And not bDungeonSelectMode Then
        GetAM
        Select Case ActiveMode
          Case 0:
            if BSMode <> 1 And GMode <> 1 and TMode <> 1 Then
              Debug3 "In flipper hit: " &AMCombo
              HideHelper
              StartNextMode
              BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
            End If
          Case 1,3,5,7:
              Debug2 "In flipper hit: " &AMCombo
              HideHelper
              StartNextMode
              BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
          Case 2,4,6,8:
            if AMState = 1 Then
              Debug "Ball Hold"
              BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
              ClearGuideMessages
              if DMDType = 2 Then InGuide = 0
              if DMDType <> 0 Then
                UpdateAll
              Else
                UpdateBG
              End If
              HideHelper
              triggerscript 7000, "hidehelper "  ' call again to make sure it wasnt just skipped over
              StartDungeonBattle
              'StartDTs
            End If
          Case 10,11,12,13,14:
            if AMState = 1 Then
              Debug "Ball Hold"
              BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
              ClearGuideMessages
              if DMDType = 2 Then InGuide = 0
              if DMDType <> 0 Then
                UpdateAll
              Else
                UpdateBG
              End If
              HideHelper
              triggerscript 7000, "hidehelper "  ' call again to make sure it wasnt just skipped over
              StartDungeonBattle
              'StartDTs   ' DO NOT CALL AMBUSH
            End If
        End Select
      bHoldBall = False
    End If

  End If
'==========================================================
'       Decision INN
'==========================================================
' This code is used after a lost ball, and waits for the player to make a decision on returning to the Inn( non mode 0 )  or the Village Mode 0
if keycode = leftflipperkey AND bDecision = True Then
  bInn = True
  bHoldBall = False
  bHoldBallDelay = False
  GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,False
  GeneralPupQueue.Add "bDecision-F","bDecision = false",20,100,0,0,0,False

  AudioQueue.Add "Pup232","PuPEvent 232",20,0,0,0,0,False ' return to inn voiceover
  AudioQueue.Add "Pup446","PuPEvent 446",20,3100,0,0,0,False ' return to inn music
  GeneralPupQueue.Add "Pup347","pupevent 347",90,3400,0,0,0,True

Debug "LastMode/Activemode:" &Lastmode &"-" & Activemode
  if LastMode < 14 And PartySize(CurrentPlayer) > 0 Then
    Debug "Decision Left - Inn : "  &LastMode &"-" &activeMode
    UpdateDecision
    li047.state = 0 ' make sure Inn light is off
    'li038.state = 0 ' make sure quest light is off

    If DMDType = 2 Then
      GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
      GeneralPupQueue.Add "bSupressDMD-F","bSupressDMD = False",21,0,0,0,0,False
      InGuide = 0
    Else
      GeneralPupQueue.Add "Pup511","pupevent 511",90,0,0,0,0,True
      Debug "Clear & Turn off PuP 1"
      pupflasher1.visible=false
    End If

    CreateNewBall
    if LastMode > 8 And PartySize(CurrentPlayer) = 4 Then bBossDefeatedFullParty = True

    ContinueMode LastMode
  End If ' end if activemode < 13

End If
'==========================================================
'                Decision Village
'==========================================================
if keycode = rightflipperkey  AND bDecision = True Then
  GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True ' clear DMD guide
  GeneralPupQueue.Add "bDecision-F","bDecision = false",20,100,0,0,0,False
  bHoldBall = False
  bHoldBallDelay = False

  if ActiveMode < 14 And PartySize(CurrentPlayer) > 0 Then
    Debug "Decision Right - Village :" &AMCombo

    'ContinueMode LastMode '129.5
    ResetModes  ' 137.9
    ReturnToVillage
    CreateNewBall
    UpdateDecision


    If DMDType = 2 Then
      GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
      GeneralPupQueue.Add "bSupressDMD-F","bSupressDMD = False",21,0,0,0,0,False
      InGuide = 0
      'UpdateAll
    Else
      GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,False
      InGuide = 0
      Debug "Turn off PuP 1"
      pupflasher1.visible=false
    End If

  'UpdateDMD
  End If
  AudioQueue.Add "Pup233","PuPEvent 233",20,0,0,0,AudioExpiry,False
  AudioQueue.Add "Pup445","PuPEvent 445",20,3100,0,0,0,False ' return to inn voiceover
End If
'==========================================================
  If keycode = LeftFlipperKey Then
    Pincab_Flipper_Button_Left.X = Pincab_Flipper_Button_Left.X + 10
  End If

  If keycode = RightFlipperKey Then
    Pincab_Flipper_Button_Right.X = Pincab_Flipper_Button_Right.X - 10
  End If

  If keycode = LeftMagnaSave Then
    Pincab_Magna_Button_Left.X = Pincab_Magna_Button_Left.X + 10
  End If

  If keycode = RightMagnaSave Then
    Pincab_Magna_Button_Right.X = Pincab_Magna_Button_Right.X - 10
  End If


    If bGameInPlay AND NOT Tilted Then
        If keycode = LeftTiltKey Then CheckTilt 'only check the tilt during game
        If keycode = RightTiltKey Then CheckTilt
        If keycode = CenterTiltKey Then CheckTilt

        If keycode = LeftFlipperKey And bBallinPlungerLane And BallsonPlayfield = 1 Then
      InstantInfoTimer.Enabled = True
    End If
        If keycode = RightFlipperKey And bBallinPlungerLane And BallsonPlayfield = 1 Then
      InstantInfoTimer.Enabled = True
    End If

        If keycode = LeftFlipperKey Then
      HideHelper ' Make sure message is cleared
      ClearPupMessages ' RC15
      FlipperActivate LeftFlipper, LFPress
      SolLFlipper 1

        'InstantInfoTimer.Enabled = True
        RotateLaneLights 1
        If StagedFlippers = 0 Then
          SolMLFlipper 1
        End If

        If StagedFlippers = 0 And bKillUPF = False Then
          SolULFlipper 1
        End If
    End If
        If keycode = RightFlipperKey Then
      RFlipperUsed = 1
      HideHelper ' make sure message is cleared
      ClearPupMessages ' RC15
      if bMagnetcaptured And UseRflipper Then
        ReleaseMagnetBalls
      End If
      FlipperActivate RightFlipper, RFPress
      SolRFlipper 1
        'InstantInfoTimer.Enabled = True
        RotateLaneLights 0
          If StagedFlippers = 0 Then
            if  bKillUPF = False Then
              SolURFlipper 1
            End If
            if MagnetCheckTimer.Enabled = 0 then SolMRFlipper 1
          End If
    End If

    If StagedFlippers <> 0 Then
      If keycode = 30 Then ' Left Stage 2
        SolULFlipper 1
        SolMLFlipper 1
      End If
      If keycode = 40 Then ' Right stage 2
        SolURFlipper 1
        if MagnetCheckTimer.Enabled = 0 then SolMRFlipper 1
      End If
    End If

    If keycode = LeftMagnaSave Then
      Dim tmpBOT
      tmpBOT = GetBalls
      if Ubound(tmpBOT) + ballsinhole = 1 Then
        mMagnet.MagnetOn = True:DOF 132, DOFOn
        MagnetCheckTimer.Enabled = 1
        MagnetMessage
        li0130.state = 2
        triggerscript MagnetTime*1000, "DisableMagnet"
        if RuleCardsAvailable Mod 2 = 1 Then RewindRulecard
      End If
    End If

    If keycode = RightMagnaSave Then
      ReleaseMagnetBalls
    End If

    If keycode = RightMagnaSave And bBallInPlungerLane = True And BallsOnPlayfield < 2 And not bDungeonSelectMode Then
      if RuleCardsAvailable Mod 2 = 1 Then AdvanceRulecard
    End If

    If keycode = LeftMagnaSave And bBallInPlungerLane = True And BallsOnPlayfield < 2 And not bDungeonSelectMode Then
      if RuleCardsAvailable Mod 2 = 1 Then RewindRulecard
    End If


        If keycode = StartGameKey Then
            If((PlayersPlayingGame < MaxPlayers)AND(bOnTheFirstBall = True))Then
                If(bFreePlay = True)Then
                    PlayersPlayingGame = PlayersPlayingGame + 1
                    TotalGamesPlayed = TotalGamesPlayed + 1
 '                   DMD "_", CL(PlayersPlayingGame & " PLAYERS"), "", eNone, eBlink, eNone, 1000, True, ""
                Else
                    If(Credits > 0)then
                        PlayersPlayingGame = PlayersPlayingGame + 1
                        TotalGamesPlayed = TotalGamesPlayed + 1
                        Credits = Credits - 1
   '                     DMD "_", CL(PlayersPlayingGame & " PLAYERS"), "", eNone, eBlink, eNone, 1000, True, ""
                        If Credits < 1 And bFreePlay = False Then DOF 121, DOFOff
                        Else
                            ' Not Enough Credits to start a game.
'                            DMD CL("CREDITS " & Credits), CL("INSERT COIN"), "", eNone, eBlink, eNone, 1000, True, "vo_givemeyourmoney"
                    End If
                End If
            End If
        End If
        Else ' If (GameInPlay)


            If keycode = StartGameKey And bGameInPlay = False Then


                If(bFreePlay = True)Then
                    If(BallsOnPlayfield = 0) And GameReady = 1 Then
            'HideHighScores
            'HighScoreQueue.RemoveAll(True)
                        ResetForNewGame()
                    End If
                Else
                    If(Credits > 0)Then
                        If(BallsOnPlayfield < 1)Then
                            Credits = Credits - 1
                            If Credits < 1 And bFreePlay = False Then DOF 121, DOFOff
              'HideHighScores
              'HighScoreQueue.RemoveAll(True)
                            ResetForNewGame()
                        End If
                    Else
                        ' Not Enough Credits to start a game.
 '                       DMDFlush
 '                       DMD CL("CREDITS " & Credits), CL("INSERT COIN"), "", eNone, eBlink, eNone, 1000, True, "vo_givemeyourmoney"
                        ShowTableInfo
                    End If
                End If
            End If

'   If keycode = LeftFlipperKey And keycode = RightFlipperKey Then
'     InstantInfoTimer.Enabled = True
'   End If

    End If ' If (GameInPlay)
End Sub

Sub Table1_KeyUp(ByVal keycode)

'LUT controls
  If keycode = LeftMagnaSave Then bLutActive = False
  If keycode = LeftMagnaSave And DisableLUTSelector = 0 Then SaveLUT

    If keycode = PlungerKey Then
        Plunger.Fire
        SoundPlungerReleaseBall()
    TimerVRPlunger.Enabled = False
    TimerVRPlunger2.Enabled = True
    Pincab_Shooter.Y = -163
    End If

    If hsbModeActive Then
        Exit Sub
    End If

    ' Table specific

  If keycode = LeftFlipperKey Then
    Pincab_Flipper_Button_Left.X = Pincab_Flipper_Button_Left.X - 10
  End If

  If keycode = RightFlipperKey Then
    Pincab_Flipper_Button_Right.X = Pincab_Flipper_Button_Right.X + 10
  End If

  If keycode = LeftMagnaSave Then
    Pincab_Magna_Button_Left.X = Pincab_Magna_Button_Left.X - 10
  End If

  If keycode = RightMagnaSave Then
    Pincab_Magna_Button_Right.X = Pincab_Magna_Button_Right.X + 10
  End If

    If bGameInPLay AND NOT Tilted Then
     If keycode = LeftFlipperKey Then
      FlipperDeActivate LeftFlipper, LFPress
            SolLFlipper 0
        If StagedFlippers = 0 Then
          SolULFlipper 0
          SolMLFlipper 0
        End If
            InstantInfoTimer.Enabled = False
            If bInstantInfo Then
 '               DMDScoreNow
        'HideHighScores
        'HighScoreQueue.RemoveAll(True)
                bInstantInfo = False
            End If
        End If
        If keycode = RightFlipperKey Then
      RFlipperUsed = 0
      FlipperDeActivate RightFlipper, RFPress
            SolRFlipper 0
      SolMRFlipper 0
'       If StagedFlippers = 0 And bKillUPF = False Then
          SolURFlipper 0
'       End If
            InstantInfoTimer.Enabled = False
            If bInstantInfo Then
 '               DMDScoreNow
        'HideHighScores
        'HighScoreQueue.RemoveAll(True)
                bInstantInfo = False
            End If
        End If
' If StagedFlippers <> 0 And bKillUPF = False Then
    If keycode = 30 Then
      SolULFlipper 0
      SolMLFlipper 0
    End If
    If keycode = 40 Then
      SolURFlipper 0
      SolMRFlipper 0
    End If
'    End If

  If keycode = LeftMagnaSave and EnableLUTSelector = 1 Then
    saveLUT
  End If

End IF
End Sub

Sub InstantInfoTimer_Timer
    InstantInfoTimer.Enabled = False
    If NOT hsbModeActive Then
        bInstantInfo = True
 '       DMDFlush
        InstantInfo
    DisplayHighScores
    End If
End Sub

'*************
' Pause Table
'*************

Sub Table_Paused:Controller.Pause = 1:End Sub
Sub Table_unPaused:Controller.Pause = 0:End Sub

Sub Table1_Exit
    If B2SOn Then Controller.Stop
' dump
' dump2
  Debug "Exiting Game"
  pupflasher1.VideoCapUpdate=""
  pupflasher2.VideoCapUpdate=""
  SaveLut
    Savehs
End Sub

'//////////////////////////////////////////////////////////////////////
'// FLIPPERS
'//////////////////////////////////////////////////////////////////////

Const ReflipAngle = 20

' Flipper Solenoid Callbacks (these subs mimics how you would handle flippers in ROM based tables)
Sub SolLFlipper(Enabled)
  If Enabled Then
       DOF 101, DOFOn
  LF.Fire 'leftflipper.rotatetoend

    If leftflipper.currentangle < leftflipper.endangle + ReflipAngle Then
      RandomSoundReflipUpLeft LeftFlipper
    Else
      SoundFlipperUpAttackLeft LeftFlipper
      RandomSoundFlipperUpLeft LeftFlipper
    End If
  Else
        DOF 101, DOFOff
    LeftFlipper.RotateToStart
    If LeftFlipper.currentangle < LeftFlipper.startAngle - 5 Then
      RandomSoundFlipperDownLeft LeftFlipper
    End If
    FlipperLeftHitParm = FlipperUpSoundLevel
  End If
End Sub

Sub SolMLFlipper(Enabled)
  If Enabled Then
    LeftMiddleFlipper.RotateToEnd

    If LeftMiddleFlipper.currentangle < LeftMiddleFlipper.endangle + ReflipAngle Then
      RandomSoundReflipUpLeft LeftMiddleFlipper
    Else
      SoundFlipperUpAttackLeft LeftMiddleFlipper
      RandomSoundFlipperUpLeft LeftMiddleFlipper
    End If
  Else
    LeftMiddleFlipper.RotateToStart
    If LeftMiddleFlipper.currentangle < LeftMiddleFlipper.startAngle - 5 Then
      RandomSoundFlipperDownLeft LeftMiddleFlipper
    End If
    FlipperLeftHitParm = FlipperUpSoundLevel
  End If
End Sub

Sub SolULFlipper(Enabled)
  If Enabled Then
    LeftFlipper2.RotateToEnd

    If LeftFlipper2.currentangle < LeftFlipper2.endangle + ReflipAngle Then
      RandomSoundReflipUpLeft LeftFlipper2
    Else
      SoundFlipperUpAttackLeft LeftFlipper2
      RandomSoundFlipperUpLeft LeftFlipper2
    End If
  Else
    LeftFlipper2.RotateToStart
    If LeftFlipper2.currentangle < LeftFlipper2.startAngle - 5 Then
      RandomSoundFlipperDownLeft LeftFlipper2
    End If
    FlipperLeftHitParm = FlipperUpSoundLevel
  End If
End Sub

Sub SolRFlipper(Enabled)
  If Enabled Then
       DOF 102, DOFOn
  RF.Fire  'rightflipper.rotatetoend

    If rightflipper.currentangle > rightflipper.endangle - ReflipAngle Then
      RandomSoundReflipUpRight RightFlipper
    Else
      SoundFlipperUpAttackRight RightFlipper
      RandomSoundFlipperUpRight RightFlipper
    End If
  Else
        DOF 102, DOFOff
    RightFlipper.RotateToStart
    If RightFlipper.currentangle > RightFlipper.startAngle + 5 Then
      RandomSoundFlipperDownRight RightFlipper
    End If
    FlipperRightHitParm = FlipperUpSoundLevel
  End If
End Sub

Sub SolMRFlipper(Enabled)
  If Enabled Then
    RightMiddleFlipper.RotateToEnd   'rightflipper.rotatetoend

    If RightMiddleFlipper.currentangle > RightMiddleFlipper.endangle - ReflipAngle Then
      RandomSoundReflipUpRight RightMiddleFlipper
    Else
      SoundFlipperUpAttackRight RightMiddleFlipper
      RandomSoundFlipperUpRight RightMiddleFlipper
    End If
  Else
    RightMiddleFlipper.RotateToStart
    If RightFlipper2.currentangle > RightMiddleFlipper.startAngle + 5 Then
      RandomSoundFlipperDownRight RightMiddleFlipper
    End If
    FlipperRightHitParm = FlipperUpSoundLevel
  End If
End Sub

Sub SolURFlipper(Enabled)
  If Enabled Then
    RightFlipper2.RotateToEnd  'rightflipper.rotatetoend

    If RightFlipper2.currentangle > RightFlipper2.endangle - ReflipAngle Then
      RandomSoundReflipUpRight RightFlipper2
    Else
      SoundFlipperUpAttackRight RightFlipper2
      RandomSoundFlipperUpRight RightFlipper2
    End If
  Else
    RightFlipper2.RotateToStart
    If RightFlipper2.currentangle > RightFlipper2.startAngle + 5 Then
      RandomSoundFlipperDownRight RightFlipper2
    End If
    FlipperRightHitParm = FlipperUpSoundLevel
  End If
End Sub


' Flipper collide subs
Sub LeftFlipper_Collide(parm)
  CheckLiveCatch Activeball, LeftFlipper, LFCount, parm
  LeftFlipperCollide parm
End Sub

Sub RightFlipper_Collide(parm)
  CheckLiveCatch Activeball, RightFlipper, RFCount, parm
  RightFlipperCollide parm
End Sub

' This subroutine updates the flipper shadows and visual primitives
Sub FlipperVisualUpdate
  FlipperLSh.RotZ = LeftFlipper.CurrentAngle
  FlipperRSh.RotZ = RightFlipper.CurrentAngle
  FlipperLSh001.RotZ = LeftMiddleFlipper.CurrentAngle
  FlipperRSh001.RotZ = RightMiddleFlipper.CurrentAngle

  LFLogo.RotZ = LeftFlipper.CurrentAngle
  RFlogo.RotZ = RightFlipper.CurrentAngle
  LFLogo001.RotZ = LeftMiddleFlipper.CurrentAngle
  RFlogo001.RotZ = RightMiddleFlipper.CurrentAngle
  LFlogo002.Rotz = LeftFlipper2.CurrentAngle
  RFlogo002.RotZ = RightFlipper2.CurrentAngle
End Sub



dim LF : Set LF = New FlipperPolarity
dim RF : Set RF = New FlipperPolarity

InitPolarity
''*******************************************
'' Early 90's and after
'
Sub InitPolarity()
        dim x, a : a = Array(LF, RF)
        for each x in a
                x.AddPoint "Ycoef", 0, RightFlipper.Y-65, 1        'disabled
                x.AddPoint "Ycoef", 1, RightFlipper.Y-11, 1
                x.enabled = True
                x.TimeDelay = 60
        Next

        AddPt "Polarity", 0, 0, 0
        AddPt "Polarity", 1, 0.05, -5.5
        AddPt "Polarity", 2, 0.4, -5.5
        AddPt "Polarity", 3, 0.6, -5.0
        AddPt "Polarity", 4, 0.65, -4.5
        AddPt "Polarity", 5, 0.7, -4.0
        AddPt "Polarity", 6, 0.75, -3.5
        AddPt "Polarity", 7, 0.8, -3.0
        AddPt "Polarity", 8, 0.85, -2.5
        AddPt "Polarity", 9, 0.9,-2.0
        AddPt "Polarity", 10, 0.95, -1.5
        AddPt "Polarity", 11, 1, -1.0
        AddPt "Polarity", 12, 1.05, -0.5
        AddPt "Polarity", 13, 1.1, 0
        AddPt "Polarity", 14, 1.3, 0

        addpt "Velocity", 0, 0,         1
        addpt "Velocity", 1, 0.16, 1.06
        addpt "Velocity", 2, 0.41,         1.05
        addpt "Velocity", 3, 0.53,         1'0.982
        addpt "Velocity", 4, 0.702, 0.968
        addpt "Velocity", 5, 0.95,  0.968
        addpt "Velocity", 6, 1.03,         0.945

        LF.Object = LeftFlipper
        LF.EndPoint = EndPointLp
        RF.Object = RightFlipper
        RF.EndPoint = EndPointRp
End Sub


' Flipper trigger hit subs
Sub TriggerLF_Hit() : LF.Addball activeball : End Sub
Sub TriggerLF_UnHit() : LF.PolarityCorrect activeball : End Sub
Sub TriggerRF_Hit() : RF.Addball activeball : End Sub
Sub TriggerRF_UnHit() : RF.PolarityCorrect activeball : End Sub




'******************************************************
'  FLIPPER CORRECTION FUNCTIONS
'******************************************************

Sub AddPt(aStr, idx, aX, aY)        'debugger wrapper for adjusting flipper script in-game
  dim a : a = Array(LF, RF)
  dim x : for each x in a
    x.addpoint aStr, idx, aX, aY
  Next
End Sub

Class FlipperPolarity
  Public DebugOn, Enabled
  Private FlipAt        'Timer variable (IE 'flip at 723,530ms...)
  Public TimeDelay        'delay before trigger turns off and polarity is disabled TODO set time!
  private Flipper, FlipperStart,FlipperEnd, FlipperEndY, LR, PartialFlipCoef
  Private Balls(20), balldata(20)

  dim PolarityIn, PolarityOut
  dim VelocityIn, VelocityOut
  dim YcoefIn, YcoefOut
  Public Sub Class_Initialize
    redim PolarityIn(0) : redim PolarityOut(0) : redim VelocityIn(0) : redim VelocityOut(0) : redim YcoefIn(0) : redim YcoefOut(0)
    Enabled = True : TimeDelay = 50 : LR = 1:  dim x : for x = 0 to uBound(balls) : balls(x) = Empty : set Balldata(x) = new SpoofBall : next
  End Sub

  Public Property let Object(aInput) : Set Flipper = aInput : StartPoint = Flipper.x : End Property
  Public Property Let StartPoint(aInput) : if IsObject(aInput) then FlipperStart = aInput.x else FlipperStart = aInput : end if : End Property
  Public Property Get StartPoint : StartPoint = FlipperStart : End Property
  Public Property Let EndPoint(aInput) : FlipperEnd = aInput.x: FlipperEndY = aInput.y: End Property
  Public Property Get EndPoint : EndPoint = FlipperEnd : End Property
  Public Property Get EndPointY: EndPointY = FlipperEndY : End Property

  Public Sub AddPoint(aChooseArray, aIDX, aX, aY) 'Index #, X position, (in) y Position (out)
    Select Case aChooseArray
      case "Polarity" : ShuffleArrays PolarityIn, PolarityOut, 1 : PolarityIn(aIDX) = aX : PolarityOut(aIDX) = aY : ShuffleArrays PolarityIn, PolarityOut, 0
      Case "Velocity" : ShuffleArrays VelocityIn, VelocityOut, 1 :VelocityIn(aIDX) = aX : VelocityOut(aIDX) = aY : ShuffleArrays VelocityIn, VelocityOut, 0
      Case "Ycoef" : ShuffleArrays YcoefIn, YcoefOut, 1 :YcoefIn(aIDX) = aX : YcoefOut(aIDX) = aY : ShuffleArrays YcoefIn, YcoefOut, 0
    End Select
    if gametime > 100 then Report aChooseArray
  End Sub

  Public Sub Report(aChooseArray)         'debug, reports all coords in tbPL.text
    if not DebugOn then exit sub
    dim a1, a2 : Select Case aChooseArray
      case "Polarity" : a1 = PolarityIn : a2 = PolarityOut
      Case "Velocity" : a1 = VelocityIn : a2 = VelocityOut
      Case "Ycoef" : a1 = YcoefIn : a2 = YcoefOut
        case else :tbpl.text = "wrong string" : exit sub
    End Select
    dim str, x : for x = 0 to uBound(a1) : str = str & aChooseArray & " x: " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    tbpl.text = str
  End Sub

  Public Sub AddBall(aBall) : dim x : for x = 0 to uBound(balls) : if IsEmpty(balls(x)) then set balls(x) = aBall : exit sub :end if : Next  : End Sub

  Private Sub RemoveBall(aBall)
    dim x : for x = 0 to uBound(balls)
      if TypeName(balls(x) ) = "IBall" then
        if aBall.ID = Balls(x).ID Then
          balls(x) = Empty
          Balldata(x).Reset
        End If
      End If
    Next
  End Sub

  Public Sub Fire()
    Flipper.RotateToEnd
    processballs
  End Sub

  Public Property Get Pos 'returns % position a ball. For debug stuff.
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        pos = pSlope(Balls(x).x, FlipperStart, 0, FlipperEnd, 1)
      End If
    Next
  End Property

  Public Sub ProcessBalls() 'save data of balls in flipper range
    FlipAt = GameTime
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        balldata(x).Data = balls(x)
      End If
    Next
    PartialFlipCoef = ((Flipper.StartAngle - Flipper.CurrentAngle) / (Flipper.StartAngle - Flipper.EndAngle))
    PartialFlipCoef = abs(PartialFlipCoef-1)
  End Sub
  Private Function FlipperOn() : if gameTime < FlipAt+TimeDelay then FlipperOn = True : End If : End Function        'Timer shutoff for polaritycorrect

  Public Sub PolarityCorrect(aBall)
    if FlipperOn() then
      dim tmp, BallPos, x, IDX, Ycoef : Ycoef = 1

      'y safety Exit
      if aBall.VelY > -8 then 'ball going down
        RemoveBall aBall
        exit Sub
      end if

      'Find balldata. BallPos = % on Flipper
      for x = 0 to uBound(Balls)
        if aBall.id = BallData(x).id AND not isempty(BallData(x).id) then
          idx = x
          BallPos = PSlope(BallData(x).x, FlipperStart, 0, FlipperEnd, 1)
          if ballpos > 0.65 then  Ycoef = LinearEnvelope(BallData(x).Y, YcoefIn, YcoefOut)                                'find safety coefficient 'ycoef' data
        end if
      Next

      If BallPos = 0 Then 'no ball data meaning the ball is entering and exiting pretty close to the same position, use current values.
        BallPos = PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1)
        if ballpos > 0.65 then  Ycoef = LinearEnvelope(aBall.Y, YcoefIn, YcoefOut)                                                'find safety coefficient 'ycoef' data
      End If

      'Velocity correction
      if not IsEmpty(VelocityIn(0) ) then
        Dim VelCoef
        VelCoef = LinearEnvelope(BallPos, VelocityIn, VelocityOut)

        if partialflipcoef < 1 then VelCoef = PSlope(partialflipcoef, 0, 1, 1, VelCoef)

        if Enabled then aBall.Velx = aBall.Velx*VelCoef
        if Enabled then aBall.Vely = aBall.Vely*VelCoef
      End If

      'Polarity Correction (optional now)
      if not IsEmpty(PolarityIn(0) ) then
        If StartPoint > EndPoint then LR = -1        'Reverse polarity if left flipper
        dim AddX : AddX = LinearEnvelope(BallPos, PolarityIn, PolarityOut) * LR

        if Enabled then aBall.VelX = aBall.VelX + 1 * (AddX*ycoef*PartialFlipcoef)
      End If
    End If
    RemoveBall aBall
  End Sub
End Class

'******************************************************
'  FLIPPER POLARITY AND RUBBER DAMPENER SUPPORTING FUNCTIONS
'******************************************************

' Used for flipper correction and rubber dampeners
Sub ShuffleArray(ByRef aArray, byVal offset) 'shuffle 1d array
  dim x, aCount : aCount = 0
  redim a(uBound(aArray) )
  for x = 0 to uBound(aArray)        'Shuffle objects in a temp array
    if not IsEmpty(aArray(x) ) Then
      if IsObject(aArray(x)) then
        Set a(aCount) = aArray(x)
      Else
        a(aCount) = aArray(x)
      End If
      aCount = aCount + 1
    End If
  Next
  if offset < 0 then offset = 0
  redim aArray(aCount-1+offset)        'Resize original array
  for x = 0 to aCount-1                'set objects back into original array
    if IsObject(a(x)) then
      Set aArray(x) = a(x)
    Else
      aArray(x) = a(x)
    End If
  Next
End Sub

' Used for flipper correction and rubber dampeners
Sub ShuffleArrays(aArray1, aArray2, offset)
  ShuffleArray aArray1, offset
  ShuffleArray aArray2, offset
End Sub

' Used for flipper correction, rubber dampeners, and drop targets
Function BallSpeed(ball) 'Calculates the ball speed
  BallSpeed = SQR(ball.VelX^2 + ball.VelY^2 + ball.VelZ^2)
End Function

' Used for flipper correction and rubber dampeners
Function PSlope(Input, X1, Y1, X2, Y2)        'Set up line via two points, no clamping. Input X, output Y
  dim x, y, b, m : x = input : m = (Y2 - Y1) / (X2 - X1) : b = Y2 - m*X2
  Y = M*x+b
  PSlope = Y
End Function

' Used for flipper correction
Class spoofball
  Public X, Y, Z, VelX, VelY, VelZ, ID, Mass, Radius
  Public Property Let Data(aBall)
    With aBall
      x = .x : y = .y : z = .z : velx = .velx : vely = .vely : velz = .velz
      id = .ID : mass = .mass : radius = .radius
    end with
  End Property
  Public Sub Reset()
    x = Empty : y = Empty : z = Empty  : velx = Empty : vely = Empty : velz = Empty
    id = Empty : mass = Empty : radius = Empty
  End Sub
End Class

' Used for flipper correction and rubber dampeners
Function LinearEnvelope(xInput, xKeyFrame, yLvl)
  dim y 'Y output
  dim L 'Line
  dim ii : for ii = 1 to uBound(xKeyFrame)        'find active line
    if xInput <= xKeyFrame(ii) then L = ii : exit for : end if
  Next
  if xInput > xKeyFrame(uBound(xKeyFrame) ) then L = uBound(xKeyFrame)        'catch line overrun
  Y = pSlope(xInput, xKeyFrame(L-1), yLvl(L-1), xKeyFrame(L), yLvl(L) )

  if xInput <= xKeyFrame(lBound(xKeyFrame) ) then Y = yLvl(lBound(xKeyFrame) )         'Clamp lower
  if xInput >= xKeyFrame(uBound(xKeyFrame) ) then Y = yLvl(uBound(xKeyFrame) )        'Clamp upper

  LinearEnvelope = Y
End Function


'******************************************************
'  FLIPPER TRICKS
'******************************************************

RightFlipper.timerinterval=1
Rightflipper.timerenabled=True

sub RightFlipper_timer()
  FlipperTricks LeftFlipper, LFPress, LFCount, LFEndAngle, LFState
  FlipperTricks RightFlipper, RFPress, RFCount, RFEndAngle, RFState
  FlipperNudge RightFlipper, RFEndAngle, RFEOSNudge, LeftFlipper, LFEndAngle
  FlipperNudge LeftFlipper, LFEndAngle, LFEOSNudge,  RightFlipper, RFEndAngle
end sub

Dim LFEOSNudge, RFEOSNudge

Sub FlipperNudge(Flipper1, Endangle1, EOSNudge1, Flipper2, EndAngle2)
  Dim b, BOT
  BOT = GetBalls

  If Flipper1.currentangle = Endangle1 and EOSNudge1 <> 1 Then
    EOSNudge1 = 1
    'debug3 Flipper1.currentangle &" = "& Endangle1 &"--"& Flipper2.currentangle &" = "& EndAngle2
    If Flipper2.currentangle = EndAngle2 Then
      For b = 0 to Ubound(BOT)
        If FlipperTrigger(BOT(b).x, BOT(b).y, Flipper1) Then
          'debug3 "ball in flip1. exit"
          exit Sub
        end If
      Next
      For b = 0 to Ubound(BOT)
        If FlipperTrigger(BOT(b).x, BOT(b).y, Flipper2) Then
          BOT(b).velx = BOT(b).velx / 1.3
          BOT(b).vely = BOT(b).vely - 0.5
        end If
      Next
    End If
  Else
    If Abs(Flipper1.currentangle) > Abs(EndAngle1) + 30 then EOSNudge1 = 0
  End If
End Sub

'*****************
' Maths
'*****************
Dim PI: PI = 4*Atn(1)

Function dSin(degrees)
  dsin = sin(degrees * Pi/180)
End Function

Function dCos(degrees)
  dcos = cos(degrees * Pi/180)
End Function

Function Atn2(dy, dx)
  If dx > 0 Then
    Atn2 = Atn(dy / dx)
  ElseIf dx < 0 Then
    If dy = 0 Then
      Atn2 = pi
    Else
      Atn2 = Sgn(dy) * (pi - Atn(Abs(dy / dx)))
    end if
  ElseIf dx = 0 Then
    if dy = 0 Then
      Atn2 = 0
    else
      Atn2 = Sgn(dy) * pi / 2
    end if
  End If
End Function

'*************************************************
'  Check ball distance from Flipper for Rem
'*************************************************

Function Distance(ax,ay,bx,by)
  Distance = SQR((ax - bx)^2 + (ay - by)^2)
End Function

Function DistancePL(px,py,ax,ay,bx,by) ' Distance between a point and a line where point is px,py
  DistancePL = ABS((by - ay)*px - (bx - ax) * py + bx*ay - by*ax)/Distance(ax,ay,bx,by)
End Function

Function Radians(Degrees)
  Radians = Degrees * PI /180
End Function

Function AnglePP(ax,ay,bx,by)
  AnglePP = Atn2((by - ay),(bx - ax))*180/PI
End Function

Function DistanceFromFlipper(ballx, bally, Flipper)
  DistanceFromFlipper = DistancePL(ballx, bally, Flipper.x, Flipper.y, Cos(Radians(Flipper.currentangle+90))+Flipper.x, Sin(Radians(Flipper.currentangle+90))+Flipper.y)
End Function

Function FlipperTrigger(ballx, bally, Flipper)
  Dim DiffAngle
  DiffAngle  = ABS(Flipper.currentangle - AnglePP(Flipper.x, Flipper.y, ballx, bally) - 90)
  If DiffAngle > 180 Then DiffAngle = DiffAngle - 360

  If DistanceFromFlipper(ballx,bally,Flipper) < 48 and DiffAngle <= 90 and Distance(ballx,bally,Flipper.x,Flipper.y) < Flipper.Length Then
    FlipperTrigger = True
  Else
    FlipperTrigger = False
  End If
End Function


'*************************************************
'  End - Check ball distance from Flipper for Rem
'*************************************************

dim LFPress, RFPress, LFCount, RFCount
dim LFState, RFState
dim EOST, EOSA,Frampup, FElasticity,FReturn
dim RFEndAngle, LFEndAngle

Const FlipperCoilRampupMode = 0     '0 = fast, 1 = medium, 2 = slow (tap passes should work)

LFState = 1
RFState = 1
EOST = leftflipper.eostorque
EOSA = leftflipper.eostorqueangle
Frampup = LeftFlipper.rampup
FElasticity = LeftFlipper.elasticity
FReturn = LeftFlipper.return

Const EOSTnew = 0.8 '90's and later
Const EOSAnew = 1
Const EOSRampup = 0
Dim SOSRampup
Select Case FlipperCoilRampupMode
  Case 0:
    SOSRampup = 2.5
  Case 1:
    SOSRampup = 6
  Case 2:
    SOSRampup = 8.5
End Select

Const LiveCatch = 16
Const LiveElasticity = 0.45
Const SOSEM = 0.815
'Const EOSReturn = 0.055  'EM's
'Const EOSReturn = 0.045  'late 70's to mid 80's
'Const EOSReturn = 0.035  'mid 80's to early 90's
Const EOSReturn = 0.025  'mid 90's and later

LFEndAngle = Leftflipper.endangle
RFEndAngle = RightFlipper.endangle

Sub FlipperActivate(Flipper, FlipperPress)
  FlipperPress = 1
  Flipper.Elasticity = FElasticity

  Flipper.eostorque = EOST
  Flipper.eostorqueangle = EOSA
End Sub

Sub FlipperDeactivate(Flipper, FlipperPress)
  FlipperPress = 0
  Flipper.eostorqueangle = EOSA
  Flipper.eostorque = EOST*EOSReturn/FReturn


  If Abs(Flipper.currentangle) <= Abs(Flipper.endangle) + 0.1 Then
    Dim b, BOT
    BOT = GetBalls

    For b = 0 to UBound(BOT)
      If Distance(BOT(b).x, BOT(b).y, Flipper.x, Flipper.y) < 55 Then 'check for cradle
        If BOT(b).vely >= -0.4 Then BOT(b).vely = -0.4
      End If
    Next
  End If
End Sub

Sub FlipperTricks (Flipper, FlipperPress, FCount, FEndAngle, FState)
  Dim Dir
  Dir = Flipper.startangle/Abs(Flipper.startangle)        '-1 for Right Flipper

  If Abs(Flipper.currentangle) > Abs(Flipper.startangle) - 0.05 Then
    If FState <> 1 Then
      Flipper.rampup = SOSRampup
      Flipper.endangle = FEndAngle - 3*Dir
      Flipper.Elasticity = FElasticity * SOSEM
      FCount = 0
      FState = 1
    End If
  ElseIf Abs(Flipper.currentangle) <= Abs(Flipper.endangle) and FlipperPress = 1 then
    if FCount = 0 Then FCount = GameTime

    If FState <> 2 Then
      Flipper.eostorqueangle = EOSAnew
      Flipper.eostorque = EOSTnew
      Flipper.rampup = EOSRampup
      Flipper.endangle = FEndAngle
      FState = 2
    End If
  Elseif Abs(Flipper.currentangle) > Abs(Flipper.endangle) + 0.01 and FlipperPress = 1 Then
    If FState <> 3 Then
      Flipper.eostorque = EOST
      Flipper.eostorqueangle = EOSA
      Flipper.rampup = Frampup
      Flipper.Elasticity = FElasticity
      FState = 3
    End If

  End If
End Sub

Const LiveDistanceMin = 30  'minimum distance in vp units from flipper base live catch dampening will occur
Const LiveDistanceMax = 114  'maximum distance in vp units from flipper base live catch dampening will occur (tip protection)

Sub CheckLiveCatch(ball, Flipper, FCount, parm) 'Experimental new live catch
  Dim Dir
  Dir = Flipper.startangle/Abs(Flipper.startangle)    '-1 for Right Flipper
  Dim LiveCatchBounce                                                                                                                        'If live catch is not perfect, it won't freeze ball totally
  Dim CatchTime : CatchTime = GameTime - FCount

  if CatchTime <= LiveCatch and parm > 6 and ABS(Flipper.x - ball.x) > LiveDistanceMin and ABS(Flipper.x - ball.x) < LiveDistanceMax Then
    if CatchTime <= LiveCatch*0.5 Then                                                'Perfect catch only when catch time happens in the beginning of the window
      LiveCatchBounce = 0
    else
      LiveCatchBounce = Abs((LiveCatch/2) - CatchTime)        'Partial catch when catch happens a bit late
    end If

    If LiveCatchBounce = 0 and ball.velx * Dir > 0 Then ball.velx = 0
    ball.vely = LiveCatchBounce * (32 / LiveCatch) ' Multiplier for inaccuracy bounce
    ball.angmomx= 0
    ball.angmomy= 0
    ball.angmomz= 0
    Else
        If Abs(Flipper.currentangle) <= Abs(Flipper.endangle) + 1 Then FlippersD.Dampenf Activeball, parm
  End If
End Sub

Sub RotateLaneLights(n) 'n is the direction, 1 = left or 0 = right
    Dim tmp
    If bRotateLights Then
        If n = 1 Then
            tmp = li002.State
            li002.State = li003.State
            li003.State = li004.State
            li004.State = li005.State
            li005.State = tmp
        Else
            tmp = li005.State
            li005.State = li004.State
            li004.State = li003.State
            li003.State = li002.State
            li002.State = tmp
        End If
    End If
End Sub

'*********
' TILT
'*********

'NOTE: The TiltDecreaseTimer Subtracts .01 from the "Tilt" variable every round
Sub CheckTilt 'Called when table is nudged

    Dim BOT
    BOT = GetBalls
    ' exit the sub if no balls on the table
    If UBound(BOT) = lob - 1 Then Exit Sub
    Tilt = Tilt + TiltSensitivity                 'Add to tilt count
    TiltDecreaseTimer.Enabled = True
    If(Tilt > TiltSensitivity)AND(Tilt <= 15)Then 'show a warning
    'pNote "TILT", "WARNING"
    End if
    If(NOT Tilted)AND Tilt > 15 Then 'If more that 15 then TILT the table

    Debug "TILT OCCURRED"
    EOBHide "checktilt"
    GeneralPuPQueue.Add "Pup899","PuPEvent 899",99,0,0,0,0,True' Tilt Video
    GeneralPuPQueue.Add "EOBReturn-Tilt","EOBReturn ""CheckTilt""",91,7000,0,0,0,False
    GeneralPuPQueue.Add "Pup400","PuPEvent 400",91,7100,0,0,0,False

        InstantInfoTimer.Enabled = False
        'PlaySound "vo_yousuck" &RndNbr(5)
        DisableTable True
        TiltRecoveryTimer.Enabled = True 'start the Tilt delay to check for all the balls to be drained
        bMultiBallMode = 0           'normally disabled in the drain sub
        'StopMBmodes
    End If
End Sub


Sub TiltDecreaseTimer_Timer
    ' DecreaseTilt
    If Tilt > 0 Then
        Tilt = Tilt - 0.1
    Else
        TiltDecreaseTimer.Enabled = False
    End If
End Sub

Sub DisableTable(Enabled)
    If Enabled Then
        Tilted = True
        'turn off GI and turn off all the lights
        GiOff
        LightSeqTilt.Play SeqAllOff
        'Disable slings, bumpers etc
        LeftFlipper.RotateToStart
        LeftMiddleFlipper.RotateToStart
        RightFlipper.RotateToStart
        RightMiddleFlipper.RotateToStart
        Bumper1.Threshold = 100
        LeftSlingshot.Disabled = 1
        RightSlingshot.Disabled = 1
    Else
        Tilted = False
        'turn back on GI and the lights
        GiOn
        LightSeqTilt.StopPlay
        Bumper1.Threshold = 1
        LeftSlingshot.Disabled = 0
        RightSlingshot.Disabled = 0
        'clean up the buffer display
 '       DMDFlush
    End If
End Sub

Sub TiltRecoveryTimer_Timer()
    ' if all the balls have been drained then..
    If(BallsOnPlayfield < 1)Then
        ' do the normal end of ball thing (this doesn't give a bonus if the table is tilted)
        triggerscript 200, "EndOfBall "
        TiltRecoveryTimer.Enabled = False
    End If
' else retry (checks again in another second or so)
End Sub

'*****************************************
'         Music as wav sounds
' in VPX 10.7 you may use also mp3 or ogg
'*****************************************

Dim Song
Song = ""

Sub PlaySong(name)
    If bMusicOn Then
        If Song <> name Then
            StopSound Song
            Song = name
            PlaySound Song, -1, SongVolume
        End If
    End If
End Sub

Sub ChangeSong
    Select Case Mode(CurrentPlayer, 0)
        Case 0:
 '           iF bMultiBallMode OR bDungeonMBStarted Then
      if bMultiBallMode Or Missions(CurrentPlayer,14) = 2 Then
                'PlaySong "mu_multiball"
                'PlaySong "mu_plunger"
            Else
                'PlaySong "mu_plunger"
            End If
        Case 1:PlaySong "mu_minotaur"  ' The Ruins1
        Case 2:PlaySong "mu_hydra"     ' Hydra
        Case 3:PlaySong "mu_cerberus"  ' Cerberus
        Case 4:PlaySong "mu_medusa"    ' Medusa
        Case 5:PlaySong "mu_ares"      ' Ares
        Case 6:PlaySong "mu_poseidon"  ' Poseidon
        Case 7:PlaySong "mu_hades"     ' Hades
        Case 8:PlaySong "mu_zeus"      ' Zeus
        Case 9:PlaySong "mu_multiball" ' God or Demi-God mode -
    case 10:PlaySong "mu_plunger"   'default music
    End Select
End Sub

Sub StopSong(name)
    StopSound name
End Sub

'******************************
' Play random quotes & sounds
'******************************

Sub PlayThunder
    PlaySound "sfx_thunder" &RndNbr(9)
End Sub

Sub PlayLightning
    PlaySound "sfx_lightning" &RndNbr(6)
End Sub

'**********************
'     GI effects
' independent routine
' it turns on the gi
' when there is a ball
' in play
'**********************
dim gilvl:gilvl = 1
Dim OldGiState
OldGiState = -1   'start witht the Gi off

Sub ChangeGi(col) 'changes the gi color
    Dim bulb
    For each bulb in aGILights
        SetLightColor bulb, col, -1
    Next

    SetLightColor gi051, col, -1
    SetLightColor gi052, col, -1

    'SetLightColor gi053, col, -1
    SetLightColor gi054, col, -1
    SetLightColor gi055, col, -1
    SetLightColor Lbumper1a, col, -1
    SetLightColor Lbumper2a, col, -1


End Sub

Sub ChangeGIIntensity(factor) 'changes the intensity scale
    Dim bulb
    For each bulb in aGILights
        bulb.IntensityScale = factor
    Next
End Sub


Sub ChangeGIIntensity2(factor) 'changes the intensity scale
    Dim bulb
    For each bulb in aGILights
        bulb.Intensity = factor
    Next
End Sub

Sub GIUpdateTimer_Timer
    Dim tmp, obj
    tmp = Getballs
    If UBound(tmp) <> OldGiState Then
        OldGiState = Ubound(tmp)
        If UBound(tmp) = 0 Then '-1 means no balls, 0 is the first captive ball, 1 is the second captive ball...)
            GiOff               ' turn off the gi if no active balls on the table, we could also have used the variable ballsonplayfield.
        Else
            Gion
        End If
    End If
End Sub

Sub GiOn
    gilvl = 1

  rspin.image = "spinner_On"
  lspin.image = "spinner2_On"
  ShadowGi.visible = 0
  Ramp001.image = "LiRamp3On"
  Ramp009.image = "LiRamp4On"
  Ramp010.image = "LiRamp4On"
    Sound_GI_Relay 1, li008 'about the center of the table
    DOF 118, DOFOn
    Dim bulb
    For each bulb in aGiLights
        bulb.State = 1
    Next
End Sub

Sub GiOff

  rspin.image = "spinner_Off"
  lspin.image = "spinner2_Off"
  Ramp001.image = "LiRamp3Off"
  Ramp009.image = "LiRamp4Off"
  Ramp010.image = "LiRamp4Off"
    gilvl = 0
  ShadowGi.visible = 1
    Sound_GI_Relay 0, li008 'about the center of the table
    DOF 118, DOFOff
    Dim bulb
    For each bulb in aGiLights
        bulb.State = 0
    Next
End Sub

Sub InnLighting
  DarknessLayer.Opacity = 50
  'FireLightTimer.Enabled = 1
  ChangeGi Orange
  ChangeGIIntensity 3
    LightSeqGi.UpdateInterval = 20
    LightSeqGi.Play SeqBlinking, , 5000, 10
End Sub

Sub DisableInnLighting
  'FireLightTimer.Enabled = 0
  DarknessLayer.Opacity = DefaultDarkness
  ChangeGi OldGI
  ChangeGIIntensity 1
  LightSeqGi.StopPlay
End Sub

Sub BleedLighting
  ChangeGi Red
  ChangeGIIntensity 2
    LightSeqGi.UpdateInterval = 10
    LightSeqGi.Play SeqBlinking, , 1000, 25
End Sub

Sub DisableBleedLighting
  ChangeGi OldGI
  ChangeGIIntensity 1
  LightSeqGi.StopPlay
End Sub




' GI, light & flashers sequence effects

Sub GiEffect(n)
    Dim ii
    Select Case n
        Case 0 'all off
            LightSeqGi.Play SeqAlloff
        Case 1 'all blink
            LightSeqGi.UpdateInterval = 40
            LightSeqGi.Play SeqBlinking, , 15, 25
        Case 2 'random
            LightSeqGi.UpdateInterval = 25
            LightSeqGi.Play SeqRandom, 50, , 1000
        Case 3 'all blink fast
            LightSeqGi.UpdateInterval = 20
            LightSeqGi.Play SeqBlinking, , 10, 10
        Case 4 'seq up
            LightSeqGi.UpdateInterval = 3
            LightSeqGi.Play SeqUpOn, 25, 3
        Case 5 'seq down
            LightSeqGi.UpdateInterval = 3
            LightSeqGi.Play SeqDownOn, 25, 3
'        Case 6 'all blink long
'     ChangeGi Red
'     ChangeGIIntensity 2
 '           LightSeqGi.UpdateInterval = 10
  '          LightSeqGi.Play SeqBlinking, , 1000, 25
    End Select
End Sub

Sub LightEffect(n)

    Select Case n
        Case 0 ' all off
            LightSeqInserts.Play SeqAlloff
        Case 1 'all blink
            LightSeqInserts.UpdateInterval = 40
            LightSeqInserts.Play SeqBlinking, , 15, 25
        Case 2 'random
      if Mode(CurrentPlayer,0) = 6 or Mode(CurrentPlayer,0) > 13 then Exit Sub
            LightSeqInserts.UpdateInterval = 25
            LightSeqInserts.Play SeqRandom, 50, , 1000
        Case 3 'all blink fast
            LightSeqInserts.UpdateInterval = 20
            LightSeqInserts.Play SeqBlinking, , 10, 10
        Case 4 'center
            LightSeqInserts.UpdateInterval = 4
            LightSeqInserts.Play SeqCircleOutOn, 15, 2
        Case 5 'top down
            LightSeqInserts.UpdateInterval = 4
            LightSeqInserts.Play SeqDownOn, 15, 1
        Case 6 'down to top
            LightSeqInserts.UpdateInterval = 4
            LightSeqInserts.Play SeqUpOn, 15, 1
    End Select
End Sub


Sub AdvanceRulecard
CurrentCardIndex = CurrentCardIndex + 1
  if CurrentCardIndex > 13 Then CurrentCardIndex = 1

    Select Case CurrentCardIndex
        Case 1:TurnOffRulecards:RuleCardScreen1.visible = True
        Case 2:TurnOffRulecards:RuleCardScreen2.visible = True
        Case 3:TurnOffRulecards:RuleCardScreen3.visible = True
        Case 4:TurnOffRulecards:RuleCardScreen4.visible = True
        Case 5:TurnOffRulecards:RuleCardScreen5.visible = True
        Case 6:TurnOffRulecards:RuleCardScreen6.visible = True
        Case 7:TurnOffRulecards:RuleCardScreen7.visible = True
        Case 8:TurnOffRulecards:RuleCardScreen8.visible = True
        Case 9:TurnOffRulecards:RuleCardScreen9.visible = True
        Case 10:TurnOffRulecards:RuleCardScreen10.visible = True
        Case 11:TurnOffRulecards:RuleCardScreen11.visible = True
        Case 12:TurnOffRulecards:RuleCardScreen12.visible = True
        Case 13:TurnOffRulecards:RuleCardScreen13.visible = True
    End Select
End Sub

Sub RewindRulecard
CurrentCardIndex = CurrentCardIndex - 1
  if CurrentCardIndex < 1 Then CurrentCardIndex = 13

    Select Case CurrentCardIndex
        Case 1:TurnOffRulecards:RuleCardScreen1.visible = True
        Case 2:TurnOffRulecards:RuleCardScreen2.visible = True
        Case 3:TurnOffRulecards:RuleCardScreen3.visible = True
        Case 4:TurnOffRulecards:RuleCardScreen4.visible = True
        Case 5:TurnOffRulecards:RuleCardScreen5.visible = True
        Case 6:TurnOffRulecards:RuleCardScreen6.visible = True
        Case 7:TurnOffRulecards:RuleCardScreen7.visible = True
        Case 8:TurnOffRulecards:RuleCardScreen8.visible = True
        Case 9:TurnOffRulecards:RuleCardScreen9.visible = True
        Case 10:TurnOffRulecards:RuleCardScreen10.visible = True
        Case 11:TurnOffRulecards:RuleCardScreen11.visible = True
        Case 12:TurnOffRulecards:RuleCardScreen12.visible = True
        Case 13:TurnOffRulecards:RuleCardScreen12.visible = True
    End Select
End Sub

Sub TurnOffRulecards
  RuleCardScreen1.visible = False
  RuleCardScreen2.visible = False
  RuleCardScreen3.visible = False
  RuleCardScreen4.visible = False
  RuleCardScreen5.visible = False
  RuleCardScreen6.visible = False
  RuleCardScreen7.visible = False
  RuleCardScreen8.visible = False
  RuleCardScreen9.visible = False
  RuleCardScreen10.visible = False
  RuleCardScreen11.visible = False
  RuleCardScreen12.visible = False
  RuleCardScreen13.visible = False
End Sub

Sub SetBallsPerGame
  if Difficulty = 1 Then
    BallsPerGame = 5
  elseif Difficulty = 2 Then
    BallsPerGame = 5
  Else
    BallsPerGame = 3
  End If

End Sub
' *********************************************************************
'                        User Defined Script Events
' *********************************************************************

' Initialise the Table for a new Game
'

Sub ResetForNewGame()
Debug "**********************************************"
Debug "**      In RESET for NEW GAME   ******"
Debug "**********************************************"
    Dim i


  Debug4 "About to check if we can start scorbit session: " &bContinueGame
  if ScorbitActive = 1 And (Scorbit.bNeedsPairing) = False And bContinueGame = False Then
    Scorbit.StartSession()
  Else
    Debug4 "Not going to call Scorbit StartSession: " &ScorbitActive &":" &(Scorbit.bNeedsPairing) &":" &bContinueGame
  End If


    bGameInPLay = True

    'resets the score display, and turn off attract mode
 '   StopAttractMode
    GiOn


  'newGameBg
  ClearPlayerImages
  Debug "Calling event 900 Resetfornewgame"
  GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True '130.9
  GeneralPupQueue.Add "Pup400","pupevent 400",93,0,0,0,0,True '130.9
    TotalGamesPlayed = TotalGamesPlayed + 1
    CurrentPlayer = 1
  'pDMDStartGame
    PlayersPlayingGame = 1
    bOnTheFirstBall = True
  SetBallsPerGame
    For i = 1 To MaxPlayers
        Score(i) = 0
        'BonusPoints(i) = 0
        BonusMultiplier(i) = 1
        PlayfieldMultiplier(i) = 1
        BallsRemaining(i) = BallsPerGame
        ExtraBallsAwards(i) = 0
    Next

    ' initialise any other flags
    Tilt = 0

    ' initialise specific Game variables
Debug2 "Calling Game_Init"
    Game_Init()

    ' you may wish to start some music, play a sound, do whatever at this point
' bContinueGame = False ' turn off the continue game flag   moved in RC6
    triggerscript 1500, "FirstBall "
End Sub

' This is used to delay the start of a game to allow any attract sequence to
' complete.  When it expires it creates a ball for the player to start playing with

Sub FirstBall

    ' reset the table for a new ball
    ResetForNewPlayerBall()
  'If BallsInLock(CurrentPlayer) < 3 Then EnableBallLock '120.3
    ' create a new ball in the shooters lane
    CreateNewBall()
End Sub

' (Re-)Initialise the Table for a new ball (either a new ball after the player has
' lost one or we have moved onto the next player (if multiple are playing))

Sub ResetForNextPlayer
  'setMonsterLightColorWhite
  'Debug "Resetting BS and Gamble Counters"
  resetspinnerCounts
  ResetRampCounts
    OrbitHits = 0
    RampHits = "0/0"
    SpinnerHits = 0
  TotalMonsters(CurrentPlayer) = 0
End Sub

Sub ResetForNewPlayerBall()
    LightSeqAttract.StopPlay
  OldGI = "white"
  ChangeGI white
  setUPFLightColorWhite
  setMonsterLightColorWhite
  if bDrain = 0 Then GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True

  Debug " In Reset for New Player Ball"


    ' set the current players bonus multiplier back down to 1X
    SetBonusMultiplier 1

    ' set the playfield multiplier
    SetPlayfieldMultiplier 1

    ' reset any drop targets, lights, game Mode etc..



    'BonusPoints(CurrentPlayer) = 0
    bBonusHeld = False

    bExtraBallWonThisBall = False
  'TotalMonsters(CurrentPlayer) = 0

    ResetNewBallVariables
  if Missions(CurrentPlayer,1) <> 8  Then ' Reset Blacksmith mode
    Missions(CurrentPlayer,1) = 0
  End If
  If Missions(CurrentPlayer,2) = 1 Then ' Reset Gambler Mode
    Missions(CurrentPlayer,2) = 0
  End If
  If Missions(CurrentPlayer,3) = 1 Then ' Reset Crypt MB Mode
    Missions(CurrentPlayer,3) = 0
  End If


  mBalls2Eject = 0

    'This is a new ball, so activate the ballsaver
    bBallSaverReady = True
'debug5 "ball saver ready"

    'and the skillshot
    bSkillShotReady = True

  ' Check Party State
  CheckParty

  ClearDungeonPup2 ' make sure message is cleared -- not needed but for backup

' ClearDMDGuide ' Stop any DMD screens
' if DMDType <> 2 Then pupflasher1.visible=false:pupflasher2.visible=false: Debug "Turn off Pup 1 EOB"


  if bDrain = 0 And bDecision = False Then
    'Debug "In RFNPB  bDrain = 0"
    'ReturnToVillage
    'GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True ' Reset Backglass  '122.1
  End If

  'Debug " Reseting DMD Screen"
  if bHoldBall = False Then
    ClearDMDGuide ' Stop any DMD screens
    if DMDType <> 2 Then pupflasher1.visible=false:pupflasher2.visible=false
  End If


  DisableMagnet ' Turn off magnet

End Sub

' Create a new ball on the Playfield

Sub CreateNewBall()

    ' create a ball in the plunger lane kicker.
  if bBallinPlungerLane Then Exit Sub  ' added v 1.1

  if bOnTheFirstBall Then BallGlow DefaultBall,100,15

  BallRelease.CreateSizedBallWithMass BallSize / 2, BallMass

  BallsOnPlayfield = BallsOnPlayfield + 1
  Debug "In Create New Ball:" & BallsOnPlayfield
  UpdateBalls
    ' kick it out..
     RandomSoundBallRelease Ballrelease
    BallRelease.Kick 90, 4

  Debug "New Ball Created"
' if there is 2 or more balls then set the multibal flag (remember to check for locked balls and other balls used for animations)
' set the bAutoPlunger flag to kick the ball in play automatically
    If BallsOnPlayfield > 1 Then
      DOF 131, DOFPulse
      bMultiBallMode = 1
      if HwyMenAttrib = 1 Then
        bAutoPlunger = False
      Else
        bAutoPlunger = True
      End If
    End If
' Debug "New Ball Created 2"
    ' There is a (or another) ball on the playfield

End Sub

' Add extra balls to the table with autoplunger
' Use it as AddMultiball 4 to add 4 extra balls to the table
Sub DisplaySelection
  Debug " In Display Selection"

  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bDecision-T","bDecision = True",53,00,0,0,0,True
    debug "BDecision should be True: " & bDecision
  if DMDType = 2 Then
    GeneralPuPQueue.Add "HideDMDInfinite","HideDMDInfinite",60,0,0,0,0,False
    'ClearDMDGuide
    GeneralPuPQueue.Add "Pup890","PuPEvent 890",14,100,0,0,0,False' Display options to enter Village(LeftFlipper) or Inn(RightFlipper)
  Else
    Debug " ******  In Display Selection DMD <> 2"
    pupflasher1.visible=true
    GeneralPuPQueue.Add "Pup890","PuPEvent 890",14,100,0,0,0,False ' Display options to enter Village(LeftFlipper) or Inn(RightFlipper)
  End If
End Sub

Sub AddMultiball(nballs)
    mBalls2Eject = mBalls2Eject + nballs
    CreateMultiballTimer.Enabled = True
    'and eject the first ball
    CreateMultiballTimer_Timer
End Sub

' Eject the ball after the delay, AddMultiballDelay
Sub CreateMultiballTimer_Timer()

    ' wait if there is a ball in the plunger lane
    If bBallInPlungerLane Then
        Exit Sub
    Else
        If BallsOnPlayfield < MaxMultiballs Then
            CreateNewBall()
            mBalls2Eject = mBalls2Eject -1
            If mBalls2Eject = 0 Then 'if there are no more balls to eject then stop the timer
                CreateMultiballTimer.Enabled = False
            End If
        Else 'the max number of multiballs is reached, so stop the timer
            mBalls2Eject = 0
            CreateMultiballTimer.Enabled = False
        End If
    End If
  'Debug "Leaving CreateMultiballTimer"
End Sub

' The Player has lost his ball (there are no more balls on the playfield).
' Handle any bonus points awarded

Sub DisplayBonusMessage
' if DMDType = 2 Then
'   PuPlayer.LabelSet pDMD,"BonusMessage", BonusMessage1 ,1,""
' Else
    PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
' End If
End Sub


Sub DisplayTotalMessage
' if DMDType = 2 Then
'   PuPlayer.LabelSet pDMD,"TotalMessage", FormatNumber(MultipliedPoints,0) ,1,""
' Else
    PuPlayer.LabelSet pBackglass,"TotalMessage", FormatNumber(MultipliedPoints,0) ,1,""
' End If
End Sub

Sub HideTotalMessage
  PuPlayer.LabelSet pBackglass,"TotalMessage","" ,0,""
End Sub


Sub ClearBonusMessage
  PuPlayer.LabelSet pBackglass,"TotalMessage","",0,""
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle","",0,""
  PuPlayer.LabelSet pBackglass,"BonusMessage","",0,""
End Sub

Dim MultipliedPoints

Sub TargetBonus
  ClearBonusMessage
    AwardPoints = BonusTargets(CurrentPlayer) * 750
  MultipliedPoints = AwardPoints * BonusMultiplier(CurrentPlayer)
    TotalBonus = TotalBonus + MultipliedPoints
  Debug "TARGETS HIT " & BonusTargets(CurrentPlayer) & " Score: " & FormatNumber(AwardPoints,0)
  MessageTitle = "TARGETS : " & BonusTargets(CurrentPlayer)
  BonusMessage1 =  FormatNumber(AwardPoints,0) & " x " & BonusMultiplier(CurrentPlayer)
  EOBQueue.Add "DTM-TB","DisplayTotalMessage",80,300,0,0,0,True
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
  PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
End Sub

Sub RampBonus
  ClearBonusMessage
    AwardPoints = BonusRamps(CurrentPlayer) * 1500
  MultipliedPoints = AwardPoints * BonusMultiplier(CurrentPlayer)
    TotalBonus = TotalBonus + MultipliedPoints
  Debug "RAMPS HIT " & BonusRamps(CurrentPlayer) & " Score: " & FormatNumber(AwardPoints,0)
  MessageTitle = "RAMPS : " & BonusRamps(CurrentPlayer)
  BonusMessage1 =  FormatNumber(AwardPoints,0) & " x " & BonusMultiplier(CurrentPlayer)
  EOBQueue.Add "DTM-RB","DisplayTotalMessage",80,300,0,0,0,True
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
  PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
End Sub

Sub SpinnerBonus
  ClearBonusMessage
    AwardPoints = SpinnerHits * 500
  MultipliedPoints = AwardPoints
    TotalBonus = TotalBonus + AwardPoints
  Debug "SPINNERS HIT " & SpinnerHits & " Score: " & FormatNumber(AwardPoints,0)
  MessageTitle = "SPINNERS : " & SpinnerHits
  BonusMessage1 =  FormatNumber(AwardPoints,0) & " x " & BonusMultiplier(CurrentPlayer)
  EOBQueue.Add "DTM-SB","DisplayTotalMessage",80,300,0,0,0,True
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
  PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
End Sub

Sub OrbitBonus
  ClearBonusMessage
    AwardPoints = OrbitHits * 2500
  MultipliedPoints = AwardPoints * BonusMultiplier(CurrentPlayer)
    TotalBonus = TotalBonus + MultipliedPoints
  Debug "ORBITS HIT " & OrbitHits & " Score: " & FormatNumber(AwardPoints,0)
  MessageTitle = "ORBITS : " & OrbitHits
  BonusMessage1 =  FormatNumber(AwardPoints,0) & " x " & BonusMultiplier(CurrentPlayer)
  EOBQueue.Add "DTM-OB","DisplayTotalMessage",80,300,0,0,0,True
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
  PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
End Sub

Sub MD_Bonus
  ClearBonusMessage
    AwardPoints = TotalMonsters(CurrentPlayer) * 5000
  MultipliedPoints = AwardPoints * BonusMultiplier(CurrentPlayer)
    TotalBonus = TotalBonus + MultipliedPoints
  Debug "MONSTERS " & TotalMonsters(CurrentPlayer) & " Score: " & FormatNumber(AwardPoints,0)
  MessageTitle = "MONSTERS : " & TotalMonsters(CurrentPlayer)
  BonusMessage1 =  FormatNumber(AwardPoints,0) & " x " & BonusMultiplier(CurrentPlayer)
  EOBQueue.Add "DTM-MD","DisplayTotalMessage",80,300,0,0,0,True
  'DisplayTotalMessage
' if DMDType = 2 Then
'   PuPlayer.LabelSet pDMD,"BonusMessageTitle", MessageTitle ,1,""
'   PuPlayer.LabelSet pDMD,"BonusMessage", BonusMessage1 ,1,""
' Else
'   Debug " DMDTYPE1 MD Bonus"
    PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
    PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
' End If
End Sub

Sub DC_Bonus
  ClearBonusMessage
    AwardPoints = DungeonsCleared(CurrentPlayer) * 50000
  MultipliedPoints = AwardPoints
    TotalBonus = TotalBonus + AwardPoints
  Debug "DUNGEONS " & DungeonsCleared(CurrentPlayer) & " Score: " & FormatNumber(AwardPoints,0)
  MessageTitle = "DUNGEONS : " & DungeonsCleared(CurrentPlayer)
  BonusMessage1 =  FormatNumber(AwardPoints,0)
  EOBQueue.Add "DTM-DC","DisplayTotalMessage",80,300,0,0,0,True
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
  PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
End Sub


Sub BD_Bonus
  ClearBonusMessage
    AwardPoints = GoldSack(CurrentPlayer) * 30000
  MultipliedPoints = AwardPoints
    TotalBonus = TotalBonus + AwardPoints
  Debug "BOSSES " & GoldSack(CurrentPlayer) & " Score: " & FormatNumber(AwardPoints,0)
  MessageTitle = "BOSSES: " & GoldSack(CurrentPlayer)
  BonusMessage1 =  FormatNumber(AwardPoints,0)
  EOBQueue.Add "DTM-BD","DisplayTotalMessage",80,300,0,0,0,True
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
  PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
End Sub

Sub Total_Bonus
  ClearBonusMessage
  'TotalBonus = TotalBonus * BonusMultiplier(CurrentPlayer)
  MultipliedPoints = TotalBonus
    AddScore2 TotalBonus  ' add all the bonus points to the scoe
  Debug "TOTAL BONUS " & FormatNumber(TotalBonus,0)
  MessageTitle = "TOTAL BONUS"
  BonusMessage1 =  FormatNumber(TotalBonus,0)
  EOBQueue.Add "DTM-TotB","DisplayTotalMessage",80,300,0,0,0,True
  PuPlayer.LabelSet pBackglass,"BonusMessageTitle", MessageTitle ,1,""
  PuPlayer.LabelSet pBackglass,"BonusMessage", BonusMessage1 ,1,""
End Sub

Sub FillParty
  if PartySize(CurrentPlayer) < 4 Then AddPartyMember
  if PartySize(CurrentPlayer) < 4 Then AddPartyMember
  if PartySize(CurrentPlayer) < 4 Then AddPartyMember
  if PartySize(CurrentPlayer) < 4 Then AddPartyMember

  CheckItems
  If ItemCount < 5 Then AddItem
  If ItemCount < 5 Then AddItem
  If ItemCount < 5 Then AddItem
  If ItemCount < 5 Then AddItem
  If ItemCount < 5 Then AddItem


End Sub

Sub EndOfBall
  'BattleQueue.RemoveAll(True)' Clear out battle queue
  GeneralPupQueue.Add "BattleQueue-RemoveAll","BattleQueue.RemoveAll(True)",93,0,0,0,0,True
  Debug2 "EOB Start"
  bInn = False



  GetAM
  'ModeFail    ' called during drain_hit
  if AMState < 2 Then
    Debug "Calling StopMode:" &ActiveMode
    StopMode(ActiveMode)
  End If

  Torchtimer.enabled = 0 ' stop the torch timer
  ResetTorches
  HeroCountDownOriginal

  HeroCountDownTimer.enabled = 0
  Pulse.enabled = 0

' if ActiveMode > 13 Then
'   Debug2 "Calling ModeFail"
'   ModeFail "EOB"
' Else
    Debug "SHOULD BE EOB BONUS SCREEN"
    EOBHide "EOB"
    BallHandlingQueue.Add "Pup311","PuPEvent 311",80,0,0,0,0,True ' EOB BG screen
    EOBQueue.Add "EOBReturn-EOB","EOBReturn ""EOBScreen"" ",77,12200,0,0,0,True

    if DMDType = 0 Then
      'bSupressBGMessages = True
      EOBQueue.Add "HideBG2","HideBG2 12200",77,0,0,0,0,True
    End If
' End If

    Dim ii
    AwardPoints = 0
    TotalBonus = 10 'yes 10 points :)
    ' the first ball has been lost. From this point on no new players can join in
    bOnTheFirstBall = False

    ' only process any of this if the table is not tilted.
    '(the tilt recovery mechanism will handle any extra balls or end of game)

    If NOT Tilted Then
    'StopSong "mu_hyrda"
        'PlaySong "mu_plunger"
        'Count the bonus. This table uses several bonus
'        DMD CL("BONUS"), "", "", eNone, eNone, eNone, 750, True, ""

    InBattle = 0  ' added 114.1 attempt to prevent attributes and ambush from occuring after lost ball
  ' Display all the bonus info
    Debug2 "Starting Bonus Run"
'   if ActiveMode < 14 Then
      'HideDMDInfinite

      bEOBSupress = True
'RTP10
'     TargetBonus
      TotalBonus = 10
      EOBQueue.Add "Line0a","Playsound ""di_sword3"" ",20,0,0,0,0,False
      EOBQueue.Add "Line1","TargetBonus",20,1,0,0,0,False
      EOBQueue.Add "Line1a","Playsound ""di_sword2"" ",20,1700,0,0,0,True
      EOBQueue.Add "Line1b","LightEffect 5",20,1700,0,0,0,False
      EOBQueue.Add "Line2","RampBonus",20,1800,0,0,0,False
      EOBQueue.Add "Line2a","Playsound ""di_sword3"" ",20,3500,0,0,0,True
      EOBQueue.Add "Line2b","LightEffect 6",20,3500,0,0,0,False
      EOBQueue.Add "Line3","SpinnerBonus",20,3600,0,0,0,False
      EOBQueue.Add "Line3a","Playsound ""di_sword2"" ",20,5300,0,0,0,True
      EOBQueue.Add "Line3b","LightEffect 5",20,5300,0,0,0,False
      EOBQueue.Add "Line4","MD_Bonus",20,5400,0,0,0,False
      EOBQueue.Add "Line4a","Playsound ""di_sword3"" ",20,7100,0,0,0,True
      EOBQueue.Add "Line4b","LightEffect 6",20,7100,0,0,0,False
      EOBQueue.Add "Line5","Total_Bonus",20,7200,0,0,0,False
      EOBQueue.Add "Line6","ClearBonusMessage",20,9000,0,0,0,False
      EOBQueue.Add "Line7","HideTotalMessage",20,9000,0,0,0,False
      EOBQueue.Add "Line8","pupevent 400:bDrain = 0",20,9000,0,0,0,False
      EOBQueue.Add "Line9","bEOBSupress = False",20,9050,0,0,0,False
      EOBQueue.Add "Line10","EOBReturn DRAIN",20,9100,0,0,0,False
      EOBQueue.Add "Line11","if PartySize(CurrentPlayer) = 0 Then UpdateDMD",20,9150,0,0,0,False
      EOBQueue.Add "Line12","EndOfBall2",40,1500,0,0,0,False


    Debug2 "EOB Balls Remain: "&BallsRemaining(CurrentPlayer)

'   Else ' else of if activemode < 14
'     EOBQueue.Add "Line12","EndOfBall2",40,500,0,0,0,False
'   End If
    Else 'if tilted then only add a short delay and move to the 2nd part of the end of the ball
        EOBQueue.Add "Line12","EndOfBall2",40,500,0,0,0,False
    End If
End Sub

' The Timer which delays the machine to allow any bonus points to be added up
' has expired.  Check to see if there are any extra balls for this player.
' if not, then check to see if this was the last ball (of the CurrentPlayer)
'
Sub EndOfBall2()
PuPHideBattle "EOB2"  ' make sure everything is hidden

Debug2 "Starting EOB2"
    ' if were tilted, reset the internal tilted flag (this will also
    ' set TiltWarnings back to zero) which is useful if we are changing player LOL
    Tilt = 0
    DisableTable False 'enable again bumpers and slingshots

    ' has the player won an extra-ball ? (might be multiple outstanding)
    If ExtraBallsAwards(CurrentPlayer) > 0 Then
        'debug3 "Extra Ball"

        ' yep got to give it to them
        ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer)- 1

        ' if no more EB's then turn off any Extra Ball light if there was any
        If(ExtraBallsAwards(CurrentPlayer) = 0)Then
            LightShootAgain.State = 0
        End If

        ' You may wish to do a bit of a song AND dance at this point
'        DMD CL("EXTRA BALL"), CL("SHOOT AGAIN"), "", eNone, eBlink, eNone, 1500, True, "vo_live_again"
    Debug2 "ExtraBall -  Balls Remain: "&BallsRemaining(CurrentPlayer)
        ' In this table an extra ball will have the skillshot and ball saver, so we reset the playfield for the new ball
'   if DMDType = 2 Then
'   ResetForNewPlayerBall()  'MERLIN RTP -- Not sure we want to comment this line out
'   Else
'     triggerscript 50, "ResetForNewPlayerBall()"
'   End If
    Debug2 "EOB2 - Combo: " &AMCombo
        ' Create a new ball in the shooters lane
    if ActiveMode < 15 Then
      if bDungeonsCleared = True Then
        ' we want to create a ball and go right back into wizard lock mode
        ActiveMode = 9 ' change for case-else statement below
        'EOBQueue.Add "FillParty","FillParty",20,10150,0,0,0,False
      End If

      if AMState = 2 Then
        Debug2 "****************  AMState = 2"
        Select Case ActiveMode
          Case 2,4,6,8,10,11,12,13:
            Debug2 " Staying in Mode: " &ActiveMode
          ' display return to center scoop message, turn on quest Light
            li038.state = 2  ' turn on quest light
            DungeonTimerMessage2 = "Return to Center Scoop"
            triggerscript 12200, "DisplayGuide2"  ' has to be called after EOB bonus is finished  'RTP8
            CreateNewBall()
          Case 1,3,5,7:
            StartNextMode
            Debug2 " Staying in Mode: " &ActiveMode
            li038.state = 2  ' turn on quest light
            CreateNewBall()
          Case 9:
            EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10200,0,0,0,False
          Case Else:
            ContinueMode ActiveMode
            Debug2 " Staying in Mode: ELSE-" &ActiveMode
            msbbox "ERROR: -4 DRAINHIT"
            CreateNewBall()
        End Select
      Elseif AMState <> 2 And PartySize(CurrentPlayer) > 0 Then
        Debug2 "**************  ExtraBall A  "& PartySize(CurrentPlayer)  &"-" &  AMCombo
        if bDungeonsCleared = True Then
          ' we want to create a ball and go right back into wizard lock mode
          EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10800,0,0,0,False
        Else
          DisplaySelection
        End If
        ' new ball is created once a selection is made
      Elseif PartySize(CurrentPlayer) = 0 Then
        if bDungeonsCleared = True Then
          ' we want to create a ball and go right back into wizard lock mode
          EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10800,0,0,0,False
        Else
          BallHandlingQueue.Add "ResetModes","ResetModes",80,0,0,0,0,False
          BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,0,0,0,0,False
          BallHandlingQueue.Add "CreateNewBall","CreateNewBall",60,0,0,0,0,False
        End If
      Else ' AM state 0 or 1 and all party members still alive
        Debug2 "**************  ExtraBall B  "& PartySize(CurrentPlayer)  &"-" &  AMCombo
        ' Determine where the player is headed to next  -- AMState = 1 or 3
        Debug5 "EOB-Else-Case: " &ActiveMode
        Select Case ActiveMode
          Case 0:
            BallHandlingQueue.Add "CreateNewBall","CreateNewBall",60,0,0,0,0,False
          Case 1,3,5,7:
            Debug "Restarting Mode: " &ActiveMode
            StartMode ActiveMode
            BallHandlingQueue.Add "CreateNewBall","CreateNewBall",60,0,0,0,0,False
            li038.state = 2 ' turn on Quest light
          Case 2,4,6,8:
            Mode(CurrentPlayer,ActiveMode-1) = 1
            StartMode ActiveMode-1
            Debug "Restarting Mode: " &ActiveMode-1
            li047.state = 2
            BallHandlingQueue.Add "CreateNewBall","CreateNewBall",60,0,0,0,0,False
          Case 10,11,12,13:
            ResetMonsters
            CreateMonsterString
              li047.state = 2
            if DMDType <> 2 Then pupflasher1.visible=false
            if PartySize(CurrentPlayer) > 3 Then
              li038.state = 2
            Else
              'li047.state = 2
            End If

            if Mode(Currentplayer,2) < 2 Then
              Mode(CurrentPlayer,0) = 1
              Mode(Currentplayer,1) = 2
            Elseif Mode(Currentplayer,4) < 2 Then
              Mode(CurrentPlayer,0) = 3
              Mode(Currentplayer,3) = 2
            Elseif Mode(Currentplayer,6) < 2 Then
              Mode(CurrentPlayer,0) = 5
              Mode(Currentplayer,5) = 2
            Elseif Mode(Currentplayer,8) < 2 Then
              Mode(CurrentPlayer,0) = 7
              Mode(Currentplayer,7) = 2
            Else
              li038.state = 0 ' party is full so turn on quest light
              StartMode 9
            End If
            CreateNewBall()
          Case 9:
            EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10800,0,0,0,False
          Case else:
            Debug2 "Restarting Mode: ELSE-" &ActiveMode
            MsgBox "Error: -1 Mode: " &ActiveMode
            'StartMode ActiveMode
            CreateNewBall
        End Select
      End If '<AMSTATE = 2?>
    Else ' else activemode < 15
        ' ActiveMode is 15 -- shouldnt we end the game ????
      Debug "--------------- THIS SHOULD PRINT -----------"
''      StartNextMode   ' 2.2J
''      CreateNewBall()  ' 2.2J
      EndOfGame()     ' 2.2J
      Exit Sub  '2.2J
    End If

'   EOBQueue.Add "ResetForNewPlayerBall","ResetForNewPlayerBall()",20,12100,0,0,0,False
'   triggerscript 200,"ResetForNewPlayerBall()"  'MERLIN RTP -- Not sure we want to comment this line out

    Else ' no extra balls
    Debug "$$$$$$   No extraballs"
    If Mode(CurrentPlayer,0) = 15 Then
      EndofGame  ' Call the end of the game
    Else

      BallsRemaining(CurrentPlayer) = BallsRemaining(CurrentPlayer) - 1
      'Debug "EOB2 Balls Remain: "&BallsRemaining(CurrentPlayer)
      ' was that the last ball ?
      If(BallsRemaining(CurrentPlayer) < 1)Then
        ' debug3 "No More Balls, High Score Entry"
        ' Submit the CurrentPlayers score to the High Score system
  '****************************************************************************
  '***************************************************************************
        'CheckHighScore() ' RTP NEED TO ADD THIS BACK
        ' you may wish to play some music at this point
        if Mode(CurrentPlayer,0) = 14 Then ' Keep the game going so they can get to Wizard mode
          AddMultiball 1
          'EndOfBallComplete()
        Else
          Debug2 " SHOULD I BE HERE"
          EndOfBallComplete()  ' This will come out once high scores routines are updated
        End If
  '****************************************************************************
  '***************************************************************************

      Else
        Debug "###### AM Combo: " &AMCombo
        ' not the last ball (for that player)
        ' if multiple players are playing then move onto the next one
        EndOfBallComplete()
      End If ' ballsremaining
    End If ' active mode 15
  End If ' if extraballs
End Sub

' This function is called when the end of bonus display
' (or high score entry finished) AND it either end the game or
' move onto the next player (or the next ball of the same player)
'
Sub EndOfBallComplete()
  TrapdoorDown  ' make sure trapdoor is down
  'if DMDType = 0 Then
  ' bSupressBGMessages = True
  ' EOBQueue.Add "bSupressBGMessages-F","bSupressBGMessages = False",20,8050,0,0,0,False
  'End If

  HeroCountDownTimer.enabled = 0 ' make absoutely sure this stopped
  Pulse.enabled = 0
  bBallSaverReady = True
  'Debug5 "setting ball saver NOW"
'ModeFail

    Dim NextPlayer
  Debug "End of Complete - Balls Remain: "&BallsRemaining(CurrentPlayer)
    'debug3 "EndOfBall - Complete"

    ' are there multiple players playing this game ?
    If(PlayersPlayingGame > 1)Then
        ' then move to the next player
        NextPlayer = CurrentPlayer + 1
    Debug "Current Player: " & CurrentPlayer
    ResetForNextPlayer
        ' are we going from the last player back to the first
        ' (ie say from player 4 back to player 1)
        If(NextPlayer > PlayersPlayingGame)Then
            NextPlayer = 1
        End If
    Else
        NextPlayer = CurrentPlayer
    End If

    'debug3 "Next Player = " & NextPlayer

    ' is it the end of the game ? (all balls been lost for all players)
'    If((BallsRemaining(CurrentPlayer) <= 0)AND(BallsRemaining(NextPlayer) <= 0))Then

  If BallsRemaining(CurrentPlayer) < 1 Then
        ' you may wish to do some sort of Point Match free game award here
        ' generally only done when not in free play mode
    Debug "Should be End of Game "&BallsRemaining(CurrentPlayer)
        ' set the machine into game over mode
        EndOfGame()
    Else

' RTP8
  Debug " Not end of game: " &BallsRemaining(CurrentPlayer)


  Debug "EOB Complete - Combo: " &AMCombo
    if ActiveMode < 15 Then
      if bDungeonsCleared = True Then
        ' we want to create a ball and go right back into wizard lock mode
        ActiveMode = 9 ' change for case-else statement below
        'EOBQueue.Add "FillParty","FillParty",20,10150,0,0,0,False
      End If

      if AMState = 2 Then
        Debug "****************  AMState = 2"
        Select Case ActiveMode
          Case 2,4,6,8,10,11,12,13:
            Debug " Staying in Mode: " &ActiveMode
          ' display return to center scoop message, turn on quest Light
            li038.state = 2  ' turn on quest light
            DungeonTimerMessage2 = "Return to Center Scoop"
            triggerscript 12200, "DisplayGuide2"  ' has to be called after EOB bonus is finished  'RTP8
            CreateNewBall()
          Case 1,3,5,7:
            StartNextMode
            Debug " Staying in Mode: " &ActiveMode
            li038.state = 2  ' turn on quest light
            CreateNewBall()
          Case 9:
            EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10800,0,0,0,False
          Case Else:
            'ContinueMode ActiveMode
            Debug " Staying in Mode: ELSE-" &ActiveMode
            'msbbox "ERROR: -4 DRAINHIT"
            CreateNewBall()
        End Select
      Elseif AMState <> 2 And PartySize(CurrentPlayer) > 0 Then
        Debug2 "&**************  ExtraBall A  "& PartySize(CurrentPlayer)  &"-" &  AMCombo
        if bDungeonsCleared = True Then
          ' we want to create a ball and go right back into wizard lock mode
          EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10800,0,0,0,False
        Else
          DisplaySelection
        End If

        ' new ball is created once a selection is made
      Elseif PartySize(CurrentPlayer) = 0 Then
        if bDungeonsCleared = True Then
          ' we want to create a ball and go right back into wizard lock mode
          EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10800,0,0,0,False
        Else
          BallHandlingQueue.Add "ResetModes","ResetModes",80,0,0,0,0,False
          BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,0,0,0,0,False
          BallHandlingQueue.Add "CreateNewBall","CreateNewBall",60,0,0,0,0,False
        End If
      Else ' AM state 0 or 1 and all party members still alive
        Debug "**************  ExtraBall B  "& PartySize(CurrentPlayer)  &"-" &  AMCombo
        ' Determine where the player is headed to next  -- AMState = 1 or 3
        Select Case ActiveMode
          Case 0:
            CreateNewBall
          Case 1,3,5,7:
            Debug "Restarting Mode: " &ActiveMode
            StartMode ActiveMode
            CreateNewBall
            li038.state = 2 ' turn on Quest light
          Case 2,4,6,8:
            Mode(CurrentPlayer,ActiveMode-1) = 1
            StartMode ActiveMode-1
            Debug "Restarting Mode: " &ActiveMode-1
            li047.state = 2
            CreateNewBall
          Case 10,11,12,13:
            ResetMonsters
            CreateMonsterString
            li047.state = 2
            if DMDType <> 2 Then pupflasher1.visible=false
            if PartySize(CurrentPlayer) > 3 Then
              li038.state = 2
            Else
              'li047.state = 2
            End If

            if Mode(Currentplayer,2) < 2 Then
              Mode(CurrentPlayer,0) = 1
              Mode(Currentplayer,1) = 2
            Elseif Mode(Currentplayer,4) < 2 Then
              Mode(CurrentPlayer,0) = 3
              Mode(Currentplayer,3) = 2
            Elseif Mode(Currentplayer,6) < 2 Then
              Mode(CurrentPlayer,0) = 5
              Mode(Currentplayer,5) = 2
            Elseif Mode(Currentplayer,8) < 2 Then
              Mode(CurrentPlayer,0) = 7
              Mode(Currentplayer,7) = 2
            Else
              li038.state = 0 ' party is full so turn on quest light
              StartMode 9
            End If

            CreateNewBall()
          Case 9:
            EOBQueue.Add "WizardPrep","ReturnWizPrep",20,10800,0,0,0,False
          Case else:
            Debug "Restarting Mode: ELSE-" &ActiveMode
            MsgBox "EOB Error: -1 Mode: " &ActiveMode
            'StartMode ActiveMode
            CreateNewBall
        End Select
      End If '<AMSTATE = 2?>
    Else ' else activemode < 15
        ' ActiveMode is 15 -- shouldnt we end the game ????
      Debug "--------------- THIS SHOULD PRINT -----------"
''      StartNextMode   ' 2.2J
''      CreateNewBall()  ' 2.2J
      EndOfGame()     ' 2.2J
      Exit Sub  '2.2J
    End If
    EOBQueue.Add "ResetForNewPlayerBall","ResetForNewPlayerBall()",20,10100,0,0,0,False  ' delay so EOB sequence can complete
    'ResetForNewPlayerBall()  ' has to go at the end
    End If ' end if balls remaing <= 0

'triggerscript 2000, "bDrain = 0" ' RTP10
End Sub


' This function is called when the end of bonus display
' (or high score entry finished) AND it either end the game or
' move onto the next player (or the next ball of the same player)
'

' This function is called at the End of the Game, it should reset all
' Drop targets, AND eject any 'held' balls, start any attract sequences etc..

Sub EndOfGame()

  bEndofGame = True

Debug " In end of game routine"
  if Missions(CurrentPlayer,1) > 0 Then ClearBlacksmithPup
  if Missions(CurrentPlayer,2) > 0 Then ClearCountDownPup
  if Missions(CurrentPlayer,3) = 1 OR Missions(CurrentPlayer,3) = 2 Then ClearTorchPup

  ClearAll
  InGuide = 1

    bGameInPlay = False

    SolLFlipper 0
    SolRFlipper 0
  SolULFlipper 0
  SolURFlipper 0

  Debug " **** Calling Finale  ****"
  finale
  'triggerscript 3000, "Finale "
  triggerscript 8000, "GameReady = 1:Debug ""TESTING"""  ' make sure the eob routine finishes before they can start a new game, otherwise screens get messed up

    GiOff
    '''StartAttractMode
' you may wish to light any Game Over Light you may have


End Sub

Sub Finale
  DOFModesOff
  bEndOfGame = True
  'EOBHide "Finale"
  HideTotalMessage
  ClearBonusMessage
  'HideFinalScore
  Debug2 "in finale"
  BallHandlingQueue.Add "EOBHide-Finale","EOBHide ""Finale""",70,7800,0,0,0,True
  BallHandlingQueue.Add "DisplayGameOver","DisplayGameOver",70,7850,0,0,0,True
End Sub

Sub DisplayGameOver
  HideTotalMessage 'make sure its cleared
  ClearBonusMessage 'make sure its cleared
  goSelection = RndNbr(5)
  'goselection = 2
  Debug2 "GOSelection: " & goSelection
  'PuPEvent 200 ' clear EOB Screen
  BallHandlingQueue.Add "GameOverAudio","GameOverAudio",70,1000,0,0,0,True
  Select Case goSelection
    Case 1:
      Debug " Calling pupevent 751"
      GeneralPuPQueue.Add "Pup751","PuPEvent 751",85,0,0,0,0,True
      BallHandlingQueue.Add "GoldSackCheck","GoldSackCheck",70,8860,0,0,0,True
      'triggerscript 8860, "GoldSackCheck "
    Case 2:
      Debug " Calling pupevent 752"
      GeneralPuPQueue.Add "Pup752","PuPEvent 752",85,0,0,0,0,True
      BallHandlingQueue.Add "GoldSackCheck","GoldSackCheck",70,6939,0,0,0,True
      'triggerscript 6939, "GoldSackCheck "
    Case 3:
      Debug " Calling pupevent 753"
      GeneralPuPQueue.Add "Pup753","PuPEvent 753",85,0,0,0,0,True
      'triggerscript 5574, "GoldSackCheck "
      BallHandlingQueue.Add "GoldSackCheck","GoldSackCheck",70,5574,0,0,0,True
    Case 4:
      Debug " Calling pupevent 754"
      GeneralPuPQueue.Add "Pup754","PuPEvent 754",85,0,0,0,0,True
      BallHandlingQueue.Add "GoldSackCheck","GoldSackCheck",70,7515,0,0,0,True
      'triggerscript 7515, "GoldSackCheck "
    Case 5:
      Debug " Calling pupevent 755"
      GeneralPuPQueue.Add "Pup755","PuPEvent 755",85,0,0,0,0,True
      BallHandlingQueue.Add "GoldSackCheck","GoldSackCheck",70,8472,0,0,0,True
      'triggerscript 8472, "GoldSackCheck "
  End Select

End Sub

Sub GameOverAudio
AudioQueue.Add "Pup431","PuPEvent 431",89,0,0,0,0,False
End Sub

Sub GoldSackCheck
  HideHelper ' make sure helper message is hidden
  Debug "in GoldSackcheck: " &goSelection
  'triggerscript 1000, "PuPevent 300"

  if GoldSack(CurrentPlayer) > 0 Then
  Debug "got here TG: " &goSelection
    Select Case goSelection
      case 1:
        bContinueScreen = True
        GeneralPuPQueue.Add "DisplayContinueMessage","DisplayContinueMessage",84,3050,0,0,0,True
        GeneralPuPQueue.Add "Pup761","PuPEvent 761",85,8000,0,0,0,True
      case 2:
        bContinueScreen = True
        GeneralPuPQueue.Add "DisplayContinueMessage","DisplayContinueMessage",84,1050,0,0,0,True
        GeneralPuPQueue.Add "Pup762","PuPEvent 762",85,6000,0,0,0,True
      case 3:
        bContinueScreen = True
        GeneralPuPQueue.Add "DisplayContinueMessage","DisplayContinueMessage",84,50,0,0,0,True
        GeneralPuPQueue.Add "Pup763","PuPEvent 763",85,5000,0,0,0,True
      case 4:
        bContinueScreen = True
        GeneralPuPQueue.Add "DisplayContinueMessage","DisplayContinueMessage",84,2050,0,0,0,True
        GeneralPuPQueue.Add "Pup764","PuPEvent 764",85,7000,0,0,0,True
      case 5:
        bContinueScreen = True
        GeneralPuPQueue.Add "DisplayContinueMessage","DisplayContinueMessage",84,3050,0,0,0,True
        GeneralPuPQueue.Add "Pup765","PuPEvent 765",85,8000,0,0,0,True
    End Select

  Else
    Debug "TGC = 0:: Should be displaying final score"
    'DisplayFinalScoreDMD
    DisplayFinalScore
    CheckHighScore()
    'triggerscript 3000, "StopScorbit"
    StopScorbit
    'DisplayGameOver
  End If
End Sub

Sub ClearAll
  ClearDMDGuide
  if DMDType <> 2 Then pupflasher1.visible=false:pupflasher2.visible=false:Debug "Turn off Pup 1 ClearAll"

  PuPHideBattle "ClearAll"
  ClearCountDownPup
  ClearDungeonPup
  ClearDungeonPup2
  ClearExtraball
  ClearGuideMessages
  ClearKickback
  HideBleed
End Sub

'this calculates the ball number in play
Function Balls
    Dim tmp
    tmp = BallsPerGame - BallsRemaining(CurrentPlayer) + 1
    If tmp > BallsPerGame Then
        Balls = BallsPerGame
    Else
        Balls = tmp
    End If
End Function

Sub GetAM ' gets the active mode and stores in variables ActiveMode
  ActiveMode = Mode(CurrentPlayer,0)
' if ActiveMode > CurrMode(CurrentPlayer) Then CurrMode(CurrentPlayer) = ActiveMode   'Update Highest Mode Achieved
  AMState = Mode(CurrentPlayer,ActiveMode)
  AMCombo = ActiveMode&":"&AMState
End Sub


Sub StartNextMode
'GetAM

Debug  "In Start Next Mode"

if bMaxParty = True And bBossDefeatedFullParty = False Then
  ContinueMode LastMode
  Exit Sub
End If

if bRetry = True And bBossDefeatedFullParty = False Then
  ContinueMode LastMode
  Exit Sub
End If


    If Mode(CurrentPlayer,1) <> 2 Then ' Check if Mode 1 was completed yet
    'pNote "STARTING", " MODE 1"
    Debug " Starting Mode 1"
    StartMode 1
    ElseIf Mode(CurrentPlayer,2) <> 3 Then
    if PartySize(CurrentPlayer) > 3 Then
    Debug " Starting Mode 2"
      StartMode 2
    Else
    Debug " Starting Mode 1"
      StartMode 1
    End If
    ElseIf Mode(CurrentPlayer,3) <> 2 Then
    Debug " Starting Mode 3"
        'StartMode 3
    StartMode 3
    ElseIf Mode(CurrentPlayer,4) <> 3 Then
    if PartySize(CurrentPlayer) > 3 Then
    Debug " Starting Mode 4"
      StartMode 4
    Else
    Debug " Starting Mode 3"
      StartMode 3
    End If
    ElseIf Mode(CurrentPlayer,5) <> 2 Then
    Debug " Starting Mode 5"
    StartMode 5
    ElseIf Mode(CurrentPlayer,6) <> 3 Then
    if PartySize(CurrentPlayer) > 3 Then
    Debug " Starting Mode 6"
      StartMode 6
    Else
    Debug " Starting Mode 5"
      StartMode 5
    End If
    ElseIf Mode(CurrentPlayer,7) <> 2 Then
    Debug " Starting Mode 7"
        'StartMode 7
    StartMode 7
    ElseIf Mode(CurrentPlayer,8) <> 3 Then
    if PartySize(CurrentPlayer) > 3 Then
    Debug " Starting Mode 8"
      StartMode 8
    Else
    Debug " Starting Mode 7"
      StartMode 7
    End If
    ElseIf Mode(CurrentPlayer,9) <> 2 Then
    Debug " Starting Mode 9"
    if PartySize(CurrentPlayer) > 3 Then
    Debug " Starting Mode 9"
      StartMode 9
    Else
    Debug " Starting Mode 7"
      StartMode 7
    End If
  Else
    MsgBox "SNM: Guess we do need this code"
    Debug " Starting Mode ELSE"
      if PartySize(CurrentPlayer) < 4 Then
        li047.state = 2
        if Mode(Currentplayer,2) < 2 Then
          'Mode(CurrentPlayer,0) = 1
          'Mode(Currentplayer,1) = 2
          StartMode 1
        Elseif Mode(Currentplayer,4) < 2 Then
          'Mode(CurrentPlayer,0) = 3
          'Mode(Currentplayer,3) = 2
          StartMode 3
        Elseif Mode(Currentplayer,6) < 2 Then
          'Mode(CurrentPlayer,0) = 5
          'Mode(Currentplayer,5) = 2
          StartMode 5
        Elseif Mode(Currentplayer,8) < 2 Then
          'Mode(CurrentPlayer,0) = 7
          'Mode(Currentplayer,7) = 2
          StartMode 7
        Else
          li038.state = 0
          StartMode 9
        End If
      Else
        li038.state = 2
        if Mode(Currentplayer,2) < 2 Then
          Mode(CurrentPlayer,0) = 1
          Mode(Currentplayer,1) = 2
          'StartMode 1
        Elseif Mode(Currentplayer,4) < 2 Then
          Mode(CurrentPlayer,0) = 3
          Mode(Currentplayer,3) = 2
          'StartMode 3
        Elseif Mode(Currentplayer,6) < 2 Then
          Mode(CurrentPlayer,0) = 5
          Mode(Currentplayer,5) = 2
          'StartMode 5
        Elseif Mode(Currentplayer,8) < 2 Then
          Mode(CurrentPlayer,0) = 7
          Mode(Currentplayer,7) = 2
          'StartMode 7
        Else
          li038.state = 0 ' party is full so turn on quest light
          StartMode 9
        End If
      End If
    End If


End Sub

'===================================================
Dim CMode
Sub ContinueMode (LeavingMode)
'getAM
CMode = LeavingMode
Mode(CurrentPlayer,0) = CMode ' make sure the mode is still the last mode
BallHandlingQueue.Add "EOBReturn-Cont","EOBReturn ""ContinueMode""",70,5000,0,0,0,True
'triggerscript 5000, "EOBReturn ""ContinueMode"" "
'CMode = LastMode
Debug "In ContinueMode: " &CMode
  if bInn = True Then
    Select Case CMode
      Case 0,1,3,5,7:
        if PartySize(CurrentPlayer) < 4 Then
          SetPartyLights
        End If
      Case Else:
        ' Do nothing
    End Select
  Elseif bVillage = True Then
    li047.state = 2
  End If


  Select Case CMode
    Case 0:
      Debug "Hmm, in Mode 0"
      StartMode 1
    Case 1:
      StartMode 1
    Case 2:
      If Mode(CurrentPlayer,2) = 3 Then
        li038.state = 2 ' turn on quest light
        DisplayGuide2
        StartMode 2
      Elseif PartySize(CurrentPlayer) > 3 Then
        li038.state = 2
  '     Debug "Continue Mode: " &LastMode
        StartMode 1
      elseif PartySize(CurrentPlayer) < 4 Then
        AudioQueue.Add "Pup232","PuPEvent 232",20,0,0,0,AudioExpiry,False
        Debug "bDecision less than 4 members: " &LastMode
        GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
        li047.state = 2
        if DMDType <> 2 Then pupflasher1.visible=true
        StartMode 1
      End If
    Case 3:
      StartMode 3
    Case 4:
      If Mode(CurrentPlayer,4) = 3 Then
        li038.state = 2 ' turn on quest light
        DisplayGuide2
        StartMode 4
      Elseif PartySize(CurrentPlayer) > 3 Then
        li038.state = 2
  '     Debug "Continue Mode: " &LastMode
        StartMode 3
      elseif PartySize(CurrentPlayer) < 4 Then
        AudioQueue.Add "Pup232","PuPEvent 232",20,0,0,0,AudioExpiry,False
        Debug "bDecision less than 4 members: " &LastMode
        GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
        li047.state = 2
        if DMDType <> 2 Then pupflasher1.visible=true
        StartMode 3
      End If
    Case 5:
      StartMode 5
    Case 6:
      If Mode(CurrentPlayer,6) = 3 Then
        li038.state = 2 ' turn on quest light
        DisplayGuide2
        StartMode 6
      Elseif PartySize(CurrentPlayer) > 3 Then
        li038.state = 2
  '     Debug "Continue Mode: " &LastMode
        StartMode 5
      elseif PartySize(CurrentPlayer) < 4 Then
        AudioQueue.Add "Pup232","PuPEvent 232",20,0,0,0,AudioExpiry,False
        Debug "bDecision less than 4 members: " &LastMode
        GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
        li047.state = 2
        if DMDType <> 2 Then pupflasher1.visible=true
        StartMode 5
      End If
    Case 7:
      StartMode 7
    Case 8:
      If Mode(CurrentPlayer,8) = 3 Then
        li038.state = 2 ' turn on quest light
        DisplayGuide2
        StartMode 8
      Elseif PartySize(CurrentPlayer) > 3 Then
        li038.state = 2
  '     Debug "Continue Mode: " &LastMode
        StartMode 7
      elseif PartySize(CurrentPlayer) < 4 Then
        AudioQueue.Add "Pup232","PuPEvent 232",20,0,0,0,AudioExpiry,False
        Debug "bDecision less than 4 members: " &LastMode
        GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
        li047.state = 2
        if DMDType <> 2 Then pupflasher1.visible=true
        StartMode 7
      End If
    Case 9:
      StartMode 9
    Case 10,11,12,13,14:
      Debug2 "Got to cont mode 10"
'     Mode(CurrentPlayer,0) = 0
      if PartySize(CurrentPlayer) < 4 Then
        li047.state = 2
        if Mode(Currentplayer,2) < 2 Then
          'Mode(CurrentPlayer,0) = 1
          'Mode(Currentplayer,1) = 2
          StartMode 1
        Elseif Mode(Currentplayer,4) < 2 Then
          'Mode(CurrentPlayer,0) = 3
          'Mode(Currentplayer,3) = 2
          StartMode 3
        Elseif Mode(Currentplayer,6) < 2 Then
          'Mode(CurrentPlayer,0) = 5
          'Mode(Currentplayer,5) = 2
          StartMode 5
        Elseif Mode(Currentplayer,8) < 2 Then
          'Mode(CurrentPlayer,0) = 7
          'Mode(Currentplayer,7) = 2
          StartMode 7
        Else
          li038.state = 0 ' party is full so turn on quest light
          StartMode 9
        End If
      Else
        li038.state = 2
        if Mode(Currentplayer,2) < 2 Then
          Mode(CurrentPlayer,0) = 1
          Mode(Currentplayer,1) = 2
          'StartMode 1
        Elseif Mode(Currentplayer,4) < 2 Then
          Mode(CurrentPlayer,0) = 3
          Mode(Currentplayer,3) = 2
          'StartMode 3
        Elseif Mode(Currentplayer,6) < 2 Then
          Mode(CurrentPlayer,0) = 5
          Mode(Currentplayer,5) = 2
          'StartMode 5
        Elseif Mode(Currentplayer,8) < 2 Then
          Mode(CurrentPlayer,0) = 7
          Mode(Currentplayer,7) = 2
          'StartMode 7
        Else
          li038.state = 0 ' party is full so turn on quest light
          StartMode 9
        End If
      End If
    Case Else:
        'Do nothing
        MsgBox "Continue Mode - ELSE"
  End Select
  SetModeTitle
End Sub
'===================================================
Sub AdvanceMode (LeavingMode)
CMode = LeavingMode
Debug " &&&&&&&&&  ---- In AdvanceMode: " &CMode

  Select Case CMode
    Case 0:
      Debug "Hmm, in Mode 0"
      msgBox "AdvanceMode: - Case 0"
    Case 1:
      if Mode(Currentplayer,2) < 2 Then
        StartMode 2
      Elseif Mode(Currentplayer,4) < 2 Then
        StartMode 4
      Elseif Mode(Currentplayer,6) < 2 Then
        StartMode 6
      Elseif Mode(Currentplayer,8) < 2 Then
        StartMode 8
      Else
        li038.state = 0 ' party is full so turn on quest light
        StartMode 9
      End If
    Case 2:
      If Mode(CurrentPlayer,2) <> 3 Then
        if PartySize(CurrentPlayer) > 3 Then
        Debug " Starting Mode 2"
          StartMode 2
        Else
        Debug " Starting Mode 1"
          StartMode 1
        End If
      End If
    Case 3:
      StartMode 4
    Case 4:
      If Mode(CurrentPlayer,4) <> 3 Then
        if PartySize(CurrentPlayer) > 3 Then
        Debug " Starting Mode 4"
          StartMode 4
        Else
        Debug " Starting Mode 3"
          StartMode 3
        End If
      End If
    Case 5:
      StartMode 6
    Case 6:
      If Mode(CurrentPlayer,6) <> 3 Then
        if PartySize(CurrentPlayer) > 3 Then
        Debug " Starting Mode 6"
          StartMode 6
        Else
        Debug " Starting Mode 5"
          StartMode 5
        End If
      End If
    Case 7:
      StartMode 8
    Case 8:
      If Mode(CurrentPlayer,8) <> 3 Then
        if PartySize(CurrentPlayer) > 3 Then
        Debug " Starting Mode 8"
          StartMode 8
        Else
        Debug " Starting Mode 7"
          StartMode 7
        End If
      End If

    Case 9:
      if PartySize(CurrentPlayer) > 3 Then
      Debug " Starting Mode 9"
        StartMode 9
      Else
      Debug " Starting Mode 7"
        StartMode 7
      End If
    Case else:
      ' Do nothing
      MsgBox "Advance Mode - ELSE"
  End Select
End Sub

'===================================================
Sub SetModeTitle
GetAM
  Select Case ActiveMode
    Case 0: ModeTitle = "In The Village"
    Case 1: ModeTitle = "At The Inn"
'   Case 2: ModeTitle =  "Ruins Dungeon"
    Case 2: ModeTitle =  "The Ruins"
    Case 3: ModeTitle = "At The Inn"
'   Case 4: ModeTitle = "Cove Dungeon"
    Case 4: ModeTitle = "The Cove"
    Case 5: ModeTitle = "At The Inn"
'   Case 6: ModeTitle = "Weald Dungeon"
    Case 6: ModeTitle = "The Weald"
    Case 7: ModeTitle = "At The Inn"
'   Case 8: ModeTitle = "Warrens Dungeon"
    Case 8: ModeTitle = "The Warrens"
    Case 9: ModeTitle = "At The Inn"
    Case 10: ModeTitle = "Prophet"
    Case 11: ModeTitle = "Drowned Crew"
    Case 12: ModeTitle = "Vvulf Battle"
    Case 13: ModeTitle = "Swine Prince"
    Case 14: ModeTitle = "Shambler"
    Case 15: ModeTitle = "Wizard Mode"
  End Select
  UpdateModeLabels
End Sub


Sub StartMode(n)
Debug  "Start Mode: " &n
    Select Case n
        Case 1:AssemblePartyRuins
        Case 2:StartRuins
        Case 3:AssemblePartyCove
        Case 4:StartCove
        Case 5:AssemblePartyWeald
        Case 6:StartWeald
        Case 7:AssemblePartyWarrens
        Case 8:StartWarrens
        Case 9:WizardModePrep
'   Case 10:LoadProphet
'   Case 11:LoadDrownedCrew
'   Case 12:LoadWulf
'   Case 13:LoadSwinePrince
    Case 14:LoadShambler
    Case 15:WizardModePrep
    Case 16:WizardMode
    Case Else: 'Do nothing
    End Select

  UpdateModeLabels

End Sub

Sub StopMode(n) 'called at the end of a ball
Debug  "In Stop Mode: " &ActiveMode
LastMode = ActiveMode
    Select Case n
        Case 1:StopAssemblePartyRuins
        Case 2:StopRuins
        Case 3:StopAssemblePartyCove
        Case 4:StopCove
        Case 5:StopAssemblePartyWeald
        Case 6:StopWeald
        Case 7:StopAssemblePartyWarrens
        Case 8:StopWarrens
        Case 9:StopWizardMode
    Case 10:StopProphet
    Case 11:StopDrownedCrew
    Case 12:StopWulf
    Case 13:StopSwinePrince
    Case 14:StopShambler
    Case Else: 'Do nothing
    End Select

  UpdateModeLabels

End Sub

Sub StopMission(n) 'called at the end of a ball
'Debug  "In Stop Mission"

    Select Case n
        Case 1:StopBlacksmith
        Case 2:StopGambler
        Case 3:StopMultiball
    End Select

  UpdateModeLabels

End Sub

Sub WinMode(n) 'called after completing a mode
Debug "Entered Win Mode: " &n
    Select Case n
    Case 0:WinBase
        Case 1:WinAssemblePartyRuins
        Case 2:WinRuins
        Case 3:WinAssemblePartyCove
        Case 4:WinCove
        Case 5:WinAssemblePartyWeald
        Case 6:WinWeald
        Case 7:WinAssemblePartyWarrens
        Case 8:WinWarrens
        Case 9:WinWizardModePrep
    Case 10:WinProphet
    Case 11:WinDrownedCrew
    Case 12:WinWulf
    Case 13:WinSwinePrince
    Case 14:WinShambler
    End Select

  UpdateModeLabels
End Sub

Sub UpdateModeLights()  '' currently not used
    'update the lights according to the mode state
   l7.State = Mode(1)
    l6.State = Mode(2)
    l8.State = Mode(3)
    l9.State = Mode(4)
    l10.State = Mode(5)
    l11.State = Mode(6)
    l12.State = Mode(7)
    l14.State = Mode(8)

   Select Case Mode(CurrentPlayer, 0)
        Case 1:SetLightColor l7, ColorCode, 2
        Case 2:SetLightColor l6, ColorCode, 2
       Case 3:SetLightColor l8, ColorCode, 2
       Case 4:SetLightColor l9, ColorCode, 2
        Case 5:SetLightColor l10, ColorCode, 2
       Case 6:SetLightColor l11, ColorCode, 2
        Case 7:SetLightColor l12, ColorCode, 2
        Case 8:SetLightColor l14, ColorCode, 2
        Case 9:SetLightColor l13, ColorCode, 2
 '       Case 10:SetLightColor l47, ColorCode, 2
    End Select
End Sub

' *********************************************************************
'                     Mode Sub Routines
' *********************************************************************
Sub WinBase
  Debug "Win BASE"
  InnCleared = 1
  'li038.state = 2 ' turn on queset light
  li047.state=0 ' inn light not blinking anymore
End Sub

Sub ClearTorchPup
  PuPlayer.LabelSet pBackglass,"TorchMeter", "",0,""
  PuPlayer.LabelSet pBackglass, "TorchHitsMessage" ,"",  0, ""
  PuPlayer.LabelSet pBackglass, "TorchCountDownTimerOn" ,"",  0, ""
End Sub

sub ClearSideMissionPuPMessages
  ClearTorchPup
  ClearBlacksmithPup
  ClearGambleCountDownPup
End Sub

Sub ClearPupMessages
  ClearSideMissionPuPMessages
  HideHelper
  HideWizardModeMessage
  ClearDungeonPup
  ClearDungeonPup2 ' make sure message has cleared
  ClearGuideMessages
  'ClearCountDownPup
  pbackglasslabelhide "ScorbitQRIcon2"  ' make sure Qr Claim is hidden
  pbackglasslabelhide "ScorbitQR2" ' make sure Qr Claim is hidden
End Sub

Sub AssemblePartyRuins ' Mode 1
  Light010.state = 0
  bInn = True
  AudioQueue.Add "Pup291","PuPEvent 291",25,0,0,0,AudioExpiry,False
  AudioQueue.Add "Pup446","PuPEvent 446",20,5100,0,0,0,False ' Inn music
  GeneralPupQueue.Add "Pup347","pupevent 347",90,5200,0,0,0,True
  InnLighting

  ClearPupMessages

  Debug "PartySize: " &PartySize(CurrentPlayer)
  if PartySize(CurrentPlayer) < 4 Then
    if DMDType <> 2 Then pupflasher1.visible=true

    GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
    BallHandlingQueue.Add "SetPartyLights","SetPartyLights",20,0,0,0,0,False

  End If


  Mode(CurrentPlayer,0) = 1
  Mode(CurrentPlayer,1) = 1
  SetModeTitle
  CheckParty



  CheckItems

End Sub

Sub StopAssemblePartyRuins
  Debug "StopAssemblePartyRuins"
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,1) = 0
  ResetLights
  SetModeTitle
  ClearGuideMessages
End Sub

Sub WinAssemblePartyRuins
  'Debug "Win ASSEMBLE RUINS"
  Mode(CurrentPlayer,1) = 2
  StopPartyLights
  ResetLaneLights
  li039.State = 2 'leave on until items maxed
  li040.State = 2 ' leave on until items maxed
  SetModeTitle
  ClearGuideMessages
End Sub

Sub RuinsLightReset
'Debug "Calling Ruins Light Reset"
  li038.state=0 ' Turn off Quest Light
  li047.state=0 ' inn light not blinking anymore


  li036.state=2 'leftramp
  li040.state=2   ' rightramp
  li051.state=2 'orbits off
  li060.state=2
  li037.state=2

End Sub

Sub MonsterLightReset
  li006.state = 1 : li006.intensity = 100 ' v 1.2Y
  li008.state = 1 : li008.intensity = 100
  li024.state = 1 : li024.intensity = 100
  li025.state = 1 : li025.intensity = 100
End Sub
' ------------------------ GIF ROUTINES FOR LOADING MONSTERS -------------------------------------
'================================================================================
Sub LoadMonsterImages
  GetAM
    Select Case ActiveMode
      Case 2:
        CreateRuinsHoard
      Case 4:
        CreateCoveHoard
      Case 6:
        CreateWealdHoard
      Case 8:
        CreateWarrensHoard
    End Select
end Sub
'================================================================================
Sub ResetGIF_MA
    For i = 0 to 4
        For j = 0 to 1
      For k = 0 to 1
            GIF_MA(i, j, k) = 0
      Next
        Next
    Next
End Sub
'===============================================================================
Sub LoadDungeonVideos
  if Mode(CurrentPlayer,2) > 1 Then
    if Mode(CurrentPlayer,10) > 1 Then
      DungeonPuPVideos(1) = 578
    Else
      DungeonPuPVideos(1) = 574
    End If
  Else
    DungeonPuPVideos(1) = 570
  End If

  if Mode(CurrentPlayer,4) > 1 Then
    if Mode(CurrentPlayer,11) > 1  Then
      DungeonPuPVideos(2) = 579
    Else
      DungeonPuPVideos(2) = 575
    End If
  Else
    DungeonPuPVideos(2) = 571
  End If

  if Mode(CurrentPlayer,6) > 1 Then
    if Mode(CurrentPlayer,12) > 1  Then
      DungeonPuPVideos(3) = 580
    Else
      DungeonPuPVideos(3) = 576
    End If
  Else
    DungeonPuPVideos(3) = 572
  End If

  if Mode(CurrentPlayer,8) > 1 Then
    if Mode(CurrentPlayer,13) > 1  Then
      DungeonPuPVideos(4) = 581
    Else
      DungeonPuPVideos(4) = 577
    End If
  Else
    DungeonPuPVideos(4) = 573
  End If
End Sub
'===============================================================================
Sub PickDungeonBG
dungeonautoselect.Enabled  = False ' Reset timer that autoselect dungeon if no activity
dungeonautoselect.Enabled  = True
GetAM

  Select Case ActiveMode
    Case 1,2,10:
      d = RndNbr(8)
      Select Case d
        Case 1: CurrentDungeonBG = "PuPevent 950"
        Case 2: CurrentDungeonBG = "PuPevent 951"
        Case 3: CurrentDungeonBG = "PuPevent 952"
        Case 4: CurrentDungeonBG = "PuPevent 953"
        Case 5: CurrentDungeonBG = "PuPevent 954"
        Case 6: CurrentDungeonBG = "PuPevent 955"
        Case 7: CurrentDungeonBG = "PuPevent 956"
        Case 8: CurrentDungeonBG = "PuPevent 957"
        Case Else: msgbox "Error:-1 PickBG Should not get here"
      End Select

    Case 3,4,11:
      d = RndNbr(8)
      Select Case d
        Case 1: CurrentDungeonBG = "PuPevent 958"
        Case 2: CurrentDungeonBG = "PuPevent 959"
        Case 3: CurrentDungeonBG = "PuPevent 960"
        Case 4: CurrentDungeonBG = "PuPevent 961"
        Case 5: CurrentDungeonBG = "PuPevent 962"
        Case 6: CurrentDungeonBG = "PuPevent 963"
        Case 7: CurrentDungeonBG = "PuPevent 964"
        Case 8: CurrentDungeonBG = "PuPevent 965"
        Case Else: msgbox "Error:-2 PickBG Should not get here"
      End Select

    Case 5,6,12:
      d = RndNbr(8)
      Select Case d
        Case 1: CurrentDungeonBG = "PuPevent 966"
        Case 2: CurrentDungeonBG = "PuPevent 967"
        Case 3: CurrentDungeonBG = "PuPevent 968"
        Case 4: CurrentDungeonBG = "PuPevent 969"
        Case 5: CurrentDungeonBG = "PuPevent 970"
        Case 6: CurrentDungeonBG = "PuPevent 971"
        Case 7: CurrentDungeonBG = "PuPevent 972"
        Case 8: CurrentDungeonBG = "PuPevent 973"
        Case Else: msgbox "Error:-3 PickBG Should not get here"
      End Select

    Case 7,8,13:
      d = RndNbr(8)
      Select Case d
        Case 1: CurrentDungeonBG = "PuPevent 974"
        Case 2: CurrentDungeonBG = "PuPevent 975"
        Case 3: CurrentDungeonBG = "PuPevent 976"
        Case 4: CurrentDungeonBG = "PuPevent 977"
        Case 5: CurrentDungeonBG = "PuPevent 978"
        Case 6: CurrentDungeonBG = "PuPevent 979"
        Case 7: CurrentDungeonBG = "PuPevent 980"
        Case 8: CurrentDungeonBG = "PuPevent 981"
        Case Else: msgbox "Error:-4 PickBG Should not get here"
      End Select

    Case 14:
      CurrentDungeonBG = "PuPevent 982"

    Case 0,9,15:
      CurrentDungeonBG = "PuPevent 900"

    Case Else: msgbox "Error:-5 PickBG Outside of Dungeons: " &ActiveMode
  End Select

'Debug5 "DungeonBG: " &CurrentDungeonBG
End Sub

Sub DisplayDSHelper
  PuPlayer.LabelSet pBackglass,"Scoop2Helper",HelperMessage,1,"{'mt':2, 'ypos':30 }"
End Sub
'===============================================================================
Sub PickDungeon


  LoadDungeonVideos ' make sure the right videos are loaded into the queue
  bDungeonSelectMode = True

  DungeonVidIndex = 1 ' needs to be set to 1
  ' Find the first dungeon that is incomplete
  if Mode(CurrentPlayer,2) < 2 Then
    DungeonVidIndex = 1
    CheckDungeonLights
    li045.state = 2
    PlayDungeonSelection
  Elseif Mode(CurrentPlayer,4) < 2 Then
    DungeonVidIndex = 2
    CheckDungeonLights
    li030.state = 2
    PlayDungeonSelection
  Elseif Mode(CurrentPlayer,6) < 2 Then
    DungeonVidIndex = 3
    CheckDungeonLights
    li031.state = 2
    PlayDungeonSelection
  Elseif Mode(CurrentPlayer,8) < 2 Then
    DungeonVidIndex = 4
    CheckDungeonLights
    li026.state = 2
    PlayDungeonSelection
  Else
    StartMode 9
    BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
    Exit Sub
  End If

  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to View Dungeons"" ",6,0,0,0,0,False
  if DMDType = 0 Then
    GeneralPupQueue.Add "DisplayDSHelper","DisplayDSHelper",5,100,0,0,0,False
  Else
    GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,100,0,0,0,False
  End If

  PlayDungeonSelection
  PickDungeonBG
End Sub
'===============================================================================
Sub PlayDungeonSelection
  if DungeonVidIndex = 1 Then
    if Mode(CurrentPlayer,2) < 2 Then
      CheckDungeonLights
      li045.state = 2
    End If
  Elseif DungeonVidIndex = 2 Then
    if Mode(CurrentPlayer,4) < 2 Then
      CheckDungeonLights
      li030.state = 2
    End If
  Elseif DungeonVidIndex = 3 Then
    if Mode(CurrentPlayer,6) < 2 Then
      CheckDungeonLights
      li031.state = 2
    End If
  Elseif DungeonVidIndex = 4 Then
    if Mode(CurrentPlayer,8) < 2 Then
      CheckDungeonLights
      li026.state = 2
    End If
  End If



  Select Case DungeonPuPVideos(DungeonVidIndex)
    Case 570:
      GeneralPuPQueue.Add "Pup570","PuPEvent 570",40,0,0,0,0,True
    Case 571:
      GeneralPuPQueue.Add "Pup571","PuPEvent 571",40,0,0,0,0,True
    Case 572:
      GeneralPuPQueue.Add "Pup572","PuPEvent 572",40,0,0,0,0,True
    Case 573:
      GeneralPuPQueue.Add "Pup573","PuPEvent 573",40,0,0,0,0,True
    Case 574:
      GeneralPuPQueue.Add "Pup574","PuPEvent 574",40,0,0,0,0,True
    Case 575:
      GeneralPuPQueue.Add "Pup575","PuPEvent 575",40,0,0,0,0,True
    Case 576:
      GeneralPuPQueue.Add "Pup576","PuPEvent 576",40,0,0,0,0,True
    Case 577:
      GeneralPuPQueue.Add "Pup577","PuPEvent 577",40,0,0,0,0,True
    Case 578:
      GeneralPuPQueue.Add "Pup578","PuPEvent 578",40,0,0,0,0,True
    Case 579:
      GeneralPuPQueue.Add "Pup579","PuPEvent 579",40,0,0,0,0,True
    Case 580:
      GeneralPuPQueue.Add "Pup580","PuPEvent 580",40,0,0,0,0,True
    Case 581:
      GeneralPuPQueue.Add "Pup581","PuPEvent 581",40,0,0,0,0,True
    Case Else: ' Do Nothing
  End Select
End Sub
'================================================================================
Sub PickRuinsMonster3
Dim i
tmpMonster = ""
  i = RndNbr(7)
  Debug " PM: " &i
    if i = 1 Then
        if RuinsMonsters(0) = 0 Then
          RuinsMonsters(0) = 1
          tmpMonster = "SkelCaptain"
          Debug "Adding -- Skel Captain"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if RuinsMonsters(1) = 0 Then
          RuinsMonsters(1) = 1
          tmpMonster = "SkelShield"
          Debug "Adding -- Skel Shield "
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if RuinsMonsters(2) = 0 Then
          RuinsMonsters(2) = 1
          tmpMonster = "SkelClub"
          Debug "Adding -- Skel Club"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if RuinsMonsters(3) = 0 Then
          RuinsMonsters(3) = 1
          tmpMonster = "SkelSword"
          Debug "Adding -- Skel Sword"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if RuinsMonsters(4) = 0 Then
          RuinsMonsters(4) = 1
          tmpMonster = "SkelSpear"
          Debug "Adding -- Skel Spear"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if RuinsMonsters(5) = 0 Then
          RuinsMonsters(5) = 1
          tmpMonster = "Courtier"
          Debug "Adding -- Courtier"
        Else
          i = i + 1
        End If
    End If
    if i = 7 Then
        if RuinsMonsters(6) = 0 Then
          RuinsMonsters(6) = 1
          tmpMonster = "Collector"
          Debug "Adding -- Collector"
        Else
          PickRuinsMonsterPassTwo
        End If
    End If
End Sub
'================================================================================
Sub PickRuinsMonsterPassTwo
Dim i
 i= 1
' Debug " PM: " &i
    if i = 1 Then
        if RuinsMonsters(0) = 0 Then
          RuinsMonsters(0) = 1
          tmpMonster = "SkelCaptain"
'         Debug "Adding -- Skel Captain"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if RuinsMonsters(1) = 0 Then
          RuinsMonsters(1) = 1
          tmpMonster = "SkelShield"
'         Debug "Adding -- Skel Shield "
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if RuinsMonsters(2) = 0 Then
          RuinsMonsters(2) = 1
          tmpMonster = "SkelClub"
'         Debug "Adding -- Skel Club"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if RuinsMonsters(3) = 0 Then
          RuinsMonsters(3) = 1
          tmpMonster = "SkelSword"
'         Debug "Adding -- Skel Sword"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if RuinsMonsters(4) = 0 Then
          RuinsMonsters(4) = 1
          tmpMonster = "SkelSpear"
'         Debug "Adding -- Skel Spear"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if RuinsMonsters(5) = 0 Then
          RuinsMonsters(5) = 1
          tmpMonster = "Courtier"
'         Debug "Adding -- Courtier"
        Else
          i = i + 1
        End If
    End If
    if i = 7 Then
        if RuinsMonsters(6) = 0 Then
          RuinsMonsters(6) = 1
          tmpMonster = "Collector"
  '       Debug "Adding -- Collector"
        Else
          MsgBox "Error: Ruins Monster"
          Debug "Should never get here !!!! "
        End If
    End If
End Sub

'================================================================================
Sub PickRuinsMonster
  Dim out,i

  ResetGIF_MA
  out = rndUnique(0,6,4)

For i = 0 to 3
  tmpMonster = ""
  'Debug "Monster: " &out(i)

  Select Case out(i)
    Case 0:
      tmpMonster = "SkelCaptain"
      pupCreateLabelImage "SkelCaptain","GIFS\\CaptainAni8.gif",10,10,13,35,1,0
    Case 1:
      tmpMonster = "SkelShield"
      pupCreateLabelImage "SkelShield","GIFS\\SkelShield.gif",10,10,13,35,1,0
    Case 2:
      tmpMonster = "SkelClub"
      pupCreateLabelImage "SkelClub","GIFS\\SkelClub.gif",10,10,13,35,1,0
    Case 3:
      tmpMonster = "SkelSword"
      pupCreateLabelImage "SkelSword","GIFS\\SkelSword.gif",10,10,13,35,1,0
    Case 4:
      tmpMonster = "SkelSpear"
      pupCreateLabelImage "SkelSpear","GIFS\\SkelSpear.gif",10,10,13,35,1,0
    Case 5:
      tmpMonster = "Courtier"
      pupCreateLabelImage "Courtier","GIFS\\Courtier.gif",10,10,13,35,1,0
    Case 6:
      tmpMonster = "Collector"
      pupCreateLabelImage "Collector","GIFS\\Collector.gif",10,10,13,35,1,0
  End Select

  GIF_MA(i,0,0) = tmpMonster
  GIF_MA(i,1,0) = "MonsterDead"&i+1
  GIF_MA(i,0,1) = 0
  'Debug "MonsterGIF: " & GIF_MA(i,0,0)
  Debug "MonsterDeadGIF: " & GIF_MA(i,1,0)

  if i = 0 Then M1 = tmpMonster
  if i = 1 Then M2 = tmpMonster
  if i = 2 Then M3 = tmpMonster
  if i = 3 Then M4 = tmpMonster


Next

End Sub
'================================================================================
Sub CreateRuinsHoard
ResetGIF_MA
  PickRuinsMonster
Debug "***************************************"
  M1 = tmpMonster
  GIF_MA(0,0,0) = tmpMonster
  GIF_MA(0,1,0) = "MonsterDead1"
  GIF_MA(0,0,1) = 0
  Debug "Monster1: " & GIF_MA(0,0,0)

  PickRuinsMonster

  M2 = tmpMonster
  GIF_MA(1,0,0) = tmpMonster
  GIF_MA(1,1,0) = "MonsterDead2"
  GIF_MA(1,0,1) = 0
  Debug "Monster2: " & GIF_MA(1,0,0)

  PickRuinsMonster

  M3 = tmpMonster
  GIF_MA(2,0,0) = tmpMonster
  GIF_MA(2,1,0) = "MonsterDead3"
  GIF_MA(2,0,1) = 0
  Debug "Monster3: " & GIF_MA(2,0,0)

  PickRuinsMonster

  M4 = tmpMonster
  GIF_MA(3,0,0) = tmpMonster
  GIF_MA(3,1,0) = "MonsterDead4"
  GIF_MA(3,0,1) = 0
  Debug "Monster4: " & GIF_MA(3,0,0)
' Debug "Monster4: " & GIF_MA(3,1,0)
Debug "***************************************"
'Dim i
'for i = 0 to 7
' RuinsMonsters(i) = 0
'Next

End Sub
'================================================================================
Sub PickCoveMonster3
Dim i
tmpMonster = ""
  i = RndNbr(6)
    if i = 1 Then
        if CoveMonsters(0) = 0 Then
          CoveMonsters(0) = 1
          tmpMonster = "Fish"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if CoveMonsters(1) = 0 Then
          CoveMonsters(1) = 1
          tmpMonster = "Bloated"
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if CoveMonsters(2) = 0 Then
          CoveMonsters(2) = 1
          tmpMonster = "Jellyfish"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if CoveMonsters(3) = 0 Then
          CoveMonsters(3) = 1
          tmpMonster = "Pirate"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if CoveMonsters(4) = 0 Then
          CoveMonsters(4) = 1
          tmpMonster = "Shaman"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if CoveMonsters(5) = 0 Then
          CoveMonsters(5) = 1
          tmpMonster = "Snail"
        Else
          PickCoveMonsterPassTwo
        End If
    End If
End  Sub
'================================================================================
Sub PickCoveMonsterPassTwo
Dim i
  i = 1
    if i = 1 Then
        if CoveMonsters(0) = 0 Then
          CoveMonsters(0) = 1
          tmpMonster = "Fish"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if CoveMonsters(1) = 0 Then
          CoveMonsters(1) = 1
          tmpMonster = "Bloated"
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if CoveMonsters(2) = 0 Then
          CoveMonsters(2) = 1
          tmpMonster = "Jellyfish"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if CoveMonsters(3) = 0 Then
          CoveMonsters(3) = 1
          tmpMonster = "Pirate"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if CoveMonsters(4) = 0 Then
          CoveMonsters(4) = 1
          tmpMonster = "Shaman"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if CoveMonsters(5) = 0 Then
          CoveMonsters(5) = 1
          tmpMonster = "Snail"
        Else
          MsgBox "Error: Cove Monster"
          Debug " WTF - should not get here"
        End If
    End If
End Sub
'================================================================================

Sub CreateCoveHoard
ResetGIF_MA

  PickCoveMonster
Debug "***************************************"
  M1 = tmpMonster
  GIF_MA(0,0,0) = tmpMonster
  GIF_MA(0,1,0) = "MonsterDead1"
  GIF_MA(0,0,1) = 1
  Debug "Monster1: " & GIF_MA(0,0,0)

  PickCoveMonster

  M2 = tmpMonster
  GIF_MA(1,0,0) = tmpMonster
  GIF_MA(1,1,0) = "MonsterDead2"
  GIF_MA(1,0,1) = 1
  Debug "Monster2: " & GIF_MA(1,0,0)

  PickCoveMonster

  M3 = tmpMonster
  GIF_MA(2,0,0) = tmpMonster
  GIF_MA(2,1,0) = "MonsterDead3"
  GIF_MA(2,0,1) = 1
  Debug "Monster3: " & GIF_MA(2,0,0)

  PickCoveMonster

  M4 = tmpMonster
  GIF_MA(3,0,0) = tmpMonster
  GIF_MA(3,1,0) = "MonsterDead4"
  GIF_MA(3,0,1) = 1
  Debug "Monster4: " & GIF_MA(3,0,0)
  Debug "Monster4: " & GIF_MA(3,1,0)
Debug "***************************************"

End Sub
'================================================================================
Sub PickWealdMonster3
Dim i
tmpMonster = ""
  i = RndNbr(6)

    if i = 1 Then
        if WealdMonsters(0) = 0 Then
          WealdMonsters(0) = 1
          tmpMonster = "Bloat"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if WealdMonsters(1) = 0 Then
          WealdMonsters(1) = 1
          tmpMonster = "Blob"
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if WealdMonsters(2) = 0 Then
          WealdMonsters(2) = 1
          tmpMonster = "Brigand"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if WealdMonsters(3) = 0 Then
          WealdMonsters(3) = 1
          tmpMonster = "Crone"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if WealdMonsters(4) = 0 Then
          WealdMonsters(4) = 1
          tmpMonster = "Fungus"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if WealdMonsters(5) = 0 Then
          WealdMonsters(5) = 1
          tmpMonster = "Virago"
        Else
          PickWealdMonsterPassTwo
        End If
    End If
End Sub
'================================================================================
Sub PickWealdMonsterPassTwo
Dim i

  i = 1

    if i = 1 Then
        if WealdMonsters(0) = 0 Then
          WealdMonsters(0) = 1
          tmpMonster = "Bloat"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if WealdMonsters(1) = 0 Then
          WealdMonsters(1) = 1
          tmpMonster = "Blob"
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if WealdMonsters(2) = 0 Then
          WealdMonsters(2) = 1
          tmpMonster = "Brigand"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if WealdMonsters(3) = 0 Then
          WealdMonsters(3) = 1
          tmpMonster = "Crone"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if WealdMonsters(4) = 0 Then
          WealdMonsters(4) = 1
          tmpMonster = "Fungus"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if WealdMonsters(5) = 0 Then
          WealdMonsters(5) = 1
          tmpMonster = "Virago"
        Else
          MsgBox "Error: Weald Monster"
          Debug "Should not get here"
        End If
    End If
End Sub
'================================================================================
Sub CreateWealdHoard
ResetGIF_MA

  PickWealdMonster
Debug "***************************************"
  M1 = tmpMonster
  GIF_MA(0,0,0) = tmpMonster
  GIF_MA(0,1,0) = "MonsterDead1"
  GIF_MA(0,0,1) = 1
  Debug "Monster1: " & GIF_MA(0,0,0)

  PickWealdMonster

  M2 = tmpMonster
  GIF_MA(1,0,0) = tmpMonster
  GIF_MA(1,1,0) = "MonsterDead2"
  GIF_MA(1,0,1) = 1
  Debug "Monster2: " & GIF_MA(1,0,0)

  PickWealdMonster

  M3 = tmpMonster
  GIF_MA(2,0,0) = tmpMonster
  GIF_MA(2,1,0) = "MonsterDead3"
  GIF_MA(2,0,1) = 1
  Debug "Monster3: " & GIF_MA(2,0,0)

  PickWealdMonster

  M4 = tmpMonster
  GIF_MA(3,0,0) = tmpMonster
  GIF_MA(3,1,0) = "MonsterDead4"
  GIF_MA(3,0,1) = 1
  Debug "Monster4: " & GIF_MA(3,0,0)
  Debug "Monster4: " & GIF_MA(3,1,0)
Debug "***************************************"

End Sub
'================================================================================
Sub PickWarrensMonster3
Dim i
tmpMonster = ""
  i = RndNbr(6)

    if i = 1 Then
        if WarrensMonsters(0) = 0 Then
          WarrensMonsters(0) = 1
          tmpMonster = "Eater"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if WarrensMonsters(1) = 0 Then
          WarrensMonsters(1) = 1
          tmpMonster = "Flesh"
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if WarrensMonsters(2) = 0 Then
          WarrensMonsters(2) = 1
          tmpMonster = "Skiver"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if WarrensMonsters(3) = 0 Then
          WarrensMonsters(3) = 1
          tmpMonster = "Slasher"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if WarrensMonsters(4) = 0 Then
          WarrensMonsters(4) = 1
          tmpMonster = "Wretch"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if WarrensMonsters(5) = 0 Then
          WarrensMonsters(5) = 1
          tmpMonster = "Ghoul"
        Else
          PickWarrensMonsterPassTwo
        End If
    End if
End Sub
'================================================================================
Sub PickWarrensMonsterPassTwo
Dim i

  i = 1

    if i = 1 Then
        if WarrensMonsters(0) = 0 Then
          WarrensMonsters(0) = 1
          tmpMonster = "Eater"
        Else
          i = i + 1
        End If
    End If
    if i = 2 Then
        if WarrensMonsters(1) = 0 Then
          WarrensMonsters(1) = 1
          tmpMonster = "Flesh"
        Else
          i = i + 1
        End If
    End If
    if i = 3 Then
        if WarrensMonsters(2) = 0 Then
          WarrensMonsters(2) = 1
          tmpMonster = "Skiver"
        Else
          i = i + 1
        End If
    End If
    if i = 4 Then
        if WarrensMonsters(3) = 0 Then
          WarrensMonsters(3) = 1
          tmpMonster = "Slasher"
        Else
          i = i + 1
        End If
    End If
    if i = 5 Then
        if WarrensMonsters(4) = 0 Then
          WarrensMonsters(4) = 1
          tmpMonster = "Wretch"
        Else
          i = i + 1
        End If
    End If
    if i = 6 Then
        if WarrensMonsters(5) = 0 Then
          WarrensMonsters(5) = 1
          tmpMonster = "Ghoul"
        Else
          MsgBox "Error: Warrens Monster"
          Debug "Should not get here"
        End If
    End if
End Sub
'================================================================================
Sub CreateWarrensHoard
ResetGIF_MA

  PickWarrensMonster
Debug "***************************************"
  M1 = tmpMonster
  GIF_MA(0,0,0) = tmpMonster
  GIF_MA(0,1,0) = "MonsterDead1"
  GIF_MA(0,0,1) = 1
  Debug "Monster1: " & GIF_MA(0,0,0)

  PickWarrensMonster

  M2 = tmpMonster
  GIF_MA(1,0,0) = tmpMonster
  GIF_MA(1,1,0) = "MonsterDead2"
  GIF_MA(1,0,1) = 1
  Debug "Monster2: " & GIF_MA(1,0,0)

  PickWarrensMonster

  M3 = tmpMonster
  GIF_MA(2,0,0) = tmpMonster
  GIF_MA(2,1,0) = "MonsterDead3"
  GIF_MA(2,0,1) = 1
  Debug "Monster3: " & GIF_MA(2,0,0)

  PickWarrensMonster

  M4 = tmpMonster
  GIF_MA(3,0,0) = tmpMonster
  GIF_MA(3,1,0) = "MonsterDead4"
  GIF_MA(3,0,1) = 1
  Debug "Monster4: " & GIF_MA(3,0,0)
  Debug "Monster4: " & GIF_MA(3,1,0)
Debug "***************************************"

End Sub
'================================================================================
'================================================================================
Sub PickCoveMonster
  Dim out,i

  ResetGIF_MA
  out = rndUnique(0,5,4)

For i = 0 to 3
  tmpMonster = ""
  Debug "Monster: " &out(i)

  Select Case out(i)
    Case 0:
      tmpMonster = "Fish"
      pupCreateLabelImage "Fish","GIFS\\FishAni8.gif",10,10,13,35,1,0
    Case 1:
      tmpMonster = "Bloated"
      pupCreateLabelImage "Bloated","GIFS\\Bloated.gif",10,10,13,35,1,0
    Case 2:
      tmpMonster = "Jellyfish"
      pupCreateLabelImage "Jellyfish","GIFS\\jellyfish.gif",10,10,13,35,1,0
    Case 3:
      tmpMonster = "Pirate"
      pupCreateLabelImage "Pirate","GIFS\\pirate.gif",10,10,13,35,1,0
    Case 4:
      tmpMonster = "Shaman"
      pupCreateLabelImage "Shaman","GIFS\\Shaman.gif",10,10,13,35,1,0
    Case 5:
      tmpMonster = "Snail"
      pupCreateLabelImage "Snail","GIFS\\Snail.gif",10,10,13,35,1,0
  End Select

  GIF_MA(i,0,0) = tmpMonster
  GIF_MA(i,1,0) = "MonsterDead"&i+1
  GIF_MA(i,0,1) = 1
  Debug "MonsterGIF: " & GIF_MA(i,0,0)
  Debug "MonsterDeadGIF: " & GIF_MA(i,1,0)

  if i = 0 Then M1 = tmpMonster
  if i = 1 Then M2 = tmpMonster
  if i = 2 Then M3 = tmpMonster
  if i = 3 Then M4 = tmpMonster
Next

End Sub

'================================================================================
Sub PickWealdMonster
  Dim out,i

  ResetGIF_MA
  out = rndUnique(0,5,4)

For i = 0 to 3
  tmpMonster = ""
  Debug "Monster: " &out(i)

  Select Case out(i)
    Case 0:
      tmpMonster = "Bloat"
      pupCreateLabelImage "Bloat","GIFS\\Bloat.gif",10,10,13,35,1,0
    Case 1:
      tmpMonster = "Blob"
      pupCreateLabelImage "Blob","GIFS\\blob.gif",10,10,13,35,1,0
    Case 2:
      tmpMonster = "Brigand"
      pupCreateLabelImage "Brigand","GIFS\\brigand.gif",10,10,13,35,1,0
    Case 3:
      tmpMonster = "Crone"
      pupCreateLabelImage "Crone","GIFS\\crone.gif",10,10,13,35,1,0
    Case 4:
      tmpMonster = "Fungus"
      pupCreateLabelImage "Fungus","GIFS\\fungus.gif",10,10,13,35,1,0
    Case 5:
      tmpMonster = "Virago"
      PupCreateLabelImage "Virago","GIFS\\virago.gif",10,10,13,35,1,0
  End Select

  GIF_MA(i,0,0) = tmpMonster
  GIF_MA(i,1,0) = "MonsterDead"&i+1
  GIF_MA(i,0,1) = 1
  Debug "MonsterGIF: " & GIF_MA(i,0,0)

  if i = 0 Then M1 = tmpMonster
  if i = 1 Then M2 = tmpMonster
  if i = 2 Then M3 = tmpMonster
  if i = 3 Then M4 = tmpMonster
Next

End Sub

'================================================================================
Sub PickWarrensMonster
  Dim out,i

  ResetGIF_MA
  out = rndUnique(0,5,4)

For i = 0 to 3
  tmpMonster = ""
  Debug "Monster: " &out(i)

  Select Case out(i)
    Case 0:
      tmpMonster = "Eater"
      pupCreateLabelImage "Eater","GIFS\\Eater8.gif",10,10,13,35,1,0
    Case 1:
      tmpMonster = "Flesh"
      pupCreateLabelImage "Flesh","GIFS\\flesh.gif",10,10,13,35,1,0
    Case 2:
      tmpMonster = "Skiver"
      pupCreateLabelImage "Skiver","GIFS\\skiver8.gif",10,10,13,35,1,0
    Case 3:
      tmpMonster = "Slasher"
      pupCreateLabelImage "Slasher","GIFS\\slasher8.gif",10,10,13,35,1,0
    Case 4:
      tmpMonster = "Wretch"
      pupCreateLabelImage "Wretch","GIFS\\wretch8.gif",10,10,13,35,1,0
    Case 5:
      tmpMonster = "Ghoul"
      pupCreateLabelImage "Ghoul","GIFS\\GhoulAni8.gif",93,50,13,35,1,0
  End Select

  GIF_MA(i,0,0) = tmpMonster
  GIF_MA(i,1,0) = "MonsterDead"&i+1
  GIF_MA(i,0,1) = 1
  Debug "MonsterGIF: " & GIF_MA(i,0,0)

  if i = 0 Then M1 = tmpMonster
  if i = 1 Then M2 = tmpMonster
  if i = 2 Then M3 = tmpMonster
  if i = 3 Then M4 = tmpMonster
Next

End Sub

Sub GlimmerOfHopeOn
  'li100.intensity = 200
  'li100.state = 1
End Sub

Sub GlimmerOfHopeOff
  'li100.state = 0
End Sub

Sub UpdateHelperMessage(msg)
  HideHelper
  HelperMessage = msg
  PuPlayer.LabelSet pBackglass,"Scoop2Helper",HelperMessage,0,"{'mt':2, 'ypos':20 }"
End Sub
'================================================================================
Sub BallGlow(color, aura, intensity)
  ChangeBall(color)
  GlowAura=aura 'GlowBlob Auroa radius
  GlowIntensity=intensity 'Glowblob intensity
end sub

Sub RuinsDMD
    DOF 240, DOFOn
  StartDTs ' chance for Ambush -- needs to go exactly here
  Debug "Loading RUINS DMD Images"
  PickDungeonBG
  DisplayDungeonBG
  'GeneralPuPQueue.Add "Pup921","PuPEvent 921",78,0,0,0,0,True
  GeneralPupQueue.Add "PDB Ruins","PuPDisplayBattle ""start ruins"" ",30,200,0,0,0,False

  AudioQueue.Add "Pup341","PuPEvent 341",40,0,0,0,0,False

  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,1200,0,0,0,False
  GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,2200,0,0,0,False
End Sub

'-----------------------------------------------------------------------------------------
Sub StartRuins
  'Table1.ColorGradeImage = OldLUT
  DisableInnLighting
  Playsound "wood_door"
  LoadChest ' Add Bad items to the chest
  Debug "START RUINS: " &bRetry

  AudioQueue.Add "SDM","StartDungeonMusic",20,1000,0,0,0,False

  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True

  if DMDType = 0 Then HideBG2 4800
  GeneralPuPQueue.Add "ResetPlayerImages","ResetPlayerImages",42,0,0,0,0,True
  'GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
  GeneralPuPQueue.Add "Pup880","PuPEvent 880",41,0,0,0,0,True ' enter ruins Video
  GeneralPuPQueue.Add "RuinsDMD","RuinsDMD",35,4850,0,0,0,false ' Ruins BG setup


  AudioQueue.Add "Pup225","PuPEvent 225",20,9120,0,0,AudioExpiry,False
  If DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup302","PuPEvent 302",12,0,0,0,0,True

  TorchesEnabled = 1
  OldGI = "white"
  ChangeGI white

  monsterlightreset
  setMonsterLightColorGreen
  Light010.state = 0

  BallGlow 0, 200, 20


  'if bRetry = False Then CreateRuinsHoard
  if bRetry = False Then PickRuinsMonster:ResetMonsters
  if bRetry = True Then RestoreMonsterImages:RestoreMonsterLights
  bRetry = True
  'InBattle = 1


  Mode(CurrentPlayer,0) = 2
  Mode(CurrentPlayer,2) = 1
  SetModeTitle

  RuinsLightReset
  DisableBallLock
  li045.state=2 ' Turn on Ruins light
  ResetUPF
  Debug "RUINS - Monsters String: " &MonsterString

End Sub

Sub StartDungeonMusic
  'AudioQueue.Add "PuP600","PuPEvent 600",90,0,0,0,0,True ' clear audio
  AudioQueue.Add "StartDungeonMusic2","StartDungeonMusic2",70,600,0,0,0,False
End Sub

Sub StartDungeonMusic2
  GetAM
  Select Case ActiveMode
  Case 2:
    Debug "Got to SDM case 2"
    AudioQueue.Add "Pup435","PuPEvent 435",20,0,0,0,0,False' Ruins Theme
  Case 4:
    AudioQueue.Add "Pup436","PuPEvent 436",20,0,0,0,0,False ' Cove Theme
  Case 6:
    AudioQueue.Add "Pup437","PuPEvent 437",20,0,0,0,0,False ' Weald Theme
  Case 8:
    AudioQueue.Add "Pup438","PuPEvent 438",20,0,0,0,0,False ' Warrens Theme
  Case 9:
    AudioQueue.Add "Pup444","PuPEvent 444",20,0,0,0,0,False ' Wizard Mode Theme
  Case 10:
    AudioQueue.Add "Pup439","PuPEvent 439",20,0,0,0,0,False ' Prophet Theme
  Case 11:
    AudioQueue.Add "Pup440","PuPEvent 440",20,0,0,0,0,False ' Drowned Crew Theme
  Case 12:
    AudioQueue.Add "Pup441","PuPEvent 441",20,0,0,0,0,False ' Vvulf Theme
  Case 13:
    AudioQueue.Add "Pup442","PuPEvent 442",20,0,0,0,0,False ' Swine Prince Theme
  Case 14:
    AudioQueue.Add "Pup443","PuPEvent 443",20,0,0,0,0,False ' Shambler Theme
  End Select

End Sub

Sub StopRuins
  Debug "STOP RUINS"
  Torchtimer.enabled = 0
  HeroCountDownTimer.enabled = 0
  Pulse.Enabled = 0
  Mode(CurrentPlayer,2) = 0
  'SetModeTitle
  ClearGuideMessages
  PlayVillageMusic 100
  SetModeTitle
  ResetLights
  ClearDMDGuide:pupflasher1.visible = "False"
End Sub

Sub StartDungeonTimers
  Debug "Starting Dungeon Timers"
  DungeonBonusTimer.Enabled = 1
  DungeonBonusTimerExpired.Enabled = 1
End Sub

Sub CheckComplete
  if Mode(Currentplayer,2) > 1 And Mode(Currentplayer,4) > 1 And Mode(Currentplayer,6) > 1 And Mode(Currentplayer,8) > 1 Then
    bDungeonsCleared = True
  End If
End Sub

Sub WinRuins
  Mode(CurrentPlayer,2) = 2
  GetAM
  ScorbitBuildGameModes
  DOFModesOff
  Debug "WIN RUINS "&AMCombo
  'setMonsterLightColorWhite
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  bRetry = False
  'Debug "In WinRuins"
  'PuPHideBattle "winruins"
  ClearDMDGuide
  DungeonBonus = 1
  DungeonCountDown = 10
  DungeonTimerMessage1 = "Collect Dungeon Bonus"
  DungeonTimerMessage2 = "Shoot Center Scoop"
  DungeonBonusTimer.Enabled = 1
  DungeonBonusTimerExpired.Enabled = 1
  'Triggerscript 1500, "StartDungeonTimers"
  BallHandlingQueue.Add "ClearDungeonPup","ClearDungeonPup",70,11600,0,0,0,True
  'Triggerscript 11600, "ClearDungeonPup"
  Torchtimer.enabled = 0
' Debug "WIN RUINS "&AMCombo
  RandomSoundwin
  'Playsong "mu_plunger"
  ModeEnd "winruins"    ' should look to add this to start next mode
  InBattle = 0 ' prevent attribtutes from firing
  li038.state = 2 ' turn on quest light
  li045.state=1 ' Ruins turned On
  li047.state=0 ' Inn Off
  ResetLaneLights
  CheckComplete
End Sub

Sub WinProphet
  DOFModesOff
  PlayVillageMusic 100
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  ResetLaneLights

  DungeonTimerMessage2 = "Shoot Center Scoop"
  'Triggerscript 5200, "DisplayGuide2"

  EOBHide "winprophet"
  GeneralPuPQueue.Add "Pup930","PuPEvent 930",40,0,0,0,0,True
  AudioQueue.Add "Pup267", "PuPEvent 267",32,0,0,0,AudioExpiry,False  ' Boss Defeat
  BallHandlingQueue.Add "EOBReturn-WP","EOBReturn ""Winprophet""",70,5200,0,0,0,True
  BallHandlingQueue.Add "DisplayGuide2","DisplayGuide2",70,5200,0,0,0,True
  BallHandlingQueue.Add "Pup400","PuPEvent 400",70,5400,0,0,0,True
  'triggerscript 5200, "EOBReturn ""Winprophet"" "
  'triggerscript 5400, "ReturnOverlay ""winprophet backup"" " ' EOBReturn make sure it comes back



  MonstersCleared = 1


  Torchtimer.enabled = 0
' Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,10) = 2
  GetAM
  ScorbitBuildGameModes
  Debug "WIN PROPHET "&AMCombo
  'RandomSoundwin
  ModeEnd "winprophet"  ' should look to add this to start next mode
  li047.state=0 ' Inn Off
  li038.state=2
  GoldSack(CurrentPlayer) = GoldSack(CurrentPlayer) + 1
  DisplaySacksOfGold
  AudioQueue.Add "Pup276","PuPEvent 276",40,0,0,0,AudioExpiry,False

End Sub

Sub WinDrownedCrew
  DOFModesOff
  PlayVillageMusic 100
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  MonstersCleared = 1
  ResetLaneLights

  EOBHide "WinDrown"
  GeneralPuPQueue.Add "Pup931","PuPEvent 931",40,0,0,0,0,True
  AudioQueue.Add "Pup267", "PuPEvent 267",32,0,0,0,AudioExpiry,False  ' Boss Defeat
  'triggerscript 5300, "EOBReturn ""wincrew"" "
  'triggerscript 5400, "ReturnOverlay ""WDC backup"" " ' EOBReturn make sure it comes back

  DungeonTimerMessage2 = "Shoot Center Scoop"
  'Triggerscript 5100, "DisplayGuide2"

  BallHandlingQueue.Add "EOBReturn-WDC","EOBReturn ""WinDC""",70,5300,0,0,0,True
  BallHandlingQueue.Add "DisplayGuide2","DisplayGuide2",70,5300,0,0,0,True
  BallHandlingQueue.Add "Pup400","PuPEvent 400",70,5400,0,0,0,True

  Torchtimer.enabled = 0
' Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,11) = 2
  GetAM
  ScorbitBuildGameModes
  Debug "WIN DROWNED CREW "&AMCombo
  RandomSoundwin
  'Playsong "mu_plunger"
  ModeEnd "windrownedcrew"    ' should look to add this to start next mode
  li047.state=0 ' Inn Off
  li038.state=2
  GoldSack(CurrentPlayer) = GoldSack(CurrentPlayer) + 1
  DisplaySacksOfGold
  AudioQueue.Add "Pup276","PuPEvent 276",40,0,0,0,AudioExpiry,False
End Sub

Sub WinSwinePrince
  DOFModesOff
  PlayVillageMusic 100
  triggerscript 200, "ClearDMDGuide "
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  MonstersCleared = 1
  ResetLaneLights

  EOBHide "WinSwine"
  GeneralPuPQueue.Add "Pup933","PuPEvent 933",40,0,0,0,0,True
  AudioQueue.Add "Pup267", "PuPEvent 267",32,0,0,0,AudioExpiry,False  ' Boss Defeat
  DungeonTimerMessage2 = "Shoot Center Scoop"

  'triggerscript 5200, "EOBReturn ""WinSwine"" "
  'triggerscript 5400, "ReturnOverlay ""winswine backup"" " ' EOBReturn make sure it comes back

  BallHandlingQueue.Add "EOBReturn-WSP","EOBReturn ""WinSwine""",70,5200,0,0,0,True
  BallHandlingQueue.Add "DisplayGuide2","DisplayGuide2",70,5200,0,0,0,True
  BallHandlingQueue.Add "Pup400","PuPEvent 400",70,5400,0,0,0,True

  Torchtimer.enabled = 0
' Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,13) = 2
  GetAM
  ScorbitBuildGameModes
  Debug "WIN SWINE PRINCE "&AMCombo
  RandomSoundwin
  ModeEnd "winswineprince"  ' should look to add this to start next mode
  li047.state=0 ' Inn Off
  li038.state=2
  GoldSack(CurrentPlayer) = GoldSack(CurrentPlayer) + 1
  DisplaySacksOfGold
  AudioQueue.Add "Pup276","PuPEvent 276",40,0,0,0,AudioExpiry,False
  wall66down
End Sub

Sub WinWulf
  DOFModesOff
  PlayVillageMusic 100
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  MonstersCleared = 1
  ResetLaneLights


  EOBHide "WinWulf"
  GeneralPuPQueue.Add "Pup932","PuPEvent 932",40,0,0,0,0,True
  AudioQueue.Add "Pup267", "PuPEvent 267",32,0,0,0,AudioExpiry,False  ' Boss Defeat
  DungeonTimerMessage2 = "Shoot Center Scoop"

  'triggerscript 5200, "EOBReturn ""WinWulf"" "
  'triggerscript 5400, "ReturnOverlay ""winwulf"" " ' EOBReturn make sure it comes back

  BallHandlingQueue.Add "EOBReturn-WW","EOBReturn ""WinWulf""",70,5200,0,0,0,True
  BallHandlingQueue.Add "DisplayGuide2","DisplayGuide2",70,5200,0,0,0,True
  BallHandlingQueue.Add "Pup400","PuPEvent 400",70,5400,0,0,0,True


  Torchtimer.enabled = 0
' Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,12) = 2
  GetAM
  ScorbitBuildGameModes
  Debug "WIN WULF "&AMCombo
  RandomSoundwin
  'Playsong "mu_plunger"
  ModeEnd "winwulf"   ' should look to add this to start next mode
  li047.state=0 ' Inn Off
  li038.state=2
  GoldSack(CurrentPlayer) = GoldSack(CurrentPlayer) + 1
  DisplaySacksOfGold
  AudioQueue.Add "Pup276","PuPEvent 276",40,0,0,0,AudioExpiry,False
End Sub

Sub WinShambler
  Debug2 "In Win Shambler"
  DOFModesOff
  PlayVillageMusic 100
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  ResetLaneLights

  PlayerAttack
  MonstersCleared = 1


  EOBHide "WinShambler"
  GeneralPuPQueue.Add "Pup933","PuPEvent 933",40,0,0,0,0,True
  AudioQueue.Add "Pup267", "PuPEvent 267",32,0,0,0,AudioExpiry,False  ' Boss Defeat

  DungeonTimerMessage1 = "Shoot Lanes to"
  DungeonTimerMessage2 = "Collect Jackpots"

  BallHandlingQueue.Add "EOBReturn-Sh","EOBReturn ""WinShambler""",70,5200,0,0,0,True
  BallHandlingQueue.Add "DisplayGuide2","DisplayGuide2",70,5200,0,0,0,True
  BallHandlingQueue.Add "Pup400","PuPEvent 400",70,5400,0,0,0,True

  Torchtimer.enabled = 0
' Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,14) = 2
  GetAM
  ScorbitBuildGameModes
  Debug "WIN SHAMBLER "&AMCombo
  RandomSoundwin
  ModeEnd "winshambler"   ' should look to add this to start next mode
  li047.state=0 ' Inn Off
  li038.state=2
  'GoldSack(CurrentPlayer) = GoldSack(CurrentPlayer) + 1
  'AudioQueue.Add "Pup276","PuPEvent 276",40,0,0,0,AudioExpiry,False
  WizardMode
End Sub

Sub StopShambler
  'Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,14) = 0
  SetModeTitle
End Sub

Sub StopProphet
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,10) = 0
  SetModeTitle
End Sub

Sub StopDrownedCrew
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,11) = 0
  SetModeTitle
End Sub

Sub StopWulf
  Debug "&&&&&&&&&&&&&&& IN STOP WWULF &&&&&"
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,12) = 0
  ResetWulf
  SetModeTitle
End Sub

Sub StopSwinePrince
  Debug "StopSwine"
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,13) = 0
  SetModeTitle
  wall66down
End Sub
'-----------------------------------------------------------------------------------------
Sub AssemblePartyCove
  Light010.state = 0
  bInn = True
  AudioQueue.Add "Pup291","PuPEvent 291",25,0,0,0,AudioExpiry,False
  AudioQueue.Add "Pup446","PuPEvent 446",20,3100,0,0,0,False ' Inn music
  GeneralPupQueue.Add "Pup347","pupevent 347",90,3400,0,0,0,True
  InnLighting

  ClearPupMessages

  if PartySize(CurrentPlayer) < 4 Then
    if DMDType <> 2 Then pupflasher1.visible=true

    BallHandlingQueue.Add "SetPartyLights","SetPartyLights",20,0,0,0,0,False
    GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
  End If

  Mode(CurrentPlayer,0) = 3
  Mode(CurrentPlayer,3) = 1
  SetModeTitle
  CheckParty


  CheckItems

End Sub

Sub StopAssemblePartyCove
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,3) = 0
  ResetLights
  SetModeTitle
  ClearGuideMessages
End Sub

Sub WinAssemblePartyCove

  Mode(CurrentPlayer,3) = 2
  StopPartyLights
  ResetLaneLights
  SetModeTitle
  ClearGuideMessages
End Sub

Sub CoveDMD
  'Debug "Loading COVE DMD Images"
    DOF 242, DOFOn
  StartDTs ' chance for Ambush -- needs to go exactly here
  PickDungeonBG
  DisplayDungeonBG
  'GeneralPuPQueue.Add "Pup922","PuPEvent 922",78,0,0,0,0,True
  GeneralPuPQueue.Add "PDB-C","PuPDisplayBattle ""start cove"" ",41,200,0,0,0,False
  AudioQueue.Add "Pup342","PuPEvent 342",40,0,0,0,0,False

  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,200,0,0,0,False
  GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,2200,0,0,0,False
End Sub
'-----------------------------------------------------------------------------------------
Sub StartCove
  'Table1.ColorGradeImage = OldLUT
  DisableInnLighting
  'pupevent 400
  monsterlightreset
  setMonsterLightColorGreen
  Light010.state = 0

  AudioQueue.Add "SDM","StartDungeonMusic",20,1000,0,0,0,False

  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True

  if DMDType = 0 Then HideBG2 4100

  GeneralPuPQueue.Add "ResetPlayerImages","ResetPlayerImages",42,0,0,0,0,True
  GeneralPuPQueue.Add "Pup881","PuPEvent 881",41,0,0,0,0,True
  GeneralPuPQueue.Add "CoveDMD","CoveDMD",35,4100,0,0,0,false ' Ruins BG setup

  AudioQueue.Add "Pup226","PuPEvent 226",20,9000,0,0,AudioExpiry,False
  If DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup303","PuPEvent 303",12,0,0,0,0,True

  TorchesEnabled = 0
  Table1.ColorGradeImage = "LUT14"
  SetLightColor Gi051, White, -1


  BallGlow 3, 180, 12

  'InBattle = 1


' if bRetry = False Then CreateCoveHoard
  if bRetry = False Then PickCoveMonster:ResetMonsters
  if bRetry = True Then RestoreMonsterImages:RestoreMonsterLights
  bRetry = True


  'RegionMonster(CurrentPlayer,4) = 0
  wall66up ' raise post to block orbit shots
  Mode(CurrentPlayer,0) = 4
  Mode(CurrentPlayer,4) = 1
  SetModeTitle
  LoadChest ' Add Bad items to the chest

  DisableBallLock

  li038.state=0 ' Turn off Quest Light
  li047.state=0 ' inn light not blinking anymore
  li036.state=0 'leftramp
  li040.state=0  'rightramp
  li051.state=0 'orbits off
  li060.state=0
  li037.state=0

  ' turn on bumpers ?
  Lbumper1a.state=2
  Lbumper1b.state=2
  Lbumper2a.state=2
  Lbumper2b.state=2


  li030.state=2 ' cove light


  GetAM
  TotalMonsterHits = 24
  'DisplayDungeonProgress
  ResetUPF
  Debug "COVE - Monsters String: " &MonsterString

End Sub

Sub StopCove
  Torchtimer.enabled = 0
  HeroCountDownTimer.enabled = 0
  Pulse.Enabled = 0
  Mode(CurrentPlayer,4) = 0
  'SetModeTitle
  ClearGuideMessages
  PlayVillageMusic 100
  wall66down
  SetModeTitle
  ResetLights
  ClearDMDGuide:pupflasher1.visible = "False"
End Sub



Sub WinCove
' Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,4) = 2
  GetAM
  ScorbitBuildGameModes
  'triggerscript 3500,"ClearDMDGuide" ' added in v119.6 to finally clear dmd guides since monsters are cleared
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  bRetry = False
  ClearDMDGuide
  DOFModesOff
  'PuPHideBattle "wincove"
  DungeonBonus = 1
  DungeonCountDown = 10
  DungeonTimerMessage1 = "Collect Dungeon Bonus"
  DungeonTimerMessage2 = "Shoot Center Scoop"
  'Triggerscript 10100, "ClearDungeonPup"
  BallHandlingQueue.Add "ClearDungeonPup","ClearDungeonPup",70,10100,0,0,0,True
  'Triggerscript 10200, "DungeonBonusTimerExpired.enabled = 0"
  DungeonBonusTimer.Enabled = 1
  DungeonBonusTimerExpired.Enabled = 1
  Torchtimer.enabled = 0
  wall66down ' remove post that was blocking orbit

  Debug "WIN Cove "&AMCombo
  li030.state=1 ' Cove turned On

  li038.state=2 ' Quest
  li047.state=0 ' Inn
  ResetLaneLights
  RandomSoundwin

  ModeEnd "wincove"   ' should look to add this to start next mode
  InBattle = 0 ' prevent attribtutes from firing
  MonstersCleared = 1
  PuPHideBattle "wincove"
  CheckComplete
End Sub

'-----------------------------------------------------------------------------------------
Sub AssemblePartyWeald
Debug "In Assemble Party Welad"
  Light010.state = 0
  bInn = True
  AudioQueue.Add "Pup291","PuPEvent 291",25,0,0,0,AudioExpiry,False
  AudioQueue.Add "Pup446","PuPEvent 446",20,3100,0,0,0,False ' Inn music
  GeneralPupQueue.Add "Pup347","pupevent 347",90,3400,0,0,0,True
  InnLighting

  ClearPupMessages

  if PartySize(CurrentPlayer) < 4 Then
    if DMDType <> 2 Then pupflasher1.visible=true

    BallHandlingQueue.Add "SetPartyLights","SetPartyLights",20,0,0,0,0,False
    GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
  End If

  Mode(CurrentPlayer,0) = 5
  Mode(CurrentPlayer,5) = 1
  SetModeTitle
  CheckParty

  CheckItems

End Sub

Sub StopAssemblePartyWeald
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,5) = 0
  ResetLights
  SetModeTitle
  ClearGuideMessages
End Sub

Sub WinAssemblePartyWeald

  Mode(CurrentPlayer,5) = 2
  StopPartyLights
  ResetLaneLights
  SetModeTitle
  ClearGuideMessages
End Sub

Sub WealdDMD
  'Debug "Loading WEALD DMD Images"
    DOF 244, DOFOn
' StartDTs ' chance for Ambush -- needs to go exactly here  -- do NOT call in WEALD
  PickDungeonBG
  DisplayDungeonBG
  'GeneralPuPQueue.Add "Pup923","PuPEvent 923",78,0,0,0,0,True
  GeneralPuPQueue.Add "PDB-We","PuPDisplayBattle ""start weald"" ",41,200,0,0,0,False
  AudioQueue.Add "Pup343","PuPEvent 343",40,0,0,0,0,False

  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,200,0,0,0,False
  GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,2200,0,0,0,False
End Sub
'-----------------------------------------------------------------------------------------
Sub StartWeald
  'Table1.ColorGradeImage = OldLUT
  DisableInnLighting
Debug "Start Weald"
  Playsound "wood_door"
  monsterlightreset
  setMonsterLightColorGreen

  AudioQueue.Add "SDM","StartDungeonMusic",20,1000,0,0,0,False

  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True

  if DMDType = 0 Then HideBG2 4100
  GeneralPuPQueue.Add "ResetPlayerImages","ResetPlayerImages",42,0,0,0,0,True
  GeneralPuPQueue.Add "Pup882","PuPEvent 882",40,0,0,0,0,True
  GeneralPuPQueue.Add "WealdDMD","WealdDMD",35,4100,0,0,0,false ' Ruins BG setup

  AudioQueue.Add "Pup227","PuPEvent 227",20,9900,0,0,AudioExpiry,False
  If DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup304","PuPEvent 304",12,0,0,0,0,True

  Light010.state = 0
  TorchesEnabled = 1
  BallGlow 6, 180,15

  OldGI = "red"
  ChangeGI red

  if bRetry = False Then PickWealdMonster:ResetMonsters
  if bRetry = True Then RestoreMonsterImages:RestoreMonsterLights
  bRetry = True

  if DMDType <> 2 Then pupflasher1.visible=true

  GeneralPuPQueue.Add "Pup304","PuPEvent 304",12,0,0,0,0,True


  Mode(CurrentPlayer,0) = 6
  Mode(CurrentPlayer,6) = 1
  SetModeTitle
  LoadChest ' Add Bad items to the chest
  li031.state=2 ' Turn on WEALD light


  li038.state=0 ' Turn off Quest Light
  li047.state=0 ' inn light not blinking anymore
  li036.state=0 'leftramp
  li040.state=0  'rightramp
  li051.state=0 'orbits off
  li060.state=0
  li037.state=0
  li039.state=0 ' inn arrow
  DisableUPF
  DisableBallLock

  Dim L
    For each L in ChaseLightsArray : L.state=0 : Next
  'ResetChaseLights
  ChaseLights

End Sub

Sub StopWeald
  Torchtimer.enabled = 0
  HeroCountDownTimer.enabled = 0
  Pulse.Enabled = 0
  Mode(CurrentPlayer,6) = 0
  'SetModeTitle
  ClearGuideMessages
  PlayVillageMusic 100
  SetModeTitle
  ResetLights
  ClearDMDGuide:pupflasher1.visible = "False"
End Sub

Sub WinWeald
  'Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,6) = 2
  GetAM
  ScorbitBuildGameModes
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  bRetry = False
  MonstersCleared = 1
  ClearDMDGuide
  DOFModesOff
  DungeonBonus = 1
  DungeonCountDown = 10
  DungeonTimerMessage1 = "Collect Dungeon Bonus"
  DungeonTimerMessage2 = "Shoot Center Scoop"
  'Triggerscript 10100, "ClearDungeonPup"
  BallHandlingQueue.Add "ClearDungeonPup","ClearDungeonPup",70,10100,0,0,0,True
  BallHandlingQueue.Add "DBT-0","DungeonBonusTimerExpired.enabled = 0",70,10200,0,0,0,True
  'Triggerscript 10200, "DungeonBonusTimerExpired.enabled = 0"
  DungeonBonusTimer.Enabled = 1
  DungeonBonusTimerExpired.Enabled = 1
  Torchtimer.enabled = 0
  HeroCountDownReset
  HeroTimer.enabled = 0
  Debug "Won Weald "&AMCombo
  li031.state=1 ' Weald turned On
  ResetLaneLights
  RandomSoundwin
  ModeEnd "winweald"  ' should look to add this to start next mode
  InBattle = 0 ' prevent attribtutes from firing
  MonstersCleared = 1
  li038.state=2 ' Quest On
  li047.state=0 ' InnOff
  PuPHideBattle "winweald"
  CheckComplete
End Sub

Sub CheckWealdWin
Debug "In check Weald"
  if RegionMonster(CurrentPlayer,6) > 7 Then
    HeroCountDownReset
    HeroTimer.enabled = 0
    WinWeald
  Else
    ChaseLights
  End If
End Sub

'-----------------------------------------------------------------------------------------
Sub AssemblePartyWarrens
  Light010.state = 0
  bInn = True
  AudioQueue.Add "Pup291","PuPEvent 291",25,0,0,0,AudioExpiry,False
  AudioQueue.Add "Pup446","PuPEvent 446",20,3100,0,0,0,False ' Inn music
  GeneralPupQueue.Add "Pup347","pupevent 347",90,3400,0,0,0,True
  InnLighting

  ClearPupMessages

  if PartySize(CurrentPlayer) < 4 Then
    if DMDType <> 2 Then pupflasher1.visible=true

    BallHandlingQueue.Add "SetPartyLights","SetPartyLights",20,0,0,0,0,False
    GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
  End If

  Mode(CurrentPlayer,0) = 7
  Mode(CurrentPlayer,7) = 1
  SetModeTitle
  CheckParty

  CheckItems

End Sub

Sub StopAssemblePartyWarrens
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,7) = 0
  SetModeTitle
  ClearGuideMessages
End Sub


Sub WinAssemblePartyWarrens

  Mode(CurrentPlayer,7) = 2
  SetModeTitle
  StopPartyLights
  ResetLaneLights
  ClearGuideMessages
End Sub


Sub Dump
Dim BOT
  BOT = GetBalls

  Debug "Dumping State Info"
  Debug "Mode 0: " &Mode(CurrentPlayer,0)
  Debug "Mode 1: " &Mode(CurrentPlayer,1)
  Debug "Mode 2: " &Mode(CurrentPlayer,2)
  Debug "Mode 3: " &Mode(CurrentPlayer,3)
  Debug "Mode 4: " &Mode(CurrentPlayer,4)
  Debug "Mode 5: " &Mode(CurrentPlayer,5)
  Debug "Mode 6: " &Mode(CurrentPlayer,6)
  Debug "Mode 7: " &Mode(CurrentPlayer,7)
  Debug "Mode 8: " &Mode(CurrentPlayer,8)
  Debug "Mode 9: " &Mode(CurrentPlayer,9)
  Debug "Mode 10: " &Mode(CurrentPlayer,10)
  Debug "Mode 11: " &Mode(CurrentPlayer,11)
  Debug "Mode 12: " &Mode(CurrentPlayer,12)
  Debug "Mode 13: " &Mode(CurrentPlayer,13)
  Debug "Mode 14: " &Mode(CurrentPlayer,14)


  Debug "Side Mode 1: " &Missions(CurrentPlayer,1)
  Debug "Side Mode 2: " &Missions(CurrentPlayer,2)
  Debug "Side Mode 3: " &Missions(CurrentPlayer,3)

  Debug "Dark String "& DarkString
  Debug "Party String: " &PartyString
  Debug "Items String: " &ItemString
  Debug "Monsters String: " &MonsterString

  Debug "Monster1 STATE: " &GIF_MA(0,0,1)
  Debug "Monster2 STATE: " &GIF_MA(1,0,1)
  Debug "Monster3 STATE: " &GIF_MA(2,0,1)
  Debug "Monster4 STATE: " &GIF_MA(3,0,1)

  Debug "P1:" &P1
  Debug "P2:" &P2
  Debug "P3:" &P3
  Debug "P4:" &P4

  Debug "M1:" &M1
  Debug "M2:" &M2
  Debug "M3:" &M3
  Debug "M4:" &M4

  Debug "BSMode: " & BSMode
  Debug "GMode: " & GMode
  Debug "TMode: " & TMode

  Debug "BallsRemaining: " & BallsRemaining(CurrentPlayer)
  Debug "Balls On Table:"  & UBound(BOT)

End Sub

Sub Dump2
Dim BOT
  BOT = GetBalls

  debug3 "Dumping State Info"
  debug3 "Mode 0: " &Mode(CurrentPlayer,0)
  debug3 "Mode 1: " &Mode(CurrentPlayer,1)
  debug3 "Mode 2: " &Mode(CurrentPlayer,2)
  debug3 "Mode 3: " &Mode(CurrentPlayer,3)
  debug3 "Mode 4: " &Mode(CurrentPlayer,4)
  debug3 "Mode 5: " &Mode(CurrentPlayer,5)
  debug3 "Mode 6: " &Mode(CurrentPlayer,6)
  debug3 "Mode 7: " &Mode(CurrentPlayer,7)
  debug3 "Mode 8: " &Mode(CurrentPlayer,8)
  debug3 "Mode 9: " &Mode(CurrentPlayer,9)
  debug3 "Mode 10: " &Mode(CurrentPlayer,10)
  debug3 "Mode 11: " &Mode(CurrentPlayer,11)
  debug3 "Mode 12: " &Mode(CurrentPlayer,12)
  debug3 "Mode 13: " &Mode(CurrentPlayer,13)
  debug3 "Mode 14: " &Mode(CurrentPlayer,14)


  debug3 "Side Mode 1: " &Missions(CurrentPlayer,1)
  debug3 "Side Mode 2: " &Missions(CurrentPlayer,2)
  debug3 "Side Mode 3: " &Missions(CurrentPlayer,3)

  debug3 "Dark String "& DarkString
  debug3 "Party String: " &PartyString
  debug3 "Items String: " &ItemString
  debug3 "Monsters String: " &MonsterString

  debug3 "Monster1 STATE: " &GIF_MA(0,0,1)
  debug3 "Monster2 STATE: " &GIF_MA(1,0,1)
  debug3 "Monster3 STATE: " &GIF_MA(2,0,1)
  debug3 "Monster4 STATE: " &GIF_MA(3,0,1)

  debug3 "P1:" &P1
  debug3 "P2:" &P2
  debug3 "P3:" &P3
  debug3 "P4:" &P4

  debug3 "M1:" &M1
  debug3 "M2:" &M2
  debug3 "M3:" &M3
  debug3 "M4:" &M4

  debug3 "BSMode: " & BSMode
  debug3 "GMode: " & GMode
  debug3 "TMode: " & TMode

  debug3 "BallsRemaining: " & BallsRemaining(CurrentPlayer)
  debug3 "Balls On Table:"  & UBound(BOT)

End Sub

Sub WarrensDMD
  'Debug "Loading WARRENS DMD Images"
    DOF 246, DOFOn
  StartDTs ' chance for Ambush -- needs to go exactly here
  Gi051.state = 1
  PickDungeonBG
  DisplayDungeonBG
  'GeneralPuPQueue.Add "Pup924","PuPEvent 924",78,0,0,0,0,True
  GeneralPuPQueue.Add "PDB-Wa","PuPDisplayBattle ""start warrens"" ",41,200,0,0,0,False
  AudioQueue.Add "Pup344","PuPEvent 344",40,0,0,0,0,False

  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,200,0,0,0,False
  GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,2200,0,0,0,False
End Sub
'-----------------------------------------------------------------------------------------
Sub StartWarrens
  'Table1.ColorGradeImage = OldLUT
  DisableInnLighting
  'ResetUPF
  'resetlights
  OldGI = "orange"
  ChangeGI orange
  monsterlightreset
  setMonsterLightColorGreen
  setUPFLightColorGreen
  Light010.state = 0
  Playsound "wood_door"

  AudioQueue.Add "SDM","StartDungeonMusic",20,1000,0,0,0,False

  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True

  if DMDType = 0 Then HideBG2 4100
  GeneralPuPQueue.Add "ResetPlayerImages","ResetPlayerImages",42,0,0,0,0,True
  GeneralPuPQueue.Add "Pup883","PuPEvent 883",40,0,0,0,0,True
  GeneralPuPQueue.Add "WarrensDMD","WarrensDMD",35,4100,0,0,0,false ' Ruins BG setup

  AudioQueue.Add "Pup228","PuPEvent 228",20,9120,0,0,AudioExpiry,False
  if DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup305","PuPEvent 305",12,0,0,0,0,True ' dmd guide

  BallGlow 4, 180, 15

  TorchesEnabled = 1

  if bRetry = False Then PickWarrensMonster:ResetMonsters
  if bRetry = True Then RestoreMonsterImages:RestoreUPFLights:RestoreMonsterLights
  bRetry = True

  Mode(CurrentPlayer,0) = 8
  Mode(CurrentPlayer,8) = 1
  SetModeTitle
  LoadChest ' Add Bad items to the chest
  li026.state=2 ' Turn on WARRENS light


  li038.state=0 ' Turn off Quest Light
  li047.state=0 ' inn light not blinking anymore
  li036.state=0 'leftramp
  li040.state=0  'rightramp
  li051.state=0 'orbits off
  li060.state=0
  li037.state=0
  DisableBallLock

  Debug "WARRENS - Monsters String: " &MonsterString

End Sub

Sub StopWarrens
  Torchtimer.enabled = 0
  HeroCountDownTimer.enabled = 0
  Pulse.Enabled = 0
  Mode(CurrentPlayer,8) = 0
  'SetModeTitle
  ClearGuideMessages
  PlayVillageMusic 100
  SetModeTitle
  ResetLights
  ClearDMDGuide:pupflasher1.visible = "False"
End Sub

Sub WinWarrens
  'Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,8) = 2
  GetAM
  ScorbitBuildGameModes
  'setMonsterLightColorWhite
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  'Debug " GOT HERE WTF"
  bRetry = False
  MonstersCleared = 1
  ClearDMDGuide
  DOFModesOff
  DungeonBonus = 1
  DungeonCountDown = 10
  DungeonTimerMessage1 = "Collect Dungeon Bonus"
  DungeonTimerMessage2 = "Shoot Center Scoop"
  'Triggerscript 10100, "ClearDungeonPup"
  'Triggerscript 10200, "DungeonBonusTimerExpired.enabled = 0"
  BallHandlingQueue.Add "ClearDungeonPup","ClearDungeonPup",70,10100,0,0,0,True
  BallHandlingQueue.Add "DBT-0","DungeonBonusTimerExpired.enabled = 0",70,10200,0,0,0,True
  DungeonBonusTimer.Enabled = 1
  DungeonBonusTimerExpired.Enabled = 1
  Torchtimer.enabled = 0
  li026.state=1 ' Warren turned On
  li038.state=2 ' Quest Flash
  li047.state=0 ' Inn Off
  Debug "Won Warrens "&AMCombo
  ResetLaneLights
  RandomSoundwin
  'Playsong "mu_plunger"
  ModeEnd "winwarrens"    ' should look to add this to start next mode
  InBattle = 0 ' prevent attribtutes from firing
  MonstersCleared = 1
  'triggerscript 300, "PuPHideBattle ""winwarrens"" "
  BallHandlingQueue.Add "PuPHideBattle-WW","PuPHideBattle ""winwarrens""",70,300,0,0,0,True
  CheckComplete
End Sub

Sub CheckTorchWin
LightEffect 2
'Dim Tmp
'Tmp = TorchTargets(0) + TorchTargets(1) + TorchTargets(2) + TorchTargets(3)
'Debug "CheckTorchWin: " &tmp
' if Tmp > 7 or RegionMonster(CurrentPlayer,Region) > 7 Then
  if RegionMonster(CurrentPlayer,Region) > 7 Then
    InTheDarkReset
    TorchTimer.Enabled = 0
    ClearMonsterImages
    WinInTheDark
    li047.state = 2
  End If
End Sub

Sub CheckWarrensWin
Dim Tmp
Tmp = WarrensTargets(0) + WarrensTargets(1) + WarrensTargets(2) + WarrensTargets(3)
  if Tmp = 8 Then
' if RegionMonster(CurrentPlayer,Region) > 7 then
    HeroCountDownReset
    HeroCountDownTimer.Enabled = 0
    pulse.enabled = 0
    ClearMonsterImages
    WinWarrens
    li038.state = 2
  End If
End Sub

Sub CheckDrownedWin
Dim Tmp
Tmp = DrownedTargets(0) + DrownedTargets(1) + DrownedTargets(2) + DrownedTargets(3)
  if Tmp = 8 Then
' if RegionMonster(CurrentPlayer,Region) > 7 then
    HeroCountDownReset
    HeroCountDownTimer.Enabled = 0
    pulse.enabled = 0
    ClearMonsterImages
    WinDrownedCrew
  End If
End Sub

'-----------------------------------------------------------------------------------------

Sub StopWizardMode
    Mode(CurrentPlayer,0) = 0
    Mode(CurrentPlayer,15) = 0
End Sub

Sub WinWizardMode
  Mode(CurrentPlayer,0) = 0
  Mode(CurrentPlayer,15) = 2
End Sub

'-----------------------------------------------------------------------------------------
Sub ItemsMaxed
  'Turn off lane lights since items maxed out
  li040.state = 0
  'li038.state = 0
  li047.state = 0
End Sub
'----------------------------------------------------------------------------------------
Sub CheckItems
ItemCount = 0
' Routine used to check what items have been collected and turn on associated Lights
' ItemsRTP(0) = Medicine
' ItemsRTP(1) = bandages
' ItemsRTP(2) = key
' ItemsRTP(3) = shovel
' ItemsRTP(4) = potion
' ItemsRTP(5) = Heart Attack
' ItemsRTP(6) = Madness
' ItemsRTP(7) = Bleed

  if ItemsRTP(CurrentPlayer,0) = 1 Then ItemCount = ItemCount + 1
  if ItemsRTP(CurrentPlayer,1) = 1 Then  ItemCount = ItemCount + 1
  if ItemsRTP(CurrentPlayer,2) = 1 Then  ItemCount = ItemCount + 1
  if ItemsRTP(CurrentPlayer,3) = 1 Then  ItemCount = ItemCount + 1
  if ItemsRTP(CurrentPlayer,4) = 1 Then  ItemCount = ItemCount + 1
  'if ItemsRTP(CurrentPlayer,5) = 1 Then ItemCount = ItemCount + 1
  'if ItemsRTP(CurrentPlayer,6) = 1 Then ItemCount = ItemCount + 1
  'if ItemsRTP(CurrentPlayer,7) = 1 Then ItemCount = ItemCount + 1

  if itemcount = 5 Then
    GetAM
    Select Case ActiveMode
    Case 1,3,5,7:
      if BallsInLock(CurrentPlayer) < 3 then li046.state = 2 ' turn on lock light as all items have been acquired
      ItemsMaxed
    End Select
  End if

End Sub

Sub CheckTotalItems
TotalItemCount = 0
' Routine used to check what items have been collected and turn on associated Lights
' ItemsRTP(0) = Medicine
' ItemsRTP(1) = bandages
' ItemsRTP(2) = key
' ItemsRTP(3) = shovel
' ItemsRTP(4) = potion
' ItemsRTP(5) = Heart Attack
' ItemsRTP(6) = Madness
' ItemsRTP(7) = Bleed

  if ItemsRTP(CurrentPlayer,0) = 1 Then TotalItemCount = TotalItemCount + 1
  if ItemsRTP(CurrentPlayer,1) = 1 Then  TotalItemCount = TotalItemCount + 1
  if ItemsRTP(CurrentPlayer,2) = 1 Then  TotalItemCount = TotalItemCount + 1
  if ItemsRTP(CurrentPlayer,3) = 1 Then  TotalItemCount = TotalItemCount + 1
  if ItemsRTP(CurrentPlayer,4) = 1 Then  TotalItemCount = TotalItemCount + 1
  if ItemsRTP(CurrentPlayer,5) = 1 Then TotalItemCount = TotalItemCount + 1
  if ItemsRTP(CurrentPlayer,6) = 1 Then TotalItemCount = TotalItemCount + 1
  if ItemsRTP(CurrentPlayer,7) = 1 Then TotalItemCount = TotalItemCount + 1
Debug "Total Item Count: " & TotalItemCount
End Sub


'-----------------------------------------------------------------------------------------------------------
Sub AddItem
   Dim tmp,tmp2
CheckItems
  if ItemCount < 5 Then
'   Select case RndNbr(5)
    tmp2 = rndItem(ItemsRTP,CurrentPlayer)
    Debug2 "ADDITEM -- " &tmp2
    Select case tmp2
      Case -1:
        MsgBox "Additem Error: -1 "
      Case 0: ' Medicine
          If ItemsRTP(CurrentPlayer,0) <> 0 Then
            AddItem
          Else
            AddScore 5000
            Debug "MEDICINE"
            AudioQueue.Add "Pup240","PuPEvent 240",30,0,0,0,AudioExpiry,False
            ItemsRTP(CurrentPlayer,0) = 1
            li027.state = 1
            DisplayItems 0
            checkItems
            CreateItemString
          End If
      Case 1: ' Bandages
          If ItemsRTP(CurrentPlayer,1) <> 0 Then
            AddItem
          Else
            AddScore 5000
            Debug "BANDAGES"
            AudioQueue.Add "Pup241","PuPEvent 241",30,0,0,0,AudioExpiry,False
            ItemsRTP(CurrentPlayer,1) = 1
            li028.state = 1
            DisplayItems 1
            Checkitems
            CreateItemString
          End If
      Case 2: ' Key
          If ItemsRTP(CurrentPlayer,2) <> 0 Then
            AddItem
          Else
            AddScore 5000
            Debug "KEY"
            AudioQueue.Add "Pup242","PuPEvent 242",30,0,0,0,AudioExpiry,False
            ItemsRTP(CurrentPlayer,2) = 1
            li029.state = 1
            DisplayItems 2
            Checkitems
            CreateItemString
          End If
      Case 3: ' Shovel
          If ItemsRTP(CurrentPlayer,3) <> 0 Then
            AddItem
          Else
            AddScore 5000
            Debug "SHOVEL"
            AudioQueue.Add "Pup243","PuPEvent 243",30,0,0,0,AudioExpiry,False
            ItemsRTP(CurrentPlayer,3) = 1
            li033.state = 1
            DisplayItems 3
            Checkitems
            CreateItemString
          End If
      Case 4: ' Potion
          If ItemsRTP(CurrentPlayer,4) <> 0 Then
            AddItem
          Else
            AddScore 5000
            Debug "Vial"
            AudioQueue.Add "Pup244","PuPEvent 244",30,0,0,0,AudioExpiry,False
            ItemsRTP(CurrentPlayer,4) = 1
            li034.state = 1
            DisplayItems 4
            Checkitems
            CreateItemString
          End If
      Case Else:
        MsgBox "Additem Error: -2 "
    End Select
  Else
    if PartySize(CurrentPlayer) > 3 Then li047.state = 0 ' turn off Inn light
    ' Do Nothing
  End If

End Sub

Sub DisplayItems2
  If ItemsRTP(CurrentPlayer,0) = 1 Then pBackglasslabelitemflash "medicine",1000,red
  If ItemsRTP(CurrentPlayer,1) = 1 Then pBackglasslabelitemflash "bandages",1000,red
  If ItemsRTP(CurrentPlayer,2) = 1 Then pBackglasslabelitemflash "key",1000,red
  If ItemsRTP(CurrentPlayer,3) = 1 Then pBackglasslabelitemflash "shovel",1000,red
  If ItemsRTP(CurrentPlayer,4) = 1 Then pBackglasslabelitemflash "potion",1000,red
End Sub

Sub CreateItemString
Dim f
  ItemString = ""
        For f = 0 to 4
      ItemString = ItemString &ItemsRTP(CurrentPlayer, f)
    Next

  'Debug "Item String: "&ItemString
  'PuPlayer.LabelSet pBackglass,"ItemString","Item " & ItemString,1,"{'mt':2,'color':4259584, 'size': 3, 'xpos': 88, 'xalign': 0, 'ypos': 80, 'yalign': 0 }"
End Sub
'-----------------------------------------------------------------------------------------------------------
Sub ClearItems
  pBackglasslabelhide "medicine"
  pBackglasslabelhide "bandage"
  pBackglasslabelhide "key"
  pBackglasslabelhide "shovel"
  pBackglasslabelhide "vial"
End Sub
'-----------------------------------------------------------------------------------------------------------
Sub ClearCharIcons
  pBackglasslabelhide "highwayman"
  pBackglasslabelhide "jester"
  pBackglasslabelhide "vestal"
  pBackglasslabelhide "plague"
  pBackglasslabelhide "occultist"
  pBackglasslabelhide "crusader"
  pBackglasslabelhide "grave"
  pBackglasslabelhide "hound"
End Sub
'-----------------------------------------------------------------------------------------------------------
Sub ResetItems
Dim n
        For n = 0 to 7
            ItemsRTP(CurrentPlayer, n) = 0
        Next

  pBackglasslabelhide "medicine"
  pBackglasslabelhide "bandages"
  pBackglasslabelhide "key"
  pBackglasslabelhide "shovel"
  pBackglasslabelhide "potion"
End Sub
'-----------------------------------------------------------------------------------------------------------

Sub CheckMonsters
'Debug "InCheckMonster: " & AMCombo
GetAM
Region = ActiveMode
  if RegionMonster(CurrentPlayer,Region) > 7 And Region <> 4 And Region <> 13 Then
    ' All Monsters Defeated
    InBattle = 0 ' Turn off battle flag to prevent attributes from firing
    HeroCountDownReset  '  set back to original value
    'HeroTimer.enabled = 0
    HeroCountDownTimer.Enabled = 0
    pulse.enabled = 0
    ResetLights
    Debug "Monsters defeated "&AMCombo
    GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True ' added in v119.5 to finally clear dmd guides since monsters are cleared
    MonstersCleared = 1
    WinMode(ActiveMode)
    RegionMonster(CurrentPlayer,Region) = 9 ' Make sure hurtmonster does not run again, prevent infinite loop
  End If
End Sub

Sub PartyMaxLightsOff
  'Turn off orbit lights since party is maxed out
  li060.state = 0
  li036.state = 0
  li037.state = 0
  li051.state = 0
End Sub

Sub CheckParty
CreatePartyString
  Debug "PartySize = " &PartySize(CurrentPlayer)
  if PartySize(CurrentPlayer) > 3 Then
    ' Party is complete so move onto Dungeon for that Region
    GetAM
    'Debug "CheckParty: "&AMCombo
    Select Case ActiveMode
      Case 1,3,5,7,9:
        if Mode(CurrentPlayer,ActiveMode) = 1 Then
          bMaxParty = True
          Debug "Max Party Size Reached - Calling WinMode: "&AMCombo
          PartyMaxLightsOff
          WinMode(ActiveMode)
          GetAM
        End If
      Case Else:
        'Do Nothing
    End Select
  End If
End Sub

Sub HideDungeonProgress
  PuPlayer.LabelSet pBackglass,"dungeonTitle", "" ,0,""
  PuPlayer.LabelSet pBackglass,"dungeonTitle2","",0,""
  PuPlayer.LabelSet pBackglass,"dungeon","" ,0,""
End Sub

Sub HideStrings
  PuPlayer.LabelSet pBackglass,"DarkString","",0,""
  PuPlayer.LabelSet pBackglass,"Partysize","",0,""
  PuPlayer.LabelSet pBackglass,"MonsterString","",0,""
  PuPlayer.LabelSet pBackglass,"ItemString","",0,""
  PuPlayer.LabelSet pBackglass,"ModeString","",0,""
  PuPlayer.LabelSet pBackglass,"TorchTimer","",0,""
End Sub

Sub DisplayDungeonProgress
Exit Sub
if inVideo = 0 Then
  Dim r,s
' GetAM
' Region = ActiveMode
  DungeonState = RegionMonster(CurrentPlayer,Region) &"/" & TotalMonsterHits
  'Debug "Display Dungeon Progress: " & ActiveMode
  Select Case ActiveMode
    Case 2: r = "Ruins": s = "Dungeon"
    Case 4: r = "Cove": s = "Dungeon"
    Case 6: r = "Weald": s = "Dungeon"
    Case 8: r = "Warrens": s = "Dungeon"
    Case 10: r = "Prophet": s = "Battle"
    Case 11: r = "Drowned Crew": s =  "Battle"
    Case 12: r = "Vvulf": s = "Battle"
    Case 13: r = "Swine Prince": s = "Battle"
    Case 14: r = "Shambler": s = "Battle"
    Case Else: r = "Dungeon": s = "Progress"
  End Select

  if DungeonState = "" Then DungeonState = "0/8"

' PuPlayer.LabelSet pBackglass,"dungeonTitle", r ,1,"{'mt':2,'color':33023, 'size': 5.5, 'xpos': 84., 'xalign': 1, 'ypos': 69, 'yalign': 0 }"
' PuPlayer.LabelSet pBackglass,"dungeonTitle2",s,1,"{'mt':2,'color':33023, 'size': 5.5, 'xpos': 84, 'xalign': 1, 'ypos': 75, 'yalign': 0 }"
  if Mode(CurrentPlayer,0) = 4 OR Mode(CurrentPlayer,0) = 13 Then
    'PuPlayer.LabelSet pBackglass,"dungeon",DungeonState ,1,"{'mt':2,'color': 255, 'size': 9, 'xpos': 84, 'xalign': 1, 'ypos': 82, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"dungeon",DungeonState ,1,"{'mt':2,'color': 33023, 'size': 1.75, 'xpos': 35.75, 'xalign': 1, 'ypos': 9.5, 'yalign': 0 }"
  Else
    PuPlayer.LabelSet pBackglass,"dungeon",DungeonState ,1,"{'mt':2,'color': 33023, 'size': 2, 'xpos': 35.85, 'xalign': 1, 'ypos': 9.35, 'yalign': 0 }"
  End If

End If
End Sub
'==============================================
Sub DungeonProgress ' Region values 0-9

GetAM

Region = ActiveMode
  If Mode(CurrentPlayer,0) = 0 AND Missions(CurrentPlayer,3) = 2 Then
    TotalMonsterHits = 8
    RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
    'DisplayDungeonProgress
      if  TorchTargets(0) =2 Then
        p61.material = "InsertWhiteOffTri": Li061.state = 0:Target006.image = "HitTarget"
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      Elseif TorchTargets(0) =1 Then
        p61.material = "InsertRedOnTri": Li061.state = 1:Target006.image = "HitTargetRed"
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      Elseif TorchTargets(1) =2 Then
        p62.material = "InsertWhiteOffTri": Li062.state = 0:Target007.image = "HitTarget"
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      Elseif TorchTargets(1) =1 Then
        p62.material = "InsertRedOnTri": Li062.state = 1:Target007.image = "HitTargetRed"
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      Elseif TorchTargets(2) =2 Then
        p63.material = "InsertWhiteOffTri": Li063.state = 0:Target008.image = "HitTarget"
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      Elseif TorchTargets(2) =1 Then
        p63.material = "InsertRedOnTri": Li063.state = 1:Target008.image = "HitTargetRed"
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      Elseif TorchTargets(3) =2 Then
        p64.material = "InsertWhiteOffTri": Li064.state = 0:Target009.image = "HitTarget"
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      Elseif TorchTargets(3) =1 Then
        p64.material = "InsertRedOnTri": Li064.state = 1:Target009.image = "HitTargetRed"
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        InTheDarkReset
        CheckTorchWin
      End If
  End If
'------------------
  if Mode(CurrentPlayer,0) = 2 Then
    TotalMonsterHits = 8
    if RegionMonster(CurrentPlayer,Region) = 6 Then AudioQueue.Add "Pup279","PuPEvent 279",25,0,0,0,AudioExpiry,True
    if RegionMonster(CurrentPlayer,Region) < 8 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      'DisplayDungeonProgress
      HoundCriticalCheck
    End If
    if RegionMonster(CurrentPlayer,Region) < 9 Then
      HurtMonster
    End if
  ElseIf Mode(CurrentPlayer,0) = 4 Then
    TotalMonsterHits = 24
      if RegionMonster(CurrentPlayer,Region) = 19 Then AudioQueue.Add "Pup279","PuPEvent 279",25,0,0,0,AudioExpiry,True

      if RegionMonster(CurrentPlayer,Region) < 24 Then
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        HoundCriticalCheck
      End If
      if  RegionMonster(CurrentPlayer,4) > 23 Then
        WinCove
        setlightcolor li024 , white, 0
        HeroTimer.enabled=0
        HeroCountDownTimer.Enabled = 0
        pulse.enabled = 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        li038.state = 2
        li047.state = 0
        MonstersCleared = 1
        DungeonBonusTimer.Enabled = 1
        DungeonBonusTimerExpired.Enabled = 1
        DungeonBonus = 1
        GIF_MA(0,0,1) = 2
        Monsters(CurrentPlayer,0) = 2
        'triggerscript 3100, "KillPuPMonster ""0"" "
        BattleQueue.Add "KillPuPMonster-0","KillPuPMonster ""0""",70,3100,0,0,0,True
      Elseif RegionMonster(CurrentPlayer,4) > 20 Then
        setlightcolor li024 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,0) = 1
      Elseif RegionMonster(CurrentPlayer,4) > 17 Then
        setlightcolor li025 , white, 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(1,0,1) = 2
        Monsters(CurrentPlayer,1) = 2
        'triggerscript 3100, "KillPuPMonster ""1"" "
        BattleQueue.Add "KillPuPMonster-1","KillPuPMonster ""1""",70,3100,0,0,0,True
      Elseif RegionMonster(CurrentPlayer,4) > 14 Then
        setlightcolor li025 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        GIF_MA(1,0,1) = 1
        Monsters(CurrentPlayer,1) = 1
      Elseif RegionMonster(CurrentPlayer,4) > 11 Then
        setlightcolor li008 , white, 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(2,0,1) = 2
        Monsters(CurrentPlayer,2) = 2
        'triggerscript 3100, "KillPuPMonster ""2"" "
        BattleQueue.Add "KillPuPMonster-2","KillPuPMonster ""2""",70,3100,0,0,0,True
      Elseif RegionMonster(CurrentPlayer,4) > 8 Then
        setlightcolor li008 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        GIF_MA(2,0,1) = 1
        Monsters(CurrentPlayer,2) = 1
      Elseif RegionMonster(CurrentPlayer,4) > 5 Then
        setlightcolor li006 , white, 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(3,0,1) = 2
        Monsters(CurrentPlayer,3) = 2
        'triggerscript 3100, "KillPuPMonster ""3"" "
        BattleQueue.Add "KillPuPMonster-3","KillPuPMonster ""3""",70,3100,0,0,0,True
      Elseif RegionMonster(CurrentPlayer,4) > 2 Then
        setlightcolor li006 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        GIF_MA(3,0,1) = 1
        Monsters(CurrentPlayer,3) = 1
      End If
  ElseIf Mode(CurrentPlayer,0) = 6 Then
    TotalMonsterHits = 8
    if RegionMonster(CurrentPlayer,Region) = 6  Then AudioQueue.Add "Pup279","PuPEvent 279",25,0,0,0,AudioExpiry,True
    if RegionMonster(CurrentPlayer,Region) < 8 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      Debug "MONSTER HITS: " &RegionMonster(CurrentPlayer,Region)
      'DisplayDungeonProgress
      HoundCriticalCheck
    End If
    if RegionMonster(CurrentPlayer,Region) < 9 Then
      HurtMonster
    End if
  ElseIf Mode(CurrentPlayer,0) = 8 Then
    TotalMonsterHits = 8
    'DisplayDungeonProgress
  ElseIf Mode(CurrentPlayer,0) = 10 Then
    TotalMonsterHits = 8
    if RegionMonster(CurrentPlayer,Region) = 6 Then AudioQueue.Add "Pup279","PuPEvent 279",25,0,0,0,AudioExpiry,True
    if RegionMonster(CurrentPlayer,Region) < 8 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 2
      'DisplayDungeonProgress
      HoundCriticalCheck
    End If
    if RegionMonster(CurrentPlayer,Region) < 9 Then
      HurtMonster
      HurtMonster
      GIF_MA(0,0,1) = 1
    End if
  ElseIf Mode(CurrentPlayer,0) = 11 Then
    TotalMonsterHits = 8
    if RegionMonster(CurrentPlayer,Region) = 6 Then AudioQueue.Add "Pup279","PuPEvent 279",25,0,0,0,AudioExpiry,True
    'DisplayDungeonProgress
  ElseIf Mode(CurrentPlayer,0) = 13 Then
    TotalMonsterHits = 24
    CreateMonsterString
    Debug "Monsters String: " &MonsterString
      if RegionMonster(CurrentPlayer,Region) = 19 Then AudioQueue.Add "Pup279","PuPEvent 279",25,0,0,0,AudioExpiry,True

      if RegionMonster(CurrentPlayer,Region) < 24 Then
        RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
        'DisplayDungeonProgress
        HoundCriticalCheck
      End If
      if  RegionMonster(CurrentPlayer,13) > 23 Then
        WinSwinePrince
        setlightcolor li024 , white, 0
        HeroCountDownTimer.Enabled = 0
        pulse.enabled = 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        li038.state = 2
        li047.state = 0
        MonstersCleared = 1
        DungeonBonusTimer.Enabled = 1
        DungeonBonusTimerExpired.Enabled = 1
        DungeonBonus = 1
        GIF_MA(0,0,1) = 2
        Monsters(CurrentPlayer,0) = 2
      Elseif RegionMonster(CurrentPlayer,13) > 20 Then
        setlightcolor li024 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,0) = 1
      Elseif RegionMonster(CurrentPlayer,13) > 17 Then
        setlightcolor li025 , white, 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,1) = 2
      Elseif RegionMonster(CurrentPlayer,13) > 14 Then
        setlightcolor li025 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,1) = 1
      Elseif RegionMonster(CurrentPlayer,13) > 11 Then
        setlightcolor li008 , white, 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,2) = 2
      Elseif RegionMonster(CurrentPlayer,13) > 8 Then
        setlightcolor li008 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,2) = 1
      Elseif RegionMonster(CurrentPlayer,13) > 5 Then
        setlightcolor li006 , white, 0
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,3) = 2
      Elseif RegionMonster(CurrentPlayer,13) > 2 Then
        setlightcolor li006 , red, 1
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,3) = 1
      End If
  End If
  'DisplayDungeonProgress ' 129.5
  'HoundMasterAlreadyAttacked = 0 ' moved to houndcriticalattack
End Sub

Sub ResetMonsters
Dim m
  For m = 0 to 3
    Monsters(CurrentPlayer,m) = 0
    GIF_MA(m,0,1) = 0
  Next

End Sub

Sub RestoreMonsterLights
    if GIF_MA(0,0,1) = 0 Then
      setlightcolor li006 , green, 1
    elseif GIF_MA(0,0,1) = 1 Then
      setlightcolor li006 , red, 1
    elseif GIF_MA(0,0,1) = 2 Then
      setlightcolor li006 , white, 0
    End If

    if GIF_MA(1,0,1) = 0 Then
      setlightcolor li008 , green, 1
    elseif GIF_MA(1,0,1) = 1 Then
      setlightcolor li008 , red, 1
    elseif GIF_MA(1,0,1) = 2 Then
      setlightcolor li008 , white, 0
    End If

    if GIF_MA(2,0,1) = 0 Then
      setlightcolor li024 , green, 1
    elseif GIF_MA(2,0,1) = 1 Then
      setlightcolor li024 , red, 1
    elseif GIF_MA(2,0,1) = 2 Then
      setlightcolor li024 , white, 0
    End If

    if GIF_MA(3,0,1) = 0 Then
      setlightcolor li025 , green, 1
    elseif GIF_MA(3,0,1) = 1 Then
      setlightcolor li024 , red, 1
    elseif GIF_MA(3,0,1) = 2 Then
      setlightcolor li025 , white, 0
    End If


End Sub

Sub RestoreUPFLights
    if GIF_MA(0,0,1) = 0 Then
      p61.material = "InsertGreenOnTri": Li061.state = 1:Target006.image = "HitTargetGreen"
    elseif GIF_MA(0,0,1) = 1 Then
      p61.material = "InsertRedOnTri": Li061.state = 1:Target006.image = "HitTargetRed"
    elseif GIF_MA(0,0,1) = 2 Then
      p61.material = "InsertWhiteOffTri": Li061.state = 0:Target006.image = "HitTarget"
    End If

    if GIF_MA(1,0,1) = 0 Then
      p62.material = "InsertGreenOnTri": Li062.state = 1:Target007.image = "HitTargetGreen"
    elseif GIF_MA(1,0,1) = 1 Then
      p62.material = "InsertRedOnTri": Li062.state = 1:Target007.image = "HitTargetRed"
    elseif GIF_MA(1,0,1) = 2 Then
      p62.material = "InsertWhiteOffTri": Li062.state = 0:Target007.image = "HitTarget"
    End If

    if GIF_MA(2,0,1) = 0 Then
      p63.material = "InsertGreenOnTri": Li063.state = 1:Target008.image = "HitTargetGreen"
    elseif GIF_MA(2,0,1) = 1 Then
      p63.material = "InsertRedOnTri": Li063.state = 1:Target008.image = "HitTargetRed"
    elseif GIF_MA(2,0,1) = 2 Then
      p63.material = "InsertWhiteOffTri": Li063.state = 0:Target008.image = "HitTarget"
    End If

    if GIF_MA(3,0,1) = 0 Then
      p64.material = "InsertGreenOnTri": Li064.state = 1:Target009.image = "HitTargetGreen"
    elseif GIF_MA(3,0,1) = 1 Then
      p64.material = "InsertRedOnTri": Li064.state = 1:Target009.image = "HitTargetRed"
    elseif GIF_MA(3,0,1) = 2 Then
      p64.material = "InsertWhiteOffTri": Li064.state = 0:Target009.image = "HitTarget"
    End If
End Sub

Sub HurtMonster
  if RegionMonster(CurrentPlayer,Region) > 8 Then Exit Sub

  Select Case rndMonster(Monsters,CurrentPlayer)
    Case -1:
        MsgBox "HurtMonster Error: - 1 "
    Case 0:
      if GIF_MA(0,0,1) <> 2 Then
        if GIF_MA(0,0,1) = 0 Then
          Monsters(CurrentPlayer,0) = 1
          GIF_MA(0,0,1) = 1
          setlightcolor li006 , red, 1
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        Else
          GIF_MA(0,0,1) = 2
          Monsters(CurrentPlayer,0) = 2
          setlightcolor li006 , white, 0
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
          AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
          HeroTimerReset
          if ActiveMode < 10 Then
            PlayerAttack
            GIF_MA(0,0,1) = 2
            'triggerscript 3100,  "KillPuPMonster ""3"" "
            BattleQueue.Add "KillPuPMonster-3","KillPuPMonster ""3""",70,3100,0,0,0,True
          End If
          CheckMonsters
        End If
      Else
'       Debug " Monster 1 already dead"
        HurtMonster
      End If
    Case 1:
      if GIF_MA(1,0,1) <> 2 Then
        if GIF_MA(1,0,1) = 0 Then
          Monsters(CurrentPlayer,1) = 1
          GIF_MA(1,0,1) = 1
          setlightcolor li008 , red, 1
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        Else
          GIF_MA(1,0,1) = 2
          Monsters(CurrentPlayer,1) = 2
          setlightcolor li008 , white, 0
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
          AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
          HeroTimerReset
          if ActiveMode < 10 Then
            PlayerAttack
            GIF_MA(1,0,1) = 2
            BattleQueue.Add "KillPuPMonster-2","KillPuPMonster ""2""",70,3100,0,0,0,True
            'triggerscript 3100,  "KillPuPMonster ""2"" "
          End If
          CheckMonsters
        End If
      Else
'       Debug " Monster 2 already dead"
        HurtMonster
      End If
    Case 2:
      if GIF_MA(2,0,1) <> 2 Then
        if GIF_MA(2,0,1) = 0 Then
          Monsters(CurrentPlayer,2) = 1
          GIF_MA(2,0,1) = 1
          setlightcolor li024 , red, 1
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        Else
          GIF_MA(2,0,1) = 2
          Monsters(CurrentPlayer,2) = 2
          setlightcolor li024 , white, 0
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
          AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
          HeroTimerReset
          CheckMonsters
          if ActiveMode < 10 Then
            PlayerAttack
            GIF_MA(2,0,1) = 2
            BattleQueue.Add "KillPuPMonster-0","KillPuPMonster ""0""",70,3100,0,0,0,True
            'triggerscript 3100,  "KillPuPMonster ""0"" "
          End If
        End If
      Else
'       Debug " Monster 3 already dead"
        HurtMonster
      End If
    Case 3:
      if GIF_MA(3,0,1) <> 2 Then
        if GIF_MA(3,0,1) = 0 Then
          Monsters(CurrentPlayer,3) = 1
          GIF_MA(3,0,1) = 1
          setlightcolor li025 , red, 1
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        Else
          GIF_MA(3,0,1) = 2
          Monsters(CurrentPlayer,3) = 2
          setlightcolor li025 , white, 0
          AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
          AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
          HeroTimerReset
          if ActiveMode < 10 Then
            PlayerAttack
            GIF_MA(3,0,1) = 2
            BattleQueue.Add "KillPuPMonster-1","KillPuPMonster ""1""",70,3100,0,0,0,True
            'triggerscript 3100,  "KillPuPMonster ""1"" "
          End If
          CheckMonsters
        End If
      Else
'       Debug " Monster 4 already dead"
        HurtMonster
      End If
    Case Else:
      Debug " HurtMonster - Should never get here"
  End Select

CreateMonsterString
End Sub

Sub HideScore(ms)
' Debug "Called Hide Scores: " & ms
  InGuide = 1
  triggerscript ms,"InGuide = 0 "
  triggerscript ms+100, "UpdateDMD "
End Sub



'============================================
Sub PlayerAttack

if PartySize(CurrentPlayer) < 1 Then Exit sub
  Debug "In PlayerAttack"
  'HoundMasterAlreadyAttacked = 0  ' moved to end of dungeonprogress
' if activemode = 4 or activemode = 13 Then Exit Sub ' do not continue for swine prince batttle or Cove
  if Mode(CurrentPlayer,0) > 8 Then Exit Sub

  ClearDMDGuide


Dim r
'FindAliveChar
r = rndArrayCol3d(GIF_CA)


'Debug "In sub player attack: " & r
  TotalMonsters(CurrentPlayer) = TotalMonsters(CurrentPlayer) + 1
  if DMDType = 2 Then
    HideDMD 3500, True
  Else
    pup2helper 3200
  End If

  if GIF_CA(r,0,0) = "graveAni" Then
    GeneralPuPQueue.Add "Pup708","PuPEvent 708",15,0,0,0,ShortPuPExpiry,False
  elseif GIF_CA(r,0,0) = "highwaymanAni" Then
    GeneralPuPQueue.Add "Pup710","PuPEvent 710",15,0,0,0,ShortPuPExpiry,False
  elseif GIF_CA(r,0,0) = "jesterAni" Then
    GeneralPuPQueue.Add "Pup711","PuPEvent 711",15,0,0,0,ShortPuPExpiry,False
  elseif GIF_CA(r,0,0) = "vestalAni" Then
    GeneralPuPQueue.Add "Pup712","PuPEvent 712",15,0,0,0,ShortPuPExpiry,False
  elseif GIF_CA(r,0,0) = "plagueAni" Then
    GeneralPuPQueue.Add "Pup713","PuPEvent 713",15,0,0,0,ShortPuPExpiry,False
  elseif GIF_CA(r,0,0) = "occultistAni" Then
    GeneralPuPQueue.Add "Pup714","PuPEvent 714",15,0,0,0,ShortPuPExpiry,False
  elseif GIF_CA(r,0,0) = "crusaderAni" Then
    GeneralPuPQueue.Add "Pup715","PuPEvent 715",15,0,0,0,ShortPuPExpiry,False
  elseif GIF_CA(r,0,0) = "houndAni" Then
    GeneralPuPQueue.Add "Pup709","PuPEvent 709",15,0,0,0,ShortPuPExpiry,False
  End If

End Sub
'============================================
Sub ReDisplayGuide
GetAM
'ClearDMDGuide
Debug "In RedisplayGuide"

if MonstersCleared = 0 Then

  Select Case ActiveMode
    Case 2:
      GeneralPuPQueue.Add "Pup302","PuPEvent 302",12,0,0,0,0,True
    Case 4:
      GeneralPuPQueue.Add "Pup303","PuPEvent 303",12,0,0,0,0,True
    Case 6:
      GeneralPuPQueue.Add "Pup304","PuPEvent 304",12,0,0,0,0,True
    Case 8:
      GeneralPuPQueue.Add "Pup305","PuPEvent 305",12,0,0,0,0,True
    Case 10:
      GeneralPuPQueue.Add "Pup306","PuPEvent 306",14,0,0,0,0,True
    Case 11:
      GeneralPuPQueue.Add "Pup307","PuPEvent 307",14,0,0,0,0,True
    Case 12:
      GeneralPuPQueue.Add "Pup308","PuPEvent 308",14,0,0,0,0,True
    Case 13:
      GeneralPuPQueue.Add "Pup309","PuPEvent 309",14,0,0,0,0,True
    End Select
End If
End Sub
'============================================
Sub MonsterAttack
GetAM
ClearDMDGuide

  if DMDType = 2 Then
    HideDMD 3200, True
  Else
    pup2helper 3300
  End If

Select Case ActiveMode
  Case 0,1,3,5,7,9,15:
    ' Do Nothing
  Case 2:
    GeneralPuPQueue.Add "Pup724","PuPEvent 724",16,0,0,0,GenPuPExpiry,False
  Case 4:
    GeneralPuPQueue.Add "Pup722","PuPEvent 722",16,0,0,0,GenPuPExpiry,False
  Case 6:
    GeneralPuPQueue.Add "Pup721","PuPEvent 721",16,0,0,0,GenPuPExpiry,False
  Case 8:
    GeneralPuPQueue.Add "Pup723","PuPEvent 723",16,0,0,0,GenPuPExpiry,False
' Case 2,4,6,8:
  'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
'   Dim T
'   T = RndNbr(4)
' Debug "In sub monster attack: " & T & ":" & MonsterString
'     Select Case T
'       Case 1:
'         PuPEvent 721 ' Display attack for Skeleton
'       Case 2:
'         PuPEvent 722 ' Display attack for Fish
'
'       Case 3:
'         PuPEvent 723 ' Display Attack for Captain
'
'       Case 4:
'         PuPEvent 724 ' Display attack for ghoul
'     End Select ' end of second select
  'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
        Case 10:
          GeneralPuPQueue.Add "Pup725","PuPEvent 725",16,0,0,0,GenPuPExpiry,False ' Display attack for prophet
        Case 11:
          GeneralPuPQueue.Add "Pup726","PuPEvent 726",16,0,0,0,GenPuPExpiry,False
        Case 12:
          GeneralPuPQueue.Add "Pup727","PuPEvent 727",16,0,0,0,GenPuPExpiry,False
        Case 13:
          GeneralPuPQueue.Add "Pup728","PuPEvent 728",16,0,0,0,GenPuPExpiry,False
        Case 14:
          GeneralPuPQueue.Add "Pup729","PuPEvent 729",16,0,0,0,GenPuPExpiry,False
        Case Else:
          MsgBox "ERROR: Monster Attack: "&ActiveMode
  End Select

End Sub
'============================================

Sub AddPartyMember
GetAM
Dim tmpChar
if "grave" = NextChar Then
  tmpChar = 1
elseif "highwayman" = NextChar Then
  tmpChar = 2
Elseif "jester" = NextChar Then
  tmpChar = 3
Elseif "vestal" = NextChar Then
  tmpChar = 4
Elseif "plague" = NextChar Then
  tmpChar = 5
Elseif "occultist" = NextChar Then
  tmpChar = 6
Elseif "crusader" = NextChar Then
  tmpChar = 7
Elseif "hound" = NextChar Then
  tmpChar = 8
Else
  msgbox "Error in AddPartyMember:" &NextChar
End If

  Debug2 "Calling AddPartyMember:"&PartySize(CurrentPlayer) & ":" & NextChar
  if PartySize(CurrentPlayer) < 4 Then
    'Pick Party Member to Add
    Select Case tmpChar
      Case 1:
          AddScore2 25000
          Party(CurrentPlayer,0) = 1  ' Add GraveRobber
          li014.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
          GeneralPupQueue.Add "Pup817","pupevent 817",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addgrave"
          SetPuPCharLocation "graveAni", "GraveDead"
          DisplayCharIcons 0, "addparty"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case 2:
          AddScore2 25000
          Party(CurrentPlayer,1) = 1  ' Add HwyMan
          li010.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
          GeneralPupQueue.Add "Pup810","pupevent 810",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addhwy"
          SetPuPCharLocation "highwaymanAni","HighwaymanDead"
          DisplayCharIcons 1, "addparty"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case 3:
          AddScore2 25000
          Party(CurrentPlayer,2) = 1  ' Add Jester
          li011.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
          GeneralPupQueue.Add "Pup811","pupevent 811",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addjester"
          SetPuPCharLocation "jesterAni","JesterDead"
          DisplayCharIcons 2, "addparty"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case 4:
          AddScore2 25000
          Party(CurrentPlayer,3) = 1 ' Add Healer
          li012.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
          GeneralPupQueue.Add "Pup812","pupevent 812",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addvestal"
          DisplayCharIcons 3, "addparty"
          SetPuPCharLocation "vestalAni","VestalDead"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case 5:
          AddScore2 25000
          Party(CurrentPlayer,4) = 1  ' Add Plague DR
          li007.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
          GeneralPupQueue.Add "Pup813","pupevent 813",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addplague"
          DisplayCharIcons 4, "addparty"
          SetPuPCharLocation "plagueAni","PlagueDead"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case 6:
          AddScore2 25000
          Party(CurrentPlayer,5) = 1 ' Add Occultist
          li009.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
          GeneralPupQueue.Add "Pup814","pupevent 814",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addoccultist"
          DisplayCharIcons 5, "addparty"
          SetPuPCharLocation "occultistAni","OccultistDead"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case 7:
          AddScore2 25000
          Party(CurrentPlayer,6) = 1 ' Add Knight
          li013.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
          GeneralPupQueue.Add "Pup815","pupevent 815",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addcrusader"
          DisplayCharIcons 6, "addparty"
          SetPuPCharLocation "crusaderAni","CrusaderDead"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case 8:
          AddScore2 25000
          Party(CurrentPlayer,7) = 1 ' Add Hound
          li023.State = 1
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) + 1
          CheckParty
          'if DMDType = 0 Then HideBG2 5000
'         Debug " Added Hound "&PartySize(CurrentPlayer)
          GeneralPupQueue.Add "Pup816","pupevent 816",30,100,0,0,GenPuPExpiry,False
          ReturnOverlay "addhound"
          DisplayCharIcons 7, "addparty"
          SetPuPCharLocation "houndAni","HoundDead"
            If PartySize(CurrentPlayer) > 3 AND BallsInLock(CurrentPlayer) < 3 Then
              'CheckParty
              ClearDMDGuide
              if DMDType <> 2 Then pupflasher1.visible=false
'             Debug " Party at Max Size"
            End If
      Case Else:
        MsgBox "Error: addparty: " &tmpChar
        Debug " AddParty: Should not get here: " & tmpChar
    End Select

  PreviewNextChar  ' load the next character
  Else
    Debug "Party Reached Max Size"
  End If

End Sub
'============================================
Sub EnableBallLock
  Debug "Enabling Ball Locking"
  if BallsInLock(CurrentPlayer) < 3 Then
    bLockEnabled = True
    li046.State = 2
  End If
End Sub

Sub DisableBallLock
  Debug "Disabling Ball Locking"
  bLockEnabled = False
  li046.State = 0
  TrapdoorDown
End Sub

'--------------------------------------------------------------------------------------
Sub SetPuPCharLocation (Char, CharDead)
' Figure out Character
Debug "*********** In SetPupChar Location "& Char
  If P1 = "" Then
    P1 = Char
    GIF_CA(0,0,0) = Char
    GIF_CA(0,1,0) = CharDead
    GIF_CA(0,0,1) = 1 ' bring them to life
  ElseIf P2 = "" Then
    P2 = Char
    GIF_CA(1,0,0) = Char
    GIF_CA(1,1,0) = CharDead
    GIF_CA(1,0,1) = 1 ' bring them to life
  ElseIf P3 = "" Then
    P3 = Char
    GIF_CA(2,0,0) = Char
    GIF_CA(2,1,0) = CharDead
    GIF_CA(2,0,1) = 1 ' bring them to life
  ElseIf P4 = "" Then
    P4 = Char
    GIF_CA(3,0,0) = Char
    GIF_CA(3,1,0) = CharDead
    GIF_CA(3,0,1) = 1 ' bring them to life
  End if
End Sub

'--------------------------------------------------------------------------------------
Sub FindAliveChar
Debug "FindAliveChar"
CharPosition = ""
Dim r
  r = RndNbr(4)
  r = r-1
    if GIF_CA(r,0,1) = 1 Then
      CharPosition = r
    Else
      FindAliveChar
    End If

End Sub
'--------------------------------------------------------------------------------------
Sub FindChar (Char)
Debug "FindChar"
CharPosition = ""
Dim r
  For r = 0 to 3
    if GIF_CA(r,0,0) = Char Then
      CharPosition = r
    End If
  Next

End Sub
'--------------------------------------------------------------------------------------
Sub KillCharGIF (Char)
Debug "KillChar"
Dim r
  For r = 0 to 3
    if GIF_CA(r,0,0) = Char Then
      GIF_CA(r,0,1) = 0
      CharPosition = r
    End If
  Next

KillPupChar2
End Sub
'--------------------------------------------------------------------------------------
Sub FindMonster (Mon)
Debug "FindMonster"
MonPosition = ""
Dim r
  For r = 0 to 3
    if GIF_MA(r,0,0) = Mon Then
      MonPosition = r
    End If
  Next

End Sub
'--------------------------------------------------------------------------------------
Sub CreatePartyString
Dim f
PartyString = ""
        For f = 0 to 7
      PartyString = PartyString &Party(CurrentPlayer, f)
    Next

End Sub

Dim remChar

Sub RemovePartyMember
bBossDefeatedFullParty = False ' Reset this flag
remChar = ""
Debug "In Remove Party"
  GetAM

  if PartySize(CurrentPlayer) > 0 Then
    MonsterAttack
    bMaxParty = False
    'Pick Party Member to Add
    remChar = rndArrayCol(Party,CurrentPlayer)
    Select Case remChar
      Case -1:
          MsgBox "RemovePartyMember Error: -1"
          Exit Sub ' party is empty
      Case 0:
        if Party(CurrentPlayer,0) = 1 Then
          Party(CurrentPlayer,0) = 0  ' Remove Grave
          li014.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed Grave " & HeroCountDown
          HideCharIcons 0
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe0","PuPHideBattle ""Party Wipe0"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 0":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
            'PuPEvent 101
          Else
            GeneralPuPQueue.Add "Pup941","PupEvent 941",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "graveAni"
            BattleQueue.Add "KillCharGIF-Grave","KillCharGIF ""graveAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-Grave","KillPupChar ""graveAni"", ""GraveDead"" ",70,3100,0,0,0,True
            'KillPupChar "graveAni", "GraveDead" ' Only try to display this image if party is not wiped
          End If
          HeroCountDownReset
        Else
'         Debug "Grave Not in Party"
          RemovePartyMember
        end If
      Case 1:
        if Party(CurrentPlayer,1) = 1 Then
          Party(CurrentPlayer,1) = 0  ' Remove HwyMan
          li010.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed HwyMan " & HeroCountDown
          HideCharIcons 1
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe1","PuPHideBattle ""Party Wipe1"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 1":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
          Else
            GeneralPuPQueue.Add "Pup942","PupEvent 942",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "highwaymanAni"
            'KillPupChar "highwaymanAni", "HighwaymanDead" ' Only try to display this image if party is not wiped
            BattleQueue.Add "KillCharGIF-hwy","KillCharGIF ""highwaymanAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-hwy","KillPupChar ""highwaymanAni"", ""HighwaymanDead"" ",70,3100,0,0,0,True
          End If
          HeroCountDownReset
        Else
'         Debug "HwyMan Not in Party"
          RemovePartyMember
        end If
      Case 2:
        if Party(CurrentPlayer,2) = 1 Then
          Party(CurrentPlayer,2) = 0  ' Remove Jester
          li011.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed Jester " & HeroCountDown
          HideCharIcons 2
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe2","PuPHideBattle ""Party Wipe2"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 2":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
          Else
            GeneralPuPQueue.Add "Pup943","PupEvent 943",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "jesterAni"
            'KillPupChar "jesterAni", "JesterDead"' Only try to display this image if party is not wiped
            BattleQueue.Add "KillCharGIF-jester","KillCharGIF ""jesterAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-jester","KillPupChar ""jesterAni"", ""JesterDead"" ",70,3100,0,0,0,True
          End If
          HeroCountDownReset
        Else
'         Debug "Jester Not in Party"
          RemovePartyMember
        end If
      Case 3:
        if Party(CurrentPlayer,3) = 1 Then
          Party(CurrentPlayer,3) = 0 ' Remove Vestal
          li012.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed Healer " & HeroCountDown
          HideCharIcons 3
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe3","PuPHideBattle ""Party Wipe3"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 3":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
          Else
            GeneralPuPQueue.Add "Pup944","PupEvent 944",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "vestalAni"
            'KillPupChar "vestalAni", "VestalDead"' Only try to display this image if party is not wiped
            BattleQueue.Add "KillCharGIF-vestal","KillCharGIF ""vestalAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-vestal","KillPupChar ""vestalAni"", ""VestalDead"" ",70,3100,0,0,0,True
          End If
          HeroCountDownReset
        Else
'         Debug "Healer Not in Party"
          RemovePartyMember
        end If
      Case 4:
        if Party(CurrentPlayer,4) = 1 Then
          Party(CurrentPlayer,4) = 0  ' Remove Plague DR
          li007.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed Plague DR " & HeroCountDown
          HideCharIcons 4
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe4","PuPHideBattle ""Party Wipe4"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 4":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
          Else
            GeneralPuPQueue.Add "Pup945","PupEvent 945",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "plagueAni"
            'KillPupChar "plagueAni", "PlagueDead"' Only try to display this image if party is not wiped
            BattleQueue.Add "KillCharGIF-plague","KillCharGIF ""plagueAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-plague","KillPupChar ""plagueAni"", ""PlagueDead"" ",70,3100,0,0,0,True
          End If
          HeroCountDownReset
        Else
'         Debug "Plague DR Not in Party"
          RemovePartyMember
        end If
      Case 5:
        if Party(CurrentPlayer,5) = 1 Then
          Party(CurrentPlayer,5) = 0 ' Remove Occultist
          li009.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed Occultist " & HeroCountDown
          HideCharIcons 5
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe5","PuPHideBattle ""Party Wipe5"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 5":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
          Else
            GeneralPuPQueue.Add "Pup946","PupEvent 946",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "occultistAni"
            'KillPupChar "occultistAni", "OccultistDead"' Only try to display this image if party is not wiped
            BattleQueue.Add "KillCharGIF-occ","KillCharGIF ""occultistAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-occ","KillPupChar ""occultistAni"", ""OccultistDead"" ",70,3100,0,0,0,True
          End If
          HeroCountDownReset
        Else
'         Debug "Occultist Not in Party"
          RemovePartyMember
        end If
      Case 6:
        if Party(CurrentPlayer,6) = 1 Then
          Party(CurrentPlayer,6) = 0 ' Remove Crusader
          li013.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed Knight " & HeroCountDown
          HideCharIcons 6
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe6","PuPHideBattle ""Party Wipe6"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 6":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
          Else
            GeneralPuPQueue.Add "Pup947","PupEvent 947",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "crusaderAni"
            'KillPupChar "crusaderAni", "CrusaderDead"' Only try to display this image if party is not wiped
            BattleQueue.Add "KillCharGIF-crusader","KillCharGIF ""crusaderAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-crusader","KillPupChar ""crusaderAni"", ""CrusaderDead"" ",70,3100,0,0,0,True
          End If
          HeroCountDownReset
        Else
'         Debug "Knight Not in Party"
          RemovePartyMember
        end If
      Case 7:
        if Party(CurrentPlayer,7) = 1 Then
          Party(CurrentPlayer,7) = 0 ' Remove Hound
          li023.State = 0
          PartySize(CurrentPlayer) = PartySize(CurrentPlayer) - 1
          CreatePartyString
          Debug " Removed Hound " & HeroCountDown
          HideCharIcons 7
          If PartySize(CurrentPlayer) < 1 Then
            GeneralPupQueue.Add "PartyWipe7","PuPHideBattle ""Party Wipe7"" ",98,0,0,0,0,True
            AudioQueue.Add "Pup278","PuPEvent 278",40,0,0,0,AudioExpiry,False
            GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            ModeFail "party 7":pNote "YOU","SUCK":Debug "Party Wiped"
            PartySize(CurrentPlayer) = 0
            BallHandlingQueue.Add "ReturnToVillage","ReturnToVillage",70,200,0,0,0,False
          Else
            GeneralPuPQueue.Add "Pup948","PupEvent 948",23,0,0,0,GenPuPExpiry,False
            'KillCharGIF "houndAni"
            'KillPupChar "houndAni", "HoundDead"' Only try to display this image if party is not wiped
            BattleQueue.Add "KillCharGIF-hound","KillCharGIF ""houndAni"" ",70,0,0,0,0,True
            BattleQueue.Add "KillPupChar-hound","KillPupChar ""houndAni"", ""HoundDead"" ",70,3100,0,0,0,True
          End If
          HeroCountDownReset
        Else
'         Debug "Hound Not in Party"
          RemovePartyMember
        end If
      Case Else:
        MsgBox "Error: RemovePartyMember " &remChar
        Debug " RemoveParty: Should not get here"
    End Select

'   RemovePartyMemberLights
  Else ' Everyone is DEAD
    'MsgBox "Error: RemovePartyMember-ELSE " &remChar
    Debug " Should not get here"

  End If

  if Mode(CurrentPlayer,0) = 14 And PartySize(CurrentPlayer) < 2 Then
    AddPartyMember  ' Add two more party members so that wizard mode can be achieved
    AddPartyMember
  End If

End Sub

Sub CreateMonsterString
Dim m
MonsterString = ""
        For m = 0 to 3
        MonsterString = MonsterString & Monsters(CurrentPlayer,m)
      'MonsterString = MonsterString &GIF_MA(m,0,1)
        Next

'Debug "MonsterString: "&MonsterString
  'PuPlayer.LabelSet pBackglass,"MonsterString","Monster " & MonsterString,1,"{'mt':2,'color':16744576, 'size': 3, 'xpos': 88, 'xalign': 0, 'ypos': 77, 'yalign': 0 }"
End Sub

'============================================


Sub HoundCriticalCheck
  if Party(CurrentPlayer,7) = 1 Then
    Randomize
    Dim tmp1
    tmp1 = rndArrayCol(Party,CurrentPlayer)
      Select Case tmp1
        Case 7:
          if HoundMasterAlreadyAttacked = 0 Then
            HoundMasterAlreadyAttacked = 1
            if DMDType = 2 Then
              GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
              BallHandlingQueue.Add "ReDisplayGuide","ReDisplayGuide",50,4200,0,0,0,True
              BallHandlingQueue.Add "UpdateDMD","UpdateDMD",40,4300,0,0,0,False
              'triggerscript 4200, "ReDisplayGuide"
              'Triggerscript 4300, "UpdateDMD"
            Else
              pup2helper 4000
            End If
            GeneralPuPQueue.Add "Pup877","PuPEvent 877",38,0,0,0,GenPuPExpiry,False
            DungeonProgress
            'Debug "HoundMaster EXTRA Attack!!"
          End If
        Case Else:
            HoundMasterAlreadyAttacked = 0
        End Select
  End If
End Sub

Sub HoundCriticalCheck2  ' not being used - was for testing
  if Party(CurrentPlayer,7) = 1 Then
    Dim tmp2
    tmp2 = RndNbr(7)
      Select Case tmp2
        Case 1:
          if Party(CurrentPlayer,0) = 0 Then
            HoundCriticalCheck
          End If
        Case 2:
          if Party(CurrentPlayer,1) = 0 Then
            HoundCriticalCheck
          End If
        Case 3:
          if Party(CurrentPlayer,3) = 0 Then
            HoundCriticalCheck
          End If
        Case 4:
          if Party(CurrentPlayer,4) = 0 Then
            HoundCriticalCheck
          End If
        Case 5:
          if Party(CurrentPlayer,5) = 0 Then
            HoundCriticalCheck
          End If
        Case 6:
          if Party(CurrentPlayer,6) = 0 Then
            HoundCriticalCheck
          End If
        Case 7:
          if HoundMasterAlreadyAttacked = 0 Then
            HoundMasterAlreadyAttacked = 1
            DungeonProgress
            Debug "HoundMaster EXTRA Attack!!"
          End If
        End Select
  End If
End Sub

Sub ClearAllHelpers
' used to clean up any lingering messages on the screen
  HideHelper
  HideKeyAward
  HideInTheDarkMessages
  ClearBlacksmithPup
  ClearGambleCountDownPup
  ClearCountDownPup
  HideGambleRampHits
  HideGamblePoints
  ClearDungeonPup
  ClearDungeonPup2

  BallHandlingQueue.Add "HideTotalMessage","HideTotalMessage",70,15000,0,0,0,True
  BallHandlingQueue.Add "ClearBonusMessage","ClearBonusMessage",70,15010,0,0,0,True

  'triggerscript 15000, "HideTotalMessage"  ' delay due to drain_hit
  'triggerscript 15000, "ClearBonusMessage"  'delay call due to drain_hit
End Sub

Sub ResetTrapDoorImages
  trapdoorA.image = "plasticsNew"
  trapdoorC.image = "plasticsNew"
End Sub

Sub ChangeCryptImages
  trapdoorA.image = "plasticsCrypt"
  trapdoorC.image = "plasticsCrypt"
End Sub

' *********************************************************************
'                      Drain / Plunger Functions
' *********************************************************************

' lost a ball ;-( check to see how many balls are on the playfield.
' if only one then decrement the remaining count AND test for End of game
' if more than 1 ball (multi-ball) then kill of the ball but don't create
' a new one
'
Sub Drain_Hit()
  Debug2 "****************************************************************************"
  Debug2 "********************** DRAIN HIT ****************************************"
  Debug2 "****************************************************************************"

GetAM
LastMode = ActiveMode

  ClearAllHelpers

CreatePartyString
Debug "PartySting on Exit: " &PartyString


    ' Destroy the ball
    Drain.DestroyBall
    If bGameInPLay = False Then Exit Sub 'don't do anything, just delete the ball
    ' Exit Sub ' only for debugging - this way you can add balls from the debug window

    BallsOnPlayfield = BallsOnPlayfield - 1
  Debug2 "Drain Hit- BoP: " & BallsOnPlayfield
  Debug "Drain Hit2 " & AMCombo
    ' pretend to knock the ball into the ball storage mech
    RandomSoundDrain Drain
   ' DOF 109, DOFPulse  'Darrin
    'if Tilted the end Ball Mode
    If Tilted Then
        ModeFail "Tilt"
    ReturnToVillage
    End If

    ' if there is a game in progress AND it is not Tilted
    If (bGameInPLay = True) AND (Tilted = False) Then
'   Debug "Game in play"
        ' is the ball saver active,
        If(bBallSaverActive = True) Then
        DOF 171, DOFPulse
    Debug "Ball Saver Active and working"
            ' yep, create a new ball in the shooters lane
            ' we use the Addmultiball in case the multiballs are being ejected
      if DMDType = 2 Then
        GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
        bSupressDMD = True
        HideDMDInfinite
        BallHandlingQueue.Add "HideDMDInfinite","HideDMDInfinite",70,0,0,0,0,True
        'BallHandlingQueue.Add "bSupressDMD-T","bSupressDMD = True",60,0,0,0,0,True
        BallHandlingQueue.Add "Pup860","PuPEvent 860",50,0,0,0,0,False ' Ball Saved Video
        AudioQueue.Add "Pup348","PuPEvent 348",35,0,0,0,0,False ' ball save audio
        BallHandlingQueue.Add "bSupressDMD-F","bSupressDMD = False",50,6600,0,0,0,False
        BallHandlingQueue.Add "UpdateDMD","UpdateDMD",30,6700,0,0,0,False

      Else
        if Mode(CurrentPlayer,0) <> 15 Then
          Debug "Ball Saved"
          EOBHide "BallSave"
          BallHandlingQueue.Add "EOBHide-BS","EOBHide ""BallSave"" ",60,0,0,0,0,True ' Ball Saved Video
          GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
          BallHandlingQueue.Add "Pup860","PuPEvent 860",50,0,0,0,0,False' Ball Saved Video
          AudioQueue.Add "Pup348","PuPEvent 348",35,0,0,0,0,False
          BallHandlingQueue.Add "EOBReturn-BallSave","EOBReturn ""BallSave"" ",50,6550,0,0,0,True ' Ball Saved Video
        End If
      End If

            AddMultiball 1
            ' we kick the ball with the autoplunger
            bAutoPlunger = True
            ' you may wish to put something on a display or play a sound at this point
            ' stop the ballsaver timer during the launch ball saver time, but not during multiballs
            If NOT bMultiBallMode Then
'                DMD "_", CL("BALL SAVED"), "_", eNone, eBlinkfast, eNone, 2500, True ,""

'   Playsound "vo_ballsave"

            End If
        Else  ' Not in ball saver mode
      Debug2 " No ball saver"
            ' cancel any multiball if on last ball (ie. lost all other balls)
            If(BallsOnPlayfield = 1)Then
        Debug "BOP 1"                ' AND in a multi-ball??


                If(bMultiBallMode = True)then
                    ' not in multiball mode any more
                    bMultiBallMode = 0

                    ' turn off any multiball specific lights
                    If Mode(CurrentPlayer, 0) = 0 Then
            OldGI = "white"
                        ChangeGi white
                        ChangeGIIntensity 1

                    End If

                    'stop any multiball modes of this game
                    'StopMBmodes
                    ' you may wish to change any music over at this point
                    'changesong
                End If
            End If

            ' was that the last ball on the playfield
            If(BallsOnPlayfield = 0)Then

        if BSMode = 1 Then
          BlacksmithClear
        elseif GMode = 1 Then
          GambleClear
        elseif TMode = 1 Then
          InTheDarkClear
        End If

        bDrain = 1
        'if AMState <> 2 And ActiveMode < 14 And ActiveMode > 0 Then  Debug "Calling ModeFail": ModeFail "drainhit":ReturnToVillage ' Do not call modefail if completed
        if AMState < 3 And ActiveMode < 14 And ActiveMode > 0 Then  Debug2 "Calling ModeFail": ModeFail "drainhit"   ' Do not call modefail if completed   1.2b
        Light010.state = 0
        Debug2 "BOP 0"
        OldGI = "white"
                ChangeGi white
                ChangeGIIntensity 1

        AudioQueue.Add "Pup221","PuPEvent 221",70,900,0,0,AudioExpiry,True ' Ball Lost Audio

        if DMDType = 2 Then
          Debug "DMD2 -- drain hit"
          ClearAll  ' Clear all displays and messages
          InGuide = 1
          UpdateDMD
        End If


        Dim tmpy
        tmpy = RndNbr(3)
        'tmpy = 1
        DungeonBonusTimer.Enabled = 0
        DungeonBonusTimerExpired.Enabled = 0
        ClearDungeonPup
        ClearDungeonPup2
        HideHelper

        Select Case tmpy
          Case 1:
            Debug2 "EOB CASE 1"
            BallHandlingQueue.Add "EOB-DH","EOBHide ""DrainHit"" ",73,0,0,0,0,True
            BallHandlingQueue.Add "Pup842","PuPEvent 842",70,100,0,0,0,True
            DOF 174, DOFPulse ' RED
            BallHandlingQueue.Add "EndofBall","EndofBall",70,4300,0,0,0,True
          Case 2:
            Debug2 "EOB CASE 2"
            BallHandlingQueue.Add "EOB-DH","EOBHide ""DrainHit"" ",73,0,0,0,0,True
            BallHandlingQueue.Add "Pup843","PuPEvent 843",70,100,0,0,0,True
            DOF 263, DOFPulse ' WHITE
            BallHandlingQueue.Add "EndofBall","EndofBall",70,6200,0,0,0,True
          Case 3:
            Debug2 "EOB CASE 3"
            BallHandlingQueue.Add "EOB-DH","EOBHide ""DrainHit"" ",73,0,0,0,0,True
            BallHandlingQueue.Add "Pup844","PuPEvent 844",70,100,0,0,0,True
            DOF 264, DOFPulse ' BLUE
            BallHandlingQueue.Add "EndofBall","EndofBall",70,5500,0,0,0,True
        End Select


        Debug2 " Calling Lost Ball EOB " & AMCombo &":" &tmpy
      End If
        End If
    End If
End Sub

Sub DOFModesOff
    DOF 258, DOFOff
    DOF 256, DOFOff
    DOF 259, DOFOff
    DOF 260, DOFOff
    DOF 253, DOFOff
    DOF 247, DOFOff
    DOF 240, DOFOff
    DOF 242, DOFOff
    DOF 244, DOFOff
    DOF 246, DOFOff
    DOF 248, DOFOff
    DOF 261, DOFOff
    DOF 250, DOFOff
    DOF 251, DOFOff
    DOF 252, DOFOff
End Sub

sub VO_LostBall
debug "in VO_LostBall"
  AudioQueue.Add "Pup221","PuPEvent 221",70,0,0,0,AudioExpiry,True
End Sub

' The Ball has rolled out of the Plunger Lane and it is pressing down the trigger in the shooters lane
' Check to see if a ball saver mechanism is needed and if so fire it up.

Sub swPlungerRest_Hit()
'Debug "ActiveBallID: " &ActiveBall.ID
bBallInPlungerLane = True
if bOnTheFirstBall And ScorbitActive = 1 And (Scorbit.bNeedsPairing) = false then ScorbitClaimQR(True)

  If bAutoPlunger Then
      'debug3 "autofire the ball"
      PlungerIM.AutoFire
      DOF 121, DOFPulse
      DOF 148, DOFPulse ' LAUNCH MX
    If  (bAutoPlunger = True) Then ' kick the ball in play if the bAutoPlunger flag is on
      If bSkillShotReady Then
        Debug4 " Skillshot READY"
        ' PlaySong "mu_plunger"  'RTPRTP

        UpdateSkillshot()
        ' show the message to shoot the ball in case the player has fallen sleep
        swPlungerRest.TimerEnabled = 1
      End If

      if BallsOnPlayfield = 1 Then
        'Debug "Got Here: " & BallsOnPlayfield
        ''RefreshBG
      End If
    End If
  Else
    DOF 187, DOFON ' BALL READY MX
  End If
End Sub

Sub FireBall
' Used to clear any balls in plunger lane at end of modes
  if bBallInPlungerLane = True Then
        BallHandlingQueue.Add "LaunchBall","LaunchBall",95,1500,0,0,0,True ' autofireball
  End If
End Sub

Sub swPLunger2_Hit 'extra trigger to detect a ball resting down on the plunger
  bBallDown = True
    ' kick the ball in play if the bAutoPlunger flag is on
    If bAutoPlunger Then
        'debug3 "autofire the ball"
    BallHandlingQueue.Add "LaunchBall","LaunchBall",95,1500,0,0,0,True ' autofireball
    End If
End Sub

Sub LaunchBall
  PlungerIM.AutoFire
  DOF 130, DOFPulse
  PlaySoundAt "Popper", swPlungerRest
end sub

Sub swPLunger2_UnHit()
  bBallDown = False
End Sub

' The ball is released from the plunger turn off some flags and check for skillshot

Sub swPlungerRest_UnHit()
    LightSeqAttract.StopPlay
    DOF 187, DOFOff
    DOF 113, DOFPulse
  if bOnTheFirstBall Then StopAttractMode

  bContinueGame = False ' turn off the continue game flag
  bOnTheFirstBall = False
  HideContinueMessage


  HideHighScores
  HighScoreQueue.RemoveAll(True)

  if Mode(CurrentPlayer,0) <> 0 then
    if Mode(currentPlayer,0) Mod 2 = 0 And HwyMenAttrib = 1 Then
      HwyMenAttrib = 0
      Playsound "gunshot"   'Must be in mode 2,4,6,8 (Dungeon)
    End If
  End If

    lighteffect 6

  bSupressLeftOrbit = True ' Prevent Freebie orbit hits
  BallHandlingQueue.Add "bSupressLeftOrbit-F","bSupressLeftOrbit = False",25,2000,0,0,0,False
    if bBallDown = False Then ' Added RC2
    bBallInPlungerLane = False
    bAutoPlunger = False           'disable the autoplunger as the ball has left the plunger lane
    swPlungerRest.TimerEnabled = 0 'stop the launch ball timer if active
    End If

    If bSkillShotReady Then
        ResetSkillShotTimer.Enabled = 1
    ScorbitClaimQR(False)
    if AMState <> 2 Then  Li047.state=2
    End If



    ' if there is a need for a ball saver, then start off a timer
    ' only start if it is ready, and it is currently not running, else it will reset the time period
Debug2 "BSR/BST/BSA " &bBallSaverReady &":" &BallSaverTime &":" &bBallSaverActive
    If(bBallSaverReady = True)AND(BallSaverTime <> 0)And(bBallSaverActive = False)Then
    'Debug5 "Passed BS Tests"
        EnableBallSaver BallSaverTime
    GeneralPupQueue.Add "Pup511","pupevent 511",90,0,0,0,0,True
    GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True
  Else
    Debug "Failed BS Test"
    End If
DisableLUTSelector = 1  ' Turn off the ability to change LUTs

End Sub

' swPlungerRest timer to show the "launch ball" if the player has not shot the ball during 6 seconds
Sub swPlungerRest_Timer
    IF bOnTheFirstBall Then
        Select Case RndNbr(5)
 '           Case 1:DMD CL("YOU WILL"), CL("NEVER WIN"), "_", eNone, eNone, eNone, 2000, True, ""
 '           Case 2:DMD CL("I KNEW YOU"), CL("YOU WOULD BE BACK"), "_", eNone, eNone, eNone, 2000, True, ""
 '           Case 3:DMD CL("I AM ZEUS"), CL("BOW BEFORE ME"), "_", eNone, eNone, eNone, 2000, True, "sfx_thunder" &RndNbr(9):FlashEffect 2:ZeusF
 '           Case 4:DMD CL("HEY YOU"), CL("SHOOT THE BALL"), "_", eNone, eNone, eNone, 2000, True, ""
 '           Case 5:DMD CL("HEY YOU"), CL("WELCOME BACK"), "_", eNone, eNone, eNone, 2000, True, ""
        End Select
    Else
        Select Case RndNbr(4)
  '          Case 1:DMD CL("ARE YOU"), CL("SLEEPING"), "_", eNone, eNone, eNone, 2000, True, ""
  '          Case 2:DMD CL("WHAT ARE"), CL("YOU WAITING FOR"), "_", eNone, eNone, eNone, 2000, True, ""
  '          Case 3:DMD CL("HEY"), CL("PULL THE PLUNGER"), "_", eNone, eNone, eNone, 2000, True, ""
  '          Case 4:DMD CL("ARE YOU PLAYING"), CL("THIS GAME"), "_", eNone, eNone, eNone, 2000, True, ""
        End Select
    End If
End Sub

Sub EnableBallSaver(seconds)
    'debug3 "Ballsaver started"
    ' set our game flag
    bBallSaverActive = True
    bBallSaverReady = False
'debug5 "ball saver false"
    ' start the timer
    BallSaverTimerExpired.Enabled = False
    BallSaverSpeedUpTimer.Enabled = False
    BallSaverTimerExpired.Interval = 1000 * seconds
    BallSaverTimerExpired.Enabled = True
    BallSaverSpeedUpTimer.Interval = 1000 * seconds -(1000 * seconds) / 3
    BallSaverSpeedUpTimer.Enabled = True
    ' if you have a ball saver light you might want to turn it on at this point (or make it flash)
    LightShootAgain.BlinkInterval = 160
    LightShootAgain.State = 2

End Sub

' The ball saver timer has expired.  Turn it off AND reset the game flag
'
Sub BallSaverTimerExpired_Timer()
    'debug3 "Ballsaver ended"
    BallSaverTimerExpired.Enabled = False
    BallSaverSpeedUpTimer.Enabled = False 'ensure this timer is also stopped
    ' clear the flag
    bBallSaverActive = False
    ' if you have a ball saver light then turn it off at this point
    LightShootAgain.State = 0

    ' if the table uses the same lights for the extra ball or replay then turn them on if needed
    If ExtraBallsAwards(CurrentPlayer) > 0 Then
        LightShootAgain.State = 1
    End If
End Sub

Sub BallSaverSpeedUpTimer_Timer()
    'debug3 "Ballsaver Speed Up Light"
    BallSaverSpeedUpTimer.Enabled = False
    ' Speed up the blinking
    LightShootAgain.BlinkInterval = 80
    LightShootAgain.State = 2

End Sub

' *********************************************************************
'                      Supporting Score Functions
' *********************************************************************

' Add points to the score AND update the score board

Sub AddScore(points) 'normal score routine
  'debug "in addscore"
    If Tilted Then Exit Sub
    ' add the points to the current players score variable
    Score(CurrentPlayer) = Score(CurrentPlayer) + points * PlayfieldMultiplier(CurrentPlayer)
  'Debug5 "PFM: " &PlayfieldMultiplier(CurrentPlayer)
  ' multiplier added during end of ball
    'Score(CurrentPlayer) = Score(CurrentPlayer) + points
  ScoreUpdate
' pUpdateScores
' you may wish to check to see if the player has gotten a replay
End Sub

Sub AddScore2(points) 'used in jackpots, skillshots, combos, and bonus as they doe not use the PlayfieldMultiplier
    If Tilted Then Exit Sub
    ' add the points to the current players score variable
    Score(CurrentPlayer) = Score(CurrentPlayer) + points
  ScoreUpdate
' pUpdateScores ' RTP added
End Sub

' Add bonus to the bonuspoints AND update the score board

Sub AddBonus(points) 'not used in this table, since there are many different bonus items.
    If Tilted Then Exit Sub
    ' add the bonus to the current players bonus variable
    'BonusPoints(CurrentPlayer) = BonusPoints(CurrentPlayer) + points
End Sub

' Add some points to the current Jackpot.
'
Sub AddJackpot(points)
    ' Jackpots only generally increment in multiball mode AND not tilted
    ' but this doesn't have to be the case
    If Tilted Then Exit Sub

    ' If(bMultiBallMode = True) Then
    Jackpot(CurrentPlayer) = Jackpot(CurrentPlayer) + points
 '   DMD "_", CL("INCREASED JACKPOT"), "_", eNone, eNone, eNone, 1000, True, ""
' you may wish to limit the jackpot to a upper limit, ie..
' If (Jackpot >= 6000000) Then
'   Jackpot = 6000000
'   End if
'End if
End Sub

Sub AddSuperJackpot(points) 'not used in this table
    If Tilted Then Exit Sub
End Sub

Sub AddBonusMultiplier(n)
    Dim NewBonusLevel
    ' if not at the maximum bonus level
    if(BonusMultiplier(CurrentPlayer) + n <= MaxBonusMultiplier)then
        ' then add and set the lights
        NewBonusLevel = BonusMultiplier(CurrentPlayer) + n
        SetBonusMultiplier(NewBonusLevel)
 '       DMD "_", CL("BONUS X " &NewBonusLevel), "_", eNone, eBlink, eNone, 2000, True, ""
    Else
        AddScore2 500000
    ScoreUpdate
 '       DMD "_", CL("500000"), "_", eNone, eNone, eNone, 1000, True, ""
    End if
End Sub

' Set the Bonus Multiplier to the specified level AND set any lights accordingly

Sub SetBonusMultiplier(Level)
    ' Set the multiplier to the specified level
    BonusMultiplier(CurrentPlayer) = Level
  ScorbitBuildGameModes
End Sub


Sub AddPlayfieldMultiplier(n)
    Dim NewPFLevel
    ' if not at the maximum level x
    if(PlayfieldMultiplier(CurrentPlayer) + n <= MaxMultiplier)then
        ' then add and set the lights
        NewPFLevel = PlayfieldMultiplier(CurrentPlayer) + n
        SetPlayfieldMultiplier(NewPFLevel)
 '       DMD "_", CL("PLAYFIELD X " &NewPFLevel), "_", eNone, eBlink, eNone, 2000, True, "sfx_thunder" &RndNbr(7)
        LightEffect 4
    ' Play a voice sound
    Else 'if the max is already lit
        AddScore2 500000
 '       DMD "_", CL("500000"), "_", eNone, eNone, eNone, 2000, True, ""
    End if
    ' restart the PlayfieldMultiplier timer to reduce the multiplier
    PFXTimer.Enabled = 0
    PFXTimer.Enabled = 1
End Sub

Sub PFXTimer_Timer
    DecreasePlayfieldMultiplier
End Sub

Sub DecreasePlayfieldMultiplier 'reduces by 1 the playfield multiplier
    Dim NewPFLevel
    ' if not at 1 already
    if(PlayfieldMultiplier(CurrentPlayer) > 1)then
        ' then add and set the lights
        NewPFLevel = PlayfieldMultiplier(CurrentPlayer)- 1
        SetPlayfieldMultiplier(NewPFLevel)
    Else
        PFXTimer.Enabled = 0
    End if
End Sub

' Set the Playfield Multiplier to the specified level AND set any lights accordingly

Sub SetPlayfieldMultiplier(Level)
    ' Set the multiplier to the specified level
    PlayfieldMultiplier(CurrentPlayer) = Level
    UpdatePFXLights(Level)
End Sub

Sub UpdatePFXLights(Level) 'no lights in this table
    ' Update the playfield multiplier lights
    Select Case Level
    '        Case 1:li025.State = 0:li026.State = 0:li027.State = 0:li027.State = 0
    '        Case 2:li025.State = 1:li026.State = 0:li027.State = 0:li027.State = 0
    '        Case 3:li025.State = 0:li026.State = 1:li027.State = 0:li027.State = 0
    '        Case 4:li025.State = 0:li026.State = 0:li027.State = 1:li027.State = 0
    '        Case 5:li025.State = 0:li026.State = 0:li027.State = 0:li027.State = 1
    End Select
' perhaps show also the multiplier in the DMD?
End Sub

Sub AwardExtraBall()
    '   If NOT bExtraBallWonThisBall Then 'in this table you can win several extra balls
 '   DMD "_", CL("EXTRA BALL WON"), "_", eNone, eBlink, eNone, 1000, True, SoundFXDOF("Knocker", 108, DOFPulse, DOFKnocker)
    DOF 130, DOFPulse
  AudioQueue.Add "Pup262","PuPEvent 262",40,0,0,0,AudioExpiry,False
    ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer) + 1
    bExtraBallWonThisBall = True
    'light009.State = 0        'turn off extra ball light
  ClearExtraball
  ClearRewardGold
  pBackglassPNGAnimate "ExtraballGIF",12
  'PuPlayer.LabelSet pBackglass,"ExtraballStatus","EXTRA",1,""
  'PuPlayer.LabelSet pBackglass,"ExtraballStatus2"," BALL",1,""  ' needs that leading space
  if DMDType = 0 Then
    PuPlayer.LabelSet pBackglass, "ExtraballDMD","+1",1,""
  Else
    PuPlayer.LabelSet pDMD, "ExtraballDMD","+1",1,""
  End If
  AddScore Score_ExtraBall
    LightShootAgain.State = 1 'light the shoot again lamp
    GiEffect 1
    LightEffect 2
  BallHandlingQueue.Add "Pup850","PuPEvent 850",45,0,0,0,0,True ' extraball video
  'ScorbitBuildGameModes
'    END If
End Sub

Sub AwardSpecial()
 '   DMD "_", CL("EXTRA GAME WON"), "_", eNone, eBlink, eNone, 2000, True, SoundFXDOF("Knocker", 108, DOFPulse, DOFKnocker)
    DOF 130, DOFPulse
    Credits = Credits + 1
    'AddScore2 3000000 '3 mill only for this table
    If bFreePlay = False Then DOF 121, DOFOn
    LightEffect 2
    GiEffect 1
  AddScore Score_Special
    Light010.State = 0 'turn off special light
  'ScorbitBuildGameModes
End Sub

Sub AwardJackpot()     'only used for the final mode
 '   DMD CL("JACKPOT"), CL(FormatScore(Jackpot(CurrentPlayer))), "d_border", eNone, eBlinkFast, eNone, 2000, True, "vo_Jackpot"
    DOF 137, DOFPulse
  if DMDType <> 2 Then
    pup2helper 3000
  Else
    HideDMD 3100, True
    GeneralPuPQueue.Add "Pup790","PuPEvent 790",10,0,0,0,0,False
  End If
  AudioQueue.Add "Pup236","PuPEvent 236",32,0,0,0,AudioExpiry,False
    AddScore2 Jackpot(CurrentPlayer)
    Jackpot(CurrentPlayer) = Jackpot(CurrentPlayer) + 100000
    LightEffect 2
    GiEffect 1
    FlashEffect 1
End Sub

Sub AwardSuperJackpot() 'not used in this table as there are several superjackpots but I keep it as a reference
'    DMD CL("SUPER JACKPOT"), CL(FormatScore(SuperJackpot(CurrentPlayer))), "d_border", eNone, eBlink, eNone, 2000, True, "vo_super_jackpot"
    DOF 137, DOFPulse
  AudioQueue.Add "Pup237","PuPEvent 237",35,0,0,0,AudioExpiry,True
    AddScore2 SuperJackpot(CurrentPlayer)
    LightEffect 2
    GiEffect 1
End Sub

Sub AwardSkillshot()
    ResetSkillShotTimer_Timer
    'show dmd animation
 '   DMD CL("SKILLSHOT"), CL(FormatScore(SkillshotValue(CurrentPlayer))), "d_border", eNone, eBlinkFast, eNone, 2000, True, "vo_skillshot"
    DOF 127, DOFPulse
    Addscore2 SkillShotValue(CurrentPlayer)
    ' increment the skillshot value with 50.000
    SkillShotValue(CurrentPlayer) = SkillShotValue(CurrentPlayer) + 50000
    'do some light show
    GiEffect 1
    LightEffect 2
  AudioQueue.Add "Pup277","PuPEvent 277",35,0,0,0,AudioExpiry,False
End Sub

Sub AwardSuperSkillshot()
    ResetSkillShotTimer_Timer
    'show dmd animation
 '   DMD CL("SUPER SKILLSHOT"), CL(FormatScore(SuperSkillshotValue(CurrentPlayer))), "d_border", eNone, eBlinkFast, eNone, 2000, True, "vo_superskillshot"
    DOF 138, DOFPulse
    Addscore2 SuperSkillshotValue(CurrentPlayer)
    ' increment the skillshot value with 500.000
    SuperSkillshotValue(CurrentPlayer) = SuperSkillshotValue(CurrentPlayer) + 500000
    'do some light show
    GiEffect 1
    LightEffect 2
End Sub


Sub aSkillshotTargets_Hit(idx) 'stop the skillshot if any other target/switch is hit
    If bSkillshotReady then ResetSkillShotTimer_Timer
End Sub

'*****************************
'    Load / Save / Highscore
'*****************************

Sub Loadhs
    Dim x
    x = LoadValue(cGameName, "HighScore1")
    If(x <> "")Then HighScore(0) = CDbl(x)Else HighScore(0) = 300000 End If
    x = LoadValue(cGameName, "HighScore1Name")
    If(x <> "")Then HighScoreName(0) = x Else HighScoreName(0) = "RTP" End If
    x = LoadValue(cGameName, "HighScore2")
    If(x <> "")then HighScore(1) = CDbl(x)Else HighScore(1) = 2500000 End If
    x = LoadValue(cGameName, "HighScore2Name")
    If(x <> "")then HighScoreName(1) = x Else HighScoreName(1) = "HRB" End If
    x = LoadValue(cGameName, "HighScore3")
    If(x <> "")then HighScore(2) = CDbl(x)Else HighScore(2) = 2000000 End If
    x = LoadValue(cGameName, "HighScore3Name")
    If(x <> "")then HighScoreName(2) = x Else HighScoreName(2) = "OQS" End If
    x = LoadValue(cGameName, "HighScore4")
    If(x <> "")then HighScore(3) = CDbl(x)Else HighScore(3) = 1500000 End If
    x = LoadValue(cGameName, "HighScore4Name")
    If(x <> "")then HighScoreName(3) = x Else HighScoreName(3) = "PIN" End If
    x = LoadValue(cGameName, "HighScore5")
    If(x <> "")then HighScore(4) = CDbl(x)Else HighScore(4) = 1000000 End If
    x = LoadValue(cGameName, "HighScore5Name")
    If(x <> "")then HighScoreName(4) = x Else HighScoreName(4) = "PRI" End If
    x = LoadValue(cGameName, "Credits")
    If(x <> "")then Credits = CInt(x)Else Credits = 0:If bFreePlay = False Then DOF 121, DOFOff:End If
    x = LoadValue(cGameName, "TotalGamesPlayed")
    If(x <> "")then TotalGamesPlayed = CInt(x)Else TotalGamesPlayed = 0 End If
End Sub


Sub Savehs
    SaveValue cGameName, "HighScore1", HighScore(0)
    SaveValue cGameName, "HighScore1Name", HighScoreName(0)
    SaveValue cGameName, "HighScore2", HighScore(1)
    SaveValue cGameName, "HighScore2Name", HighScoreName(1)
    SaveValue cGameName, "HighScore3", HighScore(2)
    SaveValue cGameName, "HighScore3Name", HighScoreName(2)
    SaveValue cGameName, "HighScore4", HighScore(3)
    SaveValue cGameName, "HighScore4Name", HighScoreName(3)
    SaveValue cGameName, "HighScore5", HighScore(4)
    SaveValue cGameName, "HighScore5Name", HighScoreName(4)
    SaveValue cGameName, "Credits", Credits
    SaveValue cGameName, "MerlinRTPValue", "123456"
    SaveValue cGameName, "TotalGamesPlayed", TotalGamesPlayed
End Sub

Sub Reseths
    HighScoreName(0) = "RTP"
    HighScoreName(1) = "HRB"
    HighScoreName(2) = "OQS"
    HighScoreName(3) = "PIN"
    HighScoreName(4) = "PRI"
    HighScore(0) = 3000000
    HighScore(1) = 2500000
    HighScore(2) = 2000000
    HighScore(3) = 1500000
    HighScore(4) = 1000000
    Savehs
End Sub

' ***********************************************************
'  High Score Initals Entry Functions - based on Black's code
' ***********************************************************

Dim hsbModeActive
Dim hsEnteredName
Dim hsEnteredDigits(3)
Dim hsCurrentDigit
Dim hsValidLetters
Dim hsCurrentLetter
Dim hsLetterFlash

Sub CheckHighscore()
  Debug "****** In Check High Score "
  GeneralPupQueue.Add "PuP 900","PuPEvent 900",95,0,0,0,0,True ' Load BG Screen
    Dim tmp
    tmp = Score(CurrentPlayer)

    If tmp > HighScore(0)Then 'add 1 credit for beating the highscore
        Credits = Credits + 1
        DOF 121, DOFOn
    End If

    If tmp > HighScore(3)Then
    'Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame   ' Stop updateing scores
        PlaySound SoundFXDOF("Knocker", 108, DOFPulse, DOFKnocker)
        DOF 130, DOFPulse
        DOF 108, DOFPulse
        HighScore(3) = tmp
    AudioQueue.Add "Pup345","PuPEvent 345",50,0,0,0,0,False
        HighScoreEntryInit()
    if bContinueGame = True Then
      'Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame   ' Stop updateing scores
      DisplayGameContinueMessage
      GeneralPupQueue.Add "HideContinueMessage","HideContinueMessage",20,3000,0,0,0,False
      GeneralPuPQueue.Add "EOBReturn-Gameover","EOBReturn ""GameOver""",91,3050,0,0,0,False
      GeneralPupQueue.Add "DisplayStartGameMessage","DisplayStartGameMessage",20,3200,0,0,0,False
    End If
    Else
    HideFinalScore
    if bContinueGame = True Then
      'Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame   ' Stop updateing scores
      DisplayGameContinueMessage
      GeneralPupQueue.Add "HideContinueMessage","HideContinueMessage",20,3000,0,0,0,False
      GeneralPuPQueue.Add "EOBReturn-Gameover","EOBReturn ""GameOver""",91,3050,0,0,0,False
      GeneralPupQueue.Add "DisplayStartGameMessage","DisplayStartGameMessage",20,3200,0,0,0,False
      'Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame   ' Stop updateing scores
      'GeneralPupQueue.Add "RFNG","ResetForNewGame()",20,1000,0,0,0,False
      GeneralPupQueue.Add "PuP 275","PuPEvent 275",20,1000,0,0,0,False
    Else
      GeneralPuPQueue.Add "EOBReturn-Gameover","EOBReturn ""GameOver""",91,0,0,0,0,True
      GeneralPuPQueue.Add "DisplayStartGameMessage","DisplayStartGameMessage",71,100,0,0,0,False

      ' 5000, "HideContinueMessage" ' make sure startgame message is gone
      'Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame   ' Stop updateing scores
      'GeneralPupQueue.Add "RFNG","ResetForNewGame()",20,0,0,0,0,False
      'GeneralPupQueue.Add "PuP 275","PuPEvent 275",20,0,0,0,0,False
    End If
        'EndOfBallComplete()
    End If

  'Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame   ' Stop updateing scores
  'GeneralPupQueue.Add "RFNG","ResetForNewGame()",20,2000,0,0,0,False
End Sub

Sub HighScoreEntryInit()
  Debug "++++++++++++++++    In High Score Entry Init "
  PuPlayer.LabelSet pDMD,"CurrScoreDMD","",0,""   ' Clear current score
    hsbModeActive = True
    'PlaySound "vo_enterinitials"
  AudioQueue.Add "Pup345","PuPEvent 345",50,0,0,0,0,False
    hsLetterFlash = 0

    hsEnteredDigits(0) = " "
    hsEnteredDigits(1) = " "
    hsEnteredDigits(2) = " "
    hsCurrentDigit = 0

    hsValidLetters = " ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789<" ' < is back arrow
    hsCurrentLetter = 1
 '   DMDFlush()
    pMsg2Lines "YOUR NAME:", " <A  > ", 9999, "", 0 ''' RMW6
    HighScoreDisplayNameNow()

    HighScoreFlashTimer.Interval = 250
    HighScoreFlashTimer.Enabled = True
End Sub

Sub EnterHighScoreKey(keycode)
    If keycode = LeftFlipperKey Then
        playsound "fx_Previous"
        hsCurrentLetter = hsCurrentLetter - 1
        if(hsCurrentLetter = 0)then
            hsCurrentLetter = len(hsValidLetters)
        end if
        HighScoreDisplayNameNow()
    End If

    If keycode = RightFlipperKey Then
        playsound "fx_Next"
        hsCurrentLetter = hsCurrentLetter + 1
        if(hsCurrentLetter > len(hsValidLetters))then
            hsCurrentLetter = 1
        end if
        HighScoreDisplayNameNow()
    End If

    If keycode = PlungerKey OR keycode = StartGameKey Then
        if(mid(hsValidLetters, hsCurrentLetter, 1) <> "<")then
            playsound "fx_Enter"
            hsEnteredDigits(hsCurrentDigit) = mid(hsValidLetters, hsCurrentLetter, 1)
            hsCurrentDigit = hsCurrentDigit + 1
            if(hsCurrentDigit > 2)then
                HighScoreDisplayNameNow()
                HighScoreCommitName()
            else
                HighScoreDisplayNameNow()
            end if
        else
            playsound "fx_Esc"
            hsEnteredDigits(hsCurrentDigit) = " "
            if(hsCurrentDigit > 0)then
                hsCurrentDigit = hsCurrentDigit - 1
            end if
            HighScoreDisplayNameNow()
        end if
    end if

End Sub

Sub HighScoreDisplayNameNow()
    HighScoreFlashTimer.Enabled = False
    hsLetterFlash = 0
    HighScoreDisplayName()
    HighScoreFlashTimer.Enabled = True
End Sub

Sub HighScoreDisplayName()
    Dim i, TempStr

    TempStr = " >"
    if(hsCurrentDigit> 0)then TempStr = TempStr & hsEnteredDigits(0)
    if(hsCurrentDigit> 1)then TempStr = TempStr & hsEnteredDigits(1)
    if(hsCurrentDigit> 2)then TempStr = TempStr & hsEnteredDigits(2)

    if(hsCurrentDigit <> 3)then
        if(hsLetterFlash <> 0)then
            TempStr = TempStr & "_"
        else
            TempStr = TempStr & mid(hsValidLetters, hsCurrentLetter, 1)
        end if
    end if

    if(hsCurrentDigit <1)then TempStr = TempStr & hsEnteredDigits(1)
    if(hsCurrentDigit <2)then TempStr = TempStr & hsEnteredDigits(2)

    TempStr = TempStr & "< "
    pMsg2Lines "YOUR NAME:", Mid(TempStr, 2, 5), 9999, "", 0
End Sub

Sub HighScoreFlashTimer_Timer()
    HighScoreFlashTimer.Enabled = False
    hsLetterFlash = hsLetterFlash + 1
    if(hsLetterFlash = 2)then hsLetterFlash = 0
    HighScoreDisplayName()
    HighScoreFlashTimer.Enabled = True
End Sub

Sub HighScoreCommitName()
  Debug " %%%%%%%%%%%  HighScore Commited"
    HighScoreFlashTimer.Enabled = False
    hsbModeActive = False

    hsEnteredName = hsEnteredDigits(0) & hsEnteredDigits(1) & hsEnteredDigits(2)
    if(hsEnteredName = "   ")then
        hsEnteredName = "YOU"
    end if

    HighScoreName(3) = hsEnteredName
    SortHighscore
  ClearInitials
    'EndOfBallComplete()
  if bContinueGame = True Then
    DisplayGameContinueMessage
    GeneralPupQueue.Add "HideContinueMessage","HideContinueMessage",20,3000,0,0,0,False
    GeneralPuPQueue.Add "EOBReturn-Gameover","EOBReturn ""GameOver""",91,3050,0,0,0,False
    GeneralPupQueue.Add "DisplayStartGameMessage","DisplayStartGameMessage",20,3200,0,0,0,False
    GeneralPupQueue.Add "PuP 275","PuPEvent 275",20,3000,0,0,0,False
  Else
    GeneralPuPQueue.Add "EOBReturn-Gameover","EOBReturn ""GameOver""",91,0,0,0,0,True
    GeneralPupQueue.Add "DisplayStartGameMessage","DisplayStartGameMessage",20,100,0,0,0,False
    'GeneralPupQueue.Add "RFNG","ResetForNewGame()",20,0,0,0,0,False
    'GeneralPupQueue.Add "PuP 275","PuPEvent 275",20,0,0,0,0,False
  End If
End Sub

Sub ClearInitials
  'GeneralPupQueue.Add "PuP 900","PuPEvent 900",95,0,0,0,0,True ' Load BG Screen
  if DMDType = 0 Then
    PuPlayer.LabelSet pBackglass, "Line1b", "", 0, ""
    PuPlayer.LabelSet pBackglass, "Line2b", "", 0, ""
  Else
    PuPlayer.LabelSet pBackglass, "Line1b", "", 0, ""
    PuPlayer.LabelSet pBackglass, "Line2b", "", 0, ""
  End If
End Sub

Sub SortHighscore
    Dim tmp, tmp2, i, j
    For i = 0 to 3
        For j = 0 to 2
            If HighScore(j) < HighScore(j + 1)Then
                tmp = HighScore(j + 1)
                tmp2 = HighScoreName(j + 1)
                HighScore(j + 1) = HighScore(j)
                HighScoreName(j + 1) = HighScoreName(j)
                HighScore(j) = tmp
                HighScoreName(j) = tmp2
            End If
        Next
    Next
End Sub

'//////////////////////////////////////////////////////////////////////
'// LUT
'//////////////////////////////////////////////////////////////////////


Dim LUTset, DisableLUTSelector, LutToggleSound, bLutActive
LutToggleSound = True
'LoadLUT
'LUTset = 0     ' Override saved LUT for debug
'SetLUT
DisableLUTSelector = 0  ' Disables the ability to change LUT option with magna saves in game when set to 1

Sub SetLUT  'AXS
Debug "@@@@@@@@@@@@@ In SetLUT @@@@@@@@@"
  Table1.ColorGradeImage = "LUT" & LUTset
end sub

Sub LUTBox_Timer
  LUTBox.TimerEnabled = 0
  LUTBox.Visible = 0
End Sub

Sub ShowLUT
  LUTBox.visible = 1
  Select Case LUTSet
    Case 0: LUTBox.text = "Fleep Natural Dark 1"
    Case 1: LUTBox.text = "Fleep Natural Dark 2"
    Case 2: LUTBox.text = "Fleep Warm Dark"
    Case 3: LUTBox.text = "Fleep Warm Bright"
    Case 4: LUTBox.text = "Fleep Warm Vivid Soft"
    Case 5: LUTBox.text = "Fleep Warm Vivid Hard"
    Case 6: LUTBox.text = "Skitso Natural and Balanced"
    Case 7: LUTBox.text = "Skitso Natural High Contrast"
    Case 8: LUTBox.text = "3rdaxis Referenced THX Standard"
    Case 9: LUTBox.text = "CalleV Punchy Brightness and Contrast"
    Case 10: LUTBox.text = "HauntFreaks Desaturated"
      Case 11: LUTBox.text = "Tomate washed out"
        Case 12: LUTBox.text = "VPW original 1on1"
        Case 13: LUTBox.text = "bassgeige"
        Case 14: LUTBox.text = "blacklight"
        Case 15: LUTBox.text = "B&W Comic Book"
    Case 16: LUTBox.text = "Skitso New ColorLut"
  End Select
  LUTBox.TimerEnabled = 1
End Sub

Sub SaveLUT
  Dim FileObj
  Dim ScoreFile

  Set FileObj=CreateObject("Scripting.FileSystemObject")
  If Not FileObj.FolderExists(UserDirectory) then
    Exit Sub
  End if

  if LUTset = "" then LUTset = 0 'failsafe

  Set ScoreFile=FileObj.CreateTextFile(UserDirectory & "DarkestDungeonLUT.txt",True)
  ScoreFile.WriteLine LUTset
  Set ScoreFile=Nothing
  Set FileObj=Nothing
End Sub

Sub LoadLUT
Debug "^^^^^^^^^^^^^^^^^^^^ In LoadLUT ^^^^^^^^^^^^"
    bLutActive = False
  Dim FileObj, ScoreFile, TextStr
  dim rLine

  Set FileObj=CreateObject("Scripting.FileSystemObject")
  If Not FileObj.FolderExists(UserDirectory) then
    LUTset=12
    Exit Sub
  End if
  If Not FileObj.FileExists(UserDirectory & "DarkestDungeonLUT.txt") then
    LUTset=12
    Exit Sub
  End if
  Set ScoreFile=FileObj.GetFile(UserDirectory & "DarkestDungeonLUT.txt")
  Set TextStr=ScoreFile.OpenAsTextStream(1,0)
    If (TextStr.AtEndOfStream=True) then
      Exit Sub
    End if
    rLine = TextStr.ReadLine
    If rLine = "" then
      LUTset=12
      Exit Sub
    End if
    LUTset = int (rLine)
    Debug "LUT Value: " &LUTset
    Set ScoreFile = Nothing
      Set FileObj = Nothing
End Sub


' *************************************************************************
'   JP's Reduced Display Driver Functions (based on script by Black)
' only 5 effects: none, scroll left, scroll right, blink and blinkfast
' 3 Lines, treats all 3 lines as text.
' 1st and 2nd lines are 20 characters long
' 3rd line is just 1 character
' Example format:
' DMD "text1","text2","backpicture", eNone, eNone, eNone, 250, True, "sound"
' Short names:
' dq = display queue
' de = display effect
' *************************************************************************

Const eNone = 0        ' Instantly displayed
Const eScrollLeft = 1  ' scroll on from the right
Const eScrollRight = 2 ' scroll on from the left
Const eBlink = 3       ' Blink (blinks for 'TimeOn')
Const eBlinkFast = 4   ' Blink (blinks for 'TimeOn') at user specified intervals (fast speed)

Const dqSize = 64

Dim dqHead
Dim dqTail
Dim deSpeed
Dim deBlinkSlowRate
Dim deBlinkFastRate

Dim dLine(2)
Dim deCount(2)
Dim deCountEnd(2)
Dim deBlinkCycle(2)

Dim dqText(2, 64)
Dim dqEffect(2, 64)
Dim dqTimeOn(64)
Dim dqbFlush(64)
Dim dqSound(64)

Dim FlexDMD
Dim DMDScene



Function ExpandLine(TempStr) 'id is the number of the dmd line
    If TempStr = "" Then
        TempStr = Space(20)
    Else
        if Len(TempStr) > Space(20)Then
            TempStr = Left(TempStr, Space(20))
        Else
            if(Len(TempStr) < 20)Then
                TempStr = TempStr & Space(20 - Len(TempStr))
            End If
        End If
    End If
    ExpandLine = TempStr
End Function

Function FormatScore2(ByVal Num) 'it returns a string with commas (as in Black's original font)
    dim i
    dim NumString

    NumString = CStr(abs(Num))

    For i = Len(NumString)-3 to 1 step -3
        if IsNumeric(mid(NumString, i, 1))then
            NumString = left(NumString, i-1) & chr(asc(mid(NumString, i, 1)) + 48) & right(NumString, Len(NumString)- i)
        end if
    Next
    FormatScore = NumString
End function

Function FormatScore(ByVal Num) 'it returns a string with commas (as in Black's original font)
    dim i
    dim NumString

  if Num=0 then
    FormatScore="00"
    Exit Function
  End if

    NumString = CStr(abs(Num))

    For i = Len(NumString)-3 to 1 step -3
        if IsNumeric(mid(NumString, i, 1))then
            NumString = left(NumString, i) & "," & right(NumString, Len(NumString)-i)   ' ANDREW
       'NumString = left(NumString, i-1) & chr(asc(mid(NumString, i, 1)) + 48) & right(NumString, Len(NumString)- i)
        end if
    Next
    FormatScore = NumString
End function

Function FL(NumString1, NumString2) 'Fill line
    Dim Temp, TempStr
    Temp = 20 - Len(NumString1)- Len(NumString2)
    TempStr = NumString1 & Space(Temp) & NumString2
    FL = TempStr
End Function

Function CL(NumString) 'center line
    Dim Temp, TempStr
    Temp = (20 - Len(NumString)) \ 2
    TempStr = Space(Temp) & NumString & Space(Temp)
    CL = TempStr
End Function

Function RL(NumString) 'right line
    Dim Temp, TempStr
    Temp = 20 - Len(NumString)
    TempStr = Space(Temp) & NumString
    RL = TempStr
End Function

'**************
' Update DMD
'**************



'********************
' Real Time updates
'********************
'used for all the real time updates

Sub Realtime_Timer
    'LeftFlipperTop.RotZ = LeftFlipper.CurrentAngle
    'LeftFlipperTop001.RotZ = LeftMiddleFlipper.CurrentAngle
    'LeftFlipperTop002.RotZ = LeftFlipper2.CurrentAngle
    'RightFlipperTop.RotZ = RightFlipper.CurrentAngle
    'RightFlipperTop001.RotZ = RightMiddleFlipper.CurrentAngle
    'RightFlipperTop002.RotZ = RightFlipper2.CurrentAngle
' add any other real time update subs, like gates or diverters, flippers
End Sub

'********************************************************************************************
' Only for VPX 10.2 and higher.
' FlashForMs will blink light or a flasher for TotalPeriod(ms) at rate of BlinkPeriod(ms)
' When TotalPeriod done, light or flasher will be set to FinalState value where
' Final State values are:   0=Off, 1=On, 2=Return to previous State
'********************************************************************************************

Sub FlashForMs(MyLight, TotalPeriod, BlinkPeriod, FinalState) 'thanks gtxjoe for the first version

    If TypeName(MyLight) = "Light" Then

        If FinalState = 2 Then
            FinalState = MyLight.State 'Keep the current light state
        End If
        MyLight.BlinkInterval = BlinkPeriod
        MyLight.Duration 2, TotalPeriod, FinalState
    ElseIf TypeName(MyLight) = "Flasher" Then

        Dim steps

        ' Store all blink information
        steps = Int(TotalPeriod / BlinkPeriod + .5) 'Number of ON/OFF steps to perform
        If FinalState = 2 Then                      'Keep the current flasher state
            FinalState = ABS(MyLight.Visible)
        End If
        MyLight.UserValue = steps * 10 + FinalState 'Store # of blinks, and final state

        ' Start blink timer and create timer subroutine
        MyLight.TimerInterval = BlinkPeriod
        MyLight.TimerEnabled = 0
        MyLight.TimerEnabled = 1
        ExecuteGlobal "Sub " & MyLight.Name & "_Timer:" & "Dim tmp, steps, fstate:tmp=me.UserValue:fstate = tmp MOD 10:steps= tmp\10 -1:Me.Visible = steps MOD 2:me.UserValue = steps *10 + fstate:If Steps = 0 then Me.Visible = fstate:Me.TimerEnabled=0:End if:End Sub"
    End If
End Sub

'******************************************
' Change light color - simulate color leds
' changes the light color and state
' 11 colors: red, orange, amber, yellow...
'******************************************

'colors
Const red = 5
Const orange = 4
Const amber = 6
Const yellow = 3
Const darkgreen = 7
Const green = 2
Const blue = 1
Const darkblue = 8
Const purple = 9
Const white = 11
Const teal = 10
Const pink = 12

Sub SetLightColor(n, col, stat) 'stat 0 = off, 1 = on, 2 = blink, -1= no change
    Select Case col
        Case red
            n.color = RGB(18, 0, 0)
            n.colorfull = RGB(255, 0, 0)
        Case orange
            n.color = RGB(18, 3, 0)
            n.colorfull = RGB(255, 64, 0)
        Case amber
            n.color = RGB(193, 49, 0)
            n.colorfull = RGB(255, 153, 0)
        Case yellow
            n.color = RGB(18, 18, 0)
            n.colorfull = RGB(255, 255, 0)
        Case darkgreen
            n.color = RGB(0, 8, 0)
            n.colorfull = RGB(0, 64, 0)
        Case green
            n.color = RGB(0, 16, 0)
            n.colorfull = RGB(0, 128, 0)
        Case blue
            n.color = RGB(0, 18, 18)
            n.colorfull = RGB(0, 255, 255)
        Case darkblue
            n.color = RGB(0, 8, 8)
            n.colorfull = RGB(0, 64, 64)
        Case purple
            n.color = RGB(64, 0, 96)
            n.colorfull = RGB(128, 0, 192)
        Case white
            n.color = RGB(193, 91, 0)
            n.colorfull = RGB(255, 197, 143)
        Case teal
            n.color = RGB(1, 64, 62)
            n.colorfull = RGB(2, 128, 126)
        Case pink
            n.color = RGB(192, 0, 0)
            n.colorfull = RGB(255, 192, 203)
    End Select
    If stat <> -1 Then
        n.State = 0
        n.State = stat
    End If
End Sub

Sub SetFlashColor(n, col, stat) 'stat 0 = off, 1 = on, -1= no change - no blink for the flashers, use FlashForMs
    Select Case col
        Case red
            n.color = RGB(255, 0, 0)
        Case orange
            n.color = RGB(255, 64, 0)
        Case amber
            n.color = RGB(255, 153, 0)
        Case yellow
            n.color = RGB(255, 255, 0)
        Case darkgreen
            n.color = RGB(0, 64, 0)
        Case green
            n.color = RGB(0, 128, 0)
        Case blue
            n.color = RGB(0, 255, 255)
        Case darkblue
            n.color = RGB(0, 64, 64)
        Case purple
            n.color = RGB(128, 0, 192)
        Case white
            n.color = RGB(255, 197, 143)
        Case teal
            n.color = RGB(2, 128, 126)
        Case pink
            n.color = RGB(255, 192, 203)
    End Select
    If stat <> -1 Then
        n.Visible = stat
    End If
End Sub

'*************************
' Rainbow Changing Lights
'*************************

Dim RGBStep, RGBFactor, rRed, rGreen, rBlue, RainbowLights

Sub StartRainbow(n) 'n is a collection
    set RainbowLights = n
    RGBStep = 0
    RGBFactor = 5
    rRed = 255
    rGreen = 0
    rBlue = 0
    RainbowTimer.Enabled = 1
End Sub

Sub StopRainbow()
    RainbowTimer.Enabled = 0
End Sub

Sub RainbowTimer_Timer 'rainbow led light color changing
    Dim obj
    Select Case RGBStep
        Case 0 'Green
            rGreen = rGreen + RGBFactor
            If rGreen > 255 then
                rGreen = 255
                RGBStep = 1
            End If
        Case 1 'Red
            rRed = rRed - RGBFactor
            If rRed < 0 then
                rRed = 0
                RGBStep = 2
            End If
        Case 2 'Blue
            rBlue = rBlue + RGBFactor
            If rBlue > 255 then
                rBlue = 255
                RGBStep = 3
            End If
        Case 3 'Green
            rGreen = rGreen - RGBFactor
            If rGreen < 0 then
                rGreen = 0
                RGBStep = 4
            End If
        Case 4 'Red
            rRed = rRed + RGBFactor
            If rRed > 255 then
                rRed = 255
                RGBStep = 5
            End If
        Case 5 'Blue
            rBlue = rBlue - RGBFactor
            If rBlue < 0 then
                rBlue = 0
                RGBStep = 0
            End If
    End Select
    For each obj in RainbowLights
        obj.color = RGB(rRed \ 10, rGreen \ 10, rBlue \ 10)
        obj.colorfull = RGB(rRed, rGreen, rBlue)
    Next
End Sub

' ********************************
'   Table info & Attract Mode
' ********************************

Sub ShowTableInfo
    Dim ii
    'info goes in a loop only stopped by the credits and the startkey
    If Score(1)Then
'        DMD CL("LAST SCORE"), CL("PLAYER 1 " &FormatScore(Score(1))), "", eNone, eNone, eNone, 3000, False, ""
    End If
    If Score(2)Then
 '       DMD CL("LAST SCORE"), CL("PLAYER 2 " &FormatScore(Score(2))), "", eNone, eNone, eNone, 3000, False, ""
    End If
    If Score(3)Then
'        DMD CL("LAST SCORE"), CL("PLAYER 3 " &FormatScore(Score(3))), "", eNone, eNone, eNone, 3000, False, ""
    End If
    If Score(4)Then
'        DMD CL("LAST SCORE"), CL("PLAYER 4 " &FormatScore(Score(4))), "", eNone, eNone, eNone, 3000, False, ""
    End If
'    DMD "", CL("GAME OVER"), "", eNone, eBlink, eNone, 2000, False, ""
    If bFreePlay Then
'        DMD "", CL("FREE PLAY"), "", eNone, eBlink, eNone, 2000, False, ""
    Else
        If Credits > 0 Then
 '           DMD CL("CREDITS " & Credits), CL("PRESS START"), "", eNone, eBlink, eNone, 2000, False, ""
        Else
'            DMD CL("CREDITS " & Credits), CL("INSERT COIN"), "", eNone, eBlink, eNone, 2000, False, ""
        End If
    End If
'    DMD "        JPSALAS", "          AND", "d_jppresents", eNone, eNone, eNone, 2000, False, ""
'    DMD "    T-800", "  PRESENTS", "d_t800", eNone, eNone, eNone, 2000, False, ""
'    DMD "", "", "d_title", eNone, eNone, eNone, 4000, False, ""
'    DMD "", CL("ROM VERSION " &myversion), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("HIGHSCORES"), Space(20), "", eScrollLeft, eScrollLeft, eNone, 20, False, ""
'    DMD CL("HIGHSCORES"), "", "", eBlinkFast, eNone, eNone, 1000, False, ""
'    DMD CL("HIGHSCORES"), "1> " &HighScoreName(0) & " " &FormatScore(HighScore(0)), "", eNone, eScrollLeft, eNone, 2000, False, ""
'    DMD "_", "2> " &HighScoreName(1) & " " &FormatScore(HighScore(1)), "", eNone, eScrollLeft, eNone, 2000, False, ""
'    DMD "_", "3> " &HighScoreName(2) & " " &FormatScore(HighScore(2)), "", eNone, eScrollLeft, eNone, 2000, False, ""
'    DMD "_", "4> " &HighScoreName(3) & " " &FormatScore(HighScore(3)), "", eNone, eScrollLeft, eNone, 2000, False, ""
'    DMD Space(20), Space(20), "", eScrollLeft, eScrollLeft, eNone, 500, False, ""
End Sub

Sub GrandChampion
  puPlayer.LabelSet pBackglass,"HS-Title","GRAND CHAMPION",1,"{'mt':2,'color':1604786}"
  puPlayer.LabelSet pBackglass,"HS-Score",FormatScore(HighScore(0)),1,""
  puPlayer.LabelSet pBackglass,"HS-Name",HighScoreName(0),1,"{'mt':2,'color':397512}"
End Sub

Sub HighScore1
  puPlayer.LabelSet pBackglass,"HS-Title","HIGH SCORE #1",1,"{'mt':2,'color':397512}"
  puPlayer.LabelSet pBackglass,"HS-Score",FormatScore(HighScore(1)),1,""
  puPlayer.LabelSet pBackglass,"HS-Name",HighScoreName(1),1,""
End Sub

Sub HighScore2
  puPlayer.LabelSet pBackglass,"HS-Title","HIGH SCORE #2",1,""
  puPlayer.LabelSet pBackglass,"HS-Score",FormatScore(HighScore(2)),1,""
  puPlayer.LabelSet pBackglass,"HS-Name",HighScoreName(2),1,""
End Sub

Sub HighScore3
  puPlayer.LabelSet pBackglass,"HS-Title","HIGH SCORE #3",1,""
  puPlayer.LabelSet pBackglass,"HS-Score",FormatScore(HighScore(3)),1,""
  puPlayer.LabelSet pBackglass,"HS-Name",HighScoreName(3),1,""
End Sub

Sub HighScore4
  puPlayer.LabelSet pBackglass,"HS-Title","HIGH SCORE #4",1,""
  puPlayer.LabelSet pBackglass,"HS-Score",FormatScore(HighScore(4)),1,""
  puPlayer.LabelSet pBackglass,"HS-Name",HighScoreName(4),1,""
End Sub

Sub DisplayTotalGamesPlayed
  puPlayer.LabelSet pBackglass,"HS-Title","Total Games Played",1,""
  puPlayer.LabelSet pBackglass,"HS-Score",TotalGamesPlayed,1,""
End Sub

Sub HideHighScores
  puPlayer.LabelSet pBackglass,"HS-Title","",0,""
  puPlayer.LabelSet pBackglass,"HS-Name","",0,""
  puPlayer.LabelSet pBackglass,"HS-Score","",0,""
End Sub

Sub DisplayHighScores
  'Debug5 "In DisplayHighScores"

  HighScoreQueue.Add "GrandChampion","GrandChampion",50,0,0,0,0,True
  HighScoreQueue.Add "HighScore1","HighScore1",50,3000,0,0,0,False
  HighScoreQueue.Add "HighScore2","HighScore2",50,6000,0,0,0,False
  HighScoreQueue.Add "HighScore3","HighScore3",50,9000,0,0,0,False
  HighScoreQueue.Add "HighScore4","HighScore4",50,12000,0,0,0,False
  HighScoreQueue.Add "DisplayTotalGamesPlayed","DisplayTotalGamesPlayed",50,15000,0,0,0,False
  HighScoreQueue.Add "HideHighScores","HideHighScores",50,18000,0,0,0,False
End Sub

Sub StartAttractMode
  bAttractMode = True
  'Debug5 "Calling StartAttractMode"
    StartLightSeq
  EOBHide "StartAttract"
' triggerscript 6000, "DisplayHighScores"
' HighScoreQueue.Add "Pup300","pupevent 300",96,18500,0,0,0,True
' HighScoreQueue.Add "Pup555","PuPEvent 555",20,18500,0,0,0,False
' if bGameInPlay = False Then
    HighScoreQueue.Add "Pup300","pupevent 300",96,100,0,0,0,True
    HighScoreQueue.Add "Pup555","PuPEvent 555",20,100,0,0,0,False
' End If


    DOF 115, DOFOn

'    DMDFlush
'    ShowTableInfo
End Sub

Sub StopAttractMode
  bAttractMode = False
    StopRainbow
  EOBReturn "StopAttract"
  'pupevent 400
  'PreviewNextChar
  'pbackglasslabelshow "Wanted"
  'pbackglasslabelshow "RewardGold"
'    DMDScoreNow
    LightSeqAttract.StopPlay
    DOF 115, DOFOff
End Sub

Sub StartLightSeq()
    'lights sequences
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqDiagUpRightOn, 25, 2
    LightSeqAttract.Play SeqStripe1VertOn, 25
    LightSeqAttract.Play SeqClockRightOn, 180, 2
    LightSeqAttract.Play SeqFanLeftUpOn, 50, 2
    LightSeqAttract.Play SeqFanRightUpOn, 50, 2
    LightSeqAttract.Play SeqScrewRightOn, 50, 2
    LightSeqAttract.Play SeqDiagDownLeftOn, 25, 2
    LightSeqAttract.Play SeqStripe2VertOn, 25, 2
    LightSeqAttract.Play SeqFanLeftDownOn, 50, 2
    LightSeqAttract.Play SeqFanRightDownOn, 50, 2
End Sub

Sub LightSeqAttract_PlayDone()
    StartLightSeq()
End Sub

Sub LightSeqTilt_PlayDone()
    LightSeqTilt.Play SeqAllOff
End Sub

Sub LightSeqSkillshot_PlayDone()
    LightSeqSkillshot.Play SeqAllOff
End Sub

'***********************************************************************
' *********************************************************************
'                     Table Specific Script Starts Here
' *********************************************************************
'***********************************************************************

' droptargets, animations, timers, etc
Sub VPObjects_Init
    TrapdoorDown
End Sub

' tables variables and Mode init

Dim bRotateLights
Dim bPlayIntro
Dim Mode(4, 16) '4 players, 16 modes
'Mode 0 - Current Active Mode -- Value 1-9
'Mode 1 - Assemble Party Pre Ruins
'Mode 2 - RUINS Dungeon
'Mode 3 - Assemble party Pre-Cove
'Mode 4 - COVE Dungeon
'Mode 5 - Assemble party pre-WEALD
'Mode 6 - WEALD Dungeon
'Mode 7 - Assemble Party pre-WARRENS
'Mode 8 - WARRENS Dungeon
'Mode 9 - Wizard Mode
Dim BumperHits 'used for the skillshot and
Dim ComboValue(4)
Dim ComboHits(4)
Dim ComboCount
Dim BumperAward
Dim OrbitHits
Dim RampHits

Dim ExtraBallHits 'used in medusa multiball
Dim SpinnerHits   '
Dim TrapDoorHits  '
Dim bJackpotsEnabled
Dim bLockEnabled


Dim CBHits(4) 'captive ball hits
Dim BonusTargets(4)
Dim BonusRamps(4)
Dim BonusOrbits(4)
Dim BonusXHits(4)
Dim HiddenShots(4)
Dim TotalMonsters(4)
Dim GoldSack(4)
Dim LeftSpinnerCount (4)
Dim RightSpinnerCount (4)
Dim RightRampCount (4)
Dim LeftRampCount (4)
Dim Blacksmith    ' left spinner hidden blacksmith spinner mode
Dim Blacksmith2   ' left spinner hidden blacksmith spinner mode
Dim Gamble      ' ramp hidden gamble modestart
Dim Gamble2     ' ramp hidden gamble mode
dim Gamblescore
dim Gamblescorex2
Dim DungeonsCleared(4)

' MERLIN RTP CODE STUFFS
Dim LOHIT,ROHIT,INHIT,ORBHIT
Dim PupScreen1
Dim GlowMod, CharPosition, MonPosition
Dim InVideo,GameReady,tmpMonster
Dim BID
Dim goSelection
Dim CurrentCardIndex,RuleCardsAvailable
Dim ActiveMode, AMState, AMCombo, DungeonState, CFCount, CurrHero, TotalMonsterHits
Dim AwardPoints,TotalBonus,BonusMessage1,MessageTitle
Dim bDecision,bRetry,bDrain,bSelection
Dim CryptMBCount(5)
Dim HoundMasterAlreadyAttacked
Dim ChaseTorchesArray(5)
Dim CryptRound,CryptTotal
Dim TorchTotal
Dim TorchHits(4)
Dim RuinsMonsters(10)
Dim CoveMonsters(10)
Dim WealdMonsters(10)
Dim WarrensMonsters(10)
Dim NextChar
Dim HBMOD: HBMOD = 0
Dim HBMOD2: HBMOD2 = 0
Dim GuideDelay, InGuide
Dim BattleID(4)
Dim ChangeFontColor
Dim dmddef,dmdalt,dmdscr,dmdfixed
Dim GuideMessage1,GuideMessage2,GuideMessage3
Dim ModeTitle,ModeString,KBActive
Dim HeartVolume
Dim M1,M2,M3,M4
Dim P1,P2,P3,P4
Dim GMode, BSMode,TMode
Dim WulfCnt,LastTarget, CurrTarget
Dim BleedActive
Dim Rando,InEvent,QuestCount,InBattle
Dim OriginalHeroCountDown
Dim HeroCountDown,HeroCountDownMax
Dim TorchTimerCount,TorchTimerCountMax
Dim TorchesEnabled
Dim DungeonBonus, DungeonCountDown
Dim DungeonTimerMessage1, DungeonTimerMessage2, DungeonTimerMessage3
Dim BlacksmithCountDown
Dim BlacksmithTimerMessage1, BlacksmithTimerMessage2, BlacksmithTimerMessage3
Dim CountDownMessage1, CountDownMessage2,CountDownMessage3,CountDown, CDT, GambleCountDown
Dim CountBSLeftSpin, CountBSRightSpin
Dim HwyMenAttrib
Dim SpinnersTotal
Dim BleedTime,HeroTime
Dim TLV, Cnt
Dim bBSTime,bBSAll ' Blacksmith flags
Dim GambleTimerCount
Dim Monsters(4,4)
Dim WarrensTargets(4)
Dim DrownedTargets(4)
Dim TorchTargets(4)
Dim DungeonPuPVideos(4)
Dim Region
Dim ItemCount,TotalItemCount
Dim InnCleared,MonstersCleared
Dim Missions(4,9) ' 4 players 8 missions
' 0 - base -- not used currently
'1 - Blacksmith
'2 - Gambler
'3 - DungeonMB
Dim PartyString,MonsterString,ItemString,DarkString
Dim PartySize(4)
Dim Party(4,8) ' 4 players , 8 members
'0 - HwyMen
'1 - Jester
'2 - Healer
'3 - Plague Doctor
'4 - Occultist/Genie
'5 - Knight

Dim ItemsRTP(4,8) ' 4 players 5 items
' ItemsRTP(0) = medicine
' ItemsRTP(1) = bandages
' ItemsRTP(2) = key
' ItemsRTP(3) = shovel
' ItemsRTP(4) = potion

Dim RegionMonster(4,15) ' 4 players , 4 regions, values 1-8
'Region 2 - Ruins
'Region 4 - Cove
'Region 6 - Weald
'Region 8 - Warrens

'Dim DungeonMode(4,9) ' 4 players, 10 modes
'Mode 0 - Current Active Mode -- Value 1-9
'Mode 1 - Assemble Party Pre Ruins
'Mode 2 - RUINS Dungeon
'Mode 3 - Assemble party Pre-Cove
'Mode 4 - COVE Dungeond
'Mode 5 - Assemble party pre-WEALD
'Mode 6 - WEALD Dungeon
'Mode 7 - Assemble Party pre-WARRENS
'Mode 8 - WARRENS Dungeon
'Mode 9 - Wizard Mode
'Mode 10 - Shambler - Ruins Boss

 Dim i, j, k




Sub Game_Init() 'called at the start of a new game
debug "begin GAME INIT"
  ResetTrapDoorImages
  if bAttractMode Then
    StopAttractMode
    GeneralPupQueue.Add "HideHighScores","HideHighScores",95,0,0,0,0,True
    GeneralPupQueue.Add "HideHighRemoveAll","HighScoreQueue.RemoveAll(True)",93,0,0,0,0,True
  Else
    'HighScoreQueue.Add "StartAttractMode","StartAttractMode",95,6000,0,0,0,True
  End If
    LoadLut:SetLUT
  OldGi = "white"
  OldLUT = Table1.ColorGradeImage
  GeneralPupQueue.Add "HideContinueMessage","HideContinueMessage",95,3000,0,0,0,True
  GeneralPupQueue.Add "HideContinueMessage","HideContinueMessage",95,5000,0,0,0,False

  'GeneralPupQueue.Add "HideHighScores","HideHighScores",95,6500,0,0,0,True
  'GeneralPupQueue.Add "HideHighRemoveAll","HighScoreQueue.RemoveAll(True)",93,6500,0,0,0,True

  'SetLightColor li060, Blue, 0
  AutoFlipTimer.Enabled = 1
  LastSwitch.interval = 1800 ' bigger = lastswitch hit is active longer
  'SearchForStuckBalls.Enabled = 1
  AF = 1
  bInn = False
  bVillage = True
  bDungeonsCleared = False
  bBallDown = False
  bEndOfGame = False
  bSupressDMD = False
  bSupressBGMessages = False
  bSupressRightOrbit = False
  bDungeonsClosed = False
  bSupressLeftOrbit = False
  bMaxParty = False
  bBossDefeatedFullParty = False
  bKillUPF = False
  bSuperJackpotReady = False
  bEndofGame = False
  bHoldBall = False
  bHoldBallDelay = False
  bDecision = False
  bBallPossiblyStuck = False
  bDungeonSelectMode = False
  bInDungeonSelection = False
  'GlimmerOfHopeOn
  AudioQueue.Add "Pup445","PuPEvent 445",20,0,0,0,0,False ' play village theme music
  setMonsterLightColorWhite
  Debug "In Game Init"
  gi051.state = 0
  ResetWulf  ' make sure drop targets are down
  DarknessLayer.Opacity = DefaultDarkness

  RuleCardsAvailable = 0

  GameReady = 0
  PartySize(CurrentPlayer) = 0
  HelperMessage =""
  debugKB = 0
  LastMode = 0
  RFlipperUsed = 0

  if EnableFlicker = True Then
    FlickerTimer.enabled = 1
  Else
    FlickerTimer.enabled = 0
  End If
  'PuPEvent 100
  'triggerscript 100, "ReturnOverlay ""gameinit"" "
  GeneralPupQueue.Add "Pup400","pupevent 400",95,100,0,0,0,True
  GeneralPupQueue.Add "Pup900","pupevent 900",95,150,0,0,0,True
  GeneralPupQueue.Add "Pup200","pupevent 200",90,200,0,0,0,True
  GeneralPupQueue.Add "EOBReturn-GameInit","EOBReturn ""gameinit""",90,250,0,0,0,True
  'triggerscript 250, "EOBReturn ""gameinit"" "

  InGuide = 0
  CryptRound = 1 ' starts at 1
  CryptTotal = 0
  if DMDType = 0 Then
    PuPlayer.LabelSet pBackglass,"FinalScore","",0,""   ' Hide final score from last game
  Else
    PuPlayer.LabelSet pBackglass,"FinalScore","",0,""   ' Hide final score from last game
    if DMDType = 2 Then PuPlayer.LabelSet pDMD,"FinalScoreDMD","",0,""   ' Hide final score from last game
  End If

  ClearDMDGuide ' Clear DMD

  if DMDType <> 2 Then
    GeneralPupQueue.Add "Pup511","pupevent 511",90,0,0,0,0,True
    GeneralPupQueue.Add "Pup512","pupevent 512",90,0,0,0,0,True
  End If

' li060.state=0 ' turn off left lane flashing
  GuideDelay = 10000
  SetModeTitle
  TotalMonsterHits = 8
  ClearGuideMessages
  'HideTotalMessage
  ClearBonusMessage
  'ModeString = "{'mt':2,'color':255, 'size': 10, 'xpos': 65.5, 'xalign': 1, 'ypos': 87.5, 'yalign': 1 }"
  ClearCountDownPup
  wall66down
  TrapdoorDown
  ResetTorches
  RefreshBG
  HwyMenAttrib = 0
  CountBSLeftSpin = 1
  CountBSRightSpin = 1
  OriginalHeroCountDown = HeroHealth + HBMOD
  HeroCountDown = OriginalHeroCountDown ' HeroCountDown must match the interval
  HeroCountDownMax = OriginalHeroCountDown
'####################################################################################
  ' Set timer intervals
  FullOrbitTimer.interval = 5000
  HeroCountDownTimer.Interval = 1000
  gambletimer.interval=1000
  CountDownTimer.interval = 1000
  herotimer.interval = HeroCountDown*1000
  HeroTime = herotimer.interval
  BleedTime = HeroTime - 10000
  torchtimer.interval = DarknessSpeed
  Debug "Initializaing Game Variables: "& GameVersion
  pNote  "Initializaing", "Please Be Patient"
  ResetBlinkIntervals
  CurrentCardIndex = 0
    'Init Variables
  InBattle = 0
  bRetry = False
  bDrain = 0
  DungeonBonus = 0
  CurrHero = ""
  LOHIT  = 0
  ROHIT = 0
  INHIT = 0
  ORBHIT = 0
  Mode(CurrentPlayer,0) = 0
  BleedActive = 0
  TorchesEnabled = 0
  InEvent = 0
  CFCount = 0
  MonstersCleared = 0
  DungeonState = "0/8"
  AMState = 0
  ItemCount = 0
    bPlayIntro = True
    BallSaverTime = 20 'RTP7
    bExtraBallWonThisBall = False
    BumperHits = 0
    bRotateLights = True
    BumperAward = 5000
  gamblescore = 20000
  Gamblescorex2 = 40000
    ComboCount = 0
    OrbitHits = 0
    RampHits = "0/0"
    SpinnerHits = 0
    ExtraBallHits = 0
    TrapDoorHits = 0
    bJackpotsEnabled = False
    bLockEnabled = False
  bContinueScreen = False
debug2 "STARTING INITIALIZE VARIABLES"
   For i = 0 to 5
    CryptMBCount(i) = 0
    ChaseTorchesArray(i) = 0
    TorchLevel(i) = 100
  Next

if bContinueGame = False Then ' Do not reset these vairables if continuing the game
Debug2 "Continuing the game is False"
   For i = 0 to 10
    RuinsMonsters(i) = 0
    CoveMonsters(i) = 0
    WealdMonsters(i) = 0
    WarrensMonsters(i) = 0
  Next

    For i = 0 to 4
    UPFHitCount(i) = 0
    LeftSpinnerCount (i) = 0
    RightSpinnerCount (i) = 0
    RightRampCount (i) = 0
    LeftRampCount (i) = 0
    TorchTargets(i) = 0
    DungeonsCleared(i) = 0
  Next

    For i = 0 to 4
        For j = 0 to 15
            Mode(i, j) = 0
        Next
    Next

    For i = 0 to 4
        For j = 0 to 15
            RegionMonster(i, j) = 0
        Next
    Next

End If

    For i = 0 to 4
    TorchHits(i) = 0
    DarkLights(i) = 0
    WarrensTargets(i) = 0
    DrownedTargets(i) = 0
    BattleID(i) = 0
    PartySize(i) = 0
        SkillshotValue(i) = 100000
        ComboValue(i) = 250000
        BallsInLock(i) = 0
        SuperJackpot(i) = 5000000
        Jackpot(i) = 1000000
        CBHits(i) = 0
        BonusTargets(i) = 0
        BonusRamps(i) = 0
        BonusOrbits(i) = 0
        BonusXHits(i) = 0
        ComboHits(i) = 0
        HiddenShots(i) = 0
        TotalMonsters(i) = 0
    GoldSack(i) = 0
    Next

    For i = 0 to 4
        For j = 0 to 4
            Monsters(i, j) = 0
        Next
    Next

    For i = 0 to 4
        For j = 0 to 7
            ItemsRTP(i, j) = 0
      Missions(i,j) = 0
            Party(i, j) = 0
        Next
    Next

    For i = 0 to 4
        For j = 0 to 2
      For k = 0 to 2
            GIF_MA(i, j, k) = 0
      GIF_CA(i, j, k) = 0
      Next
        Next
    Next

  ' Assign dungeon Pup Videos
' DungeonPuPVideos(0) = "PuPEvent 570"
' DungeonPuPVideos(1) = "PuPEvent 571"
' DungeonPuPVideos(2) = "PuPEvent 572"
' DungeonPuPVideos(3) = "PuPEvent 573"

debug2 "DONE INITIALISZING"
  CreateDarkString
  CreatePartyString
  CreateMonsterString
  CreateItemString
    TurnOffPlayfieldLights()
  DisplayOverlayCounts
  ClearItems
  ClearCharIcons
  'DisplayDungeonProgress
  UpdateDMD
  Light010.state = 2
  CheckDungeonLights  ' Re-light dungeons on continue
  PreviewNextChar
  SetDifficulty ' Make sure to call this at the end of game_init
  ScorbitBuildGameModes
  ReturnToVillage
  if DMDType = 0 Then
    UpdateBG
  Else
    UpdateDMD
  End If
  'dev.enabled = 1:bDisplayDev = "True" 'RTP7
' TrapdoorUp ' RTP7
' WallsUp ' RTP7
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub DisplayOverlayCounts
  if bEOBSupress = True And bDecision = False Then
    BallHandlingQueue.Add "DisplayOverlayCounts","DisplayOverlayCounts",70,1000,0,0,0,False
  Elseif bSupressDMD = True Then
    BallHandlingQueue.Add "DisplayOverlayCounts","DisplayOverlayCounts",70,1000,0,0,0,False
  Else
    Debug5 "in display overlay counts: " &bSupressBGMessages
    if DMDType = 0 And bSupressBGMessages = False Then
      DisplayRampCounts
      DisplaySpinCount
      DisplayTorchCount
      DisplaySacksOfGold
      DisplayOverlayIcons
    Elseif DMDType <> 0 Then
      DisplayRampCounts
      DisplaySpinCount
      DisplayTorchCount
      DisplaySacksOfGold
      DisplayOverlayIcons
    End If
  End If


End Sub

Sub DisplayOverlayIcons
  if DMDType = 0 And bSupressBGMessages = False Then
    if BSMode = 2 Then pBackglasslabelshow "BlacksmithOn"
    if GMode = 2 Then pBackglasslabelshow "GambleOn"
    if TMode = 2 Then pBackglasslabelshow "InTheDarkOn"
    if GoldSack(CurrentPlayer) > 0 Then pBackglasslabelshow "GoldSackOn"
  Else
    if BSMode = 2 Then pDMDlabelshow "BlacksmithOn"
    if GMode = 2 Then pDMDlabelshow "GambleOn"
    if TMode = 2 Then pDMDlabelshow "InTheDarkOn"
    if GoldSack(CurrentPlayer) > 0 Then pDMDlabelshow "GoldSackOn"
  End If
End Sub

Sub DisplayMagnetIcon
  if MagnetCheckTimer.Enabled = 1 Then
    if DMDType = 0 And bSupressBGMEssages = False Then
      pBackglasslabelshow "MagnetOn"
    Else
      pDMDlabelshow "MagnetOn"
    End If
  End If
End Sub


Sub DisplayTopOverlay
pBackglasslabelshow "Overlay2"
'PuPlayer.LabelSet pDMD "Overlay2","PuPOverlays\\topoverlay.png",32.6,25.0,80,50,1,1
End Sub

Sub HideTopOverlay
pBackglasslabelhide "Overlay2"
'PuPlayer.LabelSet pDMD "Overlay2","PuPOverlays\\topoverlay.png",32.6,25.0,80,50,1,0
end Sub

Sub HideKickBack
  pBackglassHideAnimate "kickbackGIF"
  'PuPlayer.LabelSet pBackglass,"KickBackStatus","",0,""
  'PuPlayer.LabelSet pBackglass,"KickBackStatus2","",0,""
end Sub

Sub HideExtraball
  pBackglassHideAnimate "ExtraballGIF"
  'PuPlayer.LabelSet pBackglass,"ExtraballStatus","",0,""
  'PuPlayer.LabelSet pBackglass,"ExtraballStatus2","",0,""  ' needs that leading space
  'PuPlayer.LabelSet pDMD,"ExtraballDMD","",0,""
End Sub

Sub HideMagnetMessages
  if DMDType = 0 Then
    pBackglasslabelhide "MagnetOn"
    pBackglassHideAnimate "MagnetLocked"
    PuPlayer.LabelSet pBackglass, "MagnetLockedText", "", 0, ""
  Else
    pDMDlabelhide "MagnetOn"
    pDMDHideAnimate "MagnetLocked"
    PuPlayer.LabelSet pDMD, "MagnetLockedText", "", 0, ""
  End If
end Sub

Sub MagnetMessage
  if DMDType = 0 And bSupressBGMessages = False then
    pBackglasslabelshow "MagnetOn"
  Else
    pDMDlabelshow "MagnetOn"
  End If
End Sub

Sub MagnetLockedMessage
  if DMDType = 0 And bSupressBGMessages = False Then
    pBackglassPNGAnimate "MagnetLocked", 120
    PuPlayer.LabelSet pBackglass,"MagnetLockedText","CAPTURED",1,"{'mt':2, 'size': 2.75, 'xpos': 69.6, 'xalign': 1, 'ypos': 15.6, 'yalign': 1 }"
  Else
    pDMDPNGAnimate "MagnetLocked", 120
    if DMDType = 2 Then
      PuPlayer.LabelSet pDMD,"MagnetLockedText","CAPTURED",1,"{'mt':2, 'size': 3.25, 'xpos': 69.6, 'xalign': 1, 'ypos': 15.6, 'yalign': 1 }"
    Else
      PuPlayer.LabelSet pDMD,"MagnetLockedText","CAPTURED",1,"{'mt':2,'size': 5.1, 'xpos': 64.0, 'xalign': 1, 'ypos': 96.5, 'yalign': 1 }"
    End If
  End If
End Sub

Sub ResetTorchTargets
Dim i

For i = 0 to 4
  TorchTargets(i) = 0
Next

End Sub

Sub EOBHide (caller)
  'dev.enabled = 0:bDisplayDev = "False": hidedev     'RTP7

Debug "EOBHide Called by: " &caller
  'GeneralPupQueue.Add "bSupressBGMessages-T","bSupressBGMessages = True",97,0,0,0,0,True
  bSupressBGMessages = True
  GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
  GeneralPupQueue.Add "Pup300","pupevent 300",96,200,0,0,0,True  ' make sure overlay disappears
  InVideo = 1
  ClearItems
  ClearCharIcons
  HideStrings
  HideKickBack
  pBackglassHideAnimate "ExtraballGIF"
  pBackglassHideAnimate "kickbackGIF"
  pBackglassLabelHide "RewardGold"
  pBackglassLabelHide "Wanted"
  pBackglasslabelhide "HeartMeter"
  pBackglasslabelhide "PRE" &NextChar

  if DMDType = 0 Then
    HideBG
  End If
  'HideDev
End Sub

Sub RedrawIcons
  if bSupressBGMessages = False Then
    pBackglasslabelshow "PRE"& NextChar
    CheckIconColors "RedrawIcons"
    CheckItemColors "RedrawIcons"
  End If
End Sub

Sub EOBReturn (caller)
'dim tmp4:tmp4 = caller
if bEndofGame = True Then Exit Sub

if bSupressBGMessages = False Then
  ScoreUpdate
  UpdateModeLabels
  UpdateBalls
  UpdatePlayer

  if BSMode = 2 Then pBackglasslabelshow "BlacksmithOn"
  if GMode = 2 Then pBackglasslabelshow "GambleOn"
  if TMode = 2 Then pBackglasslabelshow "InTheDarkOn"
  if GoldSack(CurrentPlayer) > 0 Then pBackglasslabelshow "GoldSackOn"
  DisplayMagnetIcon
  DisplayMagnetMessages
  DisplayOverlayCounts
End If

'Debug "EOB Return - Called By: " &tmp4
'Debug "in EOB RETURN- bEndOfGame: " &bEndOfGame
  GeneralPupQueue.Add "bSupressBGMessages-F","bSupressBGMessages = False",97,0,0,0,0,True
  if bDrain = 0 And bEndOfGame = False And bSupressBGMessages = False Then
    if bInn = False Then GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
    if bInn = False Then GeneralPupQueue.Add "Pup400","pupevent 400",95,0,0,0,0,False
    GeneralPupQueue.Add "Pup400","pupevent 400",94,200,0,0,0,True 'make sure it comes back
    InVideo = 0

    if bSupressBGMessages = False And KBActive = 1 And DebugKB = 0 Then
      pbackglasslabelhide "Wanted"
      pBackglassPNGAnimate "kickbackGIF", 60
    Else
      pBackglassLabelShow "Wanted"
    End If

    if ExtraBallsAwards(CurrentPlayer) > 0 Then
      pbackglasslabelhide "RewardGold"
      pBackglassPNGAnimate "ExtraballGIF",12
      if DMDType = 0 Then
        PuPlayer.LabelSet pBackglass, "ExtraballDMD","+1",1,""
      Else
        PuPlayer.LabelSet pDMD, "ExtraballDMD","+1",1,""
      End If
    Else
      pBackglassLabelShow "RewardGold"
    End If

    pBackglasslabelshow "HeartMeter"
    pBackglasslabelshow "PRE"& NextChar
    CheckIconColors "EOBReturn"
    CheckItemColors "EOBReturn"
    'bDisplayDev = "True"     ' RTP7
    BallHandlingQueue.Add "RedrawIcons","RedrawIcons",70,5000,0,0,0,False
  Else
    BallHandlingQueue.Add "EOBReturnSelf","EOBReturn Self",70,2000,0,0,0,False
  End If
  'if bEOBSupress = False Then bDisplayDev = "True":dev.enabled = 1  'RTP7
End Sub

Sub EOBReturn2 (caller)
if bEndofGame = True Then Exit Sub

Debug2 "in EOB RETURN2- bDrain: "& bDrain
'Debug "in EOB RETURN- bEndOfGame: " &bEndOfGame
  if bEndOfGame = False Then
    ReturnOverlay "EOBreturn2"
    'triggerscript 200, "ReturnOverlay ""EOBreturn2-backup"" " 'make sure it comes back
    InVideo = 0

    if bSupressBGMessages = False And KBActive = 1 And DebugKB = 0 Then
      pbackglasslabelhide "Wanted"
      pBackglassPNGAnimate "kickbackGIF", 60
    Else
      pBackglassLabelShow "Wanted"
    End If

    if ExtraBallsAwards(CurrentPlayer) > 0 Then
      pbackglasslabelhide "RewardGold"
      pBackglassPNGAnimate "ExtraballGIF",12
      if DMDType = 0 Then
        PuPlayer.LabelSet pBackglass, "ExtraballDMD","+1",1,""
      Else
        PuPlayer.LabelSet pDMD, "ExtraballDMD","+1",1,""
      End If
    Else
      pBackglassLabelShow "RewardGold"
    End If


    pBackglasslabelshow "HeartMeter"
    pBackglasslabelshow "PRE"& NextChar

    CheckIconColors "EOBReturn2"
    CheckItemColors "EOBReturn2"
    'bDisplayDev = "True"    ' RTP7
    BallHandlingQueue.Add "RedrawIcons","RedrawIcons",70,5000,0,0,0,False

  End If
End Sub

Sub ClearGuideMessages
  GuideMessage1 = ""
  GuideMessage2 = ""
  GuideMessage3 = ""
  DisplayGuideMessages
End Sub

Sub PreviewNextChar
if bEOBSupress = False And bSupressBGMessages = False Then
' DisplayOverlayCounts ' make sure overlay counts showing
  Debug "Hiding:" & NextChar
  pBackglasslabelhide "PRE"& NextChar
Dim r
' r  = int(1*RndNbr(8))
r = rndZeroArrayCol(Party,CurrentPlayer)

'Debug "r: " &r
  Select Case r
      Case -1:
        msgbox "PreviewNextChar Error"
      Case 0:
        if Party(CurrentPlayer,0) = 0 And NextChar <> "grave" Then
          pBackglasslabelshow "PREgrave"
          NextChar = "grave"
        Else
          Debug "* PREVIEW CHECK -- Grave Already in Party"
          PreviewNextChar
        end If
      Case 1:
        if Party(CurrentPlayer,1) = 0 And NextChar <> "highwayman" Then
          pBackglasslabelshow "PREhighwayman"
          NextChar = "highwayman"
        Else
          Debug "* PREVIEW CHECK -- Hwyman Already in Party"
          PreviewNextChar
        end If
      Case 2:
        if Party(CurrentPlayer,2) = 0 And NextChar <> "jester" Then
          pBackglasslabelshow "PREjester"
          NextChar = "jester"
        Else
          Debug "* PREVIEW CHECK -- Jester Already in Party"
          PreviewNextChar
        end If
      Case 3:
        if Party(CurrentPlayer,3) = 0 And NextChar <> "vestal" Then
          pBackglasslabelshow "PREvestal"
          NextChar = "vestal"
        Else
          Debug "* PREVIEW CHECK -- Vestal Already in Party"
          PreviewNextChar
        end If
      Case 4:
        if Party(CurrentPlayer,4) = 0 And NextChar <> "plague" Then
          pBackglasslabelshow "PREplague"
          NextChar = "plague"
        Else
          Debug "* PREVIEW CHECK -- Plague DR Already in Party"
          PreviewNextChar
        end If
      Case 5:
        if Party(CurrentPlayer,5) = 0 And NextChar <> "occultist" Then
          pBackglasslabelshow "PREoccultist"
          NextChar = "occultist"
        Else
          Debug "* PREVIEW CHECK -- Occultist Already in Party"
          PreviewNextChar
        end If
      Case 6:
        if Party(CurrentPlayer,6) = 0 And NextChar <> "crusader" Then
          pBackglasslabelshow "PREcrusader"
          NextChar = "crusader"
        Else
          Debug "* PREVIEW CHECK -- Crusader Already in Party"
          PreviewNextChar
        end If
      Case 7:
        if Party(CurrentPlayer,7) = 0 And NextChar <> "hound" Then
          pBackglasslabelshow "PREhound"
          NextChar = "hound"
        Else
          Debug "* PREVIEW CHECK -- Hound Already in Party"
          PreviewNextChar
        end If
      Case Else:
        MsgBox "Error: PreviewNExtChar " &NextChar
        Debug " Preview Char: Should not get here"
    End Select
Else
  triggerscript 3000, "PreviewNextChar"
End If
End Sub

Sub ClearBallPos
    For i = 0 to 6
        For j = 0 to 2
            BallPos(i, j) = 0
        Next
    Next
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub InstantInfo
    Dim tmp
'    DMD CL("INSTANT INFO"), "", "", eNone, eNone, eNone, 1000, True, ""
    Select Case Mode(CurrentPlayer, 0)
        Case 0 ' no Battle active
        Case 1 ' Minotaur
'            DMD CL("CURRENT MODE"), CL("MINOTAUR"), "", eNone, eNone, eNone, 2000, False, ""
'            DMD CL("SHOOT THE LIGHTS"), CL("AND SCOOP TO FINISH"), "", eNone, eNone, eNone, 2000, False, ""
        Case 2 ' Hydra
'            DMD CL("CURRENT MODE"), CL("Ruins"), "", eNone, eNone, eNone, 2000, False, ""
'            DMD CL("BATTLE CREATURES"), CL("AND LOOT"), "", eNone, eNone, eNone, 2000, False, ""
        Case 3 ' Cerberus
'            DMD CL("CURRENT MODE"), CL("CERBERUS"), "", eNone, eNone, eNone, 2000, False, ""
'            DMD CL("SHOOT THE LIGHTS"), CL("AND SCOOP TO FINISH"), "", eNone, eNone, eNone, 2000, False, ""
        Case 4 ' Medusa
 '           DMD CL("CURRENT MODE"), CL("MEDUSA"), "", eNone, eNone, eNone, 2000, False, ""
 '           DMD CL("SHOOT THE LIGHTS"), CL("AND SCOOP TO FINISH"), "", eNone, eNone, eNone, 2000, False, ""
        Case 5 ' Ares
  '          DMD CL("CURRENT MODE"), CL("ARES"), "", eNone, eNone, eNone, 2000, False, ""
  '           DMD CL("SHOOT THE SPINNERS"), CL("AND SCOOP TO FINISH"), "", eNone, eNone, eNone, 2000, False, ""
        Case 6 ' Poseidon
'            DMD CL("CURRENT MODE"), CL("POSEIDON"), "", eNone, eNone, eNone, 2000, False, ""
'            DMD CL("SHOOT LIT TARGETS"), CL("AND SCOOP TO FINISH"), "", eNone, eNone, eNone, 2000, False, ""
        Case 7 ' Hades
'            DMD CL("CURRENT MODE"), CL("HADES"), "", eNone, eNone, eNone, 2000, False, ""
'            DMD CL("SHOOT THE TRAPDOOR"), "", "", eNone, eNone, eNone, 2000, False, ""
        Case 8 ' Zeus
'            DMD CL("CURRENT MODE"), CL("ZEUS"), "", eNone, eNone, eNone, 2000, False, ""
'            DMD CL("HIT THE ZEUS TARGETS"), CL("AND SCOOP TO FINISH"), "", eNone, eNone, eNone, 2000, False, ""
        Case 9 ' God or Demi-God mode
'            DMD CL("CURRENT MODE"), CL("WIZARD MODE"), "", eNone, eNone, eNone, 2000, False, ""
'            DMD CL("HIT THE JACKPOTS"), "", "", eNone, eNone, eNone, 2000, False, ""
    End Select

'    DMD CL("YOUR SCORE"), CL(FormatScore(Score(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("EXTRA BALLS"), CL(ExtraBallsAwards(CurrentPlayer)), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("BONUS MULTIPLIER"), CL(FormatScore(BonusMultiplier(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("PLAYFIELD MULTIPLIER"), CL(FormatScore(PlayfieldMultiplier(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("SKILLSHOT VALUE"), CL(FormatScore(SkillshotValue(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("SUPR SKILLSHOT VALUE"), CL(FormatScore(SuperSkillshotValue(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("TARGETS HIT"), CL(FormatScore(BonusTargets(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("RAMPS HIT"), CL(FormatScore(BonusRamps(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("ORBITS HIT"), CL(FormatScore(BonusOrbits(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("COMBO VALUE"), CL(FormatScore(ComboValue(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("X HITS"), CL(FormatScore(BonusXHits(CurrentPlayer))), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("MONSTERS DEFEATED"), CL(TotalMonsters(CurrentPlayer)), "", eNone, eNone, eNone, 2000, False, ""
'    DMD CL("GODS DEFEATED"), CL(TotalGods(CurrentPlayer)), "", eNone, eNone, eNone, 2000, False, ""
    If Score(1)Then
 '       DMD CL("PLAYER 1 SCORE"), CL(FormatScore(Score(1))), "", eNone, eNone, eNone, 2000, False, ""
    End If
    If Score(2)Then
'        DMD CL("PLAYER 2 SCORE"), CL(FormatScore(Score(2))), "", eNone, eNone, eNone, 2000, False, ""
    End If
    If Score(3)Then
'        DMD CL("PLAYER 3 SCORE"), CL(FormatScore(Score(3))), "", eNone, eNone, eNone, 2000, False, ""
    End If
    If Score(4)Then
'        DMD CL("PLAYER 4 SCORE"), CL(FormatScore(Score(4))), "", eNone, eNone, eNone, 2000, False, ""
    End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub StopMBmodes 'stop multiball modes after loosing the last multibal
    DOF 208, DOFOff
    If Mode(CurrentPlayer, 0) = 9 Then StopMode(9) 'stop the God or Demi God multiball

  if Missions(CurrentPlayer,4) = 1 Then  ' DungeonMB was Started
        Missions(CurrentPlayer,4) = 0
         TrapdoorDown
    End If
    DOF 209, DOFOff
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub StopEndOfBallCrew()      'this sub is called after the last ball in play is drained, modes, timers
  ActiveMode = Mode(CurrentPlayer,0)
    StopMode(ActiveMode)                 'stop current mode
    'ResetLights                 'stop current mode
    TrapdoorDown
End Sub
'---------------------------------------------------------------------------------------------------------------------
'Sub StopEndOfBallMode()      'this sub is called after the last ball in play is drained, modes, timers
   ' StopMode                 'stop current mode
    'TrapdoorDown
    'LightSeqBumpers.StopPlay 'in case it was on.
'End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ResetNewBallVariables()  'reset variables and lights for a new ball or player
    'turn on or off the needed lights before a new ball is released
   ' TurnOffPlayfieldLights 'this also turn off extra ball and special lights
  Debug2 "in RNBV: " &bDecision
  if bDecision = False Then UpdateDMD
    BumperLights 0
    BonusMultiplier(CurrentPlayer) = 1
    PlayfieldMultiplier(CurrentPlayer) = 1
    bJackpotsEnabled = False

'-------------------------------------- Added by Merlin
  AddTrustPost  ' make sure trust post is there
  Debug "In RNBV: " & AMCombo
  if AMState <> 2 Then
    ResetNewBallLights ' Reset all the Lights for Mode 0
    MonstersCleared = 0
  End If
  ClearExtraball
  DisableKickback
  ClearGuideMessages
  DungeonBonus = 0
  CurrHero = ""
  LOHIT = 0
  ROHIT = 0
  INHIT = 0
  ORBHIT = 0
  CFCount = 0
  bExtraBallWonThisBall = 0
  OrbitHits=0
   For i = 0 to 5
    CryptMBCount(i) = 0
  Next

  CryptRound = 1

'---------------------------

    BumperHits = 0       'prepare for skillshot
    BumperAward = 5000
    gatekf.RotateToStart 'close the kickback
    leftoutlane.Enabled = 1
  gatekg.RotateToStart
  rightoutlane.Enabled = 1

  if bInn = True Then
    GetAM
    Select Case ActiveMode
      Case 0,1,3,5,7:
        if PartySize(CurrentPlayer) < 4 Then
          SetPartyLights
        End If
      Case Else:
        ' Do nothing
    End Select
  Elseif bVillage = True Then
    li047.state = 2
  End If

End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub RemoveTrustPost
Debug "Removing Trust Post"
zCol_Rubber_Post044.collidable = 0
zCol_Rubber_Post044.visible = 0
r25.visible = 0
primitive7.visible = 0
'RubberPin4.visible = 0
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub AddTrustPost
Debug "Adding Trust Post"
zCol_Rubber_Post044.collidable = 1
r25.visible = 1
primitive7.visible = 1
'RubberPin4.visible = 1
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub TurnOffPlayfieldLights()
    Dim a
    For each a in aLights
        a.State = 0
    Next
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub BumperLights(stat)
    Dim x
    For each x in aBumperLights
        x.State = stat
    Next
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub TurnOffXlights 'turn off the other lights after selecting a X light
    If li024.State = 2 Then li024.State = 0
    If li025.State = 2 Then li025.State = 0
    If li026.State = 2 Then li026.State = 0
    If li027.State = 2 Then li027.State = 0
    If li028.State = 2 Then li028.State = 0
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub UpdateSkillShot() 'Setup and updates the skillshot lights
    LightSeqSkillshot.Play SeqAllOff
'    DMD CL("HIT LIT LIGHT"), CL("FOR SKILLSHOT"), "", eNone, eNone, eNone, 3000, True, ""
  '  li044.State = 2
 '   li040.State = 2
    BumperLights 2            'blinking
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ResetSkillShotTimer_Timer 'timer to reset the skillshot lights & variables
    ResetSkillShotTimer.Enabled = 0
    bSkillShotReady = False
    bRotateLights = True
    LightSeqSkillshot.StopPlay
 '   li044.State = 0
  '  li040.State = 0
    BumperLights 1 'on
'    DMDScoreNow
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub CheckSkillshot
    If bSkillShotReady Then
        If BumperHits >= 3 Then
            AwardSkillshot
        End If
    End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub CheckSuperSkillshot
    If bSkillShotReady Then
        If LastSwitchHit = "hurrican" Then
            AwardSuperSkillshot
        End If
    End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub CheckFreakySkillshot
    If bSkillShotReady Then
        If LastSwitchHit = "swPlungerRest" Then
            AwardFreakySkillshot
        End If
    End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
'********************
' Flasher light seq.
'********************
'---------------------------------------------------------------------------------------------------------------------
Sub RBF 'right bottom Flasher
    LightSeqRBF.Play SeqBlinking, , 8, 40
    DOF 301, DOFPulse
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub RMF
    LightSeqRMF.Play SeqBlinking, , 8, 40
    DOF 304, DOFPulse
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub RTF
    LightSeqRTF.Play SeqBlinking, , 8, 40
    DOF 307, DOFPulse
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub LBF 'left bottom Flasher
    LightSeqLBF.Play SeqBlinking, , 8, 40
    DOF 310, DOFPulse
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub LMF
    LightSeqLMF.Play SeqBlinking, , 8, 40
    DOF 313, DOFPulse
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub LTF
    LightSeqLTF.Play SeqBlinking, , 8, 40
    DOF 316, DOFPulse
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub HelmetF
    LightSeqHelmet.Play SeqBlinking, , 8, 40
    DOF 319, DOFPulse
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ZeusF
    LightSeqZeusF.Play SeqRandom, 1, , 1500
    DOF 322, DOFPulse
End Sub
'-----------------------------------------------------------------------------------------------------------------------
Sub FlashEffect(n)
    Select Case n
        Case 1 'all blink
            LightSeqRBF.Play SeqBlinking, , 8, 40:DOF 301, DOFPulse
            LightSeqRMF.Play SeqBlinking, , 8, 40:DOF 304, DOFPulse
            LightSeqRTF.Play SeqBlinking, , 8, 40:DOF 307, DOFPulse
            LightSeqLBF.Play SeqBlinking, , 8, 40:DOF 310, DOFPulse
            LightSeqLMF.Play SeqBlinking, , 8, 40:DOF 313, DOFPulse
            LightSeqLTF.Play SeqBlinking, , 8, 40:DOF 316, DOFPulse
            LightSeqHelmet.Play SeqBlinking, , 8, 40:DOF 319, DOFPulse
        Case 2 'random

      LightSeqQueue.Add "LSeq1","LightSeqRBF.Play SeqBlinking, , 5, 40: DOF 302, DOFPulse",20,RndNbr(6) * 200,0,0,0,False
      LightSeqQueue.Add "LSeq2","LightSeqRMF.Play SeqBlinking, , 5, 40: DOF 305, DOFPulse",20,RndNbr(6) * 200,0,0,0,False
      LightSeqQueue.Add "LSeq3","LightSeqRTF.Play SeqBlinking, , 5, 40: DOF 308, DOFPulse",20,RndNbr(6) * 200,0,0,0,False
      LightSeqQueue.Add "LSeq4","LightSeqLBF.Play SeqBlinking, , 5, 40: DOF 311, DOFPulse",20,RndNbr(6) * 200,0,0,0,False
      LightSeqQueue.Add "LSeq5","LightSeqLMF.Play SeqBlinking, , 5, 40: DOF 314, DOFPulse",20,RndNbr(6) * 200,0,0,0,False
      LightSeqQueue.Add "LSeq6","LightSeqLTF.Play SeqBlinking, , 5, 40: DOF 317, DOFPulse",20,RndNbr(6) * 200,0,0,0,False
      LightSeqQueue.Add "LSeq7","LightSeqHelmet.Play SeqBlinking, , 5, 40: DOF 320, DOFPulse",20,RndNbr(6) * 200,0,0,0,False
        Case 3 'all blink fast
            LightSeqRBF.Play SeqBlinking, , 4, 30:DOF 302, DOFPulse
            LightSeqRMF.Play SeqBlinking, , 4, 30:DOF 305, DOFPulse
            LightSeqRTF.Play SeqBlinking, , 4, 30:DOF 308, DOFPulse
            LightSeqLBF.Play SeqBlinking, , 4, 30:DOF 311, DOFPulse
            LightSeqLMF.Play SeqBlinking, , 4, 30:DOF 314, DOFPulse
            LightSeqLTF.Play SeqBlinking, , 4, 30:DOF 317, DOFPulse
            LightSeqHelmet.Play SeqBlinking, , 4, 30:DOF 320, DOFPulse
        Case 4 'center
      LightSeqQueue.Add "LSeq1","LightSeqRBF.Play SeqBlinking, , 6, 30: DOF 302, DOFPulse",20,800,0,0,0,False
      LightSeqQueue.Add "LSeq2","LightSeqRMF.Play SeqBlinking, , 6, 30: DOF 305, DOFPulse",20,400,0,0,0,False
      LightSeqQueue.Add "LSeq3","LightSeqRTF.Play SeqBlinking, , 6, 30: DOF 308, DOFPulse",20,800,0,0,0,False
      LightSeqQueue.Add "LSeq4","LightSeqLBF.Play SeqBlinking, , 6, 30: DOF 311, DOFPulse",20,800,0,0,0,False
      LightSeqQueue.Add "LSeq5","LightSeqLMF.Play SeqBlinking, , 6, 30: DOF 314, DOFPulse",20,400,0,0,0,False
      LightSeqQueue.Add "LSeq6","LightSeqLTF.Play SeqBlinking, , 6, 30: DOF 317, DOFPulse",20,800,0,0,0,False
      LightSeqQueue.Add "LSeq7","LightSeqHelmet.Play SeqBlinking, , 6, 30:DOF 320, DOFPulse",20,1,0,0,0,False

        Case 5 'top down
      LightSeqQueue.Add "LSeq1","LightSeqRBF.Play SeqBlinking, , 2, 40: DOF 303, DOFPulse",20,200,0,0,0,False
      LightSeqQueue.Add "LSeq2","LightSeqRMF.Play SeqBlinking, , 2, 40: DOF 306, DOFPulse",20,100,0,0,0,False
      LightSeqQueue.Add "LSeq3","LightSeqRTF.Play SeqBlinking, , 2, 40:DOF 309, DOFPulse",20,1,0,0,0,False
      LightSeqQueue.Add "LSeq4","LightSeqLBF.Play SeqBlinking, , 2, 40: DOF 312, DOFPulse",20,200,0,0,0,False
      LightSeqQueue.Add "LSeq5","LightSeqLMF.Play SeqBlinking, , 2, 40: DOF 315, DOFPulse",20,100,0,0,0,False
      LightSeqQueue.Add "LSeq6","LightSeqLTF.Play SeqBlinking, , 2, 40:DOF 318, DOFPulse",20,1,0,0,0,False
      LightSeqQueue.Add "LSeq7","LightSeqHelmet.Play SeqBlinking, , 2, 40: DOF 321, DOFPulse",20,50,0,0,0,False

        Case 6 'down to top

      LightSeqQueue.Add "LSeq1","LightSeqRBF.Play SeqBlinking, , 2, 40:DOF 303, DOFPulse",20,1,0,0,0,False
      LightSeqQueue.Add "LSeq2","LightSeqRMF.Play SeqBlinking, , 2, 40: DOF 306, DOFPulse",20,100,0,0,0,False
      LightSeqQueue.Add "LSeq3","LightSeqRTF.Play SeqBlinking, , 2, 40: DOF 309, DOFPulse",20,200,0,0,0,False
      LightSeqQueue.Add "LSeq4","LightSeqLBF.Play SeqBlinking, , 2, 40:DOF 312, DOFPulse",20,1,0,0,0,False
      LightSeqQueue.Add "LSeq5","LightSeqLMF.Play SeqBlinking, ,2, 40: DOF 315, DOFPulse",20,100,0,0,0,False
      LightSeqQueue.Add "LSeq6","LightSeqLTF.Play SeqBlinking, , 2, 40: DOF 318, DOFPulse",20,200,0,0,0,False
      LightSeqQueue.Add "LSeq7","LightSeqHelmet.Play SeqBlinking, , 2, 40: DOF 321, DOFPulse",20,150,0,0,0,False

        Case 7 'circle 2 rounds
      LightSeqQueue.Add "LSeq1","LightSeqRBF.Play SeqBlinking, , 1, 40: DOF 303, DOFPulse",20,250,0,0,0,False
      LightSeqQueue.Add "LSeq2","LightSeqRMF.Play SeqBlinking, , 1, 40: DOF 306, DOFPulse",20,200,0,0,0,False
      LightSeqQueue.Add "LSeq3","LightSeqRTF.Play SeqBlinking, , 1, 40: DOF 309, DOFPulse",20,150,0,0,0,False
      LightSeqQueue.Add "LSeq4","LightSeqLBF.Play SeqBlinking, , 1, 40:DOF 312, DOFPulse",20,1,0,0,0,False
      LightSeqQueue.Add "LSeq5","LightSeqLMF.Play SeqBlinking, , 1, 40: DOF 315, DOFPulse",20,50,0,0,0,False
      LightSeqQueue.Add "LSeq6","LightSeqLTF.Play SeqBlinking, , 1, 40: DOF 318, DOFPulse",20,100,0,0,0,False
      LightSeqQueue.Add "LSeq7","LightSeqRBF.Play SeqBlinking, , 1, 40: DOF 303, DOFPulse",20,550,0,0,0,False
      LightSeqQueue.Add "LSeq8","LightSeqRMF.Play SeqBlinking, , 1, 40: DOF 306, DOFPulse",20,500,0,0,0,False
      LightSeqQueue.Add "LSeq9","LightSeqRTF.Play SeqBlinking, , 1, 40: DOF 309, DOFPulse",20,450,0,0,0,False
      LightSeqQueue.Add "LSeq10","LightSeqLBF.Play SeqBlinking, , 1, 40: DOF 312, DOFPulse",20,300,0,0,0,False
      LightSeqQueue.Add "LSeq11","LightSeqLMF.Play SeqBlinking, , 1, 40: DOF 315, DOFPulse",20,350,0,0,0,False
      LightSeqQueue.Add "LSeq12","LightSeqLTF.Play SeqBlinking, , 1, 40: DOF 318, DOFPulse",20,400,0,0,0,False

    End Select
End Sub

' *********************************************************************
'                        Table Object Hit Events
'
' Any target hit Sub will follow this:
' - play a sound
' - do some physical movement
' - add a score, bonus
' - check some variables/Mode this trigger is a member of
' - set the "LastSwitchHit" variable in case it is needed later
' *********************************************************************

'*********************************************************
' Slingshots has been hit
' In this table the slingshots change the outlanes lights

Dim LStep, RStep

Sub LeftSlingShot_Slingshot
  LBF
  PlaySound "sling_1"
  DOF 144, DOFPulse
    DOF 106, DOFPulse
  LS.VelocityCorrect(ActiveBall)
    If Tilted Then Exit Sub
  RandomSoundSlingshotLeft Lemk
    LeftSling004.Visible = 1
    Lemk.RotX = 26
    LStep = 0
    LeftSlingShot.TimerEnabled = True
    ' add some points
    AddScore 530
    ' check modes
    ' remember last trigger hit by the ball
    LastSwitchHit = "LeftSlingShot"
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub LeftSlingShot_Timer
    Select Case LStep
        Case 1:LeftSLing004.Visible = 0:LeftSLing003.Visible = 1:Lemk.RotX = 14
        Case 2:LeftSLing003.Visible = 0:LeftSLing002.Visible = 1:Lemk.RotX = 2
        Case 3:LeftSLing002.Visible = 0:Lemk.RotX = -20:LeftSlingShot.TimerEnabled = 0
    End Select
    LStep = LStep + 1
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub RightSlingShot_Slingshot
  RBF
    PlaySound "sling_1"
    DOF 107, DOFPulse
    DOF 145, DOFPulse
  RS.VelocityCorrect(ActiveBall)
    If Tilted Then Exit Sub
  RandomSoundSlingshotRight Remk
    RightSling004.Visible = 1
    Remk.RotX = 26
    RStep = 0
    RightSlingShot.TimerEnabled = True
    ' add some points
    AddScore 530
    LastSwitchHit = "RightSlingShot"
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub RightSlingShot_Timer
    Select Case RStep
        Case 1:RightSLing004.Visible = 0:RightSLing003.Visible = 1:Remk.RotX = 14
        Case 2:RightSLing003.Visible = 0:RightSLing002.Visible = 1:Remk.RotX = 2
        Case 3:RightSLing002.Visible = 0:Remk.RotX = -20:RightSlingShot.TimerEnabled = 0
    End Select
    RStep = RStep + 1
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub SlingTimer_Timer
    Select case SlingCount
        Case 0, 2, 4, 6, 8:Controller.B2SSetData 10, 1
        Case 1, 3, 5, 7, 9:Controller.B2SSetData 10, 0
        Case 10:SlingTimer.Enabled = 0
    End Select
    SlingCount = SlingCount + 1
End Sub
'---------------------------------------------------------------------------------------------------------------------
'***********************
'        Bumper
'***********************

Sub Bumper1_Hit
    If Tilted Then Exit Sub

    Dim tmp
  RandomSoundBumperTop Bumper1
    DOF 103, DOFPulse
    DOF 147, DOFPulse
    BumperHits = BumperHits + 1
    AddScore BumperAward

  Select Case ActiveMode
    Case 2,6,8,10,11,12,14:
      HeroCountDown = HeroCountDown + 2
      Playsound "Bell"
  End Select

  if Mode(CurrentPlayer,4) = 1 OR Mode(CurrentPlayer,13) = 1 Then
    DungeonProgress
  End If

  LBumper1a.State = 2
  LightSeqQueue.add "LBump1","LBumper1a.State = 0",10,500,0,1500,0,False

    'LastSwitchHit = "Bumper1"
    'checkmodes this switch is part of
    CheckSkillshot
    CheckBumperHits
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub Bumper2_Hit
    If Tilted Then Exit Sub
    Dim tmp
  RandomSoundBumperMiddle Bumper2
    DOF 104, DOFPulse
    DOF 147, DOFPulse
    BumperHits = BumperHits + 1
    AddScore BumperAward

  Select Case ActiveMode
    Case 2,6,8,10,11,12,14:
      HeroCountDown = HeroCountDown + 2
      Playsound "Bell"
  End Select

  if Mode(CurrentPlayer,4) = 1 OR Mode(CurrentPlayer,13) = 1 Then
    DungeonProgress
  End If

  LBumper2a.State = 2
  LightSeqQueue.add "LBump2","LBumper2a.State = 0",10,500,0,1500,0,False

    'LastSwitchHit = "Bumper2"
    'checkmodes this switch is part of
    CheckSkillshot
    CheckBumperHits
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub Bumper3_Hit
    If Tilted Then Exit Sub
    Dim tmp
  RandomSoundBumperMiddle Bumper3
    DOF 105, DOFPulse
    DOF 147, DOFPulse
    BumperHits = BumperHits + 1
    AddScore BumperAward

  Select Case ActiveMode
    Case 2,6,8,10,11,12,14:
      HeroCountDown = HeroCountDown + 2
      Playsound "Bell"
  End Select

  if Mode(CurrentPlayer,4) = 1 OR Mode(CurrentPlayer,13) = 1 Then
    DungeonProgress
  End If

  LBumper1a.State = 2
  LightSeqQueue.add "LBump1","LBumper1a.State = 0",10,500,0,1500,0,False
  LBumper2a.State = 2
  LightSeqQueue.add "LBump2","LBumper2a.State = 0",10,500,0,1500,0,False

    'LastSwitchHit = "Bumper3"
    'checkmodes this switch is part of
    CheckSkillshot
    CheckBumperHits
End Sub

'---------------------------------------------------------------------------------------------------------------------
Sub DisplayMBVideo

  if DMDType = 2 Then
    GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
    HideDMD 6000, True
    BallHandlingQueue.Add "Pup851","PuPEvent 851",40,0,0,0,0,True

    triggerscript 6200, "ReDisplayGuide"
  Else
    BallHandlingQueue.Add "Pup851","PuPEvent 851",40,0,0,0,0,True
  End If
  AudioQueue.Add "Pup264","PuPEvent 264",33,0,0,0,AudioExpiry,False
End Sub

Sub BumperMB
        BumperAward = BumperAward * 4
'        DMD CL("CHAIN LIGHTNING"), CL("BUMPER VALUE " &FormatScore(BumperAward)), "_", eNone, eNone, eNone, 3000, True, "vo_chain_lightning"
        FlashEffect RndNbr(7)
    AddMultiball 1
    DisplayMBVideo
        LightSeqBumpers.Play SeqRandom, 10, , 1000
End Sub

Sub CheckBumperHits
    If BumperHits MOD 30 = 0 Then 'activate chain lightning, bumpers score 4x
    if bBallInPlungerLane = True Then FireBall
  ' pNote "Bumpers AWARD","Granted"
    BumperAward = BumperAward * 4
'        DMD CL("CHAIN LIGHTNING"), CL("BUMPER VALUE " &FormatScore(BumperAward)), "_", eNone, eNone, eNone, 3000, True, "vo_chain_lightning"
    FlashEffect RndNbr(7)
    AddMultiball 1
    DisplayMBVideo
    LightSeqBumpers.Play SeqRandom, 10, , 1000
    End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub LightSeqBumpers_PlayDone()
    LightSeqBumpers.Play SeqRandom, 10, , 1000
End Sub

' loops
'---------------------------------------------------------------------------------------------------------------------
Sub hurrican_Hit
    DOF 190, DOFPulse
  Debug " Hurricane Hit"
    If Tilted Then Exit Sub
    'score & bonus

'    If li024.State = 2 Then
 '       li024.State = 1
        'TurnOffXlights   'MERLIN RTP
 '   End If



    'Combos
    If activeBall.VelY < 0 Then 'ball going up
        If LastSwitchHit = "upperloop2" OR LastSwitchHit = "upperloop4" Then
            AwardCombo
        Else
            ComboCount = 1
        End If
    End If
    LastSwitchHit = "hurrican"

End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub upperloop1_Hit
    DOF 191, DOFPulse
' Debug "UpperLoop1 Hit"
    If Tilted Then Exit Sub

  Debug "********** UPPER LOOP1 HIT ********"
    AddScore 1000 * MedussaX

    'Combos
    If activeBall.VelY < 0 Then 'ball going up
        If LastSwitchHit = "upperloop4" OR LastSwitchHit = "hurrican" Then
            AwardCombo
        Else
            ComboCount = 1
        End If

    End If
    LastSwitchHit = "upperloop1"
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub upperloop2_Hit
    DOF 192, DOFPulse
  Debug "UpperLoop2 Hit"
LastSwitchHit = "upperloop2"
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub upperloop3_Hit
    DOF 193, DOFPulse
  Debug "UpperLoop3 Hit"
LastSwitchHit = "upperloop3"
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub upperloop4_Hit
    DOF 194, DOFPulse
  Debug "UpperLoop4 Hit"
LastSwitchHit = "upperloop4"
End Sub

'---------------------------------------------------------------------------------------------------------------------
Sub tramp_Hit
    DOF 195, DOFPulse
Debug "Top Ramp Hit"
    If Tilted Then Exit Sub
  gi051.state = 1
  LTF:RTF
  CheckDisableUPF

'score & bonus

    If bJackpotsEnabled Then AwardJackpot

    ' check modes

    LastSwitchHit = "tramp"
End Sub

'Effect triggers

Sub Trigger001_Hit:LMF:End Sub
Sub Trigger002_Hit:LBF:End Sub
Sub Trigger003_Hit:RMF:End Sub
Sub Trigger004_Hit:RBF:End Sub
Sub Trigger005_Hit 'hidden entrance to start battle
    DOF 200, DOFPulse
' pNote "Trigger5", "Hit"
GetAM
  'pNote "AMState", ""&AMCombo
 '   DMD "_", CL("HIDDEN SHOT"), "_", eNone, eBlinkFast, eNone, 1500, True, "vo_og-growl"
    HiddenShots(CurrentPlayer) = HiddenShots(CurrentPlayer) + 1
    If HiddenShots(CurrentPlayer)MOD 3 = 0 Then
    'pNote "MULTIPLIER", "INCREASED"
        'AddPlayfieldMultiplier 1
        'FlashEffect 7
    End If
    'AddScore 10000
End Sub

'***********
' Targets
'***********

Dim DroppedDT(5) : DroppedDT(1)=1 : DroppedDT(2)=1 : DroppedDT(3)=1 : DroppedDT(4)=1 : DroppedDT(5)=1

Sub Target001_Hit
    DOF 201, DOFPulse
  Target001.collidable = False
  SoundDropTargetDrop target001
  If DroppedDT(1) = 0 Then
    DroppedDT(1) = 1
    if Mode(CurrentPlayer,0) <> 12 Then CheckAmbushComplete
    BOBA1.rotx = 4
  ' fixing  scoring and stuff here other non mech sounds ?
    if Mode(CurrentPlayer,12) = 1 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      'DisplayDungeonProgress
      WulfCnt = WulfCnt + 1
      HeroCountDownReset
      CheckWulfWin
    End If
  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub Target002_Hit
    DOF 202, DOFPulse
  Target002.collidable = False
  SoundDropTargetDrop target002
  If DroppedDT(2) = 0 Then
    DroppedDT(2) = 1
    if Mode(CurrentPlayer,0) <> 12 Then CheckAmbushComplete
    BOBA2.rotx = 4
  ' fixing  scoring and stuff here other non mech sounds ?
    if Mode(CurrentPlayer,12) = 1 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      'DisplayDungeonProgress
      WulfCnt = WulfCnt + 1
      HeroCountDownReset
      CheckWulfWin
    End If
  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub Target003_Hit
    DOF 203, DOFPulse
  Target003.collidable = False
  SoundDropTargetDrop target003
  If DroppedDT(3) = 0 Then
    DroppedDT(3) = 1
    if Mode(CurrentPlayer,0) <> 12 Then CheckAmbushComplete
    BOBA3.rotx = 4
  ' fixing  scoring and stuff here other non mech sounds ?
    if Mode(CurrentPlayer,12) = 1 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      'DisplayDungeonProgress
      WulfCnt = WulfCnt + 1
      HeroCountDownReset
      CheckWulfWin
    End If
  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub Target004_Hit
    DOF 204, DOFPulse
  Target004.collidable = False
  SoundDropTargetDrop target004
  If DroppedDT(4) = 0 Then
    DroppedDT(4) = 1
    if Mode(CurrentPlayer,0) <> 12 Then CheckAmbushComplete
    BOBA4.rotx = 4
  ' fixing  scoring and stuff here other non mech sounds ?
    if Mode(CurrentPlayer,12) = 1 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      'DisplayDungeonProgress
      WulfCnt = WulfCnt + 1
      HeroCountDownReset
      CheckWulfWin
    End If

  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub Target005_Hit
    DOF 205, DOFPulse
    Target005.collidable = False
    SoundDropTargetDrop target005
    If DroppedDT(5) = 0 Then
        DroppedDT(5) = 1
        if Mode(CurrentPlayer,0) <> 12 Then CheckAmbushComplete
        BOBA5.rotx = 4
    ' fixing  scoring and stuff here other non mech sounds ?
        if Mode(CurrentPlayer,12) = 1 Then
            RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
            'DisplayDungeonProgress
            WulfCnt = WulfCnt + 1
            HeroCountDownReset
            CheckWulfWin
        End If

    End If

End Sub

'Dim AmbushTotalCount
Sub CheckAmbushComplete

  if DroppedDT(1) + DroppedDT(2) + DroppedDT(3) + DroppedDT(4) + DroppedDT(5) = 5 Then' Ambush destroyed
    Debug "Ambush has been destroyed"
    AddScore2 250000
      if DMDType = 2 Then
        GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
        GeneralPupQueue.Add "HideDMD-6100","HideDMD 6100,True",90,0,0,0,0,True
        'GeneralPupQueue.Add "ReDisplayGuide","ReDisplayGuide",21,6100,0,0,0,False
        'GeneralPupQueue.Add "UpdateDMD","UpdateDMD",21,6200,0,0,0,False
      Else
        pup2helper 6000
      End If
    GeneralPuPQueue.Add "Pup990","PuPEvent 990",38,0,0,0,GenPuPExpiry,False
  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub Target001_Timer : me.timerenabled = False : Target001.isdropped = false : Target001.collidable = True : DroppedDT(1) = 0 : RandomSoundDropTargetReset target001 : End Sub
Sub Target002_Timer : me.timerenabled = False : Target002.isdropped = false : Target002.collidable = True : DroppedDT(2) = 0 : RandomSoundDropTargetReset target002 : End Sub
Sub Target003_Timer : me.timerenabled = False : Target003.isdropped = false : Target003.collidable = True : DroppedDT(3) = 0 : RandomSoundDropTargetReset target003 : End Sub
Sub Target004_Timer : me.timerenabled = False : Target004.isdropped = false : Target004.collidable = True : DroppedDT(4) = 0 : RandomSoundDropTargetReset target004 : End Sub
Sub Target005_Timer : me.timerenabled = False : Target005.isdropped = false : Target005.collidable = True : DroppedDT(5) = 0 : RandomSoundDropTargetReset target005 : End Sub


'---------------------------------------------------------------------------------------------------------------------
Sub RaiseDropTarget(nr,time)   ' 1-5 + timervalue in ms 1000 is one second
  Select Case nr
    Case 1 : Target001.timerinterval = time : Target001.timerenabled = False : Target001.timerenabled = True
    Case 2 : Target002.timerinterval = time : Target002.timerenabled = False : Target002.timerenabled = True
    Case 3 : Target003.timerinterval = time : Target003.timerenabled = False : Target003.timerenabled = True
    Case 4 : Target004.timerinterval = time : Target004.timerenabled = False : Target004.timerenabled = True
    Case 5 : Target005.timerinterval = time : Target005.timerenabled = False : Target005.timerenabled = True
  End Select
End Sub

Sub ResetWulf
Debug "********** RESET VVULF ************"
  HeroCountDownTimer.Enabled = 0
  Pulse.Enabled = 0
  DroppedDT(1) = 1 : RandomSoundDropTargetReset target001
  DroppedDT(2) = 1 : RandomSoundDropTargetReset target002
  DroppedDT(3) = 1 : RandomSoundDropTargetReset target003
  DroppedDT(4) = 1 : RandomSoundDropTargetReset target004
  DroppedDT(5) = 1 : RandomSoundDropTargetReset Target005
End Sub

Sub ChaseWulf
  currTarget = rndNumNot(1,5,lastTarget)
  RaiseDropTarget currTarget, 100
  lastTarget = currTarget
End Sub

Sub CheckWulfWin
' setlightcolor li024, green,1
' setlightcolor li025, green,1
' setlightcolor li006, green,1
' setlightcolor li008, green,1

  Select Case WulfCnt
    Case 1:
      setlightcolor li024, red,1
      setlightcolor li025, green,1
      setlightcolor li006, green,1
      setlightcolor li008, green,1
    Case 2:
      setlightcolor li024, red,1
      setlightcolor li025, green,1
      setlightcolor li006, red,1
      setlightcolor li008, green,1
    Case 3:
      setlightcolor li024, red,1
      setlightcolor li025, red,1
      setlightcolor li006, red,1
      setlightcolor li008, green,1
    Case 4:
      setlightcolor li024, red,1
      setlightcolor li025, red,1
      setlightcolor li006, white,0
      setlightcolor li008, green,1
    Case 5:
      setlightcolor li024, red,1
      setlightcolor li025, red,1
      setlightcolor li006, white,0
      setlightcolor li008, red,1
    Case 6:
      setlightcolor li024, white,0
      setlightcolor li025, red,1
      setlightcolor li006, white,0
      setlightcolor li008, red,1
    Case 7:
      setlightcolor li024, white,0
      setlightcolor li025, white,0
      setlightcolor li006, white,0
      setlightcolor li008, red,1
    Case 8:
      setlightcolor li024, white,0
      setlightcolor li025, white,0
      setlightcolor li006, white,0
      setlightcolor li008, white,0
  End Select

  if WulfCnt = 6 Then AudioQueue.Add "Pup279","PuPEvent 279",25,0,0,0,AudioExpiry,True

  if WulfCnt > 7 Then
    HeroCountDownOriginal
    HeroCountDownTimer.enabled = 0
    pulse.enabled = 0
    PuPHideBattle "winwulf"
    WinWulf
  Else
    ChaseWulf
  End If
End Sub


Sub CheckShamblerDefeated
  Dim Sham
  Sham = li036.state + li040.state + li051.state + li060.state

  if Sham = 0 Then ' if all lights are off then the shambler was defeated
    'Shambler defeated
    WinShambler
    Debug "CONGRATS YOU BEAT THE GAME, TIME FOR SOME JACKPOTS"
  End If

End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub LowerAllDTs
  SoundDropTargetDrop target005
  SoundDropTargetDrop target001
  SoundDropTargetDrop target003
  Target001.timerenabled = False
  Target002.timerenabled = False
  Target003.timerenabled = False
  Target004.timerenabled = False
  Target005.timerenabled = False
  Target001.isdropped = True
  Target001.collidable = False
  Target002.isdropped = True
  Target002.collidable = False
  Target003.isdropped = True
  Target003.collidable = False
  Target004.isdropped = True
  Target004.collidable = False
  Target005.isdropped = True
  Target005.collidable = False
  DroppedDT(1)=1
  DroppedDT(2)=1
  DroppedDT(3)=1
  DroppedDT(4)=1
  DroppedDT(5)=1
  Li041.state=0
  li042.state=0
  Li043.state=0
  li044.state=0
  li048.state=0
  BOBA5.blenddisablelighting=0
  BOBA4.blenddisablelighting=0
  BOBA3.blenddisablelighting=0
  BOBA2.blenddisablelighting=0
  BOBA1.blenddisablelighting=0
End Sub
'---------------------------------------------------------------------------------------------------------------------
' to Use
' RaiseDropTarget 1,10000   ' raise only Target001 after 10 seconds
Sub Timer16ms_Timer
'fixing can add more 16ms stuff here ... always On
  If DroppedDT(1) = 1 Then if BOBA1.z > -98 Then BOBA1.z = BOBA1.z - 5 : BOBA1.rotx = BOBA1.rotx - 0.3 :li041.state=0 :boba1.blenddisablelighting=0
  If DroppedDT(2) = 1 Then if BOBA2.z > -98 Then BOBA2.z = BOBA2.z - 5 : BOBA2.rotx = BOBA2.rotx - 0.3 :li042.state=0 :BOBA2.blenddisablelighting=0
  If DroppedDT(3) = 1 Then if BOBA3.z > -98 Then BOBA3.z = BOBA3.z - 5 : BOBA3.rotx = BOBA3.rotx - 0.3 :li043.state=0 :BOBA3.blenddisablelighting=0
  If DroppedDT(4) = 1 Then if BOBA4.z > -98 Then BOBA4.z = BOBA4.z - 5 : BOBA4.rotx = BOBA4.rotx - 0.3 :li044.state=0 :BOBA4.blenddisablelighting=0
  If DroppedDT(5) = 1 Then if BOBA5.z > -98 Then BOBA5.z = BOBA5.z - 5 : BOBA5.rotx = BOBA5.rotx - 0.3 :li048.state=0 :BOBA5.blenddisablelighting=0

  If DroppedDT(1) = 0 Then if BOBA1.z < -43 Then BOBA1.z = BOBA1.z + 9 : BOBA1.rotx = 0 : Else BOBA1.z = -43 :li041.state=1  :boba1.blenddisablelighting=7
  If DroppedDT(2) = 0 Then if BOBA2.z < -43 Then BOBA2.z = BOBA2.z + 9 : BOBA2.rotx = 0 : Else BOBA2.z = -43 :li042.state=1  :BOBA2.blenddisablelighting=7
  If DroppedDT(3) = 0 Then if BOBA3.z < -43 Then BOBA3.z = BOBA3.z + 9 : BOBA3.rotx = 0 : Else BOBA3.z = -43 :li043.state=1  :BOBA3.blenddisablelighting=7
  If DroppedDT(4) = 0 Then if BOBA4.z < -43 Then BOBA4.z = BOBA4.z + 9 : BOBA4.rotx = 0 : Else BOBA4.z = -43 :li044.state=1  :BOBA4.blenddisablelighting=7
  If DroppedDT(5) = 0 Then if BOBA5.z < -43 Then BOBA5.z = BOBA5.z + 9 : BOBA5.rotx = 0 : Else BOBA5.z = -43 :li048.state=1  :BOBA5.blenddisablelighting=7
End Sub

'---------------------------------------------------------------------------------------------------------------------

' captive ball
Sub cball_Hit
    DOF 206, DOFPulse

    If Tilted Then Exit Sub

if BSMode = 1 or GMode = 1 or TMode = 1 Then Exit Sub

  GetAM
  Select case ActiveMode  ' Change preview char each time cball is hit
    Case 0:
      AudioQueue.Add "Pup274", "PuPEvent 274",32,0,0,0,AudioExpiry,False
      CBHits(CurrentPlayer) = CBHits(CurrentPlayer) + 1
      if BallsInLock(CurrentPlayer) < 3 Then
        Triggerscript 1500, "PlaySound""vo_trapdoor"":TrapdoorUp "
      End If
      LightEffect 5
      Debug "CBALL HIT: " &CBHits(CurrentPlayer)
      If CBHits(CurrentPlayer)MOD 10 = 0 Then 'ball breaker
        '        DMD CL("BALL BREAKER"), CL(FormatScore(750000)), "_", eNone, eNone, eNone, 3000, True, "vo_ball_breaker"
        if DMDType <> 2 Then
          pup2helper 3000
        Else
          HideDMD 3005
        End If
        GeneralPuPQueue.Add "Pup790","PuPEvent 790",10,0,0,0,0,False
        AudioQueue.Add "Pup263","PuPEvent 263",32,0,0,0,AudioExpiry,False
        Addscore Score_CBallJackpot
      End If
    Case 1,3,5,7:
      AudioQueue.Add "Pup274", "PuPEvent 274",32,0,0,0,AudioExpiry,False
      if PartySize(CurrentPlayer) < 4 Then
        PreviewNextChar
      Else
        Triggerscript 500, "PlaySound""vo_trapdoor"":TrapdoorUp "
        LightEffect 5
      End If
    Case 9:
      ChangeCryptImages
      AudioQueue.Add "Pup274", "PuPEvent 274",32,0,0,0,AudioExpiry,False
      HideWizardModeMessage
      CBHits(CurrentPlayer) = CBHits(CurrentPlayer) + 1
      Debug "CBALL HIT: " &CBHits(CurrentPlayer)
      'DisplayCryptCount
        ' add a pup increment to the sidemission counter
      SetCryptLights
      Debug "Trapdoor opened for wizard  mode"
      Triggerscript 1500, "PLaySound""vo_trapdoor"":TrapdoorUp "
      Addscore Score_CBall
      LightEffect 3


      GeneralPupQueue.Add "EOBHide-WMP","EOBHide ""wizmodeprep"" ",41,0,0,0,0,True
      BallHandlingQueue.Add "Pup853","PuPEvent 853",50,0,0,0,0,True
      'GeneralPupQueue.Add "Pup900","pupevent 900",95,6100,0,0,0,True
      GeneralPupQueue.Add "Pup400","pupevent 400",95,6100,0,0,0,False
      GeneralPupQueue.Add "bSupressBGMessages-F","bSupressBGMessages = False",95,6100,0,0,0,False
      GeneralPupQueue.Add "EOBReturn-9","EOBReturn ""Mode 9""",95,6150,0,0,0,False
      'Triggerscript 6150, "EOBReturn ""Mode 9"" "

    Case 2,4,6,8,10,11,12,13,14:
      AudioQueue.Add "Pup265", "PuPEvent 265",32,0,0,0,AudioExpiry,False  ' Torchlight callout
      ResetTorches
  End Select

    LastSwitchHit = "cball"
End Sub


'---------------------------------------------------------------------------------------------------------------------
Sub TargetLightsAll(stat) 'same as light.state
    For each x in aTargetsAll
        x.State = stat
    Next
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub TargetLightsThunder(stat) 'same as light.state
    For each x in aTargetsThunder
        x.State = stat
    Next
End Sub

'---------------------------------------------------------------------------------------------------------------------

Sub ResetWT

  For i = 0 to 3
    WarrensTargets(i) = 0
  Next
End Sub

Sub ResetDT

  For i = 0 to 3
    DrownedTargets(i) = 0
  Next
End Sub

Sub ResetAmbushTargets

' For i = 0 to 4
'   DroppedDT(i) = 1
' Next
End Sub

'*************
'  Spinners
'*************
'---------------------------------------------------------------------------------------------------------------------
Sub rspin_Spin 'right
' Debug "Right Spinner Hit"
    SoundSpinner rspin
    DOF 129, DOFPulse
    If Tilted Then Exit Sub
  SpinnerHits = SpinnerHits + 1
    Addscore Score_Spinner
    ' check modes
  GetAM
  if Mode(CurrentPlayer,0) = 0 And CountBSRightSpin = 1 Then
    If TMode <> 1 AND GMode <> 1 Then
      Rightspincount
      'pBackglassLabelSetSizeImage "BlacksmithOn",3.2,5.6
      'pBackglassLabelSetPos "BlacksmithOn",35.75,4.3
      if bEOBSupress = False Then
        if DMDType = 0 And bSupressBGMessages = False Then
          pBackglassLabelFlash "BlacksmithOn",FlashTime,orange
        Elseif DMDType <> 0 Then
          pDMDLabelFlash "BlacksmithOn",FlashTime,orange
        End If
      End If
    End If
  end If
  if CountBSLeftSpin = 0 And CountBSRightSpin = 0 Then
    If TMode <> 1 AND GMode <> 1 Then
      CheckRightSpinWin
    End If
  End If
' Switch_Hit "rspin" ' no lastswitchhit here
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub lspin_Spin 'left
' Debug "Left Spinner Hit"
    SoundSpinner lspin
    DOF 128, DOFPulse
    If Tilted Then Exit Sub
  SpinnerHits = SpinnerHits + 1
    Addscore Score_Spinner
  GetAM
  if Mode(CurrentPlayer,0) = 0 And CountBSLeftSpin = 1  Then
    If TMode <> 1 AND GMode <> 1 Then
      LeftSpinCount
      if bEOBSupress = False Then
        if DMDType = 0 And bSupressBGMessages = False Then
          pBackglassLabelFlash "BlacksmithOn",FlashTime,orange
        Elseif DMDType <> 0 Then
          pDMDLabelFlash "BlacksmithOn",FlashTime,orange
        End If
      End If
    End If
  end If
  if CountBSLeftSpin = 0 And CountBSRightSpin = 0 Then
    If TMode <> 1 AND GMode <> 1 Then
      CheckLeftSpinWin
    End If
  End If
    ' check modes
' Switch_Hit "lspin"' no lastswitchhit here
End Sub

Sub CallAmbushPup (BID)
Debug "Ambush: " & InBattle
Debug "BATTLE: " & BattleID(CurrentPlayer) & "-" & BID
  if InBattle = 1 AND BattleID(CurrentPlayer) = BID then
    Triggerscript 6100, "DestroyAmbush"
      Debug "Passed Ambush Tests"
    if DMDType = 2 Then
      HideDMD 6000, True
      GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
    Else
      pup2helper 6000
    End If
    GeneralPuPQueue.Add "Pup960","PuPEvent 988",48,0,0,0,0,True
  Else
    Exit Sub
  End If

End Sub

'*********-----------------------------

Sub StartDTs
  BID = BattleID(CurrentPlayer)
  Timer16ms.Enabled = 1
  dim x,x2,y
  y =  int(Rnd(1)*8)
'y=1
    Select Case y
      case 1 : x=10000
        BattleQueue.Add "CallAmbushPup","CallAmbushPup BID",70,10000,0,0,0,False
        'triggerscript 10000, "CallAmbushPup BID"
      case 2 : x=20000
        BattleQueue.Add "CallAmbushPup","CallAmbushPup BID",70,20000,0,0,0,False
        'triggerscript 20000, "CallAmbushPup BID"
      case 3 : x=30000
        BattleQueue.Add "CallAmbushPup","CallAmbushPup BID",70,30000,0,0,0,False
        'triggerscript 30000, "CallAmbushPup BID"
      case else: x = 0
    End Select

  Debug  "in StartDTs: "&y
  Debug  "Value X: "&x

  If x > 0 Then
    For x2 = 1 to 5
      RaiseDropTarget x2,x
    Next
    'Triggerscript x+200, "DestroyAmbush"   ' Can maybe try this call in place of the 3 calls above
  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
'If occultist in the party then destroy the ambush
Sub DestroyAmbush

Debug "**** In Destroy Ambush ****"
'   PuPEvent 966   ' preventambush video?
    If Party(CurrentPlayer,5) = 1 Then


      Debug " Checking if Targets are up: " & DroppedDT(1)

      if DroppedDT(1) = 0 Then
        triggerscript 1000,"Target001_hit":Debug "Target1 was up"
        if DMDType = 2 Then
          GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
          GeneralPuPQueue.Add "Pup874","PuPEvent 874",38,0,0,0,GenPuPExpiry,False

          GeneralPupQueue.Add "ReDisplayGuide","ReDisplayGuide",40,4200,0,0,0,False
          GeneralPupQueue.Add "UpdateDMD","UpdateDMD",40,4300,0,0,0,False

          'triggerscript 4200, "ReDisplayGuide"
          'Triggerscript 4300, "UpdateDMD"
        Else
          GeneralPuPQueue.Add "Pup874","PuPEvent 874",38,0,0,0,GenPuPExpiry,False
          pup2helper 4000
        End If
      End If

      if DroppedDT(2) = 0 Then triggerscript 2000,"Target002_hit":Debug "Target2 was up"
      if DroppedDT(3) = 0 Then triggerscript 3000,"Target003_hit":Debug "Target3 was up"
      if DroppedDT(4) = 0 Then triggerscript 4000,"Target004_hit":Debug "Target4 was up"
      if DroppedDT(5) = 0 Then triggerscript 5000,"Target005_hit":Debug "Target5 was up"
    Else
      Debug "Occultist not in party"
    End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub RandomlyApplyAttributes
InBattle = 1
BID = BattleID(CurrentPlayer)

if Party(CurrentPlayer,0) = 1 Then
  Rando = (RndNbr(210) + 30) * 1000
  Debug "Apply Grave "&Rando & ":" & BattleID(CurrentPlayer)
  OrigGraBID = BattleID(CurrentPlayer)
  'BallHandlingQueue.Add "ApplyGrave","Rando, ""ApplyGrave BID"" ",70,0,0,0,0,True
  'Triggerscript Rando, "ApplyGrave OrigGraBID"
  BattleQueue.Add "ApplyGrave","ApplyGrave OrigGraBID",70,Rando,0,0,0,False
End If

if Party(CurrentPlayer,1) = 1 Then
  Rando = (RndNbr(90) + 5) * 1000
  Debug "Apply Hwyman "&Rando & ":" & BattleID(CurrentPlayer)
  OrigHwyBID = BattleID(CurrentPlayer)
  'BallHandlingQueue.Add "ApplyHwy","Rando, ""ApplyHwy OrigHwyBID"" ",70,0,0,0,0,True
  'Triggerscript Rando, "ApplyHwy OrigHwyBID
  BattleQueue.Add "ApplyHwy","ApplyHwy OrigHwyBID",70,Rando,0,0,0,False
End If

if Party(CurrentPlayer,3) = 1 Then
  Rando = (RndNbr(210) + 30) * 1000
  Debug "Apply Healer "&Rando & ":" & BattleID(CurrentPlayer)
  OrigVesBID = BattleID(CurrentPlayer)
  'BallHandlingQueue.Add "ApplyHealer","Rando, ""ApplyHealer BID"" ",70,0,0,0,0,True
  'Triggerscript Rando, "ApplyHealer OrigVesBID"
  BattleQueue.Add "ApplyHealer","ApplyHealer OrigVesBID",70,Rando,0,0,0,False
End If

if Party(CurrentPlayer,2) = 1 Then
  Rando = (RndNbr(90) + 5)*1000
  Debug "Apply Jester "&Rando & ":" & BattleID(CurrentPlayer)
  OrigJesBID = BattleID(CurrentPlayer)
  'BallHandlingQueue.Add "ApplyJester","Rando, ""ApplyJester BID"" ",70,0,0,0,0,True
  'Triggerscript Rando, "ApplyJester OrigJesBID"
  BattleQueue.Add "ApplyJester","ApplyJester OrigJesBID",70,Rando,0,0,0,False
End If

if Party(CurrentPlayer,4) = 1 Then
  Rando = (RndNbr(180) + 60) * 1000
  Debug "Apply Plague "&Rando & ":" & BattleID(CurrentPlayer)
  OrigPlaBID = BattleID(CurrentPlayer)
  'BallHandlingQueue.Add "ApplyPlague","Rando, ""ApplyPlague BID"" ",70,0,0,0,0,True
  'Triggerscript Rando, "ApplyPlague OrigPlaBID"
  BattleQueue.Add "ApplyPlague","ApplyPlague OrigPlaBID",70,Rando,0,0,0,False
End If
if Party(CurrentPlayer,6) = 1 Then
  Rando = (RndNbr(90) + 5) * 1000
  Debug "Apply Knight "&Rando & ":" & BattleID(CurrentPlayer)
  OrigCruBID = BattleID(CurrentPlayer)
  'BallHandlingQueue.Add "ApplyKnight","Rando, ""ApplyKnight BID"" ",70,0,0,0,0,True
  'Triggerscript Rando, "ApplyKnight OrigCruBID"
  BattleQueue.Add "ApplyKnight","ApplyKnight OrigCruBID",70,Rando,0,0,0,False
End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ApplyPartyAttributes
  if Party(CurrentPlayer,4) = 1 Then ' Plague DR
    Debug "Plague DR Madness prevention in place"
    'PuPEvent 965
    ' When in party madness cannot occur
  End If
  if Party(CurrentPlayer,5) = 1 Then ' Occultist
    'PuPEvent 966
    Debug " Occultist CLEAR AMBUSH"
    ' If Ambushed Occultist clears all BOBA targets
  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ApplyGrave (BID)
GraveTimer.Enabled = 1
Debug "ApplyGrave: " & InBattle &":" & BID
  if InBattle = 1 AND BattleID(CurrentPlayer) = OrigGraBID then
    if Party(CurrentPlayer,0) = 1 And PartySize(CurrentPlayer) < 4 Then '
      Debug "ApplyGrave: PASSED"
      GraveTimer.Enabled = 0
      if DMDType = 2 Then
        GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
        GeneralPupQueue.Add "ReDisplayGuide","ReDisplayGuide",40,4200,0,0,0,False
        GeneralPupQueue.Add "UpdateDMD","UpdateDMD",40,4300,0,0,0,False
      Else
        pup2helper 4000
      End If

      GeneralPuPQueue.Add "Pup876","PuPEvent 876",38,0,0,0,GenPuPExpiry,False
      hidedeadchar
      AddPartyMember
      AudioQueue.Add "Pup272","PuPEvent 272",30,0,0,0,AudioExpiry,False ' reinforcemtns arrived
      PuPDisplayBattle "applyGrave"' redisplay battle
      'End If
    Else
      Exit Sub
  '     Debug "ApplyGrave party already max size, try again in 20 seconds"
        'BallHandlingQueue.Add "ApplyGrave","ApplyGrave BattleID(CurrentPlayer)",70,20000,0,0,0,True
  '       BallHandlingQueue.Add "ApplyGrave","ApplyGrave BattleID(CurrentPlayer)",55,20000,0,0,0,True
        'triggerscript 20000, "ApplyGrave BattleID(CurrentPlayer) "  ' try again in 20 seconds

    End If
  Else
    GraveTimer.Enabled = 0
  End If
End Sub

Sub ApplyHwy (BID)
HwyMenTimer.Enabled = 1
Debug "ApplyHwy: " & InBattle &":" & OrigHwyBID
  if InBattle = 1 AND BattleID(CurrentPlayer) = OrigHwyBID then
    if Party(CurrentPlayer,1) = 1 And bMultiBallMode = 0 And bBallinPlungerLane = False Then ' Hwy - Make sure multiball mode is false
      Debug "ApplyHwy: PASSED"
      HwyMenTimer.Enabled = 0
      if DMDType = 2 Then
        GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
        GeneralPupQueue.Add "ReDisplayGuide","ReDisplayGuide",40,4200,0,0,0,False
        GeneralPupQueue.Add "UpdateDMD","UpdateDMD",40,4300,0,0,0,False
      Else
        pup2helper 4000
      End If

      Select Case ActiveMode
      Case 2,4,6,8,10,11,12,13:
        GeneralPuPQueue.Add "Pup870","PuPEvent 870",38,0,0,0,GenPuPExpiry,False
        AudioQueue.Add "Pup259","PuPEvent 259",32,0,0,0,AudioExpiry,False
        HwyMenAttrib = 1
        AddMultiball 1     'MERLIN
      End Select
    Elseif Party(CurrentPlayer,1) = 1 And bMultiBallMode = 0 And bBallinPlungerLane = True Then
      Exit Sub '  exit to retry later
    Else
      HwyMenTimer.Enabled = 0 ' Either hwymen is dead or in multiball so give up
    End If
  Else
    HwyMenTimer.Enabled = 0 ' Reset timer as battle is over
  End If
End Sub

Sub ApplyJester (BID)
JesterTimer.Enabled = 1
Debug "ApplyJester: " & InBattle &":" & OrigJesBID
  If InBattle = 1  AND BattleID(CurrentPlayer) = OrigJesBID Then
    if Party(CurrentPlayer,2) = 1 Then ' Jester
    Debug "ApplyJester: PASSED"
      JesterTimer.Enabled = 0
      if DMDType = 2 Then
        GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
        GeneralPupQueue.Add "ReDisplayGuide","ReDisplayGuide",40,4200,0,0,0,False
        GeneralPupQueue.Add "UpdateDMD","UpdateDMD",40,4300,0,0,0,False
      Else
        pup2helper 4000
      End If
      GeneralPuPQueue.Add "Pup871","PuPEvent 871",38,0,0,0,GenPuPExpiry,False
      Dim jst
      jst = RndNbr(10)
      Select Case jst
        Case 1,2,3,4,5,6,7:
          AudioQueue.Add "Pup260","PuPEvent 260",32,0,0,0,AudioExpiry,False
          Debug "Jester Good Bonus"
          AddItem
          AddItem
        Case Else:
          Debug "Jester Removed Trust Post"
          AudioQueue.Add "Pup261","PuPEvent 261",32,0,0,0,AudioExpiry,False
          RemoveTrustPost ' remove trust post for set time
          BallHandlingQueue.Add "AddTrustPost","AddTrustPost",55,30000,0,0,0,True
      End Select
    Else
      JesterTimer.Enabled = 0
    End If
  JesterTimer.Enabled = 0
  End If
End Sub

Sub ApplyHealer (BID)
VestalTimer.Enabled = 1
Debug "ApplyHealer: " & InBattle &":" & BID
  If InBattle = 1 AND BattleID(CurrentPlayer) = BID Then
    if Party(CurrentPlayer,3) = 1 Then ' Healer
      VestalTimer.Enabled = 0
    Debug "ApplyHealer: PASSED"
      if DMDType = 2 Then
        GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
        GeneralPupQueue.Add "ReDisplayGuide","ReDisplayGuide",40,4200,0,0,0,False
        GeneralPupQueue.Add "UpdateDMD","UpdateDMD",40,4300,0,0,0,False
      Else
        pup2helper 4000
      End If
      GeneralPuPQueue.Add "Pup872","PuPEvent 872",38,0,0,0,GenPuPExpiry,False
      AudioQueue.Add "Pup253","PuPEvent 253",32,0,0,0,AudioExpiry,False
      Debug " Healer Ball Saver"
      EnableBallSaver 20
        if Mode(CurrentPlayer,12) <> 1 Then
          HideBleed
          HeroCountDownMax = OriginalHeroCountDown
          HeroCountDownReset
          HeroTimerReset
        End If
    Else
      VestalTimer.Enabled = 0
    End If
    VestalTimer.Enabled = 0
  End If
End Sub

Sub ApplyPlague (BID)
PlagueTimer.Enabled = 1
Debug "ApplyPlague: " & InBattle &":" & BID
  If InBattle = 1  AND BattleID(CurrentPlayer) = BID Then
    if Party(CurrentPlayer,4) = 1 Then ' Plague
      PlagueTimer.Enabled = 0
    Debug "ApplyPlague: PASSED"
      AudioQueue.Add "Pup254","PuPEvent 254",32,3000,0,0,AudioExpiry,False
      ResetTorches
    Else
      PlagueTimer.Enabled = 0
    End If
  Else
    PlagueTimer.Enabled = 0
  End If
End Sub

Sub ApplyKnight (BID)
KnightTimer.Enabled = 1
Debug "ApplyKnight: " & InBattle &":" & BID
  If InBattle = 1  AND BattleID(CurrentPlayer) = BID Then
    if Party(CurrentPlayer,6) = 1 Then ' Knight
      KnightTimer.Enabled = 0
      Debug "ApplyKnight: PASSED"
      if KBActive Then
        Exit Sub
'       Debug "ApplyKnight KB already active, try again in 20 seconds"
'       BallHandlingQueue.Add "ApplyKnight","ApplyKnight BattleID(CurrentPlayer)",55,20000,0,0,0,True
'       AudioQueue.Add "Pup256","PuPEvent 256",32,0,0,0,AudioExpiry,False
        'triggerscript 20000, "ApplyKnight BattleID(CurrentPlayer) "  ' try again in 20 seconds
      Else
        KnightTimer.Enabled = 0
        if DMDType = 2 Then
          GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
          GeneralPupQueue.Add "ReDisplayGuide","ReDisplayGuide",40,4200,0,0,0,False
          GeneralPupQueue.Add "UpdateDMD","UpdateDMD",40,4300,0,0,0,False
        'triggerscript 4200, "ReDisplayGuide"
        'Triggerscript 4300, "UpdateDMD"
        Else
          pup2helper 4000
        End If
        GeneralPuPQueue.Add "Pup875","PuPEvent 875",38,0,0,0,GenPuPExpiry,False
        KickbackActive
        Debug " Knight kickback enabled"
        PlaySoundAt "fx_diverter", gatekf
        gatekf.RotateToEnd
        LMF:LBF
      End If
    End If
  Else
    KnightTimer.Enabled = 0
  End If
End Sub
'---------------------------------------------------------------------------------------------------------------------
Dim AnimSpeed: AnimSpeed = 60  ' lower number is faster animation speed
Dim PlayerAnimSpeed: PlayerAnimSpeed = 60  ' lower number is faster animation speed

' X,0,1 -- Alive
' X,0,0 -- Dead


Sub pupM1Display
'If MonstersCleared = 0 Then
Debug "M1: " & M1
Debug "GIF_MA1: " & GIF_MA(0,0,0)
' if GIF_MA(0,0,1) <> 2 Then
  if M1 = GIF_MA(0,0,0) Then
    M1 = GIF_MA(0,0,0) ' MON GIF
  Else
    M1 = GIF_MA(0,1,0) ' Dead GIF
  End If

    if M1 = "ShamblerAni" Then
      pBackglasslabelsetsizeimage "ShamblerAni",30,50
      pBackglasslabelsetpos "ShamblerAni", 76,42
    Elseif M1 = "ProphetAni" Then
      pBackglasslabelsetsizeimage "ProphetAni",34,50
      pBackglasslabelsetpos "ProphetAni", 76,42
    Elseif M1 = "DrownedCrewAni" Then
      pBackglasslabelsetsizeimage "DrownedCrewAni",24,54
      pBackglasslabelsetpos "DrownedCrewAni", 76,40
    Elseif M1 = "VvulfAni" Then
      pBackglasslabelsetsizeimage "VvulfAni",27,50
      pBackglasslabelsetpos "VvulfAni", 76,42
    Elseif M1 = "SwinePrinceAni" Then
      pBackglasslabelsetsizeimage "SwinePrinceAni",35,50
      pBackglasslabelsetpos "SwinePrinceAni", 76,42
    Elseif M1 = "HagAni" Then
      pBackglasslabelsetsizeimage "HagAni",30,50
      pBackglasslabelsetpos "HagAni", 76,40
    Else
      pBackglasslabelsetsizeimage M1,13,42
      pBackglasslabelsetpos M1, 59,46.5
    End If
    pBackglassPNGAnimate M1,AnimSpeed
'End If
End Sub

Sub pupM2Display
'If MonstersCleared = 0 Then
  if M2 = GIF_MA(1,0,0) Then
    M2 = GIF_MA(1,0,0) ' MON GIF
  Else
    M2 = GIF_MA(1,1,0) ' Dead GIF
  End If

  if  M2 <> "" Then
    pBackglasslabelsetsizeimage M2,13,42
    pBackglasslabelsetpos M2,70,46
    pBackglassPNGAnimate M2,AnimSpeed
  End If
'End If
End Sub

Sub pupM3Display
'If MonstersCleared = 0 Then
  if M3 = GIF_MA(2,0,0) Then
    M3 = GIF_MA(2,0,0) ' MON GIF
  Else
    M3 = GIF_MA(2,1,0) ' Dead GIF
  End If

  if M3 <> "" Then
    pBackglasslabelsetsizeimage M3,13,42
    pBackglasslabelsetpos M3, 82,47.25
    pBackglassPNGAnimate M3,AnimSpeed
  End If
'End If
End Sub

Sub pupM4Display
'If MonstersCleared = 0 Then
  if M4 = GIF_MA(3,0,0) Then
    M4 = GIF_MA(3,0,0) ' MON GIF
  Else
    M4 = GIF_MA(3,1,0) ' Dead GIF
  End If

  if M4 <> "" Then
    pBackglasslabelsetsizeimage M4,13,42
    pBackglasslabelsetpos M4, 94,46.6
    pBackglassPNGAnimate M4,AnimSpeed
  End If
'End If
End Sub

Sub pupP1Display
  if GIF_CA(0,0,1) = 1 Then
    P1 = GIF_CA(0,0,0) ' CHAR GIF
  Else
    P1 = GIF_CA(0,1,0) ' Dead GIF
  End If

  if P1 <> "" Then
    pBackglasslabelsetsizeimage P1,13,35
    pBackglasslabelsetpos P1,7,49
    pBackglassPNGAnimate P1,PlayerAnimSpeed
  End If
'End If
End Sub

Sub pupP2Display
  if GIF_CA(1,0,1) = 1 Then
    P2 = GIF_CA(1,0,0) ' CHAR GIF
  Else
    P2 = GIF_CA(1,1,0) ' Dead GIF
  End If

  if P2 <> "" Then
    pBackglasslabelsetsizeimage P2,13,35
    pBackglasslabelsetpos P2,18.5,50.5
    pBackglassPNGAnimate P2,PlayerAnimSpeed
  End If
'End If
End Sub

Sub pupP3Display
  if GIF_CA(2,0,1) = 1 Then
    P3 = GIF_CA(2,0,0) ' CHAR GIF
  Else
    P3 = GIF_CA(2,1,0) ' Dead GIF
  End If

  if P3 <> "" Then
    pBackglasslabelsetsizeimage P3,13,35
    pBackglasslabelsetpos P3,28.5,50
    pBackglassPNGAnimate P3,PlayerAnimSpeed
  End If
'End If
End Sub

Sub pupP4Display
  if GIF_CA(3,0,1) = 1 Then
    P4 = GIF_CA(3,0,0) ' CHAR GIF
  Else
    P4 = GIF_CA(3,1,0) ' Dead GIF
  End If

  if P4 <> ""  Then
    pBackglasslabelsetsizeimage P4,13,35
    pBackglasslabelsetpos P4,39.75,49.5
    pBackglassPNGAnimate P4,PlayerAnimSpeed
  End If
'End If
End Sub

'=======================================================
Sub ResetPlayerImages
Debug "*** In Reset Player Images ***"
  'Debug "P1: " & P1
  'Debug "P2: " & P2
  'Debug "P3: " & P3
  'Debug "P4: " & P4

  If P1 = "HighwaymanDead"  Then
    P1 = ""
  Elseif P1 = "JesterDead" Then
    P1 = ""
  Elseif P1 = "VestalDead" Then
    P1 = ""
  Elseif P1 = "PlagueDead" Then
    P1 = ""
  Elseif P1 = "OccultistDead" Then
    P1 = ""
  Elseif P1 = "CrusaderDead" Then
    P1 = ""
  Elseif P1 = "GraveDead" Then
    P1 = ""
  Elseif P1 = "HoundDead" Then
    P1 = ""
  End If

  If P2 = "HighwaymanDead"  Then
    P2 = ""
  Elseif P2 = "JesterDead" Then
    P2 = ""
  Elseif P2 = "VestalDead" Then
    P2 = ""
  Elseif P2 = "PlagueDead" Then
    P2 = ""
  Elseif P2 = "OccultistDead" Then
    P2 = ""
  Elseif P2 = "CrusaderDead" Then
    P2 = ""
  Elseif P2 = "GraveDead" Then
    P2 = ""
  Elseif P2 = "HoundDead" Then
    P2 = ""
  End If

  If P3 = "HighwaymanDead"  Then
    P3 = ""
  Elseif P3 = "JesterDead" Then
    P3 = ""
  Elseif P3 = "VestalDead" Then
    P3 = ""
  Elseif P3 = "PlagueDead" Then
    P3 = ""
  Elseif P3 = "OccultistDead" Then
    P3 = ""
  Elseif P3 = "CrusaderDead" Then
    P3 = ""
  Elseif P3 = "GraveDead" Then
    P3 = ""
  Elseif P3 = "HoundDead" Then
    P3 = ""
  End If

  If P4 = "HighwaymanDead"  Then
    P4 = ""
  Elseif P4 = "JesterDead" Then
    P4 = ""
  Elseif P4 = "VestalDead" Then
    P4 = ""
  Elseif P4 = "PlagueDead" Then
    P4 = ""
  Elseif P4 = "OccultistDead" Then
    P4 = ""
  Elseif P4 = "CrusaderDead" Then
    P4 = ""
  Elseif P4 = "GraveDead" Then
    P4 = ""
  Elseif P4 = "HoundDead" Then
    P4 = ""
  End If

Debug "*** AFTER Reset Player Images ***"
  'Debug "P1: " & P1
  'Debug "P2: " & P2
  'Debug "P3: " & P3
  'Debug "P4: " & P4
End Sub

Sub RestoreMonsterImages
Debug " BEFORE RestoreMonsterImages"
  Debug "M1: " &M1
  Debug "M2: " &M2
  Debug "M3: " &M3
  Debug "M4: " &M4

  if M1 = "MonsterDead1" Then
    M1 = ""
  Else
    M1 = GIF_MA(0,0,0)
  End If
  if M2 = "MonsterDead2" Then
    M2 =""
  Else
    M2 = GIF_MA(1,0,0)
  End If
  if M3 = "MonsterDead3" Then
    M3 = ""
  Else
    M3 = GIF_MA(2,0,0)
  End If
  if M4 = "MonsterDead4" Then
    M4 = ""
  Else
    M4 = GIF_MA(3,0,0)
  End If

Debug " AFTER In RestoreMonsterImages"
  Debug "M1: " &M1
  Debug "M2: " &M2
  Debug "M3: " &M3
  Debug "M4: " &M4


End Sub
'*********************************************************************************************************
Sub LoadShambler
  bRetry = False
  OldGI = "purple"
  ChangeGI purple
  setMonsterLightColorGreen
  Light010.state = 0
  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True
  Debug "Starting load shambler"
  'HeroCountDownTimer.Enabled = 0
  'pulse.enabled = 0
  UpdateModeLabels
  MonstersCleared = 0 ' Reset here as it wont be cleared at the Inn scoop
  TorchesEnabled = 0

  GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True
  if DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup312","PuPEvent 312",14,100,0,0,0,True


  ResetMonsters
  CreateMonsterString
' set lights for playfield
  ResetLights
  li036.state = 2
  li040.state = 2
  li051.state = 2
  li060.state = 2
  li037.state = 0 ' inside orbit
  li047.state = 0 ' turn off the Inn light
  li032.state = 0
  li021.state = 0
  li022.state = 0



  ' set proper Mode
  Mode(CurrentPlayer,0) = 14
  Mode(CurrentPlayer,14) = 1
  SetModeTitle
' Need a cleansing video to segue between the battles
  ClearMonsterImages
  ResetPlayerImages
  DisableBallLock
  GIF_MA(0,0,0) = "ShamblerAni"
  GIF_MA(1,0,0) = ""
  GIF_MA(2,0,0) = ""
  GIF_MA(3,0,0) = ""
  M1 = "ShamblerAni"
  M2 = ""
  M4 = ""
  M3 = ""

  DisableUPF
  GeneralPuPQueue.Add "Pup888","PuPEvent 888",40,100,0,0,0,True ' intro video
  GeneralPuPQueue.Add "LoadShambler2","LoadShambler2",40,5050,0,0,0,True
  CheckItemColors "shambler"
  CheckIconColors "shambler"
End Sub

Sub LoadShambler2
    DOF 252, DOFOn
  'HeroCountDownTimer.Enabled = 0
  'pulse.enabled = 0
  BallGlow 1, 240, 15


  PickDungeonBG
  DisplayDungeonBG

  GeneralPuPQueue.Add "PDB-LS","PuPDisplayBattle ""load shambler"" ",38,0,0,0,0,False ' Shambler Battle Video
  'GeneralPuPQueue.Add "Pup929","PuPEvent 929",40,0,0,0,0,True ' Shambler BG Video
  AudioQueue.Add "Pup443","PuPEvent 443",20,0,0,0,0,False ' Audio
  Addmultiball 3
  BallHandlingQueue.Add "Addmultiball-2","Addmultiball 2",55,180000,0,0,0,True
End Sub
'*********************************************************************************************************
Sub LoadProphet
  bRetry = False
  OldGI = "purple"
  ChangeGI purple
  'InBattle = 1
  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True
  setMonsterLightColorGreen
  Light010.state = 0


  GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True
  if DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup306","PuPEvent 306",14,0,0,0,0,True


  MonstersCleared = 0 ' Reset here as it wont be cleared at the Inn scoop
  TorchesEnabled = 1

  ResetMonsters
  CreateMonsterString

' set lights for playfield
  ResetLights
  li036.state = 2
  li040.state = 2
  li047.state = 0 ' turn off the Inn light


  ' set proper Mode
  Mode(CurrentPlayer,0) = 10
  Mode(CurrentPlayer,10) = 1
  SetModeTitle
' Need a cleansing video to segue between the battles
  ClearMonsterImages
  ResetPlayerImages
  DisableBallLock

  GIF_MA(0,0,0) = "ProphetAni"
  GIF_MA(1,0,0) = ""
  GIF_MA(2,0,0) = ""
  GIF_MA(3,0,0) = ""
  M1 = "ProphetAni"
  M2 = ""
  M4 = ""
  M3 = ""
  ResetUPF

  CheckItemColors "Prophet"
  CheckIconColors "Prophet"

  GeneralPuPQueue.Add "Pup884","PuPEvent 884",40,500,0,0,0,True    ' intro video prophet
  GeneralPuPQueue.Add "LoadProphet2","LoadProphet2",40,5700,0,0,0,True    ' intro video prophet
  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,7300,0,0,0,False
  GeneralPuPQueue.Add "DisplayHelper","DisplayHelper",5,7300,0,0,0,False ' wait for battle video to complete

End Sub

Sub LoadProphet2
  Debug "Load Prophet: " &bSupressDMD
    DOF 248, DOFOn
  GeneralPuPQueue.Add "Pup306","PuPEvent 306",14,100,0,0,0,True
  GeneralPuPQueue.Add "UpdateDMD","UpdateDMD",12,0,0,0,0,False

  AudioQueue.Add "Pup439","PuPEvent 439",20,0,0,0,0,False ' dungeonmusic
  BallGlow 1, 200, 15
  MonsterLightReset

  'GeneralPuPQueue.Add "Pup921","PuPEvent 921",78,0,0,0,0,True
  PickDungeonBG
  DisplayDungeonBG
  GeneralPuPQueue.Add "PDB-LP","PuPDisplayBattle ""load prophet"" ",38,0,0,0,0,False ' Prophet BG Video

End Sub

'##################################################################################
Sub LoadDrownedCrew
  bRetry = False
  'InBattle = 1
  OldGI = "blue"
  ChangeGI blue

  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True
' set lights for playfield
  ResetLights
  monsterlightreset
  setMonsterLightColorGreen
  setUPFLightColorGreen
  Light010.state = 0

Debug "Starting load Drowned Crew"
  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,5700,0,0,0,False
  GeneralPuPQueue.Add "DisplayHelper","DisplayHelper",5,5700,0,0,0,False ' wait for battle video to complete

  MonstersCleared = 0 ' Reset here as it wont be cleared at the Inn scoop
  TorchesEnabled = 0
  Table1.ColorGradeImage = "LUT14"
  ResetMonsters
  CreateMonsterString

  li047.state = 0 ' turn off the Inn light

  GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True
  if DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup307","PuPEvent 307",14,0,0,0,0,True

  ' set proper Mode
  Mode(CurrentPlayer,0) = 11
  Mode(CurrentPlayer,11) = 1
  SetModeTitle
' Need a cleansing video to segue between the battles
  ClearMonsterImages
  ResetPlayerImages
  DisableBallLock
  GIF_MA(0,0,0) = "DrownedCrewAni"
  GIF_MA(1,0,0) = ""
  GIF_MA(2,0,0) = ""
  GIF_MA(3,0,0) = ""
  M1 = "DrownedCrewAni"
  M2 = ""
  M4 = ""
  M3 = ""

  CheckItemColors "DrownedCrew"
  CheckIconColors "DrownedCrew"

  GeneralPuPQueue.Add "Pup885","PuPEvent 885",40,500,0,0,0,True   ' intro video drowned crew
  GeneralPuPQueue.Add "LoadDrownedCrew2","LoadDrownedCrew2",40,5600,0,0,0,True   ' intro video drowned crew

End Sub

Sub LoadDrownedCrew2
    DOF 261, DOFOn
  Gi051.state = 1 ' turn on UPF
  GeneralPuPQueue.Add "UpdateDMD","UpdateDMD",12,0,0,0,0,False

  AudioQueue.Add "Pup440","PuPEvent 440",20,0,0,0,0,False ' Drowned Crew Music
  GlowMod = 10
  BallGlow 3, 200, 12

  'GeneralPuPQueue.Add "Pup922","PuPEvent 922",78,0,0,0,0,True' Drowned Crew BG Video
  PickDungeonBG
  DisplayDungeonBG
  GeneralPuPQueue.Add "PDB-LDC","PuPDisplayBattle ""load Drowned Crew"" ",38,0,0,0,0,False
  AudioQueue.Add "Pup228","PuPEvent 228",20,0,0,0,AudioExpiry,False

  MonsterLightReset
  'GetAM
  TotalMonsterHits = 8
  'DisplayDungeonProgress
  li047.state = 0 ' turn off the Inn light
End Sub
'*********************************************************************************************************
Sub LoadWulf
  bRetry = False
  OldGI = "red"
  ChangeGI red
  setMonsterLightColorGreen
  Light010.state = 0
  'InBattle = 1
  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True
Debug "Starting load wulf"
  AudioQueue.Add "Pup229","PuPEvent 229",20,8000,0,0,AudioExpiry,False

  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,5400,0,0,0,False
  GeneralPuPQueue.Add "DisplayHelper","DisplayHelper",5,5400,0,0,0,False ' wait for battle video to complete

  'InGuide = 1
  GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True
  if DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup308","PuPEvent 308",14,100,0,0,0,True

  MonstersCleared = 0 ' Reset here as it wont be cleared at the Inn scoop
  TorchesEnabled = 1
  'Table1.ColorGradeImage = "LUT-Dusk130"

  ResetMonsters
  CreateMonsterString
' set lights for playfield
  ResetLights
  li047.state = 0 ' turn off the Inn light

  ' set proper Mode
  Mode(CurrentPlayer,0) = 12
  Mode(CurrentPlayer,12) = 1
  SetModeTitle
' Need a cleansing video to segue between the battles
  ClearMonsterImages
  ResetPlayerImages
  DisableBallLock
  GIF_MA(0,0,0) = "VvulfAni"
  GIF_MA(1,0,0) = ""
  GIF_MA(2,0,0) = ""
  GIF_MA(3,0,0) = ""
  M1 = "VvulfAni"
  M2 = ""
  M4 = ""
  M3 = ""

  bKillUPF = True
  CheckDisableUPF
  CheckItemColors "Vvulf"
  CheckIconColors "Vvulf"

  GeneralPuPQueue.Add "Pup886","PuPEvent 886",40,200,0,0,0,True  ' intro video Vvulf
  GeneralPuPQueue.Add "LoadWulf2","LoadWulf2",40,5250,0,0,0,True  ' intro video Vvulf

End Sub

Sub LoadWulf2
    DOF 250, DOFOn
  GeneralPuPQueue.Add "UpdateDMD","UpdateDMD",12,0,0,0,0,False

  AudioQueue.Add "Pup441","PuPEvent 441",20,0,0,0,0,False' vvulf bg audio
  li047.state = 0 ' turn off the Inn light
  BallGlow 5, 180, 25

  ChaseWulf
  'GeneralPuPQueue.Add "Pup923","PuPEvent 923",78,0,0,0,0,True
  PickDungeonBG
  DisplayDungeonBG
  GeneralPuPQueue.Add "PDB-LW","PuPDisplayBattle ""load wulf"" ",38,0,0,0,0,False

  setlightcolor li024, green,1
  setlightcolor li025, green,1
  setlightcolor li006, green,1
  setlightcolor li008, green,1
End Sub
'*************************************************************************************************

Sub LoadSwinePrince
  bRetry = False
  OldGI = "pink"
  ChangeGI pink
  setMonsterLightColorGreen
  Light010.state = 0
  BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
  BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True
Debug "Starting load SwinePrince"

  GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Press Either Flipper to Enter Battle"" ",6,5400,0,0,0,False
  GeneralPuPQueue.Add "DisplayHelper","DisplayHelper",5,5400,0,0,0,False ' wait for battle video to complete
  AudioQueue.Add "Pup226","PuPEvent 226",20,8000,0,0,AudioExpiry,False' shoot bumpers

  GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True
  if DMDType <> 2 Then pupflasher1.visible=true
  GeneralPuPQueue.Add "Pup309","PuPEvent 309",14,100,0,0,0,True

  wall66up
  MonstersCleared = 0 ' Reset here as it wont be cleared at the Inn scoop
  TorchesEnabled = 0
  DarknessLayer.Opacity = 90


  ResetMonsters
  CreateMonsterString

  ResetLights
  li047.state = 0 ' turn off the Inn light

  ' turn on bumpers ?
  Lbumper1a.state=2
  Lbumper1b.state=2
  Lbumper2a.state=2
  Lbumper2b.state=2

  ' set proper Mode
  Mode(CurrentPlayer,0) = 13
  Mode(CurrentPlayer,13) = 1
  SetModeTitle
' Need a cleansing video to segue between the battles
  ClearMonsterImages
  ResetPlayerImages
  DisableBallLock
  GIF_MA(0,0,0) = "SwinePrinceAni"
  GIF_MA(1,0,0) = ""
  GIF_MA(2,0,0) = ""
  GIF_MA(3,0,0) = ""
  M1 = "SwinePrinceAni"
  M2 = ""
  M4 = ""
  M3 = ""

  ResetUPF

  CheckItemColors "swine"
  CheckIconColors "swine"

  GeneralPuPQueue.Add "Pup887","PuPEvent 887",40,200,0,0,0,True  ' intro video swine prince
  GeneralPuPQueue.Add "LoadSwinePrince2","LoadSwinePrince2",40,5300,0,0,0,True  ' intro video Vvulf

End Sub

Sub LoadSwinePrince2
    DOF 251, DOFOn
  GeneralPuPQueue.Add "UpdateDMD","UpdateDMD",12,0,0,0,0,False

' InGuide = 1

  'PuPEvent 205   ' not sure what this call was vent doesnt exist
  AudioQueue.Add "Pup441","PuPEvent 441",20,0,0,0,0,False 'swine prince BG audio
  li047.state = 0 ' turn off the Inn light
  BallGlow 9, 180, 25

  'GeneralPuPQueue.Add "Pup924","PuPEvent 92",78,0,0,0,0,True
  PickDungeonBG
  DisplayDungeonBG
  GeneralPuPQueue.Add "PDB-LS","PuPDisplayBattle ""load SwinePrince"" ",38,0,0,0,0,False

  MonsterLightReset

  TotalMonsterHits = 24
  'DisplayDungeonProgress
End Sub

'*************************************************************************************************
Sub ClearPlayerImages
  P1 = ""
  P2 = ""
  P3 = ""
  P4 = ""
End Sub

Sub ClearMonsterImages
  'ResetMonsterArray
  M1 = ""
  M2 = ""
  M3 = ""
  M4 = ""
End Sub

Sub ResetMonsterArray
Dim i,j,k
    For i = 0 to 4
        For j = 0 to 2
      For k = 0 to 2
            GIF_MA(i, j, k) = 0
      Next
        Next
    Next
End Sub

Sub RefreshBG
  CheckItemColors "RefreshBG"
  CheckIconColors "RefreshBG"
End Sub

Sub DisplayDungeonBG
  GeneralPuPQueue.Add CurrentDungeonBG,CurrentDungeonBG,78,0,0,0,0,True
End Sub

Sub DisplayDungeonBG2
GetAM
  Select Case ActiveMode
    Case 2,10:
      GeneralPuPQueue.Add "Pup925","PuPEvent 925",78,0,0,0,0,True
    Case 4,11:
      GeneralPuPQueue.Add "Pup926","PuPEvent 926",78,0,0,0,0,True
    Case 6,12:
      GeneralPuPQueue.Add "Pup927","PuPEvent 927",78,0,0,0,0,True
    Case 8,13:
      GeneralPuPQueue.Add "Pup928","PuPEvent 928",78,0,0,0,0,True
    Case 14:
      GeneralPuPQueue.Add "Pup929","PuPEvent 929",78,0,0,0,0,True
    Case Else:
      GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
  End Select
End Sub

Sub PuPDisplayBattle(caller)

Debug "&&&& PuPDisplay Called by: " &caller
  GetAM
'Debug "&&&&& PupDisplayBattle - AMSTATE: " &AMState
'Debug "&&&&& PupDisplayBattle - InBattle: " &InBattle
  if AMState = 1 Then
    'if InVideo = 0 Then  '128.6
      Debug "&&&&& Displaying Battle: "&caller

      Debug "about to cehck item"
      CheckItemColors "PUPDisplayBattle"
      CheckIconColors "PUPDisplayBattle"
      pupP1Display
      pupP2Display
      pupP3Display
      pupP4Display
      pupM1Display
      pupM2Display
      pupM3Display
      pupM4Display

      if BleedActive = 1 Then
        triggerscript 300, "CheckBleed"
      End If
    'Else  '128.6
    ' triggerscript 1000, "PuPdisplayBattle ""itself"" "   '128.6
    'End If   '128.6
  End If
'End If
End Sub

Sub CheckBleed
  if GIF_CA(0,0,1) = 1 then pBackglasslabelshow "Blood10"
  if GIF_CA(1,0,1) = 1 then pBackglasslabelshow "Blood11"
  if GIF_CA(2,0,1) = 1 then pBackglasslabelshow "Blood12"
  if GIF_CA(3,0,1) = 1 then pBackglasslabelshow "Blood13"
End Sub

Sub ReplaceDeadChar ' Empty the first dead character pup GIF so the new one can be added for Vial
' Debug "P1: " & P1
' Debug "P2: " & P2
' Debug "P3: " & P3
' Debug "P4: " & P4


  if P1 = "HighwaymanDead" or P1 = "JesterDead" or P1 = "VestalDead" or P1 = "PlagueDead" or P1 = "CrusaderDead" or P1 = "OccultistDead" or P1 = "GraveDead" or P1 = "HoundDead" Then
    P1 = ""
    'PuPDisplayBattle "ReplaceDeadChar"
  elseif P2 = "HighwaymanDead" or P2 = "JesterDead" or P2 = "VestalDead" or P2 = "PlagueDead" or P2 = "CrusaderDead" or P2 = "OccultistDead" or P1 = "GraveDead" or P1 = "HoundDead" Then
    P2 = ""
    'PuPDisplayBattle "ReplaceDeadChar"
  elseif P3 = "HighwaymanDead" or P3 = "JesterDead" or P3 = "VestalDead" or P3 = "PlagueDead" or P3 = "CrusaderDead" or P3 = "OccultistDead" or P1 = "GraveDead" or P1 = "HoundDead" Then
    P3 = ""
    'PuPDisplayBattle "ReplaceDeadChar"
  elseif P4 = "HighwaymanDead" or P4 = "JesterDead" or P4 = "VestalDead" or P4 = "PlagueDead" or P4 = "CrusaderDead" or P4 = "OccultistDead" or P1 = "GraveDead" or P1 = "HoundDead" Then
    P4 = ""
    'PuPDisplayBattle "ReplaceDeadChar"
  End If
'Debug "AFTER REPLACE"
' Debug "P1: " & P1
' Debug "P2: " & P2
' Debug "P3: " & P3
' Debug "P4: " & P4
End Sub
'==================================
Sub HideDeadChar
' Debug "P1: " & P1
' Debug "P2: " & P2
' Debug "P3: " & P3
' Debug "P4: " & P4

dim i
For i = 0 to 3
  Debug "Hide: " &i  &" : " &GIF_CA(i,0,1)
  If GIF_CA(i,0,1) = 0 Then
    Select Case i
      Case 0:
        P1 = ""
      Case 1:
        P2 = ""
      Case 2:
        P3 = ""
      Case 3:
        P4 = ""
    End Select
  pBackglasslabelhide GIF_CA(i,1,0)
  End If
Next

'Debug "AFTER REPLACE"
' Debug "P1: " & P1
' Debug "P2: " & P2
' Debug "P3: " & P3
' Debug "P4: " & P4
End Sub
'==================================
Sub KillPupChar2
'FindChar Char
Dim r
r = CharPosition


    pBackglasslabelhide GIF_CA(r,0,0)
    pBackglasslabelsetsizeimage GIF_CA(r,1,0),13,33
    if r = 0 Then
      pBackglasslabelhide "Blood10"
      pBackglasslabelsetpos GIF_CA(r,1,0),7,49
    elseif r = 1 Then
      pBackglasslabelhide "Blood11"
      pBackglasslabelsetpos GIF_CA(r,1,0),18.5,50.5
    elseif r = 2 Then
      pBackglasslabelhide "Blood12"
      pBackglasslabelsetpos GIF_CA(r,1,0),28.5,50
    elseif r = 3 Then
      pBackglasslabelhide "Blood13"
      pBackglasslabelsetpos GIF_CA(r,1,0),39.75,49.5
    End If
    pBackglasslabelshow GIF_CA(r,1,0)

End Sub

'==================================

Sub KillPupChar (CharDead, CharDead2)

    if P1 = CharDead Then
      pBackglasslabelhide CharDead
      pBackglasslabelsetsizeimage CharDead2,13,33
      pBackglasslabelsetpos CharDead2,7,49
      pBackglasslabelhide CharDead2
      pBackglasslabelshow CharDead2
      P1= CharDead2
    elseif P2 = CharDead Then
      pBackglasslabelhide CharDead
      pBackglasslabelsetsizeimage CharDead2,13,33
      pBackglasslabelsetpos CharDead2,18.5,50.5
      pBackglasslabelhide CharDead2
      pBackglasslabelshow CharDead2
      P2= CharDead2
    elseif P3 = CharDead Then
      pBackglasslabelhide CharDead
      pBackglasslabelsetsizeimage CharDead2,13,33
      pBackglasslabelsetpos CharDead2,28.5,50
      pBackglasslabelhide CharDead2
      pBackglasslabelshow CharDead2
      P3= CharDead2
    elseif P4 = CharDead Then
      pBackglasslabelhide CharDead
      pBackglasslabelsetsizeimage CharDead2,13,33
      pBackglasslabelsetpos CharDead2,39.75,49.5
      pBackglasslabelhide CharDead2
      pBackglasslabelshow CharDead2
      P4= CharDead2
    End If

End Sub
'==================================================================
Sub KillPuPMonster(CharDead)
Dim r
MonPosition = ""
MonPosition = CharDead
r = MonPosition


    pBackglasslabelhide GIF_MA(r,0,0)
    pBackglasslabelsetsizeimage GIF_MA(r,1,0),13,33
    if r = 0 Then
      pBackglasslabelsetpos GIF_MA(0,1,0),59,46.5
      M1 = "MonsterDead1"
    elseif r = 1 Then
      pBackglasslabelsetpos GIF_MA(1,1,0),70,46
      M2 = "MonsterDead2"
    elseif r = 2 Then
      pBackglasslabelsetpos GIF_MA(2,1,0),82,47.25
      M3 = "MonsterDead3"
    elseif r = 3 Then
      pBackglasslabelsetpos GIF_MA(3,1,0),94,46.6
      M4 = "MonsterDead4"
    End If
    pBackglasslabelshow GIF_MA(r,1,0)


End Sub

'==========================================
Sub KillPuPMonster2(CharDead)
Dim CharDead2

    if M1 = CharDead Then
      CharDead2 = "MonsterDead1"
      pBackglasslabelhide CharDead
      if InEvent Then
        pBackglasslabelhide CharDead2
      Else
  '     Debug "PuP InActive"
        pBackglasslabelshow CharDead2
      End If
      M1= CharDead2
    elseif M2 = CharDead Then
      CharDead2 = "MonsterDead2"
      pBackglasslabelhide CharDead
      if InEvent Then
        pBackglasslabelhide CharDead2
      Else
        pBackglasslabelshow CharDead2
      End If
      M2= CharDead2
    elseif M3 = CharDead Then
      CharDead2 = "MonsterDead3"
      pBackglasslabelhide CharDead
      if InEvent Then
        pBackglasslabelhide CharDead2
      Else
        pBackglasslabelshow CharDead2
      End If
      M3= CharDead2
    elseif M4 = CharDead Then
      CharDead2 = "MonsterDead4"
      pBackglasslabelhide CharDead
      if InEvent Then
        pBackglasslabelhide CharDead2
      Else
        pBackglasslabelshow CharDead2
      End If
      M4= CharDead2
    End If

End Sub

'============================================
Sub PuPHideBattle(caller)
'Debug" ******** PUPHIDEBATTLE ************** " &caller

'Hide Character GIFs
  pBackglasslabelhide GIF_CA(0,0,0)
  pBackglasslabelhide GIF_CA(0,1,0)
  pBackglasslabelhide GIF_CA(1,0,0)
  pBackglasslabelhide GIF_CA(1,1,0)
  pBackglasslabelhide GIF_CA(2,0,0)
  pBackglasslabelhide GIF_CA(2,1,0)
  pBackglasslabelhide GIF_CA(3,0,0)
  pBackglasslabelhide GIF_CA(3,1,0)

' Hide Monster GIFs
  pBackglasslabelhide GIF_MA(0,0,0)
  pBackglasslabelhide GIF_MA(0,1,0)
  pBackglasslabelhide GIF_MA(1,0,0)
  pBackglasslabelhide GIF_MA(1,1,0)
  pBackglasslabelhide GIF_MA(2,0,0)
  pBackglasslabelhide GIF_MA(2,1,0)
  pBackglasslabelhide GIF_MA(3,0,0)
  pBackglasslabelhide GIF_MA(3,1,0)

' Hide Blood effect
  pBackglasslabelhide "blood10"
  pBackglasslabelhide "blood11"
  pBackglasslabelhide "blood12"
  pBackglasslabelhide "blood13"

End Sub

Sub DisplayBleed
Debug "Called DisplayBleed"
  BleedActive = 1
  BleedLighting

    if GIF_CA(0,0,1) = 1 then pBackglasslabelshow "Blood10"
    if GIF_CA(1,0,1) = 1 then pBackglasslabelshow "Blood11"
    if GIF_CA(2,0,1) = 1 then pBackglasslabelshow "Blood12"
    if GIF_CA(3,0,1) = 1 then pBackglasslabelshow "Blood13"



End Sub


Sub HideBleed
  BleedActive = 0
  DisableBleedLighting
Debug "Called HideBleed"
    pBackglasslabelhide "Blood10"
    pBackglasslabelhide "Blood11"
    pBackglasslabelhide "Blood12"
    pBackglasslabelhide "Blood13"

End Sub


Sub MoveBall
dim tmpBall

set tmpBall = activeball
  tmpBall.x = 782.1588
  tmpBall.y = 454.1512
End Sub



Sub RTP

' Section Added for testing - Allows player to skip to a specific dungeon and be given credit for previous DungeonsCleared
' Assembles the party and adds 2 items to table, in cove it provides 1 continue credit, weald provides 2 continue credits automatically for testing the continuation feature
' Uncomment the dungeon you want to Test, leave the others commented -- only test one starting dungeon at a time
' AFTER GAME STARTS -- PRESS "4" Key ONCE to call this routine

'TestRuins:triggerscript 2000, "StartRuins"
'---------------------------
' Useful methods for testing specific dungeons
'TestRuins
'TestCove
wizardmode

'AssemblePartyRuins
'AddPartyMember
'AddPartyMember
'AddPartyMember
'AddPartyMember
'Mode(currentPlayer,0) = 0


'Mode(currentplayer,2) = 2
'Mode(currentplayer,4) = 2
'Mode(currentplayer,6) = 2
'Mode(currentplayer,8) = 2


End Sub


Sub RTP0
'TestRuins
dump
End Sub

sub rtp5

end sub


Sub TestRuins
Mode(currentplayer,4) = 2
Mode(currentplayer,6) = 2
Mode(currentplayer,8) = 2

  AssemblePartyruins
  addpartymember
  addpartymember
  addpartymember
  'addpartymember
  AddItem


  'cheatWin 1
  'GoldSack(CurrentPlayer) = 1
  'vpmtimer.addtimer 500, "scoop2_hit '"
End Sub

Sub TestCove
  AssemblePartycove
  addpartymember
  addpartymember
  addpartymember
  addpartymember
  AddItem
  Additem
  'cheatWin 3
  GoldSack(CurrentPlayer) = 2
End Sub

Sub TestWeald
  AssemblePartyweald
  addpartymember
  addpartymember
  addpartymember
  addpartymember
  AddItem
  Additem
  'cheatWin 5
  GoldSack(CurrentPlayer) = 2
End Sub

Sub TestWarrens
  AssemblePartyWarrens
  addpartymember
  addpartymember
  addpartymember
  addpartymember
  AddItem
  Additem
  'cheatWin 7
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub cheatWin(cheat)
Dim rr
  for rr = 1 to cheat
    Debug "AutoBeat Mode: " & rr
    if rr mod 2 = 0 Then
      Mode(CurrentPlayer,rr) = 3
    Else
      Mode(CurrentPlayer,rr) = 2
    End If
' Turn on region lights
    if rr = 2 Then li045.state = 1
    if rr = 4 Then li030.state = 1
    if rr = 6 Then li031.state = 1
  Next

End Sub
'---------------------------------------------------------------------------------------------------------------------

Sub RTP2

'pupevent 300
pUpdateDev

End Sub

Sub RTP3

End Sub
'==========

Sub ShowOverlayIcons
  'pDMDlabelshow "BlacksmithOn"
  'pbackglasslabelshow "progresson"
  if bEOBSupress = False Then
    if Missions(currentplayer,1) = 9 Then pDMDlabelshow "BlacksmithOn"
    if Missions(currentplayer,2) = 2 Then pDMDlabelshow "GambleOn"
    if Missions(currentplayer,3) = 3 Then pDMDlabelshow "InTheDarkOn"
    if GoldSack(CurrentPlayer) > 0 Then pDMDlabelshow "GoldSackOn"
    DisplayMagnetIcon
    if DMDType = 0 Then
      if Missions(currentplayer,1) = 9 Then pBackglasslabelshow "BlacksmithOn"
      if Missions(currentplayer,2) = 2 Then pBackglasslabelshow "GambleOn"
      if Missions(currentplayer,3) = 3 Then pBackglasslabelshow "InTheDarkOn"
      if GoldSack(CurrentPlayer) > 0 Then pBackglasslabelshow "GoldSackOn"
    End If
  Else
    BallHandlingQueue.Add "ShowOverlayIcons","ShowOverlayIcons",20,1000,0,0,0,False
  End If
End Sub

Sub HideOverlayIcons
'do not need to add BG versions only called in hideDMD
  pDMDlabelhide "BlacksmithOn"
  pDMDlabelhide "GambleOn"
  pDMDlabelhide "InTheDarkOn"
  pDMDlabelhide "GoldSackOn"
  HideMagnetMessages

End Sub

Sub HideBGOverlayIcons
  pBackglasslabelhide "BlacksmithOn"
  pBackglasslabelhide "GambleOn"
  pBackglasslabelhide "InTheDarkOn"
  pBackglasslabelhide "GoldSackOn"
End Sub

Sub HideBGOverlayCounts
  PuPlayer.LabelSet pBackglass,"rampcounts","",0,""
  PuPlayer.LabelSet pBackglass,"spinnercounts","",0,""
  PuPlayer.LabelSet pBackglass,"torchcounts","",0,""
  PuPlayer.LabelSet pBackglass,"GoldSackCount","",0,""
End Sub

Sub HideOverlayCounts
'do not need to add BG versions only called in hideDMD
  HideRampCounts
  HideSpinCount
  HideTorchCount
  HideGoldSackCount
End Sub

Sub InnHelper
  CheckItems
  if ItemCount < 5 Then
    AddItem
    BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
  Elseif BallsInLock(CurrentPlayer) < 3 Then
    BallsInLock(CurrentPlayer) = BallsInLock(CurrentPlayer) + 1
    if BallsInLock(CurrentPlayer) > 2 Then
      li039.state = 0
      DisableBallLock ' includes li046.state = 0
      CheckDungeonMB
      Debug "All Balls Locked: " &BallsInLock(CurrentPlayer)
    Else
      CheckDungeonMB
      Debug "Balls Locked < 2: " &BallsInLock(CurrentPlayer)
    End If
    BallHandlingQueue.Add "KickOut","KickBallOut",70,5400,0,0,0,True
  Else ' make sure lights are off and lock disabled
    Addscore 2000
    li039.state = 0
    DisableBallLock ' includes li046.state = 0
    BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
  End If

End Sub

Sub PlayVillageMusic (ms)
  AudioQueue.Add "Pup445","PuPEvent 445",20,ms,0,0,0,False
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub scoop1_Hit 'INN scoop
'scoop1.Destroyball
'BallsinHole = BallsInHole + 1
'BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
'Exit Sub

  ClearPupMessages
  GetAM
  Debug "INN Scoop Hit: "&AMCombo
    DOF 116, DOFPulse
    PlaySoundAt "VUKEnter", scoop1
    scoop1.Destroyball
    BallsinHole = BallsInHole + 1

    If Tilted Then BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True:Exit Sub
  FlashEffect 7
    If bSkillShotReady Then ResetSkillShotTimer_Timer

  Debug "Scoop1 kickout"

  if GMode = 1 Or TMode = 1 Then BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True:Exit Sub

  if Missions(CurrentPlayer,1) = 6 And BSMode = 1 Then ' In Blacksmith mode
    'Playsound "hammer"
    PuPEvent 292
    Missions(CurrentPlayer,1) = 7
    CountDownMessage1 = "1 Shot Remains"
    li039.state = 1 ' Inn Arrow
    li038.state=2 ' Quest
    Addscore2 Score_BlacksmithLevel
    ResetBSMode
    BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
    Exit Sub  ' do nto let sub continue
  End If

  if BSMode = 1 Then BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True:Exit Sub

  if BSMode <> 1 And GMode <> 1 And TMode <> 1 Then  ' Make sure Side missions are not active

    'Debug "Should not be in Blacksmith Mode"
    Debug "Entered Inn AMCombo : " &AMCombo
      Select Case ActiveMode
        Case 0:
          if lastmode > 9 And li038.state = 2 Then li047.state = 0:BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True:Exit Sub
          DisableBallLock
          Debug "Cleared Inn, Reset Lights"
          InnCleared = 1
          MonstersCleared = 0 ' Reset Dungeon Cleared Flag
          if PartySize(CurrentPlayer) < 4 Then
            Debug "Displaying Assemble Party Guide"
            BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
            BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
            BallHandlingQueue.Add "bHoldBallDelay-F","bHoldBallDelay = False",55,1500,0,0,0,True
            BallHandlingQueue.Add "DisplayHelper2","DisplayHelper2",55,5500,0,0,0,True
            GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
            if DMDType = 0 Then HideBG2 6200
            GeneralPuPQueue.Add "Pup819","PuPEvent 819",25,100,0,0,0,True
          Else ' party is full
            BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
            li038.state = 0
            li047.state = 0
            'BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
            'BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
            'PickDungeon
            StartNextMode
            Exit Sub
          End If
          StartNextMode
          'triggerscript 500, "KickBallOut "
        Case 1,3,5,7,9:
          if AMState = 0 Then  ' Not Started
            'Do nothing
            BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
          End If
          if AMState = 1 Then ' In Progress
            'Add Items until all filled then start to LOCK Balls
            InnHelper
          End If
          if AMState = 2 Then  ' Completed
            Debug "Mode 1,3,5,7 -- AMState 2"
            'Add Items until all filled then start to LOCK Balls
            if Activemode = 9 Then
              BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
            Else
              InnHelper
            End If
          End If
          'BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
        Case 2,4,6,8:
          if Mode(CurrentPlayer,ActiveMode) = 1 Then ' In Progress
            CheckDungeonMB   ' Check to start multiball
              CheckTotalItems
              If TotalItemCount > 0 Then
                randomchest
              Else
                Debug "No Items Left"
                HeroCountDown = HeroCountDown + 2
                AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
                BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
              End If
          Else
            BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
          End If
          if AMState = 2 Then ' Completed
            'Do nothing
          End If
          if AMState = 3 Then ' Monsters Cleared
            'Do nothing
          End If
        Case 10,11,12,13:
          if AMState = 1 Then
            CheckDungeonMB   ' Check to start multiball
              CheckTotalItems
              If TotalItemCount > 0 Then
                randomchest
              Else
                Debug "No Items Left"
                HeroCountDown = HeroCountDown + 2
                AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
                BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
              End If
          Else
            BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
          End If
        Case 14:
          if AMState = 1 Then
            BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
          End If
        Case Else:
          'Do Nothing
          BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
      End Select
  Else ' in one of the side missions kick ball out
    BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True
  End If

End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ResetBlinkIntervals
' Regions
  li045.BlinkInterval = 160 'Ruins
  li030.BlinkInterval = 160 'Cove
  li031.BlinkInterval = 160 'Weald
  li026.BlinkInterval = 160 'Warrens

'PF
  li038.BlinkInterval = 160 ' Quest
  li046.BlinkInterval = 160 ' Lock
  li047.BlinkInterval = 160 ' Inn

'Lanes
  li060.BlinkInterval = 160 ' Left Orbit
  li037.BlinkInterval = 160 ' Inside Orbit
  li051.BlinkInterval = 160 ' Right Orbit
  li036.BlinkInterval = 160 ' Left Ramp
  li040.BlinkInterval = 160 ' Right Ramp

End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ResetNewBallLights
Debug "In Reset Ball Lights"
' Bonus Lights
  ResetCampLights

  'Mode(CurrentPlayer,0) = 0 ' Reset to Base Mode
'Lanes

  li036.state = 0 ' Left Ramp
  li040.State = 0 ' Right Ramp
  li051.State = 0 ' Right Orbit
  li060.State = 0 ' Left Orbit
  li039.state = 0 ' inn arrow
  li037.state = 0 ' inside orbit

'PF
  li046.State = 0 ' Lock
  li047.State = 0 ' Inn
  li038.State = 0 ' Quest


'Party
  if Party(CurrentPlayer,0) = 1 Then li014.state=1 'Grave
  if Party(CurrentPlayer,1) = 1 Then li010.state=1 'Hwyman
  if Party(CurrentPlayer,2) = 1 Then li011.state=1 'Jester
  if Party(CurrentPlayer,3) = 1 Then li012.state=1 'Healaer
  if Party(CurrentPlayer,4) = 1 Then li007.state=1 'Plague DR
  if Party(CurrentPlayer,5) = 1 Then li009.state=1 'Occultist
  if Party(CurrentPlayer,6) = 1 Then li013.state=1 'Knight
  if Party(CurrentPlayer,7) = 1 Then li023.state=1 'Hound


End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub SetPartyLights
  Debug "In Set Party Lights"
  li047.state = 0 ' turn off Inn light
  li037.state = 2 ' inside orbit
  li036.state = 2 ' Left Ramp
  li040.State = 2 ' Right Ramp
  li051.State = 2 ' Right Orbit
  li060.State = 2 ' Left Orbit


  li039.state = 2 ' ball lock arrow
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub StopPartyLights
  Debug "In Stop Party Lights"
  li047.state = 0 ' turn off Inn light
  li037.state = 0 ' inside orbit
  li038.state = 2 ' turn on Quest light
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub ResetLaneLights
  li037.State = 0 ' Inside Orbit
  li040.State = 0 ' Right Ramp
  li036.state = 0 ' Left Ramp
  li051.State = 0 ' Right Orbit
  li060.State = 0 ' Left Orbit
  li039.state = 0 ' Inn Arrow - used for locking ball indicator
End Sub
'---------------------------------------------------------------------------------------------------------------------
Sub KickBallOut 'from all the holes
    If BallsinHole > 0 Then
        BallsinHole = BallsInHole - 1
        PlaySoundAt SoundFXDOF("VUKOut", 111, DOFPulse, DOFcontactors), scoopexit
        DOF 130, DOFPulse
        DOF 114, DOFPulse
        scoopexit.CreateSizedBallWithMass BallSize / 2, BallMass
        scoopexit.kick 196, 28
    bSupressRightOrbit = True ' Prevent Freebie orbit hits
    BallHandlingQueue.Add "SupressRightOrbitFlag","bSupressRightOrbit = False",70,2000,0,0,0,True
        HelmetF
        LightEffect 5
        BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True 'kick out the rest of the balls, if any
    End If
End Sub


Sub InnKickBallOut 'from all the holes
    If BallsinHole > 0 Then
        BallsinHole = BallsInHole - 1
        PlaySoundAt SoundFXDOF("VUKOut", 111, DOFPulse, DOFcontactors), InnExit
        DOF 130, DOFPulse
        DOF 114, DOFPulse
        InnExit.CreateSizedBallWithMass BallSize / 2, BallMass
        InnExit.kick 196, 28
        HelmetF
        LightEffect 5
    BallHandlingQueue.Add "InnKickOut","InnKickBallOut",70,KickOutDelay,0,0,0,True 'kick out the rest of the balls, if any
    End If
End Sub

Sub ChestKickBallOut
if TrapDoorK.Enabled = 1 Then
  KickBallOut
Else
    If BallsinHole > 0 Then
        BallsinHole = BallsInHole - 1

    BallHandlingQueue.Add "TrapdoorUp","TrapdoorUp",70,0,0,0,0,True
        PlaySoundAt SoundFXDOF("VUKOut", 111, DOFPulse, DOFcontactors), ChestExit
        DOF 130, DOFPulse
        DOF 114, DOFPulse
        ChestExit.CreateSizedBallWithMass BallSize / 2, BallMass
    'BallHandlingQueue.Add "ChestExit","ChestExit.kick 196, 28",70,150,0,0,0,True
    BallHandlingQueue.Add "ChestExit","ChestExit.kick 158, 26",70,150,0,0,0,True
        HelmetF
        LightEffect 5
    BallHandlingQueue.Add "TrapdoorDown","TrapdoorDown",98,300,0,0,0,True 'kick out the rest of the balls, if any
    BallHandlingQueue.Add "ChestKickOut","ChestKickBallOut",70,KickOutDelay,0,0,0,True 'kick out the rest of the balls, if any

    End If
End If
End Sub
' hole2 - Start Battle


'***********
' Trapdoor
'***********
'hole3 - HadesTrapdoor

Sub TrapDoorK_Hit 'Multiball Trapdoor for locking balls

  GetAM
  Select Case ActiveMode
    Case 0,1,3,5,7:
            DOF 116, DOFPulse
      BallsInLock(CurrentPlayer) = BallsInLock(CurrentPlayer) + 1
      if BallsInLock(CurrentPlayer) > 2 Then
        CheckDungeonMB
        Debug "Balls Locked: " &BallsInLock(CurrentPlayer)
      Else
        'BallsInLock(CurrentPlayer) = BallsInLock(CurrentPlayer) + 1
        CheckDungeonMB
        Debug "Balls Locked < 2: " &BallsInLock(CurrentPlayer)
        Triggerscript 2300, "PlaySound""vo_trapdoor"":TrapdoorUp "
      End If
    Case 9:
      BallsInLock(CurrentPlayer) = BallsInLock(CurrentPlayer) + 1
      if BallsInLock(CurrentPlayer) > 2 Then
        CheckDungeonMB
        Debug "Balls Locked: " &BallsInLock(CurrentPlayer)
        'Mode(CurrentPlayer,9) = 2   -- do not set this, this allows players to return to this mode if they fail the shambler mission
        triggerscript 5000, "LoadShambler"
      Else
        'BallsInLock(CurrentPlayer) = BallsInLock(CurrentPlayer) + 1
        CheckDungeonMB
        Debug "Balls Locked < 2: " &BallsInLock(CurrentPlayer)
        Triggerscript 2300, "PLaySound""vo_trapdoor"":TrapdoorUp "
      End If
    Case Else:
        ' Do nothing
  End Select


  Debug "Trap Doot Hit"
    PlaySoundAt "VUKEnter", TrapDoorK
    DOF 116, DOFPulse
    TrapDoorK.Destroyball
    BallsinHole = BallsInHole + 1
    If Tilted Then BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True:Exit Sub
    ' Modes


    'score a Jackpot
    AwardJackpot
     ' and close the trap door
  BallHandlingQueue.Add "KickOut","TrapdoorDown",60,1000,0,0,0,False
    BallHandlingQueue.Add "KickOut","KickBallOut",70,2000,0,0,0,True
End Sub

Sub TrapdoorUp
    PlaySoundAt SoundFXDOF("fx_SolenoidOn", 117, DOFPulse, DOFContactors), TrapDoorK
    DOF 117, DOFPulse
    TrapdoorA.IsDropped = 1
    TrapdoorB.IsDropped = 0
    TrapdoorC.IsDropped = 0
    TrapdoorD.Collidable = 0
    TrapDoorK.Enabled = 1
    Light012.State = 2
End Sub

Sub TrapdoorDown
    PlaySoundAt SoundFXDOF("fx_SolenoidOff", 117, DOFPulse, DOFContactors), TrapDoorK
    DOF 117, DOFPulse
    TrapdoorA.IsDropped = 0
    TrapdoorB.IsDropped = 1
    TrapdoorC.IsDropped = 1
    TrapdoorD.Collidable = 1
    TrapDoorK.Enabled = 0
    Light012.State = 0
End Sub



'******************************
' Pandora's Box - Extra awards
'******************************
'hole4 - Pandora's box

Sub pandorak_Hit
ClearPupMessages
    PlaySoundAt "VUKEnter", pandorak
    pandorak.Destroyball
    BallsinHole = BallsInHole + 1
    If Tilted Then BallHandlingQueue.Add "ChestKickBallOut","ChestKickBallOut",70,KickOutDelay,0,0,0,True:Exit Sub
    RMF:RBF

  GetAM
  Select Case ActiveMode
    Case 0:
      BallHandlingQueue.Add "ChestKickBallOut","ChestKickBallOut",70,KickOutDelay,0,0,0,True
    Case 1,3,5,7:
      if AMState <> 0 Then
        AddItem
      End If
      Debug "Pandorak Case 1,3,5,7"
      BallHandlingQueue.Add "ChestKickBallOut","ChestKickBallOut",70,KickOutDelay,0,0,0,True
    Case 2,4,6,8,10,11,12,13:
      if AMState = 1 Then
        CheckTotalItems
        If TotalItemCount > 0 Then
          Debug "Calling Random Chest Item"
          randomchest
        Else
          Debug "No Items Left"
          HeroCountDown = HeroCountDown + 2
          AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
          BallHandlingQueue.Add "ChestKickBallOut","ChestKickBallOut",70,KickOutDelay,0,0,0,True
        End If
      Else
        Debug "PANDORA: in Dungeon but not state 1: " & AMState
        BallHandlingQueue.Add "ChestKickBallOut","ChestKickBallOut",70,KickOutDelay,0,0,0,True
      End If
    Case 9:
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
    Case Else: ' If not in a battle just kick ball out
      Debug "Else pandorak kick"
      BallHandlingQueue.Add "ChestKickBallOut","ChestKickBallOut",70,KickOutDelay,0,0,0,True
  End Select
    DOF 116, DOFPulse
End Sub


Sub ReturnOverlay (caller)
'Exit Sub   '128.3
  Debug " *#*#*#*#*#*#**  In Return Overlay: " & caller
  GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
End Sub

Sub randomchest
'GetAM
    'do some animationDebug "In Random Chest"
'CheckTotalItems
' Debug "Total Items: "& TotalItemCount
' Debug "Mode: " & AMCombo
If TotalItemCount > 0 And AMState = 1 Then

    Dim tmp,tmp2

  'tmp2= INT(RND(1) * 8)+1
  tmp2 = rndArrayCol(ItemsRTP,CurrentPlayer)
  Debug "Chest Item: " & tmp2
    Select case tmp2
    Case -1:
        MsgBox "Randomchest Error: -1"
        Case 0 'GOOD light extraball
            If Li027.State = 1 Then ' Medicine
      Debug "Medicine USED"
 '               DMD CL("MYSTERY "), CL("EXTRA BALL IS LIT"), "_", eNone, eBlink, eNone, 2500, True, "vo_extraballislit"
        if NOT bExtraBallWonThisBall Then
          GeneralPuPQueue.Add "Pup910","PuPEvent 910",32,0,0,0,ShortPuPExpiry,True
          AudioQueue.Add "Pup245","PuPEvent 245",32,3000,0,0,AudioExpiry,False ' medicine callout
          AudioQueue.Add "Pup266","PuPEvent 266",32,6000,0,0,7000,False ' extraball lit audio
          light009.State = 2
          BallHandlingQueue.Add "Light009-0","Light009.State = 0",70,30000,0,0,0,True
          Addscore2 25000
          li027.state=0
          HideItems 0
          ItemsRTP(CurrentPlayer,0) = 0
          HeroTimerReset ' Reset the Hero timer if there is an item in the chest
          BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
        Else
          if TotalItemCount > 1 Then
            randomchest
          Else
            Li027.State = 0
            ItemsRTP(CurrentPlayer,0) = 0
            BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,800,0,0,0,True
            BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
          End If
        End If
      Else
        randomchest
            End If
        Case 1 'GOOD increment bonus multiplier
      if li028.state = 1 or ItemsRTP(CurrentPlayer,1) = 1 then ' Bandages
      Debug "Bandages USED"
        GeneralPuPQueue.Add "Pup911","PuPEvent 911",32,0,0,0,ShortPuPExpiry,True
        AudioQueue.Add "Pup246","PuPEvent 246",32,3000,0,0,AudioExpiry,False ' bandage used callout
        AddBonusMultiplier 1
'       DMD CL("MYSTERY "), CL("BONUS X " & BonusMultiplier(CurrentPlayer)), "_", eNone, eBlinkFast, eNone, 2000, True, ""
'       DMD CL("MYSTERY "), CL(FormatScore(250000)), "_", eNone, eBlink, eNone, 2000, True, ""
        Addscore2 25000
        li028.state=0
        HideItems 1
        ItemsRTP(CurrentPlayer,1) = 0
        if ItemsRTP(CurrentPlayer,7) = 0 And Mode(CurrentPlayer,12) <> 1 Then ' if bleed has been incurred
          HideBleed
          BallHandlingQueue.Add "HideBleed","HideBleed",75,4000,0,0,0,True
          HeroCountDownMax = OriginalHeroCountDown
          HeroCountDownReset
          BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,0,0,0,0,True
        End If
        BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
      Else
        randomchest
      End If
        Case 2 ' GOOD award from 5k to 100k
      if li029.state=1 or ItemsRTP(CurrentPlayer,2) = 1 then ' Key
      Debug "Key USED"
        GeneralPuPQueue.Add "Pup912","PuPEvent 912",32,0,0,0,ShortPuPExpiry,True
        AudioQueue.Add "Pup247","PuPEvent 247",32,3000,0,0,AudioExpiry,False ' key callout
'       DMD CL("MYSTERY "), CL(FormatScore(tmp)), "_", eNone, eBlink, eNone, 2000, True, ""
        Addscore2 tmp
        triggerscript 5000, "DisplayKeyAward"
        li029.state=0
        HideItems 2
        ItemsRTP(CurrentPlayer,2) = 0
        BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,0,0,0,0,True
        BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
      Else
        randomchest
      end if
        Case 3 'GOOD add a ball
      If li033.state=1 or ItemsRTP(CurrentPlayer,3) = 1 then ' Shovel
      Debug "Shovel USED"
        GeneralPuPQueue.Add "Pup913","PuPEvent 913",32,0,0,0,ShortPuPExpiry,True
        AudioQueue.Add "Pup248","PuPEvent 248",32,3000,0,0,AudioExpiry,False ' shovel used callout
'       DMD CL("MYSTERY "), CL("add a ball"), "_", eNone, eBlinkFast, eNone, 1000, True, "vo_multiball"
'       DMD "_", CL("PLAYFIELD X 2"), "_", eNone, eBlinkFast, eNone, 2000, True, ""
        if bBallInPlungerLane = True Then Fireball
        AddPlayfieldMultiplier 1
        AddMultiball 1
        bAutoPlunger = True
        triggerscript 5000, "DisplayMBVideo"
        Addscore2 25000
        li033.state = 0
        HideItems 3
        ItemsRTP(CurrentPlayer,3) = 0
        BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,0,0,0,0,True
        BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
      Else
        randomchest
      end if
        Case 4 'GOOD bring back hero
      if ItemsRTP(CurrentPlayer,4) = 1 And PartySize(CurrentPlayer) < 4 then ' potion
      Debug "Vial USED"
        GeneralPuPQueue.Add "Pup914","PuPEvent 914",32,0,0,0,ShortPuPExpiry,True
        AudioQueue.Add "Pup249", "PuPEvent 249",32,3000,0,0,AudioExpiry,False ' vial used callout
        HideDeadChar
        AddPartyMember
'       DMD CL("MYSTERY "), CL("HERO REVIVED"), "_", eNone, eNone, eNone, 1000, True, ""
'       DMD CL("MYSTERY "), CL(FormatScore(250000)), "_", eNone, eBlink, eNone, 2000, True, ""
        Addscore2 25000
        li034.state=0
        HideItems 4
        ItemsRTP(CurrentPlayer,4) = 0
        GeneralPupQueue.Add "DDB","DisplayDungeonBG",56,4100,0,0,0,True
        GeneralPupQueue.Add "PDB","PuPDisplayBattle ""case 5 additem""",55,4150,0,0,0,True
        'triggerscript 4100, "PuPDisplayBattle ""case 5 additem"" "' Reload pup since another member was added
        BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,0,0,0,0,True
        CreatePartyString  ' SEnd party string to debug logs
        BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
      Else
        if TotalItemCount > 1 Then
          randomchest
        Else
          BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,800,0,0,0,True
          BallHandlingQueue.Add "KickOut","KickBallOut",70,800,0,0,0,True
        End If
      End if
        Case 5 'BAD heart attack
      if ItemsRTP(CurrentPlayer,5) = 1 Then
        Debug " HEART ATTACK "& HeroCountDown
        AudioQueue.Add "Pup251", "PuPEvent 251",32,3000,0,0,AudioExpiry,False ' vial used callout
        ItemsRTP(CurrentPlayer,5) = 0 ' Remove Heart Attack
        GeneralPuPQueue.Add "Pup915","PuPEvent 915",32,0,0,0,ShortPuPExpiry,True
        BallHandlingQueue.Add "RemovePartyMember","RemovePartyMember",75,5000,0,0,0,True
  '     DMD CL("MYSTERY "), CL("1"), "_", eNone, eBlink, eNone, 2500, True, "vo_specialislit"
        BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,0,0,0,0,True
        BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
      Else
        RandomChest ' Call something else
      End If
        Case 6 'BAD Madness
      if ItemsRTP(CurrentPlayer,6) = 1 Then
        Debug "Madness"
'       pNote "Crazy", "Flippers"
        GeneralPuPQueue.Add "Pup916","PuPEvent 916",32,0,0,0,ShortPuPExpiry,True
        if Party(CurrentPlayer,4) <> 1 Then
          AudioQueue.Add "Pup248", "PuPEvent 248",32,3000,0,0,AudioExpiry,False ' madness callout
          'CrazyFlippers  ' Create a routine that uses a 5 second timer to cause random flipper inputs until timer expires
          BallHandlingQueue.Add "MadnessTimer-1","MadnessTimer.Enabled = 1",75,6000,0,0,0,True
          BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,0,0,0,0,True
          BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
        Else
          AudioQueue.Add "Pup254", "PuPEvent 254",32,3000,0,0,AudioExpiry,False ' madness prevention callout
          BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
          if DMDType = 2 Then
            HideDMD 4000, True
          Else
            pup2helper 4000
          End If
          GeneralPuPQueue.Add "Pup873","PuPEvent 873",38,0,0,0,GenPuPExpiry,False
        End If
        ItemsRTP(CurrentPlayer,6) = 0 ' Remove Madness
      Else
        randomchest
      end if
        Case 7 'BAD Bleed
      if ItemsRTP(CurrentPlayer,7) = 1 And Mode(CurrentPlayer,12) <> 1 Then
          Debug "Bleed"
          GeneralPuPQueue.Add "Pup918","PuPEvent 918",32,0,0,0,ShortPuPExpiry,True
          AudioQueue.Add "Pup252", "PuPEvent 252",32,3000,0,0,AudioExpiry,False ' bleed callout
          ItemsRTP(CurrentPlayer,7) = 0 ' Remove Bleed
          triggerscript 5000, "DisplayBleed "
          HeroCountDownMax = OriginalHeroCountDown - 10
          HeroCountDownReset
          BallHandlingQueue.Add "HeroTimerReset","HeroTimerReset",75,0,0,0,0,True
          BallHandlingQueue.Add "KickOut","KickBallOut",70,4600,0,0,0,True
      Else
        randomchest
      End if
        Case Else  'hahaha just from 1000 to 25000 points --- SHOULD NEVER GET HIT
      Debug "Hit ELSE of RANDOM CHEST, FIX THIS as it should not have happened"
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True  ' kick ball out in cae it gets here
    End Select
    If TotalItemCount < 1 Then li040.state = 0 ' turn off scoop1 light since no items left

  End If  ' End of if itemcount > 0
End Sub

Sub LoadChest
  ItemsRTP(CurrentPlayer,5) = 1 ' Heart Attack
  ItemsRTP(CurrentPlayer,6) = 1 ' Madness
  ItemsRTP(CurrentPlayer,7) = 1 ' Something
End Sub

Sub DisplayKeyAward
Dim tmp,r
  r = RndNbr(20)
  tmp = 5000 * r
  PuPlayer.LabelSet pBackglass,"KeyAward","Key Award - " &FormatNumber(tmp,0),1,""
  GeneralPupQueue.Add "HideKeyAward","HideKeyAward",20,3000,0,0,0,False

  Select Case r
    Case 0,1,2,3,4,5,6,7:
      AudioQueue.Add "Pup235", "PuPEvent 235",32,0,0,0,AudioExpiry,False
    Case 8,9,10,11,12,13,14:
      AudioQueue.Add "Pup236", "PuPEvent 236",32,0,0,0,AudioExpiry,False
    Case 15,16,17,18,19,20:
      AudioQueue.Add "Pup237", "PuPEvent 237",32,0,0,0,AudioExpiry,False
  End Select
  'triggerscript 3200, "HideKeyAward " ' backup to make sure it clears
End Sub


Sub CrazyFlippers
' CFCount = CFCount + 1
  if CFCount > 32 Then  '  each count is 250ms
    MadnessTimer.Enabled = 0
    CFCount = 0 ' Reset for next Dungeon
  End If
End Sub

sub MadnessTimer_timer
' Debug "MadnessCount: "&CFCount
CFCount = CFCount + 1

  Select Case RndNbr(4)
    Case 1:
      Table1_KeyDown(leftflipperkey)
      triggerscript 100, "Table1_KeyUp(leftflipperkey) "
      Table1_KeyDown(30)
      triggerscript 100, "Table1_KeyUp(30) "
    Case 2:
      Table1_KeyDown(rightflipperkey)
      triggerscript 100, "Table1_KeyUp(rightflipperkey) "
      Table1_KeyDown(40)
      triggerscript 100, "Table1_KeyUp(40) "
    Case 3:
      Table1_KeyDown(leftflipperkey)
      triggerscript 100, "Table1_KeyUp(leftflipperkey) "
      Table1_KeyDown(rightflipperkey)
      triggerscript 100, "Table1_KeyUp(rightflipperkey) "
      Table1_KeyDown(30)
      triggerscript 100, "Table1_KeyUp(30) "
      Table1_KeyDown(40)
      triggerscript 100, "Table1_KeyUp(40) "
    Case Else:
      'Do Nothing
  End Select
CrazyFlippers
End Sub



Sub TurnOffArrows 'at the end of the ball or timed mode
    li060.State = 0
    li036.State = 0
    li038.State = 0
    li037.State = 0
  '  li044.State = 0
    li040.State = 0
 '   li043.State = 0
 '   li042.State = 0
    li039.State = 0

End Sub

'*************
' Magnet
'*************
Sub ReleaseMagnetBalls 'mMagnet off and release the ball if any
  DisableMagnet
    Dim ball
    DOF 132, DOFOff
    For Each ball In mMagnet.Balls
        With ball
            .VelX = 1
            .VelY = 1
    if AF = 1 Then
'     .x = 782.1588
'     .y = 454.1512
'     .x = 782.15 ' pretty good
'     .y = 453.75' pretty good
      '.x = 782.15
      '.y = 456
      AutoMagnetFlipper
    End If
        End With
    Next

End Sub

Sub EnableMagnet
  mMagnet.MagnetOn = True
  DOF 132, DOFOn
  MagnetCheckTimer.Enabled = 1
  MagnetMessage
  li0130.state = 2
End Sub

Sub DisableMagnet
  mMagnet.MagnetOn = False
  MagnetCheckTimer.Enabled = 0
  DOF 132, DOFOff
  HideMagnetMessages
  li0130.state = 0
End Sub

Sub AutoMagnetFlipper
  Table1_KeyDown(rightflipperkey)
  triggerscript 100, "Table1_KeyUp(rightflipperkey) "
  Table1_KeyDown(40)
  triggerscript 100, "Table1_KeyUp(40) "
End Sub

Sub TurnOffMagnet
  mMagnet.MagnetOn = False
  li0130.state = 0
End Sub

'**************
'   COMBOS
'**************

Sub AwardCombo
    ComboCount = ComboCount + 1
    DOF 130, DOFPulse
    DOF 207, DOFPulse
    Select Case ComboCount
        Case 0, 1:Exit Sub 'this should never happen though
        Case 2
      Debug "ComboCount: "&ComboCount
 '           DMD CL("COMBO"), CL(FormatScore(ComboValue(CurrentPlayer))), "", eNone, eNone, eNone, 1500, True, "vo_combo"
            ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case 3
      Debug "ComboCount: "&ComboCount
 '           DMD CL("2X COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * ComboCount)), "", eNone, eNone, eNone, 1500, True, "vo_combo"
            ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case 4
      Debug "ComboCount: "&ComboCount
 '           DMD CL("3X COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * ComboCount)), "", eNone, eNone, eNone, 1500, True, "vo_combo"
            ComboValue(CurrentPlayer) = ComboValue(CurrentPlayer) + 100000:ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case 5
      Debug "ComboCount: "&ComboCount
 '           DMD CL("4X HURRICANE"), CL(FormatScore(ComboValue(CurrentPlayer) * ComboCount)), "", eNone, eNone, eNone, 1500, True, "vo_hurricane"
            ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
            If Light009.State = 0 Then
 '               DMD "_", CL("EXTRA BALL IS LIT"), "_", eNone, eBlink, eNone, 2500, True, "vo_extraballislit"
        if NOT bExtraBallWonThisBall Then
          light009.State = 2
          triggerscript 30000, "Light009.State = 0 "
        End If
'       PuPlayer.LabelSet pBackglass,"ExtraBallStatus","EXTRABALL",1,""
'       pBackglassLabelFlash "ExtraBallStatus", 30000, 121212  ' Flash Active in green for 10 seconds
            End If
        Case 6
      Debug "ComboCount: "&ComboCount
 '           DMD CL("5X COMBO KING"), CL(FormatScore(ComboValue(CurrentPlayer) * ComboCount)), "", eNone, eNone, eNone, 1500, True, "vo_combo_king"
            ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
            li046.State = 1
            If Light010.State = 0 Then
 '               DMD CL("_"), CL("SPECIAL IS LIT"), "_", eNone, eBlink, eNone, 2000, True, "vo_specialislit"
                'Light010.State = 2
            End If
        Case 7
      Debug "ComboCount: "&ComboCount
 '           DMD CL("6X WIND RIDER"), CL(FormatScore(ComboValue(CurrentPlayer) * ComboCount)), "", eNone, eNone, eNone, 1500, True, "vo_wind_rider"
            ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
        Case Else
      Debug "ComboCount: "&ComboCount
 '           DMD CL("SUPERDUPER COMBO"), CL(FormatScore(ComboValue(CurrentPlayer) * ComboCount)), "", eNone, eNone, eNone, 1500, True, "vo_combo"
            ComboHits(CurrentPlayer) = ComboHits(CurrentPlayer) + 1
    End Select
    AddScore2 ComboValue(CurrentPlayer) * ComboCount
    ComboValue(CurrentPlayer) = ComboValue(CurrentPlayer) + 100000
End Sub

Sub aComboTargets_Hit(idx) 'reset the combo count if the ball hits another target/trigger
    ComboCount = 0
End Sub



'****************************************************
'Dungeon Multiball  - holes & lock system at the Ares hole
'****************************************************
' lock 3 balls, and MB starts
' holes score Jackpots
' value doubles each time all three holes has been Hit
' each hole gives just 1 jackpot until all three has been hit again.






'*******************
' BONUS MULTIPLIER
'*******************
' fire shots

Sub CheckBonusX
    If li030.State + li031.State + li032.State + li033.State + li034.State = 5 Then 'all the fire lights are on
        AddBonusMultiplier 1
        FlashEffect 5
        LightEffect 5
        li030.State = 0
        li031.State = 0
        li032.State = 0
        li033.State = 0
        li034.State = 0
        'blink the X lights fast but only the ones that were off
        If li024.State = 0 Then li024.State = 2
        If li025.State = 0 Then li025.State = 2
        If li026.State = 0 Then li026.State = 2
        If li027.State = 0 Then li027.State = 2
        If li028.State = 0 Then li028.State = 2
    End If
End Sub

'************
' The Fates
'************



'*****************
' BONUS HIT SUBS
'*****************

Sub aBonusTargets_Hit(idx):BonusTargets(CurrentPlayer) = BonusTargets(CurrentPlayer) + 1: DOF 210, DOFPulse End Sub
Sub aBonusRamps_Hit(idx):BonusRamps(CurrentPlayer) = BonusRamps(CurrentPlayer) + 1: DOF 211, DOFPulse End Sub
Sub aBonusOrbits_Hit(idx):BonusOrbits(CurrentPlayer) = BonusOrbits(CurrentPlayer) + 1: DOF 212, DOFPulse End Sub

' DMD CL(""), CL(""), "", eNone, eNone, eNone, 3000, True, ""

'*********************
'  Random sound banks
'*********************

Sub RandomSoundFail
  PlaySound ("vo_fail" & Int(Rnd*11)+1)
End Sub

Sub RandomSoundwin
  'PlaySound ("vo_win_" & Int(Rnd*4)+1)
  AudioQueue.Add "Pup346","PuPEvent 346",45,0,0,0,0,False
End Sub

Sub RandomSoundHit
  PlaySound ("attack_" & Int(Rnd*5)+1)
End Sub

Sub RandomSoundPop
  PlaySound ("vo_win_ " & Int(Rnd*3)+1)
End Sub

Sub RandomSoundNarrHit
  PlaySound ("hit_" & Int(Rnd*12)+1)
End Sub



'*********************
'  Random item Select
'*********************


'Create an array of lights
Dim LightArray1
  LightArray1 = Array(Li029,Li027,Li028,Li034,Li033)

'General sub for turning on only random light in an array of lights
Sub TurnOnRandomLight
    Dim L, Cnt, x
    'Check how many lights lit
    Cnt = 0
    For each L in LightArray1
        If L.state > 0 Then Cnt = Cnt + 1
    Next
    'If possible, pick a random unlit light, then set it to ON state
    If Cnt < UBound(LightArray1)+1 Then
        x = RndInt(1,UBound(LightArray1)+1-Cnt)
        Cnt = 0
        For each L in LightArray1
            If L.state = 0 Then
                Cnt = Cnt + 1
                If Cnt = x Then 'Turn on this Light
                    L.state = 1
                    Exit Sub
                End If
            End If
        Next
    End If
End Sub

'**************************
' Random iten select End
'**************************


'************************
'    dungeon mutliball
'************************
Sub CheckDungeonMB
  GetAM
Debug "Checking for Ball Lock or Multiball"


    Select Case ActiveMode
      Case 2,4,6,8,10,11,12,13:
      if li022.State = 1 Then   ' if third ball is locked do soemthing
        'HwyMenAttrib = 0 '' MERLIN RTP  take this line out once the applyattribute is working
        If HwyMenAttrib = 0 Then ' Do not start mutliball if HwyMen is in the party
          if bBallInPlungerLane = True then FireBall
          Debug "Dungeon MB Started"
          DisableBallLock ' Turn Lock off
          AddMultiball 3
          BallsInLock(CurrentPlayer) = 0
          DisplayMBVideo
          'PuPlayer.LabelSet pDMD,"LockedBalls"," "  &  BallsinLock(CurrentPlayer) ,1,""
          'TrapdoorDown
  '       DMD "_", CL("BACK UP ARRIVES"), "_", eNone, eNone, eNone, 1500, True, "vo_backup"
           li032.state=0
           li021.state=0
           li022.state=0
           li046.state=0
           li039.state=0
          'ScorbitBuildGameModes
        Else
          Debug "Hwyman Alive in party so do not start multiball"
        End If
      End If
      Case 0,1,3,5,7:
          If BallsInLock(CurrentPlayer) = 3 Then
         '       DMD CL("BALL 3 LOCKED"), CL("BACK UP READY"), "_", eNone, eNone, eNone, 1500, True, "vo_lock 3"
            Debug "Ball 3 Locked"
            li032.state=1
            li021.state=1
            li022.state=1    ' third ball lock
            li046.State = 1
            BallHandlingQueue.Add "Pup857","PuPEvent 857",35,0,0,0,0,True
            AudioQueue.Add "Pup250","PuPEvent 250",25,0,0,0,0,False ' do not expire this audio -- prompts player that MB is loaded for dungeon
          Elseif BallsInLock(CurrentPlayer) = 2 Then
        '        DMD "_", CL("BALL 2 LOCKED"), "_", eNone, eNone, eNone, 1500, True, "vo_lock2"
            Debug "Ball 2 Locked"
            li021.state=1 ' second ball lock
            li032.state=1
            BallHandlingQueue.Add "Pup856","PuPEvent 856",35,0,0,0,0,True
          Elseif BallsInLock(CurrentPlayer) = 1 Then
         '       DMD "_", CL("BALL 1 LOCKED"), "_", eNone, eNone, eNone, 1500, True, "vo_lock"
            Debug "Ball 1 Locked " & BallsInLock(CurrentPlayer)
            li032.state=1
            BallHandlingQueue.Add "Pup855","PuPEvent 855",35,0,0,0,0,True
          End If
      Case 9:
          li038.state=0 ' Turn off Quest Light
          If BallsInLock(CurrentPlayer) = 3 Then
         '       DMD CL("BALL 3 LOCKED"), CL("BACK UP READY"), "_", eNone, eNone, eNone, 1500, True, "vo_lock 3"
            Debug "Ball 3 Locked"
            li032.state=1
            li021.state=1
            li022.state=1    ' third ball lock
            li046.State = 1
            BallHandlingQueue.Add "Pup857","PuPEvent 857",35,0,0,0,0,True
          Elseif BallsInLock(CurrentPlayer) = 2 Then
        '        DMD "_", CL("BALL 2 LOCKED"), "_", eNone, eNone, eNone, 1500, True, "vo_lock2"
            Debug "Ball 2 Locked"
            li021.state=1 ' second ball lock
            li032.state=1
            BallHandlingQueue.Add "Pup856","PuPEvent 856",35,0,0,0,0,True
          Elseif BallsInLock(CurrentPlayer) = 1 Then
         '       DMD "_", CL("BALL 1 LOCKED"), "_", eNone, eNone, eNone, 1500, True, "vo_lock"
            Debug "Ball 1 Locked " & BallsInLock(CurrentPlayer)
            li032.state=1
            BallHandlingQueue.Add "Pup855","PuPEvent 855",35,0,0,0,0,True
          End If
        Case Else:
          'Do nothing
      End Select

End Sub
'************************
'  dungeon mutliball end
'************************

'************************
'  ZEND - End Modes
'************************
Sub ModeEnd (caller)
Debug "---------- In Mode End"
  GeneralPupQueue.Add "BattleQueue-RemoveAll","BattleQueue.RemoveAll(True)",93,0,0,0,0,True
  'BattleQueue.RemoveAll(True)' Clear out battle queue
  DOFModesOff
  OldGI = "white"
  ChangeGI white
  'PlayVillageMusic 100
  gi051.state = 0
  gi052.state = 0
  Debug "In ModeEnd -- Starting Theme Music : " &Caller
  Debug2 "ModeEnd ActiveMode: " &ActiveMode
  LastMode = ActiveMode
  'Light010.State = 2

  'Debug "In Mode End " &Caller
  GlowMod = 0
  FlickerOn = False
  HideBleed  ' make sure bleed is reset
  LoadLUT:SetLUT
  DarknessLayer.Opacity = DefaultDarkness

  BallGlow DefaultBall,100,15
  PuPHideBattle "ModeEnd" '120.9

  if DMDType <> 2 Then
    Debug "MODE END DMDTYPE <> 2 "
    pupflasher1.visible=false
    GeneralPupQueue.Add "Pup511","pupevent 511",90,0,0,0,0,True ' clear left apron pup
  End If

  ClearPupMessages

  bInn = False
  HeroCountDown = "25"
  DungeonState = ""
  InBattle = 0
  HideBleed
  HideHelper
  HeroCountDownOriginal
  ResetMonsters
  CreateMonsterString
  ResetPlayerImages
  ResetTorches
  ResetLights
  ResetMonsterLights
  LowerAllDTs
  wall66down
  ResetUPF
  FireBall 'Maybe not needed here
Debug "-------- Leaving Mode End"
End Sub


Sub ReturnToVillage
Debug "-------- In Return to Village"
  DOFModesOff

  PlayVillageMusic 100
  'Debug "RTV: " &ActiveMode
  FlickerOn = False
  GlowMod = 0
  BallGlow DefaultBall,100,15
  InBattle = 0

  Light010.State = 2

  DarknessLayer.Opacity = DefaultDarkness


  if PartySize(CurrentPlayer) < 1 Then
    ClearPlayerImages
  Else
    ResetPlayerImages
  End If

  Herotimer.enabled = 0
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  HideBleed  ' make sure bleed is reset
  HeroCountDownOriginal

  ClearPupMessages

  Mode(CurrentPlayer,0) = 0
  SetModeTitle

' if bDrain = 0 Then
  EOBReturn "RTV"
' End If

  if PartySize(CurrentPlayer) < 4 And bInn = False Then
    Li047.state = 2 ' Flash Inn
  Elseif PartySize(CurrentPlayer) < 4 And bVillage = True Then
    Li047.state = 2 ' Flash Inn
  Else
    Li039.state = 2 ' Flash Inn Arrow
    Li038.state = 2 ' Flash Quest
  End If
Debug "---------- Leaving Return to village"
End Sub

'==================================================================================================

Sub ModeFail (caller)
Debug "-------- Entering ModeFail"
  DOFModesOff
  TorchesEnabled = 0
  InBattle = 0
  'PlayVillageMusic 100
  'BattleQueue.RemoveAll(True)' Clear out battle queue
  GeneralPupQueue.Add "BattleQueue-RemoveAll","BattleQueue.RemoveAll(True)",93,0,0,0,0,True

  if PartySize(CurrentPlayer) < 1 Then
    ClearPlayerImages
  Else
    ResetPlayerImages
  End If

  Gi052.state = 0
  OldGI = "white"
  ChangeGI white
  Debug "In ModeFail -- Calling Stop BG Audio : " &caller
  CreateMonsterString
  Debug "Monsters String: " &MonsterString

  HideBleed  ' make sure bleed is reset
  LastMode = ActiveMode
  Debug "In MODEFAIL: " &LastMode
  Light010.State = 2

  LoadLUT:SetLUT
  DarknessLayer.Opacity = DefaultDarkness

  Debug2 "Entered ModeFail: " &caller
  Debug "ModeFail - ActiveMode: " &ActiveMode
  BallGlow DefaultBall,100,15

  ClearPupMessages

  HeroCountDownOriginal
  HideHelper
  PuPHideBattle "ModeFail"
  Herotimer.enabled = 0
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0

  GetAM
  GlowMod = 0
  FlickerOn = False

  ClearDMDGuide

  pBackglasslabelshow "HeartMeter"  ' make sure heart gif is showing

  ResetTorches
  ResetLights
  ResetUPF
  Debug "Modefail: "&bDrain
  if bDrain = 0 Then ResetModes ' includes stopmode
  if BallsRemaining(CurrentPlayer) > 0 Then
    debug "mode fail calling 100"
    if bDrain = 0 Then
      Debug2 "Modefail bDrain = 0"
      GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
      GeneralPupQueue.Add "Pup400","pupevent 400",93,0,0,0,0,True
      GeneralPupQueue.Add "Pup200","pupevent 200",90,0,0,0,0,True
      'GeneralPupQueue.Add "Pup900","pupevent 900",95,4000,0,0,0,True
      'GeneralPupQueue.Add "Pup200","pupevent 200",90,4000,0,0,0,True
    End If
  End If

  ResetMonsterLights
  LowerAllDTs

  torchtimer.enabled = 0
  if li045.state = 2 Then li045.state=0 ' Ruins
  if li030.state = 2 Then li030.state=0 ' Cove
  if li031.state = 2 Then li031.state=0 ' Weald
  if li026.state = 2 Then li026.state=0 ' Warrens

  wall66down
  UpdateDMD
  FireBall ' maybe not needed

Debug "------- Leaving ModeFail"
End Sub
'==================================================================================================


'************************
'  ZRUIN - Ruin
'************************
Sub ResetModes
Debug "In Reset Modes"
  GetAM
  Select Case ActiveMode
    Case 1,3,5,7:
      if PartySize(CurrentPlayer) < 4 Then
        Mode(CurrentPlayer,ActiveMode) = 0 ' Reset Party Assembly Mode
        li047.state = 2
      Else
        li047.state = 0
        li038.state = 2
        ' leave in the mode they are in, just set the quest light
      End If
    Case 2,4,6,8:
      if PartySize(CurrentPlayer) < 4 Then
        Mode(CurrentPlayer,ActiveMode-1) = 0 ' Reset Party Assembly Mod Prior to this Dungeon
        li047.state = 2
      Else
        li047.state = 0
        li038.state = 2
        LastMode = ActiveMode
      End If
      Mode(CurrentPlayer,ActiveMode) = 0 ' Reset Dungeon Mode
    Case 12:
      if PartySize(CurrentPlayer) < 4 Then
        Mode(CurrentPlayer,ActiveMode) = 0 ' Reset Party Assembly Mode
      Else
        li047.state = 0
        li038.state = 2
        bBossDefeatedFullParty = true ' prevent next startnextmode from getting stuck, does not matter if boss was defeated or not, this needs to be set
      End If
      ResetWulf
      Mode(CurrentPlayer,ActiveMode) = 0 ' Reset Dungeon Mode
    Case 10,11,13,14:
      if PartySize(CurrentPlayer) < 4 Then
        Mode(CurrentPlayer,ActiveMode) = 0 ' Reset Party Assembly Mode
      Else
        li047.state = 0
        li038.state = 2
        bBossDefeatedFullParty = true ' prevent next startnextmode from getting stuck, does not matter if boss was defeated or not, this needs to be set
      Mode(CurrentPlayer,ActiveMode) = 0 ' Reset Dungeon Mode
      End If

    Case Else:
      ' Do Nothing
  End Select

  '' Do we really want to always drop into mode 0? -- Answer as long as startnextmode is called after this makes sense
  'Mode(CurrentPlayer,0) = 0 ' Reset to base mode
  'SetModeTitle
  debug2 "in reset modes"
  UpdateDMD
  ResetUPF
  DOFModesOff
End Sub

Sub DisplayWizardModeMessage
  PuPlayer.LabelSet pBackglass,"CryptMessage","Hit Captive Ball",1,""
  PuPlayer.LabelSet pBackglass,"CryptMessage2","To Begin Crypt Ball Lock",1,""
End Sub

Sub HideWizardModeMessage
  PuPlayer.LabelSet pBackglass,"CryptMessage","",0,""
  PuPlayer.LabelSet pBackglass,"CryptMessage2","",0,""
End Sub

Sub ReturnWizPrep
' this is called from endofballcomplete
  Debug2 "Return WizPrep"
  CreateNewBall()
  FillParty
  WinWizardModePrep
End Sub

Sub WizardModePrep
  Debug2 " Wizard Mode Prep"
  'StopAttractMode ' Make sure attractmode is off
  'ChangeCryptImages
  bDungeonsClosed = True
    DOF 247, DOFOn
  ResetLights ' turn off all other lights

  if bRetry = False Then
    BallsInLock(CurrentPlayer) = 0 ' reset locked balls on first pass
  Else
    ' reset the ball locked Lights
    If BallsInLock(CurrentPlayer) = 1 Then li032.state = 1
    If BallsInLock(CurrentPlayer) = 2 Then li032.state = 1:li021.state = 1
    If BallsInLock(CurrentPlayer) = 3 Then li032.state = 1:li021.state = 1:li022.state = 1

  End If

  bRetry = True

  Mode(CurrentPlayer,0) = 9
  Mode(CurrentPlayer,9) = 1
  SetModeTitle
  BallGlow DefaultBall,100,15
  Debug2 "Wizard Mode Prep"
  UpdateModeLabels

  bInn = True
  AudioQueue.Add "Pup291","PuPEvent 291",25,0,0,0,AudioExpiry,False
  AudioQueue.Add "Pup446","PuPEvent 446",20,100,0,0,0,False ' Inn music
  GeneralPupQueue.Add "Pup347","pupevent 347",90,200,0,0,0,True
  InnLighting

  ClearPupMessages

  Debug "PartySize: " &PartySize(CurrentPlayer)
  if PartySize(CurrentPlayer) < 4 Then
    if DMDType <> 2 Then pupflasher1.visible=true

    GeneralPuPQueue.Add "Pup301","PuPEvent 301",10,0,0,0,0,True
    BallHandlingQueue.Add "SetPartyLights","SetPartyLights",20,0,0,0,0,False
  Else
    CheckParty
  End If

  CheckItemColors "winwizardmodeprep"
  CheckIconColors "winwizardmodeprep"

End Sub

Sub WinWizardModePrep
' Change BG Image
' Change BG Music
  GeneralPupQueue.Add "Pup900","pupevent 900",90,0,0,0,0,True
  AudioQueue.Add "Pup447","PuPEvent 447",20,0,0,0,0,False ' Crypt music

  Debug2 "WinWizardMode"


  ChangeCryptImages
  GeneralPupQueue.Add "DisplayWizardModeMessage","DisplayWizardModeMessage",10,250,0,0,0,False

  bDungeonsClosed = True
    DOF 247, DOFOn
  HeroCountdown = 60 ' set to higher value so players can survice
  li021.state = 0 ' turn off ball lights
  li022.state = 0
  li032.state = 0

  If BallsInLock(CurrentPlayer) = 1 Then li032.state = 1
  If BallsInLock(CurrentPlayer) = 2 Then li032.state = 1:li021.state = 1
  If BallsInLock(CurrentPlayer) = 3 Then li032.state = 1:li021.state = 1:li022.state = 1
  Mode(CurrentPlayer,0) = 9
  Mode(CurrentPlayer,9) = 2
  'SetModeTitle
  ModeTitle = "Wizard Lock"
  BallGlow 8,100,15
  Debug "Wizard Mode Prep"

  UpdateModeLabels
  ResetLights ' turn off all other lights

  EnableBallLock
  li038.state=0 ' Turn off Quest Light
  li047.state = 0 ' turn off Inn light
  CheckItemColors "wizardmodeprep"
  CheckIconColors "wizardmodeprep"
  if DMDType = 0 Then UpdateBG
End Sub

Sub WizardMode
    DOF 252, DOFOn
  Mode(CurrentPlayer,0) = 15
  Mode(CurrentPlayer,15) = 1
  ScorbitBuildGameModes
  HideHelper
  SetModeTitle
  PuPHideBattle "WizardMode"   ' make sure pup battle is hidden
  BallGlow 8,100,15
  'pNote "WIZARD","MODE"
  UpdateModeLabels
  SetCryptLights2

  bMultiBallMode = True
  'bSupressBGMessages = True

  AudioQueue.Add "Pup444","PuPEvent 444",20,0,0,0,0,False' wizard mode audio
  'GeneralPupQueue.Add "Pup200","pupevent 200",90,20,0,0,0,True
  if DMDType <> 2 Then pupflasher1.visible=true

  'GeneralPuPQueue.Add "Pup313","PuPEvent 313",14,50,0,0,0,True

  'triggerscript 100, "EOBHide ""wizardmode""
  'GeneralPuPQueue.Add "EOBHide-WM","EOBHide ""wizardmode"" ",64,100,0,0,0,True
  PuPevent 200
  PuPevent 313
  'PuPevent 300
  EOBHide "wizardmode"
  BallHandlingQueue.Add "Pup854","PuPEvent 854",55,200,0,0,0,True
  GeneralPuPQueue.Add "Pup902","PuPEvent 902",5,6150,0,0,0,False ' Long video need to figure out when it ends in EOB routine
  BallHandlingQueue.Add "addmultiball-3","addmultiball 3",50,6500,0,0,0,True
End Sub

'Sub WizardModeAudio
' PuPEvent 444
'End Sub

Sub SetCryptLights
  li047.state = 0 ' turn off Inn light
  li038.state = 0 ' quest light
  li039.State = 0 ' inn arrow
  li036.state = 0 'leftramp
  li040.state = 0   ' rightramp
  li051.state = 0 'orbits on
  li060.state = 0
  li037.state = 0
End Sub

Sub SetCryptLights2
  li047.state = 0 ' turn off Inn light
  li038.state = 0 ' quest light
  li036.state = 2 'leftramp
  li040.state = 2   ' rightramp
  li051.state = 2 'orbits on
  li060.state = 2
  li037.state = 2
  li032.state = 0 'lock1
  li021.state = 0 ' lock2
  li022.state = 0 ' lock3
End Sub

Sub ResetLights
  'li038.state=0 ' Turn off Quest Light ' 123.8
  'li047.state=0 ' inn light flash    ' 123.8
  li039.state=0 ' inn arrow

  li046.State = 0 ' turn off lock light


  li036.state=0 'leftramp
  li040.state=0   ' rightramp
  li051.state=0 'orbits off
  li060.state=0
  li037.state=0
  ' bumpers
  Lbumper1a.state=0
  Lbumper1b.state=0
  Lbumper2a.state=0
  Lbumper2b.state=0

'upper playfield Lights
  p61.material = "InsertWhiteOffTri": Li061.state = 0:Target006.image = "HitTarget"
  p62.material = "InsertWhiteOffTri": Li062.state = 0:Target007.image = "HitTarget"
  p63.material = "InsertWhiteOffTri": li063.state = 0:Target008.image = "HitTarget"
  p64.material = "InsertWhiteOffTri": li064.state = 0:Target009.image = "HitTarget"

  'wall66down
  Dim L
  For each L in ChaseLightsArray : L.state=0 : Next

End Sub


Sub StartDungeonBattle
  UPFHitCount(CurrentPlayer) = 0
  InBattle = 1
  bHoldBall = False ' Turn off ball hold
  BattleID(CurrentPlayer) = BattleID(CurrentPlayer)  + 1
  ResetTorches
  'HideHelper ' make sure helper message is gone

  GetAM
  Select Case ActiveMode
    Case 2,4,6,10,13:
      OriginalHeroCountDown = 25 + HBMOD
      Torchtimer.enabled = 1
    Case 12:
      OriginalHeroCountDown = 8 + HBMOD2' Needs to match chasewulf timer
    Case 8,11:
      OriginalHeroCountDown = 40 + HBMOD
    Case 14:
      OriginalHeroCountDown = 60
    Case Else:
      OriginalHeroCountDown = 25 + HBMOD
    End Select

  'StartDTs
  HeroCountDownOriginal  ' set the new original timer value to max value
  HeroTimerReset '
  RandomlyApplyAttributes
' PuPDisplayBattle "StartDungeon"
End Sub



Sub wall66up
  wall066.isDropped = False
End Sub



Sub wall66down
  wall066.isDropped = True
End Sub




'random lights for weald
Dim ChaseLightsArray
ChaseLightsArray = Array(Li060,Li036,Li037,Li040,Li051)


'General sub for turning on only random light in an array of lights
Sub ChaseLights
    Dim L, Cnt, x
    'Check how many lights lit
    Cnt = 0
    For each L in ChaseLightsArray
        If L.state > 0 Then Cnt = Cnt + 1
    Next

  'Debug "Phase 1: " &Cnt

  If Cnt > 4 Then
  'Debug "Cnt is 5"
    Cnt = 0 ' if all lit then turn off all Lights
    For Each L in ChaseLightsArray
      L.state=0
    Next
  End If

    'If possible, pick a random unlit light, then set it to blink state
    If Cnt < UBound(ChaseLightsArray)+1 Then
        x = RndInt(1,UBound(ChaseLightsArray)+1-Cnt)
'   Debug "Phase 2 X: "&x
        Cnt = 0
        For each L in ChaseLightsArray
           If L.state = 0 Then
                Cnt = Cnt + 1
                If Cnt = x Then 'Turn on this Light
          Debug "Chase Lights:: turning on light : "&Cnt
                    L.state = 2
                    Exit Sub
                End If
            End If
        Next
    End If
End Sub


Sub rramp_hit
    DOF 213, DOFPulse
'Debug "Hit Right Ramp"
  WireRampOff ' Turn off the Plastic Ramp Sound
  If Tilted Then Exit Sub

' Switch_Hit "Rrampcombo"
  CheckItems

  ActiveMode = Mode(CurrentPlayer,0)
  Select Case ActiveMode
    Case 0:
    If TMode <> 1 AND BSMode <> 1 Then
      if Missions(CurrentPlayer,2)  = 0 Then
        RightRampCount(CurrentPlayer) = RightRampCount(CurrentPlayer) + 1
        'pNote "Right Ramp", "Hit"
        CheckRampCount
      Elseif Missions(CurrentPlayer,2) = 1 Then
        RightRampCount(CurrentPlayer) = RightRampCount(CurrentPlayer) + 1
        GambleCountDown = GambleCountDown + 3 ' Add Four Seconds to the Gamble Timer
      End If
      if GMode = 1 Then
        HideRampCounts
        DisplayGambleRampHits
        if DMDType = 0 And bSupressBGMessages = False Then
          pBackglassLabelHide "GambleOn"
        Elseif DMDType <> 0 Then
          pDMDLabelHide "GambleOn"
        End If
      Elseif bEOBSupress = False Then
        DisplayRampCounts
        if DMDType = 0 And bSupressBGMessages = False  Then
          pBackglassLabelShow "GambleOn"
          GeneralPuPQueue.Add "pBackglasslabelhide-gamble","pBackglassLabelHide ""GambleOn"" ",35,1500,0,0,0,False
        Elseif DMDType <> 0 Then
          pDMDLabelShow "GambleOn"
          GeneralPuPQueue.Add "pDMDlabelhide-gamble","pDMDLabelHide ""GambleOn"" ",35,1500,0,0,0,False
        End If
      End If
    End If

    If TMode <> 1 AND GMode <> 1 Then
      if Missions(CurrentPlayer,1) = 2 And BSMode Then ' Advance Blacksmith
        'Playsound "hammer"
        PuPEvent 292
        Missions(CurrentPlayer,1) = 3
          CountDownMessage1 = "5 Shots Remain"
        Debug "Blacksmith Count: "&Missions(CurrentPlayer,1)
        li040.state = 1 ' Turn off blaacksmith light
        li037.state = 2 ' make inside orbit
        Addscore2 Score_BlacksmithLevel
        ResetBSMode
      end if
    End If
    Case 1:
      if AMState <> 0 And ItemCount < 5 Then
        AddItem
      End If
    Case 2: ' Dungeon Battle Ruins
      DungeonProgress
    Case 3:
      if AMState <> 0 And ItemCount < 5 Then
        AddItem
      End If
    Case 4:
      ' Dungeon Battle Cove
    Case 5:
      if AMState <> 0 And ItemCount < 5 Then
        AddItem
      End If
    Case 6: ' Dungeon Battle Weald
      if li040.state = 2 Then
        DungeonProgress ' Weald Progress
        li040.state = 1
        CheckWealdWin
      End If
    Case 7:
      if AMState <> 0 And ItemCount < 5 Then
        AddItem
      End If
    Case 8: ' Dungeon Battle Warrens
      ' Debug In Warrens
    Case 9:
      if AMState <> 0 And ItemCount < 5 Then
        AddItem
      End If
    Case 10:
      DungeonProgress
    Case 14:
      'Shambler Mode
      if li040.state = 2 Then
        li040.state = 1
        setlightcolor li008, red,1
      elseif li040.state = 1 Then
        li040.state = 0
        setlightcolor li008, white,0
        CheckShamblerDefeated
      End If
    Case 15:
      if DMDType <> 2 Then pup2helper 3000
      GeneralPuPQueue.Add "Pup790","PuPEvent 790",10,0,0,0,ShortPuPExpiry,False
      AudioQueue.Add "Pup263","PuPEvent 263",32,0,0,0,AudioExpiry,False
      if CryptMBCount(4) < CryptRound Then
        CryptMBCount(4) = CryptMBCount(4) + 1
        AddScore2 Score_CryptJackpot*CryptRound
        CheckCryptSuperJP
        li040.state=0
        Exit Sub
      End If
    Case Else:

  End Select

' if Missions(CurrentPlayer,2) = 1 and Test_Switch("Lrampcombo") = 1  Then
'   addbonus Score_GambleWin2X
' ElseIf Missions(CurrentPlayer,2) = 1 Then
'   addbonus Score_GambleWin
' End If

  Switch_Hit "rramp"
  LastSwitchHit = "rramp"
End Sub

Sub TotalRampHits
  RampHits = LeftRampCount(CurrentPlayer) &"/" &RightRampCount(CurrentPlayer)
End Sub

Sub AddRampHits
  RampHitsTotal = LeftRampCount(CurrentPlayer) + RightRampCount(CurrentPlayer)
End Sub

Sub CheckRampCount
  TotalRampHits
    if LeftRampCount(CurrentPlayer) > RampReq - 1 And RightRampCount(CurrentPlayer) > RampReq - 1 Then
      Debug "GambleMode Entered"
      gamblemode
    End If
End Sub



Sub lramp_Hit
    DOF 214, DOFPulse
  GetAM
  'Debug "Hit Left Ramp"
  WireRampOff ' Turn off the Plastic Ramp Sound
  If Tilted Then Exit Sub

  Switch_Hit "Lrampcombo"

  Select Case ActiveMode
    Case 0:
    If TMode <> 1 AND BSMode <> 1 Then
      if Missions(CurrentPlayer,2)  = 0 Then
        LeftRampCount(CurrentPlayer) = LeftRampCount(CurrentPlayer) + 1
        CheckRampCount
      Elseif Missions(CurrentPlayer,2) = 1 Then
        LeftRampCount(CurrentPlayer) = LeftRampCount(CurrentPlayer) + 1
        'CountDown = CountDown + 4 ' Add Four Seconds to the Gamble Timer
        GambleCountDown = GambleCountDown + 3 ' Add Four Seconds to the Gamble Timer
      End If
      if GMode = 1 Then
        HideRampCounts
        DisplayGambleRampHits
        if DMDType = 0 And bSupressBGMessages = False Then
          pBackglassLabelHide "GambleOn"
        Elseif DMDType <> 0 Then
          pDMDLabelHide "GambleOn"
        End If
      Elseif bEOBSupress = False Then
        DisplayRampCounts
        if DMDType = 0 And bSupressBGMessages = False  Then
          pBackglassLabelShow "GambleOn"
          GeneralPuPQueue.Add "pBackglasslabelhide-gamble","pBackglassLabelHide ""GambleOn"" ",35,1500,0,0,0,False
        Elseif DMDType <> 0 Then
          pDMDLabelShow "GambleOn"
          GeneralPuPQueue.Add "pDMDlabelhide-gamble","pDMDLabelHide ""GambleOn"" ",35,1500,0,0,0,False
        End If
      End If
    End If

    If TMode <> 1 AND GMode <> 1 Then
      if Missions(CurrentPlayer,1) = 4 And BSMode Then
          'Playsound "hammer"
          PuPEvent 292
          Missions(CurrentPlayer,1) = 5
          CountDownMessage1 = "3 Shots Remain"
          Debug "Blacksmith Count: "&Missions(CurrentPlayer,1)
          li036.state = 1
          li051.state = 2
          Addscore2 Score_BlacksmithLevel
          ResetBSMode
      End If
    End If
    Case 1:
      if AMState = 1 Then
        AddPartyMember
      End If
    Case 2: ' Dungeon Battle Ruins
      DungeonProgress
    Case 3:
      if AMState = 1 Then
        AddPartyMember
      End If
    Case 4: ' Dungeon Battle Cove
      ' Do nothing
    Case 5:
      if AMState = 1 Then
        AddPartyMember
      End If
    Case 6: ' Dungeon Battle Weald
      if li036.state = 2 Then
        DungeonProgress' Weald Progress
        li036.state = 1
        CheckWealdWin
      End If
    Case 7:
      if AMState = 1 Then
        AddPartyMember
      End If
    Case 8:
      ' Dungeon Battle Warrens

    Case 9:
      if AMState = 1 Then
        AddPartyMember
      End If
    Case 10:
      DungeonProgress
    Case 14:
      'Shambler Mode
      if li036.state = 2 Then
        li036.state = 1
        setlightcolor li025, red,1
      elseif li036.state = 1 Then
        li036.state = 0
        setlightcolor li025, white, 0
        'PlayerAttack
        CheckShamblerDefeated
      End If
    Case 15:
      if DMDType <> 2 Then pup2helper 3000
      GeneralPuPQueue.Add "Pup790","PuPEvent 790",10,0,0,0,ShortPuPExpiry,False
      AudioQueue.Add "Pup263","PuPEvent 263",32,0,0,0,AudioExpiry,False
      if CryptMBCount(2) < CryptRound Then
        CryptMBCount(2) = CryptMBCount(2) + 1
        AddScore2 Score_CryptJackpot*CryptRound
        CheckCryptSuperJP
        li036.state=0
        Exit Sub
      End If
    Case Else:

  End Select

  if light009.state = 2 Then
    Debug "Should have awarded extraball"
    AwardExtraBall
  End If

  Switch_Hit "lramp"
  LastSwitchHit = "lramp"
End Sub

Sub ClearExtraball
  light009.state = 0
  pBackglassHideAnimate "ExtraballGIF"
  if DMDType = 0 Then
    PuPlayer.LabelSet pBackglass,"ExtraballDMD","",0,""
  Else
    PuPlayer.LabelSet pDMD,"ExtraballDMD","",0,""
  End If

End Sub

Sub ResetOrbitTimer
  FullOrbitTimer.Enabled = 0
  FullOrbitTimer.Enabled = 1
End Sub

'==========================================================
Sub InsideOrbitTrigger_Hit()
  GetAM
  Select Case ActiveMode
    Case 1,3,5,7,9:
      ORBHIT = 1
      CheckOrbitHits ' give full credit for this hit
      ResetOrbitTimer
    Case 2: ' Dungeon Battle Ruins
      ORBHIT = 1
      CheckOrbitHits  ' give full credit for this hit
      ResetOrbitTimer
    Case 6,14:
      Debug "Inside Orbit hit"
      ORBHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case 15:
      ORBHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case Else:
      'Do Nothing
  End Select

Switch_Hit "orbitinside"
LastSwitchHit = "orbitinside"
End Sub

Sub leftorbitinside_Hit
    DOF 215, DOFPulse
    If Tilted Then Exit Sub

  Debug5 "Hit Left Inside Orbit: "  &LastSwitchHit

  GetAM
  Select Case ActiveMode
    Case 0:
      if Missions(CurrentPlayer,1) = 3 And BSMode Then
          'Playsound "hammer"
          PuPEvent 292
          Missions(CurrentPlayer,1) = 4
          CountDownMessage1 = "4 Shots Remain"
          Debug "IN - Blacksmith Count: "&Missions(CurrentPlayer,1)
          li037.state = 1
          li036.state = 2 ' left ramp
          Addscore2 Score_BlacksmithLevel
          ResetBSMode
      End If
    Case 1,3,5,7,9:
      INHIT = 1
      CheckOrbitHits ' give full credit for this hit
      ResetOrbitTimer
    Case 2: ' Dungeon Battle Ruins
      INHIT = 1
      CheckOrbitHits  ' give full credit for this hit
      ResetOrbitTimer
    Case 6,14:
      Debug "Inside Orbit hit"
      INHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case 15:
      INHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case Else:
      'Do Nothing
  End Select

Switch_Hit "leftorbitinside"
LastSwitchHit = "leftorbitinside"
End Sub

Sub leftorbit_Hit
    DOF 216, DOFPulse
    If Tilted Or bSupressLeftOrbit = True Then Exit Sub

  Debug5 "Hit Left Orbit: "  &LastSwitchHit

  GetAM
  Select Case ActiveMode
    Case 0:
      if Missions(CurrentPlayer,1) = 1 And BSMode Then
          'Playsound "hammer"
          PuPEvent 292
          Missions(CurrentPlayer,1)  = 2
          CountDownMessage1 = "6 Shots Remain"
          Debug "LO - Blacksmith Count: "&Missions(CurrentPlayer,1)
          li060.state=1 ' Left Orbit
          li040.state =2 ' Right Ramp
          Addscore2 Score_BlacksmithLevel
          ResetBSMode
      end if
    Case 1,3,5,7,9:
      if AMState = 1 Then
        LOHIT = 1
        CheckOrbitHits
        ResetOrbitTimer
      End If
    Case 2: ' Dungeon Battle Ruins
      LOHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case 6,14:
      Debug "Left Orbit hit"
      LOHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case 15:
      LOHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case Else:
      'Do Nothing
  End Select

  Switch_Hit "leftorbit"
LastSwitchHit = "leftorbit"
  Debug "Leaving Left Orbit"
End Sub

Sub rightorbit_Hit
    DOF 217, DOFPulse
    If Tilted Or bSupressRightOrbit = True Then Exit Sub

  Debug5 " Hit Right Orbit: "  &LastSwitchHit

  GetAM
  Select Case ActiveMode
    Case 0:
      if Missions(CurrentPlayer,1) = 5 And BSMode Then
          'Playsound "hammer"
          PuPEvent 292
          Missions(CurrentPlayer,1) = 6
          CountDownMessage1 = "2 Shots Remain"
          li051.state = 1 ' Right Orbit
          li039.state=2 ' Inn Arrow
          Addscore2 Score_BlacksmithLevel
          ResetBSMode
      End If
    Case 1,3,5,7,9:
      if AMState = 1 Then
        ROHIT = 1
        CheckOrbitHits
        ResetOrbitTimer
      End If
    Case 2: ' Dungeon Battle Ruins
      ROHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case 6,14:
      Debug2 "Right Orbit hit"
      ROHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case 15:
      ROHIT = 1
      CheckOrbitHits
      ResetOrbitTimer
    Case Else:
      Debug " RightOrbit Else:" & AMCombo
      'Do Nothing
  End Select

  Switch_Hit "rightorbit"
LastSwitchHit = "rightorbit"

End Sub

Sub CheckOrbitHits  ' If both orbits completed allow addpartymember
'Debug5 "In Check Orbits R/L/I/O - " &ROHIT &":" &LOHIT &":" &INHIT &":" &ORBHIT


'' ROUTINES FOR FULL ORBIT HITS

  if LOHIT And ROHIT Then
    Select Case ActiveMode
      Case 1,3,5,7,9:
        AddPartyMember
      Case 2:
        DungeonProgress
      Case Else:
        ' Do Nothing
    End Select

    if Mode(CurrentPlayer,0) = 15 Then
      debug5 "Running TESTS: " &LastSwitchHit
      if DMDType <> 2 Then pup2helper 3000

      GeneralPuPQueue.Add "Pup790","PuPEvent 790",10,0,0,0,ShortPuPExpiry,False
      AudioQueue.Add "Pup270","PuPEvent 270",32,0,0,0,AudioExpiry,False

      if LastSwitchHit = "rightorbit" or LastSwitchHit = "orbitinside" Then
        debug5 "right orbit was hit"
        if CryptMBCount(5) < CryptRound Then
          CryptMBCount(5) = CryptMBCount(5) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li051.state=0
          CheckCryptSuperJP
        End If
      elseif LastSwitchHit = "leftorbit" Then
        debug5 "left orbit was hit"
        if CryptMBCount(1) < CryptRound Then
          CryptMBCount(1) = CryptMBCount(1) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li060.state=0
          CheckCryptSuperJP
        End If
      elseif LastSwitchHit = "leftorbitinside" or LastSwitchHit = "orbitinside" Then
        debug5 "Inside Orbit Hit"
        if CryptMBCount(3) < CryptRound Then
          CryptMBCount(3) = CryptMBCount(3) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li037.state=0
          CheckCryptSuperJP
        End If
      End If
    End If
    OrbitHits = OrbitHits + 1
    debug5 " Full Orbit Hit L&R: " &LastSwitchHit
    ROHIT = 0
    LOHIT = 0
  End If

  if (LOHIT Or ORBHIT) And INHIT Then
    Select Case ActiveMode
      Case 1,3,5,7,9:
        AddPartyMember
      Case 2:
        DungeonProgress
      Case Else:
        ' Do Nothing
    End Select

    if Mode(CurrentPlayer,0) = 15 Then
      if DMDType <> 2 Then pup2helper 3000

      GeneralPuPQueue.Add "Pup790","PuPEvent 790",10,0,0,0,ShortPuPExpiry,False
      AudioQueue.Add "Pup270","PuPEvent 270",32,0,0,0,AudioExpiry,False

      if LastSwitchHit = "rightorbit" Then
        debug5 "right orbit was hit"
        if CryptMBCount(5) < CryptRound Then
          CryptMBCount(5) = CryptMBCount(5) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li051.state=0
          CheckCryptSuperJP
        End If
      elseif LastSwitchHit = "leftorbit" Then
        debug5 "left orbit was hit"
        if CryptMBCount(1) < CryptRound Then
          CryptMBCount(1) = CryptMBCount(1) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li060.state=0
          CheckCryptSuperJP
        End If
      elseif LastSwitchHit = "leftorbitinside" or LastSwitchHit = "orbitinside" Then
        debug5 "Inside Orbit Hit"
        if CryptMBCount(3) < CryptRound Then
          CryptMBCount(3) = CryptMBCount(3) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li037.state=0
          CheckCryptSuperJP
        End If
      End If
    End If
    OrbitHits = OrbitHits + 1
    debug5 " Full Orbit Hit L&I"
    INHIT = 0
    LOHIT = 0
    ORBHIT = 0
  End If

  if (ROHIT Or ORBHIT) And INHIT Then
    Select Case ActiveMode
      Case 1,3,5,7,9:
        AddPartyMember
      Case 2:
        DungeonProgress
      Case Else:
        ' Do Nothing
    End Select

    if Mode(CurrentPlayer,0) = 15 Then
      if DMDType <> 2 Then pup2helper 3000

      GeneralPuPQueue.Add "Pup790","PuPEvent 790",10,0,0,0,ShortPuPExpiry,False
      AudioQueue.Add "Pup270","PuPEvent 270",32,0,0,0,AudioExpiry,False

      if LastSwitchHit = "rightorbit" Then
        debug5 "right orbit was hit"
        if CryptMBCount(5) < CryptRound Then
          CryptMBCount(5) = CryptMBCount(5) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li051.state=0
          CheckCryptSuperJP
        End If
      elseif LastSwitchHit = "leftorbit" Then
        debug5 "left orbit was hit"
        if CryptMBCount(1) < CryptRound Then
          CryptMBCount(1) = CryptMBCount(1) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li060.state=0
          CheckCryptSuperJP
        End If
      elseif LastSwitchHit = "leftorbitinside" or LastSwitchHit = "orbitinside" Then
        debug5 "Inside Orbit Hit"
        if CryptMBCount(3) < CryptRound Then
          CryptMBCount(3) = CryptMBCount(3) + 1
          AddScore2 Score_CryptJackpot*CryptRound
          li037.state=0
          CheckCryptSuperJP
        End If
      End If
    End If
    OrbitHits = OrbitHits + 1
    debug5 " Full Orbit Hit R&I"
    INHIT = 0
    ROHIT = 0
    ORBHIT = 0
  End If

'' ROUTINES FOR PARTIAL ORBIT HITS


  if Mode(CurrentPlayer,0) = 6 Then
    if LastSwitchHit = "rightorbit" Then
      Debug2 "LS: right orbit was hit"
      if li051.state = 2 Then
        li051.state = 1
        DungeonProgress
        CheckWealdWin
      End If
    elseif LastSwitchHit = "leftorbit" Then
      Debug2 "LS: left orbit was hit"
      if li060.state = 2 Then
        li060.state = 1
        DungeonProgress
        CheckWealdWin
      End If
    elseif LastSwitchHit = "leftorbitinside" Then
      Debug2 "LS: Inside Orbit Hit"
      if li037.state = 2 Then
        li037.state = 1
        DungeonProgress
        CheckWealdWin
      End If
    End If
  End If

  if Mode(CurrentPlayer,0) = 14 Then
    if LastSwitchHit = "rightorbit" Then
      Debug "right orbit was hit"
      if li051.state = 2 Then
        li051.state = 1
        setlightcolor li006, red,1
      elseif li051.state = 1 Then
        li051.state = 0
        setlightcolor li006, white,0
        CheckShamblerDefeated
      End If
    elseif LastSwitchHit = "leftorbit" Then
      Debug "left orbit was hit"
      if li060.state = 2 Then
        li060.state = 1
        setlightcolor li024, red,1
      elseif li060.state = 1 Then
        li060.state = 0
        setlightcolor li024, white,0
        CheckShamblerDefeated
      End If
'   elseif LastSwitchHit = "leftorbitinside" Then
'     Debug "Inside Orbit Hit"
'     if li037.state = 2 Then
'       li037.state = 1
'     elseif li037.state = 1 Then
'       li037.state = 0
'       CheckShamblerDefeated
'     End If
    End If
  End If


End Sub

Sub FullOrbitTimer_Timer()
    ROHIT = 0
    LOHIT = 0
    INHIT = 0
    ORBHIT = 0
    FullOrbitTimer.Enabled = 0
End Sub

Dim r,Tmp_Total

Sub CheckCryptSuperJP

Tmp_Total = 0
Debug5 " Calling CheckCryptSuperJP"

  For r = 1 to 5
    Tmp_Total = Tmp_Total + CryptMBCount(r)
  Next

Debug5 " Calling CheckCryptSuperJP: " & Tmp_Total
  if Tmp_Total = 5*CryptRound Then
    bSuperJackpotReady = True
    'AddScore2 Score_CryptSuperJackpot * CryptRound
    'if CryptRound < 3 Then CryptRound = CryptRound + 1 ' MAX value is 3 times
    'SetCryptLights
    li038.state = 2 ' turn on quest light for super jackpot
  End If
End Sub

'-------------------------------------------------------------------------------------------------
Sub DungeonCleared
  DungeonsCleared(CurrentPlayer) = DungeonsCleared(CurrentPlayer) + 1
  ClearDungeonPup
  ClearDungeonPup2
  DungeonBonusTimer.Enabled = 0
  DungeonBonusTimerExpired.Enabled = 0
End Sub

Sub scoop2_Hit 'Start dungeon
ClearPupMessages
  Debug "CENTER Scoop Hit: "&AMCombo
    PlaySoundAt "VUKEnter", scoop2
    DOF 116, DOFPulse
    scoop2.Destroyball
    BallsinHole = BallsInHole + 1

    If Tilted Then
    BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
    Exit Sub
  End If

  GetAM
  Select Case ActiveMode
  Case 0,1,2,3,4,5,6,7,8,9,10,11,12,13:
    if bDungeonsClosed = True Then
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
      Exit Sub
    End If
  End Select




  Select Case ActiveMode
    Case 0:
      ClearDungeonPup2

      Debug "INN MUST NOT CLEARED: "&InnCleared
      if BSMode <> 1 And GMode <> 1 And TMode <> 1 And li038.state = 2 And bRetry = True Then
        li038.state = 0
        StartNextMode
      elseif BSMode <> 1 And GMode <> 1 And TMode <> 1 And li038.state = 2 And bRetry = False Then
        li038.state = 0
        BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
        BallHandlingQueue.Add "bHoldBallDelay-T","bHoldBallDelay = True",54,0,0,0,0,True
        PickDungeon
        Exit Sub
      elseif BSMode <> 1 And GMode <> 1 And TMode <> 1 And li038.state <> 2 And PartySize(CurrentPlayer) > 3 Then
        li038.state = 2
      End If

      if BSMode = 1 And Missions(CurrentPlayer,1) = 7 Then
        CheckBlacksmithWin
      elseif Missions(CurrentPlayer,2) = 1 And GMode = 1 Then   ' Gamble Mode Check
        ClearGambleCountDownPup
        HideGambleRampHits
        ReturnOverlay "scoop2"
        GeneralPupQueue.Add "Pup833","PuPevent 833:DisplayGamblePoints",41,200,0,0,0,True
        GambleModeTimer.Enabled = 0  ' Pause timer while player makes a decision
        Debug "Gambler Side Mission Active"
        BallHandlingQueue.Add "bHoldBall-T","bHoldBall = True",55,0,0,0,0,True
        Exit Sub
      End If

      Debug "Scoop2 KICK Out Called - Case 0 "
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True   ' No reason to hold ball for side missions so release

    Case 2:
    HeroCountDown = HeroCountDown + 5
    AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
      if AMState = 2 Then
        Debug "Scoop2 AM 2"
        ' Do Nothing
          li038.state=0 ' Turn off quest light  -- Not sure these are needed
          if MonstersCleared = 1 Then
            Debug "DUNGEON CLEARED "&AMCombo
            Mode(CurrentPlayer,2) = 3
            InnCleared = 0 ' Reset the Inn
            RegionMonster(CurrentPlayer,ActiveMode) = 0
            ResetMonsters ' Reset monster health
            DungeonCleared
            ClearDMDGuide

            if DMDType = 2 Then
              HideDMD 6000, True
            Else
              Pup2Helper 6000
            End If
            GeneralPuPQueue.Add "Pup731","PuPEvent 731",11,0,0,0,0,False ' Dungeon Cleared Pups
            PuPHideBattle "Case 2 scoop2_hit"
            LoadProphet
            if DungeonBonus = 1 Then addscore2 Score_DungeonBonus
            if PartySize(CurrentPlayer) < 4 Then li047.state = 2 ' inn flash
          Else
            BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
            Debug "Monsters still in Dungeon "&AMCombo
          End If ' Monsters cleared
        Else ' If AMState = 2
          Debug " Else of AMSTATE2 - Kicked Ball Out"
          BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
        End If ' ActiveState = 2

    Case 4:
    Debug "Scoop2 KICK Out Called - Case 4"
    HeroCountDown = HeroCountDown + 5
    AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
      if AMState = 2 Then
      Debug "In Scoop2 Case 4: "&AMCombo
          li038.state=0 ' Turn off quest light  -- Not sure these are needed
          if MonstersCleared = 1 Then
            Mode(CurrentPlayer,4) = 3
            DungeonCleared
            ClearDMDGuide
            GeneralPuPQueue.Add "Pup732","PuPEvent 732",11,0,0,0,0,False
            InnCleared = 0 ' Reset the Inn
            RegionMonster(CurrentPlayer,ActiveMode) = 0
            ResetMonsters ' Reset monster health
            if DMDType = 2 Then
              HideDMD 6000, True
            Else
              Pup2Helper 6000
            End If
            PuPHideBattle "Case 4  scoop2_hit"
            loaddrownedcrew
            Debug "DUNGEON CLEARED "&AMCombo
            li038.state = 0
            if PartySize(CurrentPlayer) < 4 Then li047.state = 2 ' inn flash
            if DungeonBonus = 1 Then addscore2 Score_DungeonBonus

          Else
            BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
            Debug "Monsters still in Dungeon "&AMCombo
          End If
        Else ' If AMState = 2
          Debug "Case 4 Else <> AMState = 2"
          BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
        End If ' ActiveState = 2

    Case 6:
      HeroCountDown = HeroCountDown + 5
      AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
      if AMState = 2 Then
      Debug "In Scoop2 Case6: "&AMCombo
      li038.state=0 ' Turn off quest light  -- Not sure these are needed
          if MonstersCleared = 1 Then
            Mode(CurrentPlayer,6) = 3
            DungeonCleared
            ClearDMDGuide
            GeneralPuPQueue.Add "Pup733","PuPEvent 733",11,0,0,0,0,False
            if DMDType = 2 Then
              HideDMD 6000, True
            Else
              Pup2Helper 6000
            End If

            LoadWulf
            PuPHideBattle "Case 6 scoop2_hit"
            Debug "DUNGEON CLEARED "&AMCombo
            InnCleared = 0 ' Reset the Inn
            RegionMonster(CurrentPlayer,ActiveMode) = 0
            ResetMonsters ' Reset monster health
            li038.state = 0
            if PartySize(CurrentPlayer) < 4 Then li047.state = 2 ' inn flash
            if DungeonBonus = 1 Then addscore2 Score_DungeonBonus

          Else
            BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
            Debug "Monsters still in Dungeon "&AMCombo
          End If
        Else ' If AMState = 2
          Debug "Case 6 Else"
          BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
        End If ' ActiveState = 2

    Case 8:
      HeroCountDown = HeroCountDown + 5
      AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
      if AMState = 2 Then
      Debug "In Scoop2 Case8: "&AMCombo
      li038.state=0 ' Turn off quest light  -- Not sure these are needed
          if MonstersCleared = 1 Then
            Mode(CurrentPlayer,8) = 3
            ClearDMDGuide
            GeneralPuPQueue.Add "Pup734","PuPEvent 734",11,0,0,0,0,False
            DungeonCleared
            if DMDType = 2 Then
              HideDMD 6000, True
            Else
              Pup2Helper 6000
            End If

            LoadSwinePrince
            PuPHideBattle "Case 8 scoop2_hit"
            Debug "DUNGEON CLEARED "&AMCombo
            InnCleared = 0 ' Reset the Inn
            RegionMonster(CurrentPlayer,ActiveMode) = 0
            ResetMonsters ' Reset monster health
            li038.state = 0
            if PartySize(CurrentPlayer) < 4 Then li047.state = 2 ' inn flash

            if DungeonBonus = 1 Then addscore2 Score_DungeonBonus

          Else
            BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
            Debug "Monsters still in Dungeon "&AMCombo
          End If
        Else ' If AMState = 2
          Debug "Case 8 Else"
          BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
        End If ' ActiveState = 2

    Case 10,11,12,13:
      HeroCountDown = HeroCountDown + 5
      AudioQueue.Add "Playsound-Bell","Playsound ""Bell"" ",33,300,0,0,AudioExpiry,False
      if  bHoldBall = True And bHoldBallDelay = False Then
        BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
      End If
      if AMState = 2 Then
      HideHelper
      Triggerscript 5500, "HideHelper" ' call again to make sure its cleared
      Debug "In Scoop2 Case 10,11,12,13: "&AMCombo
          li038.state=0 ' Turn off quest light  -- Not sure these are needed
          if MonstersCleared = 1 Then
              If Mode(CurrentPlayer,0) = 10 Then
                Mode(CurrentPlayer,10) = 3
              ElseIf Mode(CurrentPlayer,0) = 11 Then
                Mode(CurrentPlayer,11) = 3
              ElseIf Mode(CurrentPlayer,0) = 12 Then
                Mode(CurrentPlayer,12) = 3
              ElseIf Mode(CurrentPlayer,0) = 13 Then
                Mode(CurrentPlayer,13) = 3
              ElseIf Mode(CurrentPlayer,0) = 14 Then
                Mode(CurrentPlayer,14) = 3
                Debug " Mode 14:3"
                WizardMode
              End if
            DungeonCleared
            InnCleared = 0 ' Reset the Inn
            Debug "DUNGEON CLEARED "&InnCleared
            RegionMonster(CurrentPlayer,ActiveMode) = 0
            ResetMonsters ' Reset monster health
            Triggerscript 3900, "pupevent 100"
            li038.state = 0
            ClearDMDGuide

              if ActiveMode < 14 Then   ' Want to prevent having to hit the Inn again
                if PartySize(CurrentPlayer) < 4 Then
                  Mode(CurrentPlayer,0) = 0  ' Reset to Village
                  li047.state = 2 ' inn flash
                Else
                  bBossDefeatedFullParty = True ' set this flag to prevent continue mode since party is full
                  li038.state = 2 ' party is full so turn on quest light
                  if Mode(Currentplayer,2) < 2 Then
                    Mode(CurrentPlayer,0) = 1
                    Mode(Currentplayer,1) = 2
                  Elseif Mode(Currentplayer,4) < 2 Then
                    Mode(CurrentPlayer,0) = 3
                    Mode(Currentplayer,3) = 2
                  Elseif Mode(Currentplayer,6) < 2 Then
                    Mode(CurrentPlayer,0) = 5
                    Mode(Currentplayer,5) = 2
                  Elseif Mode(Currentplayer,8) < 2 Then
                    Mode(CurrentPlayer,0) = 7
                    Mode(Currentplayer,7) = 2
                  Else
                    li038.state = 0 ' party is full so turn on quest light
                    StartMode 9
                  End If
                  ''Mode(CurrentPlayer,0) = 0  ' Reset to Village
                  'AssemblePartyRuins
                  'bBossDefeatedFullParty = True ' set this flag to prevent continue mode since party is full
                End If
                SetModeTitle
              End If
              BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
            if DungeonBonus = 1 Then addscore2 Score_DungeonBonus
          Else
            Debug "Monsters still in Dungeon "&AMCombo
          End If
        Else ' If AMState = 2
          BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
        End If ' ActiveState = 2

    Case 14:
      if AMState = 2 Then
        Mode(CurrentPlayer,14) = 3
        Debug " Mode 14:3"
        WizardMode
      End If
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True
    Case 15:
      if bSuperJackpotReady = True Then
        AudioQueue.Add "Pup271","PuPEvent 271",35,0,0,0,AudioExpiry,True
        AddScore2 Score_CryptSuperJackpot * CryptRound
        if CryptRound < 3 Then CryptRound = CryptRound + 1 ' MAX value is 3 times
        SetCryptLights2
        bSuperJackpotReady = False
      End If
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True

    Case 1:
      if AMState = 0 Then Debug "HOW DID I GET HERE!!!"
      if AMState = 1 Then
        BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True:additem
        if PartySize(CurrentPlayer) < 4 Then
          PreviewNextChar
        End If
      End If
      if AMState = 2 Then ' Party was assembled so we can start the battle
        TrapdoorDown  ' close the multiball trapdoor
        Debug "ENTERING DUNGEON "&AMCombo
        ClearGuideMessages
        Debug "Calling Start Battle Mode"
        'StartBattleMode
        if bRetry = False Then
          PickDungeon
        Else
          AdvanceMode ActiveMode
        End If
      End If

    Case 3:
      if AMState = 1 Then
        BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True:additem
        if PartySize(CurrentPlayer) < 4 Then
          PreviewNextChar
        End If
      End If
      if AMState = 2 Then ' Party was assembled so we can start the battle
        TrapdoorDown  ' close the multiball trapdoor
        Debug "ENTERING DUNGEON "&AMCombo
        ClearGuideMessages
        Debug "Calling Start Battle Mode"
        'StartBattleMode
        if bRetry = False Then
          PickDungeon
        Else
          AdvanceMode ActiveMode
        End If
      End If

    Case 5
      if AMState = 1 Then
        BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True:additem
        if PartySize(CurrentPlayer) < 4 Then
          PreviewNextChar
        End If
      End If
      if AMState = 2 Then ' Party was assembled so we can start the battle
        TrapdoorDown  ' close the multiball trapdoor
        Debug "ENTERING DUNGEON "&AMCombo
        ClearGuideMessages
        Debug "Calling Start Battle Mode"
        'StartBattleMode
        if bRetry = False Then
          PickDungeon
        Else
          AdvanceMode ActiveMode
        End If
      End If

    Case 7:
      if AMState = 1 Then
        BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True:additem
        if PartySize(CurrentPlayer) < 4 Then
          PreviewNextChar
        End If
      End If
      if AMState = 2 Then ' Party was assembled so we can start the battle
        TrapdoorDown  ' close the multiball trapdoor
        Debug "ENTERING DUNGEON "&AMCombo
        ClearGuideMessages
        Debug "Calling Start Battle Mode"
        'StartBattleMode
        if bRetry = False Then
          PickDungeon
        Else
          AdvanceMode ActiveMode
        End If
      End If

    Case Else:
      Debug "Scoop2 KICK Out Called - Case Else "
      BallHandlingQueue.Add "KickOut","KickBallOut",70,KickOutDelay,0,0,0,True

  End Select


Debug "Leaving Scoop2"
  Switch_Hit "scoop2"
End Sub

Sub DisplayHelper
  PuPlayer.LabelSet pBackglass,"Scoop2Helper",HelperMessage,1,""
End Sub

Sub DisplayHelper2
  PuPlayer.LabelSet pBackglass,"Scoop2Helper","Press Either Flipper to Continue",1,""
End Sub

Sub HideHelper
  'Debug "Called Hidehelper"
  PuPlayer.LabelSet pBackglass,"Scoop2Helper","",0,""
End Sub

sub HideKeyAward
  PuPlayer.LabelSet pBackglass,"KeyAward","",0,""
End Sub

Sub StartBattleMode
  'GetAM
  'StartDTs
  'AdvanceMode (ActiveMode)
End Sub


Dim Switch_Time(50)
Sub Switch_Hit(swi)

  LastSwitch.enabled = False
  LastSwitch.enabled = True
  LastSwitchHit = swi
  Select Case swi
    case "lramp" : Switch_Time(1) = gametime + 4000 ' 4000 = 3 seconds
    case "rramp" : Switch_Time(2) = gametime + 4000  'can be changed
    case "scoop2" : Switch_Time(3) = gametime + 500
    case "Lrampcombo" : Switch_Time(4) = gametime + 6000
    case "Rrampcombo" : Switch_Time(5) = gametime + 6000
    case "leftorbit"  : Switch_Time(6) = gametime + 3000
    case "rightorbit" : Switch_Time(7) = gametime + 3000
    case "leftorbitinside"  : Switch_Time(8) = gametime + 3000

  End Select
End Sub

Sub Reset_Switch(swi)
  Select Case swi
    case "lramp" : Switch_Time(1) = 0
    case "rramp" : Switch_Time(2) = 0
    case "scoop2" : Switch_Time(3) = 0
    case "Lrampcombo" : Switch_Time(4) = 0
    case "Rrampcombo" : Switch_Time(5) = 0
    case "leftorbit"  : Switch_Time(6) = 0
    case "rightorbit" : Switch_Time(7) = 0
    case "leftorbitinside"  : Switch_Time(8) = 0

  End Select
End Sub

Function Test_Switch(swi)
  Test_Switch = 0
  Select Case swi
    case "lramp" : If Switch_Time(1) > gametime Then Test_Switch = 1
    case "rramp" : If Switch_Time(2) > gametime Then Test_Switch = 1
    case "scoop2" : If Switch_Time(3) > gametime Then Test_Switch = 1
    case "Lrampcombo" : If Switch_Time(4) > gametime Then Test_Switch = 1
    case "Rrampcombo" : If Switch_Time(5) > gametime Then Test_Switch = 1
    case "leftorbit" : If Switch_Time(6) > gametime Then Test_Switch = 1
    case "rightorbit" : If Switch_Time(7) > gametime Then Test_Switch = 1
    case "leftorbitinside" : If Switch_Time(8) > gametime Then Test_Switch = 1

  End Select
End Function


Sub LastSwitch_Timer
  LastSwitch.enabled = False
  LastSwitchhit = ""
End Sub



Sub ResetRampLights

End Sub

Sub ResetMonsterLights
'Monsters
  li006.state=0
  li008.state=0
  li024.state=0
  li025.state=0
End Sub

Sub HeroTimerReset
  HeroCountDownTimer.Enabled = 0
  pulse.enabled = 0
  HeroCountDownReset
  HeroCountDownTimer.Enabled = 1
  pulse.enabled = 1


End Sub

Sub herotimer_timer
  Debug "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
  Debug "*************************"
  Debug "Calling Remove Party from Hero Timer "& HeroCountDown
  Debug "*************************"
  Debug "%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%"
  RemovePartyMember
End Sub

Sub Pulse_Timer()
' Debug "In pulse timer: " & pulse.interval
' Debug "Torch Value: " & TLV
  ' .05 - .2 is the range
  PlaySound "HBMP3", 1, HeartVolume ' Backglass
  PlaySound "HB-6DB", 1, HeartVolume ' Table
End Sub

Sub HeroCountDownTimer_Timer
' Debug " Hero Value: " & HeroCountDown
  HeroCountDown = HeroCountDown - 1
  HeartVolume = (25 - HeroCountDown)*.007

  if HeroCountdown > 20 Then
    HeartVolume = HeartVolume * 4.25
    pulse.interval = 1000
    pulse.enabled = 0
    pulse.enabled = 1
  elseif HeroCountdown < 5 Then
    HeartVolume = HeartVolume * 5.5
    pulse.interval = 460
    pulse.enabled = 0
    pulse.enabled = 1
  elseif HeroCountdown < 10 Then
    HeartVolume = HeartVolume * 5.25
    pulse.interval = 580
    pulse.enabled = 0
    pulse.enabled = 1
  elseif HeroCountdown < 15 Then
    HeartVolume = HeartVolume * 5
    pulse.interval = 700
    pulse.enabled = 0
    pulse.enabled = 1
  elseif HeroCountdown < 21 Then
    HeartVolume = HeartVolume * 4.65
    pulse.interval = 800
    pulse.enabled = 0
    pulse.enabled = 1
  End If

  'DisplayDungeonProgress


  if inVideo = 0 Then
    PuPlayer.LabelSet pBackglass,"HeartMeter", HeroCountDown,1,""
  End If



  if HeroCountDown <= 0 Then
    Debug "Hero Died"

    if partysize(CurrentPlayer) > 0 Then
      RemovePartyMember
      HeroCountDownReset
    Else
      HeroCountdownTimer.enabled = 0
    End If
    if Mode(CurrentPlayer,12) = 1 Then
      Debug " Expired Wulf Timer"
      LowerAllDTs
      ChaseWulf
    End If
  End If


End Sub

Sub HeroCountDownReset
' Debug "In HCDR "& HeroCountDown &":" & HeroCountDownMax
  HeroCountDown = HeroCountDownMax

  'HeroTimer.interval = HeroCountDown*1000
  'HeroTimer.Enabled = 0
  'HeroTimer.Enabled = 1
End Sub

Sub HeroCountDownOriginal
' Debug "In HCD Original " & HeroCountDownMax &":" & OriginalHeroCountDown
HeroCountDownMax = OriginalHeroCountDown
End Sub

Sub CheckDungeonLights
  if Mode(CurrentPlayer,2) = 3 then
    li045.state = 1
  Else
    li045.state = 0
  End If
  if Mode(CurrentPlayer,4) = 3 then
    li030.state = 1
  Else
    li030.state = 0
  End If
  if Mode(CurrentPlayer,6) = 3 then
    li031.state = 1
  Else
    li031.state = 0
  End If
  if Mode(CurrentPlayer,8) = 3 then
    li026.state = 1
  Else
    li026.state = 0
  End If
End Sub


'************************************************
' PUP HELPER ROUTINES
'************************************************
Sub CheckIconColors(calledby)
Debug "CheckIconColors: " &calledby

Dim m

  For m = 0 to 7
    if Party(CurrentPlayer,m) = 1 Then
      DisplayCharIcons m, "checkiconcoolors"
'     SetColorIcons m, 0 ' Make them color they are ALIVE !!!!
    Else
'     SetColorIcons m, 1 ' Make them grayed out
      HideCharIcons m
    End If
  Next

End Sub
'------------------------------------------------------------------------------------------
Sub CheckItemColors(calledby)
'Debug "CheckItemColors: " &calledby

Dim m

  For m = 0 to 4
    if ItemsRTP(CurrentPlayer,m) = 1 Then
      DisplayItems m
      'Debug " Should be making Item "&m &" color"
'     SetColorItems m, 0 ' Make them color
    Else
' Debug " Should be making Item "&m &" grey"
'     SetColorItems m, 1 ' Make them grayed out
      HideItems m
    End If
  Next

End Sub
'------------------------------------------------------------------------------------------
sub SetColorIcons(Character,Clr)
'Debug "Char and Clr: "&Character &" " &Clr
Dim Char, Col
Char = Character
Col = Clr

  if Char = 0 Then
    'pBackglassLabelSetGrayScale "highwayman",Col
    pBackglassLabelVisible "highwayman",1
  elseif Char = 1 Then
    'pBackglassLabelSetGrayScale "jester",
    pBackglassLabelVisible "jester",1
  elseif Char = 2 Then
    'pBackglassLabelSetGrayScale "vestal",Col
    pBackglassLabelVisible "vestal",1
  elseif Char = 3 Then
    'pBackglassLabelSetGrayScale "plague",Col
    pBackglassLabelVisible "plague",1
  elseif Char = 4 Then
    'pBackglassLabelSetGrayScale "occultist",Col
    pBackglassLabelVisible "occultist",1
  elseif Char = 5 Then
    'pBackglassLabelSetGrayScale "crusader",Col
    pBackglassLabelVisible "crusader",1
  elseif Char= 10 Then
    'pBackglassLabelSetGrayScale "highwayman",Col
    'pBackglassLabelSetGrayScale "jester",Col
    'pBackglassLabelSetGrayScale "vestal",Col
    'pBackglassLabelSetGrayScale "plague",Col
    'pBackglassLabelSetGrayScale "occultist",col
    'pBackglassLabelSetGrayScale "crusader",Col

  End If
End Sub

Sub DisplayCharIcons(Char,calledby)
'Debug "DisplayCharIcons calledby: " &calledby
if  bSupressBGMessages = False Then
  if Char = 0 Then
    pBackglasslabelshow "grave"
  elseif Char = 1 Then
    pBackglasslabelshow "highwayman"
  elseif Char = 2 Then
    pBackglasslabelshow "jester"
  elseif Char = 3 Then
    pBackglasslabelshow "vestal"
  elseif Char = 4 Then
    pBackglasslabelshow "plague"
  elseif Char = 5 Then
    pBackglasslabelshow "occultist"
  elseif Char = 6 Then
    pBackglasslabelshow "crusader"
  elseif Char = 7 Then
    pBackglasslabelshow "hound"
  elseif Char= 10 Then
    pBackglasslabelshow "grave"
    pBackglasslabelshow "highwayman"
    pBackglasslabelshow "jester"
    pBackglasslabelshow "vestal"
    pBackglasslabelshow "plague"
    pBackglasslabelshow "occultist"
    pBackglasslabelshow "crusader"
    pBackglasslabelshow "hound"
  End If
End If
End Sub

Sub HideCharIcons(Char)
  if Char = 0 Then
    pBackglasslabelhide "grave"
  elseif Char = 1 Then
    pBackglasslabelhide "highwayman"
  elseif Char = 2 Then
    pBackglasslabelhide "jester"
  elseif Char = 3 Then
    pBackglasslabelhide "vestal"
  elseif Char = 4 Then
    pBackglasslabelhide "plague"
  elseif Char = 5 Then
    pBackglasslabelhide "occultist"
  elseif Char = 6 Then
    pBackglasslabelhide "crusader"
  elseif Char = 7 Then
    pBackglasslabelhide "hound"
  elseif Char= 10 Then
    pBackglasslabelhide "grave"
    pBackglasslabelhide "highwayman"
    pBackglasslabelhide "jester"
    pBackglasslabelhide "vestal"
    pBackglasslabelhide "plague"
    pBackglasslabelhide "occultist"
    pBackglasslabelhide "crusader"
    pBackglasslabelhide "hound"
  End If
End Sub
'--------------------------------------------------------------------------------------------------
sub setColorItems(Itm,Clr)
Dim Im, col
Im = Itm
col = Clr

  if Im = 0 Then
    'pBackglassLabelSetGrayScale "medicine",Col
    pBackglassLabelVisible "medicine"
  Elseif Im = 1 Then
    'pBackglassLabelSetGrayScale "bandage",Col
    pBackglassLabelVisible "bandage"
  Elseif Im = 2 Then
    'pBackglassLabelSetGrayScale "key",Col
    pBackglassLabelVisible "key"
  Elseif Im = 3 Then
    'pBackglassLabelSetGrayScale "shovel",Col
    pBackglassLabelVisible "shovel"
  Elseif Im = 4 Then
    'pBackglassLabelSetGrayScale "vial",Col
    pBackglassLabelVisible "vial"
  End If
End Sub

Sub DisplayItems(Im)
if  bSupressBGMessages = False Then
  if Im = 0 Then
    pBackglasslabelshow "medicine"
  Elseif Im = 1 Then
    pBackglasslabelshow "bandage"
  Elseif Im = 2 Then
    pBackglasslabelshow "key"
  Elseif Im = 3 Then
    pBackglasslabelshow "shovel"
  Elseif Im = 4 Then
    pBackglasslabelshow "vial"
  Elseif Im = 6 Then
    pBackglasslabelshow "vial"
    pBackglasslabelshow "medicine"
    pBackglasslabelshow "bandage"
    pBackglasslabelshow "key"
    pBackglasslabelshow "shovel"
  End If
End If
End Sub

Sub HideItems(Im)
  if Im = 0 Then
    pBackglasslabelhide "medicine"
  Elseif Im = 1 Then
    pBackglasslabelhide "bandage"
  Elseif Im = 2 Then
    pBackglasslabelhide "key"
  Elseif Im = 3 Then
    pBackglasslabelhide "shovel"
  Elseif Im = 4 Then
    pBackglasslabelhide "vial"
  End If
End Sub


Sub TorchCountdown_Timer()
  TorchTimerCount = TorchTimerCount - 1
  if TorchTimerCount < 1 Then
    InTheDarkFail
  Else
    'PuPlayer.LabelSet pBackglass,"TorchMeter", TorchTimerCount,1,"{'mt':2,'color':255, 'size':12, 'xpos': 50, 'xalign': 1, 'ypos': 10, 'yalign': 0 }"

    'PuPlayer.LabelNew pBackglass,"TorchHitsMessage",dmddef, 20,16711808,0,0,1,10,7.5,1,0
    'PuPlayer.LabelNew pBackglass,"TorchCountDownTimerOn",dmddef, 54,255,0,1,1,49.5,64,1,0
    PuPlayer.LabelSet pBackglass, "TorchHitsMessage" ,TorchMissionMessage,  1, "{'mt':2,'color':255, 'size':12, 'xpos': 50, 'xalign': 1, 'ypos': 10, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass, "TorchCountDownTimerOn" ,TorchTimerCount,  1, "{'mt':2,'color':255, 'size':28, 'xpos': 50, 'xalign': 1, 'ypos': 48, 'yalign': 0 }"
  End If
End Sub

Sub WinInTheDark
  DOFModesOff
  HideInTheDarkMessages
  bSupressBGMessages = False

  GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
  GeneralPupQueue.Add "Pup840","pupevent 840",95,0,0,0,0,True
  GeneralPupQueue.Add "EOBReturn-WITD","EOBReturn ""wininthedark"" ",95,5150,0,0,0,True
  AudioQueue.Add "Pup233","PuPEvent 233",20,5200,0,0,AudioExpiry,False
  GeneralPupQueue.Add "ReturnToVillage","ReturnToVillage",35,5250,0,0,0,False


  TorchCountdown.enabled = 0
  Missions(CurrentPlayer,3) = 3
  ScorbitBuildGameModes
  TorchCountdown.enabled = 0
  pDMDlabelshow "InTheDarkOn"
  if DMDType = 0 Then pBackglassLabelShow "InTheDarkOn"
  TMode = 2
  ClearTorchPup

  LoadLUT:SetLUT

  AddScore2 Score_InTheDarkWin
  UpdateDMD
  ResetUPF
End Sub



Sub ResetTorchLightColor
SetLightColor li054, white, -1
SetLightColor li055, white, -1
SetLightColor li056, white, -1
SetLightColor li019, white, -1
SetLightColor li020, white, -1
End Sub

Sub ChaseTorches
Randomize
  dim tmp
' tmp = RndNbr(5)
  tmp = rndZeroArrayCol1d(ChaseTorchesArray)
Debug "Chase Torches: " &tmp
ResetTorchLightColor
  Select Case tmp
    Case 0:
      if ChaseTorchesArray(0) = 0 Then
        li019.blinkinterval = 10
        SetLightColor li019, red,2
        'li019.state = 2
      Else
        Debug "CT: Should not get here"
        ChaseTorches
      End If
    Case 1:
      if ChaseTorchesArray(1) = 0 Then
        li020.blinkinterval = 10
        SetLightColor li020, red,2
        'li020.state = 2
      Else
        Debug "CT: Should not get here"
        ChaseTorches
      End If
    Case 2:
      if ChaseTorchesArray(2) = 0 Then
        li056.blinkinterval = 60
        SetLightColor li056, red,2
        'li056.state = 2
      Else
        Debug "CT: Should not get here"
        ChaseTorches
      End If
    Case 3:
      if ChaseTorchesArray(3) = 0 Then
        li054.blinkinterval = 60
        SetLightColor li054, red,2
        'li054.state = 2
      Else
        Debug "CT: Should not get here"
        ChaseTorches
      End If
    Case 4:
      if ChaseTorchesArray(4) = 0 Then
        li055.blinkinterval = 60
        SetLightColor li055, red,2
        'li055.state = 2
      Else
        Debug "CT: Should not get here"
        ChaseTorches
      End If
  End Select


End Sub


Sub DisableTorchLights


Dim i
   For i = 0 to 5
    ChaseTorchesArray(i) = 0
  Next

li019.state = 0
li020.state = 0
li056.state = 0
li054.state = 0
li055.state = 0
End Sub

Sub CheckTorchesWin
Debug "****************************"
Debug "CTW0: " &ChaseTorchesArray(0)
Debug "CTW1: " &ChaseTorchesArray(1)
Debug "CTW2: " &ChaseTorchesArray(2)
Debug "CTW3: " &ChaseTorchesArray(3)
Debug "CTW4: " &ChaseTorchesArray(4)
Debug "****************************"

LightEffect 2
DarknessLayer.Opacity = DarknessLayer.Opacity - 3
Playsound "fireball-whoosh"

  if ChaseTorchesArray(0) = 1 AND ChaseTorchesArray(1) = 1 AND ChaseTorchesArray(2) = 1 AND ChaseTorchesArray(3) = 1 AND ChaseTorchesArray(4) = 1 Then
    InTheDarkReset
    TorchCountdown.Enabled = 0
    WinTorches
  Else
    InTheDarkReset
    BallHandlingQueue.Add "ChaseTorches","ChaseTorches",80,500,0,0,0,False
    'triggerscript 500, "ChaseTorches"
  End If
End Sub

Sub WinTorches
  ClearTorchPup
  TorchesEnabled = 0
  DarknessLayer.Opacity = DefaultDarkness

  TorchTimerCountMax = 40
  InTheDarkReset

  li061.state = 0  ' 126.0 changed from 2 to 0
  li062.state = 0
  li063.state = 0
  li064.state = 0

  InBattle = 0
  ModeTitle = "In The Dark 2"
  UpdateModeLabels


  Missions(CurrentPlayer,3) = 2
  InTheDark2


  li038.state=0 ' Turn off Quest Light
  li047.state=0 ' inn light not blinking anymore
  li036.state=0 'leftramp
  li040.state=0  'rightramp
  li051.state=0 'orbits off
  li060.state=0
  li037.state=0
  DisableBallLock
End Sub


Sub CheckTorchCount
'Start side mission
  if TorchHits(CurrentPlayer) > TorchReq - 1 Then
    InTheDark
  End If
End sub

Sub InTheDark
  Tmode = 1
  bSupressBGMessages = True
  GetAM
  if ActiveMode <> 0 Then
    TorchHits(CurrentPlayer) = TorchReq-1
    Exit Sub
  End If
  FlickerOn = False
    DOF 259, DOFOn
  TorchMissionMessage = "Hit The Red Lit Torch"
  ModeTitle = "In The Dark"
  'EOBHide "inthedark" '
  GeneralPupQueue.Add "EOBHide-ITD","EOBHide ""inthedark"" ",41,0,0,0,0,True
  GeneralPupQueue.Add "PuP300","PuPEvent 300 ",21,75,0,0,0,False
  AudioQueue.Add "Pup299","PuPEvent 299",93,100,0,0,0,False ' Event Start audio
  GeneralPupQueue.Add "Pup834","pupevent 834",40,150,0,0,0,True
  AudioQueue.Add "Pup434","PuPEvent 434",30,8100,0,0,0,False
  UpdateModeLabels
  TorchTimerCountMax = 30
  TorchesEnabled = 0
  ResetLights
  li038.state=0 ' Turn off Quest Light
  li047.state=0 ' inn light flash
  DisableTorchLights
  ResetLaneLights

  TorchHits(CurrentPlayer) = TorchReq
  Missions(CurrentPlayer,3) = 1
  DarknessLayer.Opacity = 98

  TorchCountdown.Interval = 1000
  InTheDarkReset
  ChaseTorches
  'ScorbitBuildGameModes
End Sub

Sub InTheDark2
  ResetTorchLightColor
  DOFModesOff
  OldGI = "red"
  ChangeGi Red
  TorchMissionMessage = "Destroy Upper Playfield Targets"
  RegionMonster(CurrentPlayer,Region) = 0
  TotalMonsterHits = 8
  'DisplayDungeonProgress
  setUPFLightColorGreen
End Sub

Sub InTheDarkAudio
  AudioQueue.Add "Pup434","PuPEvent 434",30,0,0,0,0,False
End Sub

Sub InTheDarkReset
' stop and restart the timer
  Debug "ITD Reset"
  TorchTimerCount = TorchTimerCountMax
  TorchCountdown.Enabled = 0
  TorchCountdown.Enabled = 1
  DarknessLayer.Opacity = DarknessLayer.Opacity - 5

End Sub



'***********
' ZTORCH - Torches
'***********
Sub liup1_Hit
    DOF 218, DOFPulse
    If Tilted Then Exit Sub
  liup1.timerenabled = 0: liup1.timerenabled = 1
' Debug "Torch1 Hit: "&li019.intensity

    'PlayLightning
    'ZeusF
  if GMode <> 1 And BSMode <> 1 Then
    if Missions(CurrentPlayer,3) = 1 And li019.state = 2 Then
      li019.state = 1
      ChaseTorchesArray(0) = 1
      CheckTorchesWin
    Elseif Missions(CurrentPlayer,3) <> 1 Then
      li019.state=2
      'triggerscript 2000, "li019.state = 1"
      'li019.intensity = 100
      TorchLevel(0) = 100
      Addscore Score_Torch '10000
      LightEffect 2
      Playsound "fireball-whoosh"
    End If

    if Mode(CurrentPlayer,0) = 0 AND TorchHits(CurrentPlayer) < TorchReq Then
      TorchHits(CurrentPlayer) = TorchHits(CurrentPlayer)+1
      DisplayTorchCount
      CheckTorchCount
      if DMDType = 0 Then
        pBackglassLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pBackglasslabelhide-ITD1","pBackglassLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      Else
        pDMDLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pDMDlabelhide-ITD1","pDMDLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      End If
    End If
  End If
    Switch_Hit "liup1"
End Sub


Sub liup2_Hit
    DOF 219, DOFPulse
    If Tilted Then Exit Sub
  liup2.timerenabled = 0: liup2.timerenabled = 1
' Debug "Torch2 Hit: "&li020.intensity
    'PlayLightning
    'ZeusF
  if GMode <> 1 And BSMode <> 1 Then
    if Missions(CurrentPlayer,3) = 1 And li020.state = 2 Then
      li020.state = 1
      ChaseTorchesArray(1) = 1
      CheckTorchesWin
    Elseif Missions(CurrentPlayer,3) <> 1 Then
      li020.state=2
      'triggerscript 2000, "li020.state = 1"
      'li020.intensity = 100
      TorchLevel(1) = 100
      Addscore Score_Torch '10000
      LightEffect 2
      Playsound "fireball-whoosh"
    End If

    if Mode(CurrentPlayer,0) = 0 AND TorchHits(CurrentPlayer) < TorchReq Then
      TorchHits(CurrentPlayer) = TorchHits(CurrentPlayer)+1
      DisplayTorchCount
      CheckTorchCount
      if DMDType = 0 Then
        pBackglassLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pBackglasslabelhide-ITD2","pBackglassLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      Else
        pDMDLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pDMDlabelhide-ITD2","pDMDLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      End If
    End If
  End If
    Switch_Hit "liup2"
End Sub


Sub liup3_Hit
    DOF 220, DOFPulse
    If Tilted Then Exit Sub
  liup3.timerenabled = 0: liup3.timerenabled = 1
' Debug "Torch3 Hit: "&li056.intensity
    'PlayLightning
    'ZeusF
  if GMode <> 1 And BSMode <> 1 Then
    if Missions(CurrentPlayer,3) = 1 And li056.state = 2 Then
      li056.state = 1
      ChaseTorchesArray(2) = 1
      CheckTorchesWin
    Elseif Missions(CurrentPlayer,3) <> 1 Then
      li056.state=2
      'triggerscript 2000, "li056.state = 1"
      'li056.intensity = 100
      TorchLevel(2) = 100
      Addscore Score_Torch '10000
      LightEffect 2
      Playsound "fireball-whoosh"
    End If

    if Mode(CurrentPlayer,0) = 0 AND TorchHits(CurrentPlayer) < TorchReq Then
      TorchHits(CurrentPlayer) = TorchHits(CurrentPlayer)+1
      DisplayTorchCount
      CheckTorchCount
      if DMDType = 0 Then
        pBackglassLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pBackglasslabelhide-ITD3","pBackglassLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      Else
        pDMDLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pDMDlabelhide-ITD3","pDMDLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      End If
    End If
  End If
    Switch_Hit "liup3"
End Sub


Sub liup4_Hit
    DOF 221, DOFPulse
    If Tilted Then Exit Sub
  liup4.timerenabled = 0: liup4.timerenabled = 1
' Debug "Torch4 Hit: "&li054.intensity
    'PlayLightning
    'ZeusF
  if GMode <> 1 And BSMode <> 1 Then
    if Missions(CurrentPlayer,3) = 1 And li054.state = 2 Then
      li054.state = 1
      ChaseTorchesArray(3) = 1
      CheckTorchesWin
    Elseif Missions(CurrentPlayer,3) <> 1 Then
      li054.state=2
      'triggerscript 2000, "li054.state = 1"
      'li054.intensity = 100
      TorchLevel(3) = 100
      Addscore Score_Torch '10000
      LightEffect 2
      Playsound "fireball-whoosh"
    End If

    if Mode(CurrentPlayer,0) = 0 AND TorchHits(CurrentPlayer) < TorchReq Then
      TorchHits(CurrentPlayer) = TorchHits(CurrentPlayer)+1
      DisplayTorchCount
      CheckTorchCount
      if DMDType = 0 Then
        pBackglassLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pBackglasslabelhide-ITD4","pBackglassLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      Else
        pDMDLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pDMDlabelhide-ITD4","pDMDLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      End If
    End If
  End If
    Switch_Hit "liup4"
End Sub


Sub liup5_Hit
    DOF 222, DOFPulse
    If Tilted Then Exit Sub
  liup5.timerenabled = 0: liup5.timerenabled = 1
' Debug "Torch5 Hit: "&li055.intensity
    'PlayLightning
    'ZeusF
  if GMode <> 1 And BSMode <> 1 Then
    if Missions(CurrentPlayer,3) = 1 And li055.state = 2 Then
      li055.state = 1
      ChaseTorchesArray(4) = 1
      CheckTorchesWin
    Elseif Missions(CurrentPlayer,3) <> 1 Then
      li055.state=2
      'triggerscript 2000, "li055.state = 1"
      'li055.intensity = 100
      TorchLevel(4) = 100
      Addscore Score_Torch '10000
      LightEffect 2
      Playsound "fireball-whoosh"
    End If

    if Mode(CurrentPlayer,0) = 0 AND TorchHits(CurrentPlayer) < TorchReq Then
      TorchHits(CurrentPlayer) = TorchHits(CurrentPlayer)+1
      DisplayTorchCount
      CheckTorchCount
      if DMDType = 0 Then
        pBackglassLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pBackglasslabelhide-ITD5","pBackglassLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      Else
        pDMDLabelShow "InTheDarkOn"
        GeneralPuPQueue.Add "pDMDlabelhide-ITD5","pDMDLabelHide ""InTheDarkOn"" ",35,1500,0,0,0,False
      End If
    End If
  End If
    Switch_Hit "liup5"
End Sub

Sub torchtimer_Timer ' always running

' If li019.intensity>0.25 Then li019.intensity = li019.intensity - 0.25
' If li020.intensity>0.25 Then li020.intensity = li020.intensity - 0.25
' If li056.intensity>0.25 Then li056.intensity = li056.intensity - 0.25
' If li055.intensity>0.25 Then li055.intensity = li055.intensity - 0.25
' If li054.intensity>0.25 Then li054.intensity = li054.intensity - 0.25

  If TorchLevel(0)>0.25 Then TorchLevel(0) = TorchLevel(0) - 0.25
  If TorchLevel(1)>0.25 Then TorchLevel(1) = TorchLevel(1) - 0.25
  If TorchLevel(2)>0.25 Then TorchLevel(2) = TorchLevel(2) - 0.25
  If TorchLevel(3)>0.25 Then TorchLevel(3) = TorchLevel(3) - 0.25
  If TorchLevel(4)>0.25 Then TorchLevel(4) = TorchLevel(4) - 0.25


  ' fix gi update when in modes
End Sub


'==============================================================
Sub CheckTorches
'Exit Sub

if TorchesEnabled Then
  'TLV = li019.intensity + li020.intensity + li054.intensity + li055.intensity + li056.intensity
  TLV = TorchLevel(0) + TorchLevel(1) + TorchLevel(2) + TorchLevel(3) + TorchLevel(4)

'Debug "Torch Values: "&li019.intensity &":"&li020.intensity &":"&li054.intensity &":"&li055.intensity &":"&li056.intensity &":"


PlayfieldMultiplier(CurrentPlayer) = 1   ' Reset to 1

  if TLV > 450 Then
    gi052.state = 0
    FlickerOn = False
    DarknessLayer.Opacity = DefaultDarkness

    GlowIntensity = 5 + GlowMod
    PlayfieldMultiplier(CurrentPlayer) = 1.1
  Elseif TLV > 400 Then
    gi052.state = 0
    FlickerOn = False
    GlowIntensity = 5 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 50
      End If

  Elseif TLV > 350 Then
    gi052.state = 0
    FlickerOn = False
    GlowIntensity = 10 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 75
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.2
  Elseif TLV > 325 Then
    gi052.state = 0
    FlickerOn = True
    GlowIntensity = 10 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 80
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.3
  Elseif TLV > 300 Then
    gi052.state = 0
    FlickerOn = True
    GlowIntensity = 16 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 85
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.4
  Elseif TLV > 275 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 16 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 90
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.5
  Elseif TLV > 250 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 20 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 91
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.6
  Elseif TLV > 225 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 20 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 92
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.7
  Elseif TLV > 200 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 30 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 93
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.8
  Elseif TLV > 175 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 30 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 94
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.8
  Elseif TLV > 150 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 30 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 95
      End If

    PlayfieldMultiplier(CurrentPlayer) = 1.9
  Elseif TLV > 125 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 32 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 96
      End If

    PlayfieldMultiplier(CurrentPlayer) = 2.0
  Elseif TLV > 100 Then
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 32+ GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 96
      End If

    PlayfieldMultiplier(CurrentPlayer) = 2.25
  Elseif TLV > 75 Then
    AudioQueue.Add "Pup269", "PuPEvent 269",32,0,0,0,AudioExpiry,False
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 35 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 97
      End If

    PlayfieldMultiplier(CurrentPlayer) = 2.5
  Elseif TLV > 50 Then
    AudioQueue.Add "Pup269", "PuPEvent 269",32,0,0,0,AudioExpiry,False
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 40 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 98
      End If

    PlayfieldMultiplier(CurrentPlayer) = 2.75
  Else
    AudioQueue.Add "Pup269", "PuPEvent 269",32,0,0,0,AudioExpiry,False
    gi052.state = 1
    FlickerOn = True
    GlowIntensity = 40 + GlowMod
      if MaxDarkness < darknesslayer.opacity Then
        darknesslayer.opacity = MaxDarkness
      Else
        darknesslayer.opacity = 98
      End If

    PlayfieldMultiplier(CurrentPlayer) = 3
  end If
gi052.intensity = 1.5*darknesslayer.opacity ' light used to make it easier to see flippers
End If ' if torchesenabled
End sub
'==============================================================
sub ResetTorches
  li019.intensity = 100
  li020.intensity = 100
  li056.intensity = 100
  li055.intensity = 100
  li054.intensity = 100
  TorchLevel(0)= 100
  TorchLevel(1)= 100
  TorchLevel(2)= 100
  TorchLevel(3)= 100
  TorchLevel(4)= 100
End Sub
'==============================================================
'***********
' ZKICKB - Kick back
'***********

Sub DarkD_Hit
  'pupevent 820
    If Tilted Then Exit Sub
  If DarkLights(1)=1 Then
    'AddScore score_dark_hit   ' score if already lit
  Else
    Addscore Score_DarkTarget
    DarkLights(1) = 1
    if li015.state = 0 then li015.state = 1:DOF 223, DOFPulse
    CheckKickback
    GeneralPupQueue.Add "Pup820","pupevent 820",20,0,0,0,GenPuPExpiry,False
    ReturnOverlay "darkD" ' Needed for some odd reason overlay disappears
    Playsound "sf_DARK"
  End If
  Switch_Hit "DarkD"
End Sub


Sub DarkA_Hit
    If Tilted Then Exit Sub
  'BlinkDARK
  'PuPEvent 823
  If DarkLights(2)=1 Then
    'AddScore score_dark_hit  ' score if already lit
  Else
    Addscore Score_DarkTarget
    DarkLights(2) = 1
    if li016.state = 0 then li016.state = 1:DOF 224, DOFPulse
    CheckKickback
    GeneralPupQueue.Add "Pup821","pupevent 821",20,0,0,0,GenPuPExpiry,False
    ReturnOverlay "darkA"  ' Needed for some odd reason overlay disappears
    Playsound "sf_DARK"
  End If
  Switch_Hit "DarkA"
End Sub


Sub DarkR_Hit
    If Tilted Then Exit Sub
  If DarkLights(3) = 1 Then
    'AddScore score_dark_hit  ' score if already lit
  Else
    Addscore Score_DarkTarget
    DarkLights(3)=1
    if li018.state = 0 then li018.state = 1:DOF 225, DOFPulse
    CheckKickback
    GeneralPupQueue.Add "Pup822","pupevent 822",20,0,0,0,GenPuPExpiry,False
    ReturnOverlay "darkR" ' Needed for some odd reason overlay disappears
    Playsound "sf_DARK"
  End If
  Switch_Hit "DarkR"
End Sub


Sub DarkK_Hit
    If Tilted Then Exit Sub
  If DarkLights(4) = 1 Then
    'AddScore score_dark_hit  ' score if already lit
  Else
    Addscore Score_DarkTarget
    DarkLights(4)=1
    if li017.state = 0 then li017.state = 1:DOF 226, DOFPulse
    CheckKickback
    GeneralPupQueue.Add "Pup823","pupevent 823",20,0,0,0,GenPuPExpiry,False
    ReturnOverlay "darkK" ' Needed for some odd reason overlay disappears
    Playsound "sf_DARK"
  End If
  Switch_Hit "DarkK"
End Sub

Sub CreateDarkString
Dim f
  DarkString = ""
        For f = 1 to 4
      DarkString = DarkString &DarkLights(f)
    Next

  'Debug "Dark String: "&DarkString
' PuPlayer.LabelSet pBackglass,"DarkString","DARK " &DarkString,1,"{'mt':2,'color':65535, 'size': 3, 'xpos': 88.0, 'xalign': 0, 'ypos': 68.1, 'yalign': 0 }"
End Sub
'==============================================================
Sub CheckKickback
  If DarkLights(1)+DarkLights(2)+DarkLights(3)+DarkLights(4) = 4 And KBActive = 0 Then
    GeneralPupQueue.Add "Pup824","pupevent 824",25,0,0,0,GenPuPExpiry,True
        LMF:LBF:RMF:RBF
    KickbackActive
    Debug " Kickbacks activated"
'        DMD "_", CL("KICKBACK IS KIT"), "", eNone, eNone, eNone, 1500, True, "vo_kickbackislit"
        PlaySoundAt "fx_diverter", gatekf  ' Left kickback
        gatekf.RotateToEnd
        PlaySoundAt "fx_diverter", gatekg 'Right kickback
        gatekg.RotateToEnd
    AddScore Score_KickbackLit
  End If
End Sub

Sub SetKickBackLights
 if DarkLights(1) = 1 Then li015.state = 1
 if DarkLights(2) = 1 Then li016.state = 1
 if DarkLights(3) = 1 Then li017.state = 1
 if DarkLights(4) = 1 Then li018.state = 1
End Sub

Sub KickbackActive
  AudioQueue.Add "Pup231","PuPEvent 231",25,500,0,0,AudioExpiry,False ' kickback activated
  KBActive = 1  ' used by applyknight routine
  KickbackMessages

  li015.state = 1
  li016.state = 1
  li017.state = 1
  li018.state = 1
End Sub

Sub KickbackMessages
  if bSupressBGMessages = False And KBActive = 1 And DebugKB = 0 Then
    if TMode <> 1 And GMode <> 1 Then
      pBackglassLabelHide "Wanted"
      pBackglassPNGAnimate "kickbackGIF", 60
    End If
    'PuPlayer.LabelSet pBackglass,"KickBackStatus","KICKBACK",1,""
    'PuPlayer.LabelSet pBackglass,"KickBackStatus2","ACTIVE",1,""
  Else
    BallHandlingQueue.Add "KickbackMessages","KickbackMessages",20,6000,0,0,0,False
    'triggerscript 6000, "KickbackMessages " ' try again in 6 seconds
  End If
End Sub


Sub BlinkDARK
    DOF 227, DOFPulse
  FlashForms li015, 1000, 50, DarkLights(1)
  FlashForms li016, 1000, 50, DarkLights(2)
  FlashForms li018, 1000, 50, DarkLights(3)
  FlashForms li017, 1000, 50, DarkLights(4)
End Sub


Sub Kickback_Hit
' PuPlayer.LabelSet pBackglass,"KickBackStatus","",0,""
' PuPlayer.LabelSet pBackglass,"KickBackStatus2","",0,""
  pBackglassHideAnimate "kickbackGIF"
  pbackglasslabelshow "Wanted"
    PlaySoundAt "VUKEnter", Kickback
    DOF 116, DOFPulse
    TriggerScript 500, "DOF 110, DOFPulse:PlaySoundAt SoundFX(""Popper"",DOFContactors),Kickback:kickback.kick 0,45"
    TriggerScript 1000, "PlaySoundAt""fx_diverter"", gatekf:leftoutlane.Enabled =1:gatekf.RotateToStart"
  li015.state = 0
  li016.state = 0
  li017.state = 0
  li018.state = 0
  DarkLights(1) = 0
  DarkLights(2) = 0
  DarkLights(3) = 0
  DarkLights(4) = 0
  'AddScore score_kickback_use
  KBActive = 0 ' reset KBActive flag
  BlinkDARK
End Sub

Sub Kickback2_Hit
' PuPlayer.LabelSet pBackglass,"KickBackStatus","",0,""
' PuPlayer.LabelSet pBackglass,"KickBackStatus2","",0,""
  pBackglassHideAnimate "kickbackGIF"
  pbackglasslabelshow "Wanted"
    PlaySoundAt "VUKEnter", Kickback2
    DOF 116, DOFPulse
    TriggerScript 500, "DOF 110, DOFPulse:PlaySoundAt SoundFX(""Popper"",DOFContactors),Kickback2:kickback2.kick 0,45"
    TriggerScript 1000, "PlaySoundAt""fx_diverter"", gatekg:rightoutlane.Enabled =1:gatekg.RotateToStart"
  li015.state = 0
  li016.state = 0
  li017.state = 0
  li018.state = 0
  DarkLights(1) = 0
  DarkLights(2) = 0
  DarkLights(3) = 0
  DarkLights(4) = 0
  'AddScore score_kickback_use
  KBActive = 0 ' reset KBActive flag
  BlinkDARK
End Sub

Sub DisableKickback
  KBActive = 0  ' used by applyknight routine
  pBackglassHideAnimate "kickbackGIF"
' PuPlayer.LabelSet pBackglass,"KickBackStatus","",0,""
' PuPlayer.LabelSet pBackglass,"KickBackStatus2","",0,""
  li015.state = 0
  li016.state = 0
  li017.state = 0
  li018.state = 0
  DarkLights(1) = 0
  DarkLights(2) = 0
  DarkLights(3) = 0
  DarkLights(4) = 0
End Sub

Sub ClearKickback
  pBackglassHideAnimate "kickbackGIF"
  'PuPlayer.LabelSet pBackglass,"KickBackStatus","",0,""
  'PuPlayer.LabelSet pBackglass,"KickBackStatus2","",0,""
End Sub

Sub ClearWanted
  pBackglassLabelHide "Wanted"
End Sub

Sub ClearRewardGold
  pBackglassLabelHide "RewardGold"
End Sub

Sub DisplayWanted
if dev.enabled = 0 Then pBackglassLabelShow "Wanted"  ' prevent image from showing when in debug mode
End Sub

Sub DisplayRewawrdGold
  pBackglassLabelShow "RewardGold"
End Sub

'***********
' ZVAR   variabels used
'***********





'***********
' ZSCO   Scoring variabels
'***********
'////////////////////////////////////////////////////////////////////
'Scoring Constants
Const Score_RightOrbit = 1000
Const Score_LeftOrbit = 1000
Const Score_FullOrbit = 1000
Const Score_RightRamp = 500
Const Score_LeftRamp = 500
Const Score_Spinner = 100
Const Score_InLanes = 250
Const Score_OutLanes = 250
Const Score_DarkTarget = 500
Const Score_KickbackLit = 2500
Const Score_CBall = 7500
Const Score_CBallJackpot = 7500
Const Score_CryptJackpot = 150000
Const Score_CryptSuperJackpot = 500000
Const Score_Torch = 100
Const Score_Bumper = 250
Const Score_UPFTarget = 1000
Const Score_SlingShot = 100
Const Score_PopUpTarget = 500
Const Score_BallLock = 1000
Const Score_ExtraBall = 5000
Const Score_Special = 10000
Const Score_GambleRamp = 50000
Const Score_GambleWin = 100000
Const Score_GambleWin2X = 40000
Const Score_BlacksmithLevel = 25000
Const Score_BlacksmithWin = 750000
Const Score_InTheDarkWin = 600000
Const Score_DungeonBonus = 25000

Const score_skillshot1  = 100000
Const score_skillshot2  = 200000
Const score_scoop2_hit  =  25000
Const score_dark_hit  =   5000
Const score_dark_lit  =  20000
Const score_kickback_lit=  50000
Const score_kickback_use=  50000
Const score_torch_hit =  10000
'Const score_outlanes = 250000
'Const score_inlanes    = 100000
Const score_addEOBx   = 100000 ' eobbonus upgrade
Const score_maxEOB    = 200000 ' already on max eobbonus so give points
Const score_blacksmithEnd = 250000
const score_blacksmith  = 100000
'Const score_gamble     = 200000
'Const score_gamblex2   = 400000

'*********
' ZCAMP in/out Lanes
'*********
' in and outlanes
Sub leftoutlane_Hit
    If Tilted Then Exit Sub
    'score & bonus
  AddScore score_outlanes
  if li002.state = 1 Then
    li002.state = 0
  Else
    li002.state = 1
        DOF 228, DOFPulse
  End If
  CheckCAMP
  Switch_Hit "leftoutlane"
End Sub

Sub leftinlane_Hit
    If Tilted Then Exit Sub
    'score & bonus
    AddScore score_inlanes
  if li003.state = 1 Then
    li003.state = 0
  Else
    li003.state = 1
        DOF 229, DOFPulse
  End If
  CheckCAMP
  Switch_Hit "leftinlane"
End Sub

Sub rightinlane_Hit
    If Tilted Then Exit Sub
    'score & bonus
    AddScore score_inlanes

    if not bMagnetCaptured And AutoMagnetOn = True Then
      EnableMagnet
      triggerscript MagnetTime*1000, "DisableMagnet"
      'BallHandlingQueue.Add "DisableMagnet","MagnetTime*1000, ""DisableMagnet"" ",90,0,0,0,0,True
    End If

  if li004.state = 1 Then
    li004.state = 0
  Else
    li004.state = 1
        DOF 230, DOFPulse
  End If
  CheckCAMP
  Switch_Hit "rightinlane"
End Sub

Sub rightoutlane_Hit
    If Tilted Then Exit Sub
    'score & bonus
    AddScore score_outlanes
  if li005.state = 1 Then
    li005.state = 0
  Else
    li005.state = 1
        DOF 231, DOFPulse
  End If
  CheckCAMP
  'AudioQueue.Add "Pup231","PuPEvent 231",25,0,0,0,AudioExpiry,False
  Switch_Hit "rightinlane"
End Sub

Sub CheckCAMP
    LightSeqLanes.Play SeqRandom, 4, , 200
    If li002.State + li003.State + li004.State + li005.State = 4 Then 'all lights are lit then turn them off
        DOF 232, DOFPulse
        li002.State = 0
        li003.State = 0
        li004.State = 0
        li005.State = 0
    LightSeqLanes.stopplay
        LightSeqLanes.Play SeqRandom, 2, , 700

    EOB_Bonus = EOB_Bonus + 2
    If EOB_Bonus > 8 Then ' already 8x
      EOB_Bonus = 8
      FlashForms lix2, 400, 30, 1
      FlashForms lix4, 400, 30, 1
      FlashForms lix6, 400, 30, 1
      FlashForms lix8, 400, 30, 1
      AddScore Score_MaxEOB
    Else
      If EOB_Bonus = 2 Then FlashForms lix2, 400, 30, 1
      If EOB_Bonus = 4 Then FlashForms lix4, 400, 30, 1
      If EOB_Bonus = 6 Then FlashForms lix6, 400, 30, 1
      If EOB_Bonus = 8 Then FlashForms lix8, 400, 30, 1
      'addscore score_addEOBx
    End If

  SetBonusMultiplier(EOB_Bonus)

    if EOB_Bonus > 1 Then lix2.state = 1
    if EOB_Bonus > 3 Then lix4.state = 1
    if EOB_Bonus > 5 Then lix6.state = 1
    if EOB_Bonus > 7 Then lix8.state = 1
  End If
End Sub

Sub ResetCampLights
  lix2.state = 0
  lix4.state = 0
  Lix6.state = 0
  Lix8.state = 0
End sub


'//////////////////////////////////////////////////////////////////////
'// Ball
'//////////////////////////////////////////////////////////////////////

If BallBright Then
  table1.BallImage = "ball_HDR_brighter"
Else
  table1.BallImage = "MRBallDark2b"
End If

'//////////////////////////////////////////////////////////////////////
'// Dynamic Ball Shadows
'//////////////////////////////////////////////////////////////////////

Const fovY          = 0   'Offset y position under ball to account for layback or inclination (more pronounced need further back)
Const DynamicBSFactor     = 0.95  '0 to 1, higher is darker
Const AmbientBSFactor     = 0.7 '0 to 1, higher is darker
Const AmbientMovement   = 2   '1 to 4, higher means more movement as the ball moves left and right
Const Wideness        = 20  'Sets how wide the dynamic ball shadows can get (20 +5 thinness should be most realistic for a 50 unit ball)
Const Thinness        = 5   'Sets minimum as ball moves away from source


' *** This segment goes within the RollingUpdate sub, so that if Ambient...=0 and Dynamic...=0 the entire DynamicBSUpdate sub can be skipped for max performance
' ' stop the sound of deleted balls
' For b = UBound(BOT) + 1 to tnob
'   If AmbientBallShadowOn = 0 Then BallShadowA(b).visible = 0
'   ...rolling(b) = False
'   ...StopSound("BallRoll_" & b)
' Next
'
'...rolling and drop sounds...

'   If DropCount(b) < 5 Then
'     DropCount(b) = DropCount(b) + 1
'   End If
'
'   ' "Static" Ball Shadows
'   If AmbientBallShadowOn = 0 Then
'     If BOT(b).Z > 30 Then
'       BallShadowA(b).height=BOT(b).z - BallSize/4   'This is technically 1/4 of the ball "above" the ramp, but it keeps it from clipping
'     Else
'       BallShadowA(b).height=BOT(b).z - BallSize/2 + 5
'     End If
'     BallShadowA(b).Y = BOT(b).Y + Ballsize/5 + fovY
'     BallShadowA(b).X = BOT(b).X
'     BallShadowA(b).visible = 1
'   End If

' *** Required Functions, enable these if they are not already present elswhere in your table
Function DistanceFast(x, y)
  dim ratio, ax, ay
  ax = abs(x)         'Get absolute value of each vector
  ay = abs(y)
  ratio = 1 / max(ax, ay)   'Create a ratio
  ratio = ratio * (1.29289 - (ax + ay) * ratio * 0.29289)
  if ratio > 0 then     'Quickly determine if it's worth using
    DistanceFast = 1/ratio
  Else
    DistanceFast = 0
  End if
end Function

Function max(a,b)
  if a > b then
    max = a
  Else
    max = b
  end if
end Function

'Dim PI: PI = 4*Atn(1)

'Function Atn2(dy, dx)
' If dx > 0 Then
'   Atn2 = Atn(dy / dx)
' ElseIf dx < 0 Then
'   If dy = 0 Then
'     Atn2 = pi
'   Else
'     Atn2 = Sgn(dy) * (pi - Atn(Abs(dy / dx)))
'   end if
' ElseIf dx = 0 Then
'   if dy = 0 Then
'     Atn2 = 0
'   else
'     Atn2 = Sgn(dy) * pi / 2
'   end if
' End If
'End Function
'
'Function AnglePP(ax,ay,bx,by)
' AnglePP = Atn2((by - ay),(bx - ax))*180/PI
'End Function

'****** End Part B:  Code and Functions ******


'****** Part C:  The Magic ******
Dim sourcenames, currentShadowCount, DSSources(30), numberofsources, numberofsources_hold
sourcenames = Array ("","","","","","","","","","","","")
currentShadowCount = Array (0,0,0,0,0,0,0,0,0,0,0,0)

' *** Trim or extend these to match the number of balls/primitives/flashers on the table!
dim objrtx1(12), objrtx2(12)
dim objBallShadow(12)
Dim BallShadowA
BallShadowA = Array (BallShadowA0,BallShadowA1,BallShadowA2,BallShadowA3,BallShadowA4,BallShadowA5,BallShadowA6,BallShadowA7,BallShadowA8,BallShadowA9,BallShadowA10,BallShadowA11)

DynamicBSInit

sub DynamicBSInit()
  Dim iii, source

  for iii = 0 to tnob                 'Prepares the shadow objects before play begins
    Set objrtx1(iii) = Eval("RtxBallShadow" & iii)
    objrtx1(iii).material = "RtxBallShadow" & iii
    objrtx1(iii).z = iii/1000 + 0.01
    objrtx1(iii).visible = 0

    Set objrtx2(iii) = Eval("RtxBall2Shadow" & iii)
    objrtx2(iii).material = "RtxBallShadow2_" & iii
    objrtx2(iii).z = (iii)/1000 + 0.02
    objrtx2(iii).visible = 0

    currentShadowCount(iii) = 0

    Set objBallShadow(iii) = Eval("BallShadow" & iii)
    objBallShadow(iii).material = "BallShadow" & iii
    UpdateMaterial objBallShadow(iii).material,1,0,0,0,0,0,AmbientBSFactor,RGB(0,0,0),0,0,False,True,0,0,0,0
    objBallShadow(iii).Z = iii/1000 + 0.04
    objBallShadow(iii).visible = 0

    BallShadowA(iii).Opacity = 100*AmbientBSFactor
    BallShadowA(iii).visible = 0
  Next

  iii = 0

  For Each Source in DynamicSources
    DSSources(iii) = Array(Source.x, Source.y)
    iii = iii + 1
  Next
  numberofsources = iii
  numberofsources_hold = iii
end sub


Sub DynamicBSUpdate
  Dim falloff:  falloff = 150     'Max distance to light sources, can be changed if you have a reason
  Dim ShadowOpacity, ShadowOpacity2
  Dim s, Source, LSd, currentMat, AnotherSource, BOT, iii
  BOT = GetBalls

  'Hide shadow of deleted balls
  For s = UBound(BOT) + 1 to tnob
    objrtx1(s).visible = 0
    objrtx2(s).visible = 0
    objBallShadow(s).visible = 0
    BallShadowA(s).visible = 0
  Next

  If UBound(BOT) < lob Then Exit Sub    'No balls in play, exit

'The Magic happens now
  For s = lob to UBound(BOT)

' *** Normal "ambient light" ball shadow
  'Layered from top to bottom. If you had an upper pf at for example 80 and ramps even above that, your segments would be z>110; z<=110 And z>100; z<=100 And z>30; z<=30 And z>20; Else invisible

    If AmbientBallShadowOn = 1 Then     'Primitive shadow on playfield, flasher shadow in ramps
      If BOT(s).Z > 30 Then             'The flasher follows the ball up ramps while the primitive is on the pf
        If BOT(s).X < tablewidth/2 Then
          objBallShadow(s).X = ((BOT(s).X) - (Ballsize/10) + ((BOT(s).X - (tablewidth/2))/(Ballsize/AmbientMovement))) + 5
        Else
          objBallShadow(s).X = ((BOT(s).X) + (Ballsize/10) + ((BOT(s).X - (tablewidth/2))/(Ballsize/AmbientMovement))) - 5
        End If
        objBallShadow(s).Y = BOT(s).Y + BallSize/10 + fovY
        objBallShadow(s).visible = 1

        BallShadowA(s).X = BOT(s).X
        BallShadowA(s).Y = BOT(s).Y + BallSize/5 + fovY
        BallShadowA(s).height=BOT(s).z - BallSize/4   'This is technically 1/4 of the ball "above" the ramp, but it keeps it from clipping
        BallShadowA(s).visible = 1
      Elseif BOT(s).Z <= 30 And BOT(s).Z > 20 Then  'On pf, primitive only
        objBallShadow(s).visible = 1
        If BOT(s).X < tablewidth/2 Then
          objBallShadow(s).X = ((BOT(s).X) - (Ballsize/10) + ((BOT(s).X - (tablewidth/2))/(Ballsize/AmbientMovement))) + 5
        Else
          objBallShadow(s).X = ((BOT(s).X) + (Ballsize/10) + ((BOT(s).X - (tablewidth/2))/(Ballsize/AmbientMovement))) - 5
        End If
        objBallShadow(s).Y = BOT(s).Y + fovY
        BallShadowA(s).visible = 0
      Else                      'Under pf, no shadows
        objBallShadow(s).visible = 0
        BallShadowA(s).visible = 0
      end if

    Elseif AmbientBallShadowOn = 2 Then   'Flasher shadow everywhere
      If BOT(s).Z > 30 Then             'In a ramp
        BallShadowA(s).X = BOT(s).X
        BallShadowA(s).Y = BOT(s).Y + BallSize/5 + fovY
        BallShadowA(s).height=BOT(s).z - BallSize/4   'This is technically 1/4 of the ball "above" the ramp, but it keeps it from clipping
        BallShadowA(s).visible = 1
      Elseif BOT(s).Z <= 30 And BOT(s).Z > 20 Then  'On pf
        BallShadowA(s).visible = 1
        If BOT(s).X < tablewidth/2 Then
          BallShadowA(s).X = ((BOT(s).X) - (Ballsize/10) + ((BOT(s).X - (tablewidth/2))/(Ballsize/AmbientMovement))) + 5
        Else
          BallShadowA(s).X = ((BOT(s).X) + (Ballsize/10) + ((BOT(s).X - (tablewidth/2))/(Ballsize/AmbientMovement))) - 5
        End If
        BallShadowA(s).Y = BOT(s).Y + Ballsize/10 + fovY
        BallShadowA(s).height=BOT(s).z - BallSize/2 + 5
      Else                      'Under pf
        BallShadowA(s).visible = 0
      End If
    End If

' *** Dynamic shadows
    If DynamicBallShadowsOn Then
      If BOT(s).Z < 30 Then 'And BOT(s).Y < (TableHeight - 200) Then 'Or BOT(s).Z > 105 Then    'Defining when and where (on the table) you can have dynamic shadows
        For iii = 0 to numberofsources - 1
          LSd=DistanceFast((BOT(s).x-DSSources(iii)(0)),(BOT(s).y-DSSources(iii)(1))) 'Calculating the Linear distance to the Source
          If LSd < falloff And gilvl > 0 Then               'If the ball is within the falloff range of a light and light is on (we will set numberofsources to 0 when GI is off)
            currentShadowCount(s) = currentShadowCount(s) + 1   'Within range of 1 or 2
            if currentShadowCount(s) = 1 Then           '1 dynamic shadow source
              sourcenames(s) = iii
              currentMat = objrtx1(s).material
              objrtx2(s).visible = 0 : objrtx1(s).visible = 1 : objrtx1(s).X = BOT(s).X : objrtx1(s).Y = BOT(s).Y + fovY
  '           objrtx1(s).Z = BOT(s).Z - 25 + s/1000 + 0.01            'Uncomment if you want to add shadows to an upper/lower pf
              objrtx1(s).rotz = AnglePP(DSSources(iii)(0), DSSources(iii)(1), BOT(s).X, BOT(s).Y) + 90
              ShadowOpacity = (falloff-LSd)/falloff                 'Sets opacity/darkness of shadow by distance to light
              objrtx1(s).size_y = Wideness*ShadowOpacity+Thinness           'Scales shape of shadow with distance/opacity
              UpdateMaterial currentMat,1,0,0,0,0,0,ShadowOpacity*DynamicBSFactor^2,RGB(0,0,0),0,0,False,True,0,0,0,0
              If AmbientBallShadowOn = 1 Then
                currentMat = objBallShadow(s).material                  'Brightens the ambient primitive when it's close to a light
                UpdateMaterial currentMat,1,0,0,0,0,0,AmbientBSFactor*(1-ShadowOpacity),RGB(0,0,0),0,0,False,True,0,0,0,0
              Else
                BallShadowA(s).Opacity = 100*AmbientBSFactor*(1-ShadowOpacity)
              End If

            Elseif currentShadowCount(s) = 2 Then
                                  'Same logic as 1 shadow, but twice
              currentMat = objrtx1(s).material
              AnotherSource = sourcenames(s)
              objrtx1(s).visible = 1 : objrtx1(s).X = BOT(s).X : objrtx1(s).Y = BOT(s).Y + fovY
  '           objrtx1(s).Z = BOT(s).Z - 25 + s/1000 + 0.01              'Uncomment if you want to add shadows to an upper/lower pf
              objrtx1(s).rotz = AnglePP(DSSources(AnotherSource)(0),DSSources(AnotherSource)(1), BOT(s).X, BOT(s).Y) + 90
              ShadowOpacity = (falloff-DistanceFast((BOT(s).x-DSSources(AnotherSource)(0)),(BOT(s).y-DSSources(AnotherSource)(1))))/falloff
              objrtx1(s).size_y = Wideness*ShadowOpacity+Thinness
              UpdateMaterial currentMat,1,0,0,0,0,0,ShadowOpacity*DynamicBSFactor^3,RGB(0,0,0),0,0,False,True,0,0,0,0

              currentMat = objrtx2(s).material
              objrtx2(s).visible = 1 : objrtx2(s).X = BOT(s).X : objrtx2(s).Y = BOT(s).Y + fovY
  '           objrtx2(s).Z = BOT(s).Z - 25 + s/1000 + 0.02              'Uncomment if you want to add shadows to an upper/lower pf
              objrtx2(s).rotz = AnglePP(DSSources(iii)(0), DSSources(iii)(1), BOT(s).X, BOT(s).Y) + 90
              ShadowOpacity2 = (falloff-LSd)/falloff
              objrtx2(s).size_y = Wideness*ShadowOpacity2+Thinness
              UpdateMaterial currentMat,1,0,0,0,0,0,ShadowOpacity2*DynamicBSFactor^3,RGB(0,0,0),0,0,False,True,0,0,0,0
              If AmbientBallShadowOn = 1 Then
                currentMat = objBallShadow(s).material                  'Brightens the ambient primitive when it's close to a light
                UpdateMaterial currentMat,1,0,0,0,0,0,AmbientBSFactor*(1-max(ShadowOpacity,ShadowOpacity2)),RGB(0,0,0),0,0,False,True,0,0,0,0
              Else
                BallShadowA(s).Opacity = 100*AmbientBSFactor*(1-max(ShadowOpacity,ShadowOpacity2))
              End If
            end if
          Else
            currentShadowCount(s) = 0
            BallShadowA(s).Opacity = 100*AmbientBSFactor
          End If
        Next
      Else                  'Hide dynamic shadows everywhere else
        objrtx2(s).visible = 0 : objrtx1(s).visible = 0
      End If
    End If
  Next
End Sub

'//////////////////////////////////////////////////////////////////////
'// TargetBounce
'//////////////////////////////////////////////////////////////////////

sub TargetBouncer(aBall,defvalue)
    dim zMultiplier, vel, vratio
    if TargetBouncerEnabled = 1 and aball.z < 30 then
        'debug3 "velx: " & aball.velx & " vely: " & aball.vely & " velz: " & aball.velz
        vel = BallSpeed(aBall)
        if aBall.velx = 0 then vratio = 1 else vratio = aBall.vely/aBall.velx
        Select Case Int(Rnd * 6) + 1
            Case 1: zMultiplier = 0.2*defvalue
      Case 2: zMultiplier = 0.25*defvalue
            Case 3: zMultiplier = 0.3*defvalue
      Case 4: zMultiplier = 0.4*defvalue
            Case 5: zMultiplier = 0.45*defvalue
            Case 6: zMultiplier = 0.5*defvalue
        End Select
        aBall.velz = abs(vel * zMultiplier * TargetBouncerFactor)
        aBall.velx = sgn(aBall.velx) * sqr(abs((vel^2 - aBall.velz^2)/(1+vratio^2)))
        aBall.vely = aBall.velx * vratio
        'debug3 "---> velx: " & aball.velx & " vely: " & aball.vely & " velz: " & aball.velz
        'debug3 "conservation check: " & BallSpeed(aBall)/vel
  end if
end sub

' Add targets or posts to the TargetBounce collection if you want to activate the targetbouncer code from them
Sub TargetBounce_Hit
  TargetBouncer activeball, 1
End Sub

'//////////////////////////////////////////////////////////////////////
'// PHYSICS DAMPENERS
'//////////////////////////////////////////////////////////////////////

' These are data mined bounce curves,
' dialed in with the in-game elasticity as much as possible to prevent angle / spin issues.
' Requires tracking ballspeed to calculate COR



Sub dPosts_Hit(idx)
  RubbersD.dampen Activeball
  TargetBouncer Activeball, 1
End Sub

Sub dSleeves_Hit(idx)
  SleevesD.Dampen Activeball
  TargetBouncer Activeball, 0.7
End Sub


dim RubbersD : Set RubbersD = new Dampener        'frubber
RubbersD.name = "Rubbers"
RubbersD.debugOn = False        'shows info in textbox "TBPout"
RubbersD.Print = False        'debug, reports in debugger (in vel, out cor)
'cor bounce curve (linear)
'for best results, try to match in-game velocity as closely as possible to the desired curve
'RubbersD.addpoint 0, 0, 0.935        'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 0, 0, 1.1        'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 1, 3.77, 0.97
RubbersD.addpoint 2, 5.76, 0.967        'dont take this as gospel. if you can data mine rubber elasticitiy, please help!
RubbersD.addpoint 3, 15.84, 0.874
RubbersD.addpoint 4, 56, 0.64        'there's clamping so interpolate up to 56 at least

dim SleevesD : Set SleevesD = new Dampener        'this is just rubber but cut down to 85%...
SleevesD.name = "Sleeves"
SleevesD.debugOn = False        'shows info in textbox "TBPout"
SleevesD.Print = False        'debug, reports in debugger (in vel, out cor)
SleevesD.CopyCoef RubbersD, 0.85

'######################### Add new FlippersD Profile
'#########################    Adjust these values to increase or lessen the elasticity

dim FlippersD : Set FlippersD = new Dampener
FlippersD.name = "Flippers"
FlippersD.debugOn = False
FlippersD.Print = False
FlippersD.addpoint 0, 0, 1.1
FlippersD.addpoint 1, 3.77, 0.99
FlippersD.addpoint 2, 6, 0.99

Class Dampener
  Public Print, debugOn 'tbpOut.text
  public name, Threshold         'Minimum threshold. Useful for Flippers, which don't have a hit threshold.
  Public ModIn, ModOut
  Private Sub Class_Initialize : redim ModIn(0) : redim Modout(0): End Sub

  Public Sub AddPoint(aIdx, aX, aY)
    ShuffleArrays ModIn, ModOut, 1 : ModIn(aIDX) = aX : ModOut(aIDX) = aY : ShuffleArrays ModIn, ModOut, 0
    if gametime > 100 then Report
  End Sub

  public sub Dampen(aBall)
    if threshold then if BallSpeed(aBall) < threshold then exit sub end if end if
    dim RealCOR, DesiredCOR, str, coef
    DesiredCor = LinearEnvelope(cor.ballvel(aBall.id), ModIn, ModOut )
    RealCOR = BallSpeed(aBall) / (cor.ballvel(aBall.id)+0.0001)
    coef = desiredcor / realcor
    if debugOn then str = name & " in vel:" & round(cor.ballvel(aBall.id),2 ) & vbnewline & "desired cor: " & round(desiredcor,4) & vbnewline & _
    "actual cor: " & round(realCOR,4) & vbnewline & "ballspeed coef: " & round(coef, 3) & vbnewline
'   if Print then debug3 Round(cor.ballvel(aBall.id),2) & ", " & round(desiredcor,3)

    aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef
    if debugOn then TBPout.text = str
  End Sub

  public sub Dampenf(aBall, parm) 'Rubberizer is handle here
    dim RealCOR, DesiredCOR, str, coef
    DesiredCor = LinearEnvelope(cor.ballvel(aBall.id), ModIn, ModOut )
    RealCOR = BallSpeed(aBall) / (cor.ballvel(aBall.id)+0.0001)
    coef = desiredcor / realcor
    If abs(aball.velx) < 2 and aball.vely < 0 and aball.vely > -3.75 then
      aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef
    End If
  End Sub

  Public Sub CopyCoef(aObj, aCoef) 'alternative addpoints, copy with coef
    dim x : for x = 0 to uBound(aObj.ModIn)
      addpoint x, aObj.ModIn(x), aObj.ModOut(x)*aCoef
    Next
  End Sub


  Public Sub Report()         'debug, reports all coords in tbPL.text
    if not debugOn then exit sub
    dim a1, a2 : a1 = ModIn : a2 = ModOut
    dim str, x : for x = 0 to uBound(a1) : str = str & x & ": " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    TBPout.text = str
  End Sub

End Class

'//////////////////////////////////////////////////////////////////////
'// TRACK ALL BALL VELOCITIES FOR RUBBER DAMPENER AND DROP TARGETS
'//////////////////////////////////////////////////////////////////////

dim cor : set cor = New CoRTracker

Class CoRTracker
  public ballvel, ballvelx, ballvely

  Private Sub Class_Initialize : redim ballvel(0) : redim ballvelx(0): redim ballvely(0) : End Sub

  Public Sub Update() 'tracks in-ball-velocity
    dim str, b, AllBalls, highestID : allBalls = getballs

    for each b in allballs
      if b.id >= HighestID then highestID = b.id
    Next

    if uBound(ballvel) < highestID then redim ballvel(highestID)  'set bounds
    if uBound(ballvelx) < highestID then redim ballvelx(highestID)  'set bounds
    if uBound(ballvely) < highestID then redim ballvely(highestID)  'set bounds

    for each b in allballs
      ballvel(b.id) = BallSpeed(b)
      ballvelx(b.id) = b.velx
      ballvely(b.id) = b.vely
    Next
  End Sub
End Class

'//////////////////////////////////////////////////////////////////////
'// RAMP ROLLING SFX
'//////////////////////////////////////////////////////////////////////

'Ball tracking ramp SFX 1.0
'   Reqirements:
'          * Import A Sound File for each ball on the table for plastic ramps.  Call It RampLoop<Ball_Number> ex: RampLoop1, RampLoop2, ...
'          * Import a Sound File for each ball on the table for wire ramps. Call it WireLoop<Ball_Number> ex: WireLoop1, WireLoop2, ...
'          * Create a Timer called RampRoll, that is enabled, with a interval of 100
'          * Set RampBAlls and RampType variable to Total Number of Balls
' Usage:
'          * Setup hit events and call WireRampOn True or WireRampOn False (True = Plastic ramp, False = Wire Ramp)
'          * To stop tracking ball
'                 * call WireRampOff
'                 * Otherwise, the ball will auto remove if it's below 30 vp units
'

dim RampMinLoops : RampMinLoops = 4

' RampBalls
'      Setup:        Set the array length of x in RampBalls(x,2) Total Number of Balls on table + 1:  if tnob = 5, then RammBalls(6,2)
'      Description:
dim RampBalls(6,2)
'x,0 = ball x,1 = ID, 2 = Protection against ending early (minimum amount of updates)
'0,0 is boolean on/off, 0,1 unused for now
RampBalls(0,0) = False

' RampType
'     Setup: Set this array to the number Total number of balls that can be tracked at one time + 1.  5 ball multiball then set value to 6
'     Description: Array type indexed on BallId and a values used to deterimine what type of ramp the ball is on: False = Wire Ramp, True = Plastic Ramp
dim RampType(6)

Sub WireRampOn(input)  : Waddball ActiveBall, input : RampRollUpdate: End Sub
Sub WireRampOff() : WRemoveBall ActiveBall.ID : End Sub


' WaddBall (Active Ball, Boolean)
'     Description: This subroutine is called from WireRampOn to Add Balls to the RampBalls Array
Sub Waddball(input, RampInput)  'Add ball
  ' This will loop through the RampBalls array checking each element of the array x, position 1
  ' To see if the the ball was already added to the array.
  ' If the ball is found then exit the subroutine
  dim x : for x = 1 to uBound(RampBalls)  'Check, don't add balls twice
    if RampBalls(x, 1) = input.id then
      if Not IsEmpty(RampBalls(x,1) ) then Exit Sub 'Frustating issue with BallId 0. Empty variable = 0
    End If
  Next

  ' This will itterate through the RampBalls Array.
  ' The first time it comes to a element in the array where the Ball Id (Slot 1) is empty.  It will add the current ball to the array
  ' The RampBalls assigns the ActiveBall to element x,0 and ball id of ActiveBall to 0,1
  ' The RampType(BallId) is set to RampInput
  ' RampBalls in 0,0 is set to True, this will enable the timer and the timer is also turned on
  For x = 1 to uBound(RampBalls)
    if IsEmpty(RampBalls(x, 1)) then
      Set RampBalls(x, 0) = input
      RampBalls(x, 1) = input.ID
      RampType(x) = RampInput
      RampBalls(x, 2) = 0
      'exit For
      RampBalls(0,0) = True
      RampRoll.Enabled = 1   'Turn on timer
      'RampRoll.Interval = RampRoll.Interval 'reset timer
      exit Sub
    End If
'   if x = uBound(RampBalls) then   'debug
'     debug3 "WireRampOn error, ball queue is full: " & vbnewline & _
'     RampBalls(0, 0) & vbnewline & _
'     Typename(RampBalls(1, 0)) & " ID:" & RampBalls(1, 1) & "type:" & RampType(1) & vbnewline & _
'     Typename(RampBalls(2, 0)) & " ID:" & RampBalls(2, 1) & "type:" & RampType(2) & vbnewline & _
'     Typename(RampBalls(3, 0)) & " ID:" & RampBalls(3, 1) & "type:" & RampType(3) & vbnewline & _
'     Typename(RampBalls(4, 0)) & " ID:" & RampBalls(4, 1) & "type:" & RampType(4) & vbnewline & _
'     Typename(RampBalls(5, 0)) & " ID:" & RampBalls(5, 1) & "type:" & RampType(5) & vbnewline & _
'     " "
'   End If
  next
End Sub

' WRemoveBall (BallId)
'    Description: This subroutine is called from the RampRollUpdate subroutine
'                 and is used to remove and stop the ball rolling sounds
Sub WRemoveBall(ID)   'Remove ball
  'debug3 "In WRemoveBall() + Remove ball from loop array"
  dim ballcount : ballcount = 0
  dim x : for x = 1 to Ubound(RampBalls)
    if ID = RampBalls(x, 1) then 'remove ball
      Set RampBalls(x, 0) = Nothing
      RampBalls(x, 1) = Empty
      RampType(x) = Empty
      StopSound("RampLoop" & x)
      StopSound("wireloop" & x)
    end If
    'if RampBalls(x,1) = Not IsEmpty(Rampballs(x,1) then ballcount = ballcount + 1
    if not IsEmpty(Rampballs(x,1)) then ballcount = ballcount + 1
  next
  if BallCount = 0 then RampBalls(0,0) = False  'if no balls in queue, disable timer update
End Sub

Sub RampRoll_Timer():RampRollUpdate:End Sub

Sub RampRollUpdate()    'Timer update
  dim x : for x = 1 to uBound(RampBalls)
    if Not IsEmpty(RampBalls(x,1) ) then
      if BallVel(RampBalls(x,0) ) > 1 then ' if ball is moving, play rolling sound
        If RampType(x) then
          PlaySound("RampLoop" & x), -1, VolPlayfieldRoll(RampBalls(x,0)) * RampRollVolume * VolumeDial, AudioPan(RampBalls(x,0)), 0, BallPitchV(RampBalls(x,0)), 1, 0, AudioFade(RampBalls(x,0))
          StopSound("wireloop" & x)
        Else
          StopSound("RampLoop" & x)
          PlaySound("wireloop" & x), -1, VolPlayfieldRoll(RampBalls(x,0)) * RampRollVolume * VolumeDial, AudioPan(RampBalls(x,0)), 0, BallPitch(RampBalls(x,0)), 1, 0, AudioFade(RampBalls(x,0))
        End If
        RampBalls(x, 2) = RampBalls(x, 2) + 1
      Else
        StopSound("RampLoop" & x)
        StopSound("wireloop" & x)
      end if
      if RampBalls(x,0).Z < 30 and RampBalls(x, 2) > RampMinLoops then  'if ball is on the PF, remove  it
        StopSound("RampLoop" & x)
        StopSound("wireloop" & x)
        Wremoveball RampBalls(x,1)
      End If
    Else
      StopSound("RampLoop" & x)
      StopSound("wireloop" & x)
    end if
  next
  if not RampBalls(0,0) then RampRoll.enabled = 0

End Sub

' This can be used to debug the Ramp Roll time.  You need to enable the tbWR timer on the TextBox
Sub tbWR_Timer()  'debug textbox
  me.text = "on? " & RampBalls(0, 0) & " timer: " & RampRoll.Enabled & vbnewline & _
  "1 " & Typename(RampBalls(1, 0)) & " ID:" & RampBalls(1, 1) & " type:" & RampType(1) & " Loops:" & RampBalls(1, 2) & vbnewline & _
  "2 " & Typename(RampBalls(2, 0)) & " ID:" & RampBalls(2, 1) & " type:" & RampType(2) & " Loops:" & RampBalls(2, 2) & vbnewline & _
  "3 " & Typename(RampBalls(3, 0)) & " ID:" & RampBalls(3, 1) & " type:" & RampType(3) & " Loops:" & RampBalls(3, 2) & vbnewline & _
  "4 " & Typename(RampBalls(4, 0)) & " ID:" & RampBalls(4, 1) & " type:" & RampType(4) & " Loops:" & RampBalls(4, 2) & vbnewline & _
  "5 " & Typename(RampBalls(5, 0)) & " ID:" & RampBalls(5, 1) & " type:" & RampType(5) & " Loops:" & RampBalls(5, 2) & vbnewline & _
  "6 " & Typename(RampBalls(6, 0)) & " ID:" & RampBalls(6, 1) & " type:" & RampType(6) & " Loops:" & RampBalls(6, 2) & vbnewline & _
  " "
End Sub


Function BallPitch(ball) ' Calculates the pitch of the sound based on the ball speed
    BallPitch = pSlope(BallVel(ball), 1, -1000, 60, 10000)
End Function

Function BallPitchV(ball) ' Calculates the pitch of the sound based on the ball speed Variation
  BallPitchV = pSlope(BallVel(ball), 1, -4000, 60, 7000)
End Function

'//////////////////////////////////////////////////////////////////////
'// RAMP TRIGGERS
'//////////////////////////////////////////////////////////////////////

Sub ramptrigger1_hit()
    DOF 233, DOFPulse
  WireRampOn True 'Play Plastic Ramp Sound
End Sub

Sub ramptrigger01_hit()
    DOF 234, DOFPulse
  WireRampOn True 'Play Plastic Ramp Sound
End Sub

Sub ramptrigger001_hit()
    DOF 235, DOFPulse
  WireRampOn True 'Play Plastic Ramp Sound
End Sub

Sub ramptrigger0001_hit()
    DOF 236, DOFPulse
  WireRampOn True 'Play Plastic Ramp Sound
End Sub




Sub ramptrigger002_unhit()
  WireRampOn False ' On Wire Ramp Pay Wire Ramp Sound
End Sub

Sub ramptrigger02_hit()
  WireRampOff ' Turn off the Plastic Ramp Sound
End Sub

Sub ramptrigger02_unhit()
  WireRampOn False ' On Wire Ramp Pay Wire Ramp Sound
End Sub

Sub ramptrigger2_hit()
  WireRampOff ' Turn off the Plastic Ramp Sound

End Sub

Sub ramptrigger2_unhit()
  WireRampOn False ' On Wire Ramp Pay Wire Ramp Sound
  gi051.state = 0
End Sub



Sub ramptrigger003_hit()
  WireRampOff ' Exiting Wire Ramp Stop Playing Sound
End Sub

Sub ramptrigger003_unhit()
  PlaySoundAt "WireRamp_Stop", ramptrigger03
End Sub

Sub ramptrigger3_hit()
  WireRampOff ' Exiting Wire Ramp Stop Playing Sound
End Sub

Sub ramptrigger3_unhit()
  PlaySoundAt "WireRamp_Stop", ramptrigger03
End Sub

Sub ramptrigger03_unhit()
  PlaySoundAt "WireRamp_Stop", ramptrigger03
End Sub

Sub ramptrigger004_Unhit()
    WireRampOn False ' On Wire Ramp Pay Wire Ramp Sound
End Sub



'//////////////////////////////////////////////////////////////////////
'// Ball Rolling
'//////////////////////////////////////////////////////////////////////

ReDim rolling(tnob)
InitRolling

Dim DropCount
ReDim DropCount(tnob)

Sub InitRolling
  Dim i
  For i = 0 to tnob
    rolling(i) = False
  Next
End Sub

Sub RollingUpdate()
  Dim BOT, b
  BOT = GetBalls

  ' stop the sound of deleted balls
  For b = UBound(BOT) + 1 to tnob
    ' Comment the next line if you are not implementing Dyanmic Ball Shadows
    If AmbientBallShadowOn = 0 Then BallShadowA(b).visible = 0
    rolling(b) = False
    StopSound("BallRoll_" & b)
  Next

  ' exit the sub if no balls on the table
  If UBound(BOT) = -1 Then Exit Sub

  ' play the rolling sound for each ball

  For b = 0 to UBound(BOT)
    If BallVel(BOT(b)) > 1 AND BOT(b).z < 30 Then
      rolling(b) = True
      PlaySound ("BallRoll_" & b), -1, VolPlayfieldRoll(BOT(b)) * BallRollVolume * VolumeDial, AudioPan(BOT(b)), 0, PitchPlayfieldRoll(BOT(b)), 1, 0, AudioFade(BOT(b))

    Else
      If rolling(b) = True Then
        StopSound("BallRoll_" & b)
        rolling(b) = False
      End If
    End If

    ' Ball Drop Sounds
    If BOT(b).VelZ < -1 and BOT(b).z < 55 and BOT(b).z > 27 Then 'height adjust for ball drop sounds
      If DropCount(b) >= 5 Then
        DropCount(b) = 0
        If BOT(b).velz > -7 Then
          RandomSoundBallBouncePlayfieldSoft BOT(b)
        Else
          RandomSoundBallBouncePlayfieldHard BOT(b)
        End If
      End If
    End If
    If DropCount(b) < 5 Then
      DropCount(b) = DropCount(b) + 1
    End If

    ' "Static" Ball Shadows
    ' Comment the next If block, if you are not implementing the Dyanmic Ball Shadows
    If AmbientBallShadowOn = 0 Then
      If BOT(b).Z > 30 Then
        BallShadowA(b).height=BOT(b).z - BallSize/4   'This is technically 1/4 of the ball "above" the ramp, but it keeps it from clipping
      Else
        BallShadowA(b).height=BOT(b).z - BallSize/2 + 5
      End If
      BallShadowA(b).Y = BOT(b).Y + Ballsize/5 + fovY
      BallShadowA(b).X = BOT(b).X
      BallShadowA(b).visible = 1
    End If
  Next
End Sub

'//////////////////////////////////////////////////////////////////////
'// Mechanic Sounds
'//////////////////////////////////////////////////////////////////////

' This part in the script is an entire block that is dedicated to the physics sound system.
' Various scripts and sounds that may be pretty generic and could suit other WPC systems, but the most are tailored specifically for the TOM table

' Many of the sounds in this package can be added by creating collections and adding the appropriate objects to those collections.
' Create the following new collections:
'   Metals (all metal objects, metal walls, metal posts, metal wire guides)
'   Apron (the apron walls and plunger wall)
'   Walls (all wood or plastic walls)
'   Rollovers (wire rollover triggers, star triggers, or button triggers)
'   Targets (standup or drop targets, these are hit sounds only ... you will want to add separate dropping sounds for drop targets)
'   Gates (plate gates)
'   GatesWire (wire gates)
'   Rubbers (all rubbers including posts, sleeves, pegs, and bands)
' When creating the collections, make sure "Fire events for this collection" is checked.
' You'll also need to make sure "Has Hit Event" is checked for each object placed in these collections (not necessary for gates and triggers).
' Once the collections and objects are added, the save, close, and restart VPX.
'
' Many places in the script need to be modified to include the correct sound effect subroutine calls. The tutorial videos linked below demonstrate
' how to make these updates. But in summary the following needs to be updated:
' - Nudging, plunger, coin-in, start button sounds will be added to the keydown and keyup subs.
' - Flipper sounds in the flipper solenoid subs. Flipper collision sounds in the flipper collide subs.
' - Bumpers, slingshots, drain, ball release, knocker, spinner, and saucers in their respective subs
' - Ball rolling sounds sub
'
' Tutorial vides by Apophis
' Part 1:   https://youtu.be/PbE2kNiam3g
' Part 2:   https://youtu.be/B5cm1Y8wQsk
' Part 3:   https://youtu.be/eLhWyuYOyGg


'///////////////////////////////  SOUNDS PARAMETERS  //////////////////////////////
Dim GlobalSoundLevel, CoinSoundLevel, PlungerReleaseSoundLevel, PlungerPullSoundLevel, NudgeLeftSoundLevel
Dim NudgeRightSoundLevel, NudgeCenterSoundLevel, StartButtonSoundLevel, RollingSoundFactor

CoinSoundLevel = 1                            'volume level; range [0, 1]
NudgeLeftSoundLevel = 1                         'volume level; range [0, 1]
NudgeRightSoundLevel = 1                        'volume level; range [0, 1]
NudgeCenterSoundLevel = 1                       'volume level; range [0, 1]
StartButtonSoundLevel = 0.1                       'volume level; range [0, 1]
PlungerReleaseSoundLevel = 0.8 '1 wjr                     'volume level; range [0, 1]
PlungerPullSoundLevel = 1                       'volume level; range [0, 1]
RollingSoundFactor = 1.1/5

'///////////////////////-----Solenoids, Kickers and Flash Relays-----///////////////////////
Dim FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel, FlipperUpAttackLeftSoundLevel, FlipperUpAttackRightSoundLevel
Dim FlipperUpSoundLevel, FlipperDownSoundLevel, FlipperLeftHitParm, FlipperRightHitParm
Dim SlingshotSoundLevel, BumperSoundFactor, KnockerSoundLevel

FlipperUpAttackMinimumSoundLevel = 0.010                      'volume level; range [0, 1]
FlipperUpAttackMaximumSoundLevel = 0.635                'volume level; range [0, 1]
FlipperUpSoundLevel = 1.0                                   'volume level; range [0, 1]
FlipperDownSoundLevel = 0.45                                  'volume level; range [0, 1]
FlipperLeftHitParm = FlipperUpSoundLevel                'sound helper; not configurable
FlipperRightHitParm = FlipperUpSoundLevel               'sound helper; not configurable
SlingshotSoundLevel = 0.95                        'volume level; range [0, 1]
BumperSoundFactor = 4.25                        'volume multiplier; must not be zero
KnockerSoundLevel = 1                           'volume level; range [0, 1]

'///////////////////////-----Ball Drops, Bumps and Collisions-----///////////////////////
Dim RubberStrongSoundFactor, RubberWeakSoundFactor, RubberFlipperSoundFactor,BallWithBallCollisionSoundFactor
Dim BallBouncePlayfieldSoftFactor, BallBouncePlayfieldHardFactor, PlasticRampDropToPlayfieldSoundLevel, WireRampDropToPlayfieldSoundLevel, DelayedBallDropOnPlayfieldSoundLevel
Dim WallImpactSoundFactor, MetalImpactSoundFactor, SubwaySoundLevel, SubwayEntrySoundLevel, ScoopEntrySoundLevel
Dim SaucerLockSoundLevel, SaucerKickSoundLevel

BallWithBallCollisionSoundFactor = 3.2                  'volume multiplier; must not be zero
RubberStrongSoundFactor = 0.055/5                     'volume multiplier; must not be zero
RubberWeakSoundFactor = 0.075/5                     'volume multiplier; must not be zero
RubberFlipperSoundFactor = 0.075/5                    'volume multiplier; must not be zero
BallBouncePlayfieldSoftFactor = 0.025                 'volume multiplier; must not be zero
BallBouncePlayfieldHardFactor = 0.025                 'volume multiplier; must not be zero
DelayedBallDropOnPlayfieldSoundLevel = 0.8                  'volume level; range [0, 1]
WallImpactSoundFactor = 0.075                     'volume multiplier; must not be zero
MetalImpactSoundFactor = 0.075/3
SaucerLockSoundLevel = 0.8
SaucerKickSoundLevel = 0.8

'///////////////////////-----Gates, Spinners, Rollovers and Targets-----///////////////////////

Dim GateSoundLevel, TargetSoundFactor, SpinnerSoundLevel, RolloverSoundLevel, DTSoundLevel

GateSoundLevel = 0.5/5                          'volume level; range [0, 1]
TargetSoundFactor = 0.0025 * 10                     'volume multiplier; must not be zero
DTSoundLevel = 0.25                           'volume multiplier; must not be zero
RolloverSoundLevel = 0.25                                       'volume level; range [0, 1]
SpinnerSoundLevel = 0.5                                       'volume level; range [0, 1]

'///////////////////////-----Ball Release, Guides and Drain-----///////////////////////
Dim DrainSoundLevel, BallReleaseSoundLevel, BottomArchBallGuideSoundFactor, FlipperBallGuideSoundFactor

DrainSoundLevel = 0.8                           'volume level; range [0, 1]
BallReleaseSoundLevel = 1                       'volume level; range [0, 1]
BottomArchBallGuideSoundFactor = 0.2                  'volume multiplier; must not be zero
FlipperBallGuideSoundFactor = 0.015                   'volume multiplier; must not be zero

'///////////////////////-----Loops and Lanes-----///////////////////////
Dim ArchSoundFactor
ArchSoundFactor = 0.025/5                         'volume multiplier; must not be zero


'/////////////////////////////  SOUND PLAYBACK FUNCTIONS  ////////////////////////////
'/////////////////////////////  POSITIONAL SOUND PLAYBACK METHODS  ////////////////////////////
' Positional sound playback methods will play a sound, depending on the X,Y position of the table element or depending on ActiveBall object position
' These are similar subroutines that are less complicated to use (e.g. simply use standard parameters for the PlaySound call)
' For surround setup - positional sound playback functions will fade between front and rear surround channels and pan between left and right channels
' For stereo setup - positional sound playback functions will only pan between left and right channels
' For mono setup - positional sound playback functions will not pan between left and right channels and will not fade between front and rear channels

' PlaySound full syntax - PlaySound(string, int loopcount, float volume, float pan, float randompitch, int pitch, bool useexisting, bool restart, float front_rear_fade)
' Note - These functions will not work (currently) for walls/slingshots as these do not feature a simple, single X,Y position
Sub PlaySoundAtLevelStatic(playsoundparams, aVol, tableobj)
  PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelExistingStatic(playsoundparams, aVol, tableobj)
  PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 1, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelStaticLoop(playsoundparams, aVol, tableobj)
  PlaySound playsoundparams, -1, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelStaticRandomPitch(playsoundparams, aVol, randomPitch, tableobj)
  PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), randomPitch, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelActiveBall(playsoundparams, aVol)
  PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ActiveBall), 0, 0, 0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtLevelExistingActiveBall(playsoundparams, aVol)
  PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ActiveBall), 0, 0, 1, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtLeveTimerActiveBall(playsoundparams, aVol, ballvariable)
  PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ballvariable), 0, 0, 0, 0, AudioFade(ballvariable)
End Sub

Sub PlaySoundAtLevelTimerExistingActiveBall(playsoundparams, aVol, ballvariable)
  PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ballvariable), 0, 0, 1, 0, AudioFade(ballvariable)
End Sub

Sub PlaySoundAtLevelRoll(playsoundparams, aVol, pitch)
  PlaySound playsoundparams, -1, aVol * VolumeDial, AudioPan(tableobj), randomPitch, 0, 0, 0, AudioFade(tableobj)
End Sub

' Previous Positional Sound Subs

Sub PlaySoundAt(soundname, tableobj)
  PlaySound soundname, 1, 1 * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

Sub PlaySoundAtVol(soundname, tableobj, aVol)
  PlaySound soundname, 1, aVol * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

'Sub PlaySoundAtBall(soundname)
' PlaySoundAt soundname, ActiveBall
'End Sub

Sub PlaySoundAtBall(soundname) ' play a sound at the ball position, like rubbers, targets, metals, plastics
    PlaySound soundname, 0, Vol(ActiveBall), pan(ActiveBall), 0.2, Pitch(ActiveBall) * 10, 0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtBallVol (Soundname, aVol)
  Playsound soundname, 1,aVol * VolumeDial, AudioPan(ActiveBall), 0,0,0, 1, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtBallVolM (Soundname, aVol)
  Playsound soundname, 1,aVol * VolumeDial, AudioPan(ActiveBall), 0,0,0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtVolLoops(sound, tableobj, Vol, Loops)
  PlaySound sound, Loops, Vol * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

'******************************************************
'  Fleep  Supporting Ball & Sound Functions
'******************************************************

Function AudioFade(tableobj) ' Fades between front and back of the table (for surround systems or 2x2 speakers, etc), depending on the Y position on the table. "table1" is the name of the table
  Dim tmp
    tmp = tableobj.y * 2 / tableheight-1

  if tmp > 7000 Then
    tmp = 7000
  elseif tmp < -7000 Then
    tmp = -7000
  end if

    If tmp > 0 Then
    AudioFade = Csng(tmp ^10)
    Else
        AudioFade = Csng(-((- tmp) ^10) )
    End If
End Function

Function AudioPan(tableobj) ' Calculates the pan for a tableobj based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = tableobj.x * 2 / tablewidth-1

  if tmp > 7000 Then
    tmp = 7000
  elseif tmp < -7000 Then
    tmp = -7000
  end if

    If tmp > 0 Then
        AudioPan = Csng(tmp ^10)
    Else
        AudioPan = Csng(-((- tmp) ^10) )
    End If
End Function

Function Vol(ball) ' Calculates the volume of the sound based on the ball speed
  Vol = Csng(BallVel(ball) ^2)
End Function

Function Volz(ball) ' Calculates the volume of the sound based on the ball speed
  Volz = Csng((ball.velz) ^2)
End Function

Function Pitch(ball) ' Calculates the pitch of the sound based on the ball speed
  Pitch = BallVel(ball) * 20
End Function

Function BallVel(ball) 'Calculates the ball speed
  BallVel = INT(SQR((ball.VelX ^2) + (ball.VelY ^2) ) )
End Function

Function VolPlayfieldRoll(ball) ' Calculates the roll volume of the sound based on the ball speed
  VolPlayfieldRoll = RollingSoundFactor * 0.0005 * Csng(BallVel(ball) ^3)
End Function

Function PitchPlayfieldRoll(ball) ' Calculates the roll pitch of the sound based on the ball speed
  PitchPlayfieldRoll = BallVel(ball) ^2 * 15
End Function

Function RndInt(min, max)
  RndInt = Int(Rnd() * (max-min + 1) + min)' Sets a random number integer between min and max
End Function

Function RndNum(min, max)
  RndNum = Rnd() * (max-min) + min' Sets a random number between min and max
End Function

Function RndNbr(n) 'returns a random number between 1 and n
    Randomize timer
    RndNbr = Int((n * Rnd) + 1)
End Function


Function Pan(ball) ' Calculates the pan for a ball based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = ball.x * 2 / TableWidth-1
    If tmp > 0 Then
        Pan = Csng(tmp ^10)
    Else
        Pan = Csng(-((- tmp) ^10))
    End If
End Function

'/////////////////////////////  GENERAL SOUND SUBROUTINES  ////////////////////////////
Sub SoundStartButton()
  PlaySound ("Start_Button"), 0, StartButtonSoundLevel, 0, 0.25
End Sub

Sub SoundNudgeLeft()
  PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeLeftSoundLevel * VolumeDial, -0.1, 0.25
End Sub

Sub SoundNudgeRight()
  PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeRightSoundLevel * VolumeDial, 0.1, 0.25
End Sub

Sub SoundNudgeCenter()
  PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeCenterSoundLevel * VolumeDial, 0, 0.25
End Sub


Sub SoundPlungerPull()
  PlaySoundAtLevelStatic ("Plunger_Pull_1"), PlungerPullSoundLevel, Plunger
End Sub

Sub SoundPlungerReleaseBall()
  PlaySoundAtLevelStatic ("Plunger_Release_Ball"), PlungerReleaseSoundLevel, Plunger
End Sub

Sub SoundPlungerReleaseNoBall()
  PlaySoundAtLevelStatic ("Plunger_Release_No_Ball"), PlungerReleaseSoundLevel, Plunger
End Sub


'/////////////////////////////  KNOCKER SOLENOID  ////////////////////////////
Sub KnockerSolenoid()
  PlaySoundAtLevelStatic SoundFX("Knocker_1",DOFKnocker), KnockerSoundLevel, KnockerPosition
End Sub

'/////////////////////////////  DRAIN SOUNDS  ////////////////////////////
Sub RandomSoundDrain(drainswitch)
  PlaySoundAtLevelStatic ("Drain_" & Int(Rnd*11)+1), DrainSoundLevel, drainswitch
End Sub

'/////////////////////////////  TROUGH BALL RELEASE SOLENOID SOUNDS  ////////////////////////////

Sub RandomSoundBallRelease(drainswitch)
  PlaySoundAtLevelStatic SoundFX("BallRelease" & Int(Rnd*7)+1,DOFContactors), BallReleaseSoundLevel, drainswitch
End Sub

'/////////////////////////////  SLINGSHOT SOLENOID SOUNDS  ////////////////////////////
Sub RandomSoundSlingshotLeft(sling)
    DOF 106, DOFPulse
  PlaySoundAtLevelStatic SoundFX("Sling_L" & Int(Rnd*10)+1,DOFContactors), SlingshotSoundLevel, Sling
End Sub

Sub RandomSoundSlingshotRight(sling)
    DOF 107, DOFPulse
  PlaySoundAtLevelStatic SoundFX("Sling_R" & Int(Rnd*8)+1,DOFContactors), SlingshotSoundLevel, Sling
End Sub

'/////////////////////////////  BUMPER SOLENOID SOUNDS  ////////////////////////////
Sub RandomSoundBumperTop(Bump)
    DOF 103, DOFPulse
  PlaySoundAtLevelStatic SoundFX("Bumpers_Top_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

Sub RandomSoundBumperMiddle(Bump)
    DOF 104, DOFPulse
  PlaySoundAtLevelStatic SoundFX("Bumpers_Middle_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

Sub RandomSoundBumperBottom(Bump)
    DOF 105, DOFPulse
  PlaySoundAtLevelStatic SoundFX("Bumpers_Bottom_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

'/////////////////////////////  SPINNER SOUNDS  ////////////////////////////
Sub SoundSpinner(spinnerswitch)
  PlaySoundAtLevelStatic ("Spinner"), SpinnerSoundLevel, spinnerswitch
End Sub


'/////////////////////////////  FLIPPER BATS SOUND SUBROUTINES  ////////////////////////////
'/////////////////////////////  FLIPPER BATS SOLENOID ATTACK SOUND  ////////////////////////////
Sub SoundFlipperUpAttackLeft(flipper)
  FlipperUpAttackLeftSoundLevel = RndNum(FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel)
  PlaySoundAtLevelStatic ("Flipper_Attack-L01"), FlipperUpAttackLeftSoundLevel, flipper
End Sub

Sub SoundFlipperUpAttackRight(flipper)
  FlipperUpAttackRightSoundLevel = RndNum(FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel)
  PlaySoundAtLevelStatic ("Flipper_Attack-R01"), FlipperUpAttackLeftSoundLevel, flipper
End Sub

'/////////////////////////////  FLIPPER BATS SOLENOID CORE SOUND  ////////////////////////////
Sub RandomSoundFlipperUpLeft(flipper)
  PlaySoundAtLevelStatic SoundFX("Flipper_L0" & Int(Rnd*9)+1,DOFFlippers), FlipperLeftHitParm, Flipper
End Sub

Sub RandomSoundFlipperUpRight(flipper)
  PlaySoundAtLevelStatic SoundFX("Flipper_R0" & Int(Rnd*9)+1,DOFFlippers), FlipperRightHitParm, Flipper
End Sub

Sub RandomSoundReflipUpLeft(flipper)
  PlaySoundAtLevelStatic SoundFX("Flipper_ReFlip_L0" & Int(Rnd*3)+1,DOFFlippers), (RndNum(0.8, 1))*FlipperUpSoundLevel, Flipper
End Sub

Sub RandomSoundReflipUpRight(flipper)
  PlaySoundAtLevelStatic SoundFX("Flipper_ReFlip_R0" & Int(Rnd*3)+1,DOFFlippers), (RndNum(0.8, 1))*FlipperUpSoundLevel, Flipper
End Sub

Sub RandomSoundFlipperDownLeft(flipper)
  PlaySoundAtLevelStatic SoundFX("Flipper_Left_Down_" & Int(Rnd*7)+1,DOFFlippers), FlipperDownSoundLevel, Flipper
End Sub

Sub RandomSoundFlipperDownRight(flipper)
  PlaySoundAtLevelStatic SoundFX("Flipper_Right_Down_" & Int(Rnd*8)+1,DOFFlippers), FlipperDownSoundLevel, Flipper
End Sub

'/////////////////////////////  FLIPPER BATS BALL COLLIDE SOUND  ////////////////////////////

Sub LeftFlipperCollide(parm)
  FlipperLeftHitParm = parm/10
  If FlipperLeftHitParm > 1 Then
    FlipperLeftHitParm = 1
  End If
  FlipperLeftHitParm = FlipperUpSoundLevel * FlipperLeftHitParm
  RandomSoundRubberFlipper(parm)
End Sub

Sub RightFlipperCollide(parm)
  FlipperRightHitParm = parm/10
  If FlipperRightHitParm > 1 Then
    FlipperRightHitParm = 1
  End If
  FlipperRightHitParm = FlipperUpSoundLevel * FlipperRightHitParm
  RandomSoundRubberFlipper(parm)
End Sub

Sub RandomSoundRubberFlipper(parm)
  PlaySoundAtLevelActiveBall ("Flipper_Rubber_" & Int(Rnd*7)+1), parm  * RubberFlipperSoundFactor
End Sub

'/////////////////////////////  ROLLOVER SOUNDS  ////////////////////////////
Sub RandomSoundRollover()
    DOF 164, DOFPulse
  PlaySoundAtLevelActiveBall ("Rollover_" & Int(Rnd*4)+1), RolloverSoundLevel
End Sub

Sub Rollovers_Hit(idx)
  RandomSoundRollover
End Sub

'/////////////////////////////  VARIOUS PLAYFIELD SOUND SUBROUTINES  ////////////////////////////
'/////////////////////////////  RUBBERS AND POSTS  ////////////////////////////
'/////////////////////////////  RUBBERS - EVENTS  ////////////////////////////
Sub Rubbers_Hit(idx)
  dim finalspeed
  finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
  If finalspeed > 5 then
    RandomSoundRubberStrong 1
  End if
  If finalspeed <= 5 then
    RandomSoundRubberWeak()
  End If
End Sub

'/////////////////////////////  RUBBERS AND POSTS - STRONG IMPACTS  ////////////////////////////
Sub RandomSoundRubberStrong(voladj)
  Select Case Int(Rnd*10)+1
    Case 1 : PlaySoundAtLevelActiveBall ("Rubber_Strong_1"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 2 : PlaySoundAtLevelActiveBall ("Rubber_Strong_2"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 3 : PlaySoundAtLevelActiveBall ("Rubber_Strong_3"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 4 : PlaySoundAtLevelActiveBall ("Rubber_Strong_4"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 5 : PlaySoundAtLevelActiveBall ("Rubber_Strong_5"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 6 : PlaySoundAtLevelActiveBall ("Rubber_Strong_6"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 7 : PlaySoundAtLevelActiveBall ("Rubber_Strong_7"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 8 : PlaySoundAtLevelActiveBall ("Rubber_Strong_8"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 9 : PlaySoundAtLevelActiveBall ("Rubber_Strong_9"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
    Case 10 : PlaySoundAtLevelActiveBall ("Rubber_1_Hard"), Vol(ActiveBall) * RubberStrongSoundFactor * 0.6*voladj
  End Select
End Sub

'/////////////////////////////  RUBBERS AND POSTS - WEAK IMPACTS  ////////////////////////////
Sub RandomSoundRubberWeak()
  PlaySoundAtLevelActiveBall ("Rubber_" & Int(Rnd*9)+1), Vol(ActiveBall) * RubberWeakSoundFactor
End Sub

'/////////////////////////////  WALL IMPACTS  ////////////////////////////
Sub Walls_Hit(idx)
  RandomSoundWall()
End Sub

Sub RandomSoundWall()
  dim finalspeed
  finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
  If finalspeed > 16 then
    Select Case Int(Rnd*5)+1
      Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_1"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_2"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_5"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 4 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_7"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 5 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_9"), Vol(ActiveBall) * WallImpactSoundFactor
    End Select
  End if
  If finalspeed >= 6 AND finalspeed <= 16 then
    Select Case Int(Rnd*4)+1
      Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_3"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_4"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_6"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 4 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_8"), Vol(ActiveBall) * WallImpactSoundFactor
    End Select
  End If
  If finalspeed < 6 Then
    Select Case Int(Rnd*3)+1
      Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_4"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_6"), Vol(ActiveBall) * WallImpactSoundFactor
      Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_8"), Vol(ActiveBall) * WallImpactSoundFactor
    End Select
  End if
End Sub

'/////////////////////////////  METAL TOUCH SOUNDS  ////////////////////////////
Sub RandomSoundMetal()
  PlaySoundAtLevelActiveBall ("Metal_Touch_" & Int(Rnd*13)+1), Vol(ActiveBall) * MetalImpactSoundFactor
End Sub

'/////////////////////////////  METAL - EVENTS  ////////////////////////////

Sub Metals_Hit (idx)
  RandomSoundMetal
End Sub

Sub ShooterDiverter_collide(idx)
  RandomSoundMetal
End Sub

'/////////////////////////////  BOTTOM ARCH BALL GUIDE  ////////////////////////////
'/////////////////////////////  BOTTOM ARCH BALL GUIDE - SOFT BOUNCES  ////////////////////////////
Sub RandomSoundBottomArchBallGuide()
  dim finalspeed
  finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
  If finalspeed > 16 then
    PlaySoundAtLevelActiveBall ("Apron_Bounce_"& Int(Rnd*2)+1), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
  End if
  If finalspeed >= 6 AND finalspeed <= 16 then
    Select Case Int(Rnd*2)+1
      Case 1 : PlaySoundAtLevelActiveBall ("Apron_Bounce_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
      Case 2 : PlaySoundAtLevelActiveBall ("Apron_Bounce_Soft_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
    End Select
  End If
  If finalspeed < 6 Then
    Select Case Int(Rnd*2)+1
      Case 1 : PlaySoundAtLevelActiveBall ("Apron_Bounce_Soft_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
      Case 2 : PlaySoundAtLevelActiveBall ("Apron_Medium_3"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
    End Select
  End if
End Sub

'/////////////////////////////  BOTTOM ARCH BALL GUIDE - HARD HITS  ////////////////////////////
Sub RandomSoundBottomArchBallGuideHardHit()
  PlaySoundAtLevelActiveBall ("Apron_Hard_Hit_" & Int(Rnd*3)+1), BottomArchBallGuideSoundFactor * 0.25
End Sub

Sub dApron_Hit (idx)
  RandomSoundBottomArchBallGuide
exit sub
'Debug3 "idx: "&idx
'Debug3 "ActiveballID: "&activeball.id
'Debug3 "X-Value: "&cor.ballvelx(activeball.id)
'Debug3 "Y-Value: "&cor.ballvely(activeball.id)
  If Abs(cor.ballvelx(activeball.id) < 4) and Abs(cor.ballvely(activeball.id) > 7) then
    RandomSoundBottomArchBallGuideHardHit()
  Else
    RandomSoundBottomArchBallGuide
  End If
'RandomSoundBottomArchBallGuide
End Sub

'/////////////////////////////  FLIPPER BALL GUIDE  ////////////////////////////
Sub RandomSoundFlipperBallGuide()
  dim finalspeed
  finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
  If finalspeed > 16 then
    Select Case Int(Rnd*2)+1
      Case 1 : PlaySoundAtLevelActiveBall ("Apron_Hard_1"),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
      Case 2 : PlaySoundAtLevelActiveBall ("Apron_Hard_2"),  Vol(ActiveBall) * 0.8 * FlipperBallGuideSoundFactor
    End Select
  End if
  If finalspeed >= 6 AND finalspeed <= 16 then
    PlaySoundAtLevelActiveBall ("Apron_Medium_" & Int(Rnd*3)+1),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
  End If
  If finalspeed < 6 Then
    PlaySoundAtLevelActiveBall ("Apron_Soft_" & Int(Rnd*7)+1),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
  End If
End Sub

'/////////////////////////////  TARGET HIT SOUNDS  ////////////////////////////
Sub RandomSoundTargetHitStrong()
  PlaySoundAtLevelActiveBall SoundFX("Target_Hit_" & Int(Rnd*4)+5,DOFTargets), Vol(ActiveBall) * 0.45 * TargetSoundFactor
End Sub

Sub RandomSoundTargetHitWeak()
  PlaySoundAtLevelActiveBall SoundFX("Target_Hit_" & Int(Rnd*4)+1,DOFTargets), Vol(ActiveBall) * TargetSoundFactor
End Sub

Sub PlayTargetSound()
  dim finalspeed
  finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
  If finalspeed > 10 then
    RandomSoundTargetHitStrong()
    RandomSoundBallBouncePlayfieldSoft Activeball
  Else
    RandomSoundTargetHitWeak()
  End If
End Sub

Sub Targets_Hit (idx)
    DOF 120, DOFPulse
  PlayTargetSound
End Sub

'/////////////////////////////  BALL BOUNCE SOUNDS  ////////////////////////////
Sub RandomSoundBallBouncePlayfieldSoft(aBall)
  Select Case Int(Rnd*9)+1
    Case 1 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_1"), volz(aBall) * BallBouncePlayfieldSoftFactor, aBall
    Case 2 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_2"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.5, aBall
    Case 3 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_3"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.8, aBall
    Case 4 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_4"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.5, aBall
    Case 5 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_5"), volz(aBall) * BallBouncePlayfieldSoftFactor, aBall
    Case 6 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_1"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
    Case 7 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_2"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
    Case 8 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_5"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
    Case 9 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_7"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.3, aBall
  End Select
End Sub

Sub RandomSoundBallBouncePlayfieldHard(aBall)
  PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_" & Int(Rnd*7)+1), volz(aBall) * BallBouncePlayfieldHardFactor, aBall
End Sub

'/////////////////////////////  DELAYED DROP - TO PLAYFIELD - SOUND  ////////////////////////////
Sub RandomSoundDelayedBallDropOnPlayfield(aBall)
  Select Case Int(Rnd*5)+1
    Case 1 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_1_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
    Case 2 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_2_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
    Case 3 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_3_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
    Case 4 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_4_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
    Case 5 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_5_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
  End Select
End Sub

'/////////////////////////////  BALL GATES AND BRACKET GATES SOUNDS  ////////////////////////////

Sub SoundPlayfieldGate()
  PlaySoundAtLevelStatic ("Gate_FastTrigger_" & Int(Rnd*2)+1), GateSoundLevel, Activeball
End Sub

Sub SoundHeavyGate()
  PlaySoundAtLevelStatic ("Gate_2"), GateSoundLevel, Activeball
End Sub

Sub Gates_hit(idx)
  SoundHeavyGate
End Sub

Sub GatesWire_hit(idx)
  SoundPlayfieldGate
End Sub

'/////////////////////////////  LEFT LANE ENTRANCE - SOUNDS  ////////////////////////////

Sub RandomSoundLeftArch()
  PlaySoundAtLevelActiveBall ("Arch_L" & Int(Rnd*4)+1), Vol(ActiveBall) * ArchSoundFactor
End Sub

Sub RandomSoundRightArch()
  PlaySoundAtLevelActiveBall ("Arch_R" & Int(Rnd*4)+1), Vol(ActiveBall) * ArchSoundFactor
End Sub


Sub Arch1_hit()
  If Activeball.velx > 1 Then SoundPlayfieldGate
  StopSound "Arch_L1"
  StopSound "Arch_L2"
  StopSound "Arch_L3"
  StopSound "Arch_L4"
End Sub

Sub Arch1_unhit()
  If activeball.velx < -8 Then
    RandomSoundRightArch
  End If
End Sub

Sub Arch2_hit()
    DOF 238, DOFPulse
  If Activeball.velx < 1 Then SoundPlayfieldGate
  StopSound "Arch_R1"
  StopSound "Arch_R2"
  StopSound "Arch_R3"
  StopSound "Arch_R4"
End Sub

Sub Arch2_unhit()
  If activeball.velx > 10 Then
    RandomSoundLeftArch
  End If
End Sub

'/////////////////////////////  SAUCERS (KICKER HOLES)  ////////////////////////////

Sub SoundSaucerLock()
  PlaySoundAtLevelStatic ("Saucer_Enter_" & Int(Rnd*2)+1), SaucerLockSoundLevel, Activeball
End Sub

Sub SoundSaucerKick(scenario, saucer)
  Select Case scenario
    Case 0: PlaySoundAtLevelStatic SoundFX("Saucer_Empty", DOFContactors), SaucerKickSoundLevel, saucer
    Case 1: PlaySoundAtLevelStatic SoundFX("Saucer_Kick", DOFContactors), SaucerKickSoundLevel, saucer
  End Select
End Sub

'/////////////////////////////  BALL COLLISION SOUND  ////////////////////////////
Sub OnBallBallCollision(ball1, ball2, velocity)
  Dim snd
  Select Case Int(Rnd*7)+1
    Case 1 : snd = "Ball_Collide_1"
    Case 2 : snd = "Ball_Collide_2"
    Case 3 : snd = "Ball_Collide_3"
    Case 4 : snd = "Ball_Collide_4"
    Case 5 : snd = "Ball_Collide_5"
    Case 6 : snd = "Ball_Collide_6"
    Case 7 : snd = "Ball_Collide_7"
  End Select

  PlaySound (snd), 0, Csng(velocity) ^2 / 200 * BallWithBallCollisionSoundFactor * VolumeDial, AudioPan(ball1), 0, Pitch(ball1), 0, 0, AudioFade(ball1)
End Sub


'///////////////////////////  DROP TARGET HIT SOUNDS  ///////////////////////////

Sub RandomSoundDropTargetReset(obj)
    DOF 161, DOFPulse
  PlaySoundAtLevelStatic SoundFX("Drop_Target_Reset_" & Int(Rnd*6)+1,DOFContactors), 1, obj
End Sub

Sub SoundDropTargetDrop(obj)
  PlaySoundAtLevelStatic ("Drop_Target_Down_" & Int(Rnd*6)+1), 200, obj
End Sub

'/////////////////////////////  GI AND FLASHER RELAYS  ////////////////////////////

Const RelayFlashSoundLevel = 0.315                  'volume level; range [0, 1];
Const RelayGISoundLevel = 1.05                  'volume level; range [0, 1];

Sub Sound_GI_Relay(toggle, obj)
  Select Case toggle
    Case 1
      PlaySoundAtLevelStatic ("Relay_GI_On"), 0.025*RelayGISoundLevel, obj
    Case 0
      PlaySoundAtLevelStatic ("Relay_GI_Off"), 0.025*RelayGISoundLevel, obj
  End Select
End Sub

Sub Sound_Flash_Relay(toggle, obj)
  Select Case toggle
    Case 1
      PlaySoundAtLevelStatic ("Relay_Flash_On"), 0.025*RelayFlashSoundLevel, obj
    Case 0
      PlaySoundAtLevelStatic ("Relay_Flash_Off"), 0.025*RelayFlashSoundLevel, obj
  End Select
End Sub

'/////////////////////////////////////////////////////////////////
'         End Mechanical Sounds
'/////////////////////////////////////////////////////////////////

'******************************************************
'  SLINGSHOT CORRECTION FUNCTIONS
'******************************************************
' To add these slingshot corrections:
'   - On the table, add the endpoint primitives that define the two ends of the Slingshot
' - Initialize the SlingshotCorrection objects in InitSlingCorrection
'   - Call the .VelocityCorrect methods from the respective _Slingshot event sub


dim LS : Set LS = New SlingshotCorrection
dim RS : Set RS = New SlingshotCorrection

InitSlingCorrection

Sub InitSlingCorrection

  LS.Object = LeftSlingshot
  LS.EndPoint1 = EndPoint1LS
  LS.EndPoint2 = EndPoint2LS

  RS.Object = RightSlingshot
  RS.EndPoint1 = EndPoint1RS
  RS.EndPoint2 = EndPoint2RS

  'Slingshot angle corrections (pt, BallPos in %, Angle in deg)
  ' These values are best guesses. Retune them if needed based on specific table research.
  AddSlingsPt 0, 0.00,  -4
  AddSlingsPt 1, 0.45,  -7
  AddSlingsPt 2, 0.48,  0
  AddSlingsPt 3, 0.52,  0
  AddSlingsPt 4, 0.55,  7
  AddSlingsPt 5, 1.00,  4

End Sub


Sub AddSlingsPt(idx, aX, aY)        'debugger wrapper for adjusting flipper script in-game
  dim a : a = Array(LS, RS)
  dim x : for each x in a
    x.addpoint idx, aX, aY
  Next
End Sub

'' The following sub are needed, however they may exist somewhere else in the script. Uncomment below if needed
'Dim PI: PI = 4*Atn(1)
'Function dSin(degrees)
' dsin = sin(degrees * Pi/180)
'End Function
'Function dCos(degrees)
' dcos = cos(degrees * Pi/180)
'End Function
'
Function RotPoint(x,y,angle)
    dim rx, ry
    rx = x*dCos(angle) - y*dSin(angle)
    ry = x*dSin(angle) + y*dCos(angle)
    RotPoint = Array(rx,ry)
End Function

Class SlingshotCorrection
  Public DebugOn, Enabled
  private Slingshot, SlingX1, SlingX2, SlingY1, SlingY2

  Public ModIn, ModOut
  Private Sub Class_Initialize : redim ModIn(0) : redim Modout(0): Enabled = True : End Sub

  Public Property let Object(aInput) : Set Slingshot = aInput : End Property
  Public Property Let EndPoint1(aInput) : SlingX1 = aInput.x: SlingY1 = aInput.y: End Property
  Public Property Let EndPoint2(aInput) : SlingX2 = aInput.x: SlingY2 = aInput.y: End Property

  Public Sub AddPoint(aIdx, aX, aY)
    ShuffleArrays ModIn, ModOut, 1 : ModIn(aIDX) = aX : ModOut(aIDX) = aY : ShuffleArrays ModIn, ModOut, 0
    If gametime > 100 then Report
  End Sub

  Public Sub Report()         'debug, reports all coords in tbPL.text
    If not debugOn then exit sub
    dim a1, a2 : a1 = ModIn : a2 = ModOut
    dim str, x : for x = 0 to uBound(a1) : str = str & x & ": " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    TBPout.text = str
  End Sub


  Public Sub VelocityCorrect(aBall)
    dim BallPos, XL, XR, YL, YR

    'Assign right and left end points
    If SlingX1 < SlingX2 Then
      XL = SlingX1 : YL = SlingY1 : XR = SlingX2 : YR = SlingY2
    Else
      XL = SlingX2 : YL = SlingY2 : XR = SlingX1 : YR = SlingY1
    End If

    'Find BallPos = % on Slingshot
    If Not IsEmpty(aBall.id) Then
      If ABS(XR-XL) > ABS(YR-YL) Then
        BallPos = PSlope(aBall.x, XL, 0, XR, 1)
      Else
        BallPos = PSlope(aBall.y, YL, 0, YR, 1)
      End If
      If BallPos < 0 Then BallPos = 0
      If BallPos > 1 Then BallPos = 1
    End If

    'Velocity angle correction
    If not IsEmpty(ModIn(0) ) then
      Dim Angle, RotVxVy
      Angle = LinearEnvelope(BallPos, ModIn, ModOut)
      'debug3 " BallPos=" & BallPos &" Angle=" & Angle
      'debug3 " BEFORE: aBall.Velx=" & aBall.Velx &" aBall.Vely" & aBall.Vely
      RotVxVy = RotPoint(aBall.Velx,aBall.Vely,Angle)
      If Enabled then aBall.Velx = RotVxVy(0)
      If Enabled then aBall.Vely = RotVxVy(1)
      'debug3 " AFTER: aBall.Velx=" & aBall.Velx &" aBall.Vely" & aBall.Vely
      'debug3 " "
    End If
  End Sub

End Class




'*************************
'   Side modes
'*************************
'uses LeftSpinnerCount, RightSpinnerCount,spinerstotal, blacksmith and blacksmith2

'******************************
'PuP DMD Display Routines
'******************************
Sub DisplaySpinCount
    SpinnersTotal = LeftSpinnerCount(CurrentPlayer) &"/" &RightSpinnerCount(CurrentPlayer)
    'Debug2 "SpinnersTotal:" &SpinnersTotal
    if DMDType = 2 Then
      PuPlayer.LabelSet pDMD,"spinnercounts",SpinnersTotal,1,"{'mt':2,'size': 3.25, 'xpos': 28.3, 'xalign': 1, 'ypos': 15.6, 'yalign': 1 }"
    Elseif DMDType = 1 Then
      PuPlayer.LabelSet pDMD,"spinnercounts",SpinnersTotal,1,"{'mt':2,'size': 6, 'xpos': 36.0, 'xalign': 1, 'ypos': 96.5, 'yalign': 1 }"
    Elseif DMDType = 0 Then
      PuPlayer.LabelSet pBackglass,"spinnercounts",SpinnersTotal,1,"{'mt':2,'size': 2.75, 'xpos': 35.8, 'xalign': 1, 'ypos': 10.3, 'yalign': 1 }"
    End If
' Else
'   Debug "Side Mission Active: " &BSMode &":" &GMode &":" &TMode
' End If
End Sub

Sub DisplayRampCounts
    TotalRampHits
    if DMDType = 2 Then
      PuPlayer.LabelSet pDMD,"rampcounts",RampHits,1,"{'mt':2,'size': 3.25, 'xpos': 38.8, 'xalign': 1, 'ypos': 15.6, 'yalign': 1 }"
    Elseif DMDType = 1 Then
      PuPlayer.LabelSet pDMD,"rampcounts",RampHits,1,"{'mt':2,'size': 6, 'xpos': 43.3, 'xalign': 1, 'ypos': 96.5, 'yalign': 1 }"
    Elseif DMDType = 0 Then
      PuPlayer.LabelSet pBackglass,"rampcounts",RampHits,1,"{'mt':2,'size': 2.75, 'xpos': 43.0, 'xalign': 1, 'ypos': 10.3, 'yalign': 1 }"
    End If
' Else
'   Debug "Side Mission Active: " &BSMode &":" &GMode &":" &TMode
' End If
End Sub

Sub DisplayTorchCount
    TorchTotal = TorchHits(CurrentPlayer) &"/" & TorchReq
    if DMDType = 2 Then
      PuPlayer.LabelSet pDMD,"torchcounts",TorchTotal,1,"{'mt':2,'size': 3.25, 'xpos': 49.4, 'xalign': 1, 'ypos': 15.6, 'yalign': 1 }"
    Elseif DMDType = 1 Then
      PuPlayer.LabelSet pDMD,"torchcounts",TorchTotal,1,"{'mt':2,'size': 6, 'xpos': 50.2, 'xalign': 1, 'ypos': 96.5, 'yalign': 1 }"
    Elseif DMDType = 0 Then
      PuPlayer.LabelSet pBackglass,"torchcounts",TorchTotal,1,"{'mt':2,'size': 2.75, 'xpos': 50.4, 'xalign': 1, 'ypos': 10.3, 'yalign': 1 }"
    End If
' Else
'   Debug "Side Mission Active: " &BSMode &":" &GMode &":" &TMode
' End If
End Sub

Sub DisplaySacksOfGold
  if DMDType = 2 Then
    PuPlayer.LabelSet pDMD,"GoldSackCount",GoldSack(CurrentPlayer),1,"{'mt':2,'size': 3.25, 'xpos': 59.25, 'xalign': 1, 'ypos': 15.6, 'yalign': 1 }"
  Elseif DMDType = 1 Then
    PuPlayer.LabelSet pDMD,"GoldSackCount",GoldSack(CurrentPlayer),1,"{'mt':2,'size': 6, 'xpos': 57.1, 'xalign': 1, 'ypos': 96.5, 'yalign': 1 }"
  Elseif DMDType = 0 Then
    PuPlayer.LabelSet pBackglass,"GoldSackCount",GoldSack(CurrentPlayer),1,"{'mt':2,'size': 2.75, 'xpos': 57, 'xalign': 1, 'ypos': 10.3, 'yalign': 1 }"
  End If
End Sub

Sub DisplayMagnetMessages
  if bMagnetCaptured = True Then
    if DMDType = 0 Then
      pBackglassPNGAnimate "MagnetLocked", 120
      PuPlayer.LabelSet pBackglass,"MagnetLockedText","CAPTURED",1,"{'mt':2, 'size': 2.25, 'xpos': 64.0, 'xalign': 1, 'ypos': 10.2, 'yalign': 1 }"
    Else
      pDMDPNGAnimate "MagnetLocked", 120
      if DMDType = 2 Then
        PuPlayer.LabelSet pDMD,"MagnetLockedText","CAPTURED",1,"{'mt':2, 'size': 3.25, 'xpos': 69.6, 'xalign': 1, 'ypos': 15.6, 'yalign': 1 }"
      Else
        PuPlayer.LabelSet pDMD,"MagnetLockedText","CAPTURED",1,"{'mt':2,'size': 5.1, 'xpos': 64.0, 'xalign': 1, 'ypos': 96.5, 'yalign': 1 }"
      End If
    End If
  End If
End Sub

Sub HideRampCounts
  if DMDType = 0 Then
    'PuPlayer.LabelSet pBackglass,"rampcounts","",0,""
  Else
    PuPlayer.LabelSet pDMD,"rampcounts","",0,""
  End If
End Sub

Sub HideSpinCount
  if DMDType = 0 Then
    'PuPlayer.LabelSet pBackglass,"spinnercounts","",0,""
  Else
    PuPlayer.LabelSet pDMD,"spinnercounts","",0,""
  End If
End Sub

Sub HideTorchCount
  if DMDType = 0 Then
    'PuPlayer.LabelSet pBackglass,"torchcounts","",0,""
  Else
    PuPlayer.LabelSet pDMD,"torchcounts","",0,""
  End If
End Sub

Sub HideGoldSackCount
  if DMDType = 0 Then
    'PuPlayer.LabelSet pBackglass,"GoldSackCount","",0,""
  Else
    PuPlayer.LabelSet pDMD,"GoldSackCount","",0,""
  End If
End Sub

'******************************

sub ResetSpinnerCounts
  LeftSpinnerCount(CurrentPlayer) = 0
  RightSpinnerCount(CurrentPlayer) = 0
end Sub


Sub LeftSpinCount

  if CountBSLeftSpin <> 0 And Mode(CurrentPlayer,0) = 0 And Missions(CurrentPlayer,1) = 0 Then
    LeftSpinnerCount(CurrentPlayer) = LeftSpinnercount(CurrentPlayer) + 1
    DisplaySpincount
    CheckLeftSpinWin
  end if

End sub

Sub RightSpinCount
  if CountBSRightSpin <> 0 And Mode(CurrentPlayer,0) = 0 And Missions(CurrentPlayer,1) = 0 Then
    RightSpinnerCount(CurrentPlayer) = RightSpinnerCount(CurrentPlayer) + 1
    DisplaySpincount
    CheckRightSpinWin
  end if

End sub

Sub CheckLeftSpinWin
  if CountBSRightSpin = 0 And CountBSLeftSpin = 0 Then
    Debug "Blacksmith Mode Start"
    BlacksmithMode
    CountBSRightSpin = 2
    CountBSLeftSpin = 2
  Elseif LeftSpinnerCount(CurrentPlayer) > SpinReq - 1 Then
    CountBSLeftSpin = 0
  End If
End Sub

Sub CheckRightSpinWin
  if CountBSRightSpin = 0 And CountBSLeftSpin = 0 Then
    Debug "Blacksmith Mode Start"
    BlacksmithMode
    CountBSRightSpin = 2
    CountBSLeftSpin = 2
  Elseif RightSpinnerCount(CurrentPlayer) > SpinReq - 1 Then
    CountBSRightSpin = 0
  End If
End Sub

Sub BlacksmithMode
BlacksmithModeExpired.Interval = BlacksmithTime * 1000
  ResetLaneLights
  bSupressBGMessages = True

  GetAM
  if ActiveMode <> 0 Then
    LeftSpinCount(CurrentPlayer) = SpinReq-1
    Exit Sub
  End If
  if ActiveMode <> 1 And GMode <> 1 And Tmode <> 1Then ' Make sure in Mode 0 and not in Gamble Mode
    if bMultiBallMode = 0 Then
      BSMode = 1
      li060.state = 2
      li047.state = 0 ' turn off Inn light
      ModeTitle = "Blacksmith Mission"
            DOF 163, DOFOn
      UpdateModeLabels
      Missions(CurrentPlayer,1) = 1
      GeneralPupQueue.Add "Pup830","pupevent 830",40,0,0,0,0,False
      if DMDType = 0 Then
        GeneralPupQueue.Add "Pup450","pupevent 450",94,0,0,0,0,True
      Else
        GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
      End If
      AudioQueue.Add "Pup297","PuPEvent 297",93,0,0,0,0,False' Event Start audio
      Triggerscript 3100, "BlacksmithAudio" ' Audio
      ResetBSMode

      bBSAll = 1 ' SET flag for bonus if collect all shots
      'CountDownMessage1 = "Follow the Flashing Lights"
      'CountDownMessage2 = "To Earn Bonuses"
      'CountDownMessage3 = "Super Bonus at the End
      CountDownMessage1 = "7 Shots Remain"
    End If

  End If
  'ScorbitBuildGameModes
end sub

Sub BlacksmithAudio
  AudioQueue.Add "Pup432","PuPEvent 432",30,0,0,0,0,False
End Sub

Sub CheckBlacksmithWin

  DOFModesOff


  if Missions(CurrentPlayer,1) = 7 Then   ' Blacksmith Mode Finish Check
    Missions(CurrentPlayer,1) = 0  ' Blacksmith Finished so reset to 0
    'Playsound "hammer"
    PuPEvent 292
    'ResetModes
    BlacksmithModeTimer.Enabled = 0
    BlacksmithModeExpired.Enabled = 0
    'GeneralPupQueue.Add "Pup900","pupevent 900",95,0,0,0,0,True
    ClearBlacksmithPup
    ClearPupMessages
    Debug "Blacksmith Count: "&Missions(CurrentPlayer,1) ' Should be 7
    li040.state = 0
    li036.state = 0
    li037.state = 0
    li051.state = 0
    li060.state = 0
    li039.state = 0
    Addscore2 Score_BlacksmithLevel
    li038.state = 0
    li047.state = 2
    bSupressBGMessages = False
      if bBSAll = 1 Then
        pDMDlabelshow "BlacksmithOn"    ' Turn on the Blacksmith Mode completion spinner for top overlay
                DOF 163, DOFOff
        Addscore2 Score_BlacksmithWin
        GoldSack(CurrentPlayer) = GoldSack(CurrentPlayer) + 1
        DisplaySacksOfGold
        Missions(CurrentPlayer,1) = 9 ' Closed and Completed super bonus
        ScorbitBuildGameModes
        'AudioQueue.Add "Pup280","PuPEvent 280",35,0,0,0,AudioExpiry,False
        GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
        if DMDType = 0 Then
          GeneralPupQueue.Add "Pup400","pupevent 400",95,0,0,0,0,True
          pBackglasslabelshow "BlacksmithOn"
        End If
        GeneralPupQueue.Add "Pup836","pupevent 836",42,0,0,0,0,True ' complete BS Mode
        GeneralPupQueue.Add "ReturnToVillage","ReturnToVillage",95,5000,0,0,0,True
        AudioQueue.Add "Pup233","PuPEvent 233",35,5000,0,0,AudioExpiry,False
        BSMode = 2  ' At the last stop so turn off Blacksmith mode
        pDMDlabelshow "BlacksmithOn"
      'Else
        'AudioQueue.Add "Pup281","PuPEvent 281",35,0,0,0,AudioExpiry,False
      ' AudioQueue.Add "Pup233","PuPEvent 233",35,3000,0,0,AudioExpiry,False
      End If

  End if
  'AudioQueue.Add "Pup445","PuPEvent 445",35,8000,0,0,AudioExpiry,False

End Sub

Sub ResetBlacksmithLights
 ResetLaneLights

End Sub


Sub BlacksmithFail
  BlacksmithClear
  ClearBlacksmithPup
  'ResetModes
    DOF 163, DOFOff
' if Missions(CurrentPlayer,1) <> 8  Then ' Reset Blacksmith mode
  GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
  GeneralPupQueue.Add "Pup835","pupevent 835",42,0,0,0,0,True
  GeneralPupQueue.Add "ReturnToVillage","ReturnToVillage",95,5150,0,0,0,True
  AudioQueue.Add "Pup233","PuPEvent 233",35,5200,0,0,AudioExpiry,False
  ResetSpinnerCounts
  DisplayOverlayCounts
' End If
  'ScorbitBuildGameModes
End Sub

Sub BlacksmithClear
  bSupressBGMessages = False
  DOFModesOff
  ResetLaneLights
  li038.state = 0
  BSMode = 0
    DOF 163, DOFOff
  if Missions(CurrentPlayer,1) <> 9  Then ' Reset Blacksmith mode
    resetspinnerCounts
    Missions(CurrentPlayer,1) = 0
    EOBReturn "Blacksmith Fail"
  End If
  ClearBlacksmithPup
  ClearPupMessages
  CountBSLeftSpin = 1
  CountBSRightSpin = 1
  BlacksmithModeTimer.Enabled = 0
  BlacksmithModeExpired.Enabled = 0
  ResetUPF
End Sub


Sub HideInTheDarkMessages
    PuPlayer.LabelSet pBackglass, "TorchHitsMessage" ,"",  1, ""
    PuPlayer.LabelSet pBackglass, "TorchCountDownTimerOn" ,"",  1, ""
End Sub

Sub InTheDarkFail
  'PlayVillageMusic 100

  InTheDarkClear
  DarknessLayer.Opacity = DefaultDarkness
  'AudioQueue.Add "Pup283","PuPEvent 283",35,0,0,0,AudioExpiry,False
  GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
  GeneralPupQueue.Add "Pup839","pupevent 839",95,0,0,0,0,True
  GeneralPupQueue.Add "ReturnToVillage","ReturnToVillage",95,5150,0,0,0,True
  AudioQueue.Add "Pup233","PuPEvent 233",20,5200,0,0,AudioExpiry,False

  li047.state = 2
  'ResetModes
  'ScorbitBuildGameModes
End Sub

Sub InTheDarkClear
  bSupressBGMessages = False
  DOFModesOff
  TMode = 0
  HideInTheDarkMessages
  ResetTorchLightColor
  ClearTorchPup
  ResetTorchTargets
  Triggerscript 3000, "HideInTheDarkMessages" ' make sure torch pup message is cleared
  TorchCountdown.enabled = 0
  Missions(CurrentPlayer,3) = 0
  TorchHits(CurrentPlayer) = 0
  DisplayTorchCount
  DisableTorchLights
  TorchCountdown.enabled = 0
  ResetUPF
End Sub

Sub ResetBSMode
    DOF 163, DOFOff
  bBSTime = 1
  BlacksmithCountDown = BlacksmithTime
  BlacksmithModeTimer.Enabled = 0
  BlacksmithModeTimer.Enabled = 1
  BlacksmithModeExpired.enabled = 0
  BlacksmithModeExpired.enabled = 1
End Sub

Sub BlacksmithModeTimer_Timer
'Debug "InEvent :" &InEvent

BlacksmithCountDown = BlacksmithCountDown - 1

  if BSMode = 1 Then

    if BlacksmithCountDown < 10 Then
      ChangeFontColor = 1

      if BlacksmithCountdown < 0 Then bBSAll = 0
        'CountDownMessage1 = "  Time Expired"
        'CountDownMessage2 = ""
        'CountDownMessage3 = "Moving to Next Light"
      Else
        ChangeFontColor = 0
      ' CountDownMessage1 = "Follow Flashing Lights"
      ' CountDownMessage2 = ""
      ' CountDownMessage3 = "  To Earn Bonuses"
      '   if bBSAll = 1 Then
      '     CountDownMessage2 = "  To Earn Bonuses"
      '     CountDownMessage3 = "Super Bonus at the End"
      '   End If
    End If
  End If

  if BSMode Then
    if ChangeFontColor = 1 Then
      'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage1", CountDownMessage1 ,1,"{'mt':2,'color':255 }"
      'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage2", CountDownMessage2 ,1,"{'mt':2,'color':255 }"
      'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage3", CountDownMessage3 ,1,"{'mt':2,'color':255 }"
      PuPlayer.LabelSet pBackglass,"BlacksmithTimerOn", BlacksmithCountDown,1,"{'mt':2,'color':255}"
      PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage4", CountDownMessage1 ,1,""
    Else
      'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage1", CountDownMessage1 ,1,"{'mt':2,'color':33023}"
      'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage2", CountDownMessage2 ,1,"{'mt':2,'color':33023}"
      'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage3", CountDownMessage3 ,1,"{'mt':2,'color':33023}"
      PuPlayer.LabelSet pBackglass,"BlacksmithTimerOn", BlacksmithCountDown,1,"{'mt':2,'color':0}"
      PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage4", CountDownMessage1 ,1,""
    End If
  End If

End Sub

Sub BlacksmithModeExpired_Timer
'Debug "InEvent :" &InEvent

  BlacksmithModeTimer.Enabled = 0
  BlacksmithModeExpired.Enabled = 0

  bBSAll = 0 ' Turn off the super jackpot flag
  BlacksmithFail
  ClearBlacksmithPup

End Sub

Sub ClearBlacksmithPup
  'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage1", "" ,1,"" ' Erase Messages
  'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage2", "" ,1,"" ' Erase Messages
  'PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage3", "" ,1,"" ' Erase Messages
  PuPlayer.LabelSet pBackglass,"BlacksmithTimerMessage4", "" ,1,"" ' Erase Messages
  PuPlayer.LabelSet pBackglass,"BlacksmithTimerOn", "" ,1,"" ' Erase Messages
End Sub


'*************************
'   Side mode gamble
'*************************

'-----------------------------------------------------------------------------------------------------
sub CountDownTimer_timer
ChangeFontColor = 0
GetAM ' Get current active mode
  CountDown = CountDown - 1

  if Missions(CurrentPlayer,2) = 1 Then
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage1", CountDownMessage1 ,1,""
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage2", CountDownMessage2 ,1,""
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage3", CountDownMessage3 ,1,""
    PuPlayer.LabelSet pBackglass,"CountDownTimerOn", "" & CountDown,1,""
  End If


' if Missions(CurrentPlayer,2) = 1 Then
'     if CountDown = 0 Then
'       GambleFail
'     End If
' end If

End Sub
'-----------------------------------------------------------------------------------------------------
sub GambleModeTimer_timer
'ChangeFontColor = 0
'GetAM ' Get current active mode
  GambleCountDown = GambleCountDown - 1

  if Missions(CurrentPlayer,2) = 1 Then
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage1", CountDownMessage1 ,1,""
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage2", CountDownMessage2 ,1,""
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage3", CountDownMessage3 ,1,""
    PuPlayer.LabelSet pBackglass,"GambleCountDownTimerOn", "" & GambleCountDown,1,""
  End If


  if Missions(CurrentPlayer,2) = 1 Then
      if GambleCountDown < 0 Then
        Debug "Calling Gamble Fail"
        GambleFail
      End If
  end If

End Sub
'-----------------------------------------------------------------------------------------------------
Sub ClearCountDownPup
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage1", "" ,1,"" ' Erase Messages
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage3", "" ,1,"" ' Erase Messages
    PuPlayer.LabelSet pBackglass,"CountDownTimerOn", "" ,1,"" ' Erase Messages
End Sub

Sub ClearGambleCountDownPup
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage1", "" ,1,"" ' Erase Messages
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage2", "" ,1,"" ' Erase Messages
    PuPlayer.LabelSet pBackglass,"CountDownTimerMessage3", "" ,1,"" ' Erase Messages
    PuPlayer.LabelSet pBackglass,"CountDownTimerOn", "" ,1,"" ' Erase Messages
    PuPlayer.LabelSet pBackglass,"GambleCountDownTimerOn", "" ,1,"" ' Erase Messages
End Sub

'-----------------------------------------------------------------------------------------------------

Sub ResetRampCounts
  LeftRampCount(CurrentPlayer) = 0
  RightRampCount(CurrentPlayer) = 0
  DisplayRampCounts
End Sub


Dim RampHitsMessage
Sub DisplayGambleRampHits
  AddRampHits
  RampHitsMessage = RampHitsTotal &" Ramps Hit  x  " & FormatNumber(Score_GambleRamp,0)
  PuPlayer.LabelSet pBackglass,"GambleRampHitsMessage", RampHitsMessage ,1,""
End Sub

Sub HideGambleRampHits
  PuPlayer.LabelSet pBackglass,"GambleRampHitsMessage", "" ,1,"" 'Erase Messages
End Sub

Dim GamblePoints
Sub DisplayGamblePoints
  AddRampHits
  GamblePoints = RampHitsTotal * Score_GambleRamp
  PuPlayer.LabelSet pBackglass,"GamblePointsMessage", FormatNumber(GamblePoints,0),1,""
End Sub

Sub HideGamblePoints
  PuPlayer.LabelSet pBackglass,"GamblePointsMessage", "" ,1,"" 'Erase Messages
End Sub

Sub gamblemode
  GetAM
  ResetLaneLights
  bSupressBGMessages = True

  if ActiveMode <> 0 Then
    LeftRampCount(CurrentPlayer) = RampReq-1
    Exit Sub
  End If

  if Mode(CurrentPlayer,0) = 0 And BSMode <> 1 And TMode <> 1 Then
    if bMultiBallMode = 0 Then
      DOF 256, DOFOn
      GambleModeTimer.interval = 1000
      li036.state=2 'Left Ramp
      li040.state=2 ' Right Ramp
      li047.state =0 ' turn off Inn
      ModeTitle = "Gamble Mission"
      UpdateModeLabels
      Missions(CurrentPlayer,2) = 1
      Li038.state = 2 ' Quest Flashing
      EOBHide "gamblemode"
      GeneralPupQueue.Add "Pup831","pupevent 831",40,0,0,0,0,True ' BG Video
      AudioQueue.Add "Pup298","PuPEvent 298",93,0,0,0,0,False ' Event Start audio
      AudioQueue.Add "Pup433","PuPEvent 433",30,3100,0,0,0,False
      'PuPEvent 446 ' Audio
      GambleCountDown = 40
      GambleModeTimer.enabled = 1
      CountDownMessage1 = "Hit Left and Right Ramps"
      CountDownMessage2 = "To Increase Bonuses"
      CountDownMessage3 = "Collect at Center Scoop"
      HideRampCounts
      StopDMDLabelFlash "GambleOn"
      triggerscript 500, "GMode = 1"
    Else
      GeneralPupQueue.Add "gamblemode","gamblemode",40,10000,0,0,0,True ' try again
      'triggerscript 10000, "gamblemode" ' try again
    End If
  end if
  'ScorbitBuildGameModes
End sub


Sub GambleCollect
  pDMDLabelShow "GambleOn"
  if DMDType = 0 Then pBackglassLabelShow "GambleOn"
    DOFModesOff
  HideGambleRampHits
  bSupressBGMessages = False
  Debug "called gamble collect"
  GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
  GeneralPupQueue.Add "Pup838","pupevent 838",42,0,0,0,0,True
  GeneralPupQueue.Add "ReturnToVillage","ReturnToVillage",95,5100,0,0,0,True
  AudioQueue.Add "Pup233","PuPEvent 233",35,5000,0,0,AudioExpiry,False
  'gambleCount(CurrentPlayer)=0
  Missions(CurrentPlayer,2) = 2 ' Set Flag that mode is completed
  ScorbitBuildGameModes
  li036.state=0
  li040.state=0
  li038.state=0
  li047.state = 2 ' turn on Inn light
  GambleModeTimer.Enabled = 0
  GMode = 2 ' Reset Gamble Mode
  ClearGambleCountDownPup
  AddScore2 GamblePoints
  'ResetModes
End Sub

sub GambleFail
    DOFModesOff
  GambleClear
  li036.state=0
  li040.state=0
  Li038.state=0
  ModeFail "Gamble"
  GeneralPupQueue.Add "Pup300","pupevent 300",96,0,0,0,0,True
  GeneralPupQueue.Add "Pup837","pupevent 837",42,0,0,0,0,True
  GeneralPupQueue.Add "ReturnToVillage","ReturnToVillage",95,5000,0,0,0,True
  AudioQueue.Add "Pup233","PuPEvent 233",20,5000,0,0,AudioExpiry,False
  'ScorbitBuildGameModes
End Sub

sub GambleClear
  bSupressBGMessages = False
  DOFModesOff
  GMode = 0
  HideGambleRampHits
  HideGamblePoints
  debug "Called Gamble Clear"
  Missions(CurrentPlayer,2) = 0 ' Reset Gambler Mode
  GambleModeTimer.Enabled = 0
  ClearGambleCountDownPup
  ResetRampCounts
  DisplayOverlayCounts
  ResetUPF
End Sub


'**************************
'   PinUp Player USER Config
'**************************

'********************* START OF PUPDMD FRAMEWORK v2.0 BETA *************************
'******************************************************************************
'*****   Create a PUPPack within PUPPackEditor for layout config!!!  **********
'******************************************************************************
'
'
'  Quick Steps:
'      1>  create a folder in PUPVideos with Starter_PuPPack.zip and call the folder "yourgame"
'      2>  above set global variable pGameName="yourgame"
'      3>  copy paste the settings section above to top of table script for user changes.
'      4>  on Table you need to create ONE timer only called pupDMDUpdate and set it to 250 ms enabled on startup.
'      5>  go to your table1_init or table first startup function and call PUPINIT function
'      6>  Go to bottom on framework here and setup game to call the appropriate events like pStartGame (call that in your game code where needed)...etc
'      7>  attractmodenext at bottom is setup for you already,  just go to each case and add/remove as many as you want and setup the messages to show.
'      8>  Have fun and use pDMDDisplay(xxxx)  sub all over where needed.  remember its best to make a bunch of mp4 with text animations... looks the best for sure!
'
'
'Note:  for *Future Pinball* "pupDMDupdate_Timer()" timer needs to be renamed to "pupDMDupdate_expired()"  and then all is good.
'       and for future pinball you need to add the follow lines near top
'Need to use BAM and have com idll enabled.
'       Dim icom : Set icom = xBAM.Get("icom") ' "icom" is name of "icom.dll" in BAM\Plugins dir
'       if icom is Nothing then MSGBOX "Error cannot run without icom.dll plugin"
'       Function CreateObject(className)
'             Set CreateObject = icom.CreateObject(className)
'       End Function


'**************************
'   PinUp Player USER Config
'**************************




'Dim pGameName       : pGameName="Darkestdungeon"  'pupvideos foldername, probably set to cGameName in realworld


Const HasPuP = True   'dont set to false as it will break pup
Dim pDMD


if DMDType = 1 Then pDMD = 1
if DMDType = 2 Then pDMD=13

'Const pTopper=0
Const pBackglass=2
'Const pMusic=4
'Const pMusic2=7
'Const pCallouts=8
'Const pPopUP=11


'pages
Const pDMDBlank=0
Const pBackglassBlank=0
Const pScores=1
Const pBigLine=2
Const pThreeLines=3
Const pTwoLines=4
Const pTargerLetters=5




'Dim PuPlayer
Dim PUPDMDObject  'for realtime mirroring.
Dim pDMDlastchk: pDMDLastchk = -1    'performance of updates
Dim pBackglasslastchk:pBackglasslastchk = -1
Dim pDMDCurPage: pDMDCurPage= 0     'default page is empty.
Dim pBackglassCurPage:pBackglassCurPage=0
Dim pInAttract : pInAttract=false   'pAttract mode




'*************  starts PUP system,  must be called AFTER b2s/controller running so put in last line of table1_init

Sub PuPInit
  Debug5 "In PuPInit"
'Set PuPlayer = CreateObject("PinUpPlayer.PinDisplay")
  PuPlayer.B2SInit "", pGameName
  PuPlayer.LabelInit pDMD
  PuPlayer.LabelInit pBackglass
'   StartAttractMode
' Displayhighscores
  TriggerScript 2000,"delayStartup"

  if Scorbitactive then
'   if Scorbit.DoInit(4112, "PupOverlays", myVersion, "DDUN") then  ' Staging
    if Scorbit.DoInit(4111, "PupOverlays", myVersion, "DDUN") then  ' Prod
      tmrScorbit.Interval=2000
      tmrScorbit.UserValue = 0
      tmrScorbit.Enabled=True
      Scorbit.UploadLog = ScorbitUploadLog
    End if
  End if

End Sub 'end PUPINIT

sub CheckPairing
  'Debug3 "In check pairing"
  if (Scorbit.bNeedsPairing) then
    debug3 "Should be displaying pairing info"
    'puPlayer.LabelSet pDMD, "ScorbitQRIcon1", "PuPOverlays\\QRcodeS.png",1,  "{'mt':2,'width':39, 'height':80,'xalign':0,'yalign':0,'ypos':3,'xpos':3,'zback':1}"
    'puPlayer.LabelSet pDMD, "ScorbitQR1",  "PuPOverlays\\QRcode.png",1,  "{'mt':2,'width':34, 'height':60,'xalign':0,'yalign':0,'ypos':5,'xpos':5}"
    'PuPEvent 991
    pBackglassLabelSetSizeImage "ScorbitQR1",17,30
    pBackglassLabelSetPos "ScorbitQR1",82,37
    BallHandlingQueue.Add "PuPEvent 400","PuPEvent 400",44,0,0,0,0,True
    BallHandlingQueue.Add "PuPEvent 991","PuPEvent 991",44,0,0,0,0,True
    BallHandlingQueue.Add "ScorbitQR1","pbackglasslabelshow ""ScorbitQR1"" ",44,0,0,0,0,True
    'pbackglasslabelshow "ScorbitQR1"
    pBackglasslabelshow "ScorbitQRIcon1"
    DelayQRClaim.Interval=6000
    DelayQRClaim.Enabled=True
  end if
End sub

SUB delayStartup
  pSetPageLayouts(DMDType)
  pDMDSetPage(pDMDBlank)   'set blank text overlay page.
  pBackglassSetPage(pBackglassBlank)

  pDMDStartUP                 ' firsttime running for like an startup video..
end sub

Sub pDMDStartUP
  'do stuff fancy pants on first run
  pInAttract = True
  pDMDSetPage(pScores)
  pBackglassSetPage(pScores)
  BallHandlingQueue.Add "StartAttractMode","StartAttractMode",24,100,0,0,0,False
  BallHandlingQueue.Add "CheckPairing","CheckPairing",24,2000,0,0,0,False



end Sub 'end DMDStartup

'**********************************************************
'*
'*        Ensures we are using PuP Version 1.5 or later
'*      Else will exit table
'*
'**********************************************************
Sub CheckPupVersion

    Dim strPupVersion
    strPupVersion = PuPlayer.GetVersion
    'strPupVersion = "1.4.0.10" 'test

    strPupVersion = Replace(strPupVersion, ".", "")
    strPupVersion = mid (strPupVersion, 1,3)
    strPupVersion = CDbl(strPupVersion)

    If strPupVersion => 150 then
        exit sub
    Else
        msgbox "This table requires PuP Player version 1.5 or greater.  Please update your pup install to play the table", 0
        Table1_Exit
        QuitPlayer 2
    End if

End sub


'PinUP Player DMD Helper Functions

Sub pDMDLabelHide(labName)
PuPlayer.LabelSet pDMD,labName,"",0,""
end sub

Sub pBackglassLabelHide(labName)
PuPlayer.LabelSet pBackglass,labName,"",0,""
end sub

Sub pPoPUPLabelShow(labName)
PuPlayer.LabelSet pPopUP,labName,"`u`",1,""
end sub


Sub pDMDLabelShow(labName)
PuPlayer.LabelSet pDMD,labName,"",1,""
end sub

Sub pBackglassLabelShow(labName)
PuPlayer.LabelSet pBackglass,labName,"",1,""
end sub

Sub pDMDLabelcollectl(labName)
PuPlayer.LabelSet pDMD,labName,"collectL",1,""
end sub

Sub pBackglassLabelcollectl(labName)
PuPlayer.LabelSet pBackglass,labName,"collectL",1,""
end sub

Sub pDMDLabelcollectR(labName)
PuPlayer.LabelSet pDMD,labName,"collectR",1,""
end sub

Sub pBackglassLabelcollectR(labName)
PuPlayer.LabelSet pBackglass,labName,"collectR",1,""
end sub

Sub pDMDCountDownTimerOn(labName)
PuPlayer.LabelSet pDMD,labName,CountDown,1,"{'mt':2,'color':33023, 'size': 5.8, 'xpos': 24.1, 'xalign': 0, 'ypos': 69.1, 'yalign': 0 }"
end sub

Sub pBackglassCountDownTimerOn(labName)
PuPlayer.LabelSet pBackglass,labName,CountDown,1,"{'mt':2,'color':33023, 'size': 5.8, 'xpos': 24.1, 'xalign': 0, 'ypos': 69.1, 'yalign': 0 }"
end sub

sub pDMDLabelSetGrayScale(labName, isGray)  'only on image objects.  will show as grayscale.  1=gray filter on 0=off normal mode
   PuPlayer.LabelSet pDMD,labName,"u",1,"{'mt':2,'grayscale':"&isGray&"}"
end sub

sub pBackglassLabelSetGrayScale(labName, isGray)  'only on image objects.  will show as grayscale.  1=gray filter on 0=off normal mode
   PuPlayer.LabelSet pBackglass,labName,"u",1,"{'mt':2,'grayscale':"&isGray&"}"
end sub

Sub pDMDLabelVisible(labName, isVis)
PuPlayer.LabelSet pDMD,labName,"",isVis,""
end sub

Sub pBackglassLabelVisible(labName, isVis)
PuPlayer.LabelSet pBackglass,labName,"",isVis,""
end sub

Sub pDMDLabelSendToBack(labName)
PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':2,'zback': 1 }"
end sub

Sub pDMDLabelSendToFront(labName)
PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':2,'ztop': 1 }"
end sub

sub pDMDLabelSetPos(labName, xpos, ypos)
   PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':2,'xpos':"&xpos& ",'ypos':"&ypos&"}"
end sub

sub pBackglassLabelSetPos(labName, xpos, ypos)
   PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':2,'xpos':"&xpos& ",'ypos':"&ypos&"}"
end sub

sub pDMDLabelSetSizeImage(labName, lWidth, lHeight)
   PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':2,'width':"& lWidth & ",'height':"&lHeight&"}"
end sub

sub pBackglassLabelSetSizeImage(labName, lWidth, lHeight)
   PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':2,'width':"& lWidth & ",'height':"&lHeight&"}"
end sub

sub pDMDLabelSetSizeText(labName, fHeight)
   PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':2,'size':"&fHeight&"}"
end sub

sub pBcakglassLabelSetSizeText(labName, fHeight)
   PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':2,'size':"&fHeight&"}"
end sub

sub pDMDLabelSetColor(labName, lCol)
   PuPlayer.LabelSet pDMD,labName,"`u`",1,"{'mt':2,'color':"&lCol&"}"
end sub

sub pBackglassLabelSetColor(labName, lCol)
   PuPlayer.LabelSet pBackglass,labName,"`u`",1,"{'mt':2,'color':"&lCol&"}"
end sub

'sub pDMDLabelSetOutShadow(labName, lCol,offsetx,offsety,isOutline,isVis)
'   PuPlayer.LabelSet pDMD,labName,"`u`",1,"{'mt':2,'shadowcolor':"&lCol&",'shadowstate': "&isVis&", 'xoffset': "&offsetx&", 'yoffset': "&offsety&", 'outline': "&isOutline&"}"
'end sub


'animations
sub pDMDPNGAnimateOrig(labName,cSpeed)  'speed is frame timer, 0 = stop animation  100 is 10fps for animated png and gif nextframe timer.
  PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':2,'anigif':"&cSpeed&" }"
end sub

sub pDMDPNGAnimate(labName,cSpeed)  'speed is frame timer, 0 = stop animation  100 is 10fps for animated png and gif nextframe timer.
   PuPlayer.LabelSet pDMD,labName,"`u`",1,"{'mt':2,'animate':"&cSpeed&"}"
end sub

'sub pBackglassPNGAnimateOrig(labName,cSpeed)  'speed is frame timer, 0 = stop animation  100 is 10fps for animated png and gif nextframe timer.
'   PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':2,'animate':"&cSpeed&"}"
'end sub


sub pBackglassPNGAnimate(labName,cSpeed)  'speed is frame timer, 0 = stop animation  100 is 10fps for animated png and gif nextframe timer.
   PuPlayer.LabelSet pBackglass,labName,"`u`",1,"{'mt':2,'animate':"&cSpeed&"}"
end sub

sub pBackglassPNGAnimateOnce(labName,cSpeed)  'will show an animated gif/png and then hide when done, overrides loop to force stop at end.
   PuPlayer.LabelSet pBackglass,labName,"`u`",1,"{'mt':2,'animate':"&cSpeed&", 'gifloop': 0 , 'aniendhide':1 }"
end sub


'---------- 1.4.6 Animation Code
'sub pBackglassPNGAnimate3(labName,cSpeed)  'speed is frame timer, 0 = stop animation  100 is 10fps for animated png and gif nextframe timer.
'   PuPlayer.LabelSet pDMD,labName,"`u`",1,"{'mt':2,'animate':"&cSpeed&"}"
'end sub

sub pBackglassPNGAnimate2(labName,cSpeed,pos)
if pos = "back" Then
   PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':2,'anigif':600,'zback':1}"
Else
   PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':2,'anigif':600,'ztop':1}"
End If
End Sub

sub pBackglassStopAnimate(labName,cSpeed)
   PuPlayer.LabelSet pBackglass,labName,"",1,""
End Sub

sub pBackglassHideAnimate(labName)
   PuPlayer.LabelSet pBackglass,labName,"",0,""
End Sub

sub pDMDHideAnimate(labName)
   PuPlayer.LabelSet pDMD,labName,"",0,""
End Sub
'--------------
sub testplayevent
'playevent  SNUM, playlist, filename, volume, priority, playtype, seconds, special""
   PuPlayer.playevent pDMD,"RandomScoring","Fire Missile 1.mp4",100,1,1,2,""
end sub
'--------------

sub pDMDPNGAnimateEx(labName,startFrame,endFrame,LoopMode)  'sets up the apng/gif settings before you call animate.  if you set start/end frame same if will display that frame, set start to -1 to reset settings.
   PuPlayer.LabelSet pDMD,labName,"`u`",1,"{'mt':2,'gifstart':"&startFrame&",'gifend':"&endFrame&",'gifloop':"&loopMode&" }"          'gifstart':3, 'gifend':10, 'gifloop': 1
end sub

Sub pDMDLabelHide2(labName,timeSec, mColor)
PuPlayer.LabelSet pDMD,labName,"`u`",0,"{'mt':1,'at':1,'fq':100,'len':" & (timeSec) & ",'fc':" & mColor & "}"
end sub

Sub pDMDLabelFlash(LabName,timeSec, mColor)   'timeSec in ms
    PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':1,'at':1,'fq':100,'len':" & (timeSec) & ",'fc':" & mColor & "}"
end sub

Sub pDMDLabelSlowFlash(LabName,timeSec, mColor)   'timeSec in ms
    PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':1,'at':1,'fq':10,'len':" & (timeSec) & ",'fc':" & mColor & "}"
end sub

Sub pBackglassLabelFlash(LabName,timeSec, mColor)   'timeSec in ms
    PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':1,'at':1,'fq':100,'len':" & (timeSec) & ",'fc':" & mColor & "}"
end sub

Sub StopLabelFlash(labName)
PuPlayer.LabelSet pBackglass,labName,"",0,""
End Sub

Sub StopDMDLabelFlash(labName)
PuPlayer.LabelSet pDMD,labName,"",0,""
End Sub

Sub pDMDLabelitemFlash(LabName,timeSec, mColor)   'timeSec in ms
    PuPlayer.LabelSet pDMD,labName,"",1,"{'mt':1,'at':1,'fq':200,'len':" & (timeSec) & ",'fc':" & mColor & "}"
end sub

Sub pBackglassLabelitemFlash(LabName,timeSec, mColor)   'timeSec in ms
    PuPlayer.LabelSet pBackglass,labName,"",1,"{'mt':1,'at':1,'fq':200,'len':" & (timeSec) & ",'fc':" & mColor & "}"
end sub

sub pDMDLabelPulseText(LabName,LabValue,mLen,mColor)       'mlen in ms
    PuPlayer.LabelSet pDMD,labName,LabValue,0,"{'mt':1,'at':4,'hstart':20,'hend':35,'len':" & (mLen) & ",'pspeed': 8,'fc':" & mColor & "}"
end Sub


sub pDMDLabelPulseNumber(LabName,LabValue,mLen,mColor,pNumStart,pNumEnd,pNumformat)   'pnumformat 0 no format, 1 with thousands  mLen=ms
     PuPlayer.LabelSet pDMD,labName,LabValue,0,"{'mt':1,'at':4,'hstart':25,'hend':30,'len':" & (mLen) & ",'pspeed': 1,'fc':" & mColor & ",'numstart':"&pNumStart&",'numend' :"&pNumEnd&", 'numformat':"&pNumFormat&"}"
end Sub

Sub pDMDSplashPage(pagenum,pTime)    ' pTime is seconds when under 999 otherwise its ms.  (3=3 seconds, 2500= 2500ms)
    PuPlayer.LabelShowPage pDMD,pagenum,pTime,""   'Temp Show page for x seconds and then auto-return to current page
end Sub

Sub pBackglassSplashPage(pagenum,pTime)    ' pTime is seconds when under 999 otherwise its ms.  (3=3 seconds, 2500= 2500ms)
    PuPlayer.LabelShowPage pBackglass,pagenum,pTime,""   'Temp Show page for x seconds and then auto-return to current page
end Sub

Sub pDMDPageForceShow(pagenum)
     PuPlayer.LabelShowPage pDMD,pagenum,0,"forceshow"   'timevar is ignored in force
end Sub

Sub pDMDPageForceHide(pagenum)
    PuPlayer.LabelShowPage pDMD,pagenum,0,"forcehide"   'timevar is ignored in force
end Sub

Sub pDMDSetPage(pagenum)
    PuPlayer.LabelShowPage pDMD,pagenum,0,""   'set page to blank 0 page if want off
    PDMDCurPage=pagenum
end Sub

Sub pBackglassSetPage(pagenum)
    PuPlayer.LabelShowPage pBackglass,pagenum,0,""   'set page to blank 0 page if want off
    PBackglassCurPage=pagenum
end Sub

sub pDMDLabelSetShadow(labName,lCol,offsetx,offsety,isVis)  ' shadow of text
dim ST: ST=1 : if isVIS=false Then St=0
   PuPlayer.LabelSet pDMD,labName,"`u`",1,"{'mt':2,'shadowcolor':"&lCol&",'shadowtype': "&ST&", 'xoffset': "&offsetx&", 'yoffset': "&offsety&"}"
end sub

sub pDMDLabelSetBorder(labName,lCol,offsetx,offsety,isVis)   'outline/border around text.
dim ST: ST=2 : if isVIS=false Then St=0
   PuPlayer.LabelSet pDMD,labName,"`u`",1,"{'mt':2,'shadowcolor':"&lCol&",'shadowtype': "&ST&", 'xoffset': "&offsetx&", 'yoffset': "&offsety&"}"
end sub

Sub pHideOverlayDuringCurrentPlay()
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "& "5"& ", ""FN"": 34 }"             'hideoverlay text during next videoplay on DMD auto return
end Sub

sub pOverlayVisible(lvis)   '0/1 to show hide overlay
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": "& "5"& ",""OT"":"&lvis&", ""FN"": 3 }"             'hideoverlay text force
end Sub

Sub pDMDSetBackFrame(fname)
  PuPlayer.playlistplayex pDMD,"PUPFrames",fname,0,1
end Sub

Sub pBackglassSetBackFrame(fname)
  PuPlayer.playlistplayex pBackglass,"PUPFrames",fname,0,1
end Sub

Sub pDMDBackLoopStart(fPlayList,fname)
  PuPlayer.playlistplayex pDMD,fPlayList,fname,0,1
  PuPlayer.SetBackGround pDMD,1
end Sub

Sub pDMDBackLoopStop
  PuPlayer.SetBackGround pDMD,0
  PuPlayer.playstop pDMD
end Sub

Sub PuPEvent(EventNum)
  GetAM
  if hasPUP=false then Exit Sub


  if bEOBSupress = True Then
    Select Case True
      Case EventNum = 511 or EventNum = 555 or EventNum = 890:
      Case EventNum = 445 or EventNum = 446 or EventNum = 447: ' audio tracks
      Case (EventNum > 750 And EventNum < 756): ' game over screens
      Case (EventNum > 770 And EventNum < 775): ' continue screens
      Case (EventNum > 199 And EventNum < 300): ' audio callouts
      Case (EventNum > 299 And EventNum < 312): ' DMD guides
      Case Else:
        Debug2 "***************************"
        Debug2 "*** SUPRESSING EVENT: " &EventNum
        Debug2 "***************************"
        Exit Sub ' supress pup events until EOB sequence completes
    End Select
  End If


  'if hasPUP=false then Exit Sub


  'if EventNum = 400 Then Debug " ************ 400 ******************"
  if GMode = 1 Then
    Select Case EventNum
      Case 824:
        PuPlayer.B2SData "D286",1  'send AUDIO version of event to puppack driver
      Case 831,833,837,838,300,400,853,842,843,844,900,298,433:
        PuPlayer.B2SData "D"&EventNum,1  'send event to puppack driver
    End Select
    Exit Sub
  Elseif BSMode = 1 Then
    Select Case EventNum
      Case 824:
        PuPlayer.B2SData "D286",1  'send AUDIO version of event to puppack driver
      Case 292,830,835,836,400,853,842,843,844,900,297,432:
        PuPlayer.B2SData "D"&EventNum,1  'send event to puppack driver
    End Select
    Exit Sub
  Elseif TMode = 1 Then
    Select Case EventNum
      Case 824:
        PuPlayer.B2SData "D286",1  'send AUDIO version of event to puppack driver
      Case 834,839,840,400,853,842,843,844,900,299,434:
        PuPlayer.B2SData "D"&EventNum,1  'send event to puppack driver
    End Select
    Exit Sub
  Elseif Mode(CurrentPlayer,0) = 9 Then
    Select Case EventNum
'     Case 824,842,843,844,853,400,900:
'       PuPlayer.B2SData "D286",1  'send AUDIO version of event to puppack driver
      Case 820,821,822,823:  ' skip these videos
        Exit Sub
      Case Else
        PuPlayer.B2SData "D"&EventNum,1  'send event to puppack driver
    End Select
'   Exit Sub
  Elseif Mode(CurrentPlayer,0) = 15 Then
    Select Case EventNum
      Case 200,300,313,444,842,843,844,854,902:
        PuPlayer.B2SData "D"&EventNum,1  'allow thru
      Case (EventNum > 750 And EventNum < 756): ' game over screens
        PuPlayer.B2SData "D"&EventNum,1  'allow thru
      Case (EventNum > 770 And EventNum < 775): ' continue screens
        PuPlayer.B2SData "D"&EventNum,1  'allow thru
      Case (EventNum > 199 And EventNum < 300): ' audio callouts
        PuPlayer.B2SData "D"&EventNum,1  'send event to puppack driver
      Case Else
        ' Do nothing
    End Select
    Exit Sub
  Else
    PuPlayer.B2SData "D"&EventNum,1  'send event to puppack driver
  End If





    Select Case EventNum

      Case 860: ' ball save
        Select Case ActiveMode
        Case 2,4,6,8,10,11,12,13,14:
          InEvent = 1
          triggerscript 6200, "InEvent = 0 "
          if DMDType <> 2 Then
            PuPHideBattle "PupEvent"
            CreateMonsterString
              if AMState = 1 And PartySize(CurrentPlayer) > 0 And MonsterString <> "2222" Then
                Debug "Displaying Pup Battle: "&EventNum &":" &MonsterString
                  GeneralPupQueue.Add "DDB","DisplayDungeonBG",56,6100,0,0,0,True
                  GeneralPuPQueue.Add "PupDisplayBattle","PuPDisplayBattle ""Delayed pupevent"" ",50,6100,0,0,0,True
              End If
          End If
        End Select
      Case 824: ' kickback active
        Debug "InEvent: " &EventNum
'       InEvent = 1
'       triggerscript 5200, "InEvent = 0 "
          Select Case ActiveMode
            Case 2,4,6,8,10,11,12,13,14:
              'bSupressBGMessages = True
              'GeneralPuPQueue.Add "SupressBGMessagesFlag","bSupressBGMessages = False ",80,5200,0,0,0,True
              CreateMonsterString
              Debug "Hiding pupbattle for Event: "&EventNum &":" & AMState &":" &InEvent
              GeneralPuPQueue.Add "PupHideBattle","PuPHideBattle ""PupEvent"" ",98,0,0,0,0,True
                if AMState = 1 And PartySize(CurrentPlayer) > 0 And MonsterString <> "2222" Then
      '           Debug "Displaying Pup Battle: "&EventNum &":" &MonsterString
                  GeneralPupQueue.Add "DDB","DisplayDungeonBG",56,5100,0,0,0,True
                  GeneralPuPQueue.Add "PupDisplayBattle","PuPDisplayBattle ""Delayed pupevent"" ",50,5100,0,0,0,True
              End If
          End Select 'ActoveMode

      Case 850: 'extraball
        Debug "InEvent: " &EventNum
'       InEvent = 1
'       triggerscript 5500, "InEvent = 0 "
          Select Case ActiveMode
            Case 2,4,6,8,10,11,12,13,14:
              'bSupressBGMessages = True
              'triggerscript 5600, "bSupressBGMessages = False "
              CreateMonsterString
              Debug "Hiding pupbattle for Event: "&EventNum &":" & AMState &":" &InEvent
              GeneralPuPQueue.Add "PupHideBattle","PuPHideBattle ""PupEvent"" ",98,0,0,0,0,True
                if AMState = 1 And PartySize(CurrentPlayer) > 0 And MonsterString <> "2222" Then
      '           Debug "Displaying Pup Battle: "&EventNum &":" &MonsterString
                  GeneralPupQueue.Add "DDB","DisplayDungeonBG",56,5500,0,0,0,True
                  GeneralPuPQueue.Add "PupDisplayBattle","PuPDisplayBattle ""Delayed pupevent"" ",50,5500,0,0,0,True ' Redisplay as battle is still going on
              End If
          End Select 'ActoveMode

      Case 820,821,822,823: ' kickback letters
        Debug "InEvent: " &EventNum
'       InEvent = 1
'       triggerscript 5200, "InEvent = 0 "
          Select Case ActiveMode
            Case 2,4,6,8,10,11,12,13,14:
              'bSupressBGMessages = True
              'triggerscript 5500, "bSupressBGMessages = False "
              CreateMonsterString
              Debug "Hiding pupbattle for Event: "&EventNum &":" & AMState &":" &InEvent
              GeneralPuPQueue.Add "PupHideBattle","PuPHideBattle ""PupEvent"" ",98,0,0,0,0,True
                if AMState = 1 And PartySize(CurrentPlayer) > 0 And MonsterString <> "2222" Then
      '           Debug "Displaying Pup Battle: "&EventNum &":" &MonsterString
                  GeneralPupQueue.Add "DDB","DisplayDungeonBG",56,5300,0,0,0,True
                  GeneralPuPQueue.Add "PupDisplayBattle","PuPDisplayBattle ""Delayed pupevent"" ",50,5300,0,0,0,True ' Redisplay as battle is still going on
              End If
          End Select 'ActoveMode

      Case 910,911,912,913,914,915,916,918: ' items
        Debug "InEvent: " &EventNum
'       InEvent = 1
'       triggerscript 4400, "InEvent = 0 "
          Select Case ActiveMode
            Case 2,4,6,8,10,11,12,13,14:
              HideHelper
              'bSupressBGMessages = True
              'triggerscript 4400, "bSupressBGMessages = False "
              CreateMonsterString
              Debug "Hiding pupbattle for Event: "&EventNum &":" & AMState &":" &InEvent
              GeneralPuPQueue.Add "PupHideBattle","PuPHideBattle ""PupEvent"" ",98,0,0,0,0,True
                if AMState = 1 And PartySize(CurrentPlayer) > 0 And MonsterString <> "2222" Then
      '           Debug "Displaying Pup Battle: "&EventNum &":" &MonsterString
                  GeneralPupQueue.Add "DDB","DisplayDungeonBG",56,4400,0,0,0,True
                  GeneralPuPQueue.Add "PupDisplayBattle","PuPDisplayBattle ""Delayed pupevent"" ",50,4400,0,0,0,True ' Redisplay as battle is still going on
              End If
          End Select 'ActoveMode

      Case 941,942,943,944,945,946,947,948: ' death videos
        Debug "InEvent: " &EventNum
'       InEvent = 1
'       triggerscript 3100, "InEvent = 0 "
          Select Case ActiveMode
            Case 2,4,6,8,10,11,12,13,14:
              HideHelper
              'bSupressBGMessages = True
              'triggerscript 4400, "bSupressBGMessages = False "
              CreateMonsterString
              Debug "Hiding pupbattle for Event: "&EventNum &":" & AMState &":" &InEvent
              GeneralPuPQueue.Add "PupHideBattle","PuPHideBattle ""PupEvent"" ",98,0,0,0,0,True
                if AMState = 1 And PartySize(CurrentPlayer) > 0 And MonsterString <> "2222" Then
      '           Debug "Displaying Pup Battle: "&EventNum &":" &MonsterString
                  GeneralPupQueue.Add "DDB","DisplayDungeonBG",56,3100,0,0,0,True
                  GeneralPuPQueue.Add "PupDisplayBattle","PuPDisplayBattle ""Delayed pupevent"" ",50,3100,0,0,0,True ' Redisplay as battle is still going on
              End If
          End Select 'ActoveMode

    End Select 'EventNum

End Sub

Sub SetGuideShadows
  pDMDLabelSetShadow "Guide1", 080808, 3,3,1
  pDMDLabelSetShadow "Guide2", 080808, 3,3,1
  pDMDLabelSetShadow "Guide3", 080808, 3,3,1
End Sub

Sub SetCountDownShadows
  pDMDLabelSetShadow "CountDownTimerMessage1", 080808, 3,3,1
  pDMDLabelSetShadow "CountDownTimerMessage2", 080808, 3,3,1
  pDMDLabelSetShadow "CountDownTimerMessage3", 080808, 3,3,1
End Sub



'==================== OLD pDMD Calls ======================================

Sub pupCreateLabel(lName, lValue, lFont, lSize, lColor, xpos, ypos, alignX, alignY, pagenum, lvis)
  PuPlayer.LabelNew pBackglass,lName ,lFont,lSize,lColor,0,alignX,alignY,1,1,pagenum,lvis
  PuPlayer.LabelSet pBackglass,lName,lValue,lvis,"{'mt':2,'xpos':"& xpos & ",'ypos':"&ypos&"}"
end Sub

Sub pupCreateLabelImage(lName, lFilename,xpos, ypos, Iwidth, Iheight, pagenum, lvis)
  PuPlayer.LabelNew pBackglass,lName ,"",50,RGB(100,100,100),0,1,1,1,1,pagenum,lvis
  PuPlayer.LabelSet pBackglass,lName,lFilename,lvis,"{'mt':2,'width':"&IWidth&",'height':"&Iheight&",'xpos':"&xpos&",'ypos':"&ypos&"}"
end Sub

Sub pupCreateLabelImageDMD(lName, lFilename,xpos, ypos, Iwidth, Iheight, pagenum, lvis)
  PuPlayer.LabelNew pDMD,lName ,"",50,RGB(100,100,100),0,1,1,1,1,pagenum,lvis
  PuPlayer.LabelSet pDMD,lName,lFilename,lvis,"{'mt':2,'width':"&IWidth&",'height':"&Iheight&",'xpos':"&xpos&",'ypos':"&ypos&"}"
end Sub

Sub pupPoPCreateLabelImage(lName, lFilename,xpos, ypos, Iwidth, Iheight, pagenum, lvis)
  PuPlayer.LabelNew pPopUP,lName ,"",50,RGB(100,100,100),0,1,1,1,1,pagenum,lvis
  PuPlayer.LabelSet pPopUP,lName,lFilename,lvis,"{'mt':2,'width':"&IWidth&",'height':"&Iheight&",'xpos':"&xpos&",'ypos':"&ypos&"}"
end Sub



Sub pMsg2Lines(msgText, msgText2, timeSec, mColor, Blink)
    PuPlayer.LabelShowPage pBackglass, 1, timeSec, ""
  if DMDType = 0 Then
    If Blink = 1 then
      PuPlayer.LabelSet pBackglass, "Line1b", msgText, 0, "{'mt':1,'at':" & Blink & ",'fq':150,'len':" & (timeSec * 1000) & ",'fc':" & mColor & "}"
      PuPlayer.LabelSet pBackglass, "Line2b", msgText2, 0, "{'mt':1,'at':" & Blink & ",'fq':150,'len':" & (timeSec * 1000) & ",'fc':" & mColor & "}"
    Else
      PuPlayer.LabelSet pBackglass, "Line1b", msgText, 1, ""
      PuPlayer.LabelSet pBackglass, "Line2b", msgText2, 1, ""
    End If
  Else
    If Blink = 1 then
      PuPlayer.LabelSet pBackglass, "Line1b", msgText, 0, "{'mt':1,'at':" & Blink & ",'fq':150,'len':" & (timeSec * 1000) & ",'fc':" & mColor & "}"
      PuPlayer.LabelSet pBackglass, "Line2b", msgText2, 0, "{'mt':1,'at':" & Blink & ",'fq':150,'len':" & (timeSec * 1000) & ",'fc':" & mColor & "}"
    Else
      PuPlayer.LabelSet pBackglass, "Line1b", msgText, 1, ""
      PuPlayer.LabelSet pBackglass, "Line2b", msgText2, 1, ""
    End If

  End If
end Sub

'labelNew <screen#>, <Labelname>, <fontName>,<size%>,<colour>,<rotation>,<xalign>,<yalign>,<xpos>,<ypos>,<PageNum>,<visible>
'***********************************************************************'
'<screen#>, in standard wed set this to pDMD ( or 1)
'<Labelname>, your name of the label. keep it short no spaces (like 8 chars) although you can call it anything really. When setting the label you will use this labelname to access the label.
'<fontName> Windows font name, this must be exact match of OS front name. if you are using custom TTF fonts then double check the name of font names.
'<size%>, Height as a percent of display height. 20=20% of screen height.
'<colour>, integer value of windows color.
'<rotation>, degrees in tenths   (900=90 degrees)
'<xAlign>, 0= horizontal left align, 1 = center horizontal, 2= right horizontal
'<yAlign>, 0 = top, 1 = center, 2=bottom vertical alignment
'<xpos>, this should be 0, but if you want to force a position you can set this. it is a % of horizontal width. 20=20% of screen width.
'<ypos> same as xpos.sub DisplayHighScores
'<PageNum> IMPORTANT this will assign this label to this page or group.
'<visible> initial state of label. visible=1 show, 0 = off.

'Using FULL BIG LCD PuPDMD  ************ lcd **************
'
'Sub CreateLabel(lName, lValue, lFont, lSize, lColor, xpos, ypos, alignX, alignY, pagenum, lvis)
'
'Sub CreateLabelImage(lName, lFilename,xpos, ypos, Iwidth, Iheight, pagenum, lvis)
'Font colors:
  Const cWhite =  16777215
  Const cRed =  397512
  Const cGold =   1604786
  Const cGrey =   8421504
  Const cYellow = 65535
  Const cOrange = 33023
  Const cPurple = 16711808
  Const cBlue = 16711680
  Const cLightBlue = 16744448
  Const cBoltYellow = 2148582

'********************************************************************************************************************
'****************   ALL DMD TYPES INHERIT THESE VALUES **************************************************************
'********************************************************************************************************************

Sub pSetPageLayouts(DMDType)


  dmdalt="DwarvenAxe BB W00 Regular"
    dmdfixed="DwarvenAxe BB W00 Regular"
  dmdscr="DwarvenAxe BB W00 Regular"  'main score font
  dmddef="DwarvenAxe BB W00 Regular"

' puPlayer.LabelNew pDMD,"ScorbitQR2",  dmddef,   1,RGB(247, 170, 51)     ,0,2,0 ,0,0    ,1,1
' puPlayer.LabelNew pDMD,"ScorbitQRicon2", dmddef,  1,RGB(247, 170, 51)     ,0,2,0 ,0,0    ,1,1

' puPlayer.LabelNew pDMD,"ScorbitQR1",  dmddef,   1,RGB(247, 170, 51)     ,0,2,0 ,0,0    ,9,1
' puPlayer.LabelNew pDMD,"ScorbitQRicon1", dmddef,  1,RGB(247, 170, 51)     ,0,2,0 ,0,0    ,9,1


  pupCreateLabelImage "ScorbitQRicon1","PuPOverlays\\QRcodeS.png",50,30,34,60,1,0
  pupCreateLabelImage "ScorbitQR1","PuPOverlays\\QRCode.png",50,30,34,60,1,0

  pupCreateLabelImage "ScorbitQRicon2","PuPOverlays\\QRcodeB.png",50,30,34,60,1,0
  pupCreateLabelImage "ScorbitQR2","PuPOverlays\\QRclaim.png",50,30,34,60,1,0


  PuPlayer.LabelNew pDMD,"titlebg",dmddef,        25,16777215          ,0,1,1,54,40,1,1
    PuPlayer.LabelNew pDMD,"title",dmddef,            25,16777215     ,0,1,1,54,40,1,1
    PuPlayer.LabelNew pDMD,"titlebg2",dmddef,        25,16777215          ,0,1,1,54,40,1,1
    PuPlayer.LabelNew pDMD,"title2",dmddef,            25,16777215     ,0,1,1,54,40,1,1

  PuPlayer.LabelNew pBackglass,"Credits" ,dmddef,20,33023   ,0,2,2,95,0,1,0
  PuPlayer.LabelNew pBackglass,"Play1"   ,dmdalt,20,33023   ,1,0,0,15,0,1,0
  PuPlayer.LabelNew pBackglass,"MsgScore",dmddef,45,33023   ,0,1,0, 0,40,1,0
  PuPlayer.LabelNew pBackglass,"dungeonTitle",dmdscr,60,8454143   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pBackglass,"dungeonTitle2",dmdscr,60,8454143   ,0,1,1, 0,0,1,0

  PuPlayer.LabelNew pBackglass,"partysize",dmdscr,60,8454143   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pBackglass,"ModeString",dmdscr,60,8454143   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pBackglass,"MonsterString",dmdscr,60,16744576   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pBackglass,"DarkString",dmdscr,60,16744576   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pBackglass,"ItemString",dmdscr,60,4259584   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pBackglass,"heros",dmdscr,60,8454143   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pBackglass,"torchtimer",dmdscr,60,255   ,0,1,1, 0,0,1,0
  PuPlayer.LabelNew pDMD,"Leftspinner",   dmddef, 7,16777215  ,0,1,1,50,87,1,1
  PuPlayer.LabelNew pDMD,"Rightspinner",    dmddef, 7,16777215  ,0,1,1,50,87,1,1
  PuPlayer.LabelNew pDMD,"TargetCounts",    dmddef, 7,16777215  ,0,1,1,10,97,1,1
  PuPlayer.LabelNew pDMD,"GambleTime",    dmddef, 7,16777215  ,0,1,1,50,87,1,1
  PuPlayer.LabelNew pDMD,"sidemodes",     dmddef, 3,16777215  ,0,0,1,23,81,1,0

  PuPlayer.LabelNew pDMD,"TopOverlayON",    dmddef, 100,16777215  ,0,0,0,2,0,1,0
    PuPlayer.LabelNew pDMD,"Gamblebonus",   dmddef, 5,16777215  ,15.8,3.7,1,25,87,1,0

  PuPlayer.LabelNew pBackglass,"KeyAward",    dmddef, 20,255  ,0,1,1,50,20,1,0
    PuPlayer.LabelNew pBackglass,"Scoop2Helper",dmddef, 14,33023,0,1,1,50,20,1,0
'Sub CreateLabelImage(lName, lFilename,xpos, ypos, Iwidth, Iheight, pagenum, lvis)
    'page 1 lables


                            '****  icons****
        pupCreateLabelImage "grave","Heros\\graveicon.png",30.4,91.75,6.1,10.7,1,0
        pupCreateLabelImage "highwayman","Heros\\highwaymanicon.png",37.3,91.75,6.1,10.7,1,0
        pupCreateLabelImage "jester","Heros\\jestericon.png",44.3,91.75,6.1,10.7,1,0
        pupCreateLabelImage "vestal","Heros\\vestalicon.png",51.3,91.75,6.1,10.7,1,0
        pupCreateLabelImage "plague","Heros\\plagueicon.png",58.25,91.75,6.1,10.7,1,0
        pupCreateLabelImage "occultist","Heros\\occultisticon.png",65.3,91.75,6.1,10.7,1,0
        pupCreateLabelImage "crusader","Heros\\crusadericon.png",72.5,91.75,6.1,10.7,1,0
        pupCreateLabelImage "hound","Heros\\houndicon.png",79.3,91.75,6.1,10.7,1,0
                            '**** Preview Hero icons****
        pupCreateLabelImage "PREgrave","Heros\\graveicon.png",90.35,81.4,6.34,11.25,1,0
        pupCreateLabelImage "PREhighwayman","Heros\\highwaymanicon.png",90.35,81.4,6.34,11.25,1,0
        pupCreateLabelImage "PREjester","Heros\\jestericon.png",90.35,81.4,6.34,11.25,1,0
        pupCreateLabelImage "PREvestal","Heros\\vestalicon.png",90.35,81.4,6.34,11.25,1,0
        pupCreateLabelImage "PREplague","Heros\\plagueicon.png",90.35,81.4,6.34,11.25,1,0
        pupCreateLabelImage "PREoccultist","Heros\\occultisticon.png",90.35,81.4,6.34,11.25,1,0
        pupCreateLabelImage "PREcrusader","Heros\\crusadericon.png",90.35,81.4,6.34,11.25,1,0
        pupCreateLabelImage "PREhound","Heros\\houndicon.png",90.35,81.4,6.34,11.25,1,0
                        '**** Item collect images****
        pupCreateLabelImage "medicine","Items\\medicine.png",40.4,78,4.2,15,1,0
        pupCreateLabelImage "bandage","Items\\bandage.png",47.4,78,4.2,15,1,0
        pupCreateLabelImage "key","Items\\key.png",54.8,78,4.2,15,1,0
        pupCreateLabelImage "shovel","Items\\shovel.png",62.1,78,4.2,15,1,0
        pupCreateLabelImage "vial","Items\\vial.png",69.2,78,4.2,15,1,0
            '**** battle gifs****
        pupCreateLabelImage "graveAni","Heros\\grave.gif",41.5,90.7,8,12,1,0
        pupCreateLabelImage "houndAni","Heros\\hound.gif",41.5,90.7,8,13,1,0
        pupCreateLabelImage "highwaymanAni","Heros\\highwayman.gif",41.5,90.7,8,13,1,0
        pupCreateLabelImage "jesterAni","Heros\\jester.gif",45.9,90.7,8,13,1,0
        pupCreateLabelImage "vestalAni","Heros\\vestal.gif",58.3,90.7,8,13,1,0
        pupCreateLabelImage "plagueAni","Heros\\plague.gif",62.6,90.7,8,13,1,0
        pupCreateLabelImage "occultistAni","Heros\\Occultist.gif",71,90.7,8,13,1,0
        pupCreateLabelImage "crusaderAni","Heros\\crusader.gif",79.4,90.7,8,13,1,0

            '**** BOSS gifs****
        pupCreateLabelImage "ShamblerAni","GIFS\\ShamblerAni8.gif",76,42,30,50,1,0
        pupCreateLabelImage "DrownedCrewAni","GIFS\\DrownedCrewAni.gif",76,42,16,34,1,0
        pupCreateLabelImage "VvulfAni","GIFS\\VvulfAni.gif",76,42,27,50,1,0
        pupCreateLabelImage "ProphetAni","GIFS\\ProphetAni.gif",76,42,34,50,1,0
        pupCreateLabelImage "HagAni","GIFS\\HagAni.gif",76,40,30,50,1,0
        pupCreateLabelImage "SwinePrinceAni","GIFS\\SwinePrinceAni.gif",76,42,35,50,1,0

    pupCreateLabelImage "HoundDead","Heros\\HoundDead2.png",62.6,50.7,8,13,1,0
    pupCreateLabelImage "CrusaderDead","Heros\\CrusaderDead2.png",22.6,50.7,8,13,1,0
    pupCreateLabelImage "JesterDead","Heros\\JesterDead2.png",62.6,90.7,8,13,1,0
    pupCreateLabelImage "VestalDead","Heros\\VestalDead2.png",62.6,90.7,8,13,1,0
    pupCreateLabelImage "PlagueDead","Heros\\PlagueDead2.png",62.6,90.7,8,13,1,0
    pupCreateLabelImage "HighwaymanDead","Heros\\HighwaymanDead2.png",62.6,90.7,8,13,1,0
    pupCreateLabelImage "OccultistDead","Heros\\OccultistDead2.png",62.6,90.7,8,13,1,0
    pupCreateLabelImage "GraveDead","Heros\\GraveDead2.png",62.6,90.7,8,13,1,0
    pupCreateLabelImage "MonsterDead1","GIFS\\MonsterDead.png",59,48,13,35,1,0
    pupCreateLabelImage "MonsterDead2","GIFS\\MonsterDead.png",70,48,13,35,1,0
    pupCreateLabelImage "MonsterDead3","GIFS\\MonsterDeadTall.png",82,48,13,35,1,0
    pupCreateLabelImage "MonsterDead4","GIFS\\MonsterDeadTall.png",93,48,13,35,1,0

    pupCreateLabelImage "Blood10","Heros\\IconBleed.png",6.75,30,5,8,1,0
    pupCreateLabelImage "Blood11","Heros\\IconBleed.png",19,30,5,8,1,0
    pupCreateLabelImage "Blood12","Heros\\IconBleed.png",28.5,30,5,8,1,0
    pupCreateLabelImage "Blood13","Heros\\IconBleed.png",39.75,30,5,8,1,0

    pupCreateLabelImage "Wanted","Heros\\wantedFish.png",32.7,79,10,10,1,0  ' RTP7
    pupCreateLabelImage "RewardGold","Heros\\rewardgold.png",77.25,78.5,8,11,1,0

'************ Messaging *********************************
'labelNew <screen#>, <Labelname>, <fontName>,<size%>,<colour>,<rotation>,<xalign>,<yalign>,<xpos>,<ypos>,<PageNum>,<visible>
'    PuPlayer.LabelNew pBackglass,"KickBackStatus",dmddef, 5.5,255,0,0,1,28,76.5,1,0
'    PuPlayer.LabelNew pBackglass,"KickBackStatus2",dmddef, 5.5,255,0,0,1,29.4,80.6,1,0
'    PuPlayer.LabelNew pBackglass,"ExtraBallStatus",dmddef, 7,255,0,0,1,73.6,76,1,0
'    PuPlayer.LabelNew pBackglass,"ExtraBallStatus2",dmddef, 7,255,0,0,1,74.5,81,1,0
    PuPlayer.LabelNew pBackglass,"AutoFlip",dmddef, 4,33023,0,1,1,71.5,81,1,0
'    PuPlayer.LabelNew pBackglass,"SpecialStatus",dmddef, 4,16711808,0,1,1,73.5,75,1,0
'    PuPlayer.LabelNew pBackglass,"SpecialStatus2",dmddef, 4,16711808,0,1,1,73.5,79,1,0

    PuPlayer.LabelNew pDMD,"Guide1",dmddef, 15,33023,0,1,1,50,10,1,0
    PuPlayer.LabelNew pDMD,"Guide2",dmddef, 15,33023,0,1,1,50,30,1,0
    PuPlayer.LabelNew pDMD,"Guide3",dmddef, 15,33023,0,1,1,50,70,1,0
  PuPlayer.LabelNew pBackglass,"CryptMessage",    dmddef, 20,255  ,0,1,1,50,20,1,0
  PuPlayer.LabelNew pBackglass,"CryptMessage2",   dmddef, 20,255  ,0,1,1,50,40,1,0

    'PuPlayer.LabelNew pBackglass,"Scoop2Helper",dmddef, 14,33023,0,1,1,50,24,1,0
'Sub CreateLabel(lName, lValue, lFont, lSize, lColor, xpos, ypos, alignX, alignY, pagenum, lvis)
                        '***text labels

  '      pupCreateLabel      "Credits","5",dmddef,20,RGB(50,50,250),91.25,80,1,1,1,1
    PuPlayer.LabelNew pBackglass,"CountDownTimerMessage1",dmddef, 10,33023,0,1,1,50,20,1,0
    PuPlayer.LabelNew pBackglass,"CountDownTimerMessage2",dmddef, 10,33023,0,1,1,50,30,1,0
    PuPlayer.LabelNew pBackglass,"CountDownTimerMessage3",dmddef, 10,33023,0,1,1,50,40,1,0
    PuPlayer.LabelNew pBackglass,"CountDownTimerOn",dmddef, 24,255,0,1,1,50,55,1,0
'    PuPlayer.LabelNew pBackglass,"GambleCountDownTimerOn",dmddef, 20,255,0,1,1,49.5,76,1,0
    PuPlayer.LabelNew pBackglass,"GambleCountDownTimerOn",dmddef, 54,255,0,1,1,49.5,64,1,0
    PuPlayer.LabelNew pBackglass,"GambleRampHitsMessage",dmddef, 20,16711808,0,0,1,10,7.5,1,0
    PuPlayer.LabelNew pBackglass,"GamblePointsMessage",dmddef, 28,33023,0,1,1,49,54,1,0


    PuPlayer.LabelNew pBackglass,"BlacksmithTimerMessage1",dmddef, 8,33023,0,1,1,70,18,1,0
    PuPlayer.LabelNew pBackglass,"BlacksmithTimerMessage2",dmddef, 8,33023,0,1,1,70,27,1,0
    PuPlayer.LabelNew pBackglass,"BlacksmithTimerMessage3",dmddef, 8,33023,0,1,1,70,36,1,0
    PuPlayer.LabelNew pBackglass,"BlacksmithTimerMessage4",dmddef, 18,32768,0,1,1,65.5,54,1,0
    PuPlayer.LabelNew pBackglass,"BlacksmithTimerOn",dmdscr, 35,255,0,1,1,76.5,21,1,0

    PuPlayer.LabelNew pBackglass,"TorchHitsMessage",dmddef, 20,16711808,0,0,1,10,7.5,1,0
    PuPlayer.LabelNew pBackglass,"TorchCountDownTimerOn",dmddef, 54,255,0,1,1,49.5,64,1,0

    PuPlayer.LabelNew pBackglass,"DungeonTimerMessage1",dmddef, 10,33023,0,1,1,50,14,1,0
    PuPlayer.LabelNew pBackglass,"DungeonTimerMessage2",dmddef, 10,33023,0,1,1,50,26,1,0
    PuPlayer.LabelNew pBackglass,"DungeonTimerMessage3",dmddef, 10,33023,0,1,1,50,38,1,0
    PuPlayer.LabelNew pBackglass,"DungeonTimerOn",dmddef, 12,255,0,1,1,50,46,1,0

    pupCreateLabel      "HeartMeter",HeroCountDown,dmddef,18,16744448,15.75,88,1,1,1,0
    pupCreateLabelImage "KickbackGIF","GIFs\\kickback.gif",32.7,78.9,11,14,1,0
    pupCreateLabelImage "ExtraballGIF","GIFs\\ExtraBall.gif",77.6,78.1,16,15,1,0
   ' pupCreateLabelImage "RewardGIF","GIFs\\Reward.gif",77.6,78.1,16,15,1,0

    'pupCreateLabel      "TorchMeter",TorchTimerCount,dmddef,15,16744448,20,74,1,1,1,0

'PuPlayer.LabelSet pBackglass,"HeartMeter", "25",1,"{'mt':2,'color':16744448, 'size':13.25, 'xpos': 15.75, 'xalign': 1, 'ypos': 78, 'yalign': 0 }"

' End of ball messaging

  PuPlayer.LabelNew pBackglass,"bonusMessageTitle",dmddef, 11.5,33023,0,1,1,46,33.4,1,0
  PuPlayer.LabelNew pBackglass,"bonusMessage",dmddef, 13,255,0,1,1,51,53.25,1,0
  PuPlayer.LabelNew pBackglass,"TotalMessage",dmddef, 11,16777215,0,1,1,56,74.75,1,0

'end of game messaging
  PuPlayer.LabelNew pBackglass,"ContinueMessage",   dmddef, 25,255  ,0,1,1,50,25,1,0
  PuPlayer.LabelNew pBackglass,"FinalScore",    dmddef, 25,255  ,0,1,1,50,12,1,0

' PuPlayer.LabelNew pDMD, "Line1b",dmdscr,      30,cGold  ,0,1,1, 50,20,  1,0
' PuPlayer.LabelNew pDMD, "Line2b",dmdscr,      30,cWhite ,0,1,1, 50,60,  1,0

  PuPlayer.LabelNew pBackglass, "Line1b",dmdscr,      25,cGold  ,0,1,1, 50,32,  1,0
  PuPlayer.LabelNew pBackglass, "Line2b",dmdscr,      25,cWhite ,0,1,1, 50,55,  1,0

  PuPlayer.LabelNew pBackglass, "HS-Title",dmdscr,      20,cRed ,0,1,1, 50,12,  1,0
  PuPlayer.LabelNew pBackglass, "HS-Score",dmdscr,      20,cWhite ,0,1,1, 50,32,  1,0
  PuPlayer.LabelNew pBackglass, "HS-Name",dmdscr,       20,cWhite ,0,1,1, 50,52,  1,0



'***************************************************************************************************************
'**********************   DMD TYPE 0 NO DMD         ***************************************************
'***************************************************************************************************************

if DMDType = 0 Then

  'Page 1 (default score display)

  PuPlayer.LabelNew pBackglass,"CurrScore",         dmdscr,10,255   ,0,1,1, 16.0,4,1,0
  PuPlayer.LabelNew pBackglass,"Mode",               dmdscr,7,255   ,0,1,1, 80.5,4,1,0
  PuPlayer.LabelNew pBackglass,"Ball",               dmdscr,10,255   ,0,1,1,97.25,4,1,0
  PuPlayer.LabelNew pBackglass,"ExtraballDMD",     dmdscr,5,cWhite   ,0,0,1,94.5,4,1,0

    pupCreateLabelImage "BlacksmithOn","SideModes\\blacksmithOn.png",35.8,4.8,6,7.7,1,0
    pupCreateLabelImage "GambleOn","SideModes\\gambleOn.png",43,4.8,6,7.6,1,0
    pupCreateLabelImage "InTheDarkOn","SideModes\\inTheDarkOn.png",50.2,4.8,5.8,7.6,1,0
    pupCreateLabelImage "GoldSackOn","SideModes\\goldSackOn.png",57,4.8,6,7.6,1,0
    pupCreateLabelImage "MagnetOn","SideModes\\magnetOn.png",63.9,5.0,6,8,1,0
    pupCreateLabelImage "MagnetLocked","GIFs\\magnetLocked2.gif",63.9,5.0,6,8,1,0

  PuPlayer.LabelNew pBackglass,"SpinnerCounts", dmddef, 4.5,cYellow ,0,1,1,46.3,82.6,1,0
  PuPlayer.LabelNew pBackglass,"RampCounts",    dmddef, 4.5,cYellow ,0,1,1,51.3,82.6,1,0
  PuPlayer.LabelNew pBackglass,"torchcounts",   dmddef, 4.5,cYellow ,0,1,1,56.3,82.6,1,0
  PuPlayer.LabelNew pBackglass,"GoldSackCount", dmddef, 4.5,cYellow ,0,1,1,61.3,82.6,1,0
  PuPlayer.LabelNew pBackglass,"MagnetLockedText",dmddef,5.25,cYellow ,0,0,0,66.5,82.6,1,0

    PuPlayer.LabelNew pBackglass,"DSHelper",dmddef, 14,33023,0,1,1,50,30,1,0

' PuPlayer.LabelNew pBackglass,"CurrScore",         dmdscr,7,33023   ,0,1,1,18.0,7.0,1,0
' PuPlayer.LabelNew pBackglass,"Mode",               dmdscr,7,33023   ,0,1,1,86.6.4,1,0
  'PuPlayer.LabelNew pBackglass,"LockedBalls",     dmdscr,8,255   ,0,1,1,75.4,81.5,1,0
' PuPlayer.LabelNew pBackglass,"Ball"    ,             dmdscr,8,255   ,0,1,1,27.4,81.35,1,0


  PuPlayer.LabelNew pBackglass,"ContinueMessage",   dmddef, 25,255  ,0,1,1,50,25,1,0
  PuPlayer.LabelNew pBackglass,"FinalScore",    dmddef, 25,255  ,0,1,1,50,25,1,0
  PuPlayer.LabelNew pBackglass,"TotalMessage",dmddef, 6,16777215,0,1,1,56,74.75,1,0
  PuPlayer.LabelNew pBackglass,"bonusMessageTitle",dmddef, 8,33023,0,1,1,50,33.5,1,0
  PuPlayer.LabelNew pBackglass,"bonusMessage",dmddef, 9,255,0,1,1,51,53.25,1,0

End If ' end of DMD Type Check

'***************************************************************************************************************
'**********************   DMD TYPE 1 LCD DMD   4:1  ***************************************************
'***************************************************************************************************************
'RMW5
if  DMDType = 1 Then  ' LCD DMD
    'dmddef="Impact"

  'Page 1 (default score display)


  PuPlayer.LabelNew pDMD,"Player",         dmdscr,12,255   ,0,1,0,82.75,81,1,0
    PuPlayer.LabelNew pDMD,"Mode",               dmdscr,11,255   ,0,1,0,15.9,84.0,1,1
  PuPlayer.LabelNew pDMD,"Ball"    ,             dmdscr,18,255   ,0,1,1,97.3,12.6,1,0
  PuPlayer.LabelNew pDMD,"CurrScoreDMD",    dmdscr, 40,255  ,0,1,1,37,40,1,0                    '****Side mode Icons****
    'pupCreateLabelImageDMD "BlacksmithOn","SideModes\\blacksmithOn.png",28.2,7.75,9,11,1,0
    pupCreateLabelImageDMD "BlacksmithOn","SideModes\\blacksmithOn.png",36.0,84.5,6,17,1,0
    pupCreateLabelImageDMD "GambleOn","SideModes\\gambleOn.png",43.2,85,6,17,1,0
    pupCreateLabelImageDMD "InTheDarkOn","SideModes\\inTheDarkOn.png",50.3,84.3,5.8,17,1,0
    pupCreateLabelImageDMD "GoldSackOn","SideModes\\goldSackOn.png",57.1,84.5,6,17,1,0
    pupCreateLabelImageDMD "MagnetOn","SideModes\\magnetOn.png",64,84.4,6,17,1,0
    pupCreateLabelImageDMD "MagnetLocked","GIFs\\magnetLocked2.gif",64,84.4,6,17,1,0
  PuPlayer.LabelNew pDMD,"ExtraballDMD",     dmdscr,12,cWhite   ,0,0,0,93,5.7,1,0

  PuPlayer.LabelNew pDMD,"SpinnerCounts",   dmddef, 4.5,cYellow ,0,1,1,46.3,82.6,1,0
  PuPlayer.LabelNew pDMD,"RampCounts",    dmddef, 4.5,cYellow ,0,1,1,51.3,82.6,1,0
  PuPlayer.LabelNew pDMD,"torchcounts",   dmddef, 4.5,cYellow ,0,1,1,56.3,82.6,1,0
  PuPlayer.LabelNew pDMD,"GoldSackCount", dmddef, 4.5,cYellow   ,0,1,1,61.3,82.6,1,0
  PuPlayer.LabelNew pDMD,"MagnetLockedText",dmddef,5.25,cYellow   ,0,0,0,66.5,82.6,1,0

  PuPlayer.LabelNew pDMD,"titlebg",dmddef,        25,16777215          ,0,1,1,540,400,1,1
  PuPlayer.LabelNew pDMD,"title",dmddef,            25,16777215     ,0,1,1,540,400,1,1
  PuPlayer.LabelNew pDMD,"titlebg2",dmddef,        25,16777215          ,0,1,1,540,400,1,1
  PuPlayer.LabelNew pDMD,"title2",dmddef,            25,16777215     ,0,1,1,540,400,1,1

' PuPlayer.LabelNew pBackglass,"ContinueMessage",   dmddef, 25,255  ,0,1,1,50,25,1,0
' PuPlayer.LabelNew pBackglass,"FinalScore",    dmddef, 25,255  ,0,1,1,50,25,1,0
' PuPlayer.LabelNew pDMD,"CurrScoreDMD",    dmdscr, 65,255  ,0,1,1,37,40,1,0
' PuPlayer.LabelNew pDMD,"FinalScoreDMD",   dmddef, 65,255  ,0,1,1,37,40,1,0
' PuPlayer.LabelNew pDMD,"CurrScoreDMD",    dmddef, 65,33023  ,0,1,1,37,40,1,0


' PuPlayer.LabelNew pBackglass,"TotalMessage",dmddef, 11,16777215,0,1,1,56,74.75,1,0
' PuPlayer.LabelNew pBackglass,"bonusMessageTitle",dmddef, 10,33023,0,1,1,50,33.5,1,0
' PuPlayer.LabelNew pBackglass,"bonusMessage",dmddef, 13,255,0,1,1,51,53.25,1,0
End If ' end of DMD Type Check

'***************************************************************************************************************
'**********************   DMD TYPE 2 FULL DMD ********************************************************
'***************************************************************************************************************

if DMDType = 2 Then   ' Full DMD
    'dmddef="Impact"



  'Page 1 (default score display)


                    '****Side mode Icons****
    pupCreateLabelImageDMD "BlacksmithOn","SideModes\\blacksmithOn.png",28.2,7.75,9,11,1,0
    pupCreateLabelImageDMD "GambleOn","SideModes\\gambleOn.png",38.9,8.0,9,11.2,1,0
    pupCreateLabelImageDMD "InTheDarkOn","SideModes\\inTheDarkOn.png",49.4,7.7,8.9,11,1,0
    pupCreateLabelImageDMD "GoldSackOn","SideModes\\goldSackOn.png",59.4,7.6,9,11.2,1,0
    pupCreateLabelImageDMD "MagnetOn","SideModes\\magnetOn.png",69.5,7.7,9.1,11,1,0
    pupCreateLabelImageDMD "MagnetLocked","GIFs\\magnetLocked2.gif",69.5,7.7,9.1,11,1,0

  PuPlayer.LabelNew pDMD,"SpinnerCounts",   dmddef, 4.5,cYellow ,0,1,1,46.3,12.6,1,0
  PuPlayer.LabelNew pDMD,"RampCounts",    dmddef, 4.5,cYellow ,0,1,1,51.3,12.6,1,0
  PuPlayer.LabelNew pDMD,"torchcounts",   dmddef, 4.5,cYellow ,0,1,1,56.3,12.6,1,0
  PuPlayer.LabelNew pDMD,"GoldSackCount", dmddef, 4.5,cYellow   ,0,1,1,61.3,12.6,1,0
  PuPlayer.LabelNew pDMD,"MagnetLockedText",dmddef,5.25,cYellow   ,0,0,0,66.5,12.6,1,0


  PuPlayer.LabelNew pDMD,"CurrScore",         dmdscr,15,255   ,0,1,1, 21.0,92.3,1,0
  PuPlayer.LabelNew pDMD,"Mode",               dmdscr,11,255   ,0,1,1, 62.5,92.3,1,0
  PuPlayer.LabelNew pDMD,"Ball",               dmdscr,15,255   ,0,1,1,91.25,92.3,1,0
  PuPlayer.LabelNew pDMD,"ExtraballDMD",     dmdscr,10,cWhite   ,0,1,1,87.25,92.3,1,0

  PuPlayer.LabelNew pDMD,"FinalScoreDMD",   dmdscr, 40,255,0,1,1,50,40,1,0


End If ' end of DMD Type Check

'********************************************************************************************************************
'****************   END SET PAGE LAYUOTS **************************************************************
'********************************************************************************************************************


End Sub 'page Layouts
'++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++

Sub MonsterGIFs

'**** RUINS MONSTER gifs****
        pupCreateLabelImage "SkelCaptain","GIFS\\CaptainAni8.gif",10,10,13,35,1,0
        pupCreateLabelImage "SkelShield","GIFS\\SkelShield.gif",10,10,13,35,1,0
        pupCreateLabelImage "SkelClub","GIFS\\SkelClub.gif",10,10,13,35,1,0
        pupCreateLabelImage "SkelSword","GIFS\\SkelSword.gif",10,10,13,35,1,0
        pupCreateLabelImage "SkelSpear","GIFS\\SkelSpear.gif",10,10,13,35,1,0
        pupCreateLabelImage "Courtier","GIFS\\Courtier.gif",10,10,13,35,1,0
        pupCreateLabelImage "Collector","GIFS\\Collector.gif",10,10,13,35,1,0
'**** COVE MONSTER gifs****
        pupCreateLabelImage "Bloated","GIFS\\Bloated.gif",10,10,13,35,1,0
        pupCreateLabelImage "Fish","GIFS\\FishAni8.gif",10,10,13,35,1,0
        pupCreateLabelImage "Jellyfish","GIFS\\jellyfish.gif",10,10,13,35,1,0
        pupCreateLabelImage "Pirate","GIFS\\pirate.gif",10,10,13,35,1,0
        pupCreateLabelImage "Shaman","GIFS\\Shaman.gif",10,10,13,35,1,0
        pupCreateLabelImage "Snail","GIFS\\Snail.gif",10,10,13,35,1,0
'**** WEALD MONSTER gifs****
        pupCreateLabelImage "Bloat","GIFS\\Bloat.gif",10,10,13,35,1,0
        pupCreateLabelImage "Blob","GIFS\\blob.gif",10,10,13,35,1,0
        pupCreateLabelImage "Brigand","GIFS\\brigand.gif",10,10,13,35,1,0
        pupCreateLabelImage "Crone","GIFS\\crone.gif",10,10,13,35,1,0
        pupCreateLabelImage "Fungus","GIFS\\fungus.gif",10,10,13,35,1,0
        pupCreateLabelImage "Virago","GIFS\\virago.gif",10,10,13,35,1,0
'**** WARRENS MONSTER gifs****
        pupCreateLabelImage "Eater","GIFS\\Eater8.gif",10,10,13,35,1,0
        pupCreateLabelImage "Flesh","GIFS\\flesh.gif",10,10,13,35,1,0
        pupCreateLabelImage "Skiver","GIFS\\skiver8.gif",10,10,13,35,1,0
        pupCreateLabelImage "Slasher","GIFS\\slasher8.gif",10,10,13,35,1,0
        pupCreateLabelImage "Wretch","GIFS\\wretch8.gif",10,10,13,35,1,0
        pupCreateLabelImage "Ghoul","GIFS\\GhoulAni8.gif",93,50,13,35,1,0
End Sub

Sub MonsterDMDGIFs

'**** RUINS MONSTER gifs****
        pupCreateLabelImageDMD "SkelCaptain","GIFS\\CaptainAni8.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "SkelShield","GIFS\\SkelShield.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "SkelClub","GIFS\\SkelClub.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "SkelSword","GIFS\\SkelSword.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "SkelSpear","GIFS\\SkelSpear.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Courtier","GIFS\\Courtier.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Collector","GIFS\\Collector.gif",10,10,13,35,1,0
'**** COVE MONSTER gifs****
        pupCreateLabelImageDMD "Bloated","GIFS\\Bloated.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Fish","GIFS\\FishAni8.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Jellyfish","GIFS\\jellyfish.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Pirate","GIFS\\pirate.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Shaman","GIFS\\Shaman.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Snail","GIFS\\Snail.gif",10,10,13,35,1,0
'**** WEALD MONSTER gifs****
        pupCreateLabelImageDMD "Bloat","GIFS\\Bloat.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Blob","GIFS\\blob.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Brigand","GIFS\\brigand.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Crone","GIFS\\crone.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Fungus","GIFS\\fungus.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Virago","GIFS\\virago.gif",10,10,13,35,1,0
'**** WARRENS MONSTER gifs****
        pupCreateLabelImageDMD "Eater","GIFS\\Eater8.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Flesh","GIFS\\flesh.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Skiver","GIFS\\skiver8.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Slasher","GIFS\\slasher8.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Wretch","GIFS\\wretch8.gif",10,10,13,35,1,0
        pupCreateLabelImageDMD "Ghoul","GIFS\\GhoulAni8.gif",93,50,13,35,1,0
End Sub


Sub pDMDSplashBig(msgText,timeSec, mColor)   'note timesec is seconds( 2, 3..etc) , if timesec>1000 then its ms. (2300, 3200)
PuPlayer.LabelShowPage pDMD,2,timeSec,""
PuPlayer.LabelSet pDMD,"Splash",msgText,0,"{'mt':1,'at':1,'fq':150,'len':" & (timeSec*1000) & ",'fc':" & mColor & "}"
end sub

Sub DisplayGuideMessages
  'SetGuideShadows
  PuPlayer.LabelSet pDMD,"Guide1",GuideMessage1,1,""
  PuPlayer.LabelSet pDMD,"Guide2",GuideMessage2,1,""
  PuPlayer.LabelSet pDMD,"Guide3",GuideMessage3,1,""
End Sub

'ModeString = "{'mt':2,'color':255, 'size': 10, 'xpos': 65.5, 'xalign': 1, 'ypos': 87.5, 'yalign': 1 }"

'************************ called during gameplay to update Scores ***************************
Sub ScoreUpdate
  if bSupressDMD = False And bDecision = False Then
'   if DMDType <> 0 And bDrain = 0 Then
    if DMDType <> 0 Then ' 132.8
      PuPlayer.LabelSet pDMD,"CurrScore",FormatNumber(Score(CurrentPlayer),0),1,""
      PuPlayer.LabelSet pDMD,"CurrScoreDMD",FormatNumber(Score(CurrentPlayer),0),1,""
      Exit Sub
    End If


    if DMDType <> 0 And InGuide = 0 Then
      PuPlayer.LabelSet pDMD,"CurrScore",FormatNumber(Score(CurrentPlayer),0),1,""
      PuPlayer.LabelSet pDMD,"CurrScoreDMD",FormatNumber(Score(CurrentPlayer),0),1,""
    Elseif DMDType <> 0 And InGuide = 1 Then
      PuPlayer.LabelSet pDMD,"CurrScore",FormatNumber(Score(CurrentPlayer),0),0,""
      PuPlayer.LabelSet pDMD,"CurrScoreDMD",FormatNumber(Score(CurrentPlayer),0),1,""
    End If
  Else
    Debug "ScoreUpdate SUPRESSED"
  End If

if bSupressBGMessages = False Then
  PuPlayer.LabelSet pBackglass,"CurrScore",FormatNumber(Score(CurrentPlayer),0),1,""
Else
  PuPlayer.LabelSet pBackglass,"CurrScore","",0,""
End If

' if ScorbitActive then
'   if Scorbit.bSessionActive then
'     NameStr=Scorbit.GetName(CurrentPlayer)
'     if NameStr<>"" then
'       puPlayer.LabelSet pDMD,"Credits","Credits: " & ""& Credits & "./ " & NameStr & " / BALL: " & BallinPlay ,1,""
'     Else
'       puPlayer.LabelSet pDMD,"Credits","Credits: " & ""& Credits & "./ PLAYER: " & CurrentPlayer & " / BALL: " & BallinPlay ,1,""
'     End if
'   End if
' Else
'   puPlayer.LabelSet pDMD,"Credits","Credits: " & ""& Credits & "./ PLAYER: " & CurrentPlayer & " / BALL: " & BallinPlay ,1,""
' End if

End Sub

Sub UpdatePlayer
  PuPlayer.LabelSet pDMD,"Player", "Player 1",1,""
End Sub

Sub HidePlayer
  PuPlayer.LabelSet pDMD,"Player", "",0,""
end Sub

Sub UpdateModeLabels
  if bSupressDMD = False Then
    if DMDType <> 0 Then
      PuPlayer.LabelSet pDMD,"Mode", ModeTitle,1,""
      Exit Sub
    End If

    if DMDType <> 0 And InGuide = 0 Then
      PuPlayer.LabelSet pDMD,"Mode", ModeTitle,1,""
    Elseif DMDType <> 0 And InGuide = 1 Then
      PuPlayer.LabelSet pDMD,"Mode", ModeTitle,0,""
    End If
  'PuPlayer.LabelSet pBackglass,"ModeString","Mode " & ActiveMode &":"&AMState,1,"{'mt':2,'color':33023, 'size': 3, 'xpos': 88, 'xalign': 0, 'ypos': 71, 'yalign': 0 }"
  Else
    Debug "########   UpdateModeLabels SUPRESSED"
  End If

  if bSupressBGMessages = False Then
'   if DMDType = 0 And InGuide = 0 Then
'     PuPlayer.LabelSet pBackglass,"Mode", ModeTitle,1,""
'   Elseif DMDType = 0 And InGuide = 1 Then
    PuPlayer.LabelSet pBackglass,"Mode", ModeTitle,1,""
'   End If
  Else
    PuPlayer.LabelSet pBackglass,"Mode", ModeTitle,0,""
  End If
End Sub


Sub UpdateBalls
Debug2 "in update balls"
  if bSupressDMD = False Then
    if DMDType <> 0 Then
      Debug "should be updating ball value: " &Balls
      'PuPlayer.LabelSet pDMD,"Ball"," "  &  Balls ,1,"{'mt':2,'xpos': 91.4,  'ypos': 92.3 }"
      PuPlayer.LabelSet pDMD,"Ball"," "  &  Balls ,1,""
      Exit Sub
    End If

    if DMDType <> 0 And InGuide = 0 Then
      'PuPlayer.LabelSet pDMD,"Ball"," "  &  Balls ,1,"{'mt':2,'xpos': 91.4,  'ypos': 92.3 }"
      PuPlayer.LabelSet pDMD,"Ball"," "  &  Balls ,1,""
    Elseif DMDType <> 0 And InGuide = 1 Then
      Debug "ball value suppressed due to inguide -1: " &Balls
      PuPlayer.LabelSet pDMD,"Ball"," "  &  Balls ,0,""
    End If
  End If

  if bSupressBGMessages = False Then
    if DMDType = 0 And InGuide = 0 Then
      PuPlayer.LabelSet pBackglass,"Ball"," "  &  Balls ,1,""
    Elseif DMDType = 0 And InGuide = 1 Then
      PuPlayer.LabelSet pBackglass,"Ball"," "  &  Balls ,0,""
    End If
  Else
    PuPlayer.LabelSet pBackglass,"Ball"," "  &  Balls ,0,""
  End If
End Sub

Sub UpdateAll
  debug5 "Called UpdateAll"
  if bEOBSupress = False Then
    if bEndOfGame = False And bSupressDMD = False And bDecision = False Then
      ScoreUpdate
      UpdatePlayer
      UpdateModeLabels
      UpdateBalls
      pBackglasslabelshow "PRE"& NextChar
      DisplayOverlayCounts
      DisplayMagnetMessages
    End If
  Else
    Triggerscript 3000, "UpdateAll"
  End If  ' end of dmdtype <> 2

  if bSupressBGMessages = False And DMDType = 0 And bEOBSupress = False Then
    if bDecision = False And bEndOfGame = False Then
      ScoreUpdate
      UpdatePlayer
      UpdateModeLabels
      UpdateBalls
      pBackglasslabelshow "PRE"& NextChar
        'DisplayOverlayCounts
        'DisplayMagnetMessages
        '''pUpdateDev
    End If
  End If
End Sub

Sub UpdateBG
'exit sub
Debug5 "In UpdateBG - Supress? " &bSupressBGMessages
  If bSupressBGMessages = False And DMDType = 0 Then
    GeneralPupQueue.Add "Pup400","pupevent 400",94,0,0,0,0,True
    ScoreUpdate
    UpdatePlayer
    UpdateModeLabels
    UpdateBalls
    DisplayOverlayCounts
    DisplayMagnetMessages
  End If
End Sub

Sub UpdateDMD
'exit sub
Debug5 "In UpdateDMD - Supress? " &bSupressDMD &":" &bDecision
  If bSupressDMD = False And bDecision = False And DMDType <> 0 Then
    Debug2 "UpdateDMD -- PASSED TEST:" &bDecision
    ScoreUpdate
    UpdatePlayer
    UpdateModeLabels
    UpdateBalls
    DisplayOverlayCounts
    DisplayMagnetMessages
  End If
End Sub

Sub UpdateDecision
  Debug5 "In UpdateDecision"
  if DMDType <> 0 Then
    DisplayOverlayCounts
    DisplayMagnetMessages
    ScoreUpdate
    UpdatePlayer
    UpdateModeLabels
    UpdateBalls
  Elseif bSupressBGMessages = False then
    ScoreUpdate
    UpdatePlayer
    UpdateModeLabels
    UpdateBalls
  End If
End Sub

Sub HideDMDInfinite
'Exit Sub
  if DMDType = 2 Then
    bSupressDMD = True
    Debug "In HideDMD Infinite"
    HideOverlayIcons
    HideOverlayCounts
    PuPlayer.LabelSet pDMD,"Ball","",0,""
    PuPlayer.LabelSet pDMD,"Mode", "",0,""
    PuPlayer.LabelSet pDMD,"CurrScore","",0,""
  End If
End Sub

Sub HideDMD(ms,RDG)
'Exit Sub
if DMDType = 2 Then
  Debug "In HideDMD: "&ms &" :" & RDG
  'InGuide = 1

  PuPlayer.LabelSet pDMD,"Ball","",0,""
  PuPlayer.LabelSet pDMD,"Mode", "",0,""
  PuPlayer.LabelSet pDMD,"CurrScore","",0,""

  HideOverlayIcons
  HideOverlayCounts

  'triggerscript ms,"InGuide = 0 "
  if RDG = True then triggerscript ms+100, "RedisplayGuide "
  bSupressDMD = True

  BallHandlingQueue.Add "bSupressDMD-F","bSupressDMD = False",40,ms,0,0,0,False
  BallHandlingQueue.Add "UpdateDMD","UpdateDMD",40,ms+200,0,0,0,False

  'triggerscript ms, "bSupressDMD = False " ' Added 126.6
  'triggerscript ms+200, "UpdateDMD "
End If
End Sub

Sub HideBG2(ms)

  'BallHandlingQueue.Add "bSupressBGMessages-T","bSupressBGMessages = True",40,0,0,0,0,False
  bSupressBGMessages = True
  GeneralPupQueue.Add "Pup450","pupevent 450",98,0,0,0,0,True
  BallHandlingQueue.Add "bSupressBGMessages-F","bSupressBGMessages = False",40,ms,0,0,0,False
  GeneralPupQueue.Add "Pup400","pupevent 400",50,ms,0,0,0,True
  BallHandlingQueue.Add "UpdateBG","UpdateBG",40,ms+200,0,0,0,False

'if DMDType = 0 Then
  'HideBGOverlayIcons
  'HideBGOverlayCounts
  'GeneralPupQueue.Add "Pup300","pupevent 300",94,0,0,0,0,True

  PuPlayer.LabelSet pBackglass,"ExtraballDMD","",0,""
  PuPlayer.LabelSet pBackglass,"CurrScore","",0,""
  PuPlayer.LabelSet pBackglass,"Mode", ModeTitle,0,""
  PuPlayer.LabelSet pBackglass,"Ball"," "  &  Balls ,0,""

  pBackglassLabelHide "BlacksmithOn"
  pBackglassLabelHide "GambleOn"
  pBackglassLabelHide "InTheDarkOn"
  pBackglassLabelHide "GoldSackOn"
  pBackglassLabelHide "MagnetOn"
  pBackglassHideAnimate "MagnetLocked"

  PuPlayer.LabelSet pBackglass,"spinnercounts","",0,""
  PuPlayer.LabelSet pBackglass,"rampcounts","",0,""
  PuPlayer.LabelSet pBackglass,"torchcounts","",0,""
  PuPlayer.LabelSet pBackglass,"GoldSackCount","",0,""
  PuPlayer.LabelSet pBackglass, "MagnetLockedText", "", 0, ""



'End If
End Sub

Sub ClearDMDGuide
Debug "*************** Called Clear DMD Guide"
  if DMDType = 2 Then
    GeneralPupQueue.Add "Pup310","pupevent 310",91,0,0,0,0,True
  Else
    GeneralPupQueue.Add "Pup511","pupevent 511",90,0,0,0,0,True
  End If
End Sub

Sub HideBG
' PuPlayer.LabelSet pDMD,"ExtraballDMD","",0,""
  PuPlayer.LabelSet pBackglass,"ExtraballDMD","",0,""
  PuPlayer.LabelSet pBackglass,"CurrScore","",0,""
  PuPlayer.LabelSet pBackglass,"Mode", "",0,""
  PuPlayer.LabelSet pBackglass,"Ball"," "  &  Balls ,0,""

  pBackglassLabelHide "BlacksmithOn"
  pBackglassLabelHide "GambleOn"
  pBackglassLabelHide "InTheDarkOn"
  pBackglassLabelHide "GoldSackOn"
  pBackglassLabelHide "MagnetOn"
  pBackglassHideAnimate "MagnetLocked"

  PuPlayer.LabelSet pBackglass,"spinnercounts","",0,""
  PuPlayer.LabelSet pBackglass,"rampcounts","",0,""
  PuPlayer.LabelSet pBackglass,"torchcounts","",0,""
  PuPlayer.LabelSet pBackglass,"GoldSackCount","",0,""
  PuPlayer.LabelSet pBackglass, "MagnetLockedText", "", 0, ""
End Sub

Sub pUpdateScores(DMDType)
'Dim Location
'if DMDType = 0 Then Location = pBackglass
'if DMDType = 1 Then Location = pDMD
'if DMDType = 2 Then Location = pDMD

  '   PuPlayer.LabelSet pBackglass,"DarkString","Torches: " &TLV,1,"{'mt':2,'color':65535, 'size': 3, 'xpos': 88.0, 'xalign': 0, 'ypos': 68.1, 'yalign': 0 }"
      'PuPlayer.LabelSet pBackglass,"ModeString","Mode " & ActiveMode &":"&AMState,1,"{'mt':2,'color':33023, 'size': 3, 'xpos': 88, 'xalign': 0, 'ypos': 71, 'yalign': 0 }"
      'PuPlayer.LabelSet pBackglass,"Partysize","Party " & PartyString,1,"{'mt':2,'color':16711680, 'size': 3, 'xpos': 88, 'xalign': 0, 'ypos': 74, 'yalign': 0 }"
      'PuPlayer.LabelSet pBackglass,"MonsterString","Monster " & MonsterString,1,"{'mt':2,'color':16744576, 'size': 3, 'xpos': 88, 'xalign': 0, 'ypos': 77, 'yalign': 0 }"
      'PuPlayer.LabelSet pBackglass,"ItemString","Item " & ItemString,1,"{'mt':2,'color':4259584, 'size': 3, 'xpos': 88, 'xalign': 0, 'ypos': 80, 'yalign': 0 }"


End Sub

Sub CreateStrings
  CreateDarkString
  CreatePartyString
  CreateMonsterString
  CreateItemString
End Sub

Dim bFlapper: bFlapper = 0

Sub pUpdateDev
getAM
debugKB = 1
  if bDisplayDev = "True" Then
    CreateStrings
    'PuPlayer.LabelSet pBackglass,"DarkString","DARK " &DarkString,1,"{'mt':2,'color':65535, 'size': 3, 'xpos': 20, 'xalign': 0, 'ypos': 68.1, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"ModeString","Mode " & ActiveMode &":"&AMState,1,"{'mt':2,'color':33023, 'size': 2.75, 'xpos': 29.4, 'xalign': 0, 'ypos': 72, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"Partysize","Party " & PartyString,1,"{'mt':2,'color':65535, 'size': 2.5, 'xpos': 27.8, 'xalign': 0, 'ypos': 74.9, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"MonsterString","Monster " & MonsterString,1,"{'mt':2,'color':16744576, 'size': 2.75, 'xpos': 27.8, 'xalign': 0, 'ypos': 77.75, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"ItemString","Item " & ItemString,1,"{'mt':2,'color':4259584, 'size': 2.75, 'xpos': 29, 'xalign': 0, 'ypos': 80.8, 'yalign': 0 }"
  End If
End Sub

sub HideDev
  triggerscript 10000, "bDisplayDev = True"
    'PuPlayer.LabelSet pBackglass,"DarkString","DARK " &DarkString,0,"{'mt':2,'color':65535, 'size': 3, 'xpos': 20, 'xalign': 0, 'ypos': 68.1, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"ModeString","Mode " & ActiveMode &":"&AMState,0,"{'mt':2,'color':33023, 'size': 3, 'xpos': 20, 'xalign': 0, 'ypos': 71, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"Partysize","Party " & PartyString,0,"{'mt':2,'color':16711680, 'size': 3, 'xpos': 20, 'xalign': 0, 'ypos': 74, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"MonsterString","Monster " & MonsterString,0,"{'mt':2,'color':16744576, 'size': 3, 'xpos': 20, 'xalign': 0, 'ypos': 77, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"ItemString","Item " & ItemString,0,"{'mt':2,'color':4259584, 'size': 3, 'xpos': 20, 'xalign': 0, 'ypos': 80, 'yalign': 0 }"
End Sub

Sub MultiPlayerScoring
    If CurrentPlayer = 1 Then

      If PlayersPlayingGame = 2 Then
        PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':8421504, 'size': 3, 'xpos': 71, 'xalign': 0, 'ypos': 79.5, 'yalign': 0  }"
        PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504, 'size': 3, 'xpos': 72.5, 'xalign': 0, 'ypos': 75.8, 'yalign': 0 }"

      End If
      If PlayersPlayingGame = 3 Then
        PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
      End If
      If PlayersPlayingGame = 4 Then
        PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':8421504}"
      End If
    End If

    If CurrentPlayer = 2 Then
      PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':33023, 'size': 3, 'xpos': 71, 'xalign': 0, 'ypos': 79.5, 'yalign': 0  }"
      PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':65535, 'size': 3, 'xpos': 72.5, 'xalign': 0, 'ypos': 75.8, 'yalign': 0 }"
      If PlayersPlayingGame = 2 Then
        PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 3,  'xpos': 71, 'xalign': 0, 'ypos': 71.9, 'yalign': 0 }"
        PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504, 'size': 3, 'xpos': 72.5, 'xalign': 0, 'ypos': 68.5, 'yalign': 0 }"
      End If
      If PlayersPlayingGame = 3 Then
        PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
      End If
      If PlayersPlayingGame = 4 Then
        PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':8421504}"
      End If
    End If

    If CurrentPlayer = 3 Then
      PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 2.4 }"
      PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':16777215 }"
      If PlayersPlayingGame = 3 Then
        PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
      End If
      If PlayersPlayingGame = 4 Then
        PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':8421504}"
      End If
    End If
    If CurrentPlayer = 4 Then
      PuPlayer.LabelSet pBackglass,"Play4score","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 2.4 }"
      PuPlayer.LabelSet pBackglass,"Play4","Player 4",1,"{'mt':2,'color':16777215 }"
      If PlayersPlayingGame = 4 Then
        PuPlayer.LabelSet pBackglass,"Play1score","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play1","Player 1",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play2score","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play2","Player 2",1,"{'mt':2,'color':8421504}"
        PuPlayer.LabelSet pBackglass,"Play3score","" & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 2.4 }"
        PuPlayer.LabelSet pBackglass,"Play3","Player 3",1,"{'mt':2,'color':8421504}"
      End If
    End If
End Sub



Sub Test

End Sub

'------------------------------
'PNOTE

  Dim titlepos
  titlepos = 0
  titletimer.enabled = 0
  dim title
  title = ""
  dim subtitle



  Sub titletimer_timer
    titlepos = titlepos + 1
    Select Case titlepos
      Case 1
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':2565927, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':2565927, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 0, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 2
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':5066061, 'size': 0.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 0.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':5066061, 'size': 0.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 0.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 3
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':7960953, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':7960953, 'size': 0.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 0.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 4
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':9671571, 'size': 1.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 1.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':9671571, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 1.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 5
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':11842740, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':11842740, 'size': 1.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 1.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 6
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':13224393, 'size': 3, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 3, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':13224393, 'size': 2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 7
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':14671839, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':14671839, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 2.4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 8
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':15790320, 'size': 4.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 4.2, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':15790320, 'size': 2.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 2.8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 9
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':16316664, 'size': 4.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 4.8, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':16316664, 'size': 3.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 3.2, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 10
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':16777215, 'size': 5.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 5.4, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':16777215, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 3.6, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 11
        PuPlayer.LabelSet pDMD,"title",title,1,"{'mt':2,'color':16777215, 'size': 12, 'xpos': 50, 'xalign': 1, 'ypos': 30, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg",title,1,"{'mt':2,'color':0, 'size': 12, 'xpos': 50, 'xalign': 1, 'ypos': 30, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2",subtitle,1,"{'mt':2,'color':16777215, 'size': 8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2",subtitle,1,"{'mt':2,'color':0, 'size': 8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      Case 150
        PuPlayer.LabelSet pDMD,"title","",1,"{'mt':2,'color':16777215, 'size': 12, 'xpos': 50, 'xalign': 1, 'ypos': 30, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg","",1,"{'mt':2,'color':0, 'size': 12, 'xpos': 50, 'xalign': 1, 'ypos': 30, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"title2","",1,"{'mt':2,'color':16777215, 'size': 8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        PuPlayer.LabelSet pDMD,"titlebg2","",1,"{'mt':2,'color':0, 'size': 8, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
        titlepos = 0
        titletimer.enabled = 0
    End Select
  End Sub


  Sub pNote(msgText,msg2text)
    title = msgText
    subtitle = msg2text
    If titlepos = 0 Then
      titletimer.enabled = 1
    Else
      titlepos = 0
      titletimer.enabled = 1
      PuPlayer.LabelSet pDMD,"title","",1,"{'mt':2,'color':16777215, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 30, 'yalign': 0}"
      PuPlayer.LabelSet pDMD,"titlebg","",1,"{'mt':2,'color':0, 'size': 6, 'xpos': 50, 'xalign': 1, 'ypos': 30, 'yalign': 0}"
      PuPlayer.LabelSet pDMD,"title2","",1,"{'mt':2,'color':16777215, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
      PuPlayer.LabelSet pDMD,"titlebg2","",1,"{'mt':2,'color':0, 'size': 4, 'xpos': 50, 'xalign': 1, 'ypos': 45, 'yalign': 0}"
    End If
  End Sub

Sub titletimerpop_Timer()

End Sub


Sub pupDMDUpdate_Timer()

End Sub

Sub DungeonBonusTimer_Timer()
'Debug "In DBT "
  DungeonCountDown = DungeonCountDown - 1

  if ActiveMode Mod 2 = 0 And Mode(CurrentPlayer,ActiveMode) = 2 Then ' In a Dungeon Mode
    PuPlayer.LabelSet pBackglass,"DungeonTimerMessage1", DungeonTimerMessage1 ,1,"{'mt':2,'color':33023, 'size': 8, 'xpos': 50.0, 'xalign': 1, 'ypos': 15.2, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"DungeonTimerMessage2", DungeonTimerMessage2 ,1,"{'mt':2,'color':33023, 'size': 8, 'xpos': 50.0, 'xalign': 1, 'ypos': 25.2, 'yalign': 0 }"
    PuPlayer.LabelSet pBackglass,"DungeonTimerOn", "" & DungeonCountDown,1,""
  End If

End Sub


Sub DungeonBonusTimerExpired_Timer()
  DungeonBonusTimer.Enabled = 0
  DungeonBonusTimerExpired.Enabled = 0
  DungeonBonus = 0
  PuPHideBattle "Dungeon Bonus Timer Expired"
  ClearDungeonPup
End Sub

Sub ClearDungeonPup
  PuPlayer.LabelSet pBackglass,"DungeonTimerMessage1", "" ,0,"" ' Erase Messages
  PuPlayer.LabelSet pBackglass,"DungeonTimerMessage3", "" ,0,"" ' Erase Messages
  PuPlayer.LabelSet pBackglass,"DungeonTimerOn", "" ,0,"" ' Erase Messages
End Sub

Sub ClearDungeonPup2
  PuPlayer.LabelSet pBackglass,"DungeonTimerMessage2", "" ,0,"" ' Erase Messages
End Sub

Sub DisplayGuide2
  PuPlayer.LabelSet pBackglass,"DungeonTimerMessage2", DungeonTimerMessage2 ,1,""
End Sub

Sub DisplayFinalScore
  Debug "In Display Final Score"
  HideContinueMessage
  if DMDType = 2 Then
    PuPlayer.LabelSet pDMD,"FinalScoreDMD",FormatNumber(Score(CurrentPlayer),0),1,""
  Else
    PuPlayer.LabelSet pBackglass,"FinalScore",FormatNumber(Score(CurrentPlayer),0),1,""
  End If
End Sub

Sub HideFinalScore
  if DMDType = 2 Then
    PuPlayer.LabelSet pDMD,"FinalScoreDMD","",0,""   ' Hide final score from last game
  Else
    PuPlayer.LabelSet pBackglass,"FinalScore","",0,""   ' Hide final score from last game
  End If
End Sub

Sub DisplayFinalScoreDMD
  Debug "In Display Final ScoreDMD"
  HideContinueMessage
  if DMDType = 2 Then
    PuPlayer.LabelSet pDMD,"FinalScoreDMD",FormatNumber(Score(CurrentPlayer),0),1,""
  Else
    PuPlayer.LabelSet pBackglass,"FinalScore",FormatNumber(Score(CurrentPlayer),0),1,""
  End If
End Sub

Sub HideFinalScoreDMD
  if DMDType = 2 Then
    PuPlayer.LabelSet pDMD,"FinalScoreDMD","",0,""   ' Hide final score from last game
  Else
    PuPlayer.LabelSet pBackglass,"FinalScore","",0,""   ' Hide final score from last game
  End If
End Sub

Sub DisplayContinueMessage2
  Dim Message
  Message = "Claim Reward:" & GoldSack(CurrentPlayer) & " <LF> or Continue <RF>"
  HideFinalScore
  PuPlayer.LabelSet pBackglass,"ContinueMessage", Message ,1,""
End Sub

Sub DisplayContinueMessage
  Debug2 " In DCM:" &GoldSack(CurrentPlayer)
  eobhide "DisplayContinueMessage"
  Select Case GoldSack(CurrentPlayer)
    Case 1:
      Debug "DCM 1"
      GeneralPuPQueue.Add "Pup771","PuPEvent 771",88,0,0,0,0,True
      Triggerscript 500, "DisplayFinalScore"
    Case 2:
      Debug "DCM 2"
      GeneralPuPQueue.Add "Pup772","PuPEvent 772",88,0,0,0,0,True
      Triggerscript 500, "DisplayFinalScore"
    Case 3:
      Debug "DCM 3"
      GeneralPuPQueue.Add "Pup773","PuPEvent 773",88,0,0,0,0,True
      Triggerscript 500, "DisplayFinalScore"
    Case 4:
      Debug "DCM 4"
      GeneralPuPQueue.Add "Pup774","PuPEvent 774",88,0,0,0,0,True
      Triggerscript 500, "DisplayFinalScore"
    Case else:
      'bContinueGame = True     ' removed rc3
      CheckHighscore
      Debug "DCM WTF"
  End Select
End Sub

Sub DisplayGameContinueMessage
  Dim Message
  HideFinalScore
  Message = "Continuing the Game"
  PuPlayer.LabelSet pBackglass,"ContinueMessage", Message ,1,""
End Sub

Sub HideContinueMessage
  PuPlayer.LabelSet pBackglass,"ContinueMessage","",0,""   ' Hide continue message
End Sub

Sub DisplayStartGameMessage
  Dim Message
  HideFinalScore
' pMsg2Lines "","Start a New Game",999,255,1
  Message = "Start New Game"
  PuPlayer.LabelSet pBackglass,"ContinueMessage", Message ,1,""
End Sub




'*****************************************************************************************************************************************
'  ERROR LOGS by baldgeek
'*****************************************************************************************************************************************

' Log File Usage:
'   WriteToLog "Label 1", "Message 1 "
'   WriteToLog "Label 2", "Message 2 "


Class DebugLogFile

    Private Filename
    Private TxtFileStream

    Private Function LZ(ByVal Number, ByVal Places)
        Dim Zeros
        Zeros = String(CInt(Places), "0")
        LZ = Right(Zeros & CStr(Number), Places)
    End Function

    Private Function GetTimeStamp
        Dim CurrTime, Elapsed, MilliSecs
        CurrTime = Now()
        Elapsed = Timer()
        MilliSecs = Int((Elapsed - Int(Elapsed)) * 1000)
        GetTimeStamp = _
            LZ(Year(CurrTime),   4) & "-" _
            & LZ(Month(CurrTime),  2) & "-" _
            & LZ(Day(CurrTime),    2) & " " _
            & LZ(Hour(CurrTime),   2) & ":" _
            & LZ(Minute(CurrTime), 2) & ":" _
            & LZ(Second(CurrTime), 2) & ":" _
            & LZ(MilliSecs, 4)
    End Function

' *** Debug.Print the time with milliseconds, and a message of your choice
    Public Sub WriteToLog(label, message, code)
        Dim FormattedMsg, Timestamp
    Filename = cGameName + "_debug_log.txt"

        Set TxtFileStream = CreateObject("Scripting.FileSystemObject").OpenTextFile(Filename, code, True)
        Timestamp  = GetTimeStamp
        FormattedMsg = GetTimeStamp + " : " + label + " : " + message
        TxtFileStream.WriteLine FormattedMsg
        TxtFileStream.Close
    'debug3 label & " : " & message
  End Sub

End Class

Sub WriteToLog(label, message)
  if KeepLogs Then
    Dim LogFileObj
    Set LogFileObj = New DebugLogFile
    LogFileObj.WriteToLog label, message, 8
  end if
End Sub

Sub NewLog()
  if KeepLogs Then
    Dim LogFileObj
    Set LogFileObj = New DebugLogFile
    LogFileObj.WriteToLog "NEW LOG", " ", 2
  end if
End Sub


Sub CleanUpTimer_Timer()
  ' Timer used to cleanup messages from screen
  HideItemMessages
End Sub

Sub TorchLevelTimer_Timer()
  if TorchesEnabled then
    CheckTorches
  End If
End Sub


'*********** Glowball Section *****************************************************************************
Dim GlowBall, CustomBulbIntensity(10)
Dim  GBred(10)
Dim GBgreen(10)
Dim GBblue(10)
Dim CustomBallImage(10), CustomBallLogoMode(10), CustomBallDecal(10), CustomBallGlow(10)


' default Ball
CustomBallGlow(0) =     True
CustomBallImage(0) =    "ball"
CustomBallLogoMode(0) =   True  ' silver glow
CustomBallDecal(0) =    ""
CustomBulbIntensity(0) =  0.01
GBred(0) = 192 : GBgreen(0) = 255 : GBblue(0) = 192

' Purple GlowBall
CustomBallGlow(1) =     True
CustomBallImage(1) =    "glowball purple"
CustomBallLogoMode(1) =   True
CustomBallDecal(1) =    ""
CustomBulbIntensity(1) =  0
'GBred(1) = 255 : GBgreen(1)  = 0 : GBblue(1) = 255
GBred(1) = 128 : GBgreen(1) = 0 : GBblue(1) = 128


' green GlowBall
CustomBallGlow(2) =     True
CustomBallImage(6) =    "glowball green"
CustomBallLogoMode(6) =   True
CustomBallDecal(6) =    ""
CustomBulbIntensity(6) =  0
GBred(2) = 100 : GBgreen(2) = 255 : GBblue(2) = 100

' blue GlowBall
CustomBallGlow(3) =     True
CustomBallImage(3) =    "glowball blue"
CustomBallLogoMode(3) =   True
CustomBallDecal(3) =    ""
CustomBulbIntensity(3) =  0
GBred(3) = 50 : GBgreen(3)  = 50 : GBblue(3) = 255


' Orange GlowBall
CustomBallGlow(4) =     False
CustomBallImage(4) =    "ball"
CustomBallLogoMode(4) =   False  ' silver no glow
CustomBallDecal(4) =    ""
CustomBulbIntensity(4) =  0
GBred(4) = 192 : GBgreen(4) = 255 : GBblue(4) = 192


' red GlowBall
CustomBallGlow(5) =     True
CustomBallImage(5) =    "glowball red"
CustomBallLogoMode(5) =   True
CustomBallDecal(5) =    ""
CustomBulbIntensity(5) =  0
GBred(5) = 255 : GBgreen(5) = 99 : GBblue(5) = 71

' white GlowBall
CustomBallGlow(6) =     True
CustomBallImage(6) =    "glowball flame"
CustomBallLogoMode(6) =   True
CustomBallDecal(6) =    ""
CustomBulbIntensity(6) =  0
GBred(6) = 255 : GBgreen(6) = 165 : GBblue(6) = 000

' yellow GlowBall
CustomBallGlow(7) =     True
CustomBallImage(7) =    "glowball yellow"
CustomBallLogoMode(7) =   True
CustomBallDecal(7) =    ""
CustomBulbIntensity(7) =  0
GBred(7) = 255 : GBgreen(7) = 255 : GBblue(7) = 000

' gold GlowBall
CustomBallGlow(8) =     True
CustomBallImage(8) =    "glowball gold"
CustomBallLogoMode(8) =   True
CustomBallDecal(8) =    ""
CustomBulbIntensity(8) =  0
GBred(8) = 255 : GBgreen(8) = 215 : GBblue(8) = 000

' pink GlowBall
CustomBallGlow(9) =     True
CustomBallImage(9) =    "glowball pink"
CustomBallLogoMode(9) =   True
CustomBallDecal(9) =    ""
CustomBulbIntensity(9) =  0
GBred(9) = 255 : GBgreen(9) = 192 : GBblue(9) = 203



' *** prepare the variable with references to three lights for glow ball ***
Dim Glowing(10)
Set Glowing(0) = Glowball1 : Set Glowing(1) = Glowball2 : Set Glowing(2) = Glowball3 : Set Glowing(3) = Glowball4: Set Glowing(4) = Glowball5: Set Glowing(5) = Glowball6


'*** change ball appearance ***

Sub ChangeBall(ballnr)
  Dim BOT, ii, col

  table1.BallDecalMode = CustomBallLogoMode(ballnr)
  table1.BallFrontDecal = CustomBallDecal(ballnr)
  table1.DefaultBulbIntensityScale = CustomBulbIntensity(ballnr)
  table1.BallImage = CustomBallImage(ballnr)
  GlowBall = CustomBallGlow(ballnr)
  For ii = 0 to 5
    col = RGB(GBred(ballnr), GBgreen(ballnr), GBblue(ballnr))
    Glowing(ii).color = col : Glowing(ii).colorfull = col
  Next
  BOT = getballs
  if Ubound(BOT) < 1 Then exit Sub
  For b = 1 to Ubound(BOT)
    BOT(b).image = CustomBallImage(ballnr)
  Next
End Sub

' *** Ball Shadow code / Glow Ball code / Primitive Flipper Update ***

Dim BallShadowArray
BallShadowArray = Array (BallShadow1, BallShadow2, BallShadow3,BallShadow4,BallShadow5)
Const anglecompensate = 15

Sub GraphicsTimer_Timer()
  Dim BOT, b, avg
    BOT = GetBalls
  if UBound(BOT) > 1 Then
    avg = Glowintensity/Ubound(BOT) * 1.5
  ' debug "AVG:" &avg
    if avg > 10 Then avg = 10
    if avg < 5 Then avg = 5
  Else
    avg = GlowIntensity
  End If


  ' switch off glowlight for removed Balls
  IF GlowBall Then
    For b = UBound(BOT) + 1 to 4
      If GlowBall and Glowing(b).state = 1 Then Glowing(b).state = 0 End If
    Next
  End If


    For b = 0 to UBound(BOT)
    If GlowBall and b < 6 and b > 0 Then  ' change from 5 to 6 in v1.2n
      If Glowing(b).state = 0 Then Glowing(b).state = 1 end if
      Glowing(b).BulbHaloHeight = BOT(b).z + 25
      Glowing(b).x = BOT(b).x : Glowing(b).y = BOT(b).y + anglecompensate
      Glowing(b).falloff=GlowAura 'GlowBlob Auroa radius
      Glowing(b).intensity=avg 'Glowblob intensity
    End If
  Next
End Sub

Sub Glowball_Init
  ChangeBall(ChooseBall)
  If GlowBall Then GraphicsTimer.enabled = True End If
End Sub

Dim FlickerOn : FlickerOn = False
Dim Flickershort : Flickershort = 0
Dim flickervalue : flickervalue = 30
Dim flickerblinks : flickerblinks = 5
FlickerTimer.interval = 16

Sub FlickerTimer_timer
'if EnableFlicker = False Then Exit Sub
    Dim bulb

    flickervalue = flickervalue - 2
    If flickervalue < 1 Then
        if flickershort Then
            flickervalue = 18 : flickershort = int(Rnd(1)*2)
        Else
            flickervalue = 25 + Int(Rnd(1)*200) : flickershort = int(Rnd(1)*2)
        End If
    End If

    If FlickerOn and flickervalue < 15 Then
        If flickervalue < 10 and flickershort Then flickervalue = 0

        For each bulb in aGiLights
            bulb.intensity = 15 - flickervalue
        Next

    End If
End Sub



'=============================================================================================
Function rndUnique(min,max,outCount)
'Debug "********************************"
    Redim out(outCount) ' How many random unique values out
    dim index: index=0

    ' pre init out array to invalid values
        Dim iInit: iInit = 0
    for iInit = 0 to  UBound(out)
        out(iInit) = max+1
    Next

    'Randomize -- 'is this redundant
    Dim iNum
    Dim dupIndex
    Dim dupDetected: dupDetected = 0

    Do While 1
        iNum =  Int((max-min+1)*Rnd+min)
        For dupIndex = 0 to index
            If out(dupIndex) = iNum  Then
                dupDetected = 1
                Exit for
            End If
        Next
        If dupDetected = 1 Then
            dupDetected = 0 ' rerun loop
        ElseIf index = UBound(out) then
            Exit Do
        Else
            out(index) = iNum
            index = index + 1

      'Debug "Index: " &iNum
        End If
    loop

rndUnique = out ' return values

'Debug "********************************"
End Function

' example call
'Dim out
'out = rndUnique(0,9,4)
'======================================================
Function ForceSelection (arrayIn)

Debug3 "In Force Selection"
  if arrayIn(currentplayer,0) = 1 Then
    ForceSelection = 0
  Elseif arrayIn(currentplayer,1) = 1 Then
    ForceSelection = 1
  Elseif arrayIn(currentplayer,2) = 1 Then
    ForceSelection = 2
  Elseif arrayIn(currentplayer,3) = 1 Then
    ForceSelection = 3
  Elseif arrayIn(currentplayer,4) = 1 Then
    ForceSelection = 4
  Elseif arrayIn(currentplayer,5) = 1 Then
    ForceSelection = 5
  Elseif arrayIn(currentplayer,6) = 1 Then
    ForceSelection = 6
  Elseif arrayIn(currentplayer,7) = 1 Then
    ForceSelection = 7
  End If

End function
'======================================================
Function rndArrayCol(arrayIn, row)
    ' send in a 2d array (arrayIn), select a row (row) and it will return a random col for a column that has a value greater then "zero"
    Dim maxCol: maxCol = UBound(arrayIn, 2) ' get the max number of cols in array
    Randomize
    Dim col

' check if the array row as all columns with zero values
Dim i,m
m = 0
Dim maxPasses: MaxPasses = 20
dim allZeros: allZeros = True
for i=0 to maxCol
    if arrayIn(row,i) > 0 Then
        allZeros = False
    End If
Next

If allZeros then ' this array is set to all zeros.  return -1
    rndArrayCol = -1
    Exit Function
End If


Do While m < MaxPasses
    col =  Int(maxCol*Rnd)
    debug3 "Pass Number: " &m
    debug3 "RandomArray - Col: " &col &"-" &arrayIn(row,col)
    If arrayIn(row,col) > 0 Then
      debug3 "Leaving with: "&col
      debug3 "================================="
      Exit do
    End If
  m = m + 1
Loop

if m = MaxPasses Then
  ' force selection via brute force
  rndArrayCol = ForceSelection(arrayIn)
  Debug3 "Force Response: " &rndArrayCol
  debug3 "---------------------------------"
Else
  rndArrayCol = col ' return value from while loop
End If


End Function


' example call
'Dim out(10,5)

'out(0,4) = 1 ' test
'out(0,2) = 1 ' test
'Dim col: col = rndArrayCol(out,0)
'msgbox col
'======================================================
Function rndZeroArrayCol(arrayIn, row)
    ' send in a 2d array (arrayIn), select a row (row) and it will return a random col for a column that has a value equal to "zero"
    Dim maxCol: maxCol = UBound(arrayIn, 2) ' get the max number of cols in array
    Randomize
    Dim col

' check if the array row as all columns with zero values
Dim i
dim allOnes: allOnes = True
for i=0 to maxCol
    if arrayIn(row,i) = 0 Then
        allOnes = False
    End If
Next

If allOnes then ' this array is set to all ones.  return -1
    rndZeroArrayCol = -1
    Exit Function
End If


Do While 1
    col =  Int(maxCol*Rnd)
    If arrayIn(row,col) = 0 Then
        Exit Do
    End If
Loop

rndZeroArrayCol = col ' return values
End Function
'======================================================
Function rndArrayCol1d(arrayIn)
    ' send in a 1d array (arrayIn) will return a random col for a column that has a value greater then "zero"
    Dim maxCol: maxCol = UBound(arrayIn) ' get the max number of cols in array
    Randomize
    Dim col

' check if the array row as all columns with zero values
Dim i
dim allZeros: allZeros = True
for i=0 to maxCol
    if arrayIn(i) <> 0 Then
        allZeros = False
    End If
Next

If allZeros then ' this array is set to all zeros.  return -1
    rndArrayCol1d = -1
    Exit Function
End If


Do While 1
    col =  Int(maxCol*Rnd)
    If arrayIn(col) > 0 Then
        Exit Do
    End If
Loop

rndArrayCol1d = col ' return values
End Function

'======================================================
Function rndMonster(arrayIn, row)
    ' send in a 2d array (arrayIn), select a row (row) and it will return a random col for a column that is either 0 or 1
    Dim maxCol: maxCol = 4 ' get the max number of cols in array
    Randomize
    Dim col

' check if the array row as all columns with zero values
Dim i
dim allTwos: allTwos = True
for i= 0 to maxcol
    if arrayIn(row,i) <> 2 Then
        allTwos = False
    End If
Next

If allTwos then ' this array is set to all Twos.  return -1
    rndMonster = -1
    Exit Function
End If


Do While 1
    col =  Int(maxcol*Rnd)
    If arrayIn(row,col) <> 2 Then
        Exit Do
    End If
Loop

rndMonster = col ' return values
End Function
'------------------------------------------------------------------------
Function rndNumNot(min, max, notNum)
    Randomize
    Dim iNum

Do While 1
    iNum = Int((max-min+1)*Rnd+min)
    If iNum <> notNum Then
        Exit Do
    End If
loop

rndNumNot = iNum ' return values
End Function

' example call
'dim rndNum
'rndNum = rndNumNot(1, 3, 2)
'msgbox rndNum
'==============================================
Function rndZeroArrayCol1d(arrayIn)
    ' send in a 1d array (arrayIn) will return a random col for a column that has a value equal to "zero"
    Dim maxCol: maxCol = UBound(arrayIn) ' get the max number of cols in array
    Randomize
    Dim col

' check if the array row as all columns with zero values
Dim i
dim allOnes: allOnes = True
for i=0 to maxCol
    if arrayIn(i) = 0 Then
        allOnes = False
    End If
Next

If allOnes then ' this array is set to all ones.  return -1
    rndZeroArrayCol1d = -1
    Exit Function
End If


Do While 1
    col =  Int(maxCol*Rnd)
    If arrayIn(col) = 0 Then
        Exit Do
    End If
Loop

rndZeroArrayCol1d = col ' return values
End Function
'======================================================
Function rndItem(arrayIn, row)
    ' send in a 2d array (arrayIn), select a row (row) and it will return a random col for a column that has a value equal to "zero"
    Dim maxCol: maxCol = 5 ' get the max number of cols in array
    Randomize
    Dim col

' check if the array row as all columns with zero values
Dim i
dim allOnes: allOnes = True
for i=0 to maxCol
    if arrayIn(row,i) = 0 Then
        allOnes = False
    End If
Next

If allOnes then ' this array is set to all ones.  return -1
    rndItem = -1
    Exit Function
End If


Do While 1
    col =  Int(maxCol*Rnd)
    If arrayIn(row,col) = 0 Then
        Exit Do
    End If
Loop

rndItem = col ' return values
End Function
'======================================================
Function rndArrayCol3d(arrayIn)
    ' send in a 1d array (arrayIn) will return a random col for a column that has a value greater then "zero"
    Dim maxCol: maxCol = 3 ' get the max number of cols in array
    Randomize
    Dim col

' check if the array row as all columns with zero values
Dim i
dim allZeros: allZeros = True
for i=0 to maxCol
    if arrayIn(i,0,1) <> 0 Then
        allZeros = False
    End If
Next

If allZeros then ' this array is set to all zeros.  return -1
    rndArrayCol3d = -1
    Exit Function
End If


Do While 1
    col =  Int(maxCol*Rnd)
    If arrayIn(col,0,1) > 0 Then
        Exit Do
    End If
Loop

rndArrayCol3d = col ' return values
End Function

'======================================================
sub setMonsterLightColorGreen
  setlightcolor li024, green,1
  setlightcolor li025, green,1
  setlightcolor li006, green,1
  setlightcolor li008, green,1
end sub

sub setMonsterLightColorWhite
  setlightcolor li024, white,0
  setlightcolor li025, white,0
  setlightcolor li006, white,0
  setlightcolor li008, white,0
end sub

sub setUPFLightColorGreen
'Debug "SetUPF GREEN"
p61.material = "InsertGreenOnTri":Target006.image = "HitTargetGreen"
p62.material = "InsertGreenOnTri":Target007.image = "HitTargetGreen"
p63.material = "InsertGreenOnTri":Target008.image = "HitTargetGreen"
p64.material = "InsertGreenOnTri":Target009.image = "HitTargetGreen"
li061.state = 1
li062.state = 1
li063.state = 1
li064.state = 1

End sub

sub setUPFLightColorWhite
'Debug "SetUPF WHITE"
p61.material = "InsertWhiteOffTri":Target006.image = "HitTarget"
p62.material = "InsertWhiteOffTri":Target007.image = "HitTarget"
p63.material = "InsertWhiteOffTri":Target008.image = "HitTarget"
p64.material = "InsertWhiteOffTri":Target009.image = "HitTarget"
  li061.state = 0
  li062.state = 0
  li063.state = 0
  li064.state = 0
End sub

'' NOTES
'BallsOnMagnet = Ubound(mLeft.Balls)
Dim BallsOnMagnet
Dim bMagnetCaptured
Sub MagnetCheckTimer_Timer()
    Dim tmpBOT
    tmpBOT = GetBalls
    if Ubound(tmpBOT) + ballsinhole > 1 Then
      if bMagnetCaptured Then ReleaseMagnetBalls
      DisableMagnet
      Exit Sub
    End If


    BallsOnMagnet = Ubound(mMagnet.Balls) + 1
    'Debug "BOM: " & BallsOnMagnet
    if BallsOnMagnet > 0 And RFlipperUsed = 0 Then
      Debug " BALL LOCKED ON MAGNET"
      bMagnetCaptured = True
      MagnetLockedMessage
      li0130.state = 1
    Else
      pDMDHideAnimate "MagnetLocked"
    End If
End Sub

Sub AutoFlipTimer_Timer()
  if AF = 1 And BallsOnPlayfield > 1 And bBallInPlungerLane = False Then
    Debug "###########  Changing to AF = 0"
    AF = 0
  Elseif BallsOnPlayfield = 2 And bBallInPlungerLane = True And AF = 0 Then
    Debug "###########  Changing to AF = 1, Hwyman exception"
    AF = 1
  Elseif AF = 0 And BallsOnPlayfield < 2 Then
    Debug "###########  Changing to AF = 1"
    AF = 1
  End If
End Sub



Sub Target006_Hit()

      If Tilted Then Exit Sub
    PlaySoundAtBall SoundFXDOF("fx_Target", 133, DOFPulse, DOFTargets)

  Debug "UPF1 Target hit"
  UPFHitCount(CurrentPlayer) = UPFHitCount(CurrentPlayer) + 1

    Addscore 5000

  if Missions(CurrentPlayer,3) = 2 Then
    if TorchTargets(0) < 2 Then
      TorchTargets(0) = TorchTargets(0) + 1
      UPFHitCount(CurrentPlayer) = 0
      DungeonProgress
    End If
  End If

  'if TorchTargets(0) > 1 Then p61.material = "InsertWhiteOnTri": Li061.state = 1:Target006.image = "HitTargetWhite"

  if Mode(CurrentPlayer,8) = 1 Then
    if WarrensTargets(0) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      WarrensTargets(0) = WarrensTargets(0) + 1
      Debug "WT0 :" &WarrensTargets(0)

      if  WarrensTargets(0) = 2 Then
        Debug "MonsterHits: 1"
        'DisplayDungeonProgress
        setlightcolor li024 , white, 0
        p61.material = "InsertWhiteOffTri": Li061.state = 0:Target006.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(0,0,1) = 2
        Monsters(CurrentPlayer,0) = 2
        triggerscript 3100, "KillPuPMonster ""0"" "
        CheckWarrensWin
        HoundCriticalCheck
      Elseif WarrensTargets(0) = 1 Then
        Debug "MonsterHits: 2"
        'DisplayDungeonProgress
        setlightcolor li024 , red, 1
        p61.material = "InsertRedOnTri": Li061.state = 1:Target006.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,0) = 1
      End If
      'DungeonProgress
    End If
  End If

  if Mode(CurrentPlayer,11) = 1 Then
    if DrownedTargets(0) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      DrownedTargets(0) = DrownedTargets(0) + 1

      if  DrownedTargets(0) = 2 Then
        Debug "MonsterHits: 1"
        'DisplayDungeonProgress
        setlightcolor li024 , white, 0
        p61.material = "InsertWhiteOffTri": Li061.state = 0:Target006.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(0,0,1) = 2
        Monsters(CurrentPlayer,0) = 2
        'triggerscript 3100, "KillPuPMonster ""0"" "
        CheckDrownedWin
        HoundCriticalCheck
      Elseif DrownedTargets(0) = 1 Then
        Debug "MonsterHits: 2"
        'DisplayDungeonProgress
        setlightcolor li024 , red, 1
        p61.material = "InsertRedOnTri": Li061.state = 1:Target006.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(0,0,1) = 1
        Monsters(CurrentPlayer,0) = 1
      End If
    End If
  End If


  Select Case ActiveMode
    Case 2,12,14:
      Debug "**************** UPF1 HIT"
        li061.state = 2
        GeneralPupQueue.Add "light61-0","li061.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) < 5 Then
        DungeonProgress
        li061.state = 2
        GeneralPupQueue.Add "light61-0","li061.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 4:
      if UPFHitCount(CurrentPlayer) < 9 Then
        DungeonProgress
        li061.state = 2
        GeneralPupQueue.Add "light61-0","li061.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 6:
        DisableUPF
    Case 10:
      if UPFHitCount(CurrentPlayer) > 2 Then DisableUPF
    Case 13:
      if UPFHitCount(CurrentPlayer) < 9Then
        DungeonProgress
        li061.state = 2
        GeneralPupQueue.Add "light61-0","li061.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 8:
      'if WarrensTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case 11:
      'if DrownedTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case Else
      li061.state = 2
      GeneralPupQueue.Add "light61-0","li061.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) > 4 Then DisableUPF
  End Select

    LastSwitchHit = "upf1"
End Sub

Sub Target007_Hit()

    If Tilted Then Exit Sub
    PlaySoundAtBall SoundFXDOF("fx_Target", 134, DOFPulse, DOFTargets)


  Debug "UPF2 Target hit"
  UPFHitCount(CurrentPlayer) = UPFHitCount(CurrentPlayer) + 1

    Addscore 5000

  if Missions(CurrentPlayer,3) = 2 Then
    if TorchTargets(1) < 2 Then
      TorchTargets(1) = TorchTargets(1) + 1
      UPFHitCount(CurrentPlayer) = 0
      DungeonProgress
    End If
  End If

  'if TorchTargets(1) > 1 Then p62.material = "InsertWhiteOnTri": Li062.state = 1:Target007.image = "HitTargetWhite"

  if Mode(CurrentPlayer,8) = 1 Then
    if WarrensTargets(1) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      WarrensTargets(1) = WarrensTargets(1) + 1
      Debug "WT1 :" &WarrensTargets(1)
      'DungeonProgress

      if WarrensTargets(1) =2 Then
        Debug "MonsterHits: 3"
        'DisplayDungeonProgress
        setlightcolor li025 , white, 0
        p62.material = "InsertWhiteOffTri": Li062.state = 0:Target007.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(1,0,1) = 2
        Monsters(CurrentPlayer,1) = 2
        triggerscript 3100, "KillPuPMonster ""1"" "
        CheckWarrensWin
        HoundCriticalCheck
      Elseif WarrensTargets(1) =1 Then
        Debug "MonsterHits: 4"
        'DisplayDungeonProgress
        setlightcolor li025 , red, 1
        p62.material = "InsertRedOnTri": Li062.state = 1:Target007.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(1,0,1) = 1
        Monsters(CurrentPlayer,1) = 1
      End If
    End If
  End If

  if Mode(CurrentPlayer,11) = 1 Then
    if DrownedTargets(1) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      DrownedTargets(1) = DrownedTargets(1) + 1

      if DrownedTargets(1) =2 Then
        Debug "MonsterHits: 3"
        'DisplayDungeonProgress
        setlightcolor li025 , white, 0
        p62.material = "InsertWhiteOffTri": Li062.state = 0:Target007.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(1,0,1) = 2
        Monsters(CurrentPlayer,1) = 2
        'triggerscript 3100, "KillPuPMonster ""1"" "
        CheckDrownedWin
        HoundCriticalCheck
      Elseif DrownedTargets(1) =1 Then
        Debug "MonsterHits: 4"
        'DisplayDungeonProgress
        setlightcolor li025 , red, 1
        p62.material = "InsertRedOnTri": Li062.state = 1:Target007.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(1,0,1) = 1
        Monsters(CurrentPlayer,1) = 1
      End If
    End If
  End If

  GetAM
  Select Case ActiveMode
    Case 2,12,14:
      Debug "**************** UPF2 HIT"
        li062.state = 2
        GeneralPupQueue.Add "light62-0","li062.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) < 5 Then
        DungeonProgress
        li062.state = 2
        GeneralPupQueue.Add "light62-0","li062.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 4:
      if UPFHitCount(CurrentPlayer) < 9 Then
        DungeonProgress
        li062.state = 2
        GeneralPupQueue.Add "light62-0","li062.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 6:
        DisableUPF
    Case 10:
      if UPFHitCount(CurrentPlayer) > 2 Then DisableUPF
    Case 13:
      if UPFHitCount(CurrentPlayer) < 9Then
        DungeonProgress
        li062.state = 2
        GeneralPupQueue.Add "light62-0","li062.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 8:
      'if WarrensTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case 11:
      'if DrownedTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case Else
      li062.state = 2
      GeneralPupQueue.Add "light62-0","li062.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) > 4 Then DisableUPF
  End Select

    LastSwitchHit = "upf2"
End Sub

Sub Target008_Hit()
If Tilted Then Exit Sub
    PlaySoundAtBall SoundFXDOF("fx_Target", 135, DOFPulse, DOFTargets)
  Debug "UPF3 Target hit"
  UPFHitCount(CurrentPlayer) = UPFHitCount(CurrentPlayer) + 1
    Addscore 5000

  if Missions(CurrentPlayer,3) = 2 Then
    if TorchTargets(2) < 2 Then
      TorchTargets(2) = TorchTargets(2) + 1
      UPFHitCount(CurrentPlayer) = 0
      DungeonProgress
    End If
  End If

  'if TorchTargets(2) > 1 Then p63.material = "InsertWhiteOnTri": Li063.state = 1:Target008.image = "HitTargetWhite"

  if Mode(CurrentPlayer,8) = 1 Then
    if WarrensTargets(2) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      WarrensTargets(2) = WarrensTargets(2) + 1
      Debug "WT2 :" &WarrensTargets(2)
      'DungeonProgress

      if WarrensTargets(2) = 2 Then
        Debug "MonsterHits: 5"
        'DisplayDungeonProgress
        setlightcolor li008 , white, 0
        p63.material = "InsertWhiteOffTri": Li063.state = 0:Target008.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(2,0,1) = 2
        Monsters(CurrentPlayer,2) = 2
        triggerscript 3100, "KillPuPMonster ""2"" "
        CheckWarrensWin
        HoundCriticalCheck
      Elseif WarrensTargets(2) = 1 Then
        Debug "MonsterHits: 6"
        'DisplayDungeonProgress
        setlightcolor li008 , red, 1
        p63.material = "InsertRedOnTri": Li063.state = 1:Target008.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(2,0,1) = 1
        Monsters(CurrentPlayer,2) = 1
      End if

    End If
  End If

  if Mode(CurrentPlayer,11) = 1 Then
    if DrownedTargets(2) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      DrownedTargets(2) = DrownedTargets(2) + 1

      if DrownedTargets(2) = 2 Then
        Debug "MonsterHits: 5"
        'DisplayDungeonProgress
        setlightcolor li008 , white, 0
        p63.material = "InsertWhiteOffTri": Li063.state = 0:Target008.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(2,0,1) = 2
        Monsters(CurrentPlayer,2) = 2
        'triggerscript 3100, "KillPuPMonster ""2"" "
        CheckDrownedWin
        HoundCriticalCheck
      Elseif DrownedTargets(2) = 1 Then
        Debug "MonsterHits: 6"
        'DisplayDungeonProgress
        setlightcolor li008 , red, 1
        p63.material = "InsertRedOnTri": Li063.state = 1:Target008.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(2,0,1) = 1
        Monsters(CurrentPlayer,2) = 1
      End if
    End If
  End If

  GetAM
  Select Case ActiveMode
    Case 2,12,14:
      Debug "**************** UPF3 HIT"
        li063.state = 2
        GeneralPupQueue.Add "light63-0","li063.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) < 5 Then
        DungeonProgress
        li063.state = 2
        GeneralPupQueue.Add "light63-0","li063.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 4:
      if UPFHitCount(CurrentPlayer) < 9 Then
        DungeonProgress
        li063.state = 2
        GeneralPupQueue.Add "light63-0","li063.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 6:
        DisableUPF
    Case 10:
      if UPFHitCount(CurrentPlayer) > 2 Then DisableUPF
    Case 13:
      if UPFHitCount(CurrentPlayer) < 9Then
        DungeonProgress
        li063.state = 2
        GeneralPupQueue.Add "light63-0","li063.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 8:
      'if WarrensTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case 11:
      'if DrownedTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case Else
      li063.state = 2
      GeneralPupQueue.Add "light61-0","li063.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) > 4 Then DisableUPF
  End Select

    LastSwitchHit = "upf3"
End Sub

Sub Target009_Hit()
    If Tilted Then Exit Sub
    PlaySoundAtBall SoundFXDOF("fx_Target", 136, DOFPulse, DOFTargets)
  Debug "UPF4 Target hit"
  UPFHitCount(CurrentPlayer) = UPFHitCount(CurrentPlayer) + 1
    Addscore 5000

  if Missions(CurrentPlayer,3) = 2 Then
    if TorchTargets(3) < 2 Then
      TorchTargets(3) = TorchTargets(3) + 1
      UPFHitCount(CurrentPlayer) = 0
      DungeonProgress
    End If
  End If

  'if TorchTargets(3) > 1 Then p64.material = "InsertWhiteOnTri": Li064.state = 1:Target009.image = "HitTargetWhite"

  if Mode(CurrentPlayer,8) = 1 Then
    if WarrensTargets(3) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      WarrensTargets(3) = WarrensTargets(3) + 1
      Debug "WT3 :" &WarrensTargets(3)
      'DungeonProgress

      if WarrensTargets(3) = 2 Then
        Debug "MonsterHits: 7"
        'DisplayDungeonProgress
        setlightcolor li006 , white, 0
        p64.material = "InsertWhiteOffTri": Li064.state = 0:Target009.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(3,0,1) = 2
        Monsters(CurrentPlayer,3) = 2
        triggerscript 3100, "KillPuPMonster ""3"" "
        CheckWarrensWin
        HoundCriticalCheck
      Elseif WarrensTargets(3) = 1 Then
        Debug "MonsterHits: 8"
        'DisplayDungeonProgress
        setlightcolor li006 , red, 1
        p64.material = "InsertRedOnTri": Li064.state = 1:Target009.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(3,0,1) = 1
        Monsters(CurrentPlayer,3) = 1
      End If

    End If
  End If

  if Mode(CurrentPlayer,11) = 1 Then
    if DrownedTargets(3) < 2 Then
      RegionMonster(CurrentPlayer,Region) = RegionMonster(CurrentPlayer,Region) + 1
      DrownedTargets(3) = DrownedTargets(3) + 1

      if DrownedTargets(3) = 2 Then
        Debug "MonsterHits: 7"
        'DisplayDungeonProgress
        setlightcolor li006 , white, 0
        p64.material = "InsertWhiteOffTri": Li064.state = 0:Target009.image = "HitTarget"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        AudioQueue.Add "Pup296","PuPEvent 296",30,2500,0,0,AudioExpiry,False
        HeroTimerReset
        PlayerAttack
        GIF_MA(3,0,1) = 2
        Monsters(CurrentPlayer,3) = 2
        'triggerscript 3100, "KillPuPMonster ""3"" "
        CheckDrownedWin
        HoundCriticalCheck
      Elseif DrownedTargets(3) = 1 Then
        Debug "MonsterHits: 8"
        'DisplayDungeonProgress
        setlightcolor li006 , red, 1
        p64.material = "InsertRedOnTri": Li064.state = 1:Target009.image = "HitTargetRed"
        AudioQueue.Add "Pup295","PuPEvent 295",30,0,0,0,AudioExpiry,False
        HoundCriticalCheck
        GIF_MA(3,0,1) = 1
        Monsters(CurrentPlayer,3) = 1
      End If
    End If
  End If

  GetAM
  Select Case ActiveMode
    Case 2,12,14:
      Debug "**************** UPF4 HIT"
        li064.state = 2
        GeneralPupQueue.Add "light64-0","li064.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) < 5 Then
        DungeonProgress
        li064.state = 2
        GeneralPupQueue.Add "light64-0","li064.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 4:
      if UPFHitCount(CurrentPlayer) < 9 Then
        DungeonProgress
        li064.state = 2
        GeneralPupQueue.Add "light64-0","li064.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 6:
        DisableUPF
    Case 10:
      if UPFHitCount(CurrentPlayer) > 2 Then DisableUPF
    Case 13:
      if UPFHitCount(CurrentPlayer) < 9Then
        DungeonProgress
        li064.state = 2
        GeneralPupQueue.Add "light64-0","li064.state = 0",85,500,0,0,0,False
      Else
        DisableUPF
      End If
    Case 8:
      'if WarrensTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case 11:
      'if DrownedTargets(0) > 1 Then li061.State = 0:Target006.image = "HitTarget"
    Case Else
      li064.state = 2
      GeneralPupQueue.Add "light64-0","li064.state = 0",85,500,0,0,0,False
      if UPFHitCount(CurrentPlayer) > 4 Then DisableUPF
  End Select

    LastSwitchHit = "upf4"
End Sub

Sub LeftRampRopesOFF
'Components that make up the right ramp built with ropes and wooden posts
  Ramp007.visible = 0
  Ramp008.visible = 0
  Ramp011.visible = 0
  Ramp012.visible = 0
  Ramp065.visible = 0
  Ramp066.visible = 0
  Ramp067.visible = 0
  Ramp068.visible = 0
  Ramp339.visible = 0
  Ramp342.visible = 0

  Primitive100.visible = 0
  Primitive101.visible = 0
  Primitive103.visible = 0
  Primitive104.visible = 0
  Primitive105.visible = 0
  Primitive106.visible = 0
  Primitive107.visible = 0
  Primitive109.visible = 0
  Primitive110.visible = 0
  Primitive111.visible = 0
  Primitive112.visible = 0
  Primitive113.visible = 0
  Primitive114.visible = 0
  Primitive115.visible = 0
  Primitive116.visible = 0
  Primitive117.visible = 0
  Primitive118.visible = 0
  Primitive119.visible = 0
  Primitive120.visible = 0
  Primitive121.visible = 0


End Sub

Sub LeftRampRopesON
'Components that make up the right ramp built with ropes and wooden posts
  Ramp007.visible = 1
  Ramp008.visible = 1
  Ramp011.visible = 1
  Ramp012.visible = 1
  Ramp065.visible = 1
  Ramp066.visible = 1
  Ramp067.visible = 1
  Ramp068.visible = 1
  Ramp339.visible = 1
  Ramp342.visible = 1

  Primitive100.visible = 1
  Primitive101.visible = 1
  Primitive103.visible = 1
  Primitive104.visible = 1
  Primitive105.visible = 1
  Primitive106.visible = 1
  Primitive107.visible = 1
  Primitive109.visible = 1
  Primitive110.visible = 1
  Primitive111.visible = 1
  Primitive112.visible = 1
  Primitive113.visible = 1
  Primitive114.visible = 1
  Primitive115.visible = 1
  Primitive116.visible = 1
  Primitive117.visible = 1
  Primitive118.visible = 1
  Primitive119.visible = 1
  Primitive120.visible = 1
  Primitive121.visible = 1
End Sub

Sub UPFRampStoneOn
  Ramp375.Visible = 1
  Ramp341.Visible = 1
  UPFRampPosts.visible = 1
End Sub

Sub UPFRampStoneOff
  Ramp375.Visible = 0
  Ramp341.Visible = 0
  UPFRampPosts.visible = 0
End Sub

Sub RightRampRopesOFF
'Components that make up the left ramp built with ropes and wooden posts
  Ramp002.visible = 0
  Ramp013.visible = 0
  Ramp014.visible = 0
  Ramp015.visible = 0
  Ramp016.visible = 0
  Ramp021.visible = 0
  Ramp022.visible = 0
  Ramp023.visible = 0
  Ramp024.visible = 0
  Ramp076.visible = 0
  Ramp062.visible = 0
  Ramp063.visible = 0
  Ramp344.visible = 0
  Ramp618.visible = 0

  Primitive071.visible = 0
  Primitive073.visible = 0
  Primitive075.visible = 0
  Primitive080.visible = 0
  Primitive081.visible = 0
  Primitive082.visible = 0
  Primitive083.visible = 0
  Primitive084.visible = 0
  Primitive085.visible = 0
  Primitive086.visible = 0
  Primitive087.visible = 0
  Primitive088.visible = 0
  Primitive089.visible = 0
  Primitive090.visible = 0
  Primitive091.visible = 0
  Primitive092.visible = 0
  Primitive093.visible = 0
  Primitive094.visible = 0
  Primitive095.visible = 0
  Primitive096.visible = 0
  Primitive097.visible = 0
  Primitive098.visible = 0
  Primitive099.visible = 0
End Sub

Sub RightRampRopesON
'Components that make up the left ramp built with ropes and wooden posts
  Ramp002.visible = 1
  Ramp013.visible = 1
  Ramp014.visible = 1
  Ramp015.visible = 1
  Ramp016.visible = 1
  Ramp021.visible = 1
  Ramp022.visible = 1
  Ramp023.visible = 1
  Ramp024.visible = 1
  Ramp076.visible = 1
  Ramp062.visible = 1
  Ramp063.visible = 1
  Ramp344.visible = 1
  Ramp618.visible = 1

  Primitive071.visible = 1
  Primitive073.visible = 1
  Primitive075.visible = 1
  Primitive080.visible = 1
  Primitive081.visible = 1
  Primitive082.visible = 1
  Primitive083.visible = 1
  Primitive084.visible = 1
  Primitive085.visible = 1
  Primitive086.visible = 1
  Primitive087.visible = 1
  Primitive088.visible = 1
  Primitive089.visible = 1
  Primitive090.visible = 1
  Primitive091.visible = 1
  Primitive092.visible = 1
  Primitive093.visible = 1
  Primitive094.visible = 1
  Primitive095.visible = 1
  Primitive096.visible = 1
  Primitive097.visible = 1
  Primitive098.visible = 1
  Primitive099.visible = 1
End Sub

Sub newRightRampON
  RightRamp.visible = 1
  rramplight.state = 2
  rramplight2.state = 1
End Sub

Sub newRightRampOFF
  RightRamp.visible = 0
  rramplight.state = 0
  rramplight2.state = 0
End Sub

Sub newUPFRAmpOFF
  UPFRamp.Visible = 0
End Sub

Sub newUPFRampON
  UPFRamp.Visible = 1
End Sub

Sub newLeftRampON
  leftRamp.visible = 1
  lramplight.state = 2
  lramplight2.state = 1
End Sub

Sub newLeftRampOFF
  leftRamp.visible = 0
  lramplight.state = 0
  lramplight2.state = 0
End Sub


Sub dev_Timer()
  pUpdateDev
End Sub

Sub DisableUPF
  bKillUPF = True
  RightFlipper2.RotateToStart
  LeftFlipper2.RotateToStart
  Gi051.state = 0 ' turn off UPF GI lighting
  p61.material = "InsertWhiteOffTri": Li061.state = 0:Target006.image = "HitTarget"
  p62.material = "InsertWhiteOffTri": Li062.state = 0:Target007.image = "HitTarget"
  p63.material = "InsertWhiteOffTri": Li063.state = 0:Target008.image = "HitTarget"
  p64.material = "InsertWhiteOffTri": Li064.state = 0:Target009.image = "HitTarget"
End Sub

Sub ResetUPF
  bKillUPF = False
  UPFHitCount(CurrentPlayer) = 0
  p61.material = "InsertWhiteOffTri": Li061.state = 0:Target006.image = "HitTarget"
  p62.material = "InsertWhiteOffTri": Li062.state = 0:Target007.image = "HitTarget"
  p63.material = "InsertWhiteOffTri": Li063.state = 0:Target008.image = "HitTarget"
  p64.material = "InsertWhiteOffTri": Li064.state = 0:Target009.image = "HitTarget"
End Sub

Sub CheckDisableUPF
  if bKillUPF = True Then DisableUPF
End Sub

Sub CheckUPFHitCount(max)
  if UPFHitCount(CurrentPlayer) > max Then DisableUPF
End Sub
'**********************************************************************************************************
'Plunger code
'**********************************************************************************************************

Sub TimerVRPlunger_Timer
  If PinCab_Shooter.Y < -63 then
    PinCab_Shooter.Y = PinCab_Shooter.Y + 5
  End If
End Sub

Sub TimerVRPlunger2_Timer
  PinCab_Shooter.Y = -163 + (5* Plunger.Position) -20
  timervrplunger2.enabled = 0
End Sub



'**********************************************************************************************************
'
' DOF CODES
' By DARRINVPCLE
'
'**********************************************************************************************************
' E101 L FLIPPER
' E102 R FLIPPER
' E103 BUMPER 1
' E104 BUMPER 2
' E105 BUMPER 3
' E106 LEFT SLING
' E107 RIGHT SLING
' E108|E110 KNOCKER
' E165 ADD CREDIT
' E112 TILT
' E113 BALL LAUNCH
' E127 SKILLSHOT
' E130 STROBE
' E121 START BUTTON
' E174 DRAIN HIT
' E187 BALL READY
' E114 KICKER
' E171 BALL SAVE
' E115 ATTRACT
' E116 VUK ENTER
' E118 In The Village
' E117 GEAR MOTOR
' E128 LEFT SPINNER
' E129 RIGHT SPINNER
' E131 MULTIBALL
' E132 LEFT MAGNA CAPTURE
' E137 STROBE JACKPOTS
' E138 SUPER SKILLSHOT
' E161 DROP TGT RESET
' E162 DROP TGT HIT
' E164 ROLLOVERS
' E301|E302|E303 RBF
' E304|E305|E306 RMF
' E307|E308|E309 RTF
' E310|E311|E312 LBF
' E313|E314|E315 LMF
' E316|E317|E318 LTF
' E319|E320|E321 HELMET
' E190 HURRICANE HIT
' E191 UPPER LOOP 1
' E192 UPPER LOOP 2
' E193 UPPER LOOP 3
' E194 UPPER LOOP 4
' E195 TOP RAMP HIT
' E196 TRIGGER001
' E197 TRIGGER002
' E198 TRIGGER003
' E199 TRIGGER004
' E200 TRIGGER005
' E201 TARGET001
' E202 TARGET002
' E203 TARGET003
' E204 TARGET004
' E205 TARGET005
' E206 CAPTIVE BALL HIT
' E207 COMBO
' E213 RIGHT RAMP
' E214 LEFT RAMP
' E215 LEFT ORBIT INSIDE
' E216 LEFT ORBIT
' E217 RIGHT ORBIT
' E218 LIUP1
' E219 LIUP2
' E220 LIUP3
' E221 LIUP4
' E222 LIUP5
' E223 DARK D
' E224 DARK A
' E225 DARK R
' E226 DARK K
' E227 DARK ALL
' E228 C LEFT OUTLANE
' E229 A LEFT INLANE
' E230 M RIGHT INLANE
' E231 P RIGHT OUTLANE
' E232 CAMP ALL
' E233 RAMP1
' E234 RAMP01
' E235 RAMP001
' E236 RAMP0001
' E237 ARCH 1
' E238 ARCH 2
' E240 Ruins
' E242 Cove
' E244 Weald
' E246 Warrens
' E247 Ball locking
' E248 Prophet
' E250 Wulf
' E251 SwinePrince
' E252 Shambler
' E253 WizardMode
' E256 Gambler
' E258 Blacksmith
' E259 InTheDark
' E260 InTheDark2
' E261 DrownedCrew
'
'
'
'**********************************************************************************************************
'***************************************************************
' ZQUE: VPIN WORKSHOP ADVANCED QUEUING SYSTEM - 1.2.0
'***************************************************************
' WHAT IS IT?
' The VPin Workshop Advanced Queuing System allows table authors
' to put sub routine calls in a queue without creating a bunch
' of timers. There are many use cases for this: queuing sequences
' for light shows and DMD scenes, delaying solenoids until the
' DMD is finished playing all its sequences (such as holding a
' ball in a scoop), managing what actions take priority over
' others (e.g. an extra ball sequence is probably more important
' than a small jackpot), and many more.
'
' This system uses Scripting.Dictionary, a single timer, and the
' GameTime global to keep track of everything in the queue.
' This allows for better stability and a virtually unlimited
' number of items in the queue. It also allows for greater
' versatility, like pre-delays, queue delays, priorities, and
' even modifying items in the queue.
'
' The VPin Workshop Queuing System can replace vpmTimer as a
' proper queue system (each item depends on the previous)
' whereas vpmTimer is a collection of virtual timers that run
' in parallel. It also adds on other advanced functionality.
' However, this queue system does not have ROM support out of
' the box like vpmTimer does.
'
' I recommend reading all the comments before you implement the
' queuing system into your table.
'
' WHAT YOU NEED to use the queuing system:
' 1) Put this VBS file in your scripts folder, or copy / paste
'    the code into your table script (and skip step 2).
' 2) Include this file via Scripting.FileSystemObject, and
'    ExecuteGlobal it.
' 3) Make one or more queues by constructing the vpwQueueManager:
'    Dim queue : Set queue = New vpwQueueManager
' 4) Create (or use) a timer that is always enabled and
'    preferably has an interval of 1 millisecond. Use a
'    higher number for less time precision but less resource
'    use. You only need one timer even if you
'    have multiple queues.
' 5) For each queue you created, call its Tick routine in
'    the timer's *_timer() routine:
'    queue.Tick
' 6) You're done! Refer to the routines in vpwQueueManager to
'    learn how to use the queuing system.
'
' TUTORIAL: https://youtu.be/kpPYgOiUlxQ
'***************************************************************

'===========================================
' vpwQueueManager
' This class manages a queue of
' vpwQueueItems and executes them.
'===========================================
Class vpwQueueManager
  Public qItems ' A dictionary of vpwQueueItems in the queue (do NOT use native Scripting.Dictionary.Add/Remove; use the vpwQueueManager's Add/Remove methods instead!)
  Public preQItems ' A dictionary of vpwQueueItems pending to be added to qItems
  Public debugOn 'Null = no debug. String = activate debug by using this unique label for the queue. REQUIRES baldgeek's error logs.

  '----------------------------------------------------------
  ' vpwQueueManager.qCurrentItem
  ' This contains a string of the key currently active / at
  ' the top of the queue. An empty string means no items are
  ' active right now.
  ' This is an important property; it should be monitored
  ' in another timer or routine whenever you Add a queue item
  ' with a -1 (indefinite) preDelay or postDelay. Then, for
  ' preDelay, ExecuteCurrentItem should be called to run the
  ' queue item. And for postDelay, DoNextItem should be
  ' called to move to the next item in the queue.
  '
  ' For example, let's say you add a queue item with the
  ' key "kickTheBall" and an indefinite preDelay. You want
  ' to wait until another timer fires before this queue item
  ' executes and kicks the ball out of a scoop. In the other
  ' timer, you will monitor qCurrentItem. Once it equals
  ' "kickTheBall", call ExecuteCurrentItem, which will run
  ' the queue item and presumably kick out the ball.
  '
  ' WARNING!: If you do not properly execute one of these
  ' callback routines on an indefinite delayed item, then
  ' the queue will effectively freeze / stop until you do.
  '---------------------------------------------------------
  Public qCurrentItem

  Public preDelayTime ' The GameTime the preDelay for the qCurrentItem was started
  Public postDelayTime ' The GameTime the postDelay for the qCurrentItem was started

  Private onQueueEmpty ' A string or object to be called every time the queue empties (use the QueueEmpty property to get/set this)
  Private queueWasEmpty ' Boolean to determine if the queue was already empty when firing DoNextItem
  Private preDelayTransfer ' Number of milliseconds of preDelay to transfer over to the next queue item when doNextItem is called

  Private Sub Class_Initialize
    Set qItems = CreateObject("Scripting.Dictionary")
    Set preQItems = CreateObject("Scripting.Dictionary")
    qCurrentItem = ""
    onQueueEmpty = ""
    queueWasEmpty = True
    debugOn = Null
    preDelayTransfer = 0
  End Sub

  '----------------------------------------------------------
  ' vpwQueueManager.Tick
  ' This is where all the magic happens! Call this method in
  ' your timer's _timer routine to check the queue and
  ' execute the necessary methods. We do not iterate over
  ' every item in the queue here, which allows for superior
  ' performance even if you have hundreds of items in the
  ' queue.
  '----------------------------------------------------------
  Public Sub Tick()
    Dim item
    If qItems.Count > 0 Then ' Don't waste precious resources if we have nothing in the queue

      ' If no items are active, or the currently active item no longer exists, move to the next item in the queue.
      ' (This is also a failsafe to ensure the queue continues to work even if an item gets manually deleted from the dictionary).
      If qCurrentItem = "" Or Not qItems.Exists(qCurrentItem) Then
        DoNextItem
      Else ' We are good; do stuff as normal
        Set item = qItems.item(qCurrentItem)

        If item.Executed Then
          ' If the current item was executed and the post delay passed, go to the next item in the queue
          If item.postDelay >= 0 And GameTime >= (postDelayTime + item.postDelay) Then
            DebugLog qCurrentItem & " - postDelay of " & item.postDelay & " passed."
            DoNextItem
          End If
        Else
          ' If the current item expires before it can be executed, go to the next item in the queue
          If item.timeToLive > 0 And GameTime >= (item.queuedOn + item.timeToLive) Then
            DebugLog qCurrentItem & " - expired (Time To live). Moving To the Next queue item."
            DoNextItem
          End If

          ' If the current item was not executed yet and the pre delay passed, then execute it
          If item.preDelay >= 0 And GameTime >= (preDelayTime + item.preDelay) Then
            DebugLog qCurrentItem & " - preDelay of " & item.preDelay & " passed. Executing callback."
            item.Execute
            preDelayTime = 0
            postDelayTime = GameTime
          End If
        End If
      End If
    End If

    ' Loop through each item in the pre-queue to find any that is ready to be added
    If preQItems.Count > 0 Then
      Dim k, key
      k = preQItems.Keys
      For Each key In k
        Set item = preQItems.Item(key)

        ' If a queue item was pre-queued and is ready to be considered as actually in the queue, add it
        If GameTime >= (item.queuedOn + item.preQueueDelay) Then
          DebugLog key & " (preQueue) - preQueueDelay of " & item.preQueueDelay & " passed. Item added To the main queue."
          preQItems.Remove key
          Me.Add key, item.Callback, item.priority, 0, item.preDelay, item.postDelay, item.timeToLive, item.executeNow
        End If
      Next
    End If
  End Sub

  '----------------------------------------------------------
  ' vpwQueueManager.DoNextItem
  ' Goes to the next item in the queue and deletes the
  ' currently active one.
  '----------------------------------------------------------
  Public Sub DoNextItem()
    If Not qCurrentItem = "" Then
      If qItems.Exists(qCurrentItem) Then qItems.Remove qCurrentItem ' Remove the current item from the queue if it still exists
      qCurrentItem = ""
    End If

    If qItems.Count > 0 Then
      Dim k, key
      Dim nextItem
      Dim nextItemPriority
      Dim item
      nextItemPriority = 0
      nextItem = ""

      ' Find which item needs to run next based on priority first, queue order second (ignore items with an active preQueueDelay)
      k = qItems.Keys
      For Each key In k
        Set item = qItems.Item(key)

        If item.preQueueDelay <= 0 And item.priority > nextItemPriority Then
          nextItem = key
          nextItemPriority = item.priority
        End If
      Next

      If qItems.Exists(nextItem) Then
        Set item = qItems.Item(nextItem)
        DebugLog "DoNextItem - checking " & nextItem & " (priority " & item.priority & ")"

        ' Make sure the item is not expired and not already executed. If it is, remove it and re-call doNextItem
        If (item.timeToLive > 0 And GameTime >= (item.queuedOn + item.timeToLive + preDelayTransfer)) Or item.executed = True Then
          DebugLog "DoNextItem - " & nextItem & " expired (Time To live) Or already executed. Removing And going To the Next item."
          qItems.Remove nextItem
          DoNextItem
          Exit Sub
        End If

        'Transfer preDelay time when applicable
        If preDelayTransfer > 0 And item.preDelay > -1 Then
          DebugLog "DoNextItem " & nextItem & " - Transferred remaining postDelay of " & preDelayTransfer & " milliseconds from previously overridden queue item To its preDelay And timeToLive"
          qItems.Item(nextItem).preDelay = item.preDelay + preDelayTransfer
          If item.timeToLive > 0 Then qItems.Item(nextItem).timeToLive = item.timeToLive + preDelayTransfer
          preDelayTransfer = 0
        End If

        ' Set item as current / active, and execute if it has no pre-delay (otherwise Tick will take care of pre-delay)
        qCurrentItem = nextItem
        If item.preDelay = 0 Then
          DebugLog "DoNextItem - " & nextItem & " Now active. It has no preDelay, so executing callback immediately."
          item.Execute
          preDelayTime = 0
          postDelayTime = GameTime
        Else
          DebugLog "DoNextItem - " & nextItem & " Now active. Waiting For a preDelay of " & item.preDelay & " before executing."
          preDelayTime = GameTime
          postDelayTime = 0
        End If
      End If
    ElseIf queueWasEmpty = False Then
      DebugLog "DoNextItem - Queue Is Now Empty; executing queueEmpty callback."
      CallQueueEmpty() ' Call QueueEmpty if this was the last item in the queue
    End If
  End Sub

  '----------------------------------------------------------
  ' vpwQueueManager.ExecuteCurrentItem
  ' Helper routine that can be used when the current item is
  ' on an indefinite preDelay. Call this when you are ready
  ' for that item to execute.
  '----------------------------------------------------------
  Public Sub ExecuteCurrentItem()
    If Not qCurrentItem = "" And qItems.Exists(qCurrentItem) Then
      DebugLog "ExecuteCurrentItem - Executing the callback For " & qCurrentItem & "."
      Dim item
      Set item = qItems.Item(qCurrentItem)
      item.Execute
      preDelayTime = 0
      postDelayTime = GameTime
    End If
  End Sub

  '----------------------------------------------------------
  ' vpwQueueManager.Add
  ' REQUIRES Class vpwQueueItem
  '
  ' Add an item to the queue.
  '
  ' PARAMETERS:
  '
  ' key (string) - Unique name for this queue item
  ' WARNING: Specifying a key that already exists will
  ' overwrite the item in the queue. This is by design. Also
  ' note the following behaviors:
  ' * Tickers / clocks for tracking delay times will NOT be
  ' restarted for this item (but the total duration will be
  ' updated. For example, if the old preDelay was 3 seconds
  ' and 2 seconds elapsed, but Add was called to update
  ' preDelay to 5 seconds, then the queue item will now
  ' execute in 3 more seconds (new preDelay - time elapsed)).
  ' However, timeToLive WILL be restarted.
  ' * Items will maintain their same place in the queue.
  ' * If key = qCurrentItem (overwriting the currently active
  ' item in the queue) and qCurrentItem already executed
  ' the callback (but is waiting for a postDelay), then the
  ' current queue item's remaining postDelay will be added to
  ' the preDelay of the next item, and this item will be
  ' added to the bottom of the queue for re-execution.
  ' If you do not want it to re-execute, then add an If
  ' guard on your call to the Add method checking
  ' "If Not vpwQueueManager.qCurrentItem = key".
  '
  ' qCallback (object|string) - An object to be called,
  ' or string to be executed globally, when this queue item
  ' runs. I highly recommend making sub routines for groups
  ' of things that should be executed by the queue so that
  ' your qCallback string does not get long, and you can
  ' easily organize your callbacks. Also, use double
  ' double-quotes when the call itself has quotes in it
  ' (VBScript escaping).
  ' Example: "playsound ""Plunger"""
  '
  ' priority (number) - Items in the queue will be executed
  ' in order from highest priority to lowest. Items with the
  ' same priority will be executed in order according to
  ' when they were added to the queue. Use any number
  ' greater than 0. My recommendation is to make a plan for
  ' your table on how you will prioritize various types of
  ' queue items and what priority number each type should
  ' have. Also, you should reserve priority 1 (lowest) to
  ' items which should wait until everything else in the
  ' queue is done (such as ejecting a ball from a scoop).
  '
  ' preQueueDelay (number) - The number of
  ' milliseconds before the queue actually considers this
  ' item as "in the queue" (pretend you started a timer to
  ' add this item into the queue after this delay; this
  ' logically works in a similar way; the only difference is
  ' timeToLive is still considered even when an item is
  ' pre-queued.) Set to 0 to add to the queue immediately.
  ' NOTE: this should be less than timeToLive.
  '
  ' preDelay (number) - The number of milliseconds before
  ' the qCallback executes once this item is active (top)
  ' in the queue. Set this to 0 to immediately execute the
  ' qCallback when this item becomes active.
  ' Set this to -1 to have an indefinite delay until
  ' vpwQueueManager.ExecuteCurrentItem is called (see the
  ' comment for qCurrentItem for more information).
  ' NOTE: this should be less than timeToLive. And, if
  ' timeToLive runs out before preDelay runs out, the item
  ' will be removed and will not execute.
  '
  ' postDelay (number) - After the qCallback executes, the
  ' number of milliseconds before moving on to the next item
  ' in the queue. Set this to -1 to have an indefinite delay
  ' until vpwQueueManager.DoNextItem is called (see the
  ' comment for qCurrentItem for more information).
  '
  ' timeToLive (number) - After this item is added to the
  ' queue, the number of milliseconds before this queue item
  ' expires / is removed if the qCallback is not executed by
  ' then. Set to 0 to never expire. NOTE: If not 0, this
  ' should be greater than preDelay + preQueueDelay or the
  ' item will expire before the qCallback is executed.
  ' Example use case: Maybe a player scored a jackpot, but
  ' it would be awkward / irrelevant to play that jackpot
  ' sequence if it hasn't played after a few seconds (e.g.
  ' other items in the queue took priority).
  '
  ' executeNow (boolean) - Specify true if this item
  ' should interrupt the queue and run immediately. This
  ' will only happen, however, if the currently active item
  ' has a priority less than or equal to the item you are
  ' adding. Note this does not bypass preQueueDelay nor
  ' preDelay if set.
  ' Example: If a player scores an extra ball, you might
  ' want that to interrupt everything else going on as it
  ' is an important milestone.
  '----------------------------------------------------------
  Public Sub Add(key, qCallback, priority, preQueueDelay, preDelay, postDelay, timeToLive, executeNow)
    DebugLog "Adding queue item " & key

    'Construct the item class
    Dim newClass
    Set newClass = New vpwQueueItem
    With newClass
      .Callback = qCallback
      .priority = priority
      .preQueueDelay = preQueueDelay
      .preDelay = preDelay
      .postDelay = postDelay
      .timeToLive = timeToLive
      .executeNow = executeNow
    End With

    'If we are attempting to overwrite the current queue item which already executed, take the remaining postDelay and add it to the preDelay of the next item. And set us up to immediately go to the next item while re-adding this item to the queue.
    If preQueueDelay <= 0 And qItems.Exists(key) And qCurrentItem = key Then
      If qItems.Item(key).executed = True Then
        DebugLog key & " (Add) - Attempting To overwrite the current queue item which already executed. Immediately re-queuing this item To the bottom of the queue, transferring the remaining postDelay To the Next item, And going To the Next item."
        If qItems.Item(key).postDelay >= 0 Then
          preDelayTransfer = ((postDelayTime + qItems.Item(key).postDelay) - GameTime)
        End If

        'Remove current queue item so we can go to the next item, this can be re-queued to the bottom, and the remaining postDelay transferred to the preDelay of the next item
        qItems.Remove qCurrentItem
        qCurrentItem = ""
      End If
    End If

    ' Determine execution stuff if this item does not have a pre-queue delay
    If preQueueDelay <= 0 Then
      If executeNow = True Then
        ' Make sure this item does not immediately execute if the current item has a higher priority
        If Not qCurrentItem = "" And qItems.Exists(qCurrentItem) Then
          Dim item
          Set item = qItems.Item(qCurrentItem)
          If item.priority <= priority Then
            DebugLog key & " (Add) - Execute Now was Set To True And this item's priority (" & priority & ") Is >= the active item's priority (" & item.priority & " from " & qCurrentItem & "). Making it the current active queue item."
            qCurrentItem = key
            If preDelay = 0 And preDelayTransfer = 0 Then
              DebugLog key & " (Add) - No pre-delay. Executing the callback immediately."
              newClass.Execute
              preDelayTime = 0
              postDelayTime = GameTime
            Else
              DebugLog key & " (Add) - Waiting For a pre-delay of " & (preDelay + preDelayTransfer) & " before executing the callback."
              preDelayTime = GameTime
              postDelayTime = 0
            End If
          Else
            DebugLog key & " (Add) - Execute Now was Set To True, but this item's priority (" & priority & ") Is Not >= the active item's priority (" & item.priority & " from " & qCurrentItem & "). This item will Not be executed Now And will be added To the queue normally."
          End If
        Else
          DebugLog key & " (Add) - Execute Now was Set To True And no item was active In the queue. Making it the current active queue item."
          qCurrentItem = key
          If preDelay = 0 Then
            DebugLog key & " (Add) - No pre-delay. Executing the callback immediately."
            preDelayTransfer = 0 'No preDelay transfer if we are immediately re-executing the same queue item
            newClass.Execute
            preDelayTime = 0
            postDelayTime = GameTime
          Else
            DebugLog key & " (Add) - Waiting For a pre-delay of " & preDelay & " before executing the callback."
            preDelayTime = GameTime
            postDelayTime = 0
          End If
        End If
      End If
      If qItems.Exists(key) Then 'Overwrite existing item in the queue if it exists
        DebugLog key & " (Add) - Already exists In the queue. Updating the item With the new parameters passed In Add."
        Set qItems.Item(key) = newClass
      Else
        DebugLog key & " (Add) - Added To the queue."
        qItems.Add key, newClass
      End If
      queueWasEmpty = False
    Else
      If preQItems.Exists(key) Then 'Overwrite existing item in the preQueue if it exists
        DebugLog key & " (Add) - Already exists In the preQueue. Updating the item With the new parameters passed In Add."
        Set preQItems.Item(key) = newClass
      Else
        DebugLog key & " (Add) - Added To the preQueue."
        preQItems.Add key, newClass
      End If
    End If
  End Sub

  '----------------------------------------------------------
  ' vpwQueueManager.Remove
  '
  ' Removes an item from the queue. It is better to use this
  ' than to remove the item from qItems directly as this sub
  ' will also call DoNextItem to advance the queue if
  ' the item removed was the active item.
  ' NOTE: This only removes items from qItems; to remove
  ' an item from preQItems, use the standard
  ' Scripting.Dictionary Remove method.
  '
  ' PARAMETERS:
  '
  ' key (string) - Unique name of the queue item to remove.
  '----------------------------------------------------------
  Public Sub Remove(key)
    If qItems.Exists(key) Then
      DebugLog key & " (Remove)"
      qItems.Remove key
      If qCurrentItem = key Or qCurrentItem = "" Then DoNextItem ' Ensure the queue does not get stuck
    End If
  End Sub

  '----------------------------------------------------------
  ' vpwQueueManager.RemoveAll
  '
  ' Removes all items from the queue / clears the queue.
  ' It is better to call this sub than to remove all items
  ' from qItems directly because this sub cleans up the queue
  ' to ensure it continues to work properly.
  '
  ' PARAMETERS:
  '
  ' preQueue (boolean) - Also clear the pre-queue.
  '----------------------------------------------------------
  Public Sub RemoveAll(preQueue)
    DebugLog "Queue was emptied via RemoveAll."

    ' Loop through each item in the queue and remove it
    Dim k, key
    k = qItems.Keys
    For Each key In k
      qItems.Remove key
    Next
    qCurrentItem = ""

    If queueWasEmpty = False Then CallQueueEmpty() ' Queue is now empty, so call our callback if applicable

    If preQueue Then
      k = preQItems.Keys
      For Each key In k
        preQItems.Remove key
      Next
    End If
  End Sub

  '----------------------------------------------------------
  ' Get vpwQueueManager.QueueEmpty
  ' Get the current callback for when the queue is empty.
  '----------------------------------------------------------
  Public Property Get QueueEmpty()
    If IsObject(onQueueEmpty) Then
      Set QueueEmpty = onQueueEmpty
    Else
      QueueEmpty = onQueueEmpty
    End If
  End Property

  '----------------------------------------------------------
  ' Let vpwQueueManager.QueueEmpty
  ' Set the callback to call every time the queue empties.
  ' This could be useful for setting a sub routine to be
  ' called each time the queue empties for doing things such
  ' as ejecting balls from scoops. Unlike using the Add
  ' method, this callback is immune from getting removed by
  ' higher priority items in the queue and will be called
  ' every time the queue is emptied, not just once.
  '
  ' PARAMETERS:
  '
  ' callback (object|string) - The callback to call every
  ' time the queue empties.
  '----------------------------------------------------------
  Public Property Let QueueEmpty(callback)
    If IsObject(callback) Then
      Set onQueueEmpty = callback
    ElseIf VarType(callback) = vbString Then
      onQueueEmpty = callback
    End If
  End Property

  '----------------------------------------------------------
  ' Get vpwQueueManager.CallQueueEmpty
  ' Private method that actually calls the QueueEmpty
  ' callback.
  '----------------------------------------------------------
  Private Sub CallQueueEmpty()
    If queueWasEmpty = True Then Exit Sub
    queueWasEmpty = True

    If IsObject(onQueueEmpty) Then
      Call onQueueEmpty(0)
    ElseIf VarType(onQueueEmpty) = vbString Then
      If onQueueEmpty > "" Then ExecuteGlobal onQueueEmpty
    End If
  End Sub

  '----------------------------------------------------------
  ' DebugLog
  ' Log something if debugOn is not null.
  ' REQUIRES / uses the WriteToLog sub from Baldgeek's
  ' error log library.
  '----------------------------------------------------------
  Private Sub DebugLog(message)
    If Not IsNull(debugOn) Then
      WriteToLog "VPW Queue " & debugOn, message
    End If
  End Sub
End Class

'===========================================
' vpwQueueItem
' Represents a single item for the queue
' system. Do NOT use this class directly.
' Instead, use the vpwQueueManager.Add
' routine.

' You can, however, access an individual
' item in the queue via
' vpwQueueManager.qItems and then modify
' its properties while it is still in the
' queue.
'===========================================
Class vpwQueueItem  ' Do not construct this class directly; use vpwQueueManager.Add instead, and vpwQueueManager.qItems.Item(key) to modify an item's properties.
  Public priority ' The item's set priority
  Public timeToLive ' The item's set timeToLive milliseconds requested
  Public preQueueDelay ' The item's pre-queue milliseconds requested
  Public preDelay ' The item's pre delay milliseconds requested
  Public postDelay ' The item's post delay milliseconds requested
  Public executeNow ' Whether the item was set to Execute immediately
  Private qCallback ' The item's callback object or string (use the Callback property on the class to get/set it)

  Public executed ' Whether or not this item's qCallback was executed yet
  Public queuedOn ' The game time this item was added to the queue
  Public executedOn ' The game time this item was executed

  Private Sub Class_Initialize
    ' Defaults
    priority = 0
    timeToLive = 0
    preQueueDelay = 0
    preDelay = 0
    postDelay = 0
    qCallback = ""
    executeNow = False

    queuedOn = GameTime
    executedOn = 0
  End Sub

  '----------------------------------------------------------
  ' vpwQueueItem.Execute
  ' Executes the qCallback on this item if it was not yet
  ' already executed.
  '----------------------------------------------------------
  Public Sub Execute()
    If executed Then Exit Sub ' Do not allow an item's qCallback to ever Execute more than one time

    'Mark as execute before actually executing callback; that way, if callback recursively adds the item back into the queue, then we can properly handle it.
    executed = True
    executedOn = GameTime

    ' Execute qCallback
    If IsObject(qCallback) Then
      Call qCallback(0)
    ElseIf VarType(qCallback) = vbString Then
      If qCallback > "" Then ExecuteGlobal qCallback
    End If
  End Sub

  Public Property Get Callback()
    If IsObject(qCallback) Then
      Set Callback = qCallback
    Else
      Callback = qCallback
    End If
  End Property

  Public Property Let Callback(cb)
    If IsObject(cb) Then
      Set qCallback = cb
    ElseIf VarType(cb) = vbString Then
      qCallback = cb
    End If
  End Property
End Class

'***************************************************************
' END VPIN WORKSHOP ADVANCED QUEUING SYSTEM
'***************************************************************

'**********************************************************************************************************
Sub SearchForStuckBalls_Timer() ' runs every 2500 msec throughout the game
Exit Sub
  If BallsInHole > 0 And bHoldBall = False Then
    bBallPossiblyStuck = True
    triggerscript 2000, "ValidateStuckBall"
  Else
    bBallPossiblyStuck = False
  End If
End Sub

Sub ValidateStuckBall
Exit Sub
  If BallsInHole > 0 And bHoldBall = False Then
    KickBallOut
    BallsInHole = ballsInHole - 1
    bBallPossiblyStuck = False
  End If
End Sub
Sub lspin_Timer()
  'lspin.TimerEnabled = false
  'lspin.TimerEnabled = true
  StopDMDLabelFlash "BlacksmithOn"
End Sub

Sub rspin_Timer()
  'rspin.TimerEnabled = false
  'rspin.TimerEnabled = true
  StopDMDLabelFlash "BlacksmithOn"
End Sub

Sub liup1_Timer()
  if Missions(CurrentPlayer,3) <> 3 Then pDMDLabelHide "InTheDarkOn"
  if Missions(CurrentPlayer,3) <> 1 Then li019.state = 1
End Sub

Sub liup2_Timer()
  if Missions(CurrentPlayer,3) <> 3 Then pDMDLabelHide "InTheDarkOn"
  if Missions(CurrentPlayer,3) <> 1 Then li020.state = 1
End Sub

Sub liup3_Timer()
  if Missions(CurrentPlayer,3) <> 3 Then pDMDLabelHide "InTheDarkOn"
  if Missions(CurrentPlayer,3) <> 1 Then li056.state = 1
End Sub

Sub liup4_Timer()
  if Missions(CurrentPlayer,3) <> 3 Then pDMDLabelHide "InTheDarkOn"
  if Missions(CurrentPlayer,3) <> 1 Then li055.state = 1
End Sub

Sub liup5_Timer()
  if Missions(CurrentPlayer,3) <> 3 Then pDMDLabelHide "InTheDarkOn"
  if Missions(CurrentPlayer,3) <> 1 Then li054.state = 1
End Sub

Sub QueueTimer_Timer()
  EOBQueue.Tick
  LightSeqQueue.Tick
  BallHandlingQueue.Tick
  GeneralPuPQueue.Tick
  AudioQueue.Tick
  HighScoreQueue.Tick
End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  SCORBIT Interface
' To Use:
' 1) Define a timer tmrScorbit
' 2) Call DoInit at the end of PupInit or in Table Init if you are nto using pup with the appropriate parameters
'     Replace 389 with your TableID from Scorbit
'     Replace GRWvz-MP37P from your table on OPDB - eg: https://opdb.org/machines/2103
'   if Scorbit.DoInit(389, "PupOverlays", "1.0.0", "GRWvz-MP37P") then
'     tmrScorbit.Interval=2000
'     tmrScorbit.UserValue = 0
'     tmrScorbit.Enabled=True
'   End if
' 3) Customize helper functions below for different events if you want or make your own
' 4) Call
'   DoInit - After Pup/Screen is setup (PuPInit)
'   StartSession - When a game starts (ResetForNewGame)
'   StopSession - When the game is over (Table1_Exit, EndOfGame)
'   SendUpdate - called when Score Changes (AddScore)
'     SendUpdate(P1Score, P2Score, P3Score, P4Score, CurrentBall, CurrentPlayer, NumberPlayers)
'     Example:  Scorbit.SendUpdate Score(0), Score(1), Score(2), Score(3), Balls, CurrentPlayer+1, PlayersPlayingGame
'   SetGameMode - When different game events happen like starting a mode, MB etc.  (ScorbitBuildGameModes helper function shows you how)
' 5) Drop the binaries sQRCode.exe and sToken.exe in your Pup Root so we can create session tokens and QRCodes.
' - Drop QRCode Images (QRCodeS.png, QRcodeB.png) in yur pup PuPOverlays if you want to use those
' 6) Callbacks
'   Scorbit_Paired    - Called when machine is successfully paired.  Hide QRCode and play a sound
'   Scorbit_PlayerClaimed - Called when player is claimed.  Hide QRCode, play a sound and display name
'   ScorbitClaimQR    - Call before/after plunge (swPlungerRest_Hit, swPlungerRest_UnHit)
' 7) Other
'   Set Pair QR Code  - During Attract
'     if (Scorbit.bNeedsPairing) then
'       PuPlayer.LabelSet pDMDFull, "ScorbitQR_a", "PuPOverlays\\QRcode.png",1,"{'mt':2,'width':32, 'height':64,'xalign':0,'yalign':0,'ypos':5,'xpos':5}"
'       PuPlayer.LabelSet pDMDFull, "ScorbitQRIcon_a", "PuPOverlays\\QRcodeS.png",1,"{'mt':2,'width':36, 'height':85,'xalign':0,'yalign':0,'ypos':3,'xpos':3,'zback':1}"
'     End if
'   Set Player Names  - Wherever it makes sense but I do it here: (pPupdateScores)
'      if ScorbitActive then
'     if Scorbit.bSessionActive then
'       PlayerName=Scorbit.GetName(CurrentPlayer+1)
'       if PlayerName="" then PlayerName= "Player " & CurrentPlayer+1
'     End if
'      End if
'
'
'>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
' TABLE CUSTOMIZATION START HERE

Sub Scorbit_Paired()                ' Scorbit callback when new machine is paired
debug4 "Scorbit PAIRED"
  PlaySound "scorbit_login"
' PlaySoundGame "scorbit_login", 0, 1, 0 ,0, 0, 1
' PuPlayer.LabelSet pDMD, "ScorbitQR1", "PuPOverlays\\clear.png",0,""
' PuPlayer.LabelSet pDMD, "ScorbitQRIcon1", "PuPOverlays\\clear.png",0,""
  PuPEvent 900
  'PuPEvent 400
  pbackglasslabelhide "ScorbitQR1"
  pbackglasslabelhide "ScorbitQRIcon1"
End Sub

Sub Scorbit_PlayerClaimed(PlayerNum, PlayerName)  ' Scorbit callback when QR Is Claimed
debug4 "Scorbit LOGIN"
  PlaySound "scorbit_login"
' PlaySoundGame "scorbit_login", 0, 1, 0 ,0, 0, 1
  ScorbitClaimQR(False)
' puPlayer.LabelSet pDMD,"ScorbitQR2",  PlayerName  ,1,""
  'puPlayer.LabelSet pDMD,"Credits","Credits: " & ""& Credits & "./ " & PlayerName & " / BALL: " & BallinPlay ,1,""
'debug3 "Scorbit_PlayerClaimed:" & PlayerNum & " " & PlayerName
End Sub


Sub ScorbitClaimQR(bShow)
debug4 "In ScorbitClaimQR: " &bShow         '  Show QRCode on first ball for users to claim this position
  if Scorbit.bSessionActive=False then Exit Sub
  if ScorbitShowClaimQR=False then Exit Sub
  if Scorbit.bNeedsPairing then exit sub

  if bShow and balls=1 and bGameInPlay and Scorbit.GetName(CurrentPlayer+1)="" then
    if ScorbitClaimSmall=0 then ' Desktop Make it Larger
      'puPlayer.LabelSet pDMD, "ScorbitQRIcon2", "PuPOverlays\\QRcodeB.png",1,"{'mt':2,'width':39, 'height':80,'xalign':0,'yalign':0,'ypos':3,'xpos':3,'zback':1}"
      'puPlayer.LabelSet pDMD, "ScorbitQR2", "PuPOverlays\\QRclaim.png",1,"{'mt':2,'width':34, 'height':60,'xalign':0,'yalign':0,'ypos':5,'xpos':5}"
''' Need to adjust this sizing later
      PuPEvent 992
      pbackglasslabelshow "ScorbitQRIcon2"
      pbackglasslabelshow "ScorbitQR2"
    else
      'PuPlayer.LabelSet pDMD, "ScorbitQRIcon2", "PuPOverlays\\QRcodeB.png",1,"{'mt':2,'width':25, 'height':50,'xalign':0,'yalign':0,'ypos':3,'xpos':3,'zback':1}"
      'PuPlayer.LabelSet pDMD, "ScorbitQR2", "PuPOverlays\\QRclaim.png",1,"{'mt':2,'width':22, 'height':38,'xalign':0,'yalign':0,'ypos':5,'xpos':5}"
      pBackglassLabelSetSizeImage "ScorbitQR2",17,30
      pBackglassLabelSetPos "ScorbitQR2",82,37

      BallHandlingQueue.Add "PuPEvent 992","PuPEvent 992",44,0,0,0,0,True
      BallHandlingQueue.Add "ScorbitQR2","pbackglasslabelshow ""ScorbitQR2"" ",44,0,0,0,0,True
      pbackglasslabelshow "ScorbitQRIcon2"
    End if
  Else
    debug4 "Hiding QR claim"
    'PuPlayer.LabelSet pDMD, "ScorbitQR2", "PuPOverlays\\clear.png",0,""
    'PuPlayer.LabelSet pDMD, "ScorbitQRIcon2", "PuPOverlays\\clear.png",0,"
    PuPEvent 900
    pbackglasslabelhide "ScorbitQRIcon2"
    pbackglasslabelhide "ScorbitQR2"
  End if
End Sub

Sub StopScorbit
  Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame   ' Stop updateing scores
End Sub

Sub ScorbitBuildGameModes()   ' Custom function to build the game modes for better stats
  dim GameModeStr
  if Scorbit.bSessionActive=False then Exit Sub
  GameModeStr="NA:"

  if BallsRemaining(CurrentPlayer) <= 0 Then  'no balls left
    GameModeStr="NA{red}:YOU FAILED!!!"
  Else                    'game on
    GetAM
    Debug4 "AMCombo Value - " &AMCombo
    Select Case AMCombo
      Case "2:2":
        Debug4 "Ruins Win"
        GameModeStr="NA{yellow}:Ruins Dungeon Cleared"
      Case "10:2":
        Debug4 "Prophet Defeated"
        GameModeStr="NA{purple}:Prophet Defeated"
      Case "4:2":
        Debug4 "Cove Win"
        GameModeStr="NA{blue}:Cove Dungeon Cleared"
      Case "11:2":
        Debug4 "DrownedCrew Defeated"
        GameModeStr="NA{blue}:Drowned Crew Defeated"
      Case "6:2":
        Debug4 "Weald Win"
        GameModeStr="NA{red}:Weald Dungeon Cleared"
      Case "12:2":
        Debug4 "Vvulf Defeated"
        GameModeStr="NA{red}:Vvulf Defeated"
      Case "8:2":
        Debug4 "Warrens Win"
        GameModeStr="NA{orange}:Warrens Dungeon Cleared"
      Case "13:2":
        Debug4 "SwinePrince Defeated"
        GameModeStr="NA{pink}:Swine Prince Defeated"
      Case "14:2":
        Debug4 "Shambler Defeated"
        GameModeStr="NA{purple}:Shambler Defeated"
      Case "15:1":
        Debug4 "WizardMode Achieved"
        GameModeStr="NA{green}:Wizard Mode"
      Case Else:
        'Do nothing
    End Select

    if Missions(CurrentPlayer,1) = 9 And BSMode = 2 Then GameModeStr="NA{red}:Blacksmith Mode Completed"
    if Missions(CurrentPlayer,2) = 2 And GMode = 2 Then GameModeStr="NA{green}:Gambler Mode Completed"
    if Missions(CurrentPlayer,3) = 3 And TMode = 2 Then GameModeStr="NA{yellow}:InTheDark Mode Completed"

  End If ' endif balls remaining


'   Select Case ReactorState(CurrentPlayer)
'     Case 0: 'Targeted
'       GameModeStr="NA{blue}:Reactor " & ReactorLevel(CurrentPlayer) & " Targeted"
'     Case 1: 'Ready
'       GameModeStr="NA{yellow}:Reactor " & ReactorLevel(CurrentPlayer) & " Ready"
'     Case 2: 'Started
'       GameModeStr="NA{green}:Reactor " & ReactorLevel(CurrentPlayer) & " Started;NA{orange}:Reactor Temp " & ReactorPercent(CurrentPlayer)
'     Case 3: 'Critical
'       GameModeStr="NA{red}:Reactor " & ReactorLevel(CurrentPlayer) & " Critical"
'   End Select

'                    # Multiball
'                    if self.game.MultiballController_mode.multiballActive == True:
'                        mode_str = mode_str + ";MB:Multiball"

'   if bMultiBallMode Then
'     GameModeStr = GameModeStr & ";MB:Multiball"
'   end if

'                       # Bonus X
'                    if self.game.bonusController_mode.currentPlayerBonusX > 1:
'                        mode_str = mode_str + ";BX" + str(self.game.bonusController_mode.currentPlayerBonusX) + \
'                                   ":Bonus " + str(self.game.bonusController_mode.currentPlayerBonusX) + "X"

'   if BonusMultiplier(CurrentPlayer) > 1 Then
'     GameModeStr = GameModeStr & ";BX" & BonusMultiplier(CurrentPlayer) & ":Bonus " & BonusMultiplier(CurrentPlayer) & "X"
'   end if


'   if ExtraBallsAwards(CurrentPlayer) = 1 then
'     GameModeStr = GameModeStr & ";EB1:Extra Ball (1)"
'   elseif ExtraBallsAwards(CurrentPlayer) = 2 then
'     GameModeStr = GameModeStr & ";EB2:Extra Ball (2)"
'   elseif ExtraBallsAwards(CurrentPlayer) = 3 then
'     GameModeStr = GameModeStr & ";EB3:Extra Ball (3)"
'   end if
' end if
'debug3 GameModeStr

  Scorbit.SetGameMode(GameModeStr)

End Sub

Sub Scorbit_LOGUpload(state)  ' Callback during the log creation process.  0=Creating Log, 1=Uploading Log, 2=Done
  Select Case state
    case 0:
      debug4 "CREATING LOG"
    case 1:
      debug4 "Uploading LOG"
    case 2:
      debug4 "LOG Complete"
  End Select
End Sub
'<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
' TABLE CUSTOMIZATION END HERE - NO NEED TO EDIT BELOW THIS LINE


dim Scorbit : Set Scorbit = New ScorbitIF
' Workaround - Call get a reference to Member Function
Sub tmrScorbit_Timer()                ' Timer to send heartbeat
  Scorbit.DoTimer(tmrScorbit.UserValue)
  tmrScorbit.UserValue=tmrScorbit.UserValue+1
  if tmrScorbit.UserValue>5 then tmrScorbit.UserValue=0
End Sub
Function ScorbitIF_Callback()
  Scorbit.Callback()
End Function
Class ScorbitIF

  Public bSessionActive
  Public bNeedsPairing
  Private bUploadLog
  Private bActive
  Private LOGFILE(10000000)
  Private LogIdx

  Private bProduction

  Private TypeLib
  Private MyMac
  Private Serial
  Private MyUUID
  Private TableVersion

  Private SessionUUID
  Private SessionSeq
  Private SessionTimeStart
  Private bRunAsynch
  Private bWaitResp
  Private GameMode
  Private GameModeOrig    ' Non escaped version for log
  Private VenueMachineID
  Private CachedPlayerNames(4)
  Private SaveCurrentPlayer

  Public bEnabled
  Private sToken
  Private machineID
  Private dirQRCode
  Private opdbID
  Private wsh

  Private objXmlHttpMain
  Private objXmlHttpMainAsync
  Private fso
  Private Domain

  Public Sub Class_Initialize()
    bActive="false"
    bSessionActive=False
    bEnabled=False
  End Sub

  Property Let UploadLog(bValue)
    bUploadLog = bValue
  End Property

  Sub DoTimer(bInterval)  ' 2 second interval
    dim holdScores(4)
    dim i
    if bInterval=0 then
      SendHeartbeat()
    elseif bRunAsynch And bSessionActive = True then ' Game in play (Updated for TNA to resolve stutter in CoopMode)
      Scorbit.SendUpdate Score(1), Score(2), Score(3), Score(4), Balls, CurrentPlayer, PlayersPlayingGame
    End if
  End Sub

  Function GetName(PlayerNum) ' Return Parsed Players name
    if PlayerNum<1 or PlayerNum>4 then
      GetName=""
    else
      GetName=CachedPlayerNames(PlayerNum-1)
    End if
  End Function

  Function DoInit(MyMachineID, Directory_PupQRCode, Version, opdb)
    dim Nad
    Dim EndPoint
    Dim resultStr
    Dim UUIDParts
    Dim UUIDFile

    bProduction=1
'   bProduction=0
    SaveCurrentPlayer=0
    VenueMachineID=""
    bWaitResp=False
    bRunAsynch=False
    DoInit=False
    opdbID=opdb
    dirQrCode=Directory_PupQRCode
    MachineID=MyMachineID
    TableVersion=version
    bNeedsPairing=False
    if bProduction then
      domain = "api.scorbit.io"
    else
      domain = "staging.scorbit.io"
      domain = "scorbit-api-staging.herokuapp.com"
    End if
    Set fso = CreateObject("Scripting.FileSystemObject")
    dim objLocator:Set objLocator = CreateObject("WbemScripting.SWbemLocator")
    Dim objService:Set objService = objLocator.ConnectServer(".", "root\cimv2")
    Set objXmlHttpMain = CreateObject("Msxml2.ServerXMLHTTP")
    Set objXmlHttpMainAsync = CreateObject("Microsoft.XMLHTTP")
    objXmlHttpMain.onreadystatechange = GetRef("ScorbitIF_Callback")
    Set wsh = CreateObject("WScript.Shell")

    ' Get Mac for Serial Number
    dim Nads: set Nads = objService.ExecQuery("Select * from Win32_NetworkAdapter where physicaladapter=true")
    for each Nad in Nads
      if not isnull(Nad.MACAddress) then
        if left(Nad.MACAddress, 6)<>"00090F" then ' Skip over forticlient MAC
debug4 "Using MAC Addresses:" & Nad.MACAddress & " From Adapter:" & Nad.description
          MyMac=replace(Nad.MACAddress, ":", "")
          Exit For
        End if
      End if
    Next
    Serial=eval("&H" & mid(MyMac, 5))
    if Serial<0 then Serial=eval("&H" & mid(MyMac, 6))    ' Mac Address Overflow Special Case
    if MyMachineID<>2108 then       ' GOTG did it wrong but MachineID should be added to serial number also
      Serial=Serial+MyMachineID
    End if
'   Serial=123456
    debug4 "Serial:" & Serial

    ' Get System UUID
    set Nads = objService.ExecQuery("SELECT * FROM Win32_ComputerSystemProduct")
    for each Nad in Nads
      debug4 "Using UUID:" & Nad.UUID
      MyUUID=Nad.UUID
      Exit For
    Next

    if MyUUID="" then
      MsgBox "SCORBIT - Can get UUID, Disabling."
      Exit Function
    elseif MyUUID="03000200-0400-0500-0006-000700080009" or ScorbitAlternateUUID then
      If fso.FolderExists(UserDirectory) then
        If fso.FileExists(UserDirectory & "ScorbitUUID.dat") then
          Set UUIDFile = fso.OpenTextFile(UserDirectory & "ScorbitUUID.dat",1)
          MyUUID = UUIDFile.ReadLine()
          UUIDFile.Close
          Set UUIDFile = Nothing
        Else
          MyUUID=GUID()
          Set UUIDFile=fso.CreateTextFile(UserDirectory & "ScorbitUUID.dat",True)
          UUIDFile.WriteLine MyUUID
          UUIDFile.Close
          Set UUIDFile=Nothing
        End if
      End if
    End if

    ' Clean UUID
    UUIDParts=split(MyUUID, "-")
    MyUUID=LCASE(Hex(eval("&h" & UUIDParts(0))+MyMachineID) & UUIDParts(1) &  UUIDParts(2) &  UUIDParts(3) & UUIDParts(4))     ' Add MachineID to UUID
    MyUUID=LPad(MyUUID, 32, "0")
'   MyUUID=Replace(MyUUID, "-",  "")
    debug4 "MyUUID:" & MyUUID


' Debug
'   myUUID="adc12b19a3504453a7414e722f58737f"
'   Serial="123456778"

    ' Authenticate and get our token
    if getStoken() then
      bEnabled=True
'     SendHeartbeat
      DoInit=True
    End if
  End Function

  Sub Callback()
    Dim ResponseStr
    Dim i
    Dim Parts
    Dim Parts2
    Dim Parts3
    if bEnabled=False then Exit Sub

    if bWaitResp and objXmlHttpMain.readystate=4 then
'     debug3 "CALLBACK: " & objXmlHttpMain.Status & " " & objXmlHttpMain.readystate
      if objXmlHttpMain.Status=200 and objXmlHttpMain.readystate = 4 then
        ResponseStr=objXmlHttpMain.responseText
        'debug3 "RESPONSE: " & ResponseStr

        ' Parse Name
        If bSessionActive = True Then
          if CachedPlayerNames(SaveCurrentPlayer-1)="" then  ' Player doesnt have a name
            if instr(1, ResponseStr, "cached_display_name") <> 0 Then ' There are names in the result
              Parts=Split(ResponseStr,",{")             ' split it
              if ubound(Parts)>=SaveCurrentPlayer-1 then        ' Make sure they are enough avail
                if instr(1, Parts(SaveCurrentPlayer-1), "cached_display_name")<>0 then  ' See if mine has a name
                  CachedPlayerNames(SaveCurrentPlayer-1)=GetJSONValue(Parts(SaveCurrentPlayer-1), "cached_display_name")    ' Get my name
                  CachedPlayerNames(SaveCurrentPlayer-1)=Replace(CachedPlayerNames(SaveCurrentPlayer-1), """", "")
                  Scorbit_PlayerClaimed SaveCurrentPlayer, CachedPlayerNames(SaveCurrentPlayer-1)
  '               debug3 "Player Claim:" & SaveCurrentPlayer & " " & CachedPlayerNames(SaveCurrentPlayer-1)
                End if
              End if
            End if
          else                            ' Check for unclaim
            if instr(1, ResponseStr, """player"":null")<>0 Then ' Someone doesnt have a name
              Parts=Split(ResponseStr,"[")            ' split it
  'debug3 "Parts:" & Parts(1)
              Parts2=Split(Parts(1),"}")              ' split it
              for i = 0 to Ubound(Parts2)
  'debug3 "Parts2:" & Parts2(i)
                if instr(1, Parts2(i), """player"":null")<>0 Then
                  CachedPlayerNames(i)=""
                End if
              Next
            End if
          End if
        End If

        'Check heartbeat
        HandleHeartbeatResp ResponseStr
      End if
      bWaitResp=False
    End if
  End Sub

  Public Sub StartSession()
    if bEnabled=False then Exit Sub
    Debug4 "Scorbit Start Session"
    CachedPlayerNames(0)=""
    CachedPlayerNames(1)=""
    CachedPlayerNames(2)=""
    CachedPlayerNames(3)=""
    bRunAsynch=True
    bActive="true"
    bSessionActive=True
    SessionSeq=0
    SessionUUID=GUID()
    SessionTimeStart=GameTime
    LogIdx=0
    SendUpdate 0, 0, 0, 0, 1, 1, 1
  End Sub

  ' Custom method for TNA to work around coop mode stuttering
  Public Sub ForceAsynch(enabled)
    if bEnabled=False then Exit Sub
    if bSessionActive=True then Exit Sub 'Sessions should always control asynch when active
    bRunAsynch=enabled
  End Sub

  Public Sub StopSession(P1Score, P2Score, P3Score, P4Score, NumberPlayers)
    StopSession2 P1Score, P2Score, P3Score, P4Score, NumberPlayers, False
  End Sub

  Public Sub StopSession2(P1Score, P2Score, P3Score, P4Score, NumberPlayers, bCancel)
    Dim i
    dim objFile
    if bEnabled=False then Exit Sub
    bRunAsynch=False 'Asynch might have been forced on in TNA to prevent coop mode stutter
    if bSessionActive=False then Exit Sub
debug4 "Scorbit Stop Session"

    bActive="false"
    SendUpdate P1Score, P2Score, P3Score, P4Score, -1, -1, NumberPlayers
    bSessionActive=False
'   SendHeartbeat

    if bUploadLog and LogIdx<>0 and bCancel=False then
      debug4 "Creating Scorbit Log: Size" & LogIdx
      Scorbit_LOGUpload(0)
      Set objFile = fso.CreateTextFile(puplayer.getroot&"\" & cGameName & "\sGameLog.csv")
      For i = 0 to LogIdx-1
        objFile.Writeline LOGFILE(i)
      Next
      objFile.Close
      LogIdx=0
      Scorbit_LOGUpload(1)
      pvPostFile "https://" & domain & "/api/session_log/", puplayer.getroot&"\" & cGameName & "\sGameLog.csv", False
      Scorbit_LOGUpload(2)
      on error resume next
      fso.DeleteFile(puplayer.getroot&"\" & cGameName & "\sGameLog.csv")
      on error goto 0
    End if

  End Sub

  Public Sub SetGameMode(GameModeStr)
    GameModeOrig=GameModeStr
    GameMode=GameModeStr
    GameMode=Replace(GameMode, ":", "%3a")
    GameMode=Replace(GameMode, ";", "%3b")
    GameMode=Replace(GameMode, " ", "%20")
    GameMode=Replace(GameMode, "{", "%7B")
    GameMode=Replace(GameMode, "}", "%7D")
  End sub

  Public Sub SendUpdate(P1Score, P2Score, P3Score, P4Score, CurrentBall, CurrentPlayer, NumberPlayers)
    SendUpdateAsynch P1Score, P2Score, P3Score, P4Score, CurrentBall, CurrentPlayer, NumberPlayers, bRunAsynch
  End Sub

  Public Sub SendUpdateAsynch(P1Score, P2Score, P3Score, P4Score, CurrentBall, CurrentPlayer, NumberPlayers, bAsynch)
    dim i
    Dim PostData
    Dim resultStr
    dim LogScores(4)

    if bUploadLog then
      if NumberPlayers>=1 then LogScores(0)=P1Score
      if NumberPlayers>=2 then LogScores(1)=P2Score
      if NumberPlayers>=3 then LogScores(2)=P3Score
      if NumberPlayers>=4 then LogScores(3)=P4Score
      LOGFILE(LogIdx)=DateDiff("S", "1/1/1970", Now()) & "," & LogScores(0) & "," & LogScores(1) & "," & LogScores(2) & "," & LogScores(3) & ",,," &  CurrentPlayer & "," & CurrentBall & ",""" & GameModeOrig & """"
      LogIdx=LogIdx+1
    End if

    if bSessionActive=False then Exit Sub
    if bEnabled=False then Exit Sub
    if bWaitResp then exit sub ' Drop message until we get our next response

'   msgbox "currentplayer: " & CurrentPlayer
    SaveCurrentPlayer=CurrentPlayer
'   PostData = "session_uuid=" & SessionUUID & "&session_time=" & DateDiff("S", "1/1/1970", Now()) & _
'         "&session_sequence=" & SessionSeq & "&active=" & bActive
    PostData = "session_uuid=" & SessionUUID & "&session_time=" & GameTime-SessionTimeStart+1 & _
          "&session_sequence=" & SessionSeq & "&active=" & bActive

    SessionSeq=SessionSeq+1
    if NumberPlayers > 0 then
      for i = 0 to NumberPlayers-1
        PostData = PostData & "&current_p" & i+1 & "_score="
        if i <= NumberPlayers-1 then
          if i = 0 then PostData = PostData & P1Score
          if i = 1 then PostData = PostData & P2Score
          if i = 2 then PostData = PostData & P3Score
          if i = 3 then PostData = PostData & P4Score
        else
          PostData = PostData & "-1"
        End if
      Next

      PostData = PostData & "&current_ball=" & CurrentBall & "&current_player=" & CurrentPlayer
      if GameMode<>"" then PostData=PostData & "&game_modes=" & GameMode
    End if
    resultStr = PostMsg("https://" & domain, "/api/entry/", PostData, bAsynch)
    'if resultStr<>"" then debug3 "SendUpdate Resp:" & resultStr          'rtp12
  End Sub

' PRIVATE BELOW
  Private Function LPad(StringToPad, Length, CharacterToPad)
    Dim x : x = 0
    If Length > Len(StringToPad) Then x = Length - len(StringToPad)
    LPad = String(x, CharacterToPad) & StringToPad
  End Function

  Private Function GUID()
    Dim TypeLib
    Set TypeLib = CreateObject("Scriptlet.TypeLib")
    GUID = Mid(TypeLib.Guid, 2, 36)

'   Set wsh = CreateObject("WScript.Shell")
'   Set fso = CreateObject("Scripting.FileSystemObject")
'
'   dim rc
'   dim result
'   dim objFileToRead
'   Dim sessionID:sessionID=puplayer.getroot&"\" & cGameName & "\sessionID.txt"
'
'   on error resume next
'   fso.DeleteFile(sessionID)
'   On error goto 0
'
'   rc = wsh.Run("powershell -Command ""(New-Guid).Guid"" | out-file -encoding ascii " & sessionID, 0, True)
'   if FileExists(sessionID) and rc=0 then
'     Set objFileToRead = fso.OpenTextFile(sessionID,1)
'     result = objFileToRead.ReadLine()
'     objFileToRead.Close
'     GUID=result
'   else
'     MsgBox "Cant Create SessionUUID through powershell. Disabling Scorbit"
'     bEnabled=False
'   End if

  End Function

  Private Function GetJSONValue(JSONStr, key)
    dim i
    Dim tmpStrs,tmpStrs2
    if Instr(1, JSONStr, key)<>0 then
      tmpStrs=split(JSONStr,",")
      for i = 0 to ubound(tmpStrs)
        if instr(1, tmpStrs(i), key)<>0 then
          tmpStrs2=split(tmpStrs(i),":")
          GetJSONValue=tmpStrs2(1)
          exit for
        End if
      Next
    End if
  End Function

  Private Sub SendHeartbeat()
    Dim resultStr
    if bEnabled=False then Exit Sub
    resultStr = GetMsgHdr("https://" & domain, "/api/heartbeat/", "Authorization", "SToken " & sToken)

    'Customized for TNA
    If bRunAsynch = False Then
      debug4 "Heartbeat Resp:" & resultStr
      HandleHeartbeatResp ResultStr
    End If
  End Sub

  'TNA custom method
  Private Sub HandleHeartbeatResp(resultStr)
    dim TmpStr
    Dim Command
    Dim rc
    'Dim QRFile:QRFile=puplayer.getroot&"\" & cGameName & "\" & dirQrCode
    Dim QRFile:QRFile=puplayer.getroot & cGameName & "\" & dirQrCode

    If VenueMachineID="" then
      If resultStr<>"" And Not InStr(resultStr, """machine_id"":" & machineID)=0 Then 'We Paired
        bNeedsPairing=False
        'debug3 "Scorbit: Paired"
        Scorbit_Paired()
      ElseIf resultStr<>"" And Not InStr(resultStr, """unpaired"":true")=0 Then 'We Did not Pair
        bNeedsPairing=True
      Else
        ' Error (or not a heartbeat); do nothing
      End If

      TmpStr=GetJSONValue(resultStr, "venuemachine_id")
      if TmpStr<>"" then
        VenueMachineID=TmpStr
'debug3 "VenueMachineID=" & VenueMachineID
        'Command = """" & puplayer.getroot&"\" & cGameName & "\sQRCode.exe"" " & VenueMachineID & " " & opdbID & " """ & QRFile & """"
        Command = """" & puplayer.getroot & cGameName & "\sQRCode.exe"" " & VenueMachineID & " " & opdbID & " """ & QRFile & """"
        rc = wsh.Run(Command, 0, False)
      End if
    End if
  End Sub

  Private Function getStoken()
    Dim result
    Dim results
'   dim wsh
    Dim tmpUUID:tmpUUID="adc12b19a3504453a7414e722f58736b"
    Dim tmpVendor:tmpVendor="vscorbitron"
    Dim tmpSerial:tmpSerial="999990104"
    'Dim QRFile:QRFile=puplayer.getroot&"\" & cGameName & "\" & dirQrCode
    Dim QRFile:QRFile=puplayer.getroot & cGameName & "\" & dirQrCode
    'Dim sTokenFile:sTokenFile=puplayer.getroot&"\" & cGameName & "\sToken.dat"
    Dim sTokenFile:sTokenFile=puplayer.getroot & cGameName & "\sToken.dat"

    ' Set everything up
    tmpUUID=MyUUID
    tmpVendor="vpin"
    tmpSerial=Serial

    on error resume next
    fso.DeleteFile(sTokenFile)
    On error goto 0

    ' get sToken and generate QRCode
'   Set wsh = CreateObject("WScript.Shell")
    Dim waitOnReturn: waitOnReturn = True
    Dim windowStyle: windowStyle = 0
    Dim Command
    Dim rc
    Dim objFileToRead

    'Command = """" & puplayer.getroot&"\" & cGameName & "\sToken.exe"" " & tmpUUID & " " & tmpVendor & " " &  tmpSerial & " " & MachineID & " """ & QRFile & """ """ & sTokenFile & """ " & domain
    Command = """" & puplayer.getroot & cGameName & "\sToken.exe"" " & tmpUUID & " " & tmpVendor & " " &  tmpSerial & " " & MachineID & " """ & QRFile & """ """ & sTokenFile & """ " & domain
debug4 "RUNNING Command:" & Command
    rc = wsh.Run(Command, windowStyle, waitOnReturn)
debug4 "Return:" & rc
    if FileExists(puplayer.getroot&"\" & cGameName & "\sToken.dat") and rc=0 then
      Set objFileToRead = fso.OpenTextFile(puplayer.getroot&"\" & cGameName & "\sToken.dat",1)
      result = objFileToRead.ReadLine()
      objFileToRead.Close
      Set objFileToRead = Nothing
'debug3 result

      if Instr(1, result, "Invalid timestamp")<> 0 then
        MsgBox "Scorbit Timestamp Error: Please make sure the time on your system is exact"
        getStoken=False
      elseif Instr(1, result, ":")<>0 then
        results=split(result, ":")
        sToken=results(1)
        sToken=mid(sToken, 3, len(sToken)-4)
debug4 "Got TOKEN:" & sToken
        getStoken=True
      Else
debug4 "ERROR:" & result
        getStoken=False
      End if
    else
debug4 "ERROR No File:" & rc
    End if

  End Function

  private Function FileExists(FilePath)
    If fso.FileExists(FilePath) Then
      FileExists=CBool(1)
    Else
      FileExists=CBool(0)
    End If
  End Function

  Private Function GetMsg(URLBase, endpoint)
    GetMsg = GetMsgHdr(URLBase, endpoint, "", "")
  End Function

  Private Function GetMsgHdr(URLBase, endpoint, Hdr1, Hdr1Val)
    Dim Url
    Url = URLBase + endpoint & "?session_active=" & bActive
'debug4 "Url:" & Url  & "  Async=" & bRunAsynch
    objXmlHttpMain.open "GET", Url, bRunAsynch
'   objXmlHttpMain.setRequestHeader "Content-Type", "text/xml"
    objXmlHttpMain.setRequestHeader "Cache-Control", "no-cache"
    if Hdr1<> "" then objXmlHttpMain.setRequestHeader Hdr1, Hdr1Val

'   on error resume next
      err.clear
      objXmlHttpMain.send ""
      if err.number=-2147012867 then
        MsgBox "Multiplayer Server is down (" & err.number & ") " & Err.Description
        bEnabled=False
      elseif err.number <> 0 then
        debug3 "Server error: (" & err.number & ") " & Err.Description
      End if
      if bRunAsynch=False then
debug4 "Status: " & objXmlHttpMain.status
        If objXmlHttpMain.status = 200 Then
          GetMsgHdr = objXmlHttpMain.responseText
        Else
          GetMsgHdr=""
        End if
      Else
        bWaitResp=True
        GetMsgHdr=""
      End if
'   On error goto 0

  End Function

  Private Function PostMsg(URLBase, endpoint, PostData, bAsynch)
    Dim Url

    Url = URLBase + endpoint
'debug4 "PostMSg:" & Url & " " & PostData     'rtp12

    objXmlHttpMain.open "POST",Url, bAsynch
    objXmlHttpMain.setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
    objXmlHttpMain.setRequestHeader "Content-Length", Len(PostData)
    objXmlHttpMain.setRequestHeader "Cache-Control", "no-cache"
    objXmlHttpMain.setRequestHeader "Authorization", "SToken " & sToken
    if bAsynch then bWaitResp=True

    on error resume next
      objXmlHttpMain.send PostData
      if err.number=-2147012867 then
        MsgBox "Multiplayer Server is down (" & err.number & ") " & Err.Description
        bEnabled=False
      elseif err.number <> 0 then
        'debug3 "Multiplayer Server error (" & err.number & ") " & Err.Description
      End if
      If objXmlHttpMain.status = 200 Then
        PostMsg = objXmlHttpMain.responseText
      else
        PostMsg="ERROR: " & objXmlHttpMain.status & " >" & objXmlHttpMain.responseText & "<"
      End if
    On error goto 0
  End Function

  Private Function pvPostFile(sUrl, sFileName, bAsync)
'debug4 "Posting File " & sUrl & " " & sFileName & " " & bAsync & " File:" & Mid(sFileName, InStrRev(sFileName, "\") + 1)
    Dim STR_BOUNDARY:STR_BOUNDARY  = GUID()
    Dim nFile
    Dim baBuffer()
    Dim sPostData
    Dim Response

    '--- read file
    Set nFile = fso.GetFile(sFileName)
    With nFile.OpenAsTextStream()
      sPostData = .Read(nFile.Size)
      .Close
    End With
'   fso.Open sFileName For Binary Access Read As nFile
'   If LOF(nFile) > 0 Then
'     ReDim baBuffer(0 To LOF(nFile) - 1) As Byte
'     Get nFile, , baBuffer
'     sPostData = StrConv(baBuffer, vbUnicode)
'   End If
'   Close nFile

    '--- prepare body
    sPostData = "--" & STR_BOUNDARY & vbCrLf & _
      "Content-Disposition: form-data; name=""uuid""" & vbCrLf & vbCrLf & _
      SessionUUID & vbcrlf & _
      "--" & STR_BOUNDARY & vbCrLf & _
      "Content-Disposition: form-data; name=""log_file""; filename=""" & SessionUUID & ".csv""" & vbCrLf & _
      "Content-Type: application/octet-stream" & vbCrLf & vbCrLf & _
      sPostData & vbCrLf & _
      "--" & STR_BOUNDARY & "--"

'debug3 "POSTDATA: " & sPostData & vbcrlf

    '--- post
    With objXmlHttpMain
      .Open "POST", sUrl, bAsync
      .SetRequestHeader "Content-Type", "multipart/form-data; boundary=" & STR_BOUNDARY
      .SetRequestHeader "Authorization", "SToken " & sToken
      .Send sPostData ' pvToByteArray(sPostData)
      If Not bAsync Then
        Response= .ResponseText
        pvPostFile = Response
debug4 "Upload Response: " & Response
      End If
    End With

  End Function

  Private Function pvToByteArray(sText)
    pvToByteArray = StrConv(sText, 128)   ' vbFromUnicode
  End Function

End Class
'  END SCORBIT
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
Sub DelayQRClaim_Timer()
  if bOnTheFirstBall AND bBallInPlungerLane then ScorbitClaimQR(True)
  DelayQRClaim.Enabled=False
End Sub


Sub dungeonautoselect_Timer()
  If bDungeonSelectMode Then
    HideHelper
    if Mode(CurrentPlayer,DungeonVidIndex*2) <> 3 Then 'make sure dungeon is not completed yet
      bDungeonSelectMode = False
      bInDungeonSelection = False
      StartMode DungeonVidIndex*2
    Else
      ' Display a message that dungeon is already closed
      GeneralPupQueue.Add "UpdateHelperMessage","UpdateHelperMessage ""Dungeon Already Completed"" ",6,0,0,0,0,False
      if DMDType = 0 Then
        GeneralPupQueue.Add "DisplayDSHelper","DisplayDSHelper",5,100,0,0,0,False
      Else
        GeneralPupQueue.Add "DisplayHelper","DisplayHelper",5,100,0,0,0,False
      End If
    End If
  End If
  dungeonautoselect.Enabled  = False
End Sub
'=================================================================================================================================
' *******                VERSION CONTROL               *************************
'=================================================================================================================================
'version history
'2.2p moved case 9 pandorak to scoop2 exit
'2.2j inn arrow off, added bdungeonscleared flag to return to mode 9 once all dungeons cleared, changed endofballcomplete activemode-15 to end game
'2.2h changed endofballcomplete code to return to wizardlock mode
'2.2f added code for 2 screen pup
'2.2a replaced activemode calls with Mode(CurrentPlayer,0), changed code in EnterHighScoreKey from = 3 to > 2
'2.2 Increased MaxPasses from 10 to 20, added check party size to playerattack routine, exit if less than 1, fixed extraballGIF
'1.2RC16 Added Inn BG image, moved calls for Inn audio
'1.2RC15 changed boss BG video callouts, added battlequeue and removal methods for attributes
'1.2RC12 Added Inn effects audio, callouts, lighting, added bleed lighting
'1.2RC9 Changed in the dark audio callouts
'1.2RC8 updated inthedark to use sequence lighting, checks for wins, fixed dmdicon overlay from turning off
'1.2RC7 Fixed restoremonsterimages for cove,weald,warrens, added sounds to EOB sequence, added flashing dungeon during selection
'1.2RC5 Added some check for inn or village, fixed continue mode, fixed resetnewball lights
'1.2 Createed apply attribute timers
'1.1 Added resetlanelights to all side missions,  added bSupressBGMEssages flag to all side missions
' Fixed Bonus Multiplier, changed values of top swath of table1 visuals, swapped flaming ball for deefault with ruins silver
' Added overlayicons to tunr on when side missions completed, changed side missions to use step 2 when completed.
' Tweaked magnet position from 456.1 to 455.5 to improve accuracy. Added check in createnewball to make sure nothing is in plungerlane
' Added highscore display, added highscore queue management, added default custom ball
'1.0 Release
'RC19 Fixed UPF lights,
'RC18 Fixed scorbit reporting
'RC17 Fixed monster defeated bonus values from resetting
'RC14 Updated Rulecard images
'RC13 Added pupevent 400 to scorbit pairing screen, added function forceselection to prevent out of stack space crashes
'RC12b Added sounds to UPF targets
'RC12 scorbit fix to prevent claimQR from populating multiple times, changed how full party is handled after boss battle
'RC10 scorbit QR code location changes
'RC9 Removed setaprondarkness, removed enableblending, added pupevent 300 to inthedark routine
'RC8 Added extra call to make sure Claim QR goes away during gameplay
'RC7 Game does not automatically restart on replay, requires startcreditkey
'RC6 Fixed Scorbit, will not allow sessions for continued games, will autorestart on new games
'RC5 Fixed Return to Inn Mechanism
'RC4 Fixed scorbit hang, Fixed UPF bloom, Added calls to reset GI between modes, Fixed continuing progress audio calls, adjust last enemy audio callouts for all bumper modes
' Fixed destroy ambush from firing during Vvulf battle, Fixed overlay bleed on destroyambush video as well as volume
'RC3 Moved version control to bottom of script, Fixed Wizard mode prep, Moved scorbit.stopsession call to after claiming rewards
'RC2 added playerimagereset calls to queue mgnt, updated ballsaver calls- added EOBreturn to queue mgnt, overlay wasnt coming back
'RC1 Changes to Gi near top of playfield, remoed dev code, fixed kickbackactive/extrball GIfs and resets
'148.5 Made sure scoops only exit for side missions, prevent trapdoor for locking balls during side missions
'148.4 Fixed Cove battle monster light 06 to turn RED-ON was off, added code to scoop1_hit for full party
'148.3 Added walls to prevent Cor.ballvelx crash
'148.1 Modified inthedarkfail and wininthedark routines
'148.0 Changed continuemode for full party responses. changed scoop2_hit for case 0
'147.9 Remove holdball =1 call from winwarrens, added ClearPupMessages to all scoop_hit routines -- help clear up any lingering pup messages
'147.8 Fixed pickdungeon logic
'147.7 Added returntovillage call to VillageDecision fork
'147.6 Removed stopmode from resetmodes, added resetwulf to case 12 of resetmode, change pickdungeon to find first incomplete dungeon
'147.4 Fixed Vvulf modefail scenarios, proeprly resets targets, fixed attract video, removed startDT call in weald dungeon
'147.2 Updated some ball images, tweaked bleed images
'147.1 Fixed mode 6/14 orbit hits adding party members, added stopmode call to resetmodes, supressed ambush defeat videos in that mode, added dungeon auto select timer
'146.9 Scorbit Mode Updates
'146.4 Added two backglights gi054&gi055
'146.3 Added Reset highscore method, the EYEBALL is back, adjusted size of both 3d creatures and turned on lighting for them, added newUPF lighting
'146.2 Added new destroy ambush video and call
'146.1 Added 3 audio callouts for side missions event starts, changed full orbit timer to 3000 ms
'145.7 Fixed Houndmaster critical randomization - before once he triggered he made all future attacks
'145.6 Added - Flasher lights to swine prince battle, added new dungeonBG calls and Pup events - allows same BG to be called each time.
'145.5 Added - Deathblow videos and calls
'145.3 Remvoed a bunch of old variabels
'144.7 Fixed overlay Inn/Village selection, fixed magnet not holding onto ball, fixed Dungeon BG battle images
'144.5 Fixed Dungeon DMD BG calls
'144.4 Added ResetPlayerImages call to all dungeons
'144.3 enlarged tramp from 30 to 40
'144.2 return player with advancemode instrad of continue mode,
'144.1 Added fixes: HideDDM for event 790, added to prevent new dungeon until previous is completed, fix for displayoverlay
'143.9 Updated Rulecard images
'143.8 Changed dungeon selection to use both flippers
'143.7 Added reset to bHoldBall after flipper hits
'143.6 Additional GI lighting for battles, added bumper lights for hits,
'143.5 adding messaging for battles
'143.4 Replaced selectdungeon calls with PickDungeon
'143.3 Updated PuP and table code to use new dungeon selection mechanism, fixed inn/village
'142.9 Added machanics for dungeon selection, added call for dungeon BG before pup display battle, added clear out to center scoop in all assembel parties
' Added code to tunr of magnet GIF on release
'142.1 Finished Light Sequence Queing, Finished EOB Sequence Queing, Started Genreal Pup & Audio Queing
'142.0 Added Queue Management System
'140.9 Fixed UPF lights flashing outside of modes
'140.8 Added some points to inn scoop once maxed out, changed staged flipper code
'140.7 Converted vpmtimer to triggerscript calls, increased queue length to 50
'140.5 fixed updatedmd call in EOB routine, fixed flippers when magnet was locked
'140.4 Fixed overlap writing off Inn/Village select screen
'140.3 Added ball hold for first pass of assemble party
'140.2 Fixes to continue mode flow
'140.1 Changed continue mode routine, fixed stop prophet call, changed end of game sequence
'139.7 Reset village music after defeating bosses, added returnoverlay calls back to resetfornewplayerball and EOBreturn -- BG overlay was missing alot of the time
' removed killpupmonster calls from drownedcrew, fixed clearblacksmith,changed continue mode routine
'139.6 Added UPF ramps, Added EOBREturn to end of ball, added dmd clear calls to displayslection and swplunger unrest
'139.4 Moved Dead GIFs, changed EOB video to timed version, moved Blood GIFs to match player positions
'139.3 Finished Blacksmith messaging changes
'139.2 Modified Blacksmith routines
'139.1 Added pupevent 900 calls to removepartymember routine, removed bRetry=false from removepartymember
' removed 5 second delay from all DisplayContinueMessage in routine
'138.0 removed pupevent 960 from sub pupevent case logic, redid start dungeon and party modes
'137.9 moved Battle GIF images back to original positions, some changes sto continuemode and startmodes
'137.8 Fixed UPF stuck right flipper, DOF config tweaks
'137.7 Changed modetitle for wizard mode lock, tied lower flashers to sling events, made apron blockers collidable, adjusted hidedmd for ball saver
'137.6 Added jackpot video,moved jackpot screens, removed back audio call for wintorch, adjusted torch light shapes, added torch levels, removed torch flickering
'137.5 Added some DOF calls for end of ball
'137.4 Change blacksmith mode to quit on first fail
'137.3 Fixed EOB screen hang, fixed attractlightseqstop, fixed gravedead image, fixed ballsaver on selection, added 3d model for chest
'136.9 DOF Config - DarrinVPCLE
'136.8 Merged codesets
'136.7 VR Magna buttons added.
'136.6 Added code to disable the UPF at certain times
'136.5 Added DOFModeOff routine
'136.4 Added Attract mode subs
'136.2 Made AutoMagnet a varriable , Fixed bBallinPlungerLane behavior, restricted game restarts until game is over, limited rulecards from coming up unless a ball is in the plungerlane
'135.9 Magnet mechanims updated to allow for use without magna save buttons
'134.6 Moved magnet back, changed madness to 8 second, added flipperbounce variable
'133.9 Fixed wanted image , supress dmdupdate during selection screen
'133.8 Fixed DrownedCrew Battle, Added SlimDMD new Pup overlays, added two new images to pup overlay
'133.6 Added pupevents for new callouts (placeholders for now)
'133.5 Added code to check for missing PinUp
'133.4 DOF Added by DarrinVPCLE
'133.3 Fixed pnganimate "extraball"
'133.2 Added VR Cathedral Room as well as VRRoomChoice script option
'133.0 fixed msgbox command in additem, fixed pupdisplaybattle applygrave
'132.9 added SlowFlashTime variable for gamble/inthedark modes
'132.8 changed scoreupdate code, fixed loadEM and table1_exit issues
'132.7 changes to controller code
'132.6 re-sync'd code with VR code from TastyWasps
'132.5 Added error handling, fixed rramp/lramp hidedmd error should have been stopdmdflashlabel calls
'132.4 tweak updateall
'132.3 Tweaked pnote, fixed hideDMD routines
'132.2 Fixed Pup guides, fixed magnet overlay and messaging
'132.1 Fixed overlay icons and messaging
'132.0 Converted table to new overlays
'131.5 modified heartbeat routine, added pulse routine. changed timing for udngeon music to start earlier, changed final score dmd to red
'131.4 fixed chasewulf targets
'131.3 supressed pup events during EOB sequence
'131.2 began cleaning up unused variables
'131.1 moved ballsave to BG for slimDMD, fixed bonusmessage clearouts, fixed inthedark bug
'131.0 EOB sequence tidied up for FullDMD
'130.9 EOB sequence tidied up for SlimDMD
'130.8 changing how EOB messaging delays and ball kickout work, added check code for chase wulf to prevent occultist attribute from firing
'130.7 tweak to item usage, changed how UPF mode target hits worked.
'130.6 Stop hero timer during item usage delay, fixed inthedark breaking inn scoop
'130.5 Fixed ball hold for items, modified flipper elasticity, modifided how EOB bonus is displayed.
'130.4 Tastywasps VR DMD Speaker grills replaced and VR backbox art updated.
'130.3 Tastywasps VR Room and VR Cabinet added with VR script logic
'129.6 Fixed a bunch of small bugs, mainly gameover, and restart of dungeons
'128.2 began cleaning up unused variables, added herohealth constant
'128.1 Loaded Vvulf/Shambler Attack Video calls & Pup
'128.0 Renamed all the charachterDead files to match case
'127.9 Routines cleaned up, set pagelayout and conditionals for DMDType
'127.8 Tweaked Blacksmith mode
'127.7 Added Clear modes to each of the side missions
'127.6 Finished Blacksmith Mission Pup & Scripting
'127.5 Finished InTheDark Mode Mission Pup & Scripting
'127.4 Finished Gamble Mode Mission Pup & Scripting
'127.3 Cleaned up extra commented code, began cleaning up gamblemode, inthedark mode needs LED in UPF fixed. Blacksmith mode -- unknown
'127.1 moved a bunch of voice over audio from vpx to pup, moved autoflipper location
'126.9 added multiball code to fire ball if sitting in plungerlane, fixed drowned crew GIF
' call pupdisplaybattle after grave attribute, started to tweak pupevnet battle redisplay timings 824 first.
'126.8 Fixed LUTs after cove battle,
'126.7 fixed game breaking bug introduced in 126.3
'126.6 fixed dmd supression, fixed lock lite, tweaked ball lost video timing, added return overlay to some routines (dungeon starts)
'126.5 added audio callouts extraball/multiball, changed gi052 loads in checktorches, added dealy to showbleed
'126.3 Split up magnet and locked messaging. Magnet comes on when magnet activated, locked only comes on when ball is caputred on magnet.
'126.2 added rereflections to UPF targets, fixed UPF mappings to LEDs, reduced flipper elasticity from .88 to .5 (lower flippers only)
'126.1 adjusted pupevent 333 calls - audio stop, made darknessspeed a constant, removed li61-64 from aLights collection to stop flickering
' fixed mapping of UPF targets to LEDs in modes 8 & 11
'126.0 Revieweed Clearing events for all screen types, added UPF target image changes based off LED lights
'125.9 Changed Targets006-9 image
'125.8 swapped pupevent 923 & 924
'125.7 edited EOBHide routine -- moved pupevnet 900 outside of if dmdtye <> 2
'125.6 tweaked EOB hide/return messages
'125.1 added leftorbit cheese prevention, tweaking continue game routines
'125.0 new Upperpf inserts lights droptargets, new lights under rightramp ( should be copy past on left + upper ramp left one need mby different walls under it ?
'124.6 Fixed Boba target materials on 1,2,3 , fixed right orbit cheese properly, fixed weald mission
'124.3 nothing yet
'124.2 Added full screen deaths for vvulf/swine prince
'124.1 Drowned Crew Fixed could not be killed, changed phophet/drowncrew defaeats to full screen, moved darkness layer height to 10
'124.0 Added ramp for UPF Oqqsan -
' tweaked full orbit checks, added some cleardungeonpup2 calls to make sure it clears, changed mnonster kill videos and pup
'123.8 removed all the extra unneeded code for HideDMD/Supress DMD
'123.7 changed PUP to fix Z ordering issues with DMD videos & DMD Info
'123.6 fixed some of the dungeonclearing DMD Guide issues, made dungeon order randomization selectable
'123.5 Oqqsan added second ramp, fixed houndcritical calls
'123.2 fixed swine prince dungeon progress, moved center post between orbits
'123.1 Added new Ramp & Lighting Oqqsan, changed tilt routine to match BG instead of DMD
'123.0 Converted Dungeons to random order
'122.9 Added Grave & Hound attribute pupevents
'122.8 adjusting darkness layer height and Y coordinate
'122.7 Modified script for new pup events to hide DMD and redisplay for all DMD screens, hid extra 2 3d inserts on side of table (will remove later)
'122.6 renamed pup events XX to 8XX, 1XX to 9XX  - this is to try to avoid conflicts with DOF events
'122.3 Fixed ChaseWulf Lights, Added right orbit supression
'122.1 Added wizard mode prep messages
'122.1 improved orbit hit checking
'122.0 fixed restore monsters light routine
'121.9 Changed BOB Standup tagets to nFozzy material, added extraball event 50 to battlehide set, changed audio clear to 100ms file,
'tweaked drowned crew routine boss video & guide, changed darkneslayer 2 to overlap by 2 vpx units
'121.8 Fixed EOB Full DMD
'120.5 Fixed DMD update calls, autoflip timer and logic to prevent autoflip with multiple balls on the table
'120.4 tweaked some audio callouts, fixed lock light from flashing when it shouldnt
'120.3 Added apron blockers - trying to keep ball from jumping off table
'120.1 changed flipper material to be consisten
'120.3 Added apron blockers - trying to keep ball from jumping off table
'120.1 changed flipper material to be consistent transparent orange
'120.0 Added all new music callouts
'119.7 converted all backglass WAV to MP3, added DMD update supression wehn videos are playing (5 seconds), bleed icon is dynamic now
'119.6 Added high score audio, added grave/hound attack videos, fixed end of game sequence, moved high score entry to DMD
'119.3 fixed houndcritical, fixed attribute/ambush from firing outside of battles, changes 3d insert lane colors, fixed audio for dungeon completions
'118.9 Normalized backglass audio in vpx, fixed bleed positions for battle GIFs -- Normalized ALL PuP mp3/mp4s
'118.8 Fixed Player/Monster Animated Battle GIF positions and speed using new beta routine -- Slim DMD
'118.7 Fixed Player/Monster Animated Battle GIF positions and speed using new beta routine  -- Full DMD
'118.6 Optimized audio/video of dungeon start sequences, removed item GIFs, removed caching of heartbeat
' 118.5 Began Optimization and cleanup of PUP and PupDMD : Fixed Inn/Village Decision logic
' removed underscore from medicineadded as well as BG overlay for icons and items not reappearing after lost ball
'117.6 added code to check if ball is trapped on magnet, added pup message on BG for magnet locked
'117.5 added checkitemcolor and checkiconcolor on resetfornewplayerball, fixed blacksmith end audio clips pass/fail
'117.4 removed ambushes from boss fights, changed how item GIFs are cleared.
'117.3 added yet another clearing call for all items, UPF lights always flash when hit now. commented out bob lights from gametimer to prevent them from blinking
'117.2 Merlin - removed reflection on torch lights liup1-5; p054-056,019-020, added dim for lightblending intensity LED_Instensity
' Reset StartDT "y" value to random, adjusted some of the upper flipper values to reduce strength and elasticity -- trying to minimize the bounce and improve control
'116   oqqsan  added first pair of 3dinserts and adjusted the light on li002 + level update for 3d-oninsert added to gametimer
'111.6 Changed monster GIFS to remove caching, used new routines to pick monsters , replaced findalivechar routine --  was using recursion
'110.7 Changed bDecision placement
'110.1 Added some new code for dungeon monster loading
'109.1 Removed Bumper Multiball, changed default song volume back to 1
'108.6 Stopped updating the logs
'102.8 updated the new monster GIFs and routines, added 2 new characters
'98.4 moved bob target on far Right
'98.3 changed how ball locking works via the trapdoor
'97.7 Joe Picaso added new ramps with ropes and posts
'97.4 converted wizard mode to mode 14 & 15, added shambler boss battle, added dynamic dmdtype mapping to pup bat files
'96.7 added automagnetflipper to make it easier to enter upper playfield
'96.6 added ballglow routines back in to modefail and modeend
'96.2 Converted to new darkness effects using darknesslayer object
'93.7 updated to remove debug logging
'93.6 tweaked crypt pup events
'93.5 added crypt side mission
'93.4 Made CBall Hits a Mode, added new EOB timers and pupevents
'93.3 removed multiball lockout
'93.2 added wall66up for swineprince,
'93.0 Added ambush pupevents, began to add 2 screen pupevent and dmd mappings
'92.9 fixed prophet battle monster count, changed EOB overlay reset timing from 3750 to 4000
'92.8 added propeht battle pup
'92.7 easy mode torch timer set to 175, added dungeon cleared pupevents
'92.6 added hidekeyaward routine, added backup call. , added 1 way gate behind scoop2
'92.5 fixed wall 034 texture map
'92.4 Added TILT debug message
'92.3 Changed DungeonProgress to limit monster defeats, adjusted keyaward to value of 5-100k added pupdmd screen to BG, changed dungeonmusicvoolume to .01 from .007
'92.2 Changed MutedSongVolume to DungeonMusicVolume
'92.1 Fixed DMD Text messages
'92.0 Added TorchLevel timer, attempt to fix DMD text updates to occur when they should and hide when they should
'91.8 disabled most of the debug messages
'91.7 Added Dungeon Cleared pupevents, added mutedsongvolume variable, added inbattle = 0 to checkmonsters to prevent attributes from firing in rare occurences (dungeon cleared but drain before entering middle scoop)
'91.5 Changed music volume during battles, fixed bosses defeated message, tried fixing modefail to include checkitem and icon colors , added final score on BG.
'90.9-D2 Fixed Total Bonus, removed dev strings
'90.8-D2 Addded code to limit 1 Extraball per active ball
'90.7-D2 Fixed dungeonstate for hits above 10 (modes 4,13)
'90.6-D2 Added EOB award bonuses, changed score constant values
'90.5-D2 Modified code to start at second level
'90.5 Added Stage Flipper code from prime5k, added multiball, added clear player images
'90.3 Added check for item count before calling randomchest
'90.2 Added Check for partyrandomlyapplyattributes, removed all heart GIF calls --fixed image issues for hwyman, medicine and shadows of first three characters
'89.7 changed bleed icon size/locations, changed how scoop2 is released, added stopblacksmith and stopgambler to end of ball
'89.2 added line to pandorak_hit routine so kick ball if in battle but not state 1
'88.8 Changed load boss triggerscript to vpmtimer -- attempt to fix loadprophet failing to trigger after ruins completed.
'88.7 Added Preview character feature, use captive ball to change character
'88.6 Prep for preview character
'88.4 fixed occultist, added modestring to dmdtype 2, fixed drowned crew for LUT 15 (blacklight), fixed warrens/weald pup calls
'88.3 BattleID implemented to prevent false attribute applications, added code to use an item in right scoop, also checked to make sure you are in a battle to use items.
'88.0 lowered emmissions scale to 3.6, changed DMDType 2 for default
'87.8 Attempt to fix scoop2_hit for when in battles but state is 1
'87.7 modified pup calls to match character attributes 70-75
'87.6 changed the emmission scale to improve graphics
'87.5 Added ball lock to boss battles, fixed destroyambush, moved upper post on outlanes, fixed boss battles, changed dorwned crew size
'87.4 Removed pnote "party removed", moved scoop2helper up above monsters
'87.3 Changed 15 second delay to on party assembly now call clearing event 310 once party is assembled, fixed missing code in AddPartyMember(Healer)
'87.2 Made Monsters larger, changed GIF routine to use speed as a parameter, adjusted all GIFs, adding a clearing of assemble party screen 15 seconds
'87.1 Attempt to fix Drop Targets
'87.0 fixed GIFs, fixed resetmode calls, adjusted GIF positions and calls
'86.9 added pupcalls for ballsave2, tilt,
'86.8 pup calls for ball saved, tilt, added code for item GIFs
'86.7 Move Bleed images, attempt to fix highwayman labelhide.
'86.6 Re-Added flipper mod, modified scoop2_hit routine, added dungeoncleared routine, removed multiball routines
'86.5 Changed how extraball status lights up, moved kickbackstatus to the left 1, attempt to fix music, stopsong "mu_hyrda" added to endofball routine, changed songvolume from .3 to .7
'86.4 Added call to pupevent 310 before event 42, added inguide message and trigger script, added pupevent 310 to modefail, modeend, added li039 to setpartylgihts
'86.3 fixed pup calls
'86.2 Attempt to fix bug with MB,
'86.1 Added new DMD Guides
'86.0 Converted to PUPDisplay 1.4.6
'85.0 changed how delays work to dungeon mode, created startdungeonbattle routine
'84.9 added hidehelper routine, fixed ballpersgame, moved mode for dmdtype 0
'84.8 Added video callouts for attributes
'84.6 changed torch interval from 160 to 125 ( faster), made changes the countdown messages, attempted to fix gamble mode, added routine clearall
'84.5 attempt to fix game over, tweaks to checkdungeonMB routine
'84.4 Added clear messages for kickback active, added AMState check to pupdisplaybattle, attempt to prevent locking balls in dungeons
'84.2 Removed staged flippers - needs more code
'84.1 Added 2 Screen Only and 4 Screen PUP options
'84.0 fixed drowned crew code, fixed all optional boss message, pupbattle displays, added extraball, multiball, locked ball pupevents
'83.9 Created code for different Pup DMD Types, added staged flipper code from PrimeTime5k, fixed changefontcolor declaration
'83.7 fixed hurtmonster ghoulani call
'83.6 added clearextraball, disablekickback, added checkitem code to turn off equip light, changed puphidebattle to include all GIFs, fixed ball locking in mdoes 11,12,13,14
'83.5 changed triggerscript to vpmtimer for kickoutball routines
'83.4 Added kickback check for applyknight, adjusted messages for kickback, extraball, special
'83.3 Turned applyhwy back on
'83.2 Made heartbeat only animate when in battles, otherwise just an image.changed frequency to 60 for ruins battle, added kickback message check and delay
'83.1 Changed HB sound file, Added SwinePrince Routines, added monster and player attack callouts
'82.9 Fixed some pupevent calls, moved heartbeat to TABLE - front
'82.7 added herocountdown image reset to modend, modefail
'82.6 adjusted modetitle, added modeString to change size for longer labels
'82.5 finished pDMD data, added new routines for optional boss battles
'82.4 Added pDMD data
'82.3 Modified sound volume during dungeon battles
'82.2 Changed DungeonStatus vairable
'82.1 moved char and item icons to new overlay positions, moved debug notes to margins
'82.0 added boss GIfs and changed shambler to prophet for RUINS boss battle, added flipper timing to free up orbit shots while holding balls
'81.9 win modes for optional boss battles
'81.8 Attempt to fix extraball Light009
'81.6 added chase wulf routine
'81.5 Added extra code for bleed displays, changed randomchest code for kickout, modified delays for bleed/hemodefart attack
'81.4 Attempt to fix bleed timer - changed herocountdownoriginal to reset herocountdownmax value
'81.3 Added Bleed images and routines displaybleed and hidebleed, included calls, added TotaltemCount routine fixed bug when randomchest would call with 0 good items
'81.2 added windrownedcrew routine
'81.1 Added load drowned crew, added InBattle flag
'80.0 Changed ZEUS lights, changed shambler hits to require only 4 hits instead of 8
'80.9 fixed extraball award, added right kickback
'80.8 Added dark string code, converted DARK lights to start off and turn on solid once achieved, made left ramp wall invisible
'80.7 added hero timer resets to cove, warren battles, changed quest light activations in many places, added 1000 multiplier for rando variable calculation for applyattributes, fixed weald cleared pup call to 744
'80.6 Fixed lramp flashing, was isnide orbit for shambler battle, changed inn/lock lights to not flash during shambler battle, addtrustpost added to resetnewballvariables routine. change logic for Ambush code
'80.5 fixed modeend,modefail, endofball to use original hero countdown, commented out TurnOffPlayfieldLights in newballreset routine, removed herotimer, added replaceddeadcharsub
'80.4 Added Shambler intro pupeventblee
'80.3 Fixed how bleed was being handled
'80.2 Fixed moster reset if lost to shambler
'80.1 Added monsterscleared = 0 to loadshambler, removed equip and crew light blinks from loadshambler, rmeoved multiball jackpot and super jackpots, attempted to fix trapdoor
'80.0 Fixed trust post images not reloading afte jester, made ramp031 insvisble
'79.8 Check Items and turn off equip once max items reached, added new game reset banner
'79.7 added model
'79.5 Added restore monster images routine, addded cleardungeonpup2 routine, corrected destroy ambush, modified pupevent for calls 741-744, changed scoop2_hit value to 4000 for ruins
'79.4 added 1 more second delay to EOB, added pup calls for win dungeons to region BG no text
'79.3 Adjust dungeonbonus timer config
'79.2 Added kickback light flash
'79.1 Fixed Occultist destroy ambush code
'78.9 Added blinkDark to crusadrer attribute, added timers for dungeon, blacksmith
'78.8 Changed routines to reset dungeon
'77.8 Added code to reset battle gifs appropriately, added vestal to pup pack
'77.4 Shaped walls, shrunk torches from 27 to 25
'77.1 Added itemcount check before adding, moved wall66 lower
'77.0 added gameover pupevent
'76.9 Fixed Clearitems routine and added clearcharicons routine, changed inside orbit to not require full orbit hit
'76.8 Added clearitems to new game reset
'76.7 changed left inside orbit hit to record ROHIT
'76.5 Code to clear dead battle GIFs
'76.5 Code to clear dead battle GIFs
'76.1 Added countdown increment to scoop2_hit mdoes 2,4,6,8
'76.0 changed pup events for dungeon clear and enter
'75.9 changed mulitpleir lights to intesnity 4 from 10, changed killpupchar code to only display if party > 0
'75.8 additem via scoop2_hit, addparty via insideorbit_hit
'75.7 added quest icon and counter
'75.6 Resolved Battle GIF images hiding when other pup videos play
'75.3 Adjusted spinner and ramp icons for top overlay, as well as text, fixed blackmith light sequences
'74.8 Added healr ability to stop bleed, also reduced bleed to 5 seconds off herotime, disbaled hwyman and shovel multiball for now
'74.6 Added check for Mode 0:0 in pupevent hidelables
'74.4 Weald code orbit fix to checkorbits on hits
'74.3 Added dungeon cleared pup events
'73.9 added pupevent place holders for party additions, changed ball lost to event 42
'73.8 Added Fix to check if randomchest is in State 1 to use items
'73.7 Fixed Scoop2 eating ball when in ActiveState 1 for modes 1,3,5,7
'73.5 Added Gamble Mode reset, added 2 sec to countdown for hitting ramps in gamble mode
'73.4 Monster Attack PUP event 720
'73.3 turn off attack lite
'73.2 Added code for player/monster attack pupevents, fixed balldrain error, added herotimer reset to randomchest routine, added check for items in chest to prevent infinite loop, add guide mp4 and pup events.
'72.5 Added call to display pup if party member revived, fix herocountdown reset
'72.4 Added dungeon win countdown cleanup routines
'72.3 added hero timer resets throughout
'72.2 Changed win ruins to use countdown timer
'72.1 changed bumper hits to +4 for testing
'71.1 Added pupevent place holders for char attributes being applied, changed torch interval to 200ms, added randomchest to scoop1 during dungeon battles
'71.0 Fixed HeroCountDownTimer and associated calls, fixed resetlights routine
'70.1 pup additions for items, sidemodes
'69.4 Added generic countdown timer
'66.9 randomized character attribute application
'68.8 added gunshot, fixed bonus multplier lights
'68.6 Added Character Attributes
'68.4 added item grey and color
'68.0 Blacksmith mode working fully including pup dmd, fixed knight clear pup
'67.7 Added icon colorization, moved strings dmd location, modified blacksmith code
'67.0 Created new monsterstring, itemstring and pupdmd displays for them
'66.8 Added Blacksmith timer for chase, fixed full orbit check for "addparty"
'66.6 modified trust post, changed side missions to new array called Missions, Modified Multiball Mode
'66.4 trust post
'66.1 Added torch routines and dungeon dimming
'64.9 Cleaned up Modes 2,4,6,8 routines
'64.6 Changed Spinner Code
'64.5 Changed Weald Chase Mode
'64.3 Blacksmith mode working
'63.8 Added Herotimer
'63.7 Fixed TrapdoorD - made extra objects non-collidable
'63.6 Implemented crazy flippers / madness
'63.5 Added Heart Attack Remove Party Member code
'63.4 Coded new Party variables and updated subroutines accordingly
'61.5 Turned off Zeus Lightning
'61.4 Cleaned up Blacksmith / Gambler Code, Added PupScreens to Apron
'61.3 Replaced all vpmtimer.addtimer calls with triggerscript
'61.2  Completed re-write of Engine/ Modes
'61.1 Removed old code fragments
'61.0 Commented FlexDMD Calls - Removed FlexDMD routines
'60.4 MerlinRTP -- Re-Wrote Engine/Framework
'056.6 H3RBSKI added start of weald mode and began to add end of existing modes
'056.0  oqqsan started 2nd mode ( not done 100% but close ) fixing : might need some stopping changing monsters while covemode running
'055.3  made new flames prim on top, added all torches to react to pf lights
'055.0  Gedankekojote97 - Added Nfozzy and Fleep along with blender lighting
'053.0  oqqsan  - redid the torches, collected stuff in bulks
'052.3  H3RBSKIx- realigned lights for the new pf image
'052.2  oqqsan  - fixed kickback operations and dark targets
'052.0  oqqsan  - redid the dungeon Battle


Sub TrapdoorB_Hit()
    If activeball.vely > 0 then exit Sub
    activeball.vely = activeball.vely / 8
    activeball.velx = activeball.velx / 8
  if activeball.x > Centerpoint then activeball.velx = -1
  if activeball.x < Centerpoint then activeball.velx =  1
  'activeball.velz = -.1
End Sub

Sub MagnetSweep_Timer()
  if ubound(mMagnet.Balls) + 1 < 1 Then
    HideMagnetMessages  ' clear out the messaging
  End If
End Sub

Sub VestalTimer_Timer()
  ApplyHealer OrigVesBID
End Sub

Sub HwyMenTimer_Timer()
  ApplyHwy OrigHwyBID
End Sub

Sub GraveTimer_Timer()
  ApplyGrave OrigGraBID
End Sub

Sub JesterTimer_Timer()
  ApplyJester OrigJesBID
End Sub

Sub PlagueTimer_Timer()
  ApplyPlague OrigPlaBID
End Sub

Sub KnightTimer_Timer()
  ApplyKnight OrigCruBID
End Sub

Dim FireLightValue
Sub FireLightTimer_Timer()
  FireLightValue = int(RndNbr(200))+100
  LightSeqGi.Play SeqBlinking, , FireLightValue, 1
End Sub

Sub LightSeqFlasher_Timer()

End Sub

Sub MultiPlungerTrigger_Hit()
  'Debug5 "Multiplungertrigger hit: " & BallsOnPlayfield
  PlungerIM.AutoFire
End Sub



Sub RDampen_Timer()

End Sub
