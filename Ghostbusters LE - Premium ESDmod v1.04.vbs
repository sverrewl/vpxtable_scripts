'                                                    JB@B@
'                                                 :qEv: .F@
'                                            ;7r7@Bi      Z@
'                                         .M@kuY7          5@1YB@
'                                        GBr                 iuM,
'                                       @N  ..     :    q:0rrr:
'                                      @Z  j5      XB.   @@
'                                     SB   :i.      ..   1@vuLv;:.
'                                    iB    :B@    B@     :B5X0EGGOZNU7,
'                                   rB     .@,    @B     i@J2U2U51FS0ZOES7.
'                                  NB             .      7BJu2uUu2u1u52SkG8N7.
'                                7@5                      @FJjUuUuUuUuUU1U5k8G5:
'                              .B@              .         Y@YLvYYuuUu2u2u2u22FqMXi
'                             j@@            i@BL          k@qkuJvvvYJUuUuUu2u12qOX,
'                           rGM@                            B@B@B@OXJvvjJuuUuUu2uFXMJ
'                          SOu@q                            :B@@@B@B@BZuvLuu2u2uUU5580:
'                        :ZE2uP@            ,@B,            .@SEGMB@B@B@BSvYjUuUu2u22POr
'                       iOP2UuYB0           UB@L            Ei       :PB@B@5LjUuUuUu2UkOL
'                      iOkUUuujJBU           uY            r@           .GB@MuuUu2u2u2UFOJ
'                     :OkuUu2JkB@Bq                       7B              r85uUu2uUu2u2uFO7
'                     ZPUUuu1@Bv  Ou                     :F            .r2uuJUuUu2u2u2u2uSO:
'                    1Z2Uuu8@r                                      :JE8ZS5u2uUu2u2u2u2u2UXE
' 0SjSY;.           :O11u2B@                                     ;188ZS522uUu2u2uUuUuUuUu22ZL
' @O. .70O0r        XP22M@1                                  .vXOZN5522u2uUu2u2uUuUuUu1u2SM@@F2U@B
'  ,2F.   i8@@Y    .0XB@F                                 :JqOEP11U1uUu2u2u2U22F11UuuFNMBMj,    O@
'    v@B.    :EB@u v@Mv                                i1ZO0X25U2uUu2u2u2u51PEOqOM@B@MSi      XZ:
' .5J. ii       ,EB@Bi                             .7PGOqS22U2u2u2uUu2U15qZOXL.   iL.       P@:
'B@r                ..                          :Y0O8XS22u2u2u2uUu2U521qE2r               ,B@O.
' ,ri,L@X,                       .i;         iU88ES522u2u2uUuUu225kGEEB.                  B@E@k:,
'    .Z  .                   ,uM@Bj.     .7S8G055EATSHITDAVEu1UFk8O0v. UZ7Z                r   .iu502
'   M@. r@Mi              :0B@B@B@.   ,YqOZq51U2u2uUu2uUU21SPOZkr.     @k                          UB
'   rX2Jr iE8u@@r    .@,YO@GuF@B@BG.u0O0P11U2u2u2u2uUU11X0MZ1i       iB                   :@@BSu1JJP@
'            :vL0@k   @BZkuuJj@MSuu0Pk22uUuUu2uUu2U15PZMqJ:          @.     :LZ@0::75ZqL   ;M@    .
'                 @@: MNuuUuuYj7LY2u1U2uUu2uUu2U55NGOS7.             G@OOOO0U20jirvBMEGB@5   .M,
'                  :B@8uu2uUuUJuuUu2uUuUuUU22FSE882i                              ,quUuuUMBP: B@
'                   vEUuUuUuUu2uUuUuUuUuUu5kG80J:                                 85UuUu2j5OB,,
'                    GS1uUu2uUuUuUuUuuuuJuU1r.                                   0P1uUu2u21M,
'                    iM52u2u2uUu2u2uuLL7jE,                                     PE1uUuUu22Gj
'                     J812u2u2u2u2uuJ2q@@@@8r                                  NE5U2uUuUU0q
'                      S822uUuUuUuuu@B@B@B@B@B@87.                           :Oq1U2u2uUUNG
'                       kG11U2uUuUujJ8B@B@@u  .LG@BBS7,                     uOS1uUu2u120Z.
'                        2O55UUuUuUujvuM@i         .72ZOM80SUY7           vGZ11uUuUu11Z0.
'                         vMX1u2u2uUuuLuL                  ..:,        .YOZSUUUUu2u1SM2
'                          :GES22u2uUu2j500L:                       .7P8E51uUu2uUUFNOr
'                            YOE11U2uUu2u1FE8G5v:.              ,rUEGGkFU2u2uUu12NOF
'                             .2MqSU1u2uUu2255q0O8ZqX1UJjJUUSXEG8Z0S521u2uUu2U5POX:
'                               .2G8k5U1uUuUu2u2UFFkkNP000qqkX5FU1u2u2u2u2U5FE8k:
'                                  7E8ESFU1u2YesYouDaveFromRetroPlayu22U5FE8Zj,
'                                    :L0O8PX5121U2u2U2uUu2uUu2uUU1251SXGGEui
'                                       .r1q8ZEXk5521u2u2U2u2U11SX0Z8ES7:
'                                             ,irvLYLuYujuJjYjvvri,.
'
'
' Ghostbustern LE - IPDB No. 6334
' Â© Stern 2016
' VPX recreation by ninuzzu,tom tower & djrobx
' Thanks to JPJ, alistaircg and hauntfreaks for playfield reconstruction and cleanup
' Thanks to arngrim for the DOF.
' Thanks to the VPDevTeam for the freaking amazing VPX
' Table runs with VPinSPA.dll, which is based on Jannik Vogel (JayFoxRox)'s research
' 3D inserts, nFozzy physics, VR work by ESD
' New options, VR update by Retro27


Option Explicit
Randomize

'****************************************************************************************
'*                  TABLE OPTIONS                       *
'****************************************************************************************

'** VolumeDial **
' VolumeDial is the actual global volume multiplier for the mechanical sounds.
' Values smaller than 1 will decrease mechanical sounds volume.
' Recommended values should be no greater than 1.
Const VolumeDial = 0.8

'** Enable GlowBall **
Const CustomBall= 0       '0 - Disable Glow Ball, 1 - Enables Green Glow Ball, 2 - Enables Blue Glow Ball, 3 - Enables Pink Glow Ball

'** Insert Brightness **
Const gInsertBrightness = 0.7


'****************************************************************************************
'*                    VR OPTIONS                        *
'****************************************************************************************

'** VR Test Mode **
Const VRTEST = 0

'****************************************************************************************
'*                  END OPTIONS                     *
'****************************************************************************************

'****************************************************************************************
'* GB TABLE AND ROM OPTIONS   - Don't touch this :)                 *
'****************************************************************************************

Const BallSize = 50
Const BallMass = 1

Dim Controller,B2SController,objShell,PopupMessage
Dim B2SOn, B2SOnALT, DOFeffects(9)

Dim DesktopMode:DesktopMode = Table1.ShowDT
Dim UseVPMDMD:UseVPMDMD = DesktopMode
Dim FastFlippersEnabled:FastFlippersEnabled = False
Dim LFlipKey:LFlipKey = False
Dim LFlipSol:LFlipSol = False
Dim RFlipKey:RFlipKey = False
Dim RFlipSol:RFlipSol = False
Dim LFlipState:LFlipState = False
Dim RFlipState:RFlipState = False

' Rom Name
Const cGameName = "spagb_100"
Const B2ScGameName = "spagb_100b2s"

'***************************************************************************************************
'* DIMS FOR THE ANIMATED COIN DOOR AND MANUAL  *  Add near the top of the script into existing table code
'***************************************************************************************************
Dim ManualPageNumber: ManualPageNumber = 0
Dim CoindoorIsOpen
Dim DoorReady: DoorReady = true
Dim WobbleBall
Dim ManualMove:ManualMove= 1
Dim CDA
Dim DoorMove:DoorMove=-1
Dim DCO:DCO=False
Dim MA:MA=False
Dim VRCoindoor
' creates ball for the VR key wobble and manual float wobble
Dim KeyWobble
 KeyWobble = 1
If KeyWobble = 1 and renderingmode = 2 or VRtest = 1 then
  set Wobbleball=keykicker.createball
  keykicker.Kick 180, 1
end if

'**************************************************************************

LoadCore
LoadSPAController

' Standard Options
Const UseSolenoids = 1
Const UseLamps = 0
Const UseSync = 0
Const HandleMech = 0

' Standard Sounds
Const SSolenoidOn = ""
Const SSolenoidOff = ""

'Dip Switches / Options Menu
Private vpmDips
Set vpmShowDips = GetRef("GBShowDips")

Private Sub GBShowDips
  If Not IsObject(vpmDips) Then ' First time
    Set vpmDips = New cvpmDips
    With vpmDips
      .AddForm 100, 240, "DIP Switches"
      .AddFrame 0, 0, 180, "Country", &H1b,_
        Array("USA",      &H00,_
          "Austria",    &H01,_
          "Belgium",    &H02,_
          "Canada 1",   &H03,_
          "Netherlands",  &H04,_
          "Finland",    &H05,_
          "France",     &H06,_
          "Germany",    &H07,_
          "Italy",    &H08,_
          "Denmark",    &H09,_
          "Norway",   &H0a,_
          "Sweden",   &H0b,_
          "Switzerland",  &H0c,_
          "Australia",    &H0d,_
          "UK",     &H0e,_
          "Greece",   &H0f,_
          "New Zealand",  &H10,_
          "Spain",    &H12,_
          "S.Africa",     &H14,_
          "Japan",    &H15,_
          "Croatia",    &H16,_
          "Middle East",  &H17,_
          "Taiwan",   &H18,_
          "Russia",       &H19,_
          "Canada 2",   &H1a)
    End With
  End If
  vpmDips.ViewDips
End Sub

'***********************************
'     Options
'***********************************

Sub Table1_OptionEvent(ByVal eventId)

  ' Cabinet
  Dim Pincab : Pincab = 1
  Pincab = Table1.Option("Cabinet", 1, 3, 1, 1, 0, Array("Limited Edition Cabinet", "Premium Cabinet", "Pro Cabinet Artwork Only"))
  Select Case Pincab
    Case 1:
      PinCab_Cabinet.image="Pincab_Cabinet_LE"
      PinCab_Backbox.image="Pincab_Backbox_LE"
      PinCab_Backglass.image="PinCab_Backglass_LE"
      PinCab_Rails.Material="Metal_Green_Powdercoat"
      PinCab_FlipBlade.Material="Metal_Green_Powdercoat"
      Pincab_LegsBack.Material="Metal_Green_Powdercoat"
      Pincab_LegsFront.Material="Metal_Green_Powdercoat"
      PinCab_Metals.Material="Metal_Green_Powdercoat"
      ApronP.image="GB_Apron_LE"
      VR_Room_Poster.image="Flyer_LE"
      VR_Room_Logo.image="Logo_LE"
      PinCab_DMD_Slime.image="DMD_Slime1"
      PinCab_Plunger_Slime.image="plunger_Slime1"
      VRTopperLogo.imageA="Logo"
      VRTopperLogo.imageB="Logo"
      VR_KeyShakeOpen.Visible = 0
      if Renderingmode = 2 or VRtest = 1 Then
      Else
      Desktop_BG.image="Logo_LE"
      end if
    Case 2:
      PinCab_Cabinet.image="Pincab_Cabinet_Prem"
      PinCab_Backbox.image="Pincab_Backbox_Prem"
      PinCab_Backglass.image="PinCab_Backglass_Prem"
      PinCab_Rails.Material="Metal_Black_Powdercoat"
      Pincab_LegsBack.Material="Metal_Black_Powdercoat"
      pincab_LegsFront.Material="Metal_Black_Powdercoat"
      PinCab_Metals.Material="Metal_Black_Powdercoat"
      PinCab_FlipBlade.Material="Metal_Black_Powdercoat"
      ApronP.image="GB_Apron"
      VR_Room_Poster.image="Flyer_Prem"
      VR_Room_Logo.image="Logo_Prem"
      PinCab_DMD_Slime.image="DMD_Slime"
      PinCab_Plunger_Slime.image="plunger_Slime"
      VRTopperLogo.imageA="Logo"
      VRTopperLogo.imageB="Logo"
      VR_KeyShakeOpen.Visible = 0
      LeftRailscrew3.Visible = 0
      PinCab_FlipBlade.Visible = 0
      Desktop_BG.image="Logo_prem"
    Case 3:
      PinCab_Cabinet.image="Pincab_Cabinet_Pro"
      PinCab_Backbox.image="Pincab_Backbox_Pro"
      PinCab_Backglass.image="PinCab_Backglass_Pro"
      PinCab_Rails.Material="Metal_Black_Powdercoat"
      Pincab_LegsBack.Material="Metal_Black_Powdercoat"
      Pincab_LegsFront.Material="Metal_Black_Powdercoat"
      PinCab_Metals.Material="Metal_Black_Powdercoat"
      PinCab_FlipBlade.Material="Metal_Black_Powdercoat"
      ApronP.image="GB_Apron"
      VR_Room_Poster.image="Flyer_Pro"
      VR_Room_Logo.image="Logo_Pro"
      PinCab_DMD_Slime.image="DMD_Slime2"
      PinCab_Plunger_Slime.image="plunger_Slime2"
      VRTopperLogo.imageA="Logo"
      VRTopperLogo.imageB="Logo"
      VR_KeyShakeOpen.Visible = 0
      LeftRailscrew3.Visible = 0
      PinCab_FlipBlade.Visible = 0
      Desktop_BG.image="Logo_pro"
  End Select

  ' Sideblades
  Dim CustomCabSides : CustomCabSides = 1
  CustomCabSides = Table1.Option("Side Blades", 1, 7, 1, 1, 0, Array("Black Wood Side Blades", "Stern Side Blades", "RetroRefurbs Side Blades", "CustomPinball Side Blades", "CustomPinball Side Blades", "Custom Side Blades", "Custom Side Blades"))
  Select Case CustomCabSides
  Case 1
    SideCab.image = "CabSides"
  Case 2
    SideCab.image = "CabSides_Art"
  Case 3
    SideCab.image = "CabSides_Art_A"
  Case 4
    SideCab.image = "CabSides_Art_B"
  Case 5
    SideCab.image = "CabSides_Art_C"
  Case 6
    SideCab.image = "CabSides_Art_D"
  Case 7
    SideCab.image = "CabSides_Art_F"
  End Select

  ' Backwall
  Dim Custombackwall : Custombackwall = 1
  Custombackwall = Table1.Option("Backwall", 1, 2, 1, 1, 0, Array("Stern Backwall", "Custom Backwall"))
  Select Case Custombackwall
  Case 1
    backwall.image = "GB_backwall"
  Case 2
    backwall.image = "GB_backwall_Custom"
  End Select

  'Apron Cards
  Dim CustomCards : CustomCards = 1
  CustomCards = Table1.Option("Instruction Cards", 1, 4, 1, 1, 0, Array("Stern 30 Years Inst", "Stern Tournament Instructions", "Custom Instructions", "Custom Instructions"))
  Select Case CustomCards
  Case 1
    Cards.image = "GB_Cards"
  Case 2
    Cards.image = "GB_Cards_B"
  Case 3
    Cards.image = "GB_Cards_C"
  Case 4
    Cards.image = "GB_Cards_D"
  End Select

  'Flippers Type
    Dim CustomFlippers : CustomFlippers = 1
  CustomFlippers = Table1.Option("Flippers", 1, 3, 1, 1, 0, Array("Standard Flippers", "Custom Flippers", "Custom Flippers"))
  Select Case CustomFlippers
  Case 1
    LeftFlipperP.image = "GBLE flippers"
    RightFlipperP.image = "GBLE flippers"
  Case 2
    LeftFlipperP.image = "GBLE flipperMod"
    RightFlipperP.image = "GBLE flipperMod"
  Case 3
    LeftFlipperP.image = "GBLE flipperMod_1"
    RightFlipperP.image = "GBLE flipperMod_1"
  End Select

  'FireHouse
    Dim ShowFirehouse : ShowFirehouse = 1
  ShowFirehouse = Table1.Option("FireHouse", 1, 2, 1, 1, 0, Array("Stern FireHouse", "Custom FireHouse"))
  Select Case ShowFirehouse
  Case 1
  Firehouse_logo.visible = False
  FireHouse_Roof.visible = False
  FireHouse_Frontwall.visible = False
  FireHouse_sidewall.visible = False
  Primitive45.visible = True
  Case 2
  Firehouse_logo.visible = ShowFirehouse
  FireHouse_Roof.visible = ShowFirehouse
  FireHouse_Frontwall.visible = ShowFirehouse
  FireHouse_sidewall.visible = ShowFirehouse
  Primitive45.visible = True
  End Select

  'Ecto1 Toy
    Dim ShowEcto1Toy : ShowEcto1Toy = 1
  ShowEcto1Toy = Table1.Option("Ecto 1 Toy", 1, 2, 1, 1, 0, Array("Ecto 1 Toy Disabled", "Ecto 1 Toy Enabled"))
  Select Case ShowEcto1Toy
  Case 1
  Ecto1_chromeparts.visible = False
  Ecto1_glass.visible = False
  Ecto1_main.visible = False
  Ecto1_metals.visible = False
  Ecto1_topdetails.visible = False
  Ecto1_trap.visible = False
  LEcto.visible = False
  Case 2
  Ecto1_chromeparts.visible = ShowEcto1Toy
  Ecto1_glass.visible = ShowEcto1Toy
  Ecto1_main.visible = ShowEcto1Toy
  Ecto1_metals.visible = ShowEcto1Toy
  Ecto1_topdetails.visible = ShowEcto1Toy
  Ecto1_trap.visible = ShowEcto1Toy
  LEcto.visible = ShowEcto1Toy
  End Select

  'Magna Slings
      Dim MagnaSlings : MagnaSlings = 1
  MagnaSlings = Table1.Option("Magna Slings", 1, 2, 1, 1, 0, Array("Magna Slings Disabled", "Magna Slings Enabled"))
  Select Case MagnaSlings
  Case 1 'OFF
    LeftMagnaSling.Enabled = False : RightMagnaSling.Enabled = False
    SLING1.visible = True : SLING2.visible = True
    sw7.collidable = False : sw8.collidable = False
    sw7a.collidable = True : sw8a.collidable = True
    MagnaSlings = 0
  Case 2 'ON
    LeftMagnaSling.Enabled = True : RightMagnaSling.Enabled = True
    SLING1.visible = False : SLING2.visible = False
    sw7.collidable = True : sw8.collidable = True
    sw7a.collidable = False : sw8a.collidable = False
    MagnaSlings = 1
  End Select

  'Scratched Glass
    Dim GlassScratches : GlassScratches = 1
  GlassScratches = Table1.Option("Glass Scratches", 1, 2, 1, 1, 0, Array("Glass Scratches Disabled", "Glass Scratches Enabled"))
  Select Case GlassScratches
  Case 1
  PinCab_Glass_scratches.visible = False
  Case 2
  PinCab_Glass_scratches.visible =True
  End Select

  'Custom Lighting
    Dim CustomLighting : CustomLighting = 1
  CustomLighting = Table1.Option("Lighting", 1, 2, 1, 1, 0, Array("Standard Lighting", "Custom Lighting"))
  Select Case CustomLighting
  Case 1
    For each bulb in GI_Purple:bulb.color = RGB (160,240,220) : bulb.colorfull = RGB (160,240,221) : bulb.intensity = 16: Next
    For each bulb in GI_Green:bulb.color = RGB (160,240,220) : bulb.colorfull = RGB (160,240,221) : bulb.intensity = 16: Next
    For each bulb in GI_Red:bulb.color = RGB (160,240,220) : bulb.colorfull = RGB (160,240,221) : bulb.intensity = 16: Next
    Reflect1.imageA = "LibrarianLit" : Reflect1.imageB = "LibrarianLit" : Reflect2.visible = 0
    glowbatleft.visible = 0 : glowbatright.visible = 0 : GlowBatLightLeft.state = 0 : GlowBatLightRight.state = 0
    LeftFlipperP.visible=1:RightFlipperP.visible=1
    FlipperLSh.visible = 1 : FlipperRSh.visible = 1
    light21.state = 0 : light22.state = 0
    light23.state = 0 : light24.state = 0
  Case 2
    If Pincab = 1 then
    Dim bulb
    For each bulb in GI_Purple:bulb.color = RGB (128,0,255) : bulb.colorfull = RGB (160,60,255) : bulb.intensity = 40: Next
    For each bulb in GI_Red:bulb.color = RGB (132,0,0) : bulb.colorfull = RGB (255,55,55) : bulb.intensity = 40: Next
    For each bulb in GI_Green:bulb.color = RGB (4,255,4) : bulb.colorfull = RGB (20,140,20) : bulb.intensity = 40: Next
    Reflect1.imageA = "LibrarianLit_C" : Reflect1.imageB = "LibrarianLit_C" : Reflect2.visible = 1
    light21.state = 1 : light22.state = 1 : l54.color = RGB (255,55,55) : l54a.color = RGB (255,55,55)
    LeftFlipperP.visible=0:RightFlipperP.visible=0
    FlipperLSh.visible = 0 : FlipperRSh.visible = 0
    glowbatleft.visible = 1 : glowbatright.visible = 1 : GlowBatLightLeft.state = 1 : GlowBatLightRight.state = 1
    glowbatleft.image = "glowbat green" : glowbatright.image = "glowbat green"
    GlowBatLightLeft.color = RGB(0,255,0) : GlowBatLightLeft.colorfull = RGB(0,255,0)
    GlowBatLightRight.color = RGB(0,255,0): GlowBatLightRight.colorfull = RGB(0,255,0)
    End if
  If Pincab = 2 then
    For each bulb in GI_Purple:bulb.color = RGB (128,0,255) : bulb.colorfull = RGB (160,60,255) : bulb.intensity = 40: Next
    For each bulb in GI_Red:bulb.color = RGB (132,0,0) : bulb.colorfull = RGB (255,55,55) : bulb.intensity = 40: Next
    For each bulb in GI_Green:bulb.color = RGB (4,255,4) : bulb.colorfull = RGB (20,140,20) : bulb.intensity = 40: Next
    Reflect1.imageA = "LibrarianLit_C" : Reflect1.imageB = "LibrarianLit_C" : Reflect2.visible = 1
    light23.state = 1 : light24.state = 1 : l54.color = RGB (33,60,180) : l54a.color = RGB (33,60,180)
    LeftFlipperP.visible=0:RightFlipperP.visible=0
    FlipperLSh.visible = 0 : FlipperRSh.visible = 0
    glowbatleft.visible = 1 : glowbatright.visible = 1 : GlowBatLightLeft.state = 1 : GlowBatLightRight.state = 1
    glowbatleft.image = "glowbat blue" : glowbatright.image = "glowbat blue"
    GlowBatLightLeft.color = RGB(33,60,180) : GlowBatLightLeft.colorfull = RGB(33,60,180)
    GlowBatLightRight.color = RGB(33,60,180): GlowBatLightRight.colorfull = RGB(33,60,180)
  End if
    If Pincab = 3 then
    For each bulb in GI_Purple:bulb.color = RGB (128,0,255) : bulb.colorfull = RGB (160,60,255) : bulb.intensity = 40: Next
    For each bulb in GI_Red:bulb.color = RGB (132,0,0) : bulb.colorfull = RGB (255,55,55) : bulb.intensity = 40: Next
    For each bulb in GI_Green:bulb.color = RGB (4,255,4) : bulb.colorfull = RGB (20,140,20) : bulb.intensity = 40: Next
    Reflect1.imageA = "LibrarianLit_C" : Reflect1.imageB = "LibrarianLit_C" : Reflect2.visible = 1
    light23.state = 1 : light24.state = 1 : l54.color = RGB (33,60,180) : l54a.color = RGB (33,60,180)
    LeftFlipperP.visible=0:RightFlipperP.visible=0
    FlipperLSh.visible = 0 : FlipperRSh.visible = 0
    glowbatleft.visible = 1 : glowbatright.visible = 1 : GlowBatLightLeft.state = 1 : GlowBatLightRight.state = 1
    glowbatleft.image = "glowbat pink" : glowbatright.image = "glowbat pink"
    GlowBatLightLeft.color = RGB(255,60,220) : GlowBatLightLeft.colorfull = RGB(255,60,220)
    GlowBatLightRight.color = RGB(255,60,220): GlowBatLightRight.colorfull = RGB(255,60,220)
  End if
  End Select

  'Side Rails
    Dim Siderails : Siderails = 1
  Siderails = Table1.Option("Siderails", 1, 2, 1, 1, 0, Array("Side Rails Enabled", "Side Rails Disabled"))
  Select Case Siderails
  Case 1
  PinCab_Rails.visible = True
  Case 2
  PinCab_Rails.visible = False
  End Select

  'VRRoom
    Dim VRThings: Dim Vrroom : Vrroom = 1
  Vrroom = Table1.Option("VR Room", 1, 4, 1, 1, 0, Array("Library", "Minimal Room", "Ultra Minimal", "Mixed Reality"))
  Select Case Vrroom
  Case 1
    If Renderingmode = 2 or VRtest = 1 then
    for each VRThings in VRCab:VRThings.visible = 1:Next
    for each VRThings in VR360Room:VRThings.visible = 1:Next
    for each VRThings in VRMinimal:VRThings.visible = 0:Next
    for each VRThings in VRSphere:VRThings.visible = 0:Next
    Scoretext.visible = False
    'Pincab_Rails.visible = True
    TimerVRPlunger2.Enabled = True
    StackTrigger.enabled = true
    Desktop_BG.visible = False
      LoadVR360Room
    Vrroom = 1
    Else
    for each VRThings in VRCab:VRThings.visible = 0:Next
    for each VRThings in VR360Room:VRThings.visible = 0:Next
    for each VRThings in VRMinimal:VRThings.visible = 0:Next
    for each VRThings in VRbooks:VRThings.visible = 0:Next
    for each VRThings in VRSphere:VRThings.visible = 0:Next
    Scoretext.visible = True
    'Pincab_Rails.visible = True
    HideFSRight.visible = False
    HideFSLeft.visible = False
    StackTrigger.enabled = false
        end if
  Case 2
    If Renderingmode = 2 or VRtest = 1 then
    for each VRThings in VRCab:VRThings.visible = 1:Next
    for each VRThings in VR360Room:VRThings.visible = 0:Next
    for each VRThings in VRMinimal:VRThings.visible = 1:Next
    for each VRThings in VRSphere:VRThings.visible = 0:Next
    Scoretext.visible = False
    'Pincab_Rails.visible = True
    TimerVRPlunger2.Enabled = True
    Desktop_BG.visible = False
    LoadMinimalRoom
    Vrroom= 2
    Else
    for each VRThings in VRCab:VRThings.visible = 0:Next
    for each VRThings in VR360Room:VRThings.visible = 0:Next
    for each VRThings in VRMinimal:VRThings.visible = 0:Next
    for each VRThings in VRSphere:VRThings.visible = 0:Next
    Scoretext.visible = True
    'Pincab_Rails.visible = True
    HideFSRight.visible = False
    HideFSLeft.visible = False
    StackTrigger.enabled = false
    end if
  Case 3
    If Renderingmode = 2 or VRtest = 1 then
    for each VRThings in VRCab:VRThings.visible = 1:Next
    for each VRThings in VR360Room:VRThings.visible = 0:Next
    for each VRThings in VRMinimal:VRThings.visible = 0:Next
    for each VRThings in VRSphere:VRThings.visible = 0:Next
    Scoretext.visible = False
    'Pincab_Rails.visible = True
    TimerVRPlunger2.Enabled = True
    Desktop_BG.visible = False
    LoadMinimalRoom
    Vrroom = 3
    Else
    for each VRThings in VRCab:VRThings.visible = 0:Next
    for each VRThings in VR360Room:VRThings.visible = 0:Next
    for each VRThings in VRMinimal:VRThings.visible = 0:Next
    for each VRThings in VRSphere:VRThings.visible = 0:Next
    Scoretext.visible = True
    'Pincab_Rails.visible = True
    HideFSRight.visible = False
    HideFSLeft.visible = False
    StackTrigger.enabled = false
    end if
  Case 4
    If Renderingmode = 2 or VRtest = 1 then
    for each VRThings in VRCab:VRThings.visible = 1:Next
    for each VRThings in VR360Room:VRThings.visible = 0:Next
    for each VRThings in VRMinimal:VRThings.visible = 0:Next
    for each VRThings in VRSphere:VRThings.visible = 1:Next
    Scoretext.visible = False
    'Pincab_Rails.visible = True
    TimerVRPlunger2.Enabled = True
    Desktop_BG.visible = False
    LoadMinimalRoom
    Vrroom = 4
    PinCab_Shadow.visible = False
    Else
    for each VRThings in VRCab:VRThings.visible = 0:Next
    for each VRThings in VR360Room:VRThings.visible = 0:Next
    for each VRThings in VRMinimal:VRThings.visible = 0:Next
    for each VRThings in VRSphere:VRThings.visible = 0:Next
    Scoretext.visible = True
    'Pincab_Rails.visible = True
    HideFSRight.visible = False
    HideFSLeft.visible = False
    StackTrigger.enabled = false
    end if
  End Select

  'VR Topper
    Dim Topper: Topper = 1
  Topper = Table1.Option("VR Topper", 1, 3, 1, 1, 0, Array("Stern Topper", " Tourmament Mode Topper", "Topper Disabled"))
  Select Case Topper
  Case 1
  If Renderingmode = 2 or VRtest = 1 then
  TopperBall.visible = Topper
  TopperBlueLeft.visible = Topper
  TopperBlueRight.visible = Topper
  TopperBottomPart.visible = Topper
  TopperCenter.visible = Topper
  TopperHorn.visible = Topper
  TopperMetals.visible = Topper
  TopperRed.visible = Topper
  TopperScrews.visible = Topper
  TopperTopBlue.visible = Topper
  TopperTopGlass.visible = Topper
  VRTopperLogo.visible = Topper
  TopperFlasherTimer.Enabled = Topper
  TopperIntroFlasherEndTimer.Enabled = Topper
  TopperIntroFlasherTimer.Enabled = Topper
  TopperIntroFlasherTimer2.Enabled = Topper
  Fl166.visible = Topper
  Fl168.visible = Topper
  Fl167.visible = Topper
  Fl169.visible = Topper
  Fl170.visible = Topper
  TestFlasher1.visible = Topper
  TestFlasher2.visible = topper
Else
  TopperBall.visible = False
  TopperBlueLeft.visible =False
  TopperBlueRight.visible = False
  TopperBottomPart.visible = False
  TopperCenter.visible = False
  TopperHorn.visible = False
  TopperMetals.visible = False
  TopperRed.visible = False
  TopperScrews.visible = False
  TopperTopBlue.visible = False
  TopperTopGlass.visible = False
  VRTopperLogo.visible = False
  TopperFlasherTimer.Enabled = False
  TopperIntroFlasherEndTimer.Enabled = False
  TopperIntroFlasherTimer.Enabled = False
  TopperIntroFlasherTimer2.Enabled = False
  Fl166.visible = False
  Fl168.visible = False
  Fl167.visible = False
  Fl169.visible = False
  Fl170.visible = False
  TestFlasher1.visible = False
  TestFlasher2.visible = False
  PinCab_TTopper.visible = False
End if
  Case 3
  TopperBall.visible = False
  TopperBlueLeft.visible =False
  TopperBlueRight.visible = False
  TopperBottomPart.visible = False
  TopperCenter.visible = False
  TopperHorn.visible = False
  TopperMetals.visible = False
  TopperRed.visible = False
  TopperScrews.visible = False
  TopperTopBlue.visible = False
  TopperTopGlass.visible = False
  VRTopperLogo.visible = False
  TopperFlasherTimer.Enabled = False
  TopperIntroFlasherEndTimer.Enabled = False
  TopperIntroFlasherTimer.Enabled = False
  TopperIntroFlasherTimer2.Enabled = False
  Fl166.visible = False
  Fl168.visible = False
  Fl167.visible = False
  Fl169.visible = False
  Fl170.visible = False
  TestFlasher1.visible = False
  TestFlasher2.visible = False
  PinCab_TTopper.visible = False
  Case 2
  PinCab_TTopper.visible = True
  TopperBall.visible = False
  TopperBlueLeft.visible =False
  TopperBlueRight.visible = False
  TopperBottomPart.visible = False
  TopperCenter.visible = False
  TopperHorn.visible = False
  TopperMetals.visible = False
  TopperRed.visible = False
  TopperScrews.visible = False
  TopperTopBlue.visible = False
  TopperTopGlass.visible = False
  VRTopperLogo.visible = False
  TopperFlasherTimer.Enabled = False
  TopperIntroFlasherEndTimer.Enabled = False
  TopperIntroFlasherTimer.Enabled = False
  TopperIntroFlasherTimer2.Enabled = False
  Fl166.visible = False
  Fl168.visible = False
  Fl167.visible = False
  Fl169.visible = False
  Fl170.visible = False
  TestFlasher1.visible = False
  TestFlasher2.visible = False
  End Select

  'VR Logo
    Dim VRlogo: VRlogo = 1
  VRlogo = Table1.Option("VR Logo", 1,2, 1, 1, 0, Array("Logo Disabled", "Logo Enabled"))
  Select Case VRlogo
  Case 2
  If Renderingmode = 2 or VRtest = 1 then
  VR_Room_Logo.visible = True
  Else
  VR_Room_Logo.visible = False
  End if
  Case 1
  VR_Room_Logo.visible = False
  End Select

  'VR Poster
    Dim VRPoster: VRPoster = 1
  VRPoster = Table1.Option("VR Poster", 1,2, 1, 1, 0, Array("Poster Disabled", "Poster Enabled"))
  Select Case VRPoster
  Case 2
  If Renderingmode = 2 or VRtest = 1 and Vrroom = 2 then
  VR_Room_Poster.visible = True
  Else
  VR_Room_Poster.visible = False
  End if
  Case 1
  VR_Room_Poster.visible = False
  End Select

  'VR Banner
    Dim VRBanner: VRBanner = 1
  VRBanner = Table1.Option("VR Banner", 1,2, 1, 1, 0, Array("Banner Disabled", "Banner Enabled"))
  Select Case VRBanner
  Case 2
  If Renderingmode = 2 or VRtest = 1 and Vrroom = 2 then
  VR_Room_Banner.visible = True
  Else
  VR_Room_Banner.visible = False
  End if
  Case 1
  VR_Room_banner.visible = False
  End Select

  'DMDslime
    Dim DMDslime : DMDslime = 1
  DMDslime = Table1.Option("VR Slime Decal", 1, 2, 1, 1, 0, Array("Slime Decal Disabled", "Slime Decal Enabled"))
  Select Case DMDslime
  Case 1
  PinCab_DMD_Slime.visible = False
  PinCab_Plunger_Slime.visible = False
  Case 2
  If Renderingmode = 2 or VRtest = 1 then
  PinCab_DMD_Slime.visible = True
  PinCab_Plunger_Slime.visible = True
  Else
  PinCab_DMD_Slime.visible = False
  PinCab_Plunger_Slime.visible = False
  end if
  End Select

  'DMD Reflection
    Dim DMDReflection : DMDReflection = 1
  DMDReflection = Table1.Option("VR DMD Reflection", 1, 2, 1, 1, 0, Array("DMD Reflection Disabled", "DMD Reflection Enabled"))
  Select Case DMDReflection
  Case 1
  PinCab_DMD_Reflection.visible = False
  Case 2
  PinCab_DMD_Reflection.visible = True
  End Select

  'Pupbackglass
    Dim Pupbackglass : Pupbackglass = 1
  Pupbackglass = Table1.Option("VR B2S/PUP Backglass", 1, 2, 1, 1, 0, Array("B2S/PUP Backglass Disabled", "B2S/PUP Backglass Enabled"))
  Select Case Pupbackglass
  Case 1
  PinCab_Backglass_Pup.Visible = False
  Case 2
  PinCab_Backglass_Pup.Visible = True
  End Select


End Sub


'************************************************************************
'            INIT TABLE
'************************************************************************

Dim bsTrough, bsLSaucer, bsRPopper, bsLock, dtLeft, dtRight, plungerIM, mLeftSling, mRightSling

Sub Table1_Init
  vpmInit Me
  With Controller
    .GameName = cGameName
    If Err Then MsgBox "Can't start Game " & cGameName & vbNewLine & Err.Description:Exit Sub
    .SplashInfoLine = "Ghostbusters LE (Stern 2016)"
    .HandleKeyboard = 0
    .ShowTitle = 0
    .ShowDMDOnly = 1
    .ShowFrame = 0
    .HandleMechanics = 0
    .Hidden = DesktopMode
    On Error Resume Next
    .Run GetPlayerHWnd
    If Err Then MsgBox Err.Description
    On Error Goto 0
  End With

    ' Main Timer init
    PinMAMETimer.Interval = PinMAMEInterval
    PinMAMETimer.Enabled = 1

    ' Nudging
    vpmNudge.TiltSwitch = 86
    vpmNudge.Sensitivity = 3
    vpmNudge.TiltObj = Array(sw49, sw50, sw51, sw7, sw8,sw7a,sw8a)

  'Trough
    Set bsTrough = New cvpmTrough
    With bsTrough
    .Size = 6
    .InitSwitches Array(20, 19, 18, 17, 16, 15)
    .InitExit BallRelease, 90, 5
    '.InitEntrySounds "Drain_1", "", ""
    '.InitExitSounds  SoundFX(SSolenoidOn,DOFContactors), SoundFX("ballrelease",DOFContactors)
    .Balls = 6
    .CreateEvents "bsTrough", Drain
    End With

  'Auto Plunger
  Const IMPowerSetting = 50
  Const IMTime = 0.6
    Set plungerIM = New cvpmImpulseP
    With plungerIM
    .InitImpulseP swplunger, IMPowerSetting, IMTime
'        .Switch 22
    .Random 0.3
        '.InitExitSnd SoundFX("AutoPlunger",DOFContactors), SoundFX(SSolenoidOn,DOFContactors)
    .CreateEvents "plungerIM"
    End With

  'Left Scoop
    Set bsLSaucer = new cvpmSaucer
    With bsLSaucer
        .InitKicker ScoopEject, 34, 0, 30, 1.56
    .InitExitVariance 0, 2
        .InitSounds "Saucer_Enter_1", SoundFX(SSolenoidOn,DOFContactors), SoundFX("Saucer_Kick",DOFContactors)
        .CreateEvents "bsLSaucer", ScoopEject
    End With

  'Right Popper
    Set bsRPopper = new cvpmSaucer
    With bsRPopper
        .InitKicker SubwayEject, 63, 0, 38, 1.56
        .InitSounds "Saucer_Enter_2", SoundFX(SSolenoidOn,DOFContactors), SoundFX("Saucer_Kick",DOFContactors)
        .CreateEvents "bsRPopper", SubwayEject
    End With

  'SubwayLock
    Set bsLock = New cvpmTrough
    With bsLock
    .Size = 3
    .InitSwitches Array(62, 61, 60)
    .InitExit SubwayLockOut, 130, 10
    .InitExitSounds  SoundFX(SSolenoidOn,DOFContactors), SoundFX("Saucer_Kick",DOFContactors)
    .Balls = 0
    .CreateEvents "bsLock", SubwayLockIn
    End With

  'Left Drop Target
  Set dtLeft = New cvpmDropTarget
  With dtLeft
    .InitDrop sw65, 65
    .Initsnd SoundFX("fx_DropTargetDown",DOFDropTargets), SoundFX("fx_DropTargetUp",DOFDropTargets)
  End With

  'Right Drop Target
  Set dtRight = New cvpmDropTarget
  With dtRight
    .InitDrop sw66, 66
    .Initsnd SoundFX("fx_DropTargetDown",DOFDropTargets), SoundFX("fx_DropTargetUp",DOFDropTargets)
  End With

  'Magna Slings
    Set mLeftSling = New cvpmMagnet
    With mLeftSling
        .InitMagnet LeftMagnaSling, 55    ' Left Magna Sling Strength (adjust to taste)
        .GrabCenter = True: .Size = 195
        .CreateEvents "mLeftSling"
    End With

    Set mRightSling = New cvpmMagnet
    With mRightSling
        .InitMagnet RightMagnaSling, 55   ' Right Magna Sling Strength (adjust to taste)
        .GrabCenter = True: .Size = 195
        .CreateEvents "mRightSling"
    End With

  'UpPost/Diverter
  DiverterOn.IsDropped=1
  UpPost.IsDropped=1

  'Captive Balls
  kickerinit.CreateSizedballWithMass Ballsize/2, BallMass
  kickerinit.kick 0,0
  kickerinit1.CreateSizedballWithMass Ballsize/2, BallMass
  kickerinit1.kick 0,0
  kickerinit2.CreateSizedballWithMass Ballsize/2, BallMass
  kickerinit2.kick 0,0
  kickerinit3.CreateSizedballWithMass Ballsize/2, BallMass
  kickerinit3.kick 0,0
  kickerinit4.CreateSizedballWithMass Ballsize/2, BallMass
  kickerinit4.kick 0,0
  kickerinit5.CreateSizedballWithMass Ballsize/2, BallMass
  kickerinit5.kick 0,0
  Controller.Switch(28) = True
  Controller.Switch(29) = True
  Controller.Switch(30) = True

  Dim bulb
  If DesktopMode Then
    For each bulb in StayPuftFlasher: bulb.intensity = 20 : Next
  Else
    For each bulb in StayPuftFlasher: bulb.intensity = 10 : Next
  End If

  InitOptions

End Sub

'***********************************************************************
'* TABLE OPTIONS *******************************************************
'***********************************************************************
Dim IsGlowBall:IsGlowball=False

Sub InitOptions

  'Green GlowBall
  If CustomBall = 1 Then IsGlowBall=True
  If CustomBall = 2 Then IsGlowBall=True
  If CustomBall = 3 Then IsGlowBall=True

End Sub

'******************************
'  Setup Desktop
'******************************

  If DesktopMode = True then
    Desktop_BG.visible = true
  Else
    Desktop_BG.visible = false
  End If

'************************************************************************
'            KEYS MAPPING
'************************************************************************

Sub Table1_KeyDown(ByVal Keycode)


  If keycode = LeftFlipperKey Then
    Controller.Switch(9) = True
    LFlipKey = True
    LFPress = 1 'nFozzy
    UpdateLeftFlipper
    VRFlipperButtonLeft.X = VRFlipperButtonLeft.X +8


    If CoindoorIsOpen = 1 Then 'AXS Coindoor
      Playsound "ball_bounce"
      ManualPageNumber = ManualPageNumber - 1
      if ManualPageNumber = -1 then ManualPageNumber = 21   ' Set your instruction manual page number here.
      VRManualInstructions.Image = "Manual_Page" & ManualPageNumber
    End If
    End if

  If keycode = RightFlipperKey Then
    Controller.Switch(10) = True
    RFlipKey = True
    rfpress = 1 'nFozzy
    UpdateRightFlipper
    VRFlipperButtonRight.X = VRFlipperButtonRight.X -8


      If CoindoorIsOpen = 1 Then 'AXS Coindoor
        Playsound "ball_bounce"
        ManualPageNumber = ManualPageNumber + 1
        if ManualPageNumber = 22 then ManualPageNumber = 0  ' Set your instruction manual page number +1 here.
        VRManualInstructions.Image = "Manual_Page" & ManualPageNumber
      End If
  End if

  If KeyCode = PlungerKey Then
    Plunger.Pullback
    SoundPlungerPull()
    If renderingmode = 2 or VRtest = 1 then
      TimerVRPlunger.Enabled = True
      TimerVRPlunger2.Enabled = False
    End if
  End if

  If keycode = StartGameKey Then
    Controller.Switch(78)  = True
        soundStartButton()
      VRStartButton.Y = VRStartButton.Y -5
      VRStartButton2.Y = VRStartButton2.Y -5
  End if

  If keycode = keyFront Then
  Controller.Switch(79) = True
    Pincab_Tournament_Button.Y =Pincab_Tournament_Button.Y -5 'Tournament mode mapped to key 2
    End if

  If keycode = keyInsertCoin1 Then vpmTimer.AddTimer 750,"vpmTimer.PulseSw 81'"       'Coin door chute #1
    If keycode = keyInsertCoin2 Then vpmTimer.AddTimer 750,"vpmTimer.PulseSw 82'"     'Coin door chute #2
    If keycode = keyInsertCoin3 Then vpmTimer.AddTimer 750,"vpmTimer.PulseSw 83'"       'Coin door chute #3
    If keycode = keyInsertCoin4 Then vpmTimer.AddTimer 750,"vpmTimer.PulseSw 84'"       'Coin door chute #4

  If keycode = keyInsertCoin1 or keycode = keyInsertCoin2 or keycode = keyInsertCoin3 or keycode = keyInsertCoin4 Then
        Select Case Int(rnd*3)
            Case 0: PlaySound ("Coin_In_1"), 0, CoinSoundLevel, 0, 0.25
            Case 1: PlaySound ("Coin_In_2"), 0, CoinSoundLevel, 0, 0.25
            Case 2: PlaySound ("Coin_In_3"), 0, CoinSoundLevel, 0, 0.25

        End Select
    End If
  If keycode = keyCancel Then Controller.Switch(0) = True
  If keycode = keyDown Then Controller.Switch(-1) = True
  If keycode = keyUp Then Controller.Switch(-2) = True
  If keycode = keyEnter Then Controller.Switch(-3) = True

' If keycode = keySlamDoorHit Then Controller.Switch(89) = True                     'Slam Tilt
' If keycode = keyCoinDoor Then Controller.Switch(106) = True                       'Playfield power interlock

  If keycode =  keyBangBack Then vpmNudge.DoNudge 0, 2
  If keycode =  LeftTiltKey Then
    Nudge 75, 2  ' Had to add this line on all 3 digital nudge presses.. not sure why existing code doesnt work.
    vpmNudge.DoNudge 75, 2
    SoundNudgeLeft()
        If renderingmode = 2 or VRtest = 1 and Keywobble = 1 then CoindoorTimer.enabled = true :CoinShutdownTimer.Interval = 17000: CoinShutdownTimer.enabled = true: keykicker2.Kick 0, 20
    End if

  If keycode =  RightTiltKey Then
    Nudge 285, 2
    vpmNudge.DoNudge 285, 2
    SoundNudgeRight()
    if renderingmode = 2 or VRtest = 1 and Keywobble = 1 then CoindoorTimer.enabled = true :CoinShutdownTimer.Interval = 17000: CoinShutdownTimer.enabled = true :keykicker2.Kick 0, 20
    End if
  If keycode =  CenterTiltKey Then
    Nudge 0, 2
    vpmNudge.DoNudge 0, 2
    SoundNudgeCenter()
    If renderingmode = 2 or VRtest = 1 and Keywobble = 1 then CoindoorTimer.enabled = true :CoinShutdownTimer.Interval = 17000: CoinShutdownTimer.enabled = true: keykicker2.Kick 0, 20
    End if

  If KeyCode = RightMagnaSave OR KeyCode = LeftMagnaSave OR KeyCode = LockbarKey Then Controller.Switch(76) = True        'LockBar Button (Optional)
  If KeyCode = keyVPMVolume Then vpmVol


  '********************************************************************************
  'AXS Coindoor
  '********************************************************************************
  '             COINDOOR OPEN AND CLOSE BUTTON ROUTINE - RASCAL & RAWD
  '********************************************************************************
  If keycode = keyCoinDoor  then ' use 'keyCoinDoor' instead of '207' for Rom driven tables.
    CoindoorTimer.enabled = true
    CoinShutdownTimer.enabled = true
    CoinShutdownTimer.Interval = 17000

    If DoorReady = true then
      DoorReady = false
      If DoorMove = -1 then
        PlaySound "CoindoorOpen":DCO = True:CoindoorIsOpen = 1
      Else
        PlaySound "page2":MA = True:CoindoorIsOpen = 0:ManualPageNumber = 0
        VRManualInstructions.Image = "Manual_Page" & ManualPageNumber
      End If
    End If
  End If
  '*********************************************************************************
    'AXS Coindoor
  If keycode = 8 and CoindoorIsOpen = 1 Then CoindoorB1.transy = CoindoorB1.transy + 10: playsound "Coindoor_Button"
  If keycode = 9 and CoindoorIsOpen = 1 Then CoindoorB2.transy = CoindoorB2.transy + 10: playsound "Coindoor_Button"
  If keycode = 10 and CoindoorIsOpen = 1 Then CoindoorB3.transy = CoindoorB3.transy + 10: playsound "Coindoor_Button"
  If keycode = 11 and CoindoorIsOpen = 1 Then CoindoorB4.transy = CoindoorB4.transy + 10: playsound "Coindoor_Button"
'    If vpmKeyDown(keycode) Then Exit Sub
End Sub


Sub CoinShutdownTimer_timer()  ' this is to shut off the coin door timer after 20 seconds and the key is done moving (so its not running all the time)
  CoindoorTimer.enabled = false
End Sub


Sub Table1_KeyUp(ByVal Keycode)
  If keycode = LeftFlipperKey Then
    Controller.Switch(9) = False
    LFlipKey = False
    'nfozzy begin'
    lfpress = 0
    leftflipper.eostorqueangle = EOSA
    leftflipper.eostorque = EOST
    'nfozzy end'
    UpdateLeftFlipper
    VRFlipperButtonLeft.X = VRFlipperButtonLeft.X -8
  End If

  If keycode = RightFlipperKey Then
    Controller.Switch(10) = False
    RFlipKey = False
    'nFozzy Begin'
    rfpress = 0
    rightflipper.eostorqueangle = EOSA
    rightflipper.eostorque = EOST
    'nFozzy Begin'
    UpdateRightFlipper
    VRFlipperButtonRight.X = VRFlipperButtonRight.X +8
  End If

  If KeyCode = PlungerKey Then
    Plunger.Fire
    SoundPlungerReleaseBall()
    if Renderingmode = 2 or VRtest = 1 then
      TimerVRPlunger.Enabled = False
      TimerVRPlunger2.Enabled = True
      Pincab_plunger.Y =2290
    End If
  End if

  If keycode = StartGameKey Then
    Controller.Switch(78)  = False
      VRStartButton.Y = VRStartButton.Y +5
      VRStartButton2.Y = VRStartButton2.Y +5
      End if
  If keycode = keyFront Then
    Controller.Switch(79) = False
      Pincab_Tournament_Button.Y =Pincab_Tournament_Button.Y +5 'Tournament mode mapped to key 2
      End if
  If keycode = keyCancel Then Controller.Switch(0) = False
  If keycode = keyDown Then Controller.Switch(-1) = False
  If keycode = keyUp Then Controller.Switch(-2) = False
  If keycode = keyEnter Then Controller.Switch(-3) = False

' If keycode = keySlamDoorHit Then Controller.Switch(89) = False                      'Slam Tilt
' If keycode = keyCoinDoor Then Controller.Switch(106) = False                      'Playfield power interlock

  If KeyCode = RightMagnaSave OR KeyCode = LeftMagnaSave OR KeyCode = LockbarKey Then Controller.Switch(76) = False       'LockBar Button (Optional)

  If KeyCode = keyShowOpts Then                                     'F1 - Show VPM options
    Controller.Pause = True
    Controller.ShowOptsDialog GetPlayerHWnd
    Controller.Pause = False
  End If

  If KeyCode = keyShowKeys Then Controller.Pause = True : vpmShowHelp : Controller.Pause = False      'F2 - Show Keys
  If KeyCode = keyReset Then Controller.Stop : BeginModal : Controller.Run : vpmTimer.Reset : EndModal  'F3 - Reset Emulation
  If KeyCode = keyFrame Then Controller.LockDisplay = Not Controller.LockDisplay              'F4 - Toggle Window Lock
  If KeyCode = keyDoubleSize Then Controller.DoubleSize  = Not Controller.DoubleSize            'F5 - Toggle displaysize
  If KeyCode = keyShowDips Then                                     'F6 - Show Dip Switch / Options Menu
    If IsObject(vpmShowDips) Then Controller.Pause = True : vpmShowDips : Controller.Pause = False
  End If

    If keycode = 8 and CoindoorIsOpen = 1 Then CoindoorB1.transy = CoindoorB1.transy - 10: playsound "Coindoor_ButtonOff"
  If keycode = 9 and CoindoorIsOpen = 1 Then CoindoorB2.transy = CoindoorB2.transy - 10: playsound "Coindoor_ButtonOff"
  If keycode = 10 and CoindoorIsOpen = 1 Then CoindoorB3.transy = CoindoorB3.transy - 10: playsound "Coindoor_ButtonOff"
  If keycode = 11 and CoindoorIsOpen = 1 Then CoindoorB4.transy = CoindoorB4.transy - 10: playsound "Coindoor_ButtonOff"

'If vpmKeyUp(keycode) Then Exit Sub

End Sub

' Help Window
vpmSystemHelp = "Stern GB keys:" & vbNewLine &_
  vpmKeyName(StartGameKey)    & vbTab & "Start Game"        & vbNewLine &_
  vpmKeyName(keyFront)        & vbTab & "Tournament Mode"   & vbNewLine &_
  vpmKeyName(keyInsertCoin1)  & vbTab & "Insert Coin #1"    & vbNewLine &_
  vpmKeyName(keyInsertCoin2)  & vbTab & "Insert Coin #2"    & vbNewLine &_
  vpmKeyName(keyInsertCoin3)  & vbTab & "Insert Coin #3"    & vbNewLine &_
  vpmKeyName(keyInsertCoin4)  & vbTab & "Insert Coin #4"    & vbNewLine &_
  vpmKeyName(keyCancel)       & vbTab & "Service Back"      & vbNewLine &_
  vpmKeyName(keyDown)         & vbTab & "Service Minus"     & vbNewLine &_
  vpmKeyName(keyUp)           & vbTab & "Service Plus"      & vbNewLine &_
  vpmKeyName(keyEnter)        & vbTab & "Service Select"

Sub Table1_Paused:Controller.Pause = True:End Sub
Sub Table1_UnPaused:Controller.Pause = False:End Sub
Sub Table1_Exit:Controller.Stop:End Sub

'************************************************************************
'            SOLENOIDS MAPPING
'************************************************************************

SolCallBack(1) = "SolTrough"            'Trough
SolCallBack(2) = "SolAutofire"            'AutoPlunger
SolCallback(sLLFlipper) = "SolLFlipper"       'Left Flipper
SolCallback(sLRFlipper) = "SolRFlipper"       'Right Flipper
SolCallback(5)=  "SolMiniMagnet mLeftSling,"    'Left Sling Magnet
SolCallback(6)=  "SolMiniMagnet mRightSling,"   'Right Sling Magnet
SolCallback(7)=  "SolShaker"            'Shaker Motor
SolCallback(10)= "SolLeftEject"           'Left Scoop
SolCallback(11)= "SolLockPost"            'Lock Post (Captive Ball)
SolCallback(12)= "SolUpPost"            'Up Post (Spinner)
'SolCallback(14)= ""                'Left Bumper
'SolCallback(15)= ""                'Right Bumper
'SolCallback(16)= ""                'Bottom Bumper
SolCallback(18)= "vpmSolGate Gate1, SoundFXDOFALT(""ElGate"",127,DOFPulse,DOFContactors),"      'Electric Gate
SolCallback(20)= "SolSubwayDiverter"        'Subway Diverter
SolCallback(21)= "SolSubwayLock"          'Subway Lock
SolCallback(22)= "SolSubwayEject"         'Subway Eject
SolCallback(24)= "SolRaiseLDrop"          'Left Drop Target Up
SolCallback(25)= "SolLowerLDrop"          'Left Drop Target Down
SolCallback(26)= "SolRaiseRDrop"          'Right Drop Target Up
SolCallback(27)= "SolLowerRDrop"          'Right Drop Target Down
SolCallback(30)= "SolKnocker"           'Knocker
'SolCallback(31)= ""                'Ticket Meter
'SolCallback(32)= ""                'Ticket Dispenser
SolCallback(33)= "SolFastFlippersEnabled"

'************************************************************************
'            BALL TROUGH
'************************************************************************
Sub SolTrough(Enabled)
  If Enabled Then
    DOFALT 120, DOFPulse
    bsTrough.ExitSol_On
    If BsTrough.Balls Then vpmTimer.PulseSw 21
  End If
End Sub

'************************************************************************
'             KNOCKER
'************************************************************************
Sub SolKnocker(Enabled)
    If enabled Then
        KnockerSolenoid
    End If
End Sub

'************************************************************************
'            AUTOPLUNGER
'************************************************************************
Sub SolAutofire(Enabled)
  If Enabled Then
    DOFALT 120, DOFPulse
    DOFALT 121, DOFPulse
    PlungerIM.AutoFire
    SoundPlungerReleaseBall()
  End If
End Sub

'************************************************************************
'               FLIPPERS
'************************************************************************
Const ReflipAngle = 20

Sub SolFastFlippersEnabled(Enabled)
  FastFlippersEnabled = Enabled
  UpdateLeftFlipper
  UpdateRightFlipper
End Sub


Sub SolLFlipper(Enabled)
  LFlipSol = Enabled
  UpdateLeftFlipper
End Sub

Sub SolRFlipper(Enabled)
  RFlipSol = Enabled
  UpdateRightFlipper
End Sub

Sub UpdateRightFlipper
  dim NewState

  if FastFlippersEnabled then
    NewState = RFlipKey
  Else
    NewState = RFlipSol
  End If
  if NewState = RFlipState then Exit Sub
  RFlipState = NewState

    If RFlipState Then
    If Rightflipper.currentangle > rightflipper.endangle - ReflipAngle Then
            RandomSoundReflipUpRight RightFlipper
        Else
            SoundFlipperUpAttackRight RightFlipper
            RandomSoundFlipperUpRight RightFlipper
        End If
        RF.Fire 'nfozzy'
    DOFALT 102, DOFOn
    Else
    If RightFlipper.currentangle > RightFlipper.startAngle + 5 Then
      RandomSoundFlipperDownRight RightFlipper
    End If
    FlipperRightHitParm = FlipperUpSoundLevel
        RightFlipper.RotateToStart
    DOFALT 102, DOFOff
    End If
End Sub

Sub UpdateLeftFlipper
  dim NewState

  if FastFlippersEnabled then
    NewState = LFlipKey
  Else
    NewState = LFlipSol
  End If
  if NewState = LFlipState then Exit Sub
  LFlipState = NewState

    If LFlipState Then
        If Leftflipper.currentangle < leftflipper.endangle + ReflipAngle Then
            RandomSoundReflipUpLeft LeftFlipper
        Else
            SoundFlipperUpAttackLeft LeftFlipper
            RandomSoundFlipperUpLeft LeftFlipper
        End If
        LF.Fire 'nfozzy'
    DOFALT 101, DOFOn
    Else
        If LeftFlipper.currentangle < LeftFlipper.startAngle - 5 Then
            RandomSoundFlipperDownLeft LeftFlipper
        End If
        FlipperLeftHitParm = FlipperUpSoundLevel
        LeftFlipper.RotateToStart
    DOFALT 101, DOFOff
    End If
End Sub

Sub LeftFlipper_Collide(parm)
  CheckLiveCatch Activeball, LeftFlipper, LFCount, parm
  LeftFlipperCollide parm
End Sub

Sub RightFlipper_Collide(parm)
  CheckLiveCatch Activeball, RightFlipper, RFCount, parm
  RightFlipperCollide parm
End Sub

'******************************************************
'   FLIPPER CORRECTION INITIALIZATION
'******************************************************

dim LF : Set LF = New FlipperPolarity
dim RF : Set RF = New FlipperPolarity

InitPolarity

Sub InitPolarity()
  dim x, a : a = Array(LF, RF)
  for each x in a
    x.AddPoint "Ycoef", 0, RightFlipper.Y-65, 1 'disabled
    x.AddPoint "Ycoef", 1, RightFlipper.Y-11, 1
    x.enabled = True
    x.TimeDelay = 60
  Next

  AddPt "Polarity", 0, 0, 0
  AddPt "Polarity", 1, 0.05, -5.5
  AddPt "Polarity", 2, 0.4, -5.5
  AddPt "Polarity", 3, 0.6, -5.0
  AddPt "Polarity", 4, 0.65, -4.5
  AddPt "Polarity", 5, 0.7, -4.0
  AddPt "Polarity", 6, 0.75, -3.5
  AddPt "Polarity", 7, 0.8, -3.0
  AddPt "Polarity", 8, 0.85, -2.5
  AddPt "Polarity", 9, 0.9,-2.0
  AddPt "Polarity", 10, 0.95, -1.5
  AddPt "Polarity", 11, 1, -1.0
  AddPt "Polarity", 12, 1.05, -0.5
  AddPt "Polarity", 13, 1.1, 0
  AddPt "Polarity", 14, 1.3, 0

  addpt "Velocity", 0, 0,   1
  addpt "Velocity", 1, 0.16, 1.06
  addpt "Velocity", 2, 0.41,  1.05
  addpt "Velocity", 3, 0.53,  1'0.982
  addpt "Velocity", 4, 0.702, 0.968
  addpt "Velocity", 5, 0.95,  0.968
  addpt "Velocity", 6, 1.03,  0.945

  LF.Object = LeftFlipper
  LF.EndPoint = EndPointLp
  RF.Object = RightFlipper
  RF.EndPoint = EndPointRp
End Sub

Sub TriggerLF_Hit() : LF.Addball activeball : End Sub
Sub TriggerLF_UnHit() : LF.PolarityCorrect activeball : End Sub
Sub TriggerRF_Hit() : RF.Addball activeball : End Sub
Sub TriggerRF_UnHit() : RF.PolarityCorrect activeball : End Sub

'******************************************************
'     FLIPPER CORRECTION FUNCTIONS
'******************************************************

Sub AddPt(aStr, idx, aX, aY)  'debugger wrapper for adjusting flipper script in-game
  dim a : a = Array(LF, RF)
  dim x : for each x in a
    x.addpoint aStr, idx, aX, aY
  Next
End Sub

Class FlipperPolarity
  Public DebugOn, Enabled
  Private FlipAt  'Timer variable (IE 'flip at 723,530ms...)
  Public TimeDelay  'delay before trigger turns off and polarity is disabled TODO set time!
  private Flipper, FlipperStart,FlipperEnd, FlipperEndY, LR, PartialFlipCoef
  Private Balls(20), balldata(20)

  dim PolarityIn, PolarityOut
  dim VelocityIn, VelocityOut
  dim YcoefIn, YcoefOut
  Public Sub Class_Initialize
    redim PolarityIn(0) : redim PolarityOut(0) : redim VelocityIn(0) : redim VelocityOut(0) : redim YcoefIn(0) : redim YcoefOut(0)
    Enabled = True : TimeDelay = 50 : LR = 1:  dim x : for x = 0 to uBound(balls) : balls(x) = Empty : set Balldata(x) = new SpoofBall : next
  End Sub

  Public Property let Object(aInput) : Set Flipper = aInput : StartPoint = Flipper.x : End Property
  Public Property Let StartPoint(aInput) : if IsObject(aInput) then FlipperStart = aInput.x else FlipperStart = aInput : end if : End Property
  Public Property Get StartPoint : StartPoint = FlipperStart : End Property
  Public Property Let EndPoint(aInput) : FlipperEnd = aInput.x: FlipperEndY = aInput.y: End Property
  Public Property Get EndPoint : EndPoint = FlipperEnd : End Property
  Public Property Get EndPointY: EndPointY = FlipperEndY : End Property

  Public Sub AddPoint(aChooseArray, aIDX, aX, aY) 'Index #, X position, (in) y Position (out)
    Select Case aChooseArray
      case "Polarity" : ShuffleArrays PolarityIn, PolarityOut, 1 : PolarityIn(aIDX) = aX : PolarityOut(aIDX) = aY : ShuffleArrays PolarityIn, PolarityOut, 0
      Case "Velocity" : ShuffleArrays VelocityIn, VelocityOut, 1 :VelocityIn(aIDX) = aX : VelocityOut(aIDX) = aY : ShuffleArrays VelocityIn, VelocityOut, 0
      Case "Ycoef" : ShuffleArrays YcoefIn, YcoefOut, 1 :YcoefIn(aIDX) = aX : YcoefOut(aIDX) = aY : ShuffleArrays YcoefIn, YcoefOut, 0
    End Select
    if gametime > 100 then Report aChooseArray
  End Sub

  Public Sub Report(aChooseArray)   'debug, reports all coords in tbPL.text
    if not DebugOn then exit sub
    dim a1, a2 : Select Case aChooseArray
      case "Polarity" : a1 = PolarityIn : a2 = PolarityOut
      Case "Velocity" : a1 = VelocityIn : a2 = VelocityOut
      Case "Ycoef" : a1 = YcoefIn : a2 = YcoefOut
      case else :tbpl.text = "wrong string" : exit sub
    End Select
    dim str, x : for x = 0 to uBound(a1) : str = str & aChooseArray & " x: " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    tbpl.text = str
  End Sub

  Public Sub AddBall(aBall) : dim x : for x = 0 to uBound(balls) : if IsEmpty(balls(x)) then set balls(x) = aBall : exit sub :end if : Next  : End Sub

  Private Sub RemoveBall(aBall)
    dim x : for x = 0 to uBound(balls)
      if TypeName(balls(x) ) = "IBall" then
        if aBall.ID = Balls(x).ID Then
          balls(x) = Empty
          Balldata(x).Reset
        End If
      End If
    Next
  End Sub

  Public Sub Fire()
    Flipper.RotateToEnd
    processballs
  End Sub

  Public Property Get Pos 'returns % position a ball. For debug stuff.
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        pos = pSlope(Balls(x).x, FlipperStart, 0, FlipperEnd, 1)
      End If
    Next
  End Property

  Public Sub ProcessBalls() 'save data of balls in flipper range
    FlipAt = GameTime
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        balldata(x).Data = balls(x)
      End If
    Next
    PartialFlipCoef = ((Flipper.StartAngle - Flipper.CurrentAngle) / (Flipper.StartAngle - Flipper.EndAngle))
    PartialFlipCoef = abs(PartialFlipCoef-1)
  End Sub
  Private Function FlipperOn() : if gameTime < FlipAt+TimeDelay then FlipperOn = True : End If : End Function 'Timer shutoff for polaritycorrect

  Public Sub PolarityCorrect(aBall)
    if FlipperOn() then
      dim tmp, BallPos, x, IDX, Ycoef : Ycoef = 1

      'y safety Exit
      if aBall.VelY > -8 then 'ball going down
        RemoveBall aBall
        exit Sub
      end if

      'Find balldata. BallPos = % on Flipper
      for x = 0 to uBound(Balls)
        if aBall.id = BallData(x).id AND not isempty(BallData(x).id) then
          idx = x
          BallPos = PSlope(BallData(x).x, FlipperStart, 0, FlipperEnd, 1)
          if ballpos > 0.65 then  Ycoef = LinearEnvelope(BallData(x).Y, YcoefIn, YcoefOut)        'find safety coefficient 'ycoef' data
        end if
      Next

      If BallPos = 0 Then 'no ball data meaning the ball is entering and exiting pretty close to the same position, use current values.
        BallPos = PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1)
        if ballpos > 0.65 then  Ycoef = LinearEnvelope(aBall.Y, YcoefIn, YcoefOut)            'find safety coefficient 'ycoef' data
      End If

      'Velocity correction
      if not IsEmpty(VelocityIn(0) ) then
        Dim VelCoef
   :      VelCoef = LinearEnvelope(BallPos, VelocityIn, VelocityOut)

        if partialflipcoef < 1 then VelCoef = PSlope(partialflipcoef, 0, 1, 1, VelCoef)

        if Enabled then aBall.Velx = aBall.Velx*VelCoef
        if Enabled then aBall.Vely = aBall.Vely*VelCoef
      End If

      'Polarity Correction (optional now)
      if not IsEmpty(PolarityIn(0) ) then
        If StartPoint > EndPoint then LR = -1 'Reverse polarity if left flipper
        dim AddX : AddX = LinearEnvelope(BallPos, PolarityIn, PolarityOut) * LR

        if Enabled then aBall.VelX = aBall.VelX + 1 * (AddX*ycoef*PartialFlipcoef)
        'playsound "fx_knocker"
      End If
    End If
    RemoveBall aBall
  End Sub
End Class

'******************************************************
'   FLIPPER POLARITY AND RUBBER DAMPENER
'     SUPPORTING FUNCTIONS
'******************************************************

' Used for flipper correction and rubber dampeners
Sub ShuffleArray(ByRef aArray, byVal offset) 'shuffle 1d array
  dim x, aCount : aCount = 0
  redim a(uBound(aArray) )
  for x = 0 to uBound(aArray) 'Shuffle objects in a temp array
    if not IsEmpty(aArray(x) ) Then
      if IsObject(aArray(x)) then
        Set a(aCount) = aArray(x)
      Else
        a(aCount) = aArray(x)
      End If
      aCount = aCount + 1
    End If
  Next
  if offset < 0 then offset = 0
  redim aArray(aCount-1+offset) 'Resize original array
  for x = 0 to aCount-1   'set objects back into original array
    if IsObject(a(x)) then
      Set aArray(x) = a(x)
    Else
      aArray(x) = a(x)
    End If
  Next
End Sub

' Used for flipper correction and rubber dampeners
Sub ShuffleArrays(aArray1, aArray2, offset)
  ShuffleArray aArray1, offset
  ShuffleArray aArray2, offset
End Sub

' Used for flipper correction, rubber dampeners, and drop targets
Function BallSpeed(ball) 'Calculates the ball speed
    BallSpeed = SQR(ball.VelX^2 + ball.VelY^2 + ball.VelZ^2)
End Function

' Used for flipper correction and rubber dampeners
Function PSlope(Input, X1, Y1, X2, Y2)  'Set up line via two points, no clamping. Input X, output Y
  dim x, y, b, m : x = input : m = (Y2 - Y1) / (X2 - X1) : b = Y2 - m*X2
  Y = M*x+b
  PSlope = Y
End Function

' Used for flipper correction
Class spoofball
  Public X, Y, Z, VelX, VelY, VelZ, ID, Mass, Radius
  Public Property Let Data(aBall)
    With aBall
      x = .x : y = .y : z = .z : velx = .velx : vely = .vely : velz = .velz
      id = .ID : mass = .mass : radius = .radius
    end with
  End Property
  Public Sub Reset()
    x = Empty : y = Empty : z = Empty  : velx = Empty : vely = Empty : velz = Empty
    id = Empty : mass = Empty : radius = Empty
  End Sub
End Class

' Used for flipper correction and rubber dampeners
Function LinearEnvelope(xInput, xKeyFrame, yLvl)
  dim y 'Y output
  dim L 'Line
  dim ii : for ii = 1 to uBound(xKeyFrame)  'find active line
    if xInput <= xKeyFrame(ii) then L = ii : exit for : end if
  Next
  if xInput > xKeyFrame(uBound(xKeyFrame) ) then L = uBound(xKeyFrame)  'catch line overrun
  Y = pSlope(xInput, xKeyFrame(L-1), yLvl(L-1), xKeyFrame(L), yLvl(L) )

  if xInput <= xKeyFrame(lBound(xKeyFrame) ) then Y = yLvl(lBound(xKeyFrame) )  'Clamp lower
  if xInput >= xKeyFrame(uBound(xKeyFrame) ) then Y = yLvl(uBound(xKeyFrame) )  'Clamp upper

  LinearEnvelope = Y
End Function

' Used for drop targets and flipper tricks
Function Distance(ax,ay,bx,by)
  Distance = SQR((ax - bx)^2 + (ay - by)^2)
End Function

'******************************************************
'     FLIPPER TRICKS
'******************************************************

RightFlipper.timerinterval=1
Rightflipper.timerenabled=True

sub RightFlipper_timer()
  FlipperTricks LeftFlipper, LFPress, LFCount, LFEndAngle, LFState
  FlipperTricks RightFlipper, RFPress, RFCount, RFEndAngle, RFState
  FlipperNudge RightFlipper, RFEndAngle, RFEOSNudge, LeftFlipper, LFEndAngle
  FlipperNudge LeftFlipper, LFEndAngle, LFEOSNudge,  RightFlipper, RFEndAngle
end sub

Dim LFEOSNudge, RFEOSNudge

Sub FlipperNudge(Flipper1, Endangle1, EOSNudge1, Flipper2, EndAngle2)
        Dim BOT, b

        If Flipper1.currentangle = Endangle1 and EOSNudge1 <> 1 Then
                EOSNudge1 = 1
                'debug.print Flipper1.currentangle &" = "& Endangle1 &"--"& Flipper2.currentangle &" = "& EndAngle2
                If Flipper2.currentangle = EndAngle2 Then
                        BOT = GetBalls
                        For b = 0 to Ubound(BOT)
                                If FlipperTrigger(BOT(b).x, BOT(b).y, Flipper1) Then
                                        'Debug.Print "ball in flip1. exit"
                                         exit Sub
                                end If
                        Next
                        For b = 0 to Ubound(BOT)
                                If FlipperTrigger(BOT(b).x, BOT(b).y, Flipper2) Then
                                        BOT(b).velx = BOT(b).velx / 1.5
                                        BOT(b).vely = BOT(b).vely - 0.5
'                   debug.print "nudge"
                                end If
                        Next
                End If
        Else
      If Abs(Flipper1.currentangle) > Abs(EndAngle1) + 30 then
        EOSNudge1 = 0
      end if
        End If
End Sub

'*************************************************
' Check ball distance from Flipper for Rem
'*************************************************

Function Distance(ax,ay,bx,by)
  Distance = SQR((ax - bx)^2 + (ay - by)^2)
End Function

Function DistancePL(px,py,ax,ay,bx,by) ' Distance between a point and a line where point is px,py
  DistancePL = ABS((by - ay)*px - (bx - ax) * py + bx*ay - by*ax)/Distance(ax,ay,bx,by)
End Function

Function Radians(Degrees)
  Radians = Degrees * PI /180
End Function

Function AnglePP(ax,ay,bx,by)
  AnglePP = Atn2((by - ay),(bx - ax))*180/PI
End Function

Function DistanceFromFlipper(ballx, bally, Flipper)
  DistanceFromFlipper = DistancePL(ballx, bally, Flipper.x, Flipper.y, Cos(Radians(Flipper.currentangle+90))+Flipper.x, Sin(Radians(Flipper.currentangle+90))+Flipper.y)
End Function

Function FlipperTrigger(ballx, bally, Flipper)
  Dim DiffAngle
  DiffAngle  = ABS(Flipper.currentangle - AnglePP(Flipper.x, Flipper.y, ballx, bally) - 90)
  If DiffAngle > 180 Then DiffAngle = DiffAngle - 360

  If DistanceFromFlipper(ballx,bally,Flipper) < 48 and DiffAngle <= 90 and Distance(ballx,bally,Flipper.x,Flipper.y) < Flipper.Length Then
    FlipperTrigger = True
  Else
    FlipperTrigger = False
  End If
End Function

'*************************************************
' End - Check ball distance from Flipper for Rem
'*************************************************

dim LFPress, RFPress, LFCount, RFCount
dim LFState, RFState
dim EOST, EOSA,Frampup, FElasticity,FReturn
dim RFEndAngle, LFEndAngle

EOST = leftflipper.eostorque
EOSA = leftflipper.eostorqueangle
Frampup = LeftFlipper.rampup
FElasticity = LeftFlipper.elasticity
FReturn = LeftFlipper.return
Const EOSTnew = 0.8
Const EOSAnew = 1
Const EOSRampup = 0
Const SOSRampup = 2.5
Const LiveCatch = 16
Const LiveElasticity = 0.45
Const SOSEM = 0.815
Const EOSReturn = 0.025

LFEndAngle = Leftflipper.endangle
RFEndAngle = RightFlipper.endangle

Sub FlipperActivate(Flipper, FlipperPress)
  FlipperPress = 1
  Flipper.Elasticity = FElasticity

  Flipper.eostorque = EOST
  Flipper.eostorqueangle = EOSA
End Sub

Sub FlipperDeactivate(Flipper, FlipperPress)
  FlipperPress = 0
  Flipper.eostorqueangle = EOSA
  Flipper.eostorque = EOST*EOSReturn/FReturn


  If Abs(Flipper.currentangle) <= Abs(Flipper.endangle) + 0.1 Then
    Dim BOT, b
    BOT = GetBalls

    For b = 0 to UBound(BOT)
      If Distance(BOT(b).x, BOT(b).y, Flipper.x, Flipper.y) < 55 Then 'check for cradle
        If BOT(b).vely >= -0.4 Then BOT(b).vely = -0.4
      End If
    Next
  End If
End Sub

Sub FlipperTricks (Flipper, FlipperPress, FCount, FEndAngle, FState)
  Dim Dir
  Dir = Flipper.startangle/Abs(Flipper.startangle)  '-1 for Right Flipper

  If Abs(Flipper.currentangle) > Abs(Flipper.startangle) - 0.05 Then
    If FState <> 1 Then
      Flipper.rampup = SOSRampup
      Flipper.endangle = FEndAngle - 3*Dir
      Flipper.Elasticity = FElasticity * SOSEM
      FCount = 0
      FState = 1
    End If
  ElseIf Abs(Flipper.currentangle) <= Abs(Flipper.endangle) and FlipperPress = 1 then
    if FCount = 0 Then FCount = GameTime

    If FState <> 2 Then
      Flipper.eostorqueangle = EOSAnew
      Flipper.eostorque = EOSTnew
      Flipper.rampup = EOSRampup
      Flipper.endangle = FEndAngle
      FState = 2
    End If
  Elseif Abs(Flipper.currentangle) > Abs(Flipper.endangle) + 0.01 and FlipperPress = 1 Then
    If FState <> 3 Then
      Flipper.eostorque = EOST
      Flipper.eostorqueangle = EOSA
      Flipper.rampup = Frampup
      Flipper.Elasticity = FElasticity
      FState = 3
    End If

  End If
End Sub

Const LiveDistanceMin = 30  'minimum distance in vp units from flipper base live catch dampening will occur
Const LiveDistanceMax = 114  'maximum distance in vp units from flipper base live catch dampening will occur (tip protection)

Sub CheckLiveCatch(ball, Flipper, FCount, parm) 'Experimental new live catch
  Dim Dir
  Dir = Flipper.startangle/Abs(Flipper.startangle)    '-1 for Right Flipper
  Dim LiveCatchBounce                             'If live catch is not perfect, it won't freeze ball totally
  Dim CatchTime : CatchTime = GameTime - FCount

  if CatchTime <= LiveCatch and parm > 6 and ABS(Flipper.x - ball.x) > LiveDistanceMin and ABS(Flipper.x - ball.x) < LiveDistanceMax Then
    if CatchTime <= LiveCatch*0.5 Then            'Perfect catch only when catch time happens in the beginning of the window
      LiveCatchBounce = 0
    else
      LiveCatchBounce = Abs((LiveCatch/2) - CatchTime)  'Partial catch when catch happens a bit late
    end If

    If LiveCatchBounce = 0 and ball.velx * Dir > 0 Then ball.velx = 0
    ball.vely = LiveCatchBounce * (32 / LiveCatch) ' Multiplier for inaccuracy bounce
    ball.angmomx= 0
    ball.angmomy= 0
    ball.angmomz= 0
    Else
        If Abs(Flipper.currentangle) <= Abs(Flipper.endangle) + 1 Then FlippersD.Dampenf Activeball, parm, 1
  End If
End Sub

Sub LeftFlipper_Collide(parm)
  CheckLiveCatch Activeball, LeftFlipper, LFCount, parm
  LeftFlipperCollide parm
End Sub

Sub RightFlipper_Collide(parm)
  CheckLiveCatch Activeball, RightFlipper, RFCount, parm
  RightFlipperCollide parm
End Sub

Const TargetBouncerFactor = 0.7   'Level of bounces. Recommmended value of 0.7
sub TargetBouncer(aBall,defvalue)
    dim zMultiplier, vel, vratio
    'debug.print "velx: " & aball.velx & " vely: " & aball.vely & " velz: " & aball.velz
  vel = BallSpeed(aBall)
  if aBall.velx = 0 then vratio = 1 else vratio = aBall.vely/aBall.velx
  Select Case Int(Rnd * 6) + 1
    Case 1: zMultiplier = 0.2*defvalue
    Case 2: zMultiplier = 0.25*defvalue
    Case 3: zMultiplier = 0.3*defvalue
    Case 4: zMultiplier = 0.4*defvalue
    Case 5: zMultiplier = 0.45*defvalue
    Case 6: zMultiplier = 0.5*defvalue
  End Select
  aBall.velz = abs(vel * zMultiplier * TargetBouncerFactor)
  aBall.velx = sgn(aBall.velx) * sqr(abs((vel^2 - aBall.velz^2)/(1+vratio^2)))
  aBall.vely = aBall.velx * vratio
  'debug.print "---> velx: " & aball.velx & " vely: " & aball.vely & " velz: " & aball.velz
  'debug.print "conservation check: " & BallSpeed(aBall)/vel
end sub

'****************************************************************************
'PHYSICS DAMPENERS

'These are data mined bounce curves,
'dialed in with the in-game elasticity as much as possible to prevent angle / spin issues.
'Requires tracking ballspeed to calculate COR


Sub dPosts_Hit(idx)
  RubbersD.dampen Activeball
  TargetBouncer Activeball, 1
End Sub

Sub dSleeves_Hit(idx)
  SleevesD.Dampen Activeball
  TargetBouncer Activeball, 0.7
End Sub


dim RubbersD : Set RubbersD = new Dampener  'frubber
RubbersD.name = "Rubbers"
RubbersD.debugOn = False  'shows info in textbox "TBPout"
RubbersD.Print = False  'debug, reports in debugger (in vel, out cor)
'cor bounce curve (linear)
'for best results, try to match in-game velocity as closely as possible to the desired curve
'RubbersD.addpoint 0, 0, 0.935  'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 0, 0, 0.96  'point# (keep sequential), ballspeed, CoR (elasticity)
RubbersD.addpoint 1, 3.77, 0.96
RubbersD.addpoint 2, 5.76, 0.967  'dont take this as gospel. if you can data mine rubber elasticitiy, please help!
RubbersD.addpoint 3, 15.84, 0.874
RubbersD.addpoint 4, 56, 0.64 'there's clamping so interpolate up to 56 at least

dim SleevesD : Set SleevesD = new Dampener  'this is just rubber but cut down to 85%...
SleevesD.name = "Sleeves"
SleevesD.debugOn = False  'shows info in textbox "TBPout"
SleevesD.Print = False  'debug, reports in debugger (in vel, out cor)
SleevesD.CopyCoef RubbersD, 0.85

dim FlippersD : Set FlippersD = new Dampener
FlippersD.name = "Flippers"
FlippersD.debugOn = False
FlippersD.Print = False
FlippersD.addpoint 0, 0, 1.1
FlippersD.addpoint 1, 3.77, 0.99
FlippersD.addpoint 2, 6, 0.99

'######################### Add Dampenf to Dampener Class
'#########################    Only applies dampener when abs(velx) < 2 and vely < 0 and vely > -3.75


Class Dampener
  Public Print, debugOn 'tbpOut.text
  public name, Threshold  'Minimum threshold. Useful for Flippers, which don't have a hit threshold.
  Public ModIn, ModOut
  Private Sub Class_Initialize : redim ModIn(0) : redim Modout(0): End Sub

  Public Sub AddPoint(aIdx, aX, aY)
    ShuffleArrays ModIn, ModOut, 1 : ModIn(aIDX) = aX : ModOut(aIDX) = aY : ShuffleArrays ModIn, ModOut, 0
    if gametime > 100 then Report
  End Sub

  public sub Dampen(aBall)
    if threshold then if BallSpeed(aBall) < threshold then exit sub end if end if
    dim RealCOR, DesiredCOR, str, coef
    DesiredCor = LinearEnvelope(cor.ballvel(aBall.id), ModIn, ModOut )
    RealCOR = BallSpeed(aBall) / cor.ballvel(aBall.id)
    coef = desiredcor / realcor
    if debugOn then str = name & " in vel:" & round(cor.ballvel(aBall.id),2 ) & vbnewline & "desired cor: " & round(desiredcor,4) & vbnewline & _
    "actual cor: " & round(realCOR,4) & vbnewline & "ballspeed coef: " & round(coef, 3) & vbnewline
    if Print then debug.print Round(cor.ballvel(aBall.id),2) & ", " & round(desiredcor,3)

' Thalamus - patched :     aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef
    aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef : aBall.velz = aBall.velz * coef
    if debugOn then TBPout.text = str
  End Sub

  public sub Dampenf(aBall, parm, ver)
    If ver = 1 Then
      dim RealCOR, DesiredCOR, str, coef
      DesiredCor = LinearEnvelope(cor.ballvel(aBall.id), ModIn, ModOut )
      RealCOR = BallSpeed(aBall) / cor.ballvel(aBall.id)
      coef = desiredcor / realcor
      If abs(aball.velx) < 2 and aball.vely < 0 and aball.vely > -3.75 then
' Thalamus - patched :         aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef
    aBall.velx = aBall.velx * coef : aBall.vely = aBall.vely * coef : aBall.velz = aBall.velz * coef
      End If
    End If
  End Sub

  Public Sub CopyCoef(aObj, aCoef) 'alternative addpoints, copy with coef
    dim x : for x = 0 to uBound(aObj.ModIn)
      addpoint x, aObj.ModIn(x), aObj.ModOut(x)*aCoef
    Next
  End Sub


  Public Sub Report()   'debug, reports all coords in tbPL.text
    if not debugOn then exit sub
    dim a1, a2 : a1 = ModIn : a2 = ModOut
    dim str, x : for x = 0 to uBound(a1) : str = str & x & ": " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    TBPout.text = str
  End Sub


End Class
'******************************************************
'   TRACK ALL BALL VELOCITIES
'     FOR RUBBER DAMPENER AND DROP TARGETS
'******************************************************

dim cor : set cor = New CoRTracker

Class CoRTracker
  public ballvel, ballvelx, ballvely

  Private Sub Class_Initialize : redim ballvel(0) : redim ballvelx(0): redim ballvely(0) : End Sub

  Public Sub Update() 'tracks in-ball-velocity
    dim str, b, AllBalls, highestID : allBalls = getballs

    for each b in allballs
      if b.id >= HighestID then highestID = b.id
    Next

    if uBound(ballvel) < highestID then redim ballvel(highestID)  'set bounds
    if uBound(ballvelx) < highestID then redim ballvelx(highestID)  'set bounds
    if uBound(ballvely) < highestID then redim ballvely(highestID)  'set bounds

    for each b in allballs
      ballvel(b.id) = BallSpeed(b)
      ballvelx(b.id) = b.velx
      ballvely(b.id) = b.vely
    Next
  End Sub
End Class


'
'************************************************************************
'           SLINGSHOTS
'************************************************************************

'Magna Slings
Sub SolMiniMagnet(aMag, enabled)
  'If MagnaSlings = 1 Then
    If enabled Then
    'PlayLoopSoundAtVol SoundFXDOFALT("fx_magnet",122,DOFOn,DOFShaker), aMag, 1
    aMag.MagnetOn = True : aMag.Update: aMag.MagnetOn = False 'Fast Pulse
  Else
    DOFALT 122, DOFOff
    StopSound "fx_magnet"
    End If
  'End If
End Sub

'Slingshots
Sub sw7_Hit:vpmTimer.PulseSw 7:DOFALT 105, DOFPulse:End Sub
Sub sw8_Hit:vpmTimer.PulseSw 8:DOFALT 106, DOFPulse:End Sub

'Normal Slings
Dim LStep, RStep

Sub sw7a_Slingshot
  vpmTimer.PulseSw 7:DOFALT 105, DOFPulse
  'PlaySoundAt SoundFXDOFALT("LeftSlingshot",103,DOFPulse,DOFContactors), ActiveBall
    LSling.Visible = 0 : LSling1.Visible = 1 :sling1.TransZ = -20
    LStep = 0 : Me.TimerInterval = 30 : Me.TimerEnabled = 1
End Sub

Sub sw8a_Slingshot
  vpmTimer.PulseSw 8:DOFALT 106, DOFPulse
  'PlaySoundAt SoundFXDOFALT("RightSlingshot",104,DOFPulse,DOFContactors), ActiveBall
    RSling.Visible = 0 : RSling1.Visible = 10 : sling2.TransZ = -20
    RStep = 0 : Me.TimerInterval = 30 : Me.TimerEnabled = 1
End Sub

Sub sw7a_Timer
    Select Case LStep
        Case 3:LSLing1.Visible = 0:LSLing2.Visible = 1:sling1.TransZ = -10
        Case 4:LSLing2.Visible = 0:LSLing.Visible = 1:sling1.TransZ = 0:Me.TimerEnabled = 0
    End Select
    LStep = LStep + 1
End Sub

Sub sw8a_Timer
    Select Case RStep
        Case 3:RSLing1.Visible = 0:RSLing2.Visible = 1:sling2.TransZ = -10
        Case 4:RSLing2.Visible = 0:RSLing.Visible = 1:sling2.TransZ = 0:Me.TimerEnabled = 0
    End Select
    RStep = RStep + 1
End Sub

'************************************************************************
'            SHAKER MOTOR
'************************************************************************
Sub SolShaker(Enabled)
  If Enabled Then
    DOFALT 123, DOFOn
    osce=0.5          'shake slimer
    cBall.VelX = 0.2'25     'shake staypuft
  Else
    DOFALT 123, DOFOff
  End If
End Sub

'************************************************************************
'            LEFT SCOOP
'************************************************************************

Sub SolLeftEject(enabled)
  If Enabled Then
    DOFALT 125, DOFPulse
    DOFALT 121, DOFPulse
    bsLSaucer.ExitSol_On
    sw34.Enabled=0
    vpmTimer.AddTimer 200, "sw34.Enabled=1 '"
    PlaySoundAt SoundFX("Saucer_Kick",DOFContactors), sw34
  End If
End Sub

'************************************************************************
'         CAPTIVEBALL LOCK POST
'************************************************************************
Sub SolLockPost(Enabled)
  If enabled Then
    DOFALT 126, DOFPulse
    LockPost.IsDropped=1:PlaySoundAt SoundFX("fx_postdown",DOFContactors),sw31
  Else
    DOFALT 126, DOFPulse
    LockPost.IsDropped=0:PlaySoundAt SoundFX("fx_postup",DOFContactors), sw31
  End If
End Sub

'************************************************************************
'           SUBWAY LOCK
'************************************************************************
Sub SolSubwayLock(Enabled)
  If Enabled Then
    DOFALT 129, DOFPulse
    bsLock.ExitSol_On
  End If
End Sub

'************************************************************************
'           SPINNER POST
'************************************************************************
Sub SolUpPost(Enabled)
  If enabled Then
    DOFALT 126, DOFPulse
    UpPost.IsDropped=0:PlaySoundAt SoundFX("fx_postup",DOFContactors), sw36
  Else
    DOFALT 126, DOFPulse
    UpPost.IsDropped=1:PlaySoundAt SoundFX("fx_postdown",DOFContactors),sw36
  End If
End Sub

'************************************************************************
'            SUBWAY
'************************************************************************

Sub kicker3_hit
  StopSound "fx_wireramp_enter": PlaysoundAt "fx_wireramp_exit", ActiveBall: me.destroyball
  Me.TimerInterval=300: Me.TimerEnabled=1
End Sub

Sub kicker3_timer
  Me.TimerEnabled = 0
  kicker2.createSizedBallWithMass BallSize/2, BallMass:kicker2.kick 180,30
End Sub

Sub SubwaySnd_Hit:PlaySoundAt "Subway_enter", ActiveBall : End Sub
Sub SubwaySnd1_hit:PlaysoundAt "Subway_exit", ActiveBall: End Sub

Sub SolSubwayDiverter(Enabled)
  If Enabled Then
    DOFALT 128, DOFPulse
    DiverterOff.IsDropped=1:DiverterOn.IsDropped=0:PlaySoundAt SoundFX("DiverterOn",DOFContactors),SubwayLockIn
  Else
    DOFALT 128, DOFPulse
    DiverterOff.IsDropped=0:DiverterOn.IsDropped=1:PlaySoundAt SoundFX("DiverterOff",DOFContactors),SubwayLockIn
  End If
End Sub

Sub SolSubwayEject(enabled)
  If Enabled Then
    DOFALT 130, DOFPulse
    DOFALT 121, DOFPulse
    bsRPopper.ExitSol_On
    sw63.Enabled=0
    vpmTimer.AddTimer 200, "sw63.Enabled=1 '"
    PlaySoundAt SoundFX("Saucer_Kick",DOFContactors), sw34
  End If
End Sub

'************************************************************************
'            SLIMER MOVE
'************************************************************************

' 71-72-73  slimer encoder wheel

Dim CurSlimerPos:CurSlimerPos = 0
Const SlimerSpeed = 0.33
dim LastMotorTime:LastMotorTime = 0
dim lastMotorDirection:lastMotorDirection = 0

sub slimerbracket_timer()
If LampState(281) <92 Then
  ' Don't move directly to ROM position - move incrementally towards it.
  if CurSlimerPos < (LampState(281)*1.85)-110-SlimerSpeed then
    CurSlimerPos = CurSlimerPos + SlimerSpeed
    LastMotorTime = Timer
    if lastMotorDirection <> -1 Then
      ChangeSlimerDirection -1
    end if
  Elseif CurSlimerPos > (LampState(281)*1.85)-110 then
    CurSlimerPos = CurSlimerPos - SlimerSpeed
    LastMotorTime = Timer
    if lastMotorDirection <> 1 Then
      ChangeSlimerDirection 1
    end if
  Elseif LastMotorTime > 0 and Timer > LastMotorTime + 0.08 then
    ChangeSlimerDirection 0
    LastMotorTime = 0
  Else

  End If

    slimerB.rotz=CurSlimerPos
    slimer.rotz=slimerb.rotz

    slimer.X=((280* dCOS(slimerB.rotZ+90))+310)
    slimer.y=(270* dSIN(slimerB.rotZ+90))+500
  slimer.z=((slimer.y/2.7)*-1)+400

  SlimerLight.x=slimer.x
  SlimerLight.y=slimer.y

  SlimerLighta.x=slimer.x
  SlimerLighta.y=slimer.y
  slimerlighta.BulbHaloHeight = slimer.z

  slimershadow.x=((slimer.x-(slimer.z))+100)+slimer.roty
  slimershadow.y=slimer.y
  slimershadow.rotz=(slimer.rotz-90)/1.2
  slimershadow.size_y=abs(slimer.roty*1.2)+10

  SlimerOscUpdate:SlimerPlasticHit

  dim xx : For each xx in SLWalls:xx.IsDropped=1:Next
  For each xx in SLBack:xx.IsDropped=1:Next
  Dim WallPos:WallPos = int((CurSlimerPos + 45) / 5.2)

  if WallPos>=0 and WallPos < SLWalls.Count Then
    SLWalls(WallPos).IsDropped=0
    SLBack(WallPos).IsDropped=0
  end if
else ' Stop motor sound
    osce=1:osc=0
    StopSound "SlimerMotor"
    DOFALT 138, DOFOff
End If
end Sub

sub ChangeSlimerDirection(cur)
   if (lastMotorDirection = -1 and cur = 1) or (lastMotorDirection = 1 and cur= -1) then ' big change in direction - oscillate high intensity
    osce=2:osc=0
'   debug.print "Shift"
   elseif cur = 0  then ' Stop
    osce=1:osc=0
    StopSound "SlimerMotor"
    DOFALT 138, DOFOff
'   debug.print "Stop"
   Else ' Start
    osce=.5:osc=0
    PlayLoopSoundAtVol SoundFXDOFALT("SlimerMotor",138,DOFOn,DOFGear), 0.25, slimer
'   debug.print "Start"
  end if
   lastMotorDirection = cur
end sub

'************************************************************************
'       SLIMER LEFT PLASTIC HIT
'************************************************************************
Dim cdir

Sub SlimerPlasticHit()
if lastMotorDirection=-1 and (slimerB.rotz>45 or slimerB.rotz<15) then cdir=-1:slimer.objroty=0
if lastMotorDirection=1 and (slimerB.rotz>45 or slimerB.rotz<15) then cdir=1:slimer.objroty=0

   if (cdir=-1) and (slimerB.rotz>15 and slimerB.rotz<45) then slimer.objroty=-((slimerB.rotz-15)*2.6)
   if (cdir=-1) and (slimerB.rotz>45 and slimerB.rotz<46) then osce=2

   if (cdir=1) and (slimerB.rotz>15 and slimerB.rotz<48) then slimer.objroty=((45-(slimerB.rotz))*3.2)
   if (cdir=1) and (slimerB.rotz>14 and slimerB.rotz<15) then osce=4
end sub

'************************************************************************
'            SLIMER OSCILLATION
'************************************************************************
dim osc,oscE:oscE=1

sub SlimerOscUpdate()
  if CurSlimerPos > -55 and CurSlimerPos < -53 Then
    ' Ghost "bumps" into play area, also stunts hit shaking
    osce=2
    'slbreak=0
  end if
  dim doupdate:doupdate = false
  if osce>0 then
    osc=osc+1
    oscE=osce-0.03
    doupdate = true
  end if
  if slbreak>0 then
    slbreak=slbreak-0.02
    slrotx=slrotx+1
    doupdate = true
  end if
  if doupdate then
    slimer.roty=(dsin(osc*45)*3)*oscE
    slimer.rotx=slimer.roty + (dCos (slrotx*20)*45)*slbreak
  Else
    ShakeSlimerOnNudge
  End If
end sub

'************************************************************************
'            SLIMER HIT
'************************************************************************
dim slrotx,slbreak:slbreak=0

sub SlWalls_hit(idx)
  vpmtimer.pulseSw 68
    Slwalls(idx).isdropped=1
    SlBack(idx).isdropped=1
    slbreak=Csng(BallVel(ActiveBall) ^2 / 200)
  if slbreak > 1.5 then slbreak = 1.5
    slrotx=2
end Sub

sub SlBack_hit(idx)
    Slwalls(idx).isdropped=1
    SlBack(idx).isdropped=1
    slbreak=Csng(BallVel(ActiveBall) ^2 / 300)
  if slbreak > 1.5 then slbreak = 1.5
    slrotx=2
end Sub

'************************************************************************
'           TOYS SHAKE ON NUDGE
'************************************************************************

Dim mMagnet, cBall

Sub WobbleMagnet_Init
   Set mMagnet = new cvpmMagnet
   With mMagnet
    .InitMagnet WobbleMagnet, 2
    .Size = 100
    .CreateEvents mMagnet
    .MagnetOn = True
   End With
  Set cBall = ckicker.createball:ckicker.Kick 0,0:mMagnet.addball cball
End Sub

Sub ShakeTimer_Timer
  ShakeStayPuftOnNudge
end Sub

Sub ShakeSlimerOnNudge
  slimer.roty= (dsin(osc*45)*3)*oscE + (cball.x - ckicker.x)
  slimer.rotx= slimer.roty + (dCos (slrotx*15)*45)*slbreak + (0.33-(ckicker.y - cball.y))
End Sub

Sub ShakeStayPuftOnNudge
  staypuft.roty=(cball.x - ckicker.x)*2
End Sub

'************************************************************************
'         SCOLERI'S DROP TARGETS
'************************************************************************

Sub SolRaiseLDrop(enabled)
  If enabled Then dtLeft.SolDropUp True: l112a.visible = True:DOFALT 119, DOFPulse
End Sub

Sub SolRaiseRDrop(enabled)
  If enabled Then dtRight.SolDropUp True: l113a.visible = True:DOFALT 119, DOFPulse
End Sub

Sub SolLowerLDrop(enabled)
  If enabled Then dtLeft.SolDropDown True: l112a.visible = False:DOFALT 119, DOFPulse
End Sub

Sub SolLowerRDrop(enabled)
  If enabled Then dtRight.SolDropDown True: l113a.visible = False:DOFALT 119, DOFPulse
End Sub

'************************************************************************
'           SWITCHES
'************************************************************************

'rollovers
Sub sw1_hit: Controller.Switch(1) = 1 : End Sub
Sub sw1_unhit:Controller.Switch(1) = 0: End Sub

Sub sw2_hit: Controller.Switch(2) = 1 : End Sub
Sub sw2_unhit:Controller.Switch(2) = 0: End Sub

Sub sw3_hit: Controller.Switch(3) = 1 : End Sub
Sub sw3_unhit:Controller.Switch(3) = 0: End Sub

Sub sw4_hit: Controller.Switch(4) = 1 : End Sub
Sub sw4_unhit:Controller.Switch(4) = 0: End Sub

Sub sw5_hit: Controller.Switch(5) = 1 : End Sub
Sub sw5_unhit:Controller.Switch(5) = 0: End Sub

Sub sw6_hit: Controller.Switch(6) = 1 : End Sub
Sub sw6_unhit:Controller.Switch(6) = 0: End Sub

Sub sw22_hit: Controller.Switch(22) = 1 : End Sub
Sub sw22_unhit:Controller.Switch(22) = 0: End Sub

Sub sw52_hit: Controller.Switch(52) = 1 : End Sub
Sub sw52_unhit:Controller.Switch(52) = 0: End Sub

Sub sw54_hit:vpmTimer.PulseSw 54 : DOFALT 134, DOFPulse:End Sub   'use pulsesw to trigger events

Sub sw55_hit: vpmTimer.PulseSw 55 : DOFALT 135, DOFPulse:End Sub    'use pulsesw to trigger events

Sub sw56_hit: Controller.Switch(56) = 1 : DOFALT 131, DOFOn:End Sub
Sub sw56_unhit:Controller.Switch(56) = 0: DOFALT 131, DOFOff : End Sub

Sub sw57_hit: Controller.Switch(57) = 1 : DOFALT 132, DOFOn:End Sub
Sub sw57_unhit:Controller.Switch(57) = 0: DOFALT 132, DOFOff : End Sub

Sub sw58_hit: Controller.Switch(58) = 1 : DOFALT 133, DOFOn:End Sub
Sub sw58_unhit:Controller.Switch(58) = 0: DOFALT 133, DOFOff : End Sub

'StandUp Targets
Sub sw24_hit:vpmtimer.PulseSw 24: DOFALT 113, DOFPulse:End Sub
Sub sw25_hit:vpmtimer.PulseSw 25: DOFALT 113, DOFPulse:End Sub
Sub sw26_hit:vpmtimer.PulseSw 26: DOFALT 113, DOFPulse:End Sub

Sub sw37_hit:vpmtimer.PulseSw 37: DOFALT 114, DOFPulse:End Sub
Sub sw38_hit:vpmtimer.PulseSw 38: DOFALT 114, DOFPulse:End Sub

Sub sw45_hit:vpmtimer.PulseSw 45: DOFALT 115, DOFPulse:End Sub
Sub sw46_hit:vpmtimer.PulseSw 46: DOFALT 115, DOFPulse:End Sub
Sub sw48_hit:vpmtimer.PulseSw 48: DOFALT 114, DOFPulse:End Sub

Sub sw64_hit:vpmtimer.PulseSw 64: DOFALT 116, DOFPulse:End Sub

'captive lock rollovers
Sub sw28_hit: Controller.Switch(28) = 1 : End Sub
Sub sw28_unhit:Controller.Switch(28) = 0: End Sub

Sub sw29_hit: Controller.Switch(29) = 1 : End Sub
Sub sw29_unhit:Controller.Switch(29) = 0: End Sub

Sub sw30_hit: Controller.Switch(30) = 1 : End Sub
Sub sw30_unhit:Controller.Switch(30) = 0: End Sub

Sub sw31_hit: Controller.Switch(31) = 1 : End Sub
Sub sw31_unhit:Controller.Switch(31) = 0: End Sub

Sub sw32_hit: Controller.Switch(32) = 1 : End Sub
Sub sw32_unhit:Controller.Switch(32) = 0: End Sub

Sub sw33_hit: Controller.Switch(33) = 1 : End Sub
Sub sw33_unhit:Controller.Switch(33) = 0: End Sub

'Spinner
Sub sw35_spin:vpmtimer.pulsesw 35: PlaySoundAt "fx_spinner", sw35:DOFALT 117, DOFPulse:End Sub

'Up Post opto
Sub sw36_hit:vpmtimer.pulsesw 36: End Sub

'Ramp Switches (use pulse switch to trigger events)
Sub sw40_hit: vpmtimer.pulsesw 40 : DOFALT 118, DOFPulse: End Sub
Sub sw43_hit: vpmtimer.pulsesw 43 : DOFALT 118, DOFPulse: End Sub

'Bumpers
Sub sw49_hit:DOFALT 108, DOFPulse:vpmtimer.pulsesw 49:DOFALT 107, DOFPulse:RandomSoundBumperLeft sw49:End Sub
Sub sw50_hit:DOFALT 112, DOFPulse:vpmtimer.pulsesw 50:DOFALT 111, DOFPulse:RandomSoundBumperRight sw50:End Sub
Sub sw51_hit:DOFALT 110, DOFPulse:vpmtimer.pulsesw 51:DOFALT 109, DOFPulse:RandomSoundBumperBottom sw51:End Sub

'ECTO Goggles opto
Sub sw59_hit:vpmtimer.pulsesw 59: End Sub

'Drop Targets
Sub sw65_dropped:dtLeft.Hit 1:DOFALT 119, DOFPulse:End Sub
Sub sw66_dropped:dtRight.Hit 1:DOFALT 119, DOFPulse:End Sub

'************************************************************************
'                        ECTO GOGGLES
'************************************************************************

Dim scene1,scene2,scene3,scene4,scene5,scene6,scene7,scene8,scene9,scene10,scene11,scene12,scene13,scene14,scene15
Dim Loop3, Loop4, Loop6, Loop9, Loop11,Loop12,Loop13,StartFrame
Loop3=0:Loop4=0:Loop6=0:Loop9=0:Loop11=0:Loop12=0:Loop13=0:StartFrame=129

sub changevideo(vidnum)
' if (vidnum<=9) then
'   ectomovie.imagea = "zcd_nunzioScoleri_hit_" & Right("000" & CStr(vidnum+1), 3)
' elseif (vidnum<=47) then
'   ectomovie.imagea = "zcd_tonyScoleri_hit_" & Right("000" & CStr(vidnum-9), 3)
' elseif (vidnum<=66) then
'   ectomovie.imagea = "zcd_nunzioScoleri_idle_" & Right("000" & CStr(vidnum-47), 3)
' elseif (vidnum<=90) then
'   ectomovie.imagea = "zcd_ghost4_idle_" & Right("000" & CStr(vidnum-66), 3)
'' I think this is a SPA bug - 029 is the first hit sequence, not 001
' elseif (vidnum<=99) Then
'   ectomovie.imagea = "zcd_ghost4_hit_" & Right("000" & CStr(vidnum-90+28), 3)
' elseif (vidnum<=127) Then
'   ectomovie.imagea = "zcd_ghost4_hit_" & Right("000" & CStr(vidnum-90-9), 3)
'' end buggy sequence.
' elseif (vidnum<=173) then
'   ectomovie.imagea = "zcd_SternLogo_" & Right("000" & CStr(vidnum-128), 3)
' elseif (vidnum=174) Then
'   ectomovie.imagea = "zcd_GhostLogo"
' elseif (vidnum<=205) then
'   ectomovie.imagea = "zcd_Jackpot_15fps_" & Right("000" & CStr(vidnum-174), 3)
' elseif (vidnum<=236) then
'   ectomovie.imagea = "zcd_SuperJackpot_15fps_" & Right("000" & CStr(vidnum-205), 3)
' elseif (vidnum<=276) then
'   ectomovie.imagea = "zcd_slimer_idle_" & Right("000" & CStr(vidnum-236), 3)
' elseif (vidnum<=294) then
'   ectomovie.imagea = "zcd_slimer_small_hit_" & Right("000" & CStr(vidnum-276), 3)
' elseif (vidnum<=313) then
'   ectomovie.imagea = "zcd_tonyScoleri_small_idle_" & Right("000" & CStr(vidnum-294), 3)
' elseif (vidnum<=418) then
'   ectomovie.imagea = "zcd_Taxi" & Right("000" & CStr(vidnum-313), 3)
' elseif (vidnum<=464) then
'   ectomovie.imagea = "zcd_Cat" & Right("000" & CStr(vidnum-418), 3)
' Else
'   ectomovie.imagea = "zcd_GhostLogo"
' end if

  Select Case vidnum
  Case 0
    StartFrame=0
  Case 10
    StartFrame=10
  Case 48
    StartFrame=48
  Case 67
    StartFrame=67
  Case 91
    StartFrame=91
  Case 128
    StartFrame=128
  Case 129
    StartFrame=129
  Case 174
    StartFrame=174
  Case 175
    StartFrame=175
  Case 206
    StartFrame=206
  Case 237
    StartFrame=237
  Case 277
    StartFrame=277
  Case 295
    StartFrame=295
  Case 314
    StartFrame=314
  Case 400
    StartFrame=400
  Case 419
    StartFrame=419
  Case 459
    StartFrame=459
  End Select
end sub

Sub NewScene_Timer
  Select Case StartFrame
  Case 0
    Loop3=0
    if scene1<10 Then
      scene1=scene1+1
      scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
      Ectomovie.imagea = "zcd_nunzioScoleri_hit_" & Right("000" & CStr(scene1), 3)
    Else
      ' Switch to Tony's hit sequence, frame 10.
      StartFrame = 10
      scene2 = 10
      NewScene_Timer
    end if
  Case 10
    Loop11=0
    if scene2<38 Then scene2=scene2+1
    scene1=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_tonyScoleri_hit_" & Right("000" & CStr(scene2), 3)
  Case 48
    If Loop3=0 Then Loop3=1
    If Loop3=1 Then scene3=scene3+1
    if scene3=20 Then scene3=1
    scene1=0:scene2=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_nunzioScoleri_idle_" & Right("000" & CStr(scene3), 3)
  Case 67
    If Loop4=0 Then Loop4=1
    If Loop4=1 Then scene4=scene4+1
    if scene4=25 Then scene4=1
    scene1=0:scene2=0:scene3=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_ghost4_idle_" & Right("000" & CStr(scene4), 3)
  Case 91
    Loop4=0
    if scene5<37 Then scene5=scene5+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_ghost4a_hit_" & Right("000" & CStr(scene5), 3)
  Case 128
    if scene6<45 Then scene6=scene6+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_SternLogo_000"
  Case 129
    if scene6<45 Then scene6=scene6+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_SternLogo_" & Right("000" & CStr(scene6), 3)
  Case 174
    Ectomovie.imagea = "zcd_GhostLogo"
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
  Case 175
    if scene7<31 Then scene7=scene7+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_Jackpot_15fps_" & Right("000" & CStr(scene7), 3)
  Case 206
    if scene8<31 Then scene8=scene8+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_SuperJackpot_15fps_" & Right("000" & CStr(scene8), 3)
  Case 237
    If Loop9=0 Then Loop9=1
    If Loop9=1 Then scene9=scene9+1
    if scene9=41 Then scene9=1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_slimer_idle_" & Right("000" & CStr(scene9), 3)
  Case 277
    Loop9=0
    if scene10<18 Then scene10=scene10+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene11=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_slimer_small_hit_" & Right("000" & CStr(scene10), 3)
  Case 295
    If Loop11=0 Then Loop11=1
    If Loop11=1 Then scene11=scene11+1
    if scene11=20 Then scene11=1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene12=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_tonyScoleri_small_idle_" & Right("000" & CStr(scene11), 3)
  Case 314
    If Loop12=0 Then Loop12=1
    If Loop12=1 Then scene12=scene12+1
    if scene12=87 Then scene12=1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene13=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_Taxi" & Right("000" & CStr(scene12), 3)
  Case 400
    Loop12=0
    if scene13<19 Then scene13=scene13+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene14=0:scene15=0
    Ectomovie.imagea = "zcd_Taxi" & Right("000" & CStr(scene13+86), 3)
  Case 419
    If Loop13=0 Then Loop13=1
    If Loop13=1 Then scene14=scene14+1
    if scene14=41 Then scene14=1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene15=0
    Ectomovie.imagea = "zcd_Cat" & Right("000" & CStr(scene14), 3)
  Case 459
    Loop13=0
    if scene15<6 Then scene15=scene15+1
    scene1=0:scene2=0:scene3=0:scene4=0:scene5=0:scene6=0:scene7=0:scene8=0:scene9=0:scene10=0:scene11=0:scene12=0:scene13=0:scene14=0
    Ectomovie.imagea = "zcd_Cat" & Right("000" & CStr(scene15+40), 3)
  End Select
End Sub

' *********************************************************************
'             LIGHTS
' *********************************************************************

Dim bulb
Dim LampState(300), FadingLevel(300)
Dim FlashSpeedUp(300), FlashSpeedDown(300), FlashMin(300), FlashMax(300), FlashLevel(300)

InitLamps()             ' turn off the lights and flashers and reset them to the default parameters
LampTimer.Interval = -1 'lamp fading speed
LampTimer.Enabled = 1

Sub InitLamps()
    Dim x
    For x = 0 to 300
        LampState(x) = 0         ' current light state, independent of the fading level. 0 is off and 1 is on
        FadingLevel(x) = 4       ' used to track the fading state
        FlashSpeedUp(x) = 0.5    ' faster speed when turning on the flasher
        FlashSpeedDown(x) = 0.35 ' slower speed when turning off the flasher
        FlashMax(x) = 1          ' the maximum value when on, usually 1
        FlashMin(x) = 0          ' the minimum value when off, usually 0
        FlashLevel(x) = 0        ' the intensity of the flashers, usually from 0 to 1
    Next
End Sub

Sub LampTimer_Timer()
    Dim chgLamp, num, chg, ii, vid, prevlvl, targetlvl
    vid = false
' debug.print "Timer print: " & LampState(18+81)
    chgLamp = Controller.ChangedLamps 'vpinspa outputs status for all lamps always, this can exhaust the fading routine, unless we filter changes out here and in fading subs
    If Not IsEmpty(chgLamp) Then
        For ii = 0 To UBound(chgLamp)
      prevlvl = LampState(chgLamp(ii, 0) )    'previous frame value
      targetlvl = chgLamp(ii, 1)          'latest frame value

      'some special lamps
      Select Case chgLamp(ii, 0)
        Case 199,201,206,207,208,209,210,211,220,223
          If chgLamp(ii, 1) > 128 Then
          DOFALT chgLamp(ii, 0), DOFOn
          Else
          DOFALT chgLamp(ii, 0), DOFOff
          End If
        Case 83
          If chgLamp(ii, 1) = 255 Then
          DOFALT chgLamp(ii, 0), DOFOn
          Else
          DOFALT chgLamp(ii, 0), DOFOff
          End If
            End Select
            if chgLamp(ii,0) = 282 or chgLamp(ii,0) = 283 Then
        'write this straight to lampstate, so that changevideo gets values correct
        LampState(chgLamp(ii, 0) ) = targetlvl
                vid = true
            end if

            if chgLamp(ii,0) = 281 Then
                'write this straight to lampstate, so that slimer moves correctly
                LampState(chgLamp(ii, 0) ) = targetlvl
            end if

      'Fadinglevel filtering
      ' 0 = static off -> skipped in subs
      ' 1 = static on -> skipped in subs
      ' 3 = not used
      ' 4 = fading down -> subs have equation that will fade the level down
      ' 5 = fading up -> This is not actually in use with vpinspa as it provides slow fade ups already

      if prevlvl <> targetlvl then
        if prevlvl < targetlvl Then
          FadingLevel(chgLamp(ii, 0) ) = 5              'fading up...
          LampState(chgLamp(ii, 0) ) = targetlvl            'as vpinspa output is modulated, we write the level here
        end if

        if prevlvl > targetlvl Then
          FadingLevel(chgLamp(ii, 0) ) = 4              'fading down...
          'LampState(chgLamp(ii, 0) ) = (prevlvl + targetlvl) / 2   'Skipping level set, let the subs to fade it slow
        end if
      Else              'no change in intensity. Vpinspa outputs these occasionally, but we should let them skip in fading subs
        if targetlvl = 255 Then
          FadingLevel(chgLamp(ii, 0) ) = 1 'on already
        elseif targetlvl = 0 Then
          FadingLevel(chgLamp(ii, 0) ) = 0 'off already
        Else
          'debug.print "same level outputted for consecutive frames -> don't care"
        end if
      end if
        Next
        if vid then
            changevideo cInt(LampState(283)) * 256 + cInt(LampState(282))
        end if
    End If
    UpdateLamps
End Sub

Sub UpdateLamps()

  ' added for VR Front lights
  SingleLamp l02, 02 'Start Button
  SingleLamp l03, 03 'Tournament Button


  SingleLampM l10, 10
  SinglePrimitive p10, 10, 20
  SingleLampM l11, 11
  SinglePrimitive p11, 11, 20
  SingleLampM l13, 13
  SinglePrimitive p13, 13, 40
  SingleLampM l14, 14
  SinglePrimitive p14, 14, 200
  SingleLampM l15, 15
  SinglePrimitive p15, 15, 200
  SingleLampM l16, 16
  SinglePrimitive p16, 16, 200
  SingleLampM l17, 17
  SinglePrimitive p17, 17, 200
  SingleLampM l18, 18
  SinglePrimitive p18, 18, 200
  SingleLampM l19, 19
  SinglePrimitive p19, 19, 40
  SingleLampM l20, 20
  SinglePrimitive p20, 20, 20
  SingleLampM l21, 21
  SinglePrimitive p21, 21, 70
  SingleLampM l22, 22
  SinglePrimitive p22, 22, 70
  SingleLampM l23, 23
  SinglePrimitive p23, 23, 70
  SingleLampM l24, 24
  SinglePrimitive p24, 24, 70
  SingleLampM l25, 25
  SinglePrimitive p25, 25, 100
  SingleLampM l30, 30
  SinglePrimitive p30, 30, 70
  SingleLampM l31, 31
  SinglePrimitive p31, 31, 100
  SingleLampM l32, 32
  SinglePrimitive p32, 32, 100
  SingleLampM l33, 33
  SinglePrimitive p33, 33, 100
  SingleLampM l35, 35
  SinglePrimitive p35, 35, 40
  SingleLampM l36, 36
  SinglePrimitive p36, 36, 40
  SingleLampM l37, 37
  SinglePrimitive p37, 37, 100
  SingleLampM l38, 38
  SinglePrimitive p38, 38, 100
  SingleLampM l39, 39
  SinglePrimitive p39, 39, 100
  SingleLampM l40, 40
  SinglePrimitive p40, 40, 200
  SingleLampM l49, 49
  SinglePrimitive p49, 49, 100
  SingleLampM l54, 54
  SingleLamp l54a, 54
  SingleLampM l56, 56
  SinglePrimitive p56, 56, 100
  SingleLampM l57, 57
  SinglePrimitive p57, 57, 40
  SingleLampM l58, 58
  SinglePrimitive p58, 58, 100
  SingleLampM l59, 59
  SinglePrimitive p59, 59, 100
  SingleLampM l60, 60
  SinglePrimitive p60, 60, 100
  SingleLampM l61, 61
  SinglePrimitive p61, 61, 100
  SingleLampM l65, 65
  SinglePrimitive p65, 65, 333
  SingleLampM l66, 66
  SinglePrimitive p66, 66, 333
  SingleLampM l68, 68
  SinglePrimitive p68, 68, 200
  SingleLampM l69, 69
  SinglePrimitive p69, 69, 200
  SingleLampM l70, 70
  SinglePrimitive p70, 70, 200
  SingleLampM l71, 71
  SinglePrimitive p71, 71, 200
  SingleLampM l72, 72
  SinglePrimitive p72, 72, 200
  SingleLampM l73, 73
  SinglePrimitive p73, 73, 20
  SingleLampM l75, 75
  SinglePrimitive p75, 75, 100
  SingleLampM l76, 76
  SinglePrimitive p76, 76, 100
  SingleLampM l77, 77
  SinglePrimitive p77, 77, 100
  SingleLampM l78, 78
  SinglePrimitive p78, 78, 100
  SingleLampM l79, 79
  SinglePrimitive p79, 79, 100
  SingleLampM l84, 84
  SinglePrimitive p84, 84, 70
  SingleLampM l85, 85
  SinglePrimitive p85, 85, 100
  SingleLampM l89, 89
  SinglePrimitive p89, 89, 10
  SingleLampM Fl91, 91
  SingleLampM Fl91a, 91
  SingleLampM Fl91b, 91
  SinglePrimitive bulb1, 91, 1
  SingleLampM Fl92, 92
  SingleLampM Fl92a, 92
  SingleLampM Fl92b, 92
  SingleLamp Fl92c, 92
  SingleLampM l94, 94
  SinglePrimitive p94, 94, 30
  SingleLampM l95, 95
  SinglePrimitive p95, 95, 333
  SingleLampM l100, 100
  SingleLampM l100a, 100
  SingleLampM l100b, 100
  SinglePrimitive p100, 100, 30
  SingleLampM l101, 101
  SingleLampM l101a, 101
  SingleLampM l101b, 101
  SinglePrimitive p101, 101, 30
  SingleLampM l102, 102
  SingleLampM l102a, 102
  SingleLampM l102b, 102
  SinglePrimitive p102, 102, 30
  SingleLamp l103, 103
  SingleLamp l104, 104
  SingleLamp l105, 105
  SingleLampM l106, 106
  SinglePrimitive p106, 106, 100
  'SingleLamp l110, 110       'SPA bug, DLL remaps 123 and 110 to 0 making it not quite right..
  SingleLampM l112, 112
  SingleLamp l112a, 112
  SinglePrimitiveM p113, 113, 200
  SingleLampM l113, 113
  SingleLampM l113a, 113
  SinglePrimitive p113, 113, 200

'RGB lamps
  RGBLamp l26r, 28, 27, 26
  RGBLamp l41r, 43, 42, 41
  RGBLamp l45r, 45, 46, 47
  RGBLampR l45a, 45, 46, 47
  RGBLamp l50r, 52, 51, 50
  RGBLamp l62r, 64, 63, 62
  RGBLamp l80r, 82, 81, 80
  RGBLamp l86r, 88, 87, 86
  RGBLamp l96r, 96, 97, 98
  RGBLamp lPuffGlow, 107, 108, 109
  StayPuftColor 107, 108, 109

'General Illumination
  CabinetSideM 117
  SingleLampM Reflect1, 117
  SingleFlasherM Flasher1, 117, -150
  SinglePrimitiveM Primitive27, 117, 1
  GIString GILeftSling, 117

  SinglePrimitiveM Primitive27, 118, 0.5
  GIString GIPlayfield2, 118


  SingleLampM Reflect2, 119
  GIString GIPlayfield3, 119

  SinglePrimitiveM bulb3, 120, 1
  SinglePrimitiveM bulb4, 120, 1
  SinglePrimitiveM bulb5, 120, 1
  SinglePrimitiveM bulb6, 120, 1
  SinglePrimitiveM bulb7, 120, 1
  SinglePrimitiveM PinCab_Backglass, 120, 3
  SinglePrimitiveM PinCab_Backglass_PUP, 120, 3
  GIString GIBackwall, 120

  SingleLampM Reflect3, 121
  SinglePrimitiveM Primitive59, 121, 0.4
  SinglePrimitiveM Primitive12, 121, 0.6
  GIString GIRightSling, 121

  SlimerLamp 122

  GIString GIEcto, 123


'Flashers
  SingleLamp fl125, 125
  SingleLamp fl126, 126

  SingleLampM fl127a, 127
  SingleLampM fl127b, 127
  SinglePrimitive fl127p, 127, 3
  SingleLampM fl128a, 128
  SingleLampM fl128b, 128
  SinglePrimitive fl128p, 128, 3

  If LampState(127+81)>0 AND LampState(128+81)>0 Then HideLamp True
  If LampState(127+81)=0 OR LampState(128+81)=0 Then HideLamp False

  SingleLampM Fl129, 129
  SingleLampM Fl129a, 129
  SingleLampM Fl129b, 129
  SingleLampM Fl129c, 129
  SinglePrimitive fl129p, 129, 3

  SingleLampM Fl130a, 130
  SingleLamp Fl130b, 130

  SingleLampM Fl131a, 131
  SingleLampM Fl131b, 131
  SinglePrimitiveM p131, 131, 80
  SingleLamp LEcto, 131
  SingleLamp Fl132, 132

  SingleLampM fl133b, 133
  SingleLampM fl133a, 133
  SinglePrimitive p133, 133, 80
  SingleLampM fl134b, 134
  SingleLampM fl134a, 134
  SinglePrimitive p134, 134, 80

  SingleLampM Fl136, 136
  SingleLampM Fl136a, 136
  SinglePrimitive p136, 136, 100

  SingleLampM Fl137, 137
  SingleLampM Fl137a, 137
  SinglePrimitive p137, 137, 80

  SingleLampM l138, 138
  SingleLamp l138a, 138

  SingleLampM l139, 139
  SingleLampM l139a, 139
  SingleLampM l139b, 139
  SingleLamp l139c, 139

  SingleLampM l140a, 140
  SingleLampM l140b, 140
  SinglePrimitiveM p140a, 140, 600
  SinglePrimitive p140b, 140, 600
  SingleLampM l141a, 141
  SingleLampM l141b, 141
  SinglePrimitiveM p141a, 141, 600
  SinglePrimitive p141b, 141, 600
  SingleLampM Fl142a, 142
  SingleLampM Fl142b, 142
  SinglePrimitive Fl142p, 142, 1

' debug.print "End of update: " & LampState(18 + 81)

'My Topper
  SingleLamp Fl166, 49 'Red Flasher
  SinglePrimitive TopperRed, 49, 0.5

    SingleLamp Fl167, 51 'Left Front Blue Flasher
  SinglePrimitive TopperBlueLeft, 51, 0.5

    SingleLamp Fl168, 52 'Right Front Blue Flasher
  SinglePrimitive TopperBlueRight, 52, 0.5

    SingleLamp Fl169, 131 'Left Middle Blue Flasher
    SingleLamp Fl170, 131 'Right Middle Blue Flaster

End Sub

Sub HideLamp (enabled)
  Fl128a.visible=NOT enabled
End Sub

Sub SingleLamp(lampobj, id)
  dim intensity

  if FadingLevel(id+81) > 1 then

    Intensity = LampState(id + 81)
'   debug.print "SingleLamp: " & intensity
    lampobj.IntensityScale = LampState(id + 81) / 255

    if FadingLevel(id+81) = 4 Then
      Intensity = LampState(id + 81) * 0.7 - 0.01
      if Intensity <= 0 then : Intensity = 0 : FadingLevel(id+81) = 0
    end if

    if FadingLevel(id+81) = 5 Then
      if Intensity = 255 then FadingLevel(id+81) = 1
    end if

    LampState(id + 81) = Intensity
  end if
End Sub

Sub SingleLampM(lampobj, id)
    if FadingLevel(id+81) > 1 then
    lampobj.IntensityScale = LampState(id + 81) / 255
  end If
End Sub

Sub SinglePrimitive(primobj, id, factor)
  dim intensity

  if FadingLevel(id+81) > 1 then

    Intensity = LampState(id + 81)
'   debug.print "SinglePrimitive: " & intensity
    primobj.BlendDisableLighting = gInsertBrightness * factor * (LampState(id + 81) / 255)

    if FadingLevel(id+81) = 4 Then
      Intensity = LampState(id + 81) * 0.65 - 0.01          'make prim dim a bit faster than light
      if Intensity <= 0 then : Intensity = 0 : FadingLevel(id+81) = 0
    end if

    if FadingLevel(id+81) = 5 Then
      if Intensity = 255 then FadingLevel(id+81) = 1
    end if

    LampState(id + 81) = Intensity
  end if
End Sub

Sub SinglePrimitiveM(primobj, id, factor)
  if FadingLevel(id+81) > 1 then
        primobj.BlendDisableLighting = gInsertBrightness * factor * (LampState(id + 81) / 255)
  end if
End Sub

Sub SingleFlasher(flasherobj, id, opacity)
  dim intensity,lvl

  if FadingLevel(id+81) > 1 then

    Intensity = LampState(id + 81)
    lvl = intensity / 255
'   debug.print "SingleFlasher: " & intensity
    flasherobj.opacity = 200 + (opacity * lvl)


    if FadingLevel(id+81) = 4 Then
      Intensity = LampState(id + 81) * 0.9 - 0.01
      if Intensity <= 0 then : Intensity = 0 : FadingLevel(id+81) = 0
    end if

    if FadingLevel(id+81) = 5 Then
      if Intensity = 255 then FadingLevel(id+81) = 1
    end if

    LampState(id + 81) = Intensity
  end if

End Sub

Sub SingleFlasherM(flasherobj, id, opacity)
    if FadingLevel(id+81) > 1 then
    flasherobj.opacity = 200 + (opacity * (LampState(id + 81) / 255))
  end If
End Sub

Sub RGBLamp(object, AR, AG, AB)   'used for light objects
  Dim r, g, bl

  if FadingLevel(aG+81) > 1 Or FadingLevel(aR+81) > 1 Or FadingLevel(aB+81) then

    r = LampState(aR+81)
    g = LampState(aG+81)
    bl = LampState(aB+81)

    Object.IntensityScale = (r+g+(bl*2)) / 500
    Object.ColorFull = RGB(r, g, bl)
    Object.Color = RGB(r, g, bl)

    if FadingLevel(aR+81) = 4 then r = r * 0.7 - 0.01
    if FadingLevel(aG+81) = 4 then g = g * 0.7 - 0.01
    if FadingLevel(aB+81) = 4 then bl = bl * 0.7 - 0.01

    if g <= 0 then : g = 0
    if r <= 0 then : r = 0
    if bl <= 0 then : bl = 0

    'if all zero, we can exclude these from fading
    if g <= 0 And r <= 0 And bl <= 0 then : FadingLevel(aG+81) = 0 : FadingLevel(aR+81) = 0 : FadingLevel(aB+81) = 0

    LampState(aR+81) = r
    LampState(aG+81) = g
    LampState(aB+81) = bl
  end if
end Sub

Sub RGBLampR(object, AR, AG, AB)    'used for light objects
  Dim r, g, bl

  if FadingLevel(aG+81) > 1 Or FadingLevel(aR+81) > 1 Or FadingLevel(aB+81) then

    r = LampState(aR+81)
    g = LampState(aG+81)
    bl = LampState(aB+81)

    Object.IntensityScale = (r+g+(bl*2)) / 1000
    Object.Color = RGB(r, g, bl)

    if FadingLevel(aR+81) = 4 then r = r * 0.7 - 0.01
    if FadingLevel(aG+81) = 4 then g = g * 0.7 - 0.01
    if FadingLevel(aB+81) = 4 then bl = bl * 0.7 - 0.01

    if g <= 0 then : g = 0
    if r <= 0 then : r = 0
    if bl <= 0 then : bl = 0

    'if all zero, we can exclude these from fading
    if g <= 0 And r <= 0 And bl <= 0 then : FadingLevel(aG+81) = 0 : FadingLevel(aR+81) = 0 : FadingLevel(aB+81) = 0

    LampState(aR+81) = r
    LampState(aG+81) = g
    LampState(aB+81) = bl
  end if
end Sub

Sub SlimerLamp(id)
  dim intensity,lvl

  if FadingLevel(id+81) > 1 then

    Intensity = LampState(id + 81)
    lvl = intensity / 255
    'debug.print "slimerlamp: " & intensity
    slimer.blenddisablelighting = lvl
    slimerlight.IntensityScale = lvl
    slimerlighta.IntensityScale = lvl
    MaterialColor "Slimer", RGB(128+127*lvl,148+107*lvl, 128+127*lvl)

    if FadingLevel(id+81) = 4 Then
      Intensity = LampState(id + 81) * 0.8 - 0.01
      if Intensity <= 0 then : Intensity = 0 : FadingLevel(id+81) = 0
    end if

    if FadingLevel(id+81) = 5 Then
      if Intensity = 255 then FadingLevel(id+81) = 1
    end if

    LampState(id + 81) = Intensity
  end if
end sub

Sub StayPuftColor(AR, AG, AB)   'used for light objects
  Dim r, g, bl, comp

  if FadingLevel(aG+81) > 1 Or FadingLevel(aR+81) > 1 Or FadingLevel(aB+81) then

    r = LampState(aR+81) * 0.7
    g = LampState(aG+81) * 0.7
    bl = LampState(aB+81) * 0.7

'   debug.print "Puft"
    staypuft.blenddisablelighting = (r+g+(bl*2)) / 1000
    comp = (r+g+bl) / 4 ' Boost contrast to make colors more intense as light gets brighter.
    MaterialColor "Staypuft", RGB(r+128-comp,g+128-comp, bl+128-comp)


    if FadingLevel(aR+81) = 4 then r = r * 0.9 - 0.01
    if FadingLevel(aG+81) = 4 then g = g * 0.9 - 0.01
    if FadingLevel(aB+81) = 4 then bl = bl * 0.9 - 0.01

    if g <= 0 then : g = 0
    if r <= 0 then : r = 0
    if bl <= 0 then : bl = 0

    'if all zero, we can exclude these from fading
    if g <= 0 And r <= 0 And bl <= 0 then : FadingLevel(aG+81) = 0 : FadingLevel(aR+81) = 0 : FadingLevel(aB+81) = 0

    LampState(aR+81) = r / 0.7    'don't ask
    LampState(aG+81) = g / 0.7
    LampState(aB+81) = bl / 0.7
  end if
end Sub

Sub GIString(Coll, id)
  dim Intensity
  dim Obj

  if FadingLevel(id+81) > 1 then

'   debug.print "coll: " & id
    Intensity = LampState(id + 81)
    for each obj in Coll
'     debug.print "GI collection" & Obj.name
      obj.IntensityScale = LampState(id + 81) / 255 'making lvl
    Next

    if FadingLevel(id+81) = 4 Then
'     debug.print "gi off " & id
      Intensity = LampState(id + 81) * 0.8 - 0.01
      if Intensity <= 0 then : Intensity = 0 : FadingLevel(id+81) = 0
    end if

    if FadingLevel(id+81) = 5 Then
'     debug.print "gi on " & id
      if Intensity = 255 then FadingLevel(id+81) = 1
    end if

    LampState(id + 81) = Intensity
  end if
End Sub

'not used
'Sub CabinetSide (id)
' dim intensity
'
' if FadingLevel(id+81) > 1 then
'
'   Intensity = LampState(id + 81)
'
'   MaterialColor "CabSides", RGB (Intensity, Intensity, Intensity)
'
'   if FadingLevel(id+81) = 4 Then
'     Intensity = LampState(id + 81) * 0.8 - 0.01
'     if Intensity <= 0 then : Intensity = 0 : FadingLevel(id+81) = 0
'   end if
'
'   if FadingLevel(id+81) = 5 Then
'     if Intensity = 255 then FadingLevel(id+81) = 1
'   end if
'
'   LampState(id + 81) = Intensity
' end if
'End Sub

Sub CabinetSideM (id)
  dim intensity, CustomCabSides
  if FadingLevel(id+81) > 1 then
    if CustomCabSides = 1 then
      Intensity = 0.79 * LampState(id + 81) + 20
    Else
      Intensity = 0.67 * LampState(id + 81) + 80
    end if
    MaterialColor "CabSides", RGB (Intensity, Intensity, Intensity)
  end if
End Sub

Sub ColorGradeLUT (id)
  dim step:step = INT(LampState(id + 81)/32 + 1)
  Table1.ColorGradeImage = "ColorGrade_" & step
End Sub

' *********************************************************************
'         Supporting Ball & Sound Functions
' *********************************************************************

'Additional DOF sound vs toy/effect helpers:
Function SoundFX (Sound, Effect)
  If ((Effect = 0 And B2SOn) Or DOFeffects(Effect)=1) Then
    SoundFX = ""
  Else
    SoundFX = Sound
  End If
End Function

Function SoundFXDOFALT (Sound, DOFevent, State, Effect)
  If DOFeffects(Effect)=1 Then
    SoundFXDOFALT = ""
    DOFALT DOFevent, State
  ElseIf DOFeffects(Effect)=2 Then
    SoundFXDOFALT = Sound
    DOFALT DOFevent, State
  Else
    SoundFXDOFALT = Sound
  End If
End Function

Sub DOF(DOFevent, State)
  If B2SOn Then
    If State = 2 Then
      Controller.B2SSetData DOFevent, 1:Controller.B2SSetData DOFevent, 0
    Else
      Controller.B2SSetData DOFevent, State
    End If
  End If
End Sub

Sub DOFALT(DOFevent, State)
  If B2SOnALT Then
    If State = 2 Then
      B2SController.B2SSetData DOFevent, 1:B2SController.B2SSetData DOFevent, 0
    Else
      B2SController.B2SSetData DOFevent, State
    End If
  End If
End Sub

'*****************
' Maths
'*****************

Const Pi = 3.1415927

Function dSin(degrees)
  dsin = sin(degrees * Pi/180)
End Function

Function dCos(degrees)
  dcos = cos(degrees * Pi/180)
End Function

Function dAtn(degrees)
  dAtn = atn(degrees * Pi/180)
End Function

Function RndNum(min, max)
    RndNum = Int(Rnd() * (max-min + 1) ) + min ' Sets a random number between min and max
End Function

' *********************************************************************
'             Other Sound FX
' *********************************************************************


Sub LREnter_Hit():If ActiveBall.VelY < 0 Then PlaySoundAtVol "fx_lrenter", LREnter, 0.5:End If:End Sub      'ball is going up
Sub LREnter_UnHit():If ActiveBall.VelY > 0 Then StopSound "fx_lrenter":End If:End Sub   'ball is going down
Sub LREnter1_Hit(): PlaySoundAtVol "fx_lrturn",LREnter1, 0.5:End Sub
Sub LWREnter_hit: PlaysoundAt "fx_wireramp_enter", ActiveBall:End Sub
Sub LWREnter1_hit: PlaysoundAt "fx_lrbump", ActiveBall:End Sub


Sub RREnter_Hit():If ActiveBall.VelY < 0 Then PlaySoundAt "fx_rrenter1",ActiveBall:End If:End Sub     'ball is going up
Sub RREnter_UnHit():If ActiveBall.VelY > 0 Then StopSound "fx_rrenter1":End If:End Sub    'ball is going down
'Sub RREnter1_hit: activeball.amgmomz = activeball.amgmomz * 3 : PlaySoundAt "fx_rrenter2", RREnter1 : End Sub
Sub RWREnter_hit:PlaysoundAt "fx_wireramp_enter", ActiveBall:End Sub
Sub RWREnter1_hit: PlaysoundAt "fx_lrbump", ActiveBall:End Sub
Sub RWRExit_hit:StopSound"fx_wireramp_enter":PlaysoundAt "fx_wireramp_exit", ActiveBall: End Sub


Sub DrainSound_Hit(): RandomSoundDrain Drain: End Sub
Sub BallRelease_UnHit(): RandomSoundBallRelease BallRelease: End Sub


'these not working with cvpmSaucer
'Sub ScoopEject_Hit(): SoundSaucerLock: End Sub
'Sub ScoopEject_UnHit(): SoundSaucerKick 1, ScoopEject: End Sub
'Sub SubwayEject_Hit(): SoundSaucerLock: End Sub
'Sub SubwayEject_UnHit(): SoundSaucerKick 1, SubwayEject: End Sub
'Sub SubwayLockIn_Hit(): SoundSaucerLock: End Sub
'Sub SubwayLockOut_UnHit(): SoundSaucerKick 1, SubwayLockOut: End Sub


'Helpers
Sub LoopL_Hit : If Activeball.VelY>10 Then Activeball.VelY=10 : End If : End Sub

' *********************************************************************
'           REALTIME UPDATES
' *********************************************************************

Dim CustomLighting, SlimerMove: SlimerMove = 10

Sub GameTimer_Timer
    RollingSoundUpdate
  BallShadowUpdate
  LeftFlipperP.ObjRotZ = LeftFlipper.currentangle
  RightFlipperp.ObjRotZ = RightFlipper.currentangle
  If CustomLighting= 2 or 1 Then
    'move glowbats
    GlowBatLightLeft.y = 1795 - 123 + LeftFlipper.CurrentAngle
    glowbatleft.objrotz = LeftFlipper.CurrentAngle
    GlowBatLightRight.y =1795 - 123 - RightFlipper.CurrentAngle
    glowbatright.objrotz = RightFlipper.CurrentAngle
  Else
    'move flipper shadows
    FlipperLSh.RotZ = LeftFlipper.currentangle
    FlipperRSh.RotZ = RightFlipper.currentangle
  End If
  sw35p.RotX     = -sw35.currentangle
  LeftGate.RotY    = Gate1.currentangle * 2/3
  RightGate.RotY   = Gate2.currentangle * 2/3
  Primitive71.RotX = -Gate3.currentangle
  Primitive69.RotX = -Gate4.currentangle
  Primitive68.RotX = -Gate5.currentangle

'***********************************
' VR Front cabinet lights code below..
'***********************************
If Renderingmode = 2 or vrtest = 1 then
if l02.IntensityScale = 1 then
VRStartButton.disableLighting = 1
VRStartButton2.disableLighting = 1
Else
VRStartButton.disableLighting = 0
VRStartButton2.disableLighting = 0
end if
if l03.IntensityScale = 1 then
Pincab_Tournament_Button.disableLighting = 1
Else
Pincab_Tournament_Button.disableLighting = 0
end if
End if


'***********************************
'****** SlimerVR code below.. ******
'***********************************


 'If VRRoom = 1 then  ' Only run the slimer animation on VRRoom = 1
    Randomize (21)
  SlimerVR.X=SlimerVR.X - SlimerMove
  If SlimerVR.X<=-11500 then
    SlimerMove = -10
    SlimerVR.Y=-3000 + rnd(1)*6500   ' this will move Slimer between y = -3000 and y =-3000 + a random number between 0.01 and 0.99 Times 6500
    SlimerVR.rotz = 250
    End If
  If SlimerVR.X>=14000 then
     SlimerMove = 10
     Randomize (17)
     SlimerVR.Y=-3000 + rnd(1)*6500
     SlimerVR.rotz = 70
     End If

    'PKE Texture swap when VRSlimer in the room
        If SlimerVR.X = -2510  then
    VRPKE.image = "Diffuse"
    end If
        If SlimerVR.X = -2500  then
    VRPKE.image = "DiffuseGreen"
    end If
    If SlimerVR.X = 2990 then
    VRPKE.image = "DiffuseGreen"
    end If
    If SlimerVR.X = 3000 then
    VRPKE.image = "Diffuse"
    end If

' VR Book and Staypuft animation below.. only runs if VRroom = 1

  VRBook.X = VRBook.X + BookMove
  VRBook.ObjRotZ=VRBook.ObjRotZ+Bookrot
  VRBook.ObjRotY=VRBook.ObjRotY+Bookrot2
  VRBook2.X = VRBook2.X + BookMove2
  VRBook2.ObjRotZ=VRBook2.ObjRotZ+Bookrot
  VRBook2.ObjRotY=VRBook2.ObjRotY+Bookrot2

  If VRBook.X>=3180 then
    BookMove = -3
  End If
  If VRBook.X<=-2000 then
    BookMove = 3
  End If
  If VRBook2.X>=3180 then
    BookMove2 = -4
  End If
  If VRBook2.X<=-2000 then
    BookMove2 = 4
  End If
  If VRBook.ObjRotZ=>10 then Bookrot=-.1
  If VRBook.ObjRotZ=<-10 then Bookrot=.1
  If VRBook.ObjRotY=>10 then Bookrot2=-.13
  If VRBook.ObjRotY=<-10 then Bookrot2=.13
  'end if

End Sub


Sub RDampen_Timer()
  Cor.Update
End Sub

Const tnob = 13           ' total number of balls : 6 (trough) + 6 (Captive Ball) + 1(FakeBall)
Const fakeballs = 7         ' number of balls created on table start (rolling sound and ballshadow will be skipped)
ReDim rolling(tnob-fakeballs-1)
ReDim BallShadow(tnob-fakeballs-1)
ReDim Glowing(tnob-fakeballs-1)
Dim DropCount
ReDim DropCount(tnob-fakeballs-1)

InitRolling:InitBallShadow:InitGlow

Sub InitRolling
  Dim i
  For i=0 to tnob-fakeballs-1
    rolling(i) = False
  Next
End Sub

Sub InitBallShadow
  Dim i
  For i=0 to tnob-fakeballs-1
    ExecuteGlobal "Set BallShadow(" & i & ") = BallShadow" & (i+1) & ":"
  Next
End Sub

Sub InitGlow
  Dim i
  For i=0 to tnob-fakeballs-1
    If CustomBall = 1 then
    ExecuteGlobal "Set Glowing(" & i & ") = Glowball" & (i+1) & ":"
        end if

        If CustomBall = 2 then
    ExecuteGlobal "Set Glowing(" & i & ") = Glowball" & (i+7) & ":"
        end if

    If CustomBall = 3 then
    ExecuteGlobal "Set Glowing(" & i & ") = Glowball" & (i+13) & ":"
        end if
  Next
End Sub

' ************************ROLLING SOUND************************
Sub RollingSoundUpdate()
    Dim BOT, b
    BOT = GetBalls
  ' stop the sound of deleted balls
  If UBound(BOT)<(tnob - 1) Then
    For b = (UBound(BOT) + 1) to (tnob-1)
      rolling(b-fakeballs) = False
      StopSound("BallRoll_" & b-fakeballs)
    Next
  End If
  ' exit the Sub if no balls on the table
    If UBound(BOT) = fakeballs-1 Then Exit Sub
       ' play the rolling sound for each ball
    For b = fakeballs to UBound(BOT)
        If BallVel(BOT(b) ) > 1 AND BOT(b).z < 30 Then
      rolling(b-fakeballs) = True
      'PlaySound("fx_ballrolling" & b-fakeballs), -1, Vol(BOT(b) )*0.25, Pan(BOT(b) ), 0, Pitch(BOT(b) ), 1, 0, AudioFade(BOT(b) )
      PlaySound ("BallRoll_" & b-fakeballs), -1, VolPlayfieldRoll(BOT(b)) * 1.1 * VolumeDial, AudioPan(BOT(b)), 0, PitchPlayfieldRoll(BOT(b)), 1, 0, AudioFade(BOT(b))
    Else
            If rolling(b-fakeballs) = True Then
                StopSound("BallRoll_" & b-fakeballs)
                rolling(b-fakeballs) = False
            End If
        End If
    '***Ball Drop Sounds***
    If BOT(b).VelZ < -1 and BOT(b).z < 55 and BOT(b).z > 27 Then 'height adjust for ball drop sounds
      If DropCount(b-fakeballs) >= 5 Then
        DropCount(b-fakeballs) = 0
        If BOT(b).velz > -7 Then
          RandomSoundBallBouncePlayfieldSoft BOT(b)
        Else
          RandomSoundBallBouncePlayfieldHard BOT(b)
        End If
      End If
    End If
    If DropCount(b-fakeballs) < 5 Then
      DropCount(b-fakeballs) = DropCount(b-fakeballs) + 1
    End If
    Next
End Sub

' **********************BALL SHADOW & GLOWING BALL**********************
Sub BallShadowUpdate()
    Dim BOT, b
    BOT = GetBalls
  ' hide shadow and switch off glowlight of deleted balls
  If UBound(BOT)<(tnob-1) Then
    For b = (UBound(BOT) + 1) to (tnob-1)
    If IsGlowBall Then Glowing(b-fakeballs).state = 0 Else BallShadow(b-fakeballs).visible = 0 End If
    Next
  End If
  ' exit the Sub if no balls on the table
    If UBound(BOT) = fakeballs-1 Then Exit Sub

    For b = fakeballs to UBound(BOT)
  If IsGlowBall Then                ' move glowball light
    If Glowing(b-fakeballs).state = 0 Then
      Glowing(b-fakeballs).state = 1
      BOT(b).DecalMode=True


            if CustomBall = 3 then

      BOT(b).image="glowball Pink":BOT(b).FrontDecal=""

      end If

            if CustomBall = 2 then

      BOT(b).image="glowball blue":BOT(b).FrontDecal=""

      end If

          if CustomBall = 1 then

      BOT(b).image="glowball green":BOT(b).FrontDecal=""

      end If



      BOT(b).BulbIntensityScale=0:BOT(b).PlayfieldReflectionScale=0
    End If
    Glowing(b-fakeballs).x = BOT(b).x
    Glowing(b-fakeballs).y = BOT(b).y + 15
        Glowing(b-fakeballs).BulbHaloHeight = BOT(b).z + 51


  Else                        ' render the shadow for each ball
    If BOT(b).X < Table1.Width/2 Then
      BallShadow(b-fakeballs).X = ((BOT(b).X) - (Ballsize/6) + ((BOT(b).X - (Table1.Width/2))/10)) + 10
    Else
      BallShadow(b-fakeballs).X = ((BOT(b).X) + (Ballsize/6) + ((BOT(b).X - (Table1.Width/2))/10)) - 10
    End If
      BallShadow(b-fakeballs).Y = BOT(b).Y + 20
    If BOT(b).Z > 20 Then
      BallShadow(b-fakeballs).visible = 1
    Else
      BallShadow(b-fakeballs).visible = 0
    End If
  End If
  Next
End Sub

'#############################################################
'#############################################################
'############### VPinSPA Controller loader ###################
'#############################################################
'#############################################################

Const directory = "HKEY_CURRENT_USER\SOFTWARE\Visual Pinball\Controller\"
Const DOFContactors = 1
Const DOFKnocker = 2
Const DOFChimes = 3
Const DOFBell = 4
Const DOFGear = 5
Const DOFShaker = 6
Const DOFFlippers = 7
Const DOFTargets = 8
Const DOFDropTargets = 9
Const DOFOff = 0
Const DOFOn = 1
Const DOFPulse = 2

Private Sub LoadCore
  On Error Resume Next
  If VPBuildVersion < 0 Or Err Then
    Dim fso : Set fso = CreateObject("Scripting.FileSystemObject") : Err.Clear
    ExecuteGlobal fso.OpenTextFile("core.vbs", 1).ReadAll    : If Err Then MsgBox "Can't open ""core.vbs""" : Exit Sub
    ExecuteGlobal fso.OpenTextFile("VPMKeys.vbs", 1).ReadAll : If Err Then MsgBox "Can't open ""vpmkeys.vbs""" : Exit Sub
  Else
    ExecuteGlobal GetTextFile("core.vbs")    : If Err Then MsgBox "Can't open ""core.vbs"""    : Exit Sub
    ExecuteGlobal GetTextFile("VPMKeys.vbs") : If Err Then MsgBox "Can't open ""vpmkeys.vbs""" : Exit Sub
  End If
End Sub

Sub LoadSPAController()
  ' Adaptation of LoadController from Controller.vbs
  Dim FileObj
  Dim DOFConfig
  Dim TextStr2
  Dim tempC
  Dim count
  Dim ISDOF
  Dim Answer

  B2SOn = False
  B2SOnALT = False
  tempC = 0
  on error resume next
  Set objShell = CreateObject("WScript.Shell")
  objShell.RegRead(directory & "ForceDisableB2S")
  If Err.number <> 0 Then
    PopupMessage = "This latest version of Controller.vbs stores its settings in the registry. To adjust the values, you must use VP 10.2 (or newer) and setup your configuration in the DOF section of the -Keys, Nudge and DOF- dialog of Visual Pinball."
    objShell.RegWrite directory & "ForceDisableB2S",0, "REG_DWORD"
    objShell.RegWrite directory & "DOFContactors",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFKnocker",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFChimes",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFBell",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFGear",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFShaker",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFFlippers",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFTargets",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFDropTargets",2, "REG_DWORD"
    MsgBox PopupMessage
  End If
  tempC = objShell.RegRead(directory & "ForceDisableB2S")
  DOFeffects(1)=objShell.RegRead(directory & "DOFContactors")
  DOFeffects(2)=objShell.RegRead(directory & "DOFKnocker")
  DOFeffects(3)=objShell.RegRead(directory & "DOFChimes")
  DOFeffects(4)=objShell.RegRead(directory & "DOFBell")
  DOFeffects(5)=objShell.RegRead(directory & "DOFGear")
  DOFeffects(6)=objShell.RegRead(directory & "DOFShaker")
  DOFeffects(7)=objShell.RegRead(directory & "DOFFlippers")
  DOFeffects(8)=objShell.RegRead(directory & "DOFTargets")
  DOFeffects(9)=objShell.RegRead(directory & "DOFDropTargets")
  Set objShell = nothing

  Set Controller = CreateObject("VPinSPA.Controller")
  If Err Then MsgBox "Can't load SPA"
  If tempC = 0 Then
    On Error Resume Next
    If Controller is Nothing Then
      Err.Clear
    Else
      Set B2SController = CreateObject("B2S.Server")
      If B2SController is Nothing Then
        Err.Clear
      Else
        B2SController.B2SName = B2ScGameName
        B2SController.Run()
        On Error Goto 0
        B2SOn = True
        B2SOnALT = True
      End If
    End If
  End If
End Sub


'******************************************************
'   STAND-UP TARGET INITIALIZATION
'******************************************************

'Define a variable for each stand-up target
Dim ST12, ST15 , ST85, ST86, ST23

'Set array with stand-up target objects
'
'StandupTargetvar = Array(primary, prim, swtich)
'   primary:      vp target to determine target hit
' prim:       primitive target used for visuals and animation
'             IMPORTANT!!!
'             transy must be used to offset the target animation
' switch:       ROM switch number
' animate:      Arrary slot for handling the animation instrucitons, set to 0



'Add all the Stand-up Target Arrays to Stand-up Target Animation Array
' STAnimationArray = Array(ST1, ST2, ....)
Dim STArray
STArray = Array(ST12, ST15, ST85, ST86, ST23)

'Configure the behavior of Stand-up Targets
Const STAnimStep =  0.5       'vpunits per animation step (control return to Start)
Const STMaxOffset = 6       'max vp units target moves when hit
Const STHitSound = "fx_target"  'Stand-up Target Hit sound

Const STMass = 0.2        'Mass of the Stand-up Target (between 0 and 1), higher values provide more resistance

'******************************************************
'       STAND-UP TARGETS FUNCTIONS
'******************************************************

Sub STHit(switch)
  Dim i
  i = STArrayID(switch)

  'PlayTargetSound
  STArray(i)(3) =  STCheckHit(Activeball,STArray(i)(0))

  If STArray(i)(3) <> 0 Then
    DTBallPhysics Activeball, STArray(i)(0).orientation, STMass
  End If
  DoSTAnim
End Sub

Sub STHit2(target, switch)
  'PlayTargetSound
  If STCheckHit(Activeball,target) = 1 Then
    vpmTimer.PulseSw switch
  End If
End Sub

Function STArrayID(switch)
  Dim i
  For i = 0 to uBound(STArray)
    If STArray(i)(2) = switch Then STArrayID = i:Exit Function
  Next
End Function

'Check if target is hit on it's face
Function STCheckHit(aBall, target)
  dim bangle, bangleafter, rangle, rangle2, perpvel, perpvelafter
  rangle = (target.orientation - 90) * 3.1416 / 180
  bangle = atn2(cor.ballvely(aball.id),cor.ballvelx(aball.id))
  bangleafter = Atn2(aBall.vely,aball.velx)

  perpvel = cor.BallVel(aball.id) * cos(bangle-rangle)
  perpvelafter = BallSpeed(aBall) * cos(bangleafter - rangle)

  If perpvel <= 0 or perpvelafter >= 0 Then
    STCheckHit = 0
  Else
    STCheckHit = 1
  End If
End Function


Sub DoSTAnim()
  Dim i
  For i=0 to Ubound(STArray)
    STArray(i)(3) = STAnimate(STArray(i)(0),STArray(i)(1),STArray(i)(2),STArray(i)(3))
  Next
End Sub

Function STAnimate(primary, prim, switch,  animate)
  Dim animtime

  STAnimate = animate

  if animate = 0  Then
    primary.uservalue = 0
    STAnimate = 0
    Exit Function
  Elseif primary.uservalue = 0 then
    primary.uservalue = gametime
  end if

  animtime = gametime - primary.uservalue

  If animate = 1 Then
    primary.collidable = 0
    prim.transy = -STMaxOffset
    vpmTimer.PulseSw switch
    STAnimate = 2
    Exit Function
  elseif animate = 2 Then
    prim.transy = prim.transy + STAnimStep
    If prim.transy >= 0 Then
      prim.transy = 0
      primary.collidable = 1
      STAnimate = 0
      Exit Function
    Else
      STAnimate = 2
    End If
  End If
End Function

sub DTBallPhysics(aBall, angle, mass)
  dim rangle,bangle,calc1, calc2, calc3
  rangle = (angle - 90) * 3.1416 / 180
  bangle = atn2(cor.ballvely(aball.id),cor.ballvelx(aball.id))

  calc1 = cor.BallVel(aball.id) * cos(bangle - rangle) * (aball.mass - mass) / (aball.mass + mass)
  calc2 = cor.BallVel(aball.id) * sin(bangle - rangle) * cos(rangle + 4*Atn(1)/2)
  calc3 = cor.BallVel(aball.id) * sin(bangle - rangle) * sin(rangle + 4*Atn(1)/2)

  aBall.velx = calc1 * cos(rangle) + calc2
  aBall.vely = calc1 * sin(rangle) + calc3
End Sub

' Used for drop targets and stand up targets
Function Atn2(dy, dx)
  dim pi
  pi = 4*Atn(1)

  If dx > 0 Then
    Atn2 = Atn(dy / dx)
  ElseIf dx < 0 Then
    If dy = 0 Then
      Atn2 = pi
    Else
      Atn2 = Sgn(dy) * (pi - Atn(Abs(dy / dx)))
    end if
  ElseIf dx = 0 Then
    if dy = 0 Then
      Atn2 = 0
    else
      Atn2 = Sgn(dy) * pi / 2
    end if
  End If
End Function


'*******************************************************
' End nFozzy Dampening
'******************************************************


'////////////////////////////  MECHANICAL SOUNDS  ///////////////////////////
'//  This part in the script is an entire block that is dedicated to the physics sound system.
'//  Various scripts and sounds that may be pretty generic and could suit other WPC systems, but the most are tailored specifically for this table.

'///////////////////////////////  SOUNDS PARAMETERS  //////////////////////////////
Dim GlobalSoundLevel, CoinSoundLevel, PlungerReleaseSoundLevel, PlungerPullSoundLevel, NudgeLeftSoundLevel
Dim NudgeRightSoundLevel, NudgeCenterSoundLevel, StartButtonSoundLevel, RollingSoundFactor

CoinSoundLevel = 1                                                                                                                'volume level; range [0, 1]
NudgeLeftSoundLevel = 1                                                                                                        'volume level; range [0, 1]
NudgeRightSoundLevel = 1                                                                                                'volume level; range [0, 1]
NudgeCenterSoundLevel = 1                                                                                                'volume level; range [0, 1]
StartButtonSoundLevel = 0.1                                                                                                'volume level; range [0, 1]
PlungerReleaseSoundLevel = 0.8 '1 wjr                                                                                        'volume level; range [0, 1]
PlungerPullSoundLevel = 1                                                                                                'volume level; range [0, 1]
RollingSoundFactor = 1.1/5

'///////////////////////-----Solenoids, Kickers and Flash Relays-----///////////////////////
Dim FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel, FlipperUpAttackLeftSoundLevel, FlipperUpAttackRightSoundLevel
Dim FlipperUpSoundLevel, FlipperDownSoundLevel, FlipperLeftHitParm, FlipperRightHitParm
Dim SlingshotSoundLevel, BumperSoundFactor, KnockerSoundLevel

FlipperUpAttackMinimumSoundLevel = 0.010                                                           'volume level; range [0, 1]
FlipperUpAttackMaximumSoundLevel = 0.635                                                                'volume level; range [0, 1]
FlipperUpSoundLevel = 1.0                                                                        'volume level; range [0, 1]
FlipperDownSoundLevel = 0.45                                                                      'volume level; range [0, 1]
FlipperLeftHitParm = FlipperUpSoundLevel                                                                'sound helper; not configurable
FlipperRightHitParm = FlipperUpSoundLevel                                                                'sound helper; not configurable
SlingshotSoundLevel = 0.95                                                                                                'volume level; range [0, 1]
BumperSoundFactor = 4.25                                                                                                'volume multiplier; must not be zero
KnockerSoundLevel = 1                                                                                                         'volume level; range [0, 1]

'///////////////////////-----Ball Drops, Bumps and Collisions-----///////////////////////
Dim RubberStrongSoundFactor, RubberWeakSoundFactor, RubberFlipperSoundFactor,BallWithBallCollisionSoundFactor
Dim BallBouncePlayfieldSoftFactor, BallBouncePlayfieldHardFactor, PlasticRampDropToPlayfieldSoundLevel, WireRampDropToPlayfieldSoundLevel, DelayedBallDropOnPlayfieldSoundLevel
Dim WallImpactSoundFactor, MetalImpactSoundFactor, SubwaySoundLevel, SubwayEntrySoundLevel, ScoopEntrySoundLevel
Dim SaucerLockSoundLevel, SaucerKickSoundLevel

BallWithBallCollisionSoundFactor = 3.2                                                                        'volume multiplier; must not be zero
RubberStrongSoundFactor = 0.055/5                                                                                        'volume multiplier; must not be zero
RubberWeakSoundFactor = 0.075/5                                                                                        'volume multiplier; must not be zero
RubberFlipperSoundFactor = 0.075/5                                                                                'volume multiplier; must not be zero
BallBouncePlayfieldSoftFactor = 0.025                                                                        'volume multiplier; must not be zero
BallBouncePlayfieldHardFactor = 0.025                                                                        'volume multiplier; must not be zero
DelayedBallDropOnPlayfieldSoundLevel = 0.8                                                                        'volume level; range [0, 1]
WallImpactSoundFactor = 0.075                                                                                        'volume multiplier; must not be zero
MetalImpactSoundFactor = 0.075/3
SaucerLockSoundLevel = 0.8
SaucerKickSoundLevel = 0.8

'///////////////////////-----Gates, Spinners, Rollovers and Targets-----///////////////////////

Dim GateSoundLevel, TargetSoundFactor, SpinnerSoundLevel, RolloverSoundLevel, DTSoundLevel

GateSoundLevel = 0.5/5                                                                                                        'volume level; range [0, 1]
TargetSoundFactor = 0.0025 * 10                                                                                        'volume multiplier; must not be zero
DTSoundLevel = 0.25                                                                                                                'volume multiplier; must not be zero
RolloverSoundLevel = 0.25                                                                      'volume level; range [0, 1]

'///////////////////////-----Ball Release, Guides and Drain-----///////////////////////
Dim DrainSoundLevel, BallReleaseSoundLevel, BottomArchBallGuideSoundFactor, FlipperBallGuideSoundFactor

DrainSoundLevel = 0.8                                                                                                                'volume level; range [0, 1]
BallReleaseSoundLevel = 1                                                                                                'volume level; range [0, 1]
BottomArchBallGuideSoundFactor = 0.2                                                                        'volume multiplier; must not be zero
FlipperBallGuideSoundFactor = 0.015                                                                                'volume multiplier; must not be zero

'///////////////////////-----Loops and Lanes-----///////////////////////
Dim ArchSoundFactor
ArchSoundFactor = 0.025/5                                                                                                        'volume multiplier; must not be zero


'/////////////////////////////  SOUND PLAYBACK FUNCTIONS  ////////////////////////////
'/////////////////////////////  POSITIONAL SOUND PLAYBACK METHODS  ////////////////////////////
' Positional sound playback methods will play a sound, depending on the X,Y position of the table element or depending on ActiveBall object position
' These are similar subroutines that are less complicated to use (e.g. simply use standard parameters for the PlaySound call)
' For surround setup - positional sound playback functions will fade between front and rear surround channels and pan between left and right channels
' For stereo setup - positional sound playback functions will only pan between left and right channels
' For mono setup - positional sound playback functions will not pan between left and right channels and will not fade between front and rear channels

' PlaySound full syntax - PlaySound(string, int loopcount, float volume, float pan, float randompitch, int pitch, bool useexisting, bool restart, float front_rear_fade)
' Note - These functions will not work (currently) for walls/slingshots as these do not feature a simple, single X,Y position
Sub PlaySoundAtLevelStatic(playsoundparams, aVol, tableobj)
    PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelExistingStatic(playsoundparams, aVol, tableobj)
    PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 1, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelStaticLoop(playsoundparams, aVol, tableobj)
    PlaySound playsoundparams, -1, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlayLoopSoundAtVol(playsoundparams, aVol, tableobj)
  PlaySound playsoundparams, -1, aVol * VolumeDial, AudioPan(tableobj), 0, 0, 1, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelStaticRandomPitch(playsoundparams, aVol, randomPitch, tableobj)
    PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(tableobj), randomPitch, 0, 0, 0, AudioFade(tableobj)
End Sub

Sub PlaySoundAtLevelActiveBall(playsoundparams, aVol)
        PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ActiveBall), 0, 0, 0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtLevelExistingActiveBall(playsoundparams, aVol)
        PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ActiveBall), 0, 0, 1, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtLeveTimerActiveBall(playsoundparams, aVol, ballvariable)
        PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ballvariable), 0, 0, 0, 0, AudioFade(ballvariable)
End Sub

Sub PlaySoundAtLevelTimerExistingActiveBall(playsoundparams, aVol, ballvariable)
        PlaySound playsoundparams, 0, aVol * VolumeDial, AudioPan(ballvariable), 0, 0, 1, 0, AudioFade(ballvariable)
End Sub

Sub PlaySoundAtLevelRoll(playsoundparams, aVol, pitch)
    PlaySound playsoundparams, -1, aVol * VolumeDial, AudioPan(tableobj), randomPitch, 0, 0, 0, AudioFade(tableobj)
End Sub

' Previous Positional Sound Subs

Sub PlaySoundAt(soundname, tableobj)
    PlaySound soundname, 1, 1 * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

Sub PlaySoundAtVol(soundname, tableobj, aVol)
    PlaySound soundname, 1, aVol * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub

Sub PlaySoundAtBall(soundname)
    PlaySoundAt soundname, ActiveBall
End Sub

Sub PlaySoundAtBallVol (Soundname, aVol)
        Playsound soundname, 1,aVol * VolumeDial, AudioPan(ActiveBall), 0,0,0, 1, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtBallVolM (Soundname, aVol)
        Playsound soundname, 1,aVol * VolumeDial, AudioPan(ActiveBall), 0,0,0, 0, AudioFade(ActiveBall)
End Sub

Sub PlaySoundAtVolLoops(sound, tableobj, Vol, Loops)
        PlaySound sound, Loops, Vol * VolumeDial, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
End Sub


' *********************************************************************
'                     Fleep  Supporting Ball & Sound Functions
' *********************************************************************

Dim tablewidth, tableheight : tablewidth = table1.width : tableheight = table1.height

Function AudioFade(tableobj) ' Fades between front and back of the table (for surround systems or 2x2 speakers, etc), depending on the Y position on the table. "table1" is the name of the table
  Dim tmp
    tmp = tableobj.y * 2 / tableheight-1

  if tmp > 7000 Then
    tmp = 7000
  elseif tmp < -7000 Then
    tmp = -7000
  end if

    If tmp > 0 Then
    AudioFade = Csng(tmp ^10)
    Else
        AudioFade = Csng(-((- tmp) ^10) )
    End If
End Function

Function AudioPan(tableobj) ' Calculates the pan for a tableobj based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = tableobj.x * 2 / tablewidth-1

  if tmp > 7000 Then
    tmp = 7000
  elseif tmp < -7000 Then
    tmp = -7000
  end if

    If tmp > 0 Then
        AudioPan = Csng(tmp ^10)
    Else
        AudioPan = Csng(-((- tmp) ^10) )
    End If
End Function


Function Vol(ball) ' Calculates the volume of the sound based on the ball speed
        Vol = Csng(BallVel(ball) ^2)
End Function

Function Volz(ball) ' Calculates the volume of the sound based on the ball speed
        Volz = Csng((ball.velz) ^2)
End Function

Function Pitch(ball) ' Calculates the pitch of the sound based on the ball speed
    Pitch = BallVel(ball) * 20
End Function

Function BallVel(ball) 'Calculates the ball speed
    BallVel = INT(SQR((ball.VelX ^2) + (ball.VelY ^2) ) )
End Function

Function VolPlayfieldRoll(ball) ' Calculates the roll volume of the sound based on the ball speed
        VolPlayfieldRoll = RollingSoundFactor * 0.0005 * Csng(BallVel(ball) ^3)
End Function

Function PitchPlayfieldRoll(ball) ' Calculates the roll pitch of the sound based on the ball speed
    PitchPlayfieldRoll = BallVel(ball) ^2 * 15
End Function

Function RndInt(min, max)
    RndInt = Int(Rnd() * (max-min + 1) + min)' Sets a random number integer between min and max
End Function

Function RndNum(min, max)
    RndNum = Rnd() * (max-min) + min' Sets a random number between min and max
End Function

'/////////////////////////////  GENERAL SOUND SUBROUTINES  ////////////////////////////
Sub SoundStartButton()
        PlaySound ("Start_Button"), 0, StartButtonSoundLevel, 0, 0.25
End Sub

Sub SoundNudgeLeft()
        PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeLeftSoundLevel * VolumeDial, -0.1, 0.25
End Sub

Sub SoundNudgeRight()
        PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeRightSoundLevel * VolumeDial, 0.1, 0.25
End Sub

Sub SoundNudgeCenter()
        PlaySound ("Nudge_" & Int(Rnd*2)+1), 0, NudgeCenterSoundLevel * VolumeDial, 0, 0.25
End Sub


Sub SoundPlungerPull()
        PlaySoundAtLevelStatic ("Plunger_Pull_1"), PlungerPullSoundLevel, Plunger
End Sub

Sub SoundPlungerReleaseBall()
        PlaySoundAtLevelStatic ("Plunger_Release_Ball"), PlungerReleaseSoundLevel, Plunger
End Sub

Sub SoundPlungerReleaseNoBall()
        PlaySoundAtLevelStatic ("Plunger_Release_No_Ball"), PlungerReleaseSoundLevel, Plunger
End Sub


'/////////////////////////////  KNOCKER SOLENOID  ////////////////////////////
Sub KnockerSolenoid()
        PlaySoundAtLevelStatic SoundFX("Knocker_1",DOFKnocker), KnockerSoundLevel, KnockerPosition
End Sub

'/////////////////////////////  DRAIN SOUNDS  ////////////////////////////
Sub RandomSoundDrain(drainswitch)
        PlaySoundAtLevelStatic ("Drain_" & Int(Rnd*11)+1), DrainSoundLevel, drainswitch
End Sub

'/////////////////////////////  TROUGH BALL RELEASE SOLENOID SOUNDS  ////////////////////////////

Sub RandomSoundBallRelease(drainswitch)
        PlaySoundAtLevelStatic SoundFX("BallRelease" & Int(Rnd*7)+1,DOFContactors), BallReleaseSoundLevel, drainswitch
End Sub

'/////////////////////////////  SLINGSHOT SOLENOID SOUNDS  ////////////////////////////
Sub RandomSoundSlingshotLeft(sling)
        PlaySoundAtLevelStatic SoundFX("Sling_L" & Int(Rnd*10)+1,DOFContactors), SlingshotSoundLevel, Sling
End Sub

Sub RandomSoundSlingshotRight(sling)
        PlaySoundAtLevelStatic SoundFX("Sling_R" & Int(Rnd*8)+1,DOFContactors), SlingshotSoundLevel, Sling
End Sub

'/////////////////////////////  BUMPER SOLENOID SOUNDS  ////////////////////////////
'Modifed to only play single specific bumber sound

Sub RandomSoundBumperLeft(Bump)
        'PlaySoundAtLevelStatic SoundFX("Bumpers_Top_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
    PlaySoundAtLevelStatic SoundFX("LeftJet",DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

Sub RandomSoundBumperRight(Bump)
        'PlaySoundAtLevelStatic SoundFX("Bumpers_Middle_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
    PlaySoundAtLevelStatic SoundFX("RightJet",DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

Sub RandomSoundBumperBottom(Bump)
        'PlaySoundAtLevelStatic SoundFX("Bumpers_Bottom_" & Int(Rnd*5)+1,DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
    PlaySoundAtLevelStatic SoundFX("BottomJet",DOFContactors), Vol(ActiveBall) * BumperSoundFactor, Bump
End Sub

'/////////////////////////////  FLIPPER BATS SOUND SUBROUTINES  ////////////////////////////
'/////////////////////////////  FLIPPER BATS SOLENOID ATTACK SOUND  ////////////////////////////
Sub SoundFlipperUpAttackLeft(flipper)
        FlipperUpAttackLeftSoundLevel = RndNum(FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel)
        PlaySoundAtLevelStatic ("Flipper_Attack-L01"), FlipperUpAttackLeftSoundLevel, flipper
End Sub

Sub SoundFlipperUpAttackRight(flipper)
        FlipperUpAttackRightSoundLevel = RndNum(FlipperUpAttackMinimumSoundLevel, FlipperUpAttackMaximumSoundLevel)
                PlaySoundAtLevelStatic ("Flipper_Attack-R01"), FlipperUpAttackLeftSoundLevel, flipper
End Sub

'/////////////////////////////  FLIPPER BATS SOLENOID CORE SOUND  ////////////////////////////
Sub RandomSoundFlipperUpLeft(flipper)
        PlaySoundAtLevelStatic SoundFX("Flipper_L0" & Int(Rnd*9)+1,DOFFlippers), FlipperLeftHitParm, Flipper
End Sub

Sub RandomSoundFlipperUpRight(flipper)
        PlaySoundAtLevelStatic SoundFX("Flipper_R0" & Int(Rnd*9)+1,DOFFlippers), FlipperRightHitParm, Flipper
End Sub

Sub RandomSoundReflipUpLeft(flipper)
        PlaySoundAtLevelStatic SoundFX("Flipper_ReFlip_L0" & Int(Rnd*3)+1,DOFFlippers), (RndNum(0.8, 1))*FlipperUpSoundLevel, Flipper
End Sub

Sub RandomSoundReflipUpRight(flipper)
        PlaySoundAtLevelStatic SoundFX("Flipper_ReFlip_R0" & Int(Rnd*3)+1,DOFFlippers), (RndNum(0.8, 1))*FlipperUpSoundLevel, Flipper
End Sub

Sub RandomSoundFlipperDownLeft(flipper)
        PlaySoundAtLevelStatic SoundFX("Flipper_Left_Down_" & Int(Rnd*7)+1,DOFFlippers), FlipperDownSoundLevel, Flipper
End Sub

Sub RandomSoundFlipperDownRight(flipper)
        PlaySoundAtLevelStatic SoundFX("Flipper_Right_Down_" & Int(Rnd*8)+1,DOFFlippers), FlipperDownSoundLevel, Flipper
End Sub

'/////////////////////////////  FLIPPER BATS BALL COLLIDE SOUND  ////////////////////////////

Sub LeftFlipperCollide(parm)
        FlipperLeftHitParm = parm/10
        If FlipperLeftHitParm > 1 Then
                FlipperLeftHitParm = 1
        End If
        FlipperLeftHitParm = FlipperUpSoundLevel * FlipperLeftHitParm
        RandomSoundRubberFlipper(parm)
End Sub

Sub RightFlipperCollide(parm)
        FlipperRightHitParm = parm/10
        If FlipperRightHitParm > 1 Then
                FlipperRightHitParm = 1
        End If
        FlipperRightHitParm = FlipperUpSoundLevel * FlipperRightHitParm
         RandomSoundRubberFlipper(parm)
End Sub

Sub RandomSoundRubberFlipper(parm)
        PlaySoundAtLevelActiveBall ("Flipper_Rubber_" & Int(Rnd*7)+1), parm  * RubberFlipperSoundFactor
End Sub

'/////////////////////////////  ROLLOVER SOUNDS  ////////////////////////////
Sub RandomSoundRollover()
        PlaySoundAtLevelActiveBall ("Rollover_" & Int(Rnd*4)+1), RolloverSoundLevel
End Sub

Sub Rollovers_Hit(idx)
        RandomSoundRollover
End Sub

'/////////////////////////////  VARIOUS PLAYFIELD SOUND SUBROUTINES  ////////////////////////////
'/////////////////////////////  RUBBERS AND POSTS  ////////////////////////////
'/////////////////////////////  RUBBERS - EVENTS  ////////////////////////////
Sub Rubbers_Hit(idx)
         dim finalspeed
          finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
         If finalspeed > 5 then
                 RandomSoundRubberStrong 1
        End if
        If finalspeed <= 5 then
                 RandomSoundRubberWeak()
         End If
End Sub

'/////////////////////////////  RUBBERS AND POSTS - STRONG IMPACTS  ////////////////////////////
Sub RandomSoundRubberStrong(voladj)
        Select Case Int(Rnd*10)+1
                Case 1 : PlaySoundAtLevelActiveBall ("Rubber_Strong_1"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 2 : PlaySoundAtLevelActiveBall ("Rubber_Strong_2"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 3 : PlaySoundAtLevelActiveBall ("Rubber_Strong_3"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 4 : PlaySoundAtLevelActiveBall ("Rubber_Strong_4"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 5 : PlaySoundAtLevelActiveBall ("Rubber_Strong_5"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 6 : PlaySoundAtLevelActiveBall ("Rubber_Strong_6"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 7 : PlaySoundAtLevelActiveBall ("Rubber_Strong_7"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 8 : PlaySoundAtLevelActiveBall ("Rubber_Strong_8"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 9 : PlaySoundAtLevelActiveBall ("Rubber_Strong_9"), Vol(ActiveBall) * RubberStrongSoundFactor*voladj
                Case 10 : PlaySoundAtLevelActiveBall ("Rubber_1_Hard"), Vol(ActiveBall) * RubberStrongSoundFactor * 0.6*voladj
        End Select
End Sub

'/////////////////////////////  RUBBERS AND POSTS - WEAK IMPACTS  ////////////////////////////
Sub RandomSoundRubberWeak()
        PlaySoundAtLevelActiveBall ("Rubber_" & Int(Rnd*9)+1), Vol(ActiveBall) * RubberWeakSoundFactor
End Sub

'/////////////////////////////  WALL IMPACTS  ////////////////////////////
Sub Walls_Hit(idx)
         dim finalspeed
          finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
         If finalspeed > 5 then
                 RandomSoundRubberStrong 1
        End if
        If finalspeed <= 5 then
                 RandomSoundRubberWeak()
         End If
End Sub

Sub RandomSoundWall()
         dim finalspeed
          finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
         If finalspeed > 16 then
                Select Case Int(Rnd*5)+1
                        Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_1"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_2"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_5"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 4 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_7"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 5 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_9"), Vol(ActiveBall) * WallImpactSoundFactor
                End Select
        End if
        If finalspeed >= 6 AND finalspeed <= 16 then
                Select Case Int(Rnd*4)+1
                        Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_3"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_4"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_6"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 4 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_8"), Vol(ActiveBall) * WallImpactSoundFactor
                End Select
         End If
        If finalspeed < 6 Then
                Select Case Int(Rnd*3)+1
                        Case 1 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_4"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 2 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_6"), Vol(ActiveBall) * WallImpactSoundFactor
                        Case 3 : PlaySoundAtLevelExistingActiveBall ("Wall_Hit_8"), Vol(ActiveBall) * WallImpactSoundFactor
                End Select
        End if
End Sub

'/////////////////////////////  METAL TOUCH SOUNDS  ////////////////////////////
Sub RandomSoundMetal()
        PlaySoundAtLevelActiveBall ("Metal_Touch_" & Int(Rnd*13)+1), Vol(ActiveBall) * MetalImpactSoundFactor
End Sub

'/////////////////////////////  METAL - EVENTS  ////////////////////////////

Sub Metals_Hit (idx)
        RandomSoundMetal
End Sub

Sub ShooterDiverter_collide(idx)
        RandomSoundMetal
End Sub

'/////////////////////////////  BOTTOM ARCH BALL GUIDE  ////////////////////////////
'/////////////////////////////  BOTTOM ARCH BALL GUIDE - SOFT BOUNCES  ////////////////////////////
Sub RandomSoundBottomArchBallGuide()
         dim finalspeed
          finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
         If finalspeed > 16 then
                PlaySoundAtLevelActiveBall ("Apron_Bounce_"& Int(Rnd*2)+1), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
        End if
        If finalspeed >= 6 AND finalspeed <= 16 then
                 Select Case Int(Rnd*2)+1
                        Case 1 : PlaySoundAtLevelActiveBall ("Apron_Bounce_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
                        Case 2 : PlaySoundAtLevelActiveBall ("Apron_Bounce_Soft_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
                End Select
         End If
        If finalspeed < 6 Then
                 Select Case Int(Rnd*2)+1
                        Case 1 : PlaySoundAtLevelActiveBall ("Apron_Bounce_Soft_1"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
                        Case 2 : PlaySoundAtLevelActiveBall ("Apron_Medium_3"), Vol(ActiveBall) * BottomArchBallGuideSoundFactor
                End Select
        End if
End Sub

'/////////////////////////////  BOTTOM ARCH BALL GUIDE - HARD HITS  ////////////////////////////
Sub RandomSoundBottomArchBallGuideHardHit()
        PlaySoundAtLevelActiveBall ("Apron_Hard_Hit_" & Int(Rnd*3)+1), BottomArchBallGuideSoundFactor * 0.25
End Sub

Sub Apron_Hit (idx)
        If Abs(cor.ballvelx(activeball.id) < 4) and cor.ballvely(activeball.id) > 7 then
                RandomSoundBottomArchBallGuideHardHit()
        Else
                RandomSoundBottomArchBallGuide
        End If
End Sub

'/////////////////////////////  FLIPPER BALL GUIDE  ////////////////////////////
Sub RandomSoundFlipperBallGuide()
         dim finalspeed
          finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
         If finalspeed > 16 then
                 Select Case Int(Rnd*2)+1
                        Case 1 : PlaySoundAtLevelActiveBall ("Apron_Hard_1"),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
                        Case 2 : PlaySoundAtLevelActiveBall ("Apron_Hard_2"),  Vol(ActiveBall) * 0.8 * FlipperBallGuideSoundFactor
                End Select
        End if
        If finalspeed >= 6 AND finalspeed <= 16 then
                PlaySoundAtLevelActiveBall ("Apron_Medium_" & Int(Rnd*3)+1),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
         End If
        If finalspeed < 6 Then
                PlaySoundAtLevelActiveBall ("Apron_Soft_" & Int(Rnd*7)+1),  Vol(ActiveBall) * FlipperBallGuideSoundFactor
        End If
End Sub

'/////////////////////////////  TARGET HIT SOUNDS  ////////////////////////////
Sub RandomSoundTargetHitStrong()
        PlaySoundAtLevelActiveBall SoundFX("Target_Hit_" & Int(Rnd*4)+5,DOFTargets), Vol(ActiveBall) * 0.45 * TargetSoundFactor
End Sub

Sub RandomSoundTargetHitWeak()
        PlaySoundAtLevelActiveBall SoundFX("Target_Hit_" & Int(Rnd*4)+1,DOFTargets), Vol(ActiveBall) * TargetSoundFactor
End Sub

Sub PlayTargetSound()
         dim finalspeed
          finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
         If finalspeed > 10 then
                 RandomSoundTargetHitStrong()
                RandomSoundBallBouncePlayfieldSoft Activeball
        Else
                 RandomSoundTargetHitWeak()
         End If
End Sub

Sub Targets_Hit (idx)
  PlayTargetSound
  TargetBouncer Activeball, 1
End Sub

'/////////////////////////////  BALL BOUNCE SOUNDS  ////////////////////////////
Sub RandomSoundBallBouncePlayfieldSoft(aBall)
        Select Case Int(Rnd*9)+1
                Case 1 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_1"), volz(aBall) * BallBouncePlayfieldSoftFactor, aBall
                Case 2 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_2"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.5, aBall
                Case 3 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_3"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.8, aBall
                Case 4 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_4"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.5, aBall
                Case 5 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Soft_5"), volz(aBall) * BallBouncePlayfieldSoftFactor, aBall
                Case 6 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_1"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
                Case 7 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_2"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
                Case 8 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_5"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.2, aBall
                Case 9 : PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_7"), volz(aBall) * BallBouncePlayfieldSoftFactor * 0.3, aBall
        End Select
End Sub

Sub RandomSoundBallBouncePlayfieldHard(aBall)
        PlaySoundAtLevelStatic ("Ball_Bounce_Playfield_Hard_" & Int(Rnd*7)+1), volz(aBall) * BallBouncePlayfieldHardFactor, aBall
End Sub

'/////////////////////////////  DELAYED DROP - TO PLAYFIELD - SOUND  ////////////////////////////
Sub RandomSoundDelayedBallDropOnPlayfield(aBall)
        Select Case Int(Rnd*5)+1
                Case 1 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_1_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
                Case 2 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_2_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
                Case 3 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_3_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
                Case 4 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_4_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
                Case 5 : PlaySoundAtLevelStatic ("Ball_Drop_Playfield_5_Delayed"), DelayedBallDropOnPlayfieldSoundLevel, aBall
        End Select
End Sub

'/////////////////////////////  BALL GATES AND BRACKET GATES SOUNDS  ////////////////////////////

Sub SoundPlayfieldGate()
        PlaySoundAtLevelStatic ("Gate_FastTrigger_" & Int(Rnd*2)+1), GateSoundLevel, Activeball
End Sub

Sub SoundHeavyGate()
        PlaySoundAtLevelStatic ("Gate_2"), GateSoundLevel, Activeball
End Sub

Sub Gates_hit(idx)
        SoundHeavyGate
End Sub

Sub GatesWire_hit(idx)
        SoundPlayfieldGate
End Sub

'/////////////////////////////  LEFT LANE ENTRANCE - SOUNDS  ////////////////////////////

Sub RandomSoundLeftArch()
        PlaySoundAtLevelActiveBall ("Arch_L" & Int(Rnd*4)+1), Vol(ActiveBall) * ArchSoundFactor
End Sub

Sub RandomSoundRightArch()
        PlaySoundAtLevelActiveBall ("Arch_R" & Int(Rnd*4)+1), Vol(ActiveBall) * ArchSoundFactor
End Sub


Sub Arch1_hit()
        If Activeball.velx > 1 Then SoundPlayfieldGate
        StopSound "Arch_L1"
        StopSound "Arch_L2"
        StopSound "Arch_L3"
        StopSound "Arch_L4"
End Sub

Sub Arch1_unhit()
        If activeball.velx < -8 Then
                RandomSoundRightArch
        End If
End Sub

Sub Arch2_hit()
        If Activeball.velx < 1 Then SoundPlayfieldGate
        StopSound "Arch_R1"
        StopSound "Arch_R2"
        StopSound "Arch_R3"
        StopSound "Arch_R4"
End Sub

Sub Arch2_unhit()
        If activeball.velx > 10 Then
                RandomSoundLeftArch
        End If
End Sub

'/////////////////////////////  SAUCERS (KICKER HOLES)  ////////////////////////////

Sub SoundSaucerLock()
  PlaySoundAtLevelStatic ("Saucer_Enter_" & Int(Rnd*2)+1), SaucerLockSoundLevel, Activeball
End Sub

Sub SoundSaucerKick(scenario, saucer)
        Select Case scenario
                Case 0: PlaySoundAtLevelStatic SoundFX("Saucer_Empty", DOFContactors), SaucerKickSoundLevel, saucer
                Case 1: PlaySoundAtLevelStatic SoundFX("Saucer_Kick", DOFContactors), SaucerKickSoundLevel, saucer
        End Select
End Sub

'/////////////////////////////  BALL COLLISION SOUND  ////////////////////////////
Sub OnBallBallCollision(ball1, ball2, velocity)
        Dim snd
        Select Case Int(Rnd*7)+1
                Case 1 : snd = "Ball_Collide_1"
                Case 2 : snd = "Ball_Collide_2"
                Case 3 : snd = "Ball_Collide_3"
                Case 4 : snd = "Ball_Collide_4"
                Case 5 : snd = "Ball_Collide_5"
                Case 6 : snd = "Ball_Collide_6"
                Case 7 : snd = "Ball_Collide_7"
        End Select

        PlaySound (snd), 0, Csng(velocity) ^2 / 200 * BallWithBallCollisionSoundFactor * VolumeDial, AudioPan(ball1), 0, Pitch(ball1), 0, 0, AudioFade(ball1)
End Sub


'/////////////////////////////////////////////////////////////////
'                                        End Mechanical Sounds
'/////////////////////////////////////////////////////////////////


'*****************************************
'*** TopperFlasherVR code below - Rawd ***
'*****************************************

Sub TopperFlasherTimer_Timer()
Fl169.X = Fl169.X +5
Fl170.X = Fl170.X +5
If Fl169.X>=235 then
Fl169.X = 10
Fl170.X = 705
End If
End Sub

Sub TopperIntroFlasherTimer_Timer()
TestFlasher1.X = TestFlasher1.X +5
TestFlasher2.X = TestFlasher2.X +5
If TestFlasher1.X>=235 then
TestFlasher1.X = 10
TestFlasher2.X = 705
End If
End Sub

Sub TopperIntroFlasherTimer2_Timer()
if TestFlasher1.visible = false Then
TestFlasher1.visible = true
Else
TestFlasher1.visible = false
end If
if TestFlasher2.visible = false Then
TestFlasher2.visible = true
Else
TestFlasher2.visible = false
end If
End Sub

Sub TopperIntroFlasherEndTimer_Timer()
TopperIntroFlasherTimer2.enabled = False
TopperIntroFlasherTimer.enabled = False
TestFlasher1.visible = false
TestFlasher2.visible = false
End Sub

'***********************************
' Floating Book VR code below - Rawd
'***********************************

Dim BookMove: BookMove = 3
Dim BookMove2: BookMove2 = 4
Dim Bookrot:Bookrot=.1
Dim Bookrot2:Bookrot2=.13
Dim Puffrot:Puffrot=.06

'***********************************
' VR Room swap code below..
'***********************************

Dim Object ' for grouping VR objects to toggle...

Sub LoadMinimalRoom()  ' makes all VRRoom components invisible and turns off all animation timers

  SlimerVR.StopAnim
  LightChangerTimer.enabled = false
  LightFlickerTimer.enabled = false

  'Animated book stuff...
  for each Object in VRBooks: object.visible = 0: next
  StackTrigger.enabled = false  ' resets book trigger if you switch rooms
  FBook1.visible = false ' for stacking animation
  StackTimer.enabled = false
  IncomingBookTimer.enabled = false
  StackShadow.ImageA = "Trans"
  StackTrigger.enabled = false

  'Send flying book back to starting position
  FBook1.x = 2167
  FBook1.y = -7200
  FBook1.z = -2000
End Sub


Sub LoadVR360Room()  ' Loads all VRRoom components and starts animation timers

  SlimerVR.PlayAnimEndless(0.005)
  LightChangerTimer.enabled = true
  LightFlickerTimer.enabled = true

  'Animated book stuff...
  for each Object in VRBooks: object.visible = 0: next  ' make sure the book animation isnt runnon and books aren seen
  StackTrigger.enabled = true  ' resets book trigger if you switch rooms
  IncomingBookTimer.enabled = false
  FBook1.visible = true ' for stacking animation
  'Send flying book back to starting position
  FBook1.x = 2167
  FBook1.y = -7200
  FBook1.z = -2000
  StackNumber = -1
  ShadowNumber = -1
  StackShadow.ImageA = "Trans"
End Sub


'****************************************************************************************************************************************************
'EVERYTHING BELOW THIS IS FOR THE ANIMATED COIN DOOR AND MANUAL ANIMATION - Put at the bottom of the script. Original code by 3rdAxis
'****************************************************************************************************************************************************
'AXS Coindoor****************************************************************************************************************************************
Sub CoindoorTimer_Timer()
  ' shaking the key and manual float motion here.. full time (NOW ONLY WHEN CALLED FOR 17 Seconds),  The ball will hit the gate when WobbleBall.vely is called.
  VR_KeyShake.rotx= -90 - Gate001.Currentangle / - 6
  VR_KeyShake.rotz= 0 - Gate002.Currentangle / - 6
  VRManualInstructions.transy= 0 - Gate002.Currentangle / - 10
  ManualBinder.transy= 0 - Gate002.Currentangle / - 10
  '*************************************************************************************************************************************
  '                                         COINDOOR OPEN/CLOSE TIMER - RASCAL & RAWD
  '*************************************************************************************************************************************
  If DCO = True Then
    If DoorMove = -1 then VR_KeyShakeOpen.Visible = 1:VR_KeyShake.Visible = 0
    For Each CDA in CoindoorAll:CDA.RotY = CDA.RotY + DoorMove:Next    ' This is the main coin door animation command.  It moves all parts together in an ungrouped collection.
    If VR_CoinDoor.RotY <= -130 then DCO = False:DoorMove=1 :MA = true: keykicker2.Kick 0, 10    ' -130 is the door angle, set that here.
    If VR_CoinDoor.RotY >= 0 then DCO = False:DoorMove=-1:VR_KeyShakeOpen.Visible = 0:VR_KeyShake.Visible = 1 : DoorReady = true
  End If
  If MA = True Then
    VRManualInstructions.objrotx = VRManualInstructions.objrotx + ManualMove
    ManualBinder.objrotx = ManualBinder.objrotx + ManualMove
    if VRManualInstructions.objrotx > 164 Then MA = false: ManualMove = -1: DoorReady = true ' 164 is the instruction manual angle, set that here.
    if VRManualInstructions.objrotx < 1 Then MA = false: ManualMove = 1 : PlaySound "CoindoorClose": DCO = true: keykicker2.Kick 0, 10
  End If
  '*************************************************************************************************************************************
End Sub

'***********************************
' Flying stacking books - Rawd
'***********************************

Sub StackTrigger_hit()
  'if VRRoom = 1  then  ' only run this in Library
  StackTimer.enabled = true
  IncomingBookTimer.enabled = true
  StackTrigger.enabled = false  ' only runs once.
  'End If
End Sub

Dim Stacknumber:StackNumber = -1
Dim BookColour:BookColour = 1
Dim ShadowNumber:ShadowNumber = -1

Sub StackTimer_Timer()
  StackNumber = StackNumber + 1
  ShadowNumber = ShadowNumber + 1
  If ShadowNumber = 38 then ShadowNumber = 37
  StackShadow.ImageA = "BS" & ShadowNumber
  VRBooks(StackNumber).visible = true
  If Stacknumber = 44 then
    StackNumber = -1
    ShadowNumber = -1
    StackTimer.enabled = false
    IncomingBookTimer.enabled = false
    'Send flying book back to starting position
    FBook1.x = 2167
    FBook1.y = -7200
    FBook1.z = -2000
    Exit Sub
  End if
End Sub

Sub IncomingBookTimer_Timer()
  FBook1.Y = FBook1.Y + 300
  If FBook1.Y > -685 Then
    FBook1.Y = -7200
    FBook1.Z = FBook1.Z + 95
    FBook1.image = "VRBookS" & BookColour
    BookColour = BookColour + 1
    if BookColour = 9 then BookColour = 1
  End if
End Sub


'***********************************
' Room lights random flicker
'***********************************
Dim LightNumber
LightNumber = 8

Sub LightFlickerTimer_Timer()
  If VRROOMLIGHTS(LightNumber).opacity =200 Then
    VRROOMLIGHTS(LightNumber).opacity =50
  Else
    VRROOMLIGHTS(LightNumber).opacity =200
    LightFlickerTimer.Interval = Int(Rnd*150)+1
  End if
End Sub

Sub LightChangerTimer_Timer()
  LightNumber = Int(Rnd*8)+1  ' random light 0-8
End Sub

'VR Plunger...
Sub TimerVRPlunger_Timer
  If Pincab_plunger.Y < 2375 then
  Pincab_plunger.Y = Pincab_plunger.Y + 5
 End If
End Sub

Sub TimerVRPlunger2_Timer
  Pincab_plunger.Y = 2310 + (5* Plunger.Position) -20
End Sub





