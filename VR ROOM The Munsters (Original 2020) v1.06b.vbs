'
'                                                                          .***/(%*.....,*(#%#%&%%/      ,,.          *((.
'                                                                          &&%%#(##%%%%####//######    .%%%#,  .&%%%&%%&&%&%##
'                                                                          &%#%#####%%%#/    ,%&%(      %&#(    .&%#(.*/*.#%#/
'                                                                          &%###* *#%%##.    .%%#(     .%%#(,   .&&#,     .(#/
'                                                                          *###,  %##%%#.     #%##%&&%#/%&##/   .&&%%&%&%%%(
'                                                                                  .#&##     .%%#(*####%&%(%#   .&&#*...#&%*
'                                                                                  .%%##.    ,%%%,     (&%/*(   *%##*   ./,
'                                                                                   (#(#,     //*,     #%#(.    .#%(/,/*.  ..,.
'                                                                                   *%#       ,%(/     .%##      (%&%%#((%%&&%#,
'                                                                                   /##.      ,%%,       *(      .&###*     %&%
'                                                                                   (##,       ##(                *&%##     ##,
'                                                                                    (*        .*.                 ,**                                                                     ./#
'                                    ,/(####%##(%%*                                                        .&&&&&&&&&%(#%%&%&%%&&%%%%&&&&%&&&&&%%%#%%#(                                *&%&%%%%&%%
'               ,((                 %&&%%%%#%%%#(#/                                                        .#%%#%&%%&%%%%%%#((#%%%##%%#((#%%%%%&&&&%##(                              .&&%#/(%#%#%%#*
'     *%%&&%&%%%%%#.              /&%&%((%%(*,*#                               /((#                        .%%%(*,*/(((*(###/(##%&%##*,/***/****(&&&#*(                            .%&&%(*(#//#%&%#//
'       %&%####%#/((              #####%%##(*/,                               ,###/#/                       /###(             /&%%%*.#             (/#(      #&%%****.   .(,      #&&%%#,#,     *%%/#
'      ,#%%%##(#%#(#             ,%#%###%%%#/(,                               *(#%#(##.       *#%&%&%%%#,                      %#%/.(%     #&&%%%%%%%%%&&%&*.&%%%&&%%%&%&&&&%/   .&%%&##        ,&#((
'      ,#&##%((%%%/#.            ##%%####%%#/#*   *&%&#%&%%                    *(#%#((/        /%%%%%((.    .%%&&&%&%%#*      %#%%#,*%    %%%##//(/*//(%##/  (%%%####(#%##%%/#%* *&%%%/*        #%%#*
'       *##%#%%%%%/((           (#%%%%%%#%%#/#*  (&%%%#//##                    ##(#%#(*/      .(##%%#(#,   %&%%(/###%%#%#    /%#%%#(/#   ,&%%//#.     (%%%/  ,%%%//. .(#(*#%#&%* &&%#/*,       *%%%#*
'        ##%%#(%#%#/((         ,%%%####%#%%%(#.  &&%%%%/((#       ,#%&&%%##/   /%#%%%(#(#(    #&&%&%#*((  (%##,    .##%##%    *#%%%###   ,&%%(*/       #%%(  *&&%//.     *&%%(#/ #%#%##/      ,&&&(##
'        ##%%((#%&%#/(*        /##(///(#%%%#((   (&%%%%##/(        #%&%#%##    (%#%&%#(###/    #&&%%#*(( /&%#,       (%%%##    ##&%(%#/  (&%&//((     ,%&%##.#&&%#/(      #%%##( *#(%%#(*     %%%(
'       *#%%%*#**%&%##/      .%&%#%((*##%%###(   #&%%%%%##(        &(%%%(.#    /##%&%%(#%##*    ,(##*/#/.%%#(        ,%&%#(,   (&%%/%#(  (%%%**,/      ,(((* #%%%#/#,     ,&#*/* .#(%%%/(*
'       *%%%#,.#*#%&%##      *&%%%###.##&%%##(  .&%%%%&%(#(        ##%&&#*#    /##%%%%*##/##/    /##%## #&%##,       #%&%(/#   %%&&//##  *&%%#(/(           #&%&%%(#,     ,##(#   /(%%%%#%%
'       /&%%/.*(##%%(///   .*##%%%##( /#&%%##*   /#(#&&&%#(        &#%&%#(#    /##%//#%%%#%###/  /##(#, %&%%#/.      ./%##    *%%%%/*#/  (&&%#((.          ,%&%%##/(     ,%%((/   ((&#%&#(%&,
'       /#/*(####./####(.  (#%%&%%##, ,##(//(,     (/%%#((((       /%%%####     (#%#/(/%&(%%###.#%%#/#  ,&%%#,*.       *%#     ##%%#(#   (&&%%((/.     *(   .(##%/((((///%%#*(      (%&%%(*##/
'       ./,##%%(#. (####(  ,&%%%#**(  #%(##(#/     %##/((#         (%%%%#(#    (%&%(/# *%&%%(/%/,#%#/(   (*/((/(/      ,%%/   /*(%%%##(  &%&%#/*#&%%%&%##,  ,&&%%##%%&%%%(*//       *%&%%%(/%#/
'         /%#%%//. ,##%##/ *&%#%#(#* *%&%%%(/(    ,%#%//#(         (&%%#/##     %%%#//   %%%#/(#/(%%#(     /##%(##.      ,    (&%%#%%#(  &(*/((%%#%%%%%%(.  /&%%#/####&%##.          #%%%#//&##.
'         ,#%%#//*  ,%%%#( (&%#####.  *%#%%##.     %#%###(          ###(##(     (%%#(/    ##(*(%%%%#/#.     (#%%%#/(          *&%%%#(,  *%((##//     *%%#.  %&##%(/( ,%&%#(.              ##%%(&*
'         .(%%#,/*  ,%%%#( #&%#(/##.  #%%&&%#/    .##%##((           ##(##*     #&%%/(.   ,(###%%%%(*(      /#%%##((#(        /#%%##*      *##(*      *##.  /##%%//,  (&%%###              #&%#(%*
'          /%%#*/.  ,%%%#(/&%%#((%#. (##%%&%##   (##%%#(,/         ./#%#%##/    (%%(*,    (##(%%%%%//#.      %&%/#%####,      %%%###/     %%##(.              (%%(/,   .##%#(              %&&#*/#
'          %&#(,/    (///(%%%%#####,  (##%#((#    (#%%%(,          /##%(###     (#/*(#     ,. ##%%%(/#*        (#//%%//(      %%%%(((    .&#%/(.             (%%%#/(    .##%##(            #((*/#((
'         .%/,*((     .#%%%%%##,      /###(###    /%%%%##          *##&###     ,##//#         .##%%%(/            /#%%(/#     &#%%#/#     %%%(/       %%/    %%%%#*/     /(&%%##             /%%#((
'          ..####.     ,%%%%%##.      *#%%####     ,((((#          ,#%%(#(     (%&(/           .##%%#/             ,#%((%#,   **#%%*#*    %%%#(#&%%#%&&/(    %&&%#(      .#(&%#%&/           *&%##(
'            (#//*      (%%%#/.       (%&%###(      (#//#          /#&&%#/     #%&%#.           (##%#/              */#%#&#     %%(*(/   /&%%%#%%%%%%%%(*   .##&%%/*      .#%%%#%&&(((*      /&%#(,
'            (#(**      .%(*..       /%%%##(#(      ###*#*          *#%(//    *%&%##*            (%%*/              *#%#(/#*   %&%((*    (&&&%((%%%#/#&%/    ,###%#/       /#&%%(/#%%(%*     #%&//
'          ,###%/(      .%###.       .%%%%#/        %%%/,(*        (##(/#/   ##%%%#(            /#%%*/               (%%#(*    &&%##     (%&(,,(####(#%#/.     *%##*        *#**/,*%%%#,   /&%#(#
'          /###%##      ,#%##.        /#/%##/       ##&%//##(,  #&&%&%//#   (%%%##(              /(**,              (%%%#*     ###**      /           #(*      ,#(*.              .##(#   /%%%#(
'           (#&%#(      ,####.         .###(          #((#%%%&%&%%/#%%/,   *##(*(%#/              *##(              (##(/      /*(#,                 ,%/*      ,#%/.               *%&%###%//*
'            #&%#(        /##.          (###           /##%%%%##%%/(#,         ,%%##               /.            #%%(##,        /%#,                 *###.     ,#%(    /%&&%#####%&%&%(***
'            *#/*         (###.        .#&%#(             (%&%(*#&/              (#*                  .*.     ,%%/*/#,          &&#,                            (#(  /&%&%%&&(,,,,,,/,
'            (#/           ,/.         /#%##*              ###/*/%(               ,#&&%%##,,%#/#%%%##%&&&&%%&#//#%,             #%#                             /#(  %%&#*,  **
'            /#/((                      (##*                #//* /         .#%&%%%%&&%%(/(((###%%(*,,*/#%%%(*   /                                              ,%#(  (/*(*
'            *##/.                      .##/                (##*         .#%#//#&%#(#(*.,(##(###(**((((%&%(,                                                   ,&%/  .##.
'             ###.                      *%#.                &%((         /#(.(%&%#/            (#.    .%%%##,                                                   %#*  #%#(
'             (#(                       (##.                 .              *#%%%/            /&#,      .                                                    /&%%#*
'             (#                        ###*                                                 #&%%#,                                                         *%%%#(
'            (##                        #%%##*                                               #%&%#(
'           *%##,                       #%%##.                                               (#%%##.
'                                        ,*.                                                  .,,,
'
' Allknowing2012 - Please dont redistribute at this time... Free to Mod in 2021.
' 2020 - Stay Safe Everyone
' v1.05DOFe
' v1.06 - based on Solters VR version ov 1.05.
'        and now Scorbit activated
' My Channel: https://www.youtube.com/channel/UCi9jCs_DmgtHWqLVPf5_7rA


Option Explicit
Randomize

' *************** UPDATE THIS!!! ********************
Dim osbdefinit:osbdefinit="H.M"      ' Herman Munster -  ' your initials to use - for the ONLINE Scoreboard!!  *** CHANGE THIS ***


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' THANKS:
'   Franck Hollinger/Mussinger - Doing the awesome redraw of the playfield ...WOW!
' NailBusters - Updating the PUP configs and providing the 2/3 screen configs and mentoring minions like me :-)
' Mr. H - Doing the fabulous Pup/3D Ramps and Models (Jens Leinensetter for providing the Herman pics)
'   ScottyWic - doing the behind the scenes magic to support the Orbital Scoreboard
'   Arngrim - DOF Edits and Updates to dofconfig website
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'   TODO & BUGS
'
'   better timing for mystery AwardGrandpa
'   jackpot value gauge on dmd
'   mMadness -  track areas completed on display
'   add timeouts to stage3
'   Hands on the Raven Clock
'   extra ball video show at wrong time .. perhaps just in the folder by mistake
'   gi flashing doesnt work .. seems nobody is using it other then attract mode
'   after mmadness .. need to relight spot shot lights?
'   is add a ball working?
'   score jackpot - code the "cancel jackpot" ability
'   raven jackpot from Mystery needs to put you into MB mode
' raven boost "Sound-0x0864 - raven boost" - when can you get Raven Boost?
'   code combos
'   missing bg music occasionaly - may have fixed
'   No plans to code Midnight Madness - its too late to being playing pinball anyways ... lol.
'   herman magnet on again after lily/grandpa?
'
'
'
'   Changes
'   1.00a
' Replaced PF Image, Removed test code for MMadness, increased ball saver time
'   grandpa awards herman but leaves the magnet on!
'   1.02 - Bugs - Mystery Award - Changes to Herman and other Awards
'         - grandpa lab relights on eject even though you have it already
'               - tweak the blades
'               - Added Orbital Scoreboard and submission see www.orbitalpin.com
'       - track high scores for each mode
'       - extraball was not lighting the shoot again light
'       - Marilyn was not scoring the individual jackpots, only the SJP
'         - marilyn videos when scoring a boyfriend
'       - backboard flashers
'         - 65 more callouts
'         - add checks for each mode high score
' 1.03 - PUP Updates and New Media (grab the media zip File!!) - Thanks Nailbuster & Jamie!
'    - tweak the plunger top corner wall
'    - removed the dummy walls, dummy.
'    - tweak lights
'    - Herman magnet is reported to be on even after playing herman mode.
'        - changed magnasave keycode to the leftmagnasave builtin etc
'        - EOB noises, bug in music playing/not playing
'        - Scoreboard is live -- Update your initials in the script!!
'   1.04 - writes to local scores was not being called and fix to save initials
' (unrel)- top of Orbit stopper is now UP during ball lanuch
'    - change scoop eject speed/angle.  Dont lower the music so much for call outs, tweak pf physics, autoplunge strength, flippers
'    - added lockbarkey as a valid key for zap button
'    - remove unused code
'        - grandpa mode - complete purple targets to light add timer, bug - grandpas lab comes on again
'    - light kitty on any lily completions - makes spot a bit easier to obtain
'        - another tweak to herman magnet, turn off magnet flag at end of hermanmode
'      - soft plunge lost the ball
'        - pause timer when in grandpa eject if only 1 ball
'        - clean up end of ball video/bonus screen from messsing up if end of mode was kicked off
'        - tilt - clear dragula lane
'      - bumper flashers
'    - award grandpa shouldnt start timer until its kicked out
'      - show the score zap jackpots image  (Requires adding .mp4 to VideoJackpots folder!!!)
'        - super skill shot lowers the top drop post
'   1.05 - DOF, New Graphics!, New Primitives!, New Physics!, Added Audio to the TV Clips
'        - quick fix for plunger strength and metal rolling sound
'   1.06 - Scorbit added .. see options below
'    - commented out the Oribital Scoreboard as it is very slow and not seemingly used - move to scorbit :-)
'    - removed the bug where you could collect the total bonus over and over.
'
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
' MODES
'
' Raven - 3 Ball Multiball, Left Ramp Restart
' Herman - 2 or 3 ball Multiball
' Spot - Hit Spot Bash Toy
' Lily - Everyting Scores More
' Grandpa - Jackpots
' Eddie - Orbit Loops
' Marilyn - Collect Ramp Boyfriends
' Zap Jackpots - collect zaps (magnasave key) then collect zap jackpots
' MunsterMadness - 4 ball multiball
'   stage 1 - complete an area
' stage 2 - collect jackpots
' stage 3 - collect hurry ups, repeat
' x 3 Levels
' Boosts
' Mystery AwardSpot
' Kitty AwardSpot
' Dragula Awards
'
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' PUP Docs - I have gathered ...
'
' PuPlayer.playlistplayex pScreen, pFolder,pFileName,pVolume,pPriority
' PuPlayer.playlistadd pScreen,pFolder,sort/alpha/shuffle,pRestseconds
'Setup Pages.  Note if you use fonts they must be in FONTS folder of the pupVideos\tablename\FONTS
'syntax - PuPlayer.LabelNew <screen# or pDMD>,<Labelname>,<fontName>,<size%>,<colour>,<rotation>,<xAlign>,<yAlign>,<xpos>,<ypos>,<PageNum>,<visible>
'<screen#>, in standard wed set this to pDMD ( or 1)
'<Labelname>, your name of the label. keep it short no spaces (like 8 chars) although you can call it anything really. When setting the label you will use this labelname to access the label.
'<fontName> Windows font name, this must be exact match of OS front name. if you are using custom TTF fonts then double check the name of font names.
'<size%>, Height as a percent of display height. 20=20% of screen height.
'<colour>, integer value of windows color.
'<rotation>, degrees in tenths   (900=90 degrees)
'<xAlign>, 0= horizontal left align, 1 = center horizontal, 2= right horizontal
'<yAlign>, 0 = top, 1 = center, 2=bottom vertical alignment
'<xpos>, this should be 0, but if you want to force a position you can set this. it is a % of horizontal width. 20=20% of screen width.
'<ypos> same as xpos.
'<PageNum> IMPORTANT! this will assign this label to this page or group.
'<visible> initial state of label. visible=1 show, 0 = off.

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' DOF Config by Arngrim

'101 Flipper Left
'102 Flipper Right
'103 Slingshot Left
'104 Slingshot Right
'105 Slinshot Left Flasher
'106 Slingshot Right Flasher
'107 Bumper Left
'108 Bumper Center
'109 Bumper Right
'110 Bumper Left Flasher
'111 Bumper Center Flasher
'112 Bumper Right Flasher
'114 Ball Release
'115 Strobe with Knocker, AutoPlunger, Kickers
'116 Scoo Center Eject
'117 Scoopwall target
'118 Drain
'119 SpotWall Hit
'120 sw40 and sw41 targets
'121 sw31 Hit
'122 Car Plunger
'123 sw28 Hit
'124 Spinner
'125 Strobe for Award and Super Skillshot
'126 RGB Undercab GI
'127 Beacon Multiball
'128 Left Upper Lane
'129 Right Upper Lane
'130 Left Loop
'131 Right Loop
'132 Strobe 500 ms
'133 sw37 and sw38 Hit
'134 sw39 Hit
'135 Magnet Shaker
'136 Knocker
'140 Start Button Light
'150 Red Flasher 2 seconds
'151 Red Flasher 5 seconds
'152 Green Flasher
'153 Blue Flasher
'154 Magenta Flasher
'155 Yellow Flasher 2 seconds
'156 Yellow Flasher 5 seconds
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Player Options
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

toppervideo = 1 'set to 1 to turn on the topper
ballrolleron = 0 ' set to 0 to turn off the ball roller if you use the "c" key in your cabinet


Const LilyTime=20         ' Time before you lose a target
Const LilyModeTime=60       ' how long to hit switches for jackpot
Const DragTime=8
Const LilySwHitsNeeded=100    ' Number of switch hits before SJP

DIM PupVideos
Dim VolSfx:VolSfx = 0.7


'============================
'  Orbital Scoreboard
'============================

Dim osbid:      osbid="" 'MMadness"                             ' your orbital scoreboard login name or use the default MMadness code
Dim osbkey:    osbkey="" '09dcddca-8710-11ea-97f8-42010a8a06b6" ' your orbital scoreboard api key or use the default Munster Table code

'============================
'  Scorbit Scoreboard
'============================

Const ScorbitActive       = 0   ' Is Scorbit Active
Const     ScorbitShowClaimQR  = 1   ' If Scorbit is active this will show a QR Code in the bottom left on ball 1 that allows player to claim the active player from the app
Const     ScorbitClaimSmall   = 0   ' Make Claim QR Code smaller for high res backglass
Const     ScorbitUploadLog    = 0   ' Store local log and upload after the game is over
Const     ScorbitAlternateUUID  = 0   ' Force Alternate UUID from Windows Machine and saves it in VPX Users directory (C:\Visual Pinball\User\ScorbitUUID.dat)


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  FRAMEWORK Options
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  Const typefont = "Raleway Medium"
  Const numberfont = "Bebas Neue"
  Const romanfont = "Roman Font 7"
  Const zoomfont = "Fundamental Brigade"
  Const jackpotfont = "BlackCastleMF"
  Const jnumberfont = "AnglicusOpti"
  Const stencilfont = "Stardos Stencil"
  Const munsterfont = "1313 MockingbiRd Lane"
  Const zoombgfont = "Fundamental 3D  Brigade" ' needs to be an outline of the zoomfont
  Const scorefont = "AkiNixieNumber" '"Comic Neue" '"Nixie One"
  Const cGameName = "mmunsters"
  Const TableName = "mmunsters"
  Const myVersion = "1.06"

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  VARIABLES
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'

  'Constructions
  Const BallSize = 50
  Const MaxPlayers = 4
  Const BallSaverTime = 15   ' not used?
  Const MaxMultiplier = 6
  Const MaxMultiballs = 5
  Const bpgcurrent = 3

  Const Herman=1
  Const Spot=2
  Const Lily=3
  Const Ray=4
  Const Raven=5
  Const Eddie=6
  Const Marilyn=7
  Const Zap=8
  Const Mystery=9
  Const Grandpa=10
  Const Madness=11

  ' Define Global Variables

  Dim curPage  ' Which pup page is being shown
  Dim toppervideo
  Dim ballrolleron
  Dim PlayersPlayingGame
  Dim CurrentPlayer
  Dim BonusPoints(4)
  Dim BonusMultiplier(4)
  Dim Modes(4,11)   ' 4 Players, 5 Modes, level 0,1,2 Level completed  Herman/Grandpa/Raven/Lily/Spot/Marilyn/Eddie
  Dim SubLevels(4,11)
  Dim Boost(4,11)
  Dim ModeTotal(4,11)
  Dim MadAreas(11)
  Dim ModesHeld(4,11)    ' retain lily hits for example  5 Awards + Marilyn + Eddie
  Dim ActiveJackpot(11)
  Dim lStates(4,150)    ' Light States
  Dim bBonusHeld
  Dim BallsRemaining(4)
  Dim ExtraBallsAwards(4)
  Dim Kitty(4)
  Dim Score(4)
  Dim HighScore(4)
  Dim LastScore(4)
  Dim HighScoreName(4)
  Dim Jackpots
  Dim Tilt
  Dim TiltSensitivity
  Dim Tilted
  Dim TotalGamesPlayed
  Dim mBalls2Eject
  Dim SkillshotValue(4)
  Dim bAutoPlunger
  Dim inhighscore
  Dim hurryvalue:hurryvalue=0
  Dim Shots(4), ZapShots(4)
  Dim bAttractMode
  Dim BallsOnPlayfield
  Dim BallsInHole
  Dim bFreePlay
  Dim bGameInPlay
  Dim bOnTheFirstBall
  Dim bBallInPlungerLane
  Dim bBallSaverActive
  Dim bBallSaverReady
  Dim plungerIM 'used mostly as an autofire plunger
  Dim bMultiBallMode
  Dim bSkillshotReady
  Dim bExtraBallWonThisBall, bAddABallAwarded, bAddTimeAwarded
  Dim bJustStarted
  Dim LastSwitchHit
  Dim hMag, lFlipperUp ' used for superskillshot
  Dim pfMultiplier
  Dim LilyMode, LilySwHits  ' 100 switches for SJP
  Dim EddieCnt
  Dim MMadnessMode
  Dim sPops
  Dim Captured, HermanJackpots, GrandpaJackpots, SpotJackpots, LilyJackpots, RavenJackpots, MarilynJackpots, EddieJackpots
  Dim ShowHurry ' Flag to display the countdown if set to True
  Dim fo(40), fn(40,80), fs(40,80), folder, maxsongs:maxsongs=0   ' folders, filenames and filesizes
  Dim Champion(11), ChampionScore(11)


  LoadCoreFiles
  Sub LoadCoreFiles
    On Error Resume Next
    ExecuteGlobal GetTextFile("core.vbs")
    If Err Then MsgBox "Can't open core.vbs"
    On Error Goto 0
    On Error Resume Next
  End Sub

  Dim objShell
  Dim objShell2, objFs
  set objShell2 = CreateObject("shell.application")
  set objFs = CreateObject("Scripting.Filesystemobject")

  Dim EnableBallControl
  EnableBallControl = false 'Change to true to enable manual ball control (or press C in-game) via the arrow keys and B (boost movement) keys


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Controller VBS stuff, but with b2s not started
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'***Controller.vbs version 1.2***'
'

Const directory = "HKEY_CURRENT_USER\SOFTWARE\Visual Pinball\Controller\"
Dim PopupMessage
Dim B2SController
Dim Controller
Const DOFContactors = 1
Const DOFKnocker = 2
Const DOFChimes = 3
Const DOFBell = 4
Const DOFGear = 5
Const DOFShaker = 6
Const DOFFlippers = 7
Const DOFTargets = 8
Const DOFDropTargets = 9
Const DOFOff = 0
Const DOFOn = 1
Const DOFPulse = 2

Dim DOFeffects(9)
Dim B2SOn
Dim B2SOnALT

Dim testx:testx=10

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   TABLE INITS & MATHS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  Dim mHMagnet
  Set mHMagnet = New cvpmMagnet : With mHMagnet
    .InitMagnet HMagnet, 200
    .GrabCenter = True
  End With

Sub Table1_Init()
  Dim i
  Randomize
  LoadEM
  Loadhs

  PuPInit

  DOF 140, DOFOn

  GetTimes(objFs.GetFolder(Folder))

  set objShell2 = Nothing
  set objFs = Nothing

  'Impulse Plunger as autoplunger
  Const IMPowerSetting = 50 ' Plunger Power
  Const IMTime = 1.1          ' Time in seconds for Full Plunge
  Set plungerIM = New cvpmImpulseP
    With plungerIM
        .InitImpulseP swplunger, IMPowerSetting, IMTime
        .Random 1.5
        .InitExitSnd SoundFX("fx_kicker", DOFContactors), SoundFX("fx_solenoid", DOFContactors)
        .CreateEvents "plungerIM"
    End With

  bAttractMode = False
  bOnTheFirstBall = False
  bBallInPlungerLane = False
  bBallSaverActive = False
  bBallSaverReady = False
  bMultiBallMode = False
  D "bGameInPlay = FALSE   (3)"
  bGameInPlay = False
  bAutoPlunger = False
  'bMusicOn = True
  BallsOnPlayfield = 0
  BallsInHole = 0
  lFlipperUp = False
  Tilt = 0
  TiltSensitivity = 6
  Tilted = False
  bBonusHeld = False
  bJustStarted = True

  GiOff
  PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 2, ""FN"":4, ""FS"":1 }"
  StartAttractMode
End Sub

'*****************************************************************************************************
' VR PLUNGER ANIMATION
'*****************************************************************************************************

Sub TimerPlunger_Timer
  If PinCab_Shooter.Y < -60 then
      PinCab_Shooter.Y = PinCab_Shooter.Y + 5
  End If
End Sub

Sub TimerPlunger2_Timer
 'debug.print plunger.position
  PinCab_Shooter.Y = -70 + (5* Plunger.Position) -20
End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   KEYS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X


Sub Table1_KeyDown(ByVal Keycode)
  If ballrolleron = 1 then
    if keycode = 46 then ' C Key
       If contball = 1 Then
          contball = 0
       Else
          contball = 1
       End If
    End If
  End If

  if keycode = 203 then bcleft = 1 ' Left Arrow
  if keycode = 200 then bcup = 1 ' Up Arrow
  if keycode = 208 then bcdown = 1 ' Down Arrow
  if keycode = 205 then bcright = 1 ' Right Arrow

  If keycode = leftmagnasave or keycode = rightmagnasave or keycode = LockBarKey  Then
    If ZapTimer.enabled Then
      ScoreZap
    Else
      PUP_audioevents "Sound-0x08DE - charge zap.mp3"
    End If
  End If

  If keycode = PlungerKey Then
    PlaySoundAt "fx_plungerpull", Plunger
    Plunger.Pullback
  End If

  If hsbModeActive = True Then
    EnterHighScoreKey(keycode)
  Elseif bGameInPlay then
    If Not inHighScore Then
      If keycode = LeftTiltKey Then Nudge 90, 6:PlaySound SoundFX("fx_nudge",0), 0, 1, -0.1, 0.25:CheckTilt
      If keycode = RightTiltKey Then Nudge 270, 6:PlaySound SoundFX("fx_nudge",0), 0, 1, 0.1, 0.25:CheckTilt
      If keycode = CenterTiltKey Then Nudge 0, 7:PlaySound SoundFX("fx_nudge",0), 0, 1, 1, 0.25:CheckTilt
    End If
    If NOT Tilted Then
      If keycode = LeftFlipperKey Then
        LF.Fire 'LeftFlipper.RotateToEnd
        PlaySound SoundFXDOF("fx_flipperup",101,DOFOn,DOFFlippers), 0, .67, AudioPan(LeftFlipper), 0.05,0,0,1,AudioFade(LeftFlipper)
        ldown = 1
        checkdown
        If bBallInPlungerLane Then ' ball in in plunger lane then save position of flipper for skillshot
          lFlipperUp = True 'for skillshot
          D "Shoot SuperSkillShot Light set"
          pStopBackLoop
          PUP_audioevents "Sound-0x07C6 - hold left button.mp3"
          DropStop.collidable=False:DropStop.isdropped=True
          pStartBackLoop "videoothers","177 - door lit up - super skillshot.mp4"
          PuPlayer.LabelSet pBackglass,"TLine0","Super\rSkill Shot",1,"{'mt':2,'color': 200, 'size': 6, 'xpos': 20, 'ypos': 30}"
          PuPlayer.LabelSet pBackglass,"TLine2","",1,"{'mt':2,'xpos': 20, 'ypos': 40}"
          PuPlayer.LabelSet pBackglass,"TLine3","Shoot Right Ramp",1, "{'mt':2,'xpos': 20, 'ypos': 50, 'size': 4, 'fname':" & jnumberfont & "}"
          L67.blinkinterval=250:SetLightColor L67,white,2
          L51.state = 0
        End If
        RotateLaneLightsLeft
      End If
      If keycode = RightFlipperKey Then
        RF.Fire 'RightFlipper.RotateToEnd
        PlaySound SoundFXDOF("fx_flipperup",102,DOFOn,DOFFlippers), 0, .67, AudioPan(RightFlipper), 0.05,0,0,1,AudioFade(RightFlipper)
        rdown = 1
        checkdown
        RotateLaneLightsRight
      End If
        If keycode = StartGameKey Then
        If((PlayersPlayingGame <MaxPlayers) AND(bOnTheFirstBall = True) ) Then
          PlayersPlayingGame = PlayersPlayingGame + 1
            If PlayersPlayingGame = 2 Then
            PuPlayer.LabelSet pBackglass,"Play2","PLAYER 2",1,"{'mt':2}"
            pUpdateScores
          End If
            If PlayersPlayingGame = 3 Then
            PuPlayer.LabelSet pBackglass,"Play3","PLAYER 3",1,"{'mt':2}"
            pUpdateScores
          End If
            If PlayersPlayingGame = 4 Then
            PuPlayer.LabelSet pBackglass,"Play4","PLAYER 4",1,"{'mt':2}"
            pUpdateScores
          End If
            TotalGamesPlayed = TotalGamesPlayed + 1
          savegp
        End If
      End If
    End If
  Else
    If NOT Tilted Then
      If keycode = LeftFlipperKey Then helptime.enabled = true:DMDintroloop:introtime = 0
      If keycode = RightFlipperKey Then helptime.enabled = true:DMDintroloop:introtime = 0
      If keycode = StartGameKey Then
          If(BallsOnPlayfield = 0) Then
            ResetForNewGame()
          End If
      End If
    End If
  End If
  '****************
  ' Testing Keys
  '****************
  if keycode = "3" and 1=2  then
    'FlashForMs B1L1, 1000, 50, 1:FlashForMs B1L2, 1000, 50, 1:FlashForMs F169, 1000, 50, 1
    'FlashForMs B2L1, 1000, 50, 1:FlashForMs B2L2, 1000, 50, 1:FlashForMs F168, 1000, 50, 1:FlashForMs F171, 100, 50, 0
    'FlashForMs B3L1, 1000, 50, 1:FlashForMs B3L2, 1000, 50, 1:FlashForMs F170, 1000, 50, 1
    'ShowJackpot zap, 100000, fWhite
        'vpmtimer.addtimer 100, "ShowJackpot Zap, " & Cstr(100000) & ", " & CStr(SubLevels(CurrentPlayer,Zap)) & " '"
hermanshake
  End If

  if keycode = "4" and 1=2 then
    TvText "","HERMAN TOTAL\r" & CenterText(18,FormatNumber(ModeTotal(CurrentPlayer,Herman),0)),"",""
  End If

  If keycode = "5" and 1=2 Then
    DropSpot
    FlashThem
    HermanShake
  End If
  If keycode = "6" and 1=2 Then
    RaiseSpot
  End If

End Sub

Sub RotateLaneLightsLeft
  Dim TempState
  TempState = L12.State
  L12.State = L13.State
  L13.State = L14.State
  L14.State = TempState
  lStates(CurrentPlayer,12)=L12.State
  lStates(CurrentPlayer,13)=L13.State
  lStates(CurrentPlayer,14)=L14.State
End Sub

Sub RotateLaneLightsRight
  Dim TempState
  TempState = L14.State
  L14.State = L13.State
  L13.State = L12.State
  L12.State = TempState
  lStates(CurrentPlayer,12)=L12.State
  lStates(CurrentPlayer,13)=L13.State
  lStates(CurrentPlayer,14)=L14.State
End Sub

Sub Table1_KeyUp(ByVal keycode)
    'Manual Ball Control

  if keycode = 203 then bcleft = 0 ' Left Arrow
  if keycode = 200 then bcup = 0 ' Up Arrow
  if keycode = 208 then bcdown = 0 ' Down Arrow
  if keycode = 205 then bcright = 0 ' Right Arrow

    If keycode = PlungerKey Then
      PlaySoundAt "fx_plunger", Plunger
      Plunger.Fire
    End If

    ' Table specific

    If bGameInPLay and hsbModeActive <> True Then

      If keycode = LeftFlipperKey Then
        If ldown = 1 and (SkillShotTime.Enabled = 1 or bBallInPlungerLane) Then
          D "Shoot SuperSkillShot Light unset"
          L51.blinkinterval=250:SetLightColor L51,white,2
          L67.state = 0
          pStopBackLoop
          DropStop.collidable=True:DropStop.isdropped=False
          pStartBackLoop "videoothers","6 - coffin open - shoot skill shot glow.png"
          PuPlayer.LabelSet pBackglass,"TLine0","Skill Shot",1, "{'mt':2,'color': 200, 'size': 6, 'xpos': 20, 'ypos': 30}"
          PuPlayer.LabelSet pBackglass,"TLine2","",1,"{'mt':2,'size': 6,'xpos': 20, 'ypos': 40}"
          PuPlayer.LabelSet pBackglass,"TLine3","Shoot Lit Top Lane\rOr Left Ramp",1,"{'mt':2, 'size': 4, 'xpos': 20, 'ypos': 40, 'fname':" & jnumberfont & "}"
          PuPlayer.LabelShowPage pBackglass,2,0,""
        End If
        ldown = 0
        lFlipperUp = False
        LeftFlipper.RotateToStart
        PlaySound SoundFXDOF("fx_flipperdown",101,DOFOff,DOFFlippers), 0, 1, AudioPan(LeftFlipper), 0.05,0,0,1,AudioFade(LeftFlipper)
      End If
      If keycode = RightFlipperKey Then
        rdown = 0
        RightFlipper.RotateToStart
        PlaySound SoundFXDOF("fx_flipperdown",102,DOFOff,DOFFlippers), 0, 1, AudioPan(RightFlipper), 0.05,0,0,1,AudioFade(RightFlipper)
      End If
    Else
      If keycode = LeftFlipperKey Then helptime.enabled = false
      If keycode = RightFlipperKey Then helptime.enabled = false
    End If

End Sub

Function LPad(StringToPad, Length, CharacterToPad)
  Dim x : x = 0
  If Length > Len(StringToPad) Then x = Length - len(StringToPad)
  LPad = String(x, CharacterToPad) & StringToPad
End Function
Function RPad(StringToPad, Length, CharacterToPad)
  Dim x : x = 0
  If Length > Len(StringToPad) Then x = Length - len(StringToPad)
  RPad = StringToPad & String(x, CharacterToPad)
End Function

Function CenterText(s,t)
  Dim a
  a = Int(Len(t)/2)
  If Len(t) >= s Then
    CenterText = t
  Else
    CenterText = Lpad(t,Int(s/2)+a," ")
  End If
End Function

Function RavenTime(seconds)
  dim h, s
  s=seconds
  if s > 24*60 Then s=24*60
  h = Int(s/60)
  RavenTime=LPad(h,2,"0") & ":" & LPad(s-(h*60),2,"0")
End Function



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   START GAME, END GANE
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'
  Sub ResetForNewGame()
    Dim i, j
    bGameInPlay = True
        D "ResetForNewGame"
    StopAttractMode
    ClearHSLabels
    ClearOSBLabels
    GiOn

    TotalGamesPlayed = TotalGamesPlayed + 1
    savegp
    CurrentPlayer = 1
    PlayersPlayingGame = 1
    bOnTheFirstBall = True
    For i = 1 To MaxPlayers
      For j = 1 To 11
        Modes(i,j) = 0
        ModeTotal(i,j)=0
        ModesHeld(i,j) = 0
        Boost(i,j) = 0
        SubLevels(i,j) = 0  'null, green, white, red, blue
      Next
      ModesHeld(i,Lily)=LilySwHitsNeeded
      ModesHeld(i,Raven)=60 ' 1 oclock
      InitLights(i)
      MadAreas(i)=0  ' areas you have completed in mmadness
      Score(i) = 0
      BonusPoints(i) = 0
      BonusMultiplier(i) = 1
      BallsRemaining(i) = 3
      ExtraBallsAwards(i) = 0
    Next
    Tilt = 0
    Game_Init()

    Scorbit.StartSession()

    vpmtimer.addtimer 1500, "FirstBall '"
  End Sub

  Sub InitLights(cp) ' Initial state for game start
    D "InitLights"
    Dim j
    For j = 1 to 150
      lStates(cp,j) = 0
      lStates(cp,j) = 0
      lStates(cp,j) = 0
      lStates(cp,j) = 0
    Next
    D "InitLights cp=" & CStr(cp)

    SetLightColor L18,green,0:L18.blinkInterval=sb
    SetLightColor L25,orange,0:L25.blinkInterval=sb
    SetLightColor L18,green,0:L18.blinkInterval=sb
    SetLightColor L58,green,0:L58.blinkInterval=sb
    SetLightColor L59,green,0:L59.blinkInterval=sb
    SetLightColor L60,green,0:L60.blinkInterval=sb


    lStates(cp,32) = 2      '(D)ragula
    lStates(cp,40) = 2      '(L)ily
    lStates(cp,12) = 2      'Eddie
    SetLightColor L12, red,2
    SetLightColor L40, orange,2
    SetLightColor L32, white,2
    lStates(cp,58) = 2:lStates(cp,59) = 2:lStates(cp,60) = 2 ' Herman Easy Play

    SetLightColor L47,white,-1 'Shots
    SetLightColor L51,white,-1 'Shots
    SetLightColor L67,white,-1 'Shots
    SetLightColor L73,white,-1 'Shots

    lStates(cp,51) = 2      'left ramp
    lStates(cp,87) = 2
    lStates(cp,78) = 2:lStates(cp,79) = 2  ' purple targets
    lStates(cp,81) = 2:lStates(cp,82) = 2  ' purple targets
    SetLightColor L32,white,-1  ' Dragula
    SetLightColor L33,white,-1
    SetLightColor L34,white,-1
    SetLightColor L35,white,-1
    SetLightColor L36,white,-1
    SetLightColor L37,white,-1
    SetLightColor L38,white,-1

    SetLightColor L98,red,-1
    SetLightColor L101,red,-1
    lStates(cp,98) = 2:lStates(cp,101) = 2  ' Spot Shot

    SetLightColor L103,orange,-1
    lStates(cp,103) = 2            ' Mystery
    lStates(cp,106) = 1:lStates(cp,107) = 1  ' Spot
    lStates(cp,108) = 1:lStates(cp,109) = 2  ' Spot
    lStates(cp,89) = 1:lStates(cp,90) = 1  ' Spot
    lStates(cp,91) = 1:lStates(cp,92) = 2  ' Spot
  End Sub

  Sub EndOfGame()
    D "EndOfGame"
    playclear pMusic
    ClearScreen()
    PuPlayer.playlistplayex pBackglass,"videoattract","185 - attract.mp4",100,1
    PuPlayer.LabelShowPage pBackglass,3,0,""
    introposition = 0
    D "bGameInPlay = FALSE   (1)"
    bGameInPlay = False
    bJustStarted = False
    'ClearPage3Timer.interval = 3000
    'ClearPage3Timer.Enabled = 1

    Scorbit.StopSession Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame

    PuPlayer.playlistplayex pAudio,"audiogameover","",80, 1
    PuPlayer.LabelSet pBackglass,"Fline0","GAME OVER",1,"{'mt':2,'color':200, 'size': 20, 'xpos': 50, 'xalign': 1, 'ypos': 36, 'yalign': 0}"
    vpmtimer.addtimer 1000, "EndOfGame2 '"
  End Sub

  Sub EndOfGame2()
    Dim i
    D "EndofGame2"
    For i = 1 To MaxPlayers
      LastScore(i) = Score(i)
    Next
    PuPlayer.LabelSet pBackglass,"Fline0","",1,""
    StartAttractMode
    GiOff
  End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   Pinup Active Backglass
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

'**************************
'   PinUp Player Config - PuPPlayer IS required
'**************************

    Dim pGameName       : pGameName="mmunsters"    'pupvideos foldername, probably set to cGameName in realworld

  Dim PuPlayer

  Const pTopper=0
  Const pDMD=2
  Const pBackglass=1
  Const pPlayfield=3
  Const pMusic=4
  Const pAudio=7
  Const pCallouts=8

  Dim fGreen:fGreen=RGB(41,217,17)
  Dim fRed:fRed=RGB(200,0,0)
  Dim fOrange:forange=RGB(255,128,0)
  Dim fBlue:fBlue=RGB(0,0,200)
  Dim fPurple:fPurple=RGB(135,0,200)
  Dim fWhite:fWhite=RGB(245,245,245)
  Dim fBlack:fBlack=RGB(0,0,0)
  Dim fYellow:fYellow=RGB(217,204,17)


  sub pupInit

  on error resume next
  Set PuPlayer = CreateObject("PinUpPlayer.PinDisplay")
  PuPlayer.B2SInit "", pGameName   'use new method to startup pup with dmd via puppack
  on error goto 0
  if not IsObject(PuPlayer) then msgbox "PuPPlayer IS required!":Exit Sub


    PupVideos=PuPlayer.getroot
    Folder=PupVideos & "\" &  cGameName & "\"

  PuPlayer.LabelInit pBackglass

  PupVideos=PuPlayer.getroot
  pSetBackFrame "ball0.png"

  PuPlayer.LabelInit pBackglass


  D "PUP AddLabels"
  PuPlayer.LabelNew pBackglass,"page0",zoomfont,  10,16777215  ,0,0,1,20,50,0,0
  PuPlayer.LabelNew pBackglass,"page1",zoomfont,  10,16777215  ,0,0,1,20,50,1,0
  PuPlayer.LabelNew pBackglass,"page2",zoomfont,  10,16777215  ,0,0,1,20,50,2,0
  PuPlayer.LabelNew pBackglass,"page3",zoomfont,  10,16777215  ,0,0,1,20,50,3,0

  'Page 1 (attractmode display)
  PuPlayer.LabelNew pBackglass,"Play1",typefont,      3,16777215  ,0,0,1,23,81,1,0
  PuPlayer.LabelNew pBackglass,"Play1score",numberfont, 3,16777215  ,0,0,1,31,81,1,0
  PuPlayer.LabelNew pBackglass,"Play2",typefont,      3,16777215  ,0,0,1,23,85,1,0
  PuPlayer.LabelNew pBackglass,"Play2score",numberfont, 3,16777215  ,0,0,1,31,85,1,0
  PuPlayer.LabelNew pBackglass,"Play3",typefont,      3,16777215  ,0,0,1,23,89,1,0
  PuPlayer.LabelNew pBackglass,"Play3score",numberfont, 3,16777215  ,0,0,1,31,89,1,0
  PuPlayer.LabelNew pBackglass,"Play4",typefont,      3,16777215  ,0,0,1,23,93,1,0
  PuPlayer.LabelNew pBackglass,"Play4score",numberfont, 3,16777215  ,0,0,1,31,93,1,0
  'PuPlayer.LabelNew pBackglass,"curscore",numberfont,    7,16777215  ,0,1,1,50,87,1,1
  PuPlayer.LabelNew pBackglass,"Ball",typefont,     2,16777215  ,0,1,1,50,81,1,1
  PuPlayer.LabelNew pBackglass,"curplayer",typefont,    3,0     ,0,1,1,50,93,1,1
  PuPlayer.LabelNew pBackglass,"hstitle",typefont,    3,444665  ,0,1,1,65,89,1,1
  PuPlayer.LabelNew pBackglass,"hs",numberfont,     3,16777215  ,0,1,1,65,93,1,1
  PuPlayer.LabelNew pBackglass,"gptitle",typefont,    3,8421504   ,0,1,1,77,89,1,1
  PuPlayer.LabelNew pBackglass,"gp",numberfont,     3,16777215  ,0,1,1,77,93,1,1
  PuPlayer.LabelNew pBackglass,"notetitle",numberfont,  3,16777215  ,0,1,1,50,12,1,1
  PuPlayer.LabelNew pBackglass,"notecopy",typefont,   2,16777215  ,0,1,1,50,15,1,1
  PuPlayer.LabelNew pBackglass,"titlebg",zoombgfont,    9,0     ,0,1,1,50,50,1,1
  PuPlayer.LabelNew pBackglass,"title",zoomfont,      9,16777215  ,0,1,1,75,50,1,1
  PuPlayer.LabelNew pBackglass,"titlebg2",zoombgfont,   6,0     ,0,1,1,50,50,1,1
  PuPlayer.LabelNew pBackglass,"title2",zoomfont,     6,16777215  ,0,1,1,50,50,1,1
  PuPlayer.LabelNew pBackglass,"lefttitle",numberfont,  3,0     ,0,1,1,11,82,1,1
  PuPlayer.LabelNew pBackglass,"lefttimer",numberfont,  8,16777215  ,0,1,1,11,87,1,1
  PuPlayer.LabelNew pBackglass,"leftdetail",typefont,   2,0       ,0,1,1,11,93,1,1
  PuPlayer.LabelNew pBackglass,"righttitle",numberfont, 3,0     ,0,1,1,89,82,1,1
  PuPlayer.LabelNew pBackglass,"righttimer",numberfont, 8,16777215  ,0,1,1,89,87,1,1
  PuPlayer.LabelNew pBackglass,"rightdetail",typefont,  2,0       ,0,1,1,89,93,1,1

  PuPlayer.LabelNew pBackglass,"high1name",munsterfont, 12,16777215  ,0,1,1,22,40,1,1
  PuPlayer.LabelNew pBackglass,"high1score",numberfont, 10,16777215  ,0,1,1,40,40,1,1
  PuPlayer.LabelNew pBackglass,"high2name",munsterfont, 12,16777215  ,0,1,1,52,50,1,1
  PuPlayer.LabelNew pBackglass,"high2score",numberfont, 10,16777215  ,0,1,1,66,50,1,1
  PuPlayer.LabelNew pBackglass,"high3name",munsterfont, 12,16777215  ,0,1,1,22,60,1,1
  PuPlayer.LabelNew pBackglass,"high3score",numberfont, 10,16777215  ,0,1,1,40,60,1,1
  PuPlayer.LabelNew pBackglass,"high4name",munsterfont, 12,16777215  ,0,1,1,52,70,1,1
  PuPlayer.LabelNew pBackglass,"high4score",numberfont, 10,16777215  ,0,1,1,66,70,1,1

  PuPlayer.LabelNew pBackglass,"HighScore",munsterfont, 18,fGreen ,0,0,1,30,20,1,1
  PuPlayer.LabelNew pBackglass,"HighScoreL1",numberfont,  8,16777215  ,0,0,1,20,40,1,1
  PuPlayer.LabelNew pBackglass,"HighScoreL2",numberfont,  8,16777215  ,0,0,1,24,40,1,1
  PuPlayer.LabelNew pBackglass,"HighScoreL3",numberfont,  8,16777215  ,0,0,1,28,40,1,1
  PuPlayer.LabelNew pBackglass,"HighScoreL4",numberfont,  6,16777215  ,0,0,1,20,60,1,1

  'Page 2 Main Score Screen +  TV Overlay                                 X  Y P

  PuPlayer.LabelNew pBackglass,"TLine0",munsterfont,  6,16777215  ,0,0,1,35,20,2,1
  PuPlayer.LabelNew pBackglass,"TLine1",jnumberfont,  10,16777215 ,0,0,1,35,30,2,1
  PuPlayer.LabelNew pBackglass,"TLine2",typefont,   6,16777215  ,0,0,1,35,50,2,1
  PuPlayer.LabelNew pBackglass,"TLine3",jnumberfont,  6,16777215  ,0,0,1,35,70,2,1
  PuPlayer.LabelNew pBackglass,"bLine",typefont,    4,16777215  ,0,0,1,30,75,2,1

  PuPlayer.LabelNew pBackglass,"HMode1",romanfont,    7,fgreen  ,0,0,1,13,10.6,2,1   ' The I, II for Herman, etc
  PuPlayer.LabelNew pBackglass,"HMode2",romanfont,    7,fgreen  ,0,0,1,17.47,9.48,2,1
  PuPlayer.LabelNew pBackglass,"GMode1",romanfont,    7,fgreen  ,0,0,1,60,10.7,2,1   ' 10.5
  PuPlayer.LabelNew pBackglass,"GMode2",romanfont,    7,fgreen  ,0,0,1,64.73,9.59,2,1
  PuPlayer.LabelNew pBackglass,"RMode1",romanfont,    7,fgreen  ,0,0,1,78,10.2,2,1
  PuPlayer.LabelNew pBackglass,"RMode2",romanfont,    7,fgreen  ,0,0,1,82.52,8.85,2,1
  PuPlayer.LabelNew pBackglass,"LMode1",romanfont,    7,fgreen  ,0,0,1,91.5,48.9,2,1
  PuPlayer.LabelNew pBackglass,"LMode2",romanfont,    7,fgreen  ,0,0,1,94.53,50.38,2,1
  PuPlayer.LabelNew pBackglass,"SMode1",romanfont,    7,fgreen  ,0,0,1,3,56,2,1
  PuPlayer.LabelNew pBackglass,"SMode2",romanfont,    7,fgreen  ,0,0,1,5.48,52.5,2,1

  PuPlayer.LabelNew pBackglass,"HBoost",jackpotfont,    5,fgreen  ,0,0,1,1.62,32.75,2,1    ' Indicate Boost Mode
  PuPlayer.LabelNew pBackglass,"GBoost",jackpotfont,    5,fpurple ,0,0,1,58.1,17.36,2,1
  PuPlayer.LabelNew pBackglass,"RBoost",jackpotfont,    5,fblue   ,0,0,1,79.51,24.31,2,1
  PuPlayer.LabelNew pBackglass,"LBoost",jackpotfont,    5,forange ,0,0,1,76,76.6,2,1
  PuPlayer.LabelNew pBackglass,"SBoost",jackpotfont,    5,fred    ,0,0,1,7.7,76.0,2,1

  PuPlayer.LabelNew pBackglass,"Ravens",numberfont,   6,fgreen  ,0,0,1,90.1,16.8,2,1
  PuPlayer.LabelNew pBackglass,"Jackpots",numberfont,   4,fgreen  ,0,0,1,28.65,93.5,2,1
  PuPlayer.LabelNew pBackglass,"Zaps",numberfont,     5,fblue   ,0,0,1,46.0,94.8,2,1
  PuPlayer.LabelNew pBackglass,"randomtxt",typefont,    14,16777215 ,0,0,1,50,50,2,1
  PuPlayer.LabelNew pBackglass,"randomtxt2",typefont,   14,16777215 ,0,0,1,50,50,2,1
  PuPlayer.LabelNew pBackglass,"rtimertxt",typefont,    6,16777215  ,0,0,1,74,55,2,1
  PuPlayer.LabelNew pBackglass,"rtimer",zoomfont,     12,fgreen ,0,0,1,76,64.5,2,1
  PuPlayer.LabelNew pBackglass,"ltimertxt",typefont,    6,16777215  ,0,0,1,72,55,2,1
  PuPlayer.LabelNew pBackglass,"ltimer",jackpotfont,    12,fgreen ,0,0,1,78,64.5,2,1
  'PuPlayer.LabelNew pBackglass,"jgauge",jackpotfont,   12,fgreen ,0,0,1,76,64.5,2,1  JackpotValue Gauge  TODO

  PuPlayer.LabelNew pBackglass,"BottomBox1",numberfont, 4,16777215  ,0,0,1,4.5,87,2,1
  PuPlayer.LabelNew pBackglass,"BottomBox1b",numberfont,  4,16777215  ,0,0,1,4.5,93,2,1
  PuPlayer.LabelNew pBackglass,"BottomBox2",numberfont, 4,16777215  ,0,0,1,64.5,87,2,1
  PuPlayer.LabelNew pBackglass,"BottomBox2b",numberfont,  4,16777215  ,0,0,1,64.5,93,2,1
  PuPlayer.LabelNew pBackglass,"BottomBox3",numberfont, 6,16777215  ,0,0,1,83,90,2,1
  PuPlayer.LabelNew pBackglass,"NewScore",scorefont,    10,255    ,0,2,1,57.6,85.1,2,1

  PuPlayer.LabelNew pBackglass,"tvline1",numberfont,  6,16752896  ,0,0,1,55,34,2,1
  PuPlayer.LabelNew pBackglass,"tvline2",numberfont,  6,255   ,0,0,1,55,46,2,1
  PuPlayer.LabelNew pBackglass,"tvline3",numberfont,  6,65280   ,0,0,1,55,58,2,1
  PuPlayer.LabelNew pBackglass,"tvline4",numberfont,  6,16777215  ,0,0,1,55,70,2,1

  'Page 3 Full Screen                                                   X  Y P
  PuPlayer.LabelNew pBackglass,"FLine1",jackpotfont,  12,16777215   ,0,0,1,35,30,3,1
  PuPlayer.LabelNew pBackglass,"FLine2",zoomfont,   8,16777215    ,0,0,1,35,50,3,1
  PuPlayer.LabelNew pBackglass,"FLine3",jackpotfont,  6,16777215    ,0,0,1,35,70,3,1
  PuPlayer.LabelNew pBackglass,"FLine0",munsterfont,  10,16777215   ,0,0,1, 5,50,3,1  'munster
  PuPlayer.LabelNew pBackglass,"movietitle",zoomfont,   9,16777215  ,0,1,1,75,50,3,1

  'Page 4 Full Screen  JACKPOT Scored Fonts                               X  Y P
  PuPlayer.LabelNew pBackglass,"jLine0",jackpotfont,  16,16777215   ,0,0,1, 5,65,4,1
  PuPlayer.LabelNew pBackglass,"jLine1",stencilfont,  12,16777215   ,0,0,1, 5.5,76.9,4,1
  PuPlayer.LabelNew pBackglass,"jLine2",jnumberfont,  18,16777215   ,0,0,1, 5,87,4,1

  'Page 5 Full Screen  Kitty Screen                                  X  Y P
  PuPlayer.LabelNew pBackglass,"kLine0",stencilfont,  5,16777215    ,0,0,1, 35,40,5,1
  PuPlayer.LabelNew pBackglass,"kLine1",stencilfont,  5,16777215    ,0,0,1, 35,50,5,1
  PuPlayer.LabelNew pBackglass,"kLine2",stencilfont,  5,16777215    ,0,0,1, 35,60,5,1

'obslabels
  'day
  PuPlayer.LabelNew pBackglass,"dh1n",numberfont,         5,fyellow  ,0,0,1,35,30,1,1
  PuPlayer.LabelNew pBackglass,"dh1s",numberfont,         5,fyellow  ,0,0,1,55,30,1,1
  PuPlayer.LabelNew pBackglass,"dh2n",numberfont,         5,fyellow  ,0,0,1,35,35,1,1
  PuPlayer.LabelNew pBackglass,"dh2s",numberfont,         5,fyellow  ,0,0,1,55,35,1,1
  PuPlayer.LabelNew pBackglass,"dh3n",numberfont,         5,fyellow  ,0,0,1,35,40,1,1
  PuPlayer.LabelNew pBackglass,"dh3s",numberfont,         5,fyellow  ,0,0,1,55,40,1,1
  PuPlayer.LabelNew pBackglass,"dh4n",numberfont,         5,fyellow  ,0,0,1,35,45,1,1
  PuPlayer.LabelNew pBackglass,"dh4s",numberfont,         5,fyellow  ,0,0,1,55,45,1,1
  PuPlayer.LabelNew pBackglass,"dh5n",numberfont,         5,fyellow  ,0,0,1,35,50,1,1
  PuPlayer.LabelNew pBackglass,"dh5s",numberfont,         5,fyellow  ,0,0,1,55,50,1,1
  PuPlayer.LabelNew pBackglass,"dh6n",numberfont,         5,fyellow  ,0,0,1,35,55,1,1
  PuPlayer.LabelNew pBackglass,"dh6s",numberfont,         5,fyellow  ,0,0,1,55,55,1,1
  PuPlayer.LabelNew pBackglass,"dh7n",numberfont,         5,fyellow  ,0,0,1,35,60,1,1
  PuPlayer.LabelNew pBackglass,"dh7s",numberfont,         5,fyellow  ,0,0,1,55,60,1,1
  PuPlayer.LabelNew pBackglass,"dh8n",numberfont,         5,fyellow  ,0,0,1,35,65,1,1
  PuPlayer.LabelNew pBackglass,"dh8s",numberfont,         5,fyellow  ,0,0,1,55,65,1,1
  PuPlayer.LabelNew pBackglass,"dh9n",numberfont,         5,fyellow  ,0,0,1,35,70,1,1
  PuPlayer.LabelNew pBackglass,"dh9s",numberfont,         5,fyellow  ,0,0,1,55,70,1,1
  PuPlayer.LabelNew pBackglass,"dh10n",numberfont,        5,fyellow  ,0,0,1,35,75,1,1
  PuPlayer.LabelNew pBackglass,"dh10s",numberfont,        5,fyellow  ,0,0,1,55,75,1,1

  puPlayer.LabelNew pBackglass,"ScorbitQR", romanfont,       1,RGB(247, 170, 51)    ,0,2,0 ,0,0    ,1,1
  puPlayer.LabelNew pBackglass,"ScorbitQRicon", romanfont,    1,RGB(247, 170, 51)     ,0,2,0 ,0,0    ,1,1

  if Scorbitactive then
    if Scorbit.DoInit(3862, "PupOverlays", myVersion, "GbPde-M5Rkv-VPIN") then  ' Munsters Pro
      tmrScorbit.Interval=2000
      tmrScorbit.UserValue = 0
      tmrScorbit.Enabled=True
      Scorbit.UploadLog = ScorbitUploadLog
    End if
  End if
  End Sub

  Sub chilloutthemusic
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 2, ""FN"":11, ""VL"":40 }"
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 4, ""FN"":11, ""VL"":40 }"
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 7, ""FN"":11, ""VL"":40 }"
    vpmtimer.addtimer 2200, "turnitbackup'"
  End Sub

  Sub turnitbackup
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 2, ""FN"":11, ""VL"":80 }"
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 4, ""FN"":11, ""VL"":80 }"
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 7, ""FN"":11, ""VL"":80 }"
  End Sub

' Screen 1 ball page
' Screen 2 attractmode
' Screen 3 EndofBall

  Sub resetbackglass
    D "resetbackglass"
    pStartBackLoop "videobackground",""
    PuPlayer.LabelShowPage pBackglass,2,0,""   'show page 2 for ever
    PuPlayer.LabelSet pBackglass,"Ball","",2,""
    PuPlayer.LabelSet pBackglass,"lefttitle","",2,""
    PuPlayer.LabelSet pBackglass,"lefttimer","",2,""
    PuPlayer.LabelSet pBackglass,"leftdetail","",2,""
    PuPlayer.LabelSet pBackglass,"righttitle","",2,""
    PuPlayer.LabelSet pBackglass,"righttimer","",2,""
    PuPlayer.LabelSet pBackglass,"rightdetail","",2,""
  End Sub

  Sub currentplayerbackglass
  End Sub

Sub VideoClip (t, line0, line1, line2, line3) 'abab
  D "VideoClip + ClearPage3 Timer"
    ClearScreen
    Dim vid, vc, a
    curPage=3
    PuPlayer.LabelShowPage pBackglass,3,0,""
    vc=fn(GetFolder("videofiller"),RndNum(1,fn(GetFolder("videofiller"),0)))
    a=GetTime("videofiller",vc)
    If a<1000 then a=t
    ClearPage3Timer.interval=a-100
    ClearPage3Timer.Enabled = 1
    vpmtimer.addtimer a, "RestoreScreen '"
    PuPlayer.playlistplayex pBackglass,"videofiller",vc,100,1
    PuPlayer.LabelSet pBackglass,"fLine0",line0,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':12, 'fname':" & munsterfont & " }"
    PuPlayer.LabelSet pBackglass,"fLine1",line1,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':12, 'fname':" & jackpotfont & " }"
    PuPlayer.LabelSet pBackglass,"fLine2",line2,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':6 , 'fname':" & zoomfont & " }"
    PuPlayer.LabelSet pBackglass,"fLine3",line3,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':6 , 'fname':" & jackpotfont & " }"
End Sub

Sub SpecialVideoClip (t, line0, line1, line2, line3, folder, fname)
    D "SpecialVideoclip + ClearPage3 Timer (" & CStr(t) & ") " & folder & "-" & fname
    Dim a, vc
    ClearScreen
    CurPage=3
    PuPlayer.LabelShowPage pBackglass,3,0,""
    If len(fname) > 0 Then
      a=GetTime(folder,fname)
      vc=fname
    Else
      vc=fn(GetFolder(folder),RndNum(1,fn(GetFolder(folder),0)))
      a=GetTime(folder,vc)
    End If
    If a<1000 then a=t
    ClearPage3Timer.interval=a-100
    ClearPage3Timer.Enabled = 1
    vpmtimer.addtimer a, "RestoreScreen '"
    PuPlayer.playlistplayex pBackglass,folder,vc,100,1
    PuPlayer.LabelSet pBackglass,"Fline0",line0,1,"{'mt':2,'fname':" & munsterfont & ", 'size': 12 }"
    PuPlayer.LabelSet pBackglass,"Fline1",line1,1,"{'mt':2,'fname':" & jackpotfont & ", 'size': 12 }"
    PuPlayer.LabelSet pBackglass,"Fline2",line2,1,"{'mt':2,'fname':" & zoomfont    & ", 'size': 8 }"
    PuPlayer.LabelSet pBackglass,"Fline3",line3,1,"{'mt':2,'fname':" & jackpotfont & ", 'size': 6 }"
End Sub

Sub Page5VideoClip (t, line0, line1, line2, folder, fname)
    D "Page5Videoclip" & folder
    Dim a
    ClearScreen
    CurPage=5
    PuPlayer.LabelShowPage pBackglass,5,0,""
    If len(fname) > 0 Then
      a=GetTime(folder,fname)
    Else
      a=t
    End If
    If a<1000 then a=t
    ClearPage5Timer.interval=a-100
    ClearPage5Timer.Enabled = 1
    vpmtimer.addtimer a, "RestoreScreen '"
    PuPlayer.playlistplayex pBackglass,folder,fname,100,1
    PuPlayer.LabelSet pBackglass,"kline0",line0,1,"{'mt':2,'fname':" & stencilfont & ", 'size': 5 }"
    PuPlayer.LabelSet pBackglass,"kline1",line1,1,"{'mt':2,'fname':" & stencilfont & ", 'size': 5 }"
    PuPlayer.LabelSet pBackglass,"kline2",line2,1,"{'mt':2,'fname':" & stencilfont & ", 'size': 5 }"
End Sub

Sub JackpotVideoClip (t, line0, line1, line2, line3, folder, fname, ccode)  'todo not clearing text??
    D "JackpotVideoclip " & folder & " " & CStr(t) & "-" & CStr(ccode)
    Dim a,vc
    ClearScreen  ' remove the dmd screen
    CurPage=4
    PuPlayer.LabelShowPage pBackglass,4,0,""
    If len(fname) > 0 Then
      a=GetTime(folder,fname)
    Else
      vc=fn(GetFolder(folder),RndNum(1,fn(GetFolder(folder),0)))
      a=GetTime(folder,vc)
    End If
    If a<1000 then a=t
    ClearPage4Timer.interval = a-100
    ClearPage4Timer.Enabled = 1
    vpmtimer.addtimer a, "RestoreScreen '"
    PuPlayer.playlistplayex pBackglass,folder,fname,100,1
    PuPlayer.LabelSet pBackglass,"jLine0",line0,1,"{'mt':2,'color': " & CStr(ccode) & ", 'fname':" & jackpotfont & ", 'size': 10 }"
    PuPlayer.LabelSet pBackglass,"jLine1",line1,1,"{'mt':2,'color': " & CStr(ccode) & ", 'fname':" & stencilfont & ", 'size': 8  }"
    PuPlayer.LabelSet pBackglass,"jLine2",line2,1,"{'mt':2,'color': " & CStr(ccode) & ", 'fname':" & jnumberfont & ", 'size': 10 }"
End Sub

Sub RestoreScreen
  D "RestoreScreen"
  If MMadnessMode Then
    pStartBackLoop "videoothers","mmadness.png"
  Else
    pStartBackLoop "videobackground",""
  End If
  pSetBackFrame "ball" & CSTR(Balls) & ".png"   'show the dmd frame first
  CurPage=2
  PuPlayer.LabelShowPage pBackglass,2,0,""
End Sub

Sub ClearScreen
  D "ClearScreen"
  CurPage=0
  PuPlayer.LabelShowPage pBackglass,0,0,""
  pSetBackFrame "clear.png"
End Sub

Sub ClearPage2Timer_Timer
  D "ClearPage2Timer Fired"
  ClearPage2Timer.Enabled = 0
  PuPlayer.LabelSet pBackglass,"tvline1","",1,"{'mt':2,'fname':" & numberfont & ",  'size': 6 }"  ' Done
  PuPlayer.LabelSet pBackglass,"tvline2","",1,"{'mt':2,'fname':" & numberfont & ",  'size': 6 }"
  PuPlayer.LabelSet pBackglass,"tvline3","",1,"{'mt':2,'fname':" & numberfont & ",  'size': 6 }"
  PuPlayer.LabelSet pBackglass,"tvline4","",1,"{'mt':2,'fname':" & numberfont & ",  'size': 6 }"
End Sub

Sub ClearPage3Timer_Timer
  D "ClearPage3Timer Fired"
  ClearPage3Timer.Enabled = 0
  PuPlayer.LabelSet pBackglass,"fLine1","",1,"{'mt':2,'fname':" & jackpotfont & ", 'size': 12 }"  ' Done
  PuPlayer.LabelSet pBackglass,"fLine2","",1,"{'mt':2,'fname':" & zoomfont & ", 'size': 8  }"
  PuPlayer.LabelSet pBackglass,"fLine3","",1,"{'mt':2,'fname':" & jackpotfont & ", 'size': 6  }"
  PuPlayer.LabelSet pBackglass,"fLine0","",1,"{'mt':2,'fname':" & munsterfont & ", 'size': 10 }"
  PuPlayer.LabelSet pBackglass,"movietitle","",1,"{'mt':2,'fname':" & zoomfont & ", 'size': 9 }"
End Sub

Sub ClearPage4Timer_Timer
  D "ClearPage4Timer Fired"
  ClearPage4Timer.Enabled = 0
  PuPlayer.LabelSet pBackglass,"jLine0","",1,"{'mt':2,'fname':" & jackpotfont & ", 'size': 10 }"
  PuPlayer.LabelSet pBackglass,"jLine1","",1,"{'mt':2,'fname':" & stencilfont & ", 'size': 8 }"
  PuPlayer.LabelSet pBackglass,"jLine2","",1,"{'mt':2,'fname':" & jnumberfont & ", 'size': 10 }"
  ShowHurry=True
End Sub

Sub ClearPage5Timer_Timer
  D "ClearPage5Timer Fired"
  ClearPage5Timer.Enabled = 0
  PuPlayer.LabelSet pBackglass,"kLine0","",1,"{'mt':2,'fname':" & stencilfont & ", 'size': 5 }"  ' Done
  PuPlayer.LabelSet pBackglass,"kLine1","",1,"{'mt':2,'fname':" & stencilfont & ", 'size': 5 }"
  PuPlayer.LabelSet pBackglass,"kLine2","",1,"{'mt':2,'fname':" & stencilfont & ", 'size': 5 }"
End Sub

Sub TimedText(i, line1, line2, line3, c)    ' on page 2
  TimedTextTimer.interval = i
  PuPlayer.LabelSet pBackglass,"TLine0","",1,   ""
  PuPlayer.LabelSet pBackglass,"TLine1",line1,1,"{'mt':2, 'color': " & CStr(c) & " }"
  PuPlayer.LabelSet pBackglass,"TLine2",line2,1,"{'mt':2, 'color': " & CStr(c) & " }"
  PuPlayer.LabelSet pBackglass,"TLine3",line3,1,"{'mt':2, 'color': " & CStr(c) & " }"
  PuPlayer.LabelSet pBackglass,"page2","",1,    ""
  TimedTextTimer.Enabled = 1
End Sub

Sub TimedTextTimer_Timer
  TimedTextTimer.Enabled = 0
  D "TimedTextTimer Fired"
  PuPlayer.LabelSet pBackglass,"TLine0","",1,"{'mt':2, 'color': " & CStr(fWhite) & ",'fname':" & munsterfont & ", 'size':  6 }"
  PuPlayer.LabelSet pBackglass,"TLine1","",1,"{'mt':2, 'color': " & CStr(fWhite) & ",'fname':" & jnumberfont & ", 'size': 12 }"
  PuPlayer.LabelSet pBackglass,"TLine2","",1,"{'mt':2, 'color': " & CStr(fWhite) & ",'fname':" &    typefont & ", 'size':  6 }"
  PuPlayer.LabelSet pBackglass,"TLine3","",1,"{'mt':2, 'color': " & CStr(fWhite) & ",'fname':" & jnumberfont & ", 'size':  6 }"
  PuPlayer.LabelSet pBackglass,"bLine" ,"",1,"{'mt':2, 'color': " & CStr(fWhite) & ",'fname':" &    typefont & ", 'size':  5 }"
End Sub

  Sub BigTimedText(i, line1, line2, line3)
    ClearPage3Timer.interval = i
    ClearPage3Timer.Enabled = 1
    PuPlayer.LabelSet pBackglass,"fLine1",line1,1,"{'mt':2,'size':12, 'fname':" & zoomfont   & "}"
    PuPlayer.LabelSet pBackglass,"fLine2",line2,1,"{'mt':2,'size':12, 'fname':" & numberfont & "}"
    PuPlayer.LabelSet pBackglass,"fLine3",line3,1,"{'mt':2,'size':12, 'fname':" & numberfont & "}"
  End Sub

  Sub pUpdateScores
    Dim Namestr(4), a

    for a = 1 to PlayersPlayingGame
      if ScorbitActive then
        NameStr(a)=Scorbit.GetName(a)
debug.print "Name:" & NameStr(a) & " " & a
        if NameStr(a)="" then
          NameStr(a)="Player " & a
        End if
      Else
        NameStr(a)="Player " & a
      End if
    Next

    PuPlayer.LabelSet pBackglass,"NewScore",LPAD(FormatNumber(Score(CurrentPlayer),0),12," "),1,""
        PuPlayer.LabelSet pBackglass,"curplayer",NameStr(CurrentPlayer),1,""

  ' D "pUpdateScores"
    If CurrentPlayer = 1 Then
      PuPlayer.LabelSet pBackglass,"bottombox1b","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
      PuPlayer.LabelSet pBackglass,"bottombox1",NameStr(1),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
      'make other scores red (inactive)
      If PlayersPlayingGame = 2 Then
        PuPlayer.LabelSet pBackglass,"bottombox2b","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox2",NameStr(2),1,"{'mt':2,'color':8421504, 'size': 3.4 }"
      End If
      If PlayersPlayingGame = 3 Then
        PuPlayer.LabelSet pBackglass,"bottombox2" ,"P2: " & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox2b","P3: " & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
      End If
      If PlayersPlayingGame = 4 Then
        PuPlayer.LabelSet pBackglass,"bottombox1" ,"P1: " & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox1b","P2: " & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox2" ,"P3: " & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox2b","P4: " & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
      End If
    End If
    If CurrentPlayer = 2 Then
      'make other scores red (inactive)
      If PlayersPlayingGame = 2 Then
        PuPlayer.LabelSet pBackglass,"bottombox1",NameStr(1),1,"{'mt':2,'color':8421504, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox1b","" & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox2",NameStr(2),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox2b","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
      End If
      If PlayersPlayingGame = 3 Then
        PuPlayer.LabelSet pBackglass,"bottombox1",NameStr(1),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox1b","" & FormatNumber(Score(2),0),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox2" ,"P1: " & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox2b","P3: " & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
      End If
      If PlayersPlayingGame = 4 Then
        PuPlayer.LabelSet pBackglass,"bottombox1", "P1: " & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox1b","P2: " & FormatNumber(Score(2),0),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox2" ,"P3: " & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox2b","P4: " & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
      End If
    End If
    If CurrentPlayer = 3 Then
      'make other scores red (inactive)
      If PlayersPlayingGame = 3 Then
        PuPlayer.LabelSet pBackglass,"bottombox1" ,"P1: " & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox1b","P2: " & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox2",NameStr(3),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox2b","" & FormatNumber(Score(CurrentPlayer),0),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
      End If
      If PlayersPlayingGame = 4 Then
        PuPlayer.LabelSet pBackglass,"bottombox1" ,"P1: " & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox1b","P2: " & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
        PuPlayer.LabelSet pBackglass,"bottombox2" ,"P3: " & FormatNumber(Score(3),0),1,"{'mt':2,'color':16777215,'size': 3.4 }"
        PuPlayer.LabelSet pBackglass,"bottombox2b","P4: " & FormatNumber(Score(4),0),1,"{'mt':2,'color':8421504, 'size': 3.0 }"
      End If
    End If
    If CurrentPlayer = 4 Then
      PuPlayer.LabelSet pBackglass,"bottombox1" ,"P1: " & FormatNumber(Score(1),0),1,"{'mt':2,'color':8421504,  'size': 3.0 }"
      PuPlayer.LabelSet pBackglass,"bottombox1b","P2: " & FormatNumber(Score(2),0),1,"{'mt':2,'color':8421504,  'size': 3.0 }"
      PuPlayer.LabelSet pBackglass,"bottombox2" ,"P3: " & FormatNumber(Score(3),0),1,"{'mt':2,'color':8421504,  'size': 3.0 }"
      PuPlayer.LabelSet pBackglass,"bottombox2b","P4: " & FormatNumber(Score(4),0),1,"{'mt':2,'color':16777215, 'size': 3.4 }"
    End If
  end Sub



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   BALL FUNCTIONS & DRAINS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  Function Balls
    Dim tmp

    tmp = bpgcurrent - BallsRemaining(CurrentPlayer) + 1
    If tmp> bpgcurrent Then
      Balls = bpgcurrent
    Else
      Balls = tmp
    End If
  End Function

  Sub FirstBall
    ResetForNewPlayerBall()
    CreateNewBall()
  End Sub


  Sub ResetForNewPlayerBall()
    D "ResetForNewPlayerBall BALL " & Balls
    PuPlayer.playresume 4
    mHMagnet.MagnetOn = 0
    MagnetFlag=False
    DropSpot()
    DropStop.collidable=True
    DropStop.isdropped=False

    PlaySound "flute"
    DragCnt=DragTime
    AddScore 0
    BonusPoints(CurrentPlayer) = 0
    bExtraBallWonThisBall = False:bAddABallAwarded=False:bAddTimeAwarded=False
    ResetNewBallLights()
    ResetNewBallVariables
    pSetBackFrame "ball" & CSTR(Balls) & ".png"
    PaintModesClear()
    PaintModes()

    ScorbitBuildGameModes()
  End Sub

  Sub CreateNewBall()
    D "CreateNewBall()"
    BallRelease.CreateSizedball BallSize / 2
    BallsOnPlayfield = BallsOnPlayfield + 1
    PlaySoundAt SoundFXDOF("fx_Ballrel", 114, DOFPulse, DOFContactors), BallRelease
    BallRelease.Kick 90, 4
    If BallsOnPlayfield > 1 Then
      bMultiBallMode = True
        DOF 127, DOFOn    'Beacon ON
      bAutoPlunger = True
    End If
  End Sub

  Sub AddMultiball(nballs)
    mBalls2Eject = mBalls2Eject + nballs
    CreateMultiballTimer.Enabled = True
  End Sub

  Sub CreateMultiballTimer_Timer()
    If bBallInPlungerLane Then
      Exit Sub
    Else
      If BallsOnPlayfield <MaxMultiballs Then
        CreateNewBall()
        mBalls2Eject = mBalls2Eject -1
        If mBalls2Eject = 0 Then
          Me.Enabled = False
        End If
      Else
        mBalls2Eject = 0
        Me.Enabled = False
      End If
    End If
  End Sub

  Sub EndOfBall()
    D "EndofBall"
    playclear pAudio
    bMultiBallMode = False
    bOnTheFirstBall = False
    vpmtimer.addtimer 500, "EndOfBall2 '"
  End Sub


  Sub EndOfBall2()
    D "EndOfBall2"
    Tilted = False
    Tilt = 0
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 7, ""FN"":11, ""VL"":50 }"
    DisableTable False
    tilttableclear.enabled = False
    tilttime = 0
    If(ExtraBallsAwards(CurrentPlayer) <> 0) Then
      ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer) - 1
      If(ExtraBallsAwards(CurrentPlayer) = 0) Then
        L25.State = 0:lStates(CurrentPlayer,25)=0
      End If
      LightSeqFlasher.UpdateInterval = 150
      LightSeqFlasher.Play SeqRandom, 10, , 2000
      CreateNewBall()
      ResetForNewPlayerBall
      PuPlayer.playlistplayex pBackglass,"videospecials","Video-0x002E - extra ball.mp4",100,2
    Else
      BallsRemaining(CurrentPlayer) = BallsRemaining(CurrentPlayer) - 1
      If(BallsRemaining(CurrentPlayer) <= 0) Then
        If osbkey="" Then
        Else
          vpmtimer.addtimer 100, "SubmitScore '"
        End If
        CheckHighscore()
      Else
        EndOfBallComplete()
      End If
    End If
    D "EndOfBall2 - Done"
  End Sub

  Sub SubmitScore
    D "SubmitScore"
    osbtemp = osbdefinit
    osbtempscore=Score(CurrentPlayer)
    SubmitOSBScore
  End Sub

  Sub EndOfBallComplete()
    D "EndOfBallComplete"
    ResetNewBallVariables
    Dim NextPlayer
    If(PlayersPlayingGame> 1) Then
      NextPlayer = CurrentPlayer + 1
      If(NextPlayer> PlayersPlayingGame) Then
        NextPlayer = 1
      End If
    Else
      NextPlayer = CurrentPlayer
    End If
    If((BallsRemaining(CurrentPlayer) <= 0) AND(BallsRemaining(NextPlayer) <= 0) ) Then
      EndOfGame()
    Else
      CurrentPlayer = NextPlayer
      AddScore 0
      ResetForNewPlayerBall()
      ScorbitBuildGameModes()
      CreateNewBall()
    End If
    D "EndOfBallComplete - Done"
  End Sub

  Sub Balldrained
    D "Balldrained"
    DOF 312, DOFPulse
    playclear pMusic
    pSetBackFrame "clear.png"
    PuP_audiodrain()
    StopEndOfBallMode
    If Not Tilted Then
      EndOfBallBonus()
    Else
      vpmtimer.addtimer 500, "EndOfBall '"
    End If
  End Sub

  Sub CancelSkillShot   ' reset skillshot
    SkillShotTime.Enabled = 0
    If bSkillshotReady then
      bSkillShotReady = False
      l87.State = 0:L51.State = 0:L67.State = 0
      PuPlayer.LabelSet pBackglass,"TLine0","",1,""
      PuPlayer.LabelSet pBackglass,"TLine1","",1,""
      PuPlayer.LabelSet pBackglass,"TLine2","",1,""
      PuPlayer.LabelSet pBackglass,"TLine3","",1,""
      PuPlayer.LabelSet pBackglass,"bLine","",1,""
      PuPlayer.LabelSet pBackglass,"rtimertxt","",1,""
      PuPlayer.LabelSet pBackglass,"rtimer","",1,""
    End If
  End Sub

  Sub Drain_Hit()
    D "Drain_Hit()"
    Drain.DestroyBall
    BallsOnPlayfield = BallsOnPlayfield - 1
    CancelSkillShot()
    PlaySoundAt "fx_drain", Drain
    DOF 118, DOFPulse
    If Tilted Then
      StopEndOfBallMode
    End If
    If(bGameInPlay = True) AND (Tilted = False) Then
      D "bGameInPlay = TRUE   (2)"
      If(bBallSaverActive = True) Then
        AddMultiball 1
        bAutoPlunger = True
        If bMultiBallMode = False Then   'ballsaved
          ClearScreen
          PuPlayer.LabelShowPage pBackglass,0,0,""
          PuPlayer.playlistplayex pBackglass,"videospecials","Video-0x0062 - ball saved.mp4",100,1
          vpmtimer.addtimer 3000, "RestoreScreen '"
          vpmtimer.addtimer 3000, "resetbackglass '"
        End If
      Else
        If(BallsOnPlayfield = 1) Then
          If(bMultiBallMode = True) then
            bMultiBallMode = False
            DOF 127, DOFOff   'DOF - Beacon - OFF
            If HermanMode Then ' lost ball with one on the magnet
              If L18.state<>0 Then
                If Modes(CurrentPlayer,Herman)< 4 Then Modes(CurrentPlayer,Herman)=Modes(CurrentPlayer,Herman)+1
                cAwardExtraBallLight()
                AwardKitty()
                PaintModes()
              End If
              StopHermanMode()
            End If
            MagnetStop
            If RavenMode Then
              StopRavenMode
              If NOT DidGetRavenJackpot Then
                StartRavenRestartMode
                Exit Sub
              End If
            End If
            If MMadnessMode Then
              StopMMadnessMode
            End If
          End If
          bMultiBallMode = False
          ChangeGi white
        End If
        If(BallsOnPlayfield = 0) Then
          D "Drain_Hit() 0 balls"
          bMultiBallMode = False
          ChangeGi white
          ClearVideo()

          vpmtimer.addtimer 1000, "Balldrained '"
        End If
      End If
    End If
    D "End of Drain_Hit()"
  End Sub

Sub StopHermanMode
  D "StopHermanMode Total=" & CStr(ModeTotal(CurrentPlayer,Herman))
  If lStates(CurrentPlayer,56)<>0 Then
    D "Turnoff Herman Lights"
    lStates(CurrentPlayer,56)=0:SetLightColor L56,white,0  ' Debug
    lStates(CurrentPlayer,58)=2:L58.state=2  ' 3 spots in front
    lStates(CurrentPlayer,59)=0:L59.state=0
    lStates(CurrentPlayer,60)=0:L60.state=0
  End If
  HermanMode=False:MagnetFlag=False
  lStates(CurrentPlayer,28)=0:SetLightColor L28,orange, 0  ' add a ball
  StartGrandpaL:StartRavenL:StartSpotL
  L18.state=1:lStates(CurrentPlayer,18)=1  'DWE
  lStates(CurrentPlayer,47)=0:SetLightColor L47,white,0 'shots
  lStates(CurrentPlayer,51)=0:SetLightColor L51,white,0
  lStates(CurrentPlayer,67)=0:SetLightColor L67,white,0
  lStates(CurrentPlayer,73)=0:SetLightColor L73,white,0
  ShowZapShots()
  PuPlayer.LabelSet pBackglass,"BottomBox3","",1,""
  PuPlayer.LabelSet pBackglass,"bLine","",1,""
  PuPlayer.LabelSet pBackglass,"ltimertxt","",1,""
  PuPlayer.LabelSet pBackglass,"ltimer","",1,""
  'flasherlight5.state=0
  If ModeTotal(CurrentPlayer,Herman) > 0  and BallsOnPlayfield > 0 Then
    vpmtimer.addtimer 4000, "resetbackglass '"
    TvText "","HERMAN TOTAL\r" & CenterText(18,FormatNumber(ModeTotal(CurrentPlayer,Herman),0)),"",""
    RestoreScreen
  End If
  D "StopHermanMode - End()"
  cAwardMMadness
End Sub

Sub StopMadMarilynMode
  MarilynMode=False:SubLevels(CurrentPlayer,Madness)=2:StartMadnessStage3
  lStates(CurrentPlayer,13)=0:SetLightColor L13,yellow,0
  lStates(CurrentPlayer,102)=0:SetLightColor L102,yellow,0
End Sub

Sub StopMadLilyMode
  LilyMode=False:SubLevels(CurrentPlayer,Madness)=2:StartMadnessStage3
  SetLightColor L40,orange,0:lStates(CurrentPlayer,40)=0    ' Lily
  SetLightColor L41,orange,0:lStates(CurrentPlayer,41)=0
  SetLightColor L42,orange,0:lStates(CurrentPlayer,42)=0
  SetLightColor L43,orange,0:lStates(CurrentPlayer,43)=0
End Sub

Sub StopMadHermanMode
  HermanMode=False:SubLevels(CurrentPlayer,Madness)=2:StartMadnessStage3
  SetLightColor L56,white,0 'Herman
  SetLightColor L58,green,0
  SetLightColor L59,green,0
  SetLightColor L60,green,0
End Sub

Sub StopMadRavenMode
  RavenMode=False:SubLevels(CurrentPlayer,Madness)=2:StartMadnessStage3
  SetLightColor L95,blue,0:lStates(CurrentPlayer,95)=0    ' Raven
  SetLightColor L96,blue,0:lStates(CurrentPlayer,96)=0
  SetLightColor L97,blue,0:lStates(CurrentPlayer,97)=0
End Sub

Sub StopMadEddieMode
  EddieMode=False:SubLevels(CurrentPlayer,Madness)=2:StartMadnessStage3
  SetLightColor L12,red,0:lStates(CurrentPlayer,12)=0     ' Eddie
  SetLightColor L14,red,0:lStates(CurrentPlayer,14)=0
  SetLightColor L46,red,0:lStates(CurrentPlayer,46)=0
  SetLightColor L72,red,0:lStates(CurrentPlayer,72)=0
End Sub

Sub StopMadSpotMode
  SpotMode=False:SubLevels(CurrentPlayer,Madness)=2:StartMadnessStage3
  SetLightColor L106,red,0:lStates(CurrentPlayer,106)=0 ' Spot
  SetLightColor L107,red,0:lStates(CurrentPlayer,107)=0
  SetLightColor L108,red,0:lStates(CurrentPlayer,108)=0
  SetLightColor L109,red,0:lStates(CurrentPlayer,109)=0
  SetLightColor L98,red,0:lStates(CurrentPlayer,98)=0   ' Shot Spot
  SetLightColor L101,red,0:lStates(CurrentPlayer,101)=0
End Sub

Sub StopMadGrandpaMode
  GrandpaMode=False:SubLevels(CurrentPlayer,Madness)=2:StartMadnessStage3
  SetLightColor L78,purple,0:lStates(CurrentPlayer,78)=0    ' Grandpa
  SetLightColor L79,purple,0:lStates(CurrentPlayer,79)=0
  SetLightColor L81,purple,0:lStates(CurrentPlayer,81)=0
  SetLightColor L82,purple,0:lStates(CurrentPlayer,82)=0
  SetLightColor L104,green,0:lStates(CurrentPlayer,104)=0
End Sub

Sub StartMadnessStage3 ' Herman HurryUp MunsterMadness
  D "StartMadnessStage3"
  lStates(CurrentPlayer,51)=0:SetLightColor L51,white,2 'shots   ' left ramp, right orbit, right ramp, left orbit
End Sub

Sub StopMadnessStage3
  SubLevels(CurrentPlayer,Madness)=0   ' Back to getting an area and stage 1
  PuPlayer.LabelSet pBackglass,"TLine0","",1,"{'mt':2,'color': 16777215, 'fname':" & munsterfont & ", 'size': 6 }"
  PuPlayer.LabelSet pBackglass,"TLine1","",1,"{'mt':2,'color': 16777215, 'fname':" & jnumberfont & ", 'size': 10}"
  PuPlayer.LabelSet pBackglass,"TLine2","",1,"{'mt':2,'color': 16777215, 'fname':" & typefont & ",    'size': 6 }"

  If MadAreas(Lily)=0 Then StartLilyL
  If MadAreas(Herman)=0 Then StartHermanL
  If MadAreas(Raven)=0 Then StartRavenL
  If MadAreas(Spot)=0 Then StartSpotL
  If MadAreas(Grandpa)=0 Then StartGrandpaL
  If MadAreas(Eddie)=0 Then StartEddieL
  If MadAreas(Marilyn)=0 Then StartMarilynL
End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  BALL SAVE & LAUNCH
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'
Dim ballLaunched

  Sub ballsavestarttrigger_hit
    D "ballsavestarttrigger"
    If(bBallSaverReady = True) AND(15 <> 0) And(bBallSaverActive = False) Then
      EnableBallSaver 10
    End If
    ballLaunched=True
  End Sub

  Dim SkillShotTimeRemain

  Sub swPlungerRest_Hit()
    D "swPlungerRest _Hit"
    PlaySoundAt "fx_sensor", ActiveBall
    bBallInPlungerLane = True
    If bAutoPlunger Then
      PlungerIM.AutoFire
      DOF 113, DOFPulse
      DOF 115, DOFPulse
      DOF 318, DOFPulse
      bAutoPlunger = False
    Else
      ScorbitClaimQR(True)
    End If
    DOF 141, DOFOn
    DOF 317, DOFOn
    If bBallSaverReady Then
      L25.BlinkInterval = 160   'Show ball save light
      L25.State = 2
    End If
    If bSkillShotReady Then
      EnableSkillShot()
      swPlungerRest.TimerInterval = 5000
      swPlungerRest.TimerEnabled = 1
    End If
    LastSwitchHit="swPlungerRest"
  End Sub


  Sub swPlungerRest_UnHit()
    bBallInPlungerLane = False
    swPlungerRest.TimerEnabled = 0 'stop the launch ball timer if active
    If bSkillShotReady Then
      UpdateSkillShot()  'Turn on Timer
    End If
    DOF 317, DOFOff   'DOF MX - Ball is ready to Launch - OFF
    ScorbitClaimQR(False)
  End Sub

  Sub swPlungerRest_Timer
    swPlungerRest.TimerEnabled = 0
  End Sub

  Sub EnableBallSaver(seconds)
    bBallSaverActive = True
    bBallSaverReady = False
    BallSaverTimerExpired.Interval = 1000 * seconds
    BallSaverTimerExpired.Enabled = True
    BallSaverSpeedUpTimer.Interval = 1000 * seconds -(1000 * seconds) / 3
    BallSaverSpeedUpTimer.Enabled = True
    ' if you have a ball saver light you might want to turn it on at this point (or make it flash)
    D "Show Ball Saver Light"
    L25.BlinkInterval = 160
    L25.State = 2
  End Sub

  ' The ball saver timer has expired.  Turn it off AND reset the game flag
  '
  Sub BallSaverTimerExpired_Timer()
    D "Ballsaver ended"
    BallSaverTimerExpired.Enabled = False
    ' clear the flag
    Dim waittime
    waittime = 400  ' grace time for ball save
    vpmtimer.addtimer waittime, "ballsavegrace'"
    ' if you have a ball saver light then turn it off at this point
    If bExtraBallWonThisBall = True Then
      L25.State = 1
    Else
      L25.State = 0
    End If
  End Sub

  Sub ballsavegrace
    bBallSaverActive = False
  End Sub

  Sub BallSaverSpeedUpTimer_Timer()
    D "Ballsaver Speed Up Light"
    BallSaverSpeedUpTimer.Enabled = False
    ' Speed up the blinking
    L25.BlinkInterval = 80
    L25.State = 2
  End Sub

'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'FRAMEWORK BASE CODE END HERE
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************
'********************************************************************************************************************************************



'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  TABLE VARIABLES
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'


' Game Variables
Dim spinvalue
Dim finalflips
Dim Saves
Dim Drains
Dim inmode

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  GAME STARTING & RESETS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'

  Sub Game_Init() 'called at the start of a new game
    Dim i,a
    For i = 1 to 4
      SkillshotValue(i) = 1000000 ' increases by 1000000 each time it is collected
      ModesHeld(i,4) = LilySwHitsNeeded
      Kitty(i)=0
    Next
  ' lrflashtime.Enabled = False
    bExtraBallWonThisBall = False:bAddABallAwarded=False:bAddTimeAwarded=False
    for each a in  flasherlights
      SetLightColor a, white, -1
    Next
    inhighscore = False
    DropSpot()
    PaintModesClear

    PuPlayer.LabelSet pBackglass,"BottomBox1","",1,""
    PuPlayer.LabelSet pBackglass,"BottomBox1b","",1,""
    PuPlayer.LabelSet pBackglass,"BottomBox2","",1,""
    PuPlayer.LabelSet pBackglass,"BottomBox2b","",1,""
    PuPlayer.LabelSet pBackglass,"BottomBox3","",1,""
    PuPlayer.LabelSet pBackglass,"tLine3","",1,""
    PuPlayer.LabelSet pBackglass,"bLine","",1,""
    PuPlayer.LabelSet pBackglass,"rTimer","",1,""
    PuPlayer.LabelSet pBackglass,"rTimertxt","",1,""
    PuPlayer.LabelSet pBackglass,"lTimer","",1,""
    PuPlayer.LabelSet pBackglass,"lTimertxt","",1,""


    PuPlayer.LabelSet pBackglass,"high1name","",1,""
    PuPlayer.LabelSet pBackglass,"high1score","",1,""
    PuPlayer.LabelSet pBackglass,"high2name","",1,""
    PuPlayer.LabelSet pBackglass,"high2score","",1,""
    PuPlayer.LabelSet pBackglass,"high3name","",1,""
    PuPlayer.LabelSet pBackglass,"high3score","",1,""
    PuPlayer.LabelSet pBackglass,"high4name","",1,""
    PuPlayer.LabelSet pBackglass,"high4score","",1,""
    PuPlayer.LabelShowPage pBackglass,1,0,""
    pUpdateScores
    PuPlayer.playlistplayex pBackglass,"PuPOverlays","ball1.png",100,1
    PuPlayer.SetBackground pBackglass,1
    PuPlayer.LabelSet pBackglass,"Play1","PLAYER 1",1,"{'mt':2,'color':16777215}"
    PuPlayer.LabelSet pBackglass,"notetitle","",1,""
    PuPlayer.LabelSet pBackglass,"notecopy","",1,""
    resetbackglass
    screenTimer.interval=1000:screenTimer.enabled=True  'Places a timer on screen when needed
  End Sub

  Sub StopEndOfBallMode()              'this sub is called after the last ball is drained
    D "StopEndOfBallMode()"
    ResetSkillShot
    flasherlight1.state=0
    flasherlight2.state=0
    flasherlight3.state=0
    flasherlight4.state=0
    LilyTimer.Enabled=False
    DragTimer.Enabled=False
    MarilynTimer.Enabled=False
    EddieTimer.Enabled=False
    HermanTimer.Enabled=False
    SpotTimer.Enabled=False
    DropStop.collidable=False
    DropStop.isdropped=True
    RavenRestartTimer.Enabled=False
    if mMadnessMode Then StopMMadnessMode  ' should not need this

    lBoostTimer.Enabled=False:gBoostTimer.Enabled=False:rBoostTimer.Enabled=False:hBoostTimer.Enabled=False:sBoostTimer.Enabled=False

    SetLightColor L47,white,0  'shots
    SetLightColor L51,white,0
    SetLightColor L67,white,0
    SetLightColor L73,white,0

    If LilyMode Then
      LilyMode=False
      L20.state = 1
      If LilySwHits=0 Then LilySwHits=LilySwHitsNeeded  ' reset for Next Level
      ModesHeld(CurrentPlayer,4)=LilySwHits
    End If

    If SubLevels(CurrentPlayer,Herman)=1 Then
      SubLevels(CurrentPlayer,Herman)=0
      lStates(CurrentPlayer,56)=0
    End If

    GrandpaMode=False

    If RavenMode Then StopRavenMode
    If SpotMode Then StopSpotMode

    HermanMode=False
    PuPlayer.LabelSet pBackglass,"TLine3","",1,""
    PuPlayer.LabelSet pBackglass,"BottomBox3","",1,""
    PuPlayer.LabelSet pBackglass,"bLine","",1,""
    PuPlayer.LabelSet pBackglass,"rtimer","",1,"{'mt':2,'color':" & CStr(fpurple) & ", 'xpos': 74, 'size': 12 }"
    PuPlayer.LabelSet pBackglass,"rtimertxt","",1,"{'mt':2,'color':" & CStr(fgreen) & ", 'xpos': 76, 'size': 6 }"
    PuPlayer.LabelSet pBackglass,"ltimer","",1,"{'mt':2,'color':" & CStr(fgreen) & ", 'xpos': 72, 'size': 12 }"
    PuPlayer.LabelSet pBackglass,"ltimertxt","",1,"{'mt':2,'color':" & CStr(16777215) & ", 'xpos': 76, 'size': 6 }"
    D "StopEndOfBallMode() - done"
  End Sub

  Sub ResetNewBallVariables()
    Dim a
    playclear pMusic
    PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 4, ""FN"":11, ""VL"":80 }"
    If MaxSongs > 0 Then
      a=RndNum(1,MaxSongs)
      D "Playing " & fn(40,a)
      PuPlayer.playlistplayex pMusic,"audiobg",fn(40,a),80,1
    Else
      PuPlayer.playlistplayex pMusic,"audiobg","",80,1
    End if
    PuPlayer.SetLoop 4,1
    spops=0
    BonusMultiplier(CurrentPlayer) = 1
    Jackpots=0
    pfMultiplier=1
    bBallSaverReady = True
    bSkillShotReady = True
    MagnetStop
    If ModesHeld(CurrentPlayer,Herman)=1 Then ModesHeld(CurrentPlayer,Herman)=0 ' need to get magnet again
    GrandpaMode=False
    HermanMode=False
    EddieMode=False
    LilyMode=False
    RavenMode=False
    SpotMode=False
    MMadnessMode=False
    MarilynMode=False
    For a = 1 to 10
      ActiveJackpot(a)=False
      Boost(CurrentPlayer,a)=0
    Next
    For a = 1 to 4
      ZapShots(a)=0   ' if you earned a zapjackpot light
    Next
    LilyCnt=0:DragCnt = 0:HermanHurryCnt=0:ZapsCnt=0
  End Sub

  Sub TurnOffPlayfieldLights()
    Dim a
    For each a in alights
      a.State = 0
    Next
  End Sub


Sub StopRavenL
  L95.state=0:L96.state=0:L97.state=0
  If RavenRestartTimer.Enabled Then RavenRestartTimer_Timer() ' Cancel your chance at a restart of Raven
End Sub

Sub StopGrandpaL
  L78.state=0:L79.state=0:L81.state=0:L82.state=0:L63.state=0
End Sub

Sub StopSpotL
  L89.state=0:L90.state=0:L91.state=0:L92.state=0
  L106.state=0:L107.state=0:L108.state=0:L109.state=0
  L98.state=0:L101.state=0
  FlasherSpot1.visible=0:FlasherSpot1.TimerEnabled=False
  FlasherSpot2.visible=0:FlasherSpot2.TimerEnabled=False
  FlasherSpot3.visible=0:FlasherSpot3.TimerEnabled=False
  FlasherSpot4.visible=0:FlasherSpot4.TimerEnabled=False
End Sub

Sub SyncSpot ' Set the backboard flashers
  Select Case lStates(CurrentPlayer,89)
    Case 0  'ffffffffffffff
      FlasherSpot1.visible=0:FlasherSpot1.TimerEnabled=False
    Case 1
      FlasherSpot1.visible=1
    Case 2
      FlashForMs FlasherSpot1, 500000, 250, 2
  End Select
  Select Case lStates(CurrentPlayer,90)
    Case 0
      FlasherSpot2.visible=0::FlasherSpot2.TimerEnabled=False
    Case 1
      FlasherSpot2.visible=1
    Case 2
      FlashForMs FlasherSpot2, 500000, 250, 2
  End Select
  Select Case lStates(CurrentPlayer,91)
    Case 0
      FlasherSpot3.visible=0::FlasherSpot3.TimerEnabled=False
    Case 1
      FlasherSpot3.visible=1
    Case 2
      FlashForMs FlasherSpot3, 500000, 250, 2
  End Select
  Select Case lStates(CurrentPlayer,92)
    Case 0
      FlasherSpot4.visible=0::FlasherSpot4.TimerEnabled=False
    Case 1
      FlasherSpot4.visible=1
    Case 2
      FlashForMs FlasherSpot4, 500000, 250, 2
  End Select
End Sub

Sub StopLilyL
  L40.state=0:L41.state=0:L42.state=0:L43.state=0
  LilyTimer.Enabled=False
End Sub

Dim MagnetFlag:MagnetFlag=False

Sub StopHermanL
  L58.state=0:L59.state=0:L60.state=0
  L56.state=0
  MagnetFlag=False
  if mHMagnet.MagnetOn Then MagnetFlag=True
  MagnetStop
End Sub

Sub StopMarilynL
  L13.state=0:L102.state=0
End Sub

Sub StopEddieL 'todo
  L12.state=0:L14.state=0
  L46.state=0:L72.state=0
End Sub

Sub StartRavenL
  L95.state=lStates(CurrentPlayer,95):L96.state=lStates(CurrentPlayer,96):L97.state=lStates(CurrentPlayer,97)
End Sub

Sub StartGrandpaL
  L78.state=lStates(CurrentPlayer,78):L79.state=lStates(CurrentPlayer,79):L81.state=lStates(CurrentPlayer,81):L82.state=lStates(CurrentPlayer,82)
  L63.state=lStates(CurrentPlayer,63)
End Sub

Sub StartSpotL
  L89.state=lStates(CurrentPlayer,89):L90.state=lStates(CurrentPlayer,90):L91.state=lStates(CurrentPlayer,91):L92.state=lStates(CurrentPlayer,92)
  SyncSpot()
  L106.state=lStates(CurrentPlayer,106):L107.state=lStates(CurrentPlayer,107):L108.state=lStates(CurrentPlayer,108):L109.state=lStates(CurrentPlayer,109)
  L98.state=lStates(CurrentPlayer,98):L101.state=lStates(CurrentPlayer,101)
End Sub

Sub StartHermanL
  L58.state=lStates(CurrentPlayer,58):L59.state=lStates(CurrentPlayer,59):L60.state=lStates(CurrentPlayer,60)
  L56.state=lStates(CurrentPlayer,56)
  If MagnetFlag Then MagnetStart
  MagnetFlag=False
End Sub

Sub StartLilyL
  L40.state=lStates(CurrentPlayer,40):L41.state=lStates(CurrentPlayer,41):L42.state=lStates(CurrentPlayer,42):L43.state=lStates(CurrentPlayer,43)
  LilyTimer.Enabled=True
End Sub

Sub StartMarilynL
  L13.state=lStates(CurrentPlayer,13):L102.state=lStates(CurrentPlayer,102)
End Sub

Sub StartEddieL
  L12.state=lStates(CurrentPlayer,12):L14.state=lStates(CurrentPlayer,14)
  L46.state=lStates(CurrentPlayer,46):L72.state=lStates(CurrentPlayer,72)
End Sub


Const sb=250 ' slowblink
Const qb=100 ' quick blink

  Sub ResetNewBallLights() 'turn on or off the needed lights before a new ball is released
    TurnOffPlayfieldLights()
    currentplayerbackglass
    D "set or reset the lights to the initial ball state"
    ResetAllLightsColor
    L12.state = lStates(CurrentPlayer,12)
    L13.state = lStates(CurrentPlayer,13)
    L14.state = lStates(CurrentPlayer,14)
    L56.state=lStates(CurrentPlayer,56)

    L18.state = lStates(CurrentPlayer,18) ' Modes
    L19.state = lStates(CurrentPlayer,19)
    L20.state = lStates(CurrentPlayer,20)
    L21.state = lStates(CurrentPlayer,21)
    L22.state = lStates(CurrentPlayer,22)
    L23.state = 0 ' 2x
    L24.state = 0 ' 3x

    If lStates(CurrentPlayer,56) <> 0 Then
      SetLightColor L56, lc(SubLevels(CurrentPlayer,Herman)),lStates(CurrentPlayer,56)
    End If

    L32.state = lStates(CurrentPlayer,32)
    L33.state = lStates(CurrentPlayer,33)
    L34.state = lStates(CurrentPlayer,34)
    L35.state = lStates(CurrentPlayer,35)
    L36.state = lStates(CurrentPlayer,36)
    L37.state = lStates(CurrentPlayer,37)
    L38.state = lStates(CurrentPlayer,38)
    L103.state = lStates(CurrentPlayer,103) ' Mystery
    L106.state = lStates(CurrentPlayer,106) ' Spot
    L107.state = lStates(CurrentPlayer,107) ' sPot
    L108.state = lStates(CurrentPlayer,108) ' spOt
    L109.state = lStates(CurrentPlayer,109) ' spoT

    L51.state = lStates(CurrentPlayer,51):l51.blinkinterval=sb

    L58.state = lStates(CurrentPlayer,58):L58.blinkinterval=sb
    L59.state = lStates(CurrentPlayer,59):L59.blinkinterval=sb
    L60.state = lStates(CurrentPlayer,60):L60.blinkinterval=sb

    L63.state = lStates(CurrentPlayer,63)  'grandpa lab


    L80.state = lStates(CurrentPlayer,80) ' kitty

    L86.state = lStates(CurrentPlayer,86) 'top lanes
    L87.state = lStates(CurrentPlayer,87)

    L89.state = lStates(CurrentPlayer,89) ' SPOT
    L90.state = lStates(CurrentPlayer,90)
    L91.state = lStates(CurrentPlayer,91)
    L92.state = lStates(CurrentPlayer,92)
    SyncSpot()

    L95.state = lStates(CurrentPlayer,95)
    L96.state = lStates(CurrentPlayer,96)
    L97.state = lStates(CurrentPlayer,97)

    L98.state = lStates(CurrentPlayer,98)
    L101.state = lStates(CurrentPlayer,101)

    L78.state=lStates(CurrentPlayer,78) ' Grandpa
    L79.state=lStates(CurrentPlayer,79)
    L81.state=lStates(CurrentPlayer,81)
    L82.state=lStates(CurrentPlayer,82)

    lStates(CurrentPlayer,40)=2 ' LILY
    lStates(CurrentPlayer,41)=0
    lStates(CurrentPlayer,42)=0
    lStates(CurrentPlayer,43)=0

    ResetLilyLights()
    ResetGrandpaLights()
  End Sub

  Sub ResetGrandpaLights()
    SetLightColor L78,purple,0:SetLightColor L79,purple,0
    SetLightColor L81,purple,0:SetLightColor L82,purple,0
    L78.state = lStates(CurrentPlayer,78)
    L79.state = lStates(CurrentPlayer,79)
    L81.state = lStates(CurrentPlayer,81)
    L82.state = lStates(CurrentPlayer,82)
  End Sub

  Sub ResetLilyLights()
    L40.state = lStates(CurrentPlayer,40):L40.blinkinterval=sb
    L41.state = lStates(CurrentPlayer,41):L41.blinkinterval=sb
    L42.state = lStates(CurrentPlayer,42):L42.blinkinterval=sb
    L43.state = lStates(CurrentPlayer,43):L43.blinkinterval=sb
  End Sub

  Sub EnableSkillShot()
    D "EnableSkillShot"
    l87.State = 2
    L51.state = 2
    ' Show the right screen   'DEBUGS
    DropStop.collidable=True:DropStop.isdropped=False
    pStartBackLoop "videoothers","6 - coffin open - shoot skill shot glow.png"
    PuPlayer.LabelSet pBackglass,"TLine0","Skill Shot",1,"{'mt':2,'color': 200, 'size': 6, 'xpos': 20, 'ypos': 30}"
    PuPlayer.LabelSet pBackglass,"TLine2","",1,"{'mt':2,'size': 6,'xpos': 20, 'ypos': 40, 'fname':" & typefont & "}"
    PuPlayer.LabelSet pBackglass,"TLine3","",1,"{'mt':2,'size':4,'xpos': 20,'ypos':40,'fname':" & jnumberfont & "}"
    PuPlayer.LabelSet pBackglass,"TLine3","Shoot Lit Top Lane\rOr Left Ramp",1,"{'mt':2,'size':4,'xpos': 20,'ypos':40,'fname':" & jnumberfont & "}"
    PuPlayer.LabelShowPage pBackglass,2,0,""
  End Sub

  Sub UpdateSkillShot() 'Updates the skillshot light
    D "UpdateSkillShot"
    SkillShotTimeRemain = 10
    SkillShotTime.Interval  = 1000
    'ResetSkillShotTimer.Interval = 30000
    SkillShotTime.Enabled = 1
  End Sub

  Sub ResetSkillShot 'timer to reset the skillshot lights & variables
    SkillShotTime.Enabled = 0
    D "ResetSkillShot()"
    If bSkillshotReady then
      D "Turn OffSkillShot"
      bSkillShotReady = False
      pStopBackLoop
      L87.State = 0:L51.State = 0:L67.State = 0
      PuPlayer.LabelSet pBackglass,"TLine0","",1,""
      PuPlayer.LabelSet pBackglass,"TLine1","",1,""
      PuPlayer.LabelSet pBackglass,"TLine2","",1,""
      PuPlayer.LabelSet pBackglass,"TLine3","",1,"{'mt':2,'size':4,'xpos': 20,'ypos':40,'fname':" & jnumberfont & "}"
      PuPlayer.LabelSet pBackglass,"bLine","",1,""
      PuPlayer.LabelSet pBackglass,"rtimer","",1,""
      PuPlayer.LabelSet pBackglass,"rtimertxt","",1,""
      pStartBackLoop "videobackground",""
    End If
  End Sub

  Sub SkillShotTime_Timer 'Show a timer
    SkillShotTime.Enabled = 0
    SkillShotTimeRemain = SkillShotTimeRemain - 1
    PuPlayer.LabelSet pBackglass,"rtimertxt", "SKILL SHOT",1,"{'mt':2,'size': 4,'color': 16777215, 'xpos': 72, 'fname':" & typefont & "}"
    PuPlayer.LabelSet pBackglass,"rtimer", Lpad(SkillShotTimeRemain,2,"0"),1,"{'mt':2,'color': 16777215, 'size':10,'xpos': 76,'fname':" & jackpotfont & "}"
    If SkillShotTimeRemain > 0 Then
      SkillShotTime.Enabled = 1
    Else
      ResetSkillShot
    End If
  End Sub

  Sub lBoostTimer_Timer
    lBoostTimer.Enabled=False:Boost(CurrentPlayer,Lily)=0
    PuPlayer.LabelSet pBackglass,"LBoost","",1,""
  End Sub

  Sub gBoostTimer_Timer
    gBoostTimer.Enabled=False:Boost(CurrentPlayer,Grandpa)=0
    PuPlayer.LabelSet pBackglass,"GBoost","",1,""
  End Sub

  Sub rBoostTimer_Timer
    D "rBoostTimer_Timer - expired"
    rBoostTimer.Enabled=False:Boost(CurrentPlayer,Raven)=0
    PuPlayer.LabelSet pBackglass,"RBoost","",1,""
    lStates(CurrentPlayer,95)=2:SetLightColor L95, blue, 2
    lStates(CurrentPlayer,96)=2:SetLightColor L96, blue, 2
    lStates(CurrentPlayer,97)=2:SetLightColor L97, blue, 2
  End Sub

  Sub hBoostTimer_Timer
    hBoostTimer.Enabled=False:Boost(CurrentPlayer,Herman)=0
    PuPlayer.LabelSet pBackglass,"HBoost","",1,""
  End Sub

  Sub sBoostTimer_Timer
    sBoostTimer.Enabled=False:Boost(CurrentPlayer,Spot)=0
    PuPlayer.LabelSet pBackglass,"SBoost","",1,""
  End Sub

' if 3 areas are now lit then light extra ball
Sub cAwardExtraBallLight
  Dim a,b
  a=0
  for b = 18 to 22
    If lStates(CurrentPlayer,b) <> 0 Then a=a+1
  Next
  If a=3 and bExtraBallWonThisBall=False Then
    If lStates(CurrentPlayer,62)=0 Then
      lStates(CurrentPlayer,62)=2:SetLightColor L62,orange,2
      SpecialVideoClip 3500,"","","","","videospecials","Video-0x006B - extraball is lit.mp4"  ' is lit video
    End If
  End If
End Sub


' ==================================================
'          Jackpots
' ==================================================
Sub TestScoreJackPots
  Dim a
  Jackpots=10
  L30.state=2
    For a = 1 to 10
      ActiveJackpot(a)=True
    Next
  ScoreJackpots
End Sub

'Herman - Collect four Jackpots during Herman Multiball.
'Spot - Spell SPOT by completing four shots during Spots mode.
'Lily - Collect 100 switch hits during Lilys mode.
'Enlarging Ray - Collect a Jackpot during Enlarging Ray.
'Raven - Collect four Jackpots during Raven Multiball.
'Eddie - Collect five Eddie Loops.
'Marilyn - Collect two boyfriend departures.
'Zap - Collect four Zap Jackpots.
'Mystery - Immediately made available upon collecting a Mystery Award.

Sub ScoreJackpots
  Dim a,p,p1:a=0:p=3000
  Dim points:points=20000
  D "ScoreJackpots"
  If Jackpots > 0 AND L30.state=2 Then  ' you have jackpots and you didnt cancel
    ClearScreen
    PuPlayer.LabelShowPage pBackglass,3,0,""
  ' D "Score Grandpa SJP"

    If ActiveJackpot(Herman) Then vpmtimer.addtimer p*a, "scoreJPHerman '":a=a+1
    If ActiveJackpot(Spot) Then vpmtimer.addtimer p*a, "scoreJPSpot '":a=a+1
    If ActiveJackpot(Lily) Then vpmtimer.addtimer p*a, "scoreJPLily '":a=a+1
    If ActiveJackpot(Ray) Then vpmtimer.addtimer p*a, "scoreJPRay '":a=a+1
    If ActiveJackpot(Raven) Then vpmtimer.addtimer p*a, "scoreJPRaven '":a=a+1
    If ActiveJackpot(Eddie) Then vpmtimer.addtimer p*a, "scoreJPEddie '":a=a+1
    If ActiveJackpot(Marilyn) Then vpmtimer.addtimer p*a, "scoreJPMarilyn '":a=a+1
    If ActiveJackpot(Zap) Then vpmtimer.addtimer p*a, "scoreJPGrandpa '":a=a+1
    If ActiveJackpot(Mystery) Then vpmtimer.addtimer p*a, "scoreJPMystery '":a=a+1
    If ActiveJackpot(Grandpa) Then vpmtimer.addtimer p*a, "scoreJPGrandpa '":a=a+1
    vpmtimer.addtimer p*a+1000, "RestoreScreen '"
    Select Case Jackpots
      Case 1
        p1=points
      Case 2
        p1=points*3
      Case 3
        p1=points*6
      Case 4
        p1=points*10
      Case 5
        p1=points*13
      Case 6
        p1=points*15
      Case 7
        p1=points*17
      Case 8
        p1=points*19
      Case 9
        p1=points*21
      Case 10
        p1=points*23
    End Select
    p=CalcPoints(Zap, p1):AddScore p
    Jackpots=0
    For a = 1 to 10
      ActiveJackpot(a)=False
    Next
    L30.state=0:L30.blinkinterval=sb  ' JP
  End If
End Sub

Sub ScoreJPHerman
  D "Score Herman SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x0080 - herman.mp4",100,1
End Sub

Sub ScoreJPSpot
  D "Score Spot SJP"
  DOF 155, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x0044 - spot.mp4",100,1
End Sub

Sub ScoreJPLily
  'D "Score Lily SJP"
  DOF 155, DOFPulse
  FlashForMs flasherlight3, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x0059 - lily.mp4",100,1
End Sub

Sub ScoreJPRay
  D "Score Ray SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x0078 - ray.mp4",100,1
End Sub

Sub ScoreJPRaven
  D "Score Raven SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x0069 - raven.mp4",100,1
End Sub

Sub ScoreJPEddie
  D "Score Eddie SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x005A - eddie.mp4",100,1
End Sub

Sub ScoreJPMarilyn
  D "Score Marilyn SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x0099 - marilyn.mp4",100,1
End Sub

Sub ScoreJPZap
  D "Score Zap SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x000B - zap.mp4",100,1
End Sub

Sub ScoreJPMystery
  D "Score Mystery SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x0079 - mystery.mp4",100,1
End Sub

Sub ScoreJPGrandpa
  D "Score Grandpa SJP"
  DOF 150, DOFPulse
  FlashForMs flasherlight4, 2000, 250, 1
  FlashThem
  PuPlayer.playlistplayex pBackglass,"videosjp","Video-0x008B - grandpa.mp4",100,1
End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  MODES
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'
' Dragula
Sub DragTimer_Timer   'flash the drag lights
  Dim a
  DragCnt=DragCnt-1
  I "DragCNt = " & CStr(DragCnt)
  If DragCnt=10 Then
    For each a in draglights
      If a.state = 2 Then a.blinkinterval=qb
    Next
  End If
  If DragCnt < 0 Then
  ' D "Move Light"
    DragCnt = DragTime
    SetLightColor L29,white,0
    If L38.state = 2  Then' reset lights
      For each a in draglights
        a.state = 0:a.blinkinterval=sb
      Next
      SetLightColor L32,white,2
    Elseif L37.state = 2 Then
      L36.blinkinterval=sb:L36.state=2:L37.state=0
    Elseif L36.state = 2 Then
      L35.blinkinterval=sb:L35.state=2:L36.state=0
    Elseif L35.state = 2 Then
      L34.blinkinterval=sb:L34.state=2:L35.state=0
    Elseif L34.state = 2 Then
      L33.blinkinterval=sb:L33.state=2:L34.state=0
    Elseif L33.state = 2 Then
      L32.blinkinterval=sb:L32.state=2:L33.state=0
    End If
    lStates(CurrentPlayer,29)=L29.state
    lStates(CurrentPlayer,32)=L32.state
    lStates(CurrentPlayer,33)=L33.state
    lStates(CurrentPlayer,34)=L34.state
    lStates(CurrentPlayer,35)=L35.state
    lStates(CurrentPlayer,36)=L36.state
    lStates(CurrentPlayer,37)=L37.state
    lStates(CurrentPlayer,38)=L38.state
  End If
End Sub

Dim GrandpaMode, RavenMode, HermanMode, EddieMode, SpotMode, MarilynMode
'
' =======================================
'         Marilyn Mode
' =======================================

  Sub MarilynTimer_Timer
    EddieTimer.Enabled=False
    SetLightColor L102,yellow,0
    lStates(CurrentPlayer,102)=0
    If RndNum(1,10) < 2 Then PUP_audioevents "Sound-0x0642 - cant keep boyfriend.mp3"
  End Sub

  Sub StartMarilyn
    MarilynTimer.Interval=10000
    MarilynTimer.Enabled=False:MarilynTimer.Enabled=True  ' restart to extend timer
    SetLightColor L102,yellow,2
    lStates(CurrentPlayer,102)=2
  End Sub
'
' =======================================
'         Eddie Mode
' =======================================
  Sub EddieTimer_Timer
    EddieCnt=EddieCnt-10
    If EddieCnt < 10 Then
      EddieTimer.Enabled=False
      SetLightColor L46,red,0
      SetLightColor L72,red,0
      lStates(CurrentPlayer,46)=0
      lStates(CurrentPlayer,72)=0
    End If
  End Sub

  Sub StartEddie
    EddieTimer.Interval=100
    EddieTimer.Enabled=False:EddieCnt=10000:EddieTimer.Enabled=True  ' restart to extend timer
    SetLightColor L46,red,2
    SetLightColor L72,red,2
    lStates(CurrentPlayer,46)=2
    lStates(CurrentPlayer,72)=2
  End Sub

  Sub ScoreEddie
    Dim points,p  'eeeeee
    EddieTimer.Enabled=False  ' Stop the Counter
    D "ScoreEddie = Cnt= " & CStr(EddieCnt)
    ModesHeld(CurrentPlayer,Eddie)=ModesHeld(CurrentPlayer,Eddie)+1
    D "ScoreEddie " & ModesHeld(CurrentPlayer,Eddie)
    If ModesHeld(CurrentPlayer,Eddie) = 5 Then
      SpecialVideoClip 3500,"","","","","videosjp","Video-0x0073 - eddie is lit.mp4"  ' is lit video
      ActiveJackpot(Eddie)=True
      'PUP_audiojp ""
      JackPots=JackPots+1
      L30.blinkinterval=260-(JackPots*20):L30.state=2
      p=CalcPoints(Eddie, 400000):AddScore p
    Else
      points=INT(20000+(ModesHeld(CurrentPlayer,Eddie)+EddieCnt))
      p=CalcPoints(Eddie, points):AddScore p
      If ModesHeld(CurrentPlayer,Eddie) = 1 Then
        VideoClip 3000, "", CStr(ModesHeld(CurrentPlayer,Eddie)) & " EDDIE LOOP", CStr(FormatNumber(points,0)), CStr(5-(ModesHeld(CurrentPlayer,Eddie) mod 5)) & " MORE TO\nLIGHT SUPER JACKPOT"
      Else
        VideoClip 3000, "", CStr(ModesHeld(CurrentPlayer,Eddie)) & " EDDIE LOOPS", CStr(FormatNumber(points,0)), CStr(5-(ModesHeld(CurrentPlayer,Eddie) mod 5)) & " MORE TO\nLIGHT SUPER JACKPOT"
      End If
    End If
    EddieCnt=0:EddieTimer_Timer()  ' Turns off the lights
  End Sub
'
' =======================================
'         Grandpa Mode
' =======================================
Dim GrandpaModeTimeRemain
Sub ScoreGrandpa
  Dim p, points, tDelay
  tDelay=0
  If Shots(1)=0 Then GrandpaJackpots=GrandpaJackpots+1
  If Shots(2)=0 Then GrandpaJackpots=GrandpaJackpots+1
  If Shots(3)=0 Then GrandpaJackpots=GrandpaJackpots+1
  If Shots(4)=0 Then GrandpaJackpots=GrandpaJackpots+1
  D "*****ScoreGrandpa  Jackpots= " & CStr(GrandpaJackpots) & " SL=" & SubLevels(CurrentPlayer,Grandpa)
  SetLightColor L47,white,0
  SetLightColor L67,white,0
  SetLightColor L51,white,0
  SetLightColor L73,white,0
  If GrandpaJackpots >=4 Then   ' SJP
    GrandpaJackpots=GrandpaJackpots-4
    If Not ActiveJackpot(Grandpa) Then
      SpecialVideoClip 3500,"","","","","videosjp","Video-0x001A - grandpa is lit.mp4"  ' is lit video
      ActiveJackpot(Grandpa)=True
      Pup_audiojp "Sound-0x0956 - grandpa is lit.mp3"
      D "Light JackPot"
      tDelay=3500
    End If
    JackPots=JackPots+1
    L30.blinkinterval=260-(JackPots*20):L30.state=2
    p=CalcPoints(Herman, 400000):AddScore p
    If SubLevels(CurrentPlayer,Grandpa) < 3 then SubLevels(CurrentPlayer,Grandpa)=SubLevels(CurrentPlayer,Grandpa)+1
  End If
  points=1000000+(150000*(Shots(1)+Shots(2)+Shots(3)+Shots(4)))
  D "ScoreGrandpa - resetshots()"
  If SubLevels(CurrentPlayer,Grandpa) > 1 Then
    Shots(1)=1:Shots(2)=0:Shots(3)=0:Shots(4)=1  ' only 2 lights available to turn purple
    SetLightColor L47,white,2  'shots
    SetLightColor L51,white,0
    SetLightColor L67,white,0
    SetLightColor L73,white,2
  Else
    Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
    SetLightColor L47,white,2  'shots
    SetLightColor L51,white,2
    SetLightColor L67,white,2
    SetLightColor L73,white,2
  End If
  D "ScoreGrandpa - setup the ShowJackpot video"
  p=CalcPoints(Herman, points):AddScore p
  vpmtimer.addtimer tDelay, "ShowJackpot grandpa, " & Cstr(p) & ", Sublevels(CurrentPlayer,grandpa) '"
End Sub

Sub StartGrandpaMode
  D "StartGrandpaMode"
  GrandpaModeTimeRemain=45  ' add some extra so the ball can be ejected
  If Modes(CurrentPlayer,Grandpa)>1 Then GrandpaModeTimeRemain=30
  GrandpaMode=True:GrandpaJackpots=0   ' if 4 then light superjackpots
  StopHermanL:StopRavenL:StopSpotL
  L63.state=0:lStates(CurrentPlayer,63)=0
  ' all shots are white and all four lights are blinking
  SetLightColor L78,purple,2:SetLightColor L79,purple,2
  SetLightColor L81,purple,2:SetLightColor L82,purple,2

  SetLightColor L104, green, 2  'Add Time Light
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1  '1 is white
  SetLightColor L47,white,2  'shots
  SetLightColor L51,white,2
  SetLightColor L67,white,2
  SetLightColor L73,white,2
  D "StartGrandpaMode End()"
  ' every 4 jackpots will light super jackpot
  ScorbitBuildGameModes()
End Sub

Sub AwardGrandpa()
  D "AwardGrandpa"
  If lStates(CurrentPlayer,22)=0 Then
    GrandpaMode=True
    If Modes(CurrentPlayer,Grandpa)<3 Then  Modes(CurrentPlayer,Grandpa)=Modes(CurrentPlayer,Grandpa)+1
    PuPlayer.LabelSet pBackglass,"BottomBox3","Enlarging Ray",1,"{'mt':2,'color': " & CStr(fPurple) & ",'fname':" & numberfont & ", 'size': 3.6 }"
    FlashForMs L22, 1000, 50, 1
    lStates(CurrentPlayer,22)=1
    SpecialVideoClip 2500, "","","","","videospecials","Video-0x005E - grandpa mode.mp4"
    PUP_audioevents "Sound-0x0772 - collect 4jp.mp3"
    DOF 154, DOFPulse
    FlashForMs flasherlight2, 5000, 250, 1
    cAwardExtraBallLight
    AwardKitty()
    PaintModes()
    StartGrandpaMode()
    ScorbitBuildGameModes()
  End If
End Sub

Sub StopGrandpaMode
  D "StopGrandpaMode"
  GrandpaMode=False
  lStates(CurrentPlayer,22)=1:L22.state=1  ' Mode Light
  lStates(CurrentPlayer,47)=0:SetLightColor L47,white,0 'shots
  lStates(CurrentPlayer,51)=0:SetLightColor L51,white,0
  lStates(CurrentPlayer,67)=0:SetLightColor L67,white,0
  lStates(CurrentPlayer,73)=0:SetLightColor L73,white,0
  ShowZapShots()
  lStates(CurrentPlayer,104)=0:L104.state=0 ' add time light off
  StartHermanL:StartRavenL:StartSpotL
  PuPlayer.LabelSet pBackglass,"BottomBox3","",1,""
  PuPlayer.LabelSet pBackglass,"bLine","",1,""
  PuPlayer.LabelSet pBackglass,"ltimertxt","",1,""
  PuPlayer.LabelSet pBackglass,"ltimer","",1,""
  SetLightColor L78,purple,0:SetLightColor L79,purple,0
  SetLightColor L81,purple,0:SetLightColor L82,purple,0
  lStates(CurrentPlayer,78)=0:lStates(CurrentPlayer,79)=0
  lStates(CurrentPlayer,81)=0:lStates(CurrentPlayer,82)=0
  flasherlight3.state=0
  If ModeTotal(CurrentPlayer,Grandpa) > 0  and BallsOnPlayfield > 0 Then
    vpmtimer.addtimer 4000, "resetbackglass '"
    If Modes(CurrentPlayer,Grandpa) = 1 Then
      PUP_audioevents "Sound-0x08F4 - grandpa lvl 1.mp3"
    Else
      PUP_audioevents "Sound-0x0619 - grandpa complete.mp3"
    End If
    TvText "", "GRANDPA TOTAL\r" & LPad(FormatNumber(ModeTotal(CurrentPlayer,Grandpa),0),16," "),"",""
    RestoreScreen
  End If
  cAwardMMadness
End Sub

  Sub cGrandpa
    D "cGrandpa"
    L63.state=2:L63.blinkinterval=sb
    lStates(CurrentPlayer,63)=L63.state
    'PuPlayer.LabelShowPage pBackglass,2,0,""
    'PUP_tvclips()
    'ClearPage2Timer.interval = 3500
    'ClearPage2Timer.Enabled = 1
    'PuPlayer.LabelSet pBackglass,"tvline1","\r\r\r\r GRANDPA'S\rLABORATORY\r     IS LIT!",1,""
    TvText "\r\r\r\r    GRANDPA'S\r   LABORATORY\r        IS LIT!","","",""
  End Sub

  Sub GrandpaLightShot
    Dim a
    a = RndNum(1,4)
    D "GrandpaLightShot Before:" & CStr(Shots(1)) & CStr(Shots(2)) & CStr(Shots(3)) & CStr(Shots(4))
    If Shots(1)+Shots(2)+Shots(3)+Shots(4) > 0 Then
      If Shots(a mod 4 +1)=1 Then
        SetLightColor aShots((a+0) mod 4 +0),purple,2:Shots((a+0) mod 4 +1)=0  ' 0 means its purple
        D "Light up Shot " & CStr((a+0) mod 4 +1)
      ElseIf Shots((a+1) mod 4 +1)=1 Then
        SetLightColor aShots((a+1) mod 4 +0),purple,2:Shots((a+1) mod 4 +1)=0
        D "Light up Shot " & CStr((a+1) mod 4 +1)
      ElseIf Shots((a+2) mod 4 +1)=1 Then
        D "Light up Shot " & CStr((a+2) mod 4 +1)
        SetLightColor aShots((a+2) mod 4 +0),purple,2:Shots((a+2) mod 4 +1)=0
      ElseIf Shots((a+3) mod 4 +1)=1 Then
        D "Light up Shot " & CStr((a+3) mod 4 +1)
        SetLightColor aShots((a+3) mod 4 +0),purple,2:Shots((a+3) mod 4 +1)=0
      End If
    End If
    D "GrandpaLightShot After:" & CStr(Shots(1)) & CStr(Shots(2)) & CStr(Shots(3)) & CStr(Shots(4))
  End Sub
'
' =======================================
'          Herman Mode
' =======================================
  Sub HermanTimer_Timer
    HermanHurryCnt=HermanHurryCnt-1
    If HermanHurryCnt < 0 Then
      HermanTimer.Enabled=False
    End If
  End Sub

  Sub StartHermanMode
    D "Start Herman"
    DOF 152, DOFPulse
    FlashForMs flasherlight1, 5000, 250, 1
    ModesHeld(CurrentPlayer,Herman)=1
    VideoClip 2000, "","HERMAN IS LATE\r   FOR WORK!","",LPad("HURRY UP!",15," ")
    vpmtimer.addtimer 2500, "HermanHurryDisplay '"  '
'       vpmtimer.addtimer 3000, "RestoreScreen '"
'       vpmtimer.addtimer 3000, "resetbackglass '"
    HermanHurryCnt=2000
    HermanTimer.Interval=100
    HermanTimer.Enabled=True
    L58.blinkinterval=qb
    L59.blinkinterval=qb
    L60.blinkinterval=qb
    lStates(CurrentPlayer,56)=2:SetLightColor L56,green,2
    StopGrandpaL:StopRavenL:StopSpotL
    Dim bulb
    For each bulb in GI
      SetLightColor bulb, green, 1
    Next
    vpmtimer.addtimer 500, "MagnetStart '"  ' Let the ball come down from being hit
  End Sub

  Sub HermanHurryDisplay
    TvText "HURRY UP!", FormatNumber(CStr(HermanHurryCnt*100),0), "", ""
'       vpmtimer.addtimer 3000, "RestoreScreen '"
'       vpmtimer.addtimer 3000, "resetbackglass '"
  End Sub

  Sub HermanHurryDisplay2
    TvText "HIT THE BALL!", "", "", ""
    PUP_audioevents "Sound-0x0631 - hit herman ball.mp3"
    vpmtimer.addtimer 3000, "RestoreScreen '"
    vpmtimer.addtimer 3000, "resetbackglass '"
  End Sub

  Sub HermanHurryBall
    D "HermanHurrayBall()"
    VideoClip 2000, "MUNSTER\rIN THE PARK\rHURRY UP!","","HIT THE BALL!",""
    FlashThem()
    AddMultiball 1
    vpmtimer.addtimer 2500, "HermanHurryDisplay2 '"  '
  End Sub

  Sub AwardHermanJackpot
    D "AwardHermanJackpot HermanJackpots=" & CStr(HermanJackpots)
    Dim p,points, tDelay
    tDelay=0
' if 4 jackpots then award SJP
    HermanJackpots=HermanJackpots+1
    If HermanJackpots mod 4 = 0 Then
      If Not ActiveJackpot(Herman) Then
        SpecialVideoClip 3500,"","","","","videosjp","Video-0x007E - herman is lit.mp4"  ' is lit video
        tDelay=3500
        ActiveJackpot(Herman)=True
        'Pup_audiojp ""
        D "Light JackPot"
      End If
      JackPots=JackPots+1
      L30.blinkinterval=260-(JackPots*20):L30.state=2
    End If
    points=150000+((HermanJackPots-1)*12500)  ' verified
    vpmtimer.addtimer tDelay, "ShowJackpot herman, " & Cstr(points) & ", SubLevels(CurrentPlayer,Herman) '"
    p=CalcPoints(Herman, points):AddScore p
  End Sub
'
' =======================================
'          Spot Mode
' =======================================
  Dim SpotTimeRemain:SpotTimeRemain=0

  Sub DropSpotTease
    SpotWall.isDropped=True
    'SpotRamp.WidthBottom=0:SpotRamp.WidthTop=0
    SpotRamp2.WidthBottom=0:SpotRamp2.WidthTop=0
    SpotLight.state=1
    SpotLight.state=0
    PlaySound SoundFXDOF("fx_target",117,DOFPulse,DOFTargets)
  End Sub

  Sub RaiseSpot
    D "Raise Spot"
    SpotWall.isDropped=False
    'SpotRamp.WidthBottom=90:SpotRamp.WidthTop=65
    SpotDoorOpen.visible=True:SpotDoorClosed.visible=False
    SpotRamp2.WidthBottom=80:SpotRamp2.WidthTop=80
    SpotLight.state=1
    SpotLight.state=0
    SetLightColor L51,red,2
    SetLightColor L98,red,2
    PlaySound SoundFXDOF("fx_target",117,DOFPulse,DOFTargets)
  End Sub

  Sub DropSpot
    SpotWall.isDropped=True
    'SpotRamp.WidthBottom=0:SpotRamp.WidthTop=0
    SpotDoorOpen.visible=False:SpotDoorClosed.visible=True
    SpotRamp2.WidthBottom=0:SpotRamp2.WidthTop=0
    SpotLight.state=1
    SpotLight.state=0
    SetLightColor L51,red,0
    SetLightColor L98,red,0
    PlaySound SoundFXDOF("fx_target",117,DOFPulse,DOFTargets)
  End Sub

  Sub AwardSpotLetter
    Dim p
    D "AwardSpotLetter"
    p=CalcPoints(Spot, 150000):AddScore p
    If lStates(CurrentPlayer,106)=0 Then
      lStates(CurrentPlayer,106)=2:L106.state=2
      lStates(CurrentPlayer,89)=2:L89.state=2
      SyncSpot()
      TvText "\r\r\r" & CenterText(18,"SPOT") & "\r" & CenterText(18,CStr(FormatNumber(p,0))) & "\r" & CenterText(18,"3 Spot Letters Left") & "\r" & CenterText(18,"For Super Jackpot"),"","",""
      If SubLevels(CurrentPlayer,Spot) > 0 Then '
        vpmtimer.addtimer 1000, "DropSpot '"
      End If
    ElseIf lStates(CurrentPlayer,107)=0 Then
      lStates(CurrentPlayer,107)=2:L107.state=2
      lStates(CurrentPlayer,90)=2:L90.state=2
      SyncSpot()
      TvText "\r\r\r" & CenterText(18,"SPOT") & "\r" & CenterText(18,CStr(FormatNumber(p,0))) & "\r" & CenterText(18,"2 Spot Letters Left") & "\r" & CenterText(18,"For Super Jackpot"),"","",""
      If SubLevels(CurrentPlayer,Spot) > 0 Then '
        vpmtimer.addtimer 1000, "DropSpot '"
      End If
    ElseIf lStates(CurrentPlayer,108)=0 Then
      lStates(CurrentPlayer,108)=2:L108.state=2
      lStates(CurrentPlayer,91)=2:L91.state=2
      SyncSpot()
      TvText "\r\r\r" & CenterText(18,"SPOT") & "\r" & CenterText(18,CStr(FormatNumber(p,0))) & "\r" & CenterText(18,"1 Spot Letter Left") & "\r" & CenterText(18,"For Super Jackpot"),"","",""
      If SubLevels(CurrentPlayer,Spot) > 0 Then '
        vpmtimer.addtimer 1000, "DropSpot '"
      End If
    Else ' all 4 spot letters
      If Not SpotMode Then
        AwardSpot() ' reset lights and work towards a jackpot
      Else
        AwardSpotJackpot()
        lStates(CurrentPlayer,106)=2:L106.state=2  'spot letters
        lStates(CurrentPlayer,107)=0:L107.state=0
        lStates(CurrentPlayer,108)=0:L108.state=0
        lStates(CurrentPlayer,109)=0:L109.state=0
        lStates(CurrentPlayer,89)=2:L89.state=2
        lStates(CurrentPlayer,90)=0:L90.state=0
        lStates(CurrentPlayer,91)=0:L91.state=0
        lStates(CurrentPlayer,92)=0:L92.state=0
        SyncSpot()
        If SubLevels(CurrentPlayer,Spot)<3 Then SubLevels(CurrentPlayer,Spot)=SubLevels(CurrentPlayer,Spot)+1
        vpmtimer.addtimer 1000, "DropSpot '"
        SetLightColor L47,blue,2   ' show spot raise blue targets
        SetLightColor L67,blue,2   ' show spot raise blue targets
      End If
    End If
  End Sub

  Sub StopSpotMode()
    D "StopSpotMode()"
    SpotMode=False
    DropSpot()
    SpotTimeRemain=0
    lStates(CurrentPlayer,21)=1:L21.state=1
    SetLightColor L98,red,0::lStates(CurrentPlayer,98)=0 'shot spot
    SetLightColor L101,red,0:lStates(CurrentPlayer,101)=0
    lStates(CurrentPlayer,47)=0:SetLightColor L47,white,0 'shots
    lStates(CurrentPlayer,51)=0:SetLightColor L51,white,0
    lStates(CurrentPlayer,67)=0:SetLightColor L67,white,0
    lStates(CurrentPlayer,73)=0:SetLightColor L73,white,0
    ShowZapShots()
    StartHermanL:StartGrandpaL:StartRavenL
    PuPlayer.LabelSet pBackglass,"BottomBox3","",1,""
    PuPlayer.LabelSet pBackglass,"bLine","",1,""
    PuPlayer.LabelSet pBackglass,"ltimertxt","",1,""
    PuPlayer.LabelSet pBackglass,"ltimer","",1,""
    flasherlight4.state=0
    If ModeTotal(CurrentPlayer,Spot) > 0 and BallsOnPlayfield > 0 Then
      vpmtimer.addtimer 4000, "resetbackglass '"
      If Modes(CurrentPlayer,Spot) = 1 Then PUP_audioevents "Sound-0x0743 - spot lvl 1.mp3"
      TvText "",CenterText(18,"SPOT TOTAL") & "\r" & CenterText(18,FormatNumber(ModeTotal(CurrentPlayer,Spot),0)),"",""
      RestoreScreen
    End If
    cAwardMMadness
  End Sub

  Sub AwardSpot()
    D "AwardSpot"
    If lStates(CurrentPlayer,21)=0 Then ' Did we get the Mode Complete?
      SpotMode=True
      lStates(CurrentPlayer,106)=2:L106.state=2  'spot letters
      lStates(CurrentPlayer,107)=0:L107.state=0
      lStates(CurrentPlayer,108)=0:L108.state=0
      lStates(CurrentPlayer,109)=0:L109.state=0
      lStates(CurrentPlayer,89)=2:L89.state=2
      lStates(CurrentPlayer,90)=0:L90.state=0
      lStates(CurrentPlayer,91)=0:L91.state=0
      lStates(CurrentPlayer,92)=0:L92.state=0
      SyncSpot()
      If Modes(CurrentPlayer,Spot)<3 Then Modes(CurrentPlayer,Spot)=Modes(CurrentPlayer,Spot)+1
      PuPlayer.LabelSet pBackglass, "BottomBox3", "    SPOT",1,"{'mt':2,'color': " & CStr(fRed) & ",'fname':" & numberfont & ", 'size': 6 }"
      lStates(CurrentPlayer,21)=1
      L21.state=2:L21.blinkinterval=150
      DOF 151, DOFPulse
      FlashForMs flasherlight4, 5000, 250, 1
      cAwardExtraBallLight
      AwardKitty()
      PaintModes()
      StartSpotMode()
      ScorbitBuildGameModes()
    End If
  End Sub

  Sub AwardSpotJackpot
    Dim p
    If Not ActiveJackpot(Spot) Then
      SpecialVideoClip 3500,"","","","","videosjp","Video-0x002F - spot is lit.mp4"  ' is lit video
      ActiveJackpot(Spot)=True
      D "Light JackPot"
      'Pup_audiojp ""
    End If
    Jackpots=Jackpots+1
    L30.blinkinterval=260-(Jackpots*20):L30.state=2
    p=CalcPoints(Spot, 100000):AddScore p
  End Sub

  Sub StartSpotMode()
    SpotMode=True
    SpotTimeRemain=47
    StopHermanL:StopGrandpaL:StopRavenL
    RaiseSpot()
    ScorbitBuildGameModes()
  End Sub

  Sub SpotTimer_Timer
    If SpotTimerRemain < 0 Then
      SpotTimer.Enabled=False
    End If
  End Sub

  Sub SpotWall_Hit
    D "SpotWall_Hit"
    PlaySound SoundFXDOF("plastichit",119,DOFPulse,DOFShaker)
  End Sub
'
' =======================================
'         Lily Mode
' =======================================
Dim LilyModeTimeRemain

Sub AwardLily
  D "Award Lily"
  If SubLevels(CurrentPlayer,Lily)<3 Then SubLevels(CurrentPlayer,Lily)=SubLevels(CurrentPlayer,Lily)+1
  If lStates(CurrentPlayer,20)=0 Then
    LilyMode=True:LilySwHits=ModesHeld(CurrentPlayer,Lily)
    If Modes(CurrentPlayer,Lily)<3 Then Modes(CurrentPlayer,Lily)=Modes(CurrentPlayer,Lily)+1
    PuPlayer.LabelSet pBackglass,"BottomBox3","\r LILY MODE",1,"{'mt':2,'color': " & CStr(fOrange) & ",'fname':" & numberfont & ", 'size': 5.5 }"
    lStates(CurrentPlayer,20)=1
    L20.state = 2:L20.blinkinterval=150

    L40.blinkinterval=250:L41.blinkinterval=250:L42.blinkinterval=250:L43.blinkinterval=250
    L40.state = 0:L41.state = 0:L42.state=0:L43.state=0
    L40.state = 2:L41.state = 2:L42.state=2:L43.state=2
    SpecialVideoClip 1900,"","\r\r\rEverything\rScores More!","","","videospecials","Video-0x00C7 - lily mode.mp4"
    LilyModeTimeRemain=LilyModeTime
    DOF 156, DOFPulse
    FlashForMs flasherlight3, 5000, 250, 1
    cAwardExtraBallLight
    AwardKitty()
    PaintModes()
    ScorbitBuildGameModes()
  Else ' Already got this level so just Score more
    LilyMode=True:LilySwHits=ModesHeld(CurrentPlayer,Lily)
    PuPlayer.LabelSet pBackglass,"BottomBox3","\r LILY MODE",1,"{'mt':2,'color': " & CStr(fOrange) & ",'fname':" & numberfont & ", 'size': 5.5 }"
    L40.blinkinterval=250:L41.blinkinterval=250:L42.blinkinterval=250:L43.blinkinterval=250
    L40.state = 0:L41.state = 0:L42.state=0:L43.state=0
    SpecialVideoClip 1900,"","\r\r\rEverything\rScores More!","","","videospecials","Video-0x00C7 - lily mode.mp4"
    LilyModeTimeRemain=LilyModeTime
    DOF 156, DOFPulse
    FlashForMs flasherlight3, 5000, 250, 1
    AwardKitty()
    PaintModes()
    ScorbitBuildGameModes()
  End If
End Sub

Sub cLilyMode   ' What do to after each switch Hit
  If Not LilyMode Then Exit Sub
  D "cLilyMode"
  If LilySwHits > 0 Then
    LilySwHits=LilySwHits-1
  End If
  If LilySwHits = 0 Then ' light the SJP
    SpecialVideoClip 2500,"","","","","videosjp","Video-0x008D - lily is lit.mp4"  ' is lit video
    StopLilyMode() ' DEBUG
    FlashLevel3=1:Flasherflash3_Timer
    ActiveJackpot(Lily)=True
    'PUP_audiojp ""
    D "Light JackPot"
    JackPots=JackPots+1
    L30.blinkinterval=260-(JackPots*20):L30.state=2
    DOF 155, DOFPulse
    FlashForMs flasherlight3, 2000, 250, 0
  End If
End Sub

Sub StopLilyMode
  D "StopLilyMode()"
  LilyMode=False
  lStates(CurrentPlayer,20)=1:L20.state = 1
  lStates(CurrentPlayer,40)=2   ' reset
  lStates(CurrentPlayer,41)=0:lStates(CurrentPlayer,42)=0:lStates(CurrentPlayer,43)=0
  ResetLilyLights()
  If LilySwHits=0 Then LilySwHits=LilySwHitsNeeded  ' reset for Next Level
  ModesHeld(CurrentPlayer,Lily)=LilySwHits
  PuPlayer.LabelSet pBackglass,"BottomBox3","",1,""
  PuPlayer.LabelSet pBackglass,"bLine","",1,""
  PuPlayer.LabelSet pBackglass,"rtimer","",1,""
  PuPlayer.LabelSet pBackglass,"rtimertxt","",1,""
  flasherlight3.state=0
  If ModeTotal(CurrentPlayer,Lily) > 0 Then
    vpmtimer.addtimer 4000, "resetbackglass '"
    If Modes(CurrentPlayer,Lily) = 1 Then
      If  RndNum(1,10) < 4 Then
        PUP_audioevents "Sound-0x08F7 - lilly lvl 1.mp3"
      Else
        PUP_audioevents "Sound-0x0740 - lily lvl 1.mp3"
      End If
    Else
      PUP_audioevents "Sound-0x0729 - finished lily.mp3"
    End If
    If BallsOnPlayfield > 0 Then
      TvText "", CenterText(18,"LILY TOTAL") & "\r" & CenterText(18,FormatNumber(ModeTotal(CurrentPlayer,Lily),0)),"",""
      RestoreScreen
    End If
  End If
  cAwardMMadness
  ScorbitBuildGameModes()
End Sub
'
' =======================================
'         Raven Mode
' =======================================

Sub AwardRavenBlink
  If lStates(CurrentPlayer,95)=0 Then
    lStates(CurrentPlayer,95)=2:SetLightColor L95, blue, 2
  ElseIf lStates(CurrentPlayer,96)=0 Then
    lStates(CurrentPlayer,96)=2:SetLightColor L96, blue, 2
  ElseIf lStates(CurrentPlayer,97)=0 Then
    lStates(CurrentPlayer,97)=2:SetLightColor L97, blue, 2
  End If
End Sub

Sub AwardRavenLight
  If lStates(CurrentPlayer,95)=2 Then
    lStates(CurrentPlayer,95)=1:SetLightColor L95, blue, 1
  ElseIf lStates(CurrentPlayer,96)=2 Then
    lStates(CurrentPlayer,96)=1:SetLightColor L96, blue, 1
  ElseIf lStates(CurrentPlayer,97)=2 Then
    lStates(CurrentPlayer,97)=1:SetLightColor L97, blue, 1
    If Not RavenMode Then
      AwardRaven()
    Else  ' Award and/or recharge RavenBoost if in RavenMode
      'TEST7
      rBoostTimer.Enabled=False:rBoostTimer.interval=20000:rBoostTimer.Enabled=True
      Boost(CurrentPlayer,Raven)=1:PaintModes()
      lStates(CurrentPlayer,95)=1:SetLightColor L95, blue, 1   'relight them since timer would have turned them off
      lStates(CurrentPlayer,96)=1:SetLightColor L96, blue, 1
      lStates(CurrentPlayer,97)=1:SetLightColor L97, blue, 2
    End If
  End If
End Sub

Sub AwardRaven
  D "AwardRaven"
  If lStates(CurrentPlayer,19)=0 Then
    RavenMode=True:RavenJackpots=0:DidGetRavenJackpot=False
    If Modes(CurrentPlayer,Raven)<3 Then Modes(CurrentPlayer,Raven)=Modes(CurrentPlayer,Raven)+1
    PuPlayer.LabelSet pBackglass, "BottomBox3","Raven Mode",1,"{'mt':2,'color': " & CStr(fBlue) & ",'fname':" & numberfont & ", 'size': 5 }"
    FlashForMs L19, 1000, 50, 1
    lStates(CurrentPlayer,19)=1
    'DOF 153, DOFPulse
    'FlashForMs flasherlight5, 5000, 250, 1
    lStates(CurrentPlayer,95)=2:SetLightColor L95, blue, 2
    lStates(CurrentPlayer,96)=2:SetLightColor L96, blue, 2
    lStates(CurrentPlayer,97)=2:SetLightColor L97, blue, 2
    Shots(1)=1:lStates(CurrentPlayer,47)=2:SetLightColor L47, white, 2
    Shots(2)=1:lStates(CurrentPlayer,51)=2:SetLightColor L51, white, 2
    Shots(3)=1:lStates(CurrentPlayer,67)=2:SetLightColor L67, white, 2
    Shots(4)=1:lStates(CurrentPlayer,73)=2:SetLightColor L73, white, 2
    ModesHeld(CurrentPlayer,Raven)=60 ' 1 occlock
    cAwardExtraBallLight
    AwardKitty()
    PaintModes()
    StartRavenMode()
    ScorbitBuildGameModes()
  End If
End Sub

Dim DidGetRavenJackpot:DidGetRavenJackpot=False

  Sub AwardRavenJackpot
    D "AwardRavenJackpot RavenJackpots=" & CStr(RavenJackpots)
    Dim p,points, tDelay
    tDelay=0
' if 4 jackpots then award SJP
    RavenJackpots=RavenJackpots+1
    If Shots(1)+Shots(2)+Shots(3)+Shots(4)=0 Then
      Shots(1)=1:lStates(CurrentPlayer,47)=2:SetLightColor L47, white, 2
      Shots(2)=1:lStates(CurrentPlayer,51)=2:SetLightColor L51, white, 2
      Shots(3)=1:lStates(CurrentPlayer,67)=2:SetLightColor L67, white, 2
      Shots(4)=1:lStates(CurrentPlayer,73)=2:SetLightColor L73, white, 2
      If Not ActiveJackpot(Raven) Then
        SpecialVideoClip 3500,"","","","","videosjp","Video-0x00BA - raven is lit.mp4"  ' is lit video
        tDelay=3500
        ActiveJackpot(Raven)=True
        DidGetRavenJackpot=True
        'Pup_audiojp ""
        D "Light JackPot"
      End If
      JackPots=JackPots+1
      L30.blinkinterval=260-(JackPots*20):L30.state=2
      SubLevels(CurrentPlayer,Raven)=SubLevels(CurrentPlayer,Raven)+1
    End If
    points=150000*(ROUND(ModesHeld(CurrentPlayer,Raven)/60,0))   ' Based on clock Hours
    vpmtimer.addtimer tDelay, "ShowJackpot Raven, " & Cstr(points) & ", SubLevels(CurrentPlayer,Raven) '"
    p=CalcPoints(Raven, points):AddScore p
  End Sub

Sub StartRavenMode()
  StopHermanL:StopGrandpaL:StopSpotL
  SpecialVideoClip 3800,"","","","","videospecials","Video-0x00BB - raven mb.mp4"
  FlashThem()
  AddMultiball 2
  Pup_AudioEvents "Sound-0x08AE - raven mb.mp3"
  EnableBallSaver 10    'quick ballsaver
End Sub

Sub StopRavenMode
  D "StopRavenMode"
  RavenMode=False
  StartHermanL:StartGrandpaL:StartSpotL
  lStates(CurrentPlayer,47)=0:SetLightColor L47,white,0 'shots
  lStates(CurrentPlayer,51)=0:SetLightColor L51,white,0
  lStates(CurrentPlayer,67)=0:SetLightColor L67,white,0
  lStates(CurrentPlayer,73)=0:SetLightColor L73,white,0
  lStates(CurrentPlayer,95)=0:SetLightColor L95, blue, 0
  lStates(CurrentPlayer,96)=0:SetLightColor L96, blue, 0
  lStates(CurrentPlayer,97)=0:SetLightColor L97, blue, 0
  rBoostTimer.Enabled=False:Boost(CurrentPlayer,Raven)=0
  lStates(CurrentPlayer,28)=0:SetLightColor L28,orange, 0 ' add a ball
  PuPlayer.LabelSet pBackglass,"RBoost","",1,""
  ShowZapShots()
  PuPlayer.LabelSet pBackglass,"BottomBox3","",1,""
  PuPlayer.LabelSet pBackglass,"bLine","",1,""
  PuPlayer.LabelSet pBackglass,"ltimertxt","",1,""
  PuPlayer.LabelSet pBackglass,"ltimer","",1,""
  'flasherlight5.state=0
  If ModeTotal(CurrentPlayer,Raven) > 0 and DidGetRavenJackpot and BallsOnPlayfield > 0 Then 'if you got the jackpot then you dont get a chance to restart so show total..   'test9
    vpmtimer.addtimer 4000, "resetbackglass '"
    If Modes(CurrentPlayer,Raven) = 1 Then
      If RndNum(1,10) < 4 Then
        PUP_audioevents "Sound-0x08F9 - raven lvl 1.mp3"
      Else
        PUP_audioevents "Sound-0x0742 - raven lvl 1.mp3"
      End If
    End If
    TvText "", "     RAVEN TOTAL\r" & LPAD(FormatNumber(ModeTotal(CurrentPlayer,Raven),0),20," "), "",""
    RestoreScreen
  End If
  cAwardMMadness
End Sub

Sub StartRavenRestartMode  '15s timer on left ramp to restart RavenMode
  SpecialVideoClip 3800,"","","","","videospecials","Video-0x0063 - shoot left.mp4"
  RavenRestartTimer.Interval=15000:RavenRestartTimer.Enabled=True
  lStates(CurrentPlayer,51)=2:SetLightColor L51,white,2:L51.blinkinterval=qb
End Sub

Sub RavenRestartTimer_Timer
  RavenRestartTimer.Enabled=False
  lStates(CurrentPlayer,51)=0:SetLightColor L51,white,0:L51.blinkinterval=sb
  If Not RavenMode and ModeTotal(CurrentPlayer,Raven) > 0 Then 'test9  'restart timer expired and you didnt get back into Ravenmode so show totals
    vpmtimer.addtimer 4000, "resetbackglass '"
    TvText "", "     RAVEN TOTAL\r" & LPAD(FormatNumber(ModeTotal(CurrentPlayer,Raven),0),20," "), "",""
    RestoreScreen
  End If
End Sub
'
' =======================================
'        MunsterMadness
' =======================================
Sub cAwardMMadness 'mmad
  Dim a,b
  a=0
  for b = 18 to 22
    If lStates(CurrentPlayer,b) <> 0 Then a=a+1
  Next
  If a=5 and Not MMadnessMode Then
    If lStates(CurrentPlayer,17)=0 and lStates(CurrentPlayer,64)=0 Then
      lStates(CurrentPlayer,17)=2:SetLightColor L17,white,2:L17.blinkInterval=qb
      lStates(CurrentPlayer,64)=2:SetLightColor L64,white,2:L64.blinkInterval=qb
      If RndNum(1,10) < 5 Then
        PUP_audioevents "Sound-0x0672 - mmadness.mp3"
      Else
        PUP_audioevents "Sound-0x0831 - mmadness lit.mp3"
      End If
    End If
  End If
End Sub

Sub StartmMadnessMode()
  D "StartmMadnessMode"
  dim a
  for a = 1 to 11
    MadAreas(a)=0
  next
  StopHermanL:StopGrandpaL:StopSpotL:StopRavenL:StopLilyL:StopMarilynL:StopEddieL
  HermanJackpots=0:GrandpaJackpots=0:SpotJackpots=0:LilyJackpots=0:RavenJackpots=0:MarilynJackpots=0:EddieJackpots=0
  Eddie2x=False
  GiAllOff
  f168.state=0
  f169.state=0
  f170.state=0
  SubLevels(CurrentPlayer,Madness)=0
  If Modes(CurrentPlayer,Madness) < 3 Then Modes(CurrentPlayer,Madness)=Modes(CurrentPlayer,Madness)+1
  Modes(CurrentPlayer,Marilyn)=Modes(CurrentPlayer,Madness) ' since you dont need to get it to get to MMadness
  Modes(CurrentPlayer,Eddie)=Modes(CurrentPlayer,Madness)   ' since you dont need to get it to get to MMadness
  TurnOffPlayfieldLights()
  ClearScreen
  mMadnessMode=True
  'SpecialVideoClip 28000,"","","","","videommadness","Video-0x009B - all - slower.mp4"  ' MunsterMadness Rules + ClearPage3 VideoClip

    PuPlayer.LabelShowPage pBackglass,3,0,""
    PuPlayer.LabelSet pBackglass,"Fline0","",1,""
    PuPlayer.LabelSet pBackglass,"Fline1","",1,""
    PuPlayer.LabelSet pBackglass,"Fline2","",1,""
    PuPlayer.LabelSet pBackglass,"Fline3","",1,""
    PuPlayer.playlistplayex pBackglass,"videommadness","Video-0x009B - all - slower.mp4",100,1


  Pup_audiojp "Sound-0x082D - mmadness.mp3"
  ScorbitBuildGameModes()
  ClearScreen
  PuPlayer.LabelShowPage pBackglass,3,0,""
  PuPlayer.playlistplayex pBackglass,"videommadness","Video-0x009B - all - slower.mp4",100,1
    vpmtimer.addtimer 500, "paper1'"
End Sub

Dim pwait:pwait=Int(19000/7)

Sub paper1() 'herman
  'PuPlayer.playlistplayex pBackglass,"videommadness","Video-0x0028 - herman.mp4",10,1
  SetLightColor L17,green,0:L17.blinkInterval=sb
  SetLightColor L25,orange,2:L25.blinkInterval=qb
  SetLightColor L18,green,2:L18.blinkInterval=qb
  SetLightColor L58,green,2:L58.blinkInterval=qb
  SetLightColor L59,green,2:L59.blinkInterval=qb
  SetLightColor L60,green,2:L60.blinkInterval=qb
  vpmtimer.addtimer pwait, "paper2'"
End Sub

Sub paper2() 'lily
  SetLightColor L18,green,0:L18.blinkInterval=sb
  SetLightColor L58,green,0:L58.blinkInterval=sb
  SetLightColor L59,green,0:L59.blinkInterval=sb
  SetLightColor L60,green,0:L60.blinkInterval=sb

  SetLightColor L20,orange,2:L20.blinkInterval=qb
  SetLightColor L40,orange,2:L40.blinkInterval=qb
  SetLightColor L41,orange,2:L41.blinkInterval=qb
  SetLightColor L42,orange,2:L42.blinkInterval=qb
  SetLightColor L43,orange,2:L43.blinkInterval=qb
  vpmtimer.addtimer pwait, "paper3'"
End Sub

Sub paper3() 'spot
  SetLightColor L20,orange,0:L20.blinkInterval=sb
  SetLightColor L40,orange,0:L40.blinkInterval=sb
  SetLightColor L41,orange,0:L41.blinkInterval=sb
  SetLightColor L42,orange,0:L42.blinkInterval=sb
  SetLightColor L43,orange,0:L43.blinkInterval=sb

  SetLightColor L21,red,2:L21.blinkInterval=qb
  SetLightColor L98,red,2:L98.blinkInterval=qb
  SetLightColor L101,red,2:L101.blinkInterval=qb
  FlashForMs flasherlight1, pwait, 250, 0
  FlashForMs flasherlight2, pwait, 250, 0
  FlashForMs flasherlight3, pwait, 250, 0
  FlashForMs flasherlight4, pwait, 250, 0

  vpmtimer.addtimer pwait, "paper4'"
End Sub

Sub paper4() 'marilyn
  SetLightColor L21,red,0:L21.blinkInterval=sb
  SetLightColor L98,red,0:L98.blinkInterval=sb
  SetLightColor L101,red,0:L101.blinkInterval=sb

  SetLightColor L13,yellow,2:L13.blinkInterval=qb
  SetLightColor L102,yellow,2:L102.blinkInterval=qb
  SetLightColor L30,red,2:L30.blinkInterval=qb
  vpmtimer.addtimer pwait, "paper5'"
End Sub

Sub paper5() ' eddie
  SetLightColor L13,yellow,0:L13.blinkInterval=sb
  SetLightColor L102,yellow,0:L102.blinkInterval=sb
  SetLightColor L30,red,0:L30.blinkInterval=sb

  SetLightColor L12,red,2:L12.blinkInterval=qb
  SetLightColor L14,red,2:L14.blinkInterval=qb
  SetLightColor L30,red,2:L30.blinkInterval=qb
  SetLightColor L46,red,2:L46.blinkInterval=qb
  SetLightColor L72,red,2:L72.blinkInterval=qb
  SetLightColor L47,white,2:L47.blinkInterval=qb
  SetLightColor L51,white,2:L51.blinkInterval=qb
  SetLightColor L67,white,2:L67.blinkInterval=qb
  SetLightColor L73,white,2:L73.blinkInterval=qb
  vpmtimer.addtimer pwait, "paper6'"
End Sub

Sub paper6() ' raven
  SetLightColor L12,red,0:L12.blinkInterval=sb
  SetLightColor L14,red,0:L14.blinkInterval=sb
  SetLightColor L30,red,0:L30.blinkInterval=sb
  SetLightColor L46,red,0:L46.blinkInterval=sb
  SetLightColor L72,red,0:L72.blinkInterval=sb
  SetLightColor L47,white,0:L47.blinkInterval=sb
  SetLightColor L51,white,0:L51.blinkInterval=sb
  SetLightColor L67,white,0:L67.blinkInterval=sb
  SetLightColor L73,white,0:L73.blinkInterval=sb

  SetLightColor L19,blue,2:L19.blinkInterval=qb
  SetLightColor L95,blue,2:L95.blinkInterval=qb
  SetLightColor L96,blue,2:L96.blinkInterval=qb
  SetLightColor L97,blue,2:L97.blinkInterval=qb
  SetLightColor L80,blue,2:L80.blinkInterval=qb
  vpmtimer.addtimer pwait, "paper7'"
End Sub

Sub paper7 ' Grandpa
  SetLightColor L19,blue,0:L19.blinkInterval=sb
  SetLightColor L95,blue,0:L95.blinkInterval=sb
  SetLightColor L96,blue,0:L96.blinkInterval=sb
  SetLightColor L97,blue,0:L97.blinkInterval=sb
  SetLightColor L80,blue,0:L80.blinkInterval=sb

  SetLightColor L22,purple,2:L22.blinkInterval=qb
  SetLightColor L78,purple,2:L78.blinkInterval=qb
  SetLightColor L79,purple,2:L79.blinkInterval=qb
  SetLightColor L81,purple,2:L81.blinkInterval=qb
  SetLightColor L82,purple,2:L82.blinkInterval=qb
  SetLightColor L104,green,2:L104.blinkInterval=qb
  vpmtimer.addtimer pwait, "paper8'"
End Sub

Sub paper8 ' 4 shots
  SetLightColor L22,purple,0:L22.blinkInterval=sb
  SetLightColor L78,purple,0:L78.blinkInterval=sb
  SetLightColor L79,purple,0:L79.blinkInterval=sb
  SetLightColor L81,purple,0:L81.blinkInterval=sb
  SetLightColor L82,purple,0:L82.blinkInterval=sb
  SetLightColor L104,green,0:L104.blinkInterval=sb

  SetLightColor L47,white,2:L47.blinkInterval=qb
  SetLightColor L51,white,2:L51.blinkInterval=qb
  SetLightColor L67,white,2:L67.blinkInterval=qb
  SetLightColor L73,white,2:L73.blinkInterval=qb
  vpmtimer.addtimer pwait, "endpaper '"
End Sub

Sub EndPaper
  RestoreScreen
  InitLights(CurrentPlayer)
  SetLightColor L58,green,2:lStates(CurrentPlayer,58)=2     ' Herman    Done  Ball Save
  SetLightColor L59,green,0:lStates(CurrentPlayer,59)=0
  SetLightColor L60,green,0:lStates(CurrentPlayer,60)=0
  SetLightColor L56,white,0:lStates(CurrentPlayer,56)=0

  SetLightColor L13,yellow,2:lStates(CurrentPlayer,13)=2    ' Marilyn Done  Light Super Jackpot
  SetLightColor L102,yellow,2:lStates(CurrentPlayer,102)=2

  SetLightColor L12,red,2:lStates(CurrentPlayer,12)=2     ' Eddie   Done  Double Jackpots
  SetLightColor L14,red,2:lStates(CurrentPlayer,14)=2

  SetLightColor L40,orange,2:lStates(CurrentPlayer,40)=2    ' Lily    Done  Scores Extra
  SetLightColor L41,orange,0:lStates(CurrentPlayer,41)=0
  SetLightColor L42,orange,0:lStates(CurrentPlayer,42)=0
  SetLightColor L43,orange,0:lStates(CurrentPlayer,43)=0

  SetLightColor L106,red,2:lStates(CurrentPlayer,106)=2   ' Spot    TODO    Starts Boost
  SetLightColor L107,red,0:lStates(CurrentPlayer,107)=0
  SetLightColor L108,red,0:lStates(CurrentPlayer,108)=0
  SetLightColor L109,red,0:lStates(CurrentPlayer,109)=0
  SetLightColor L98,red,2:lStates(CurrentPlayer,98)=2     ' Shot Spot
  SetLightColor L101,red,2:lStates(CurrentPlayer,101)=2

  SetLightColor L95,blue,2:lStates(CurrentPlayer,95)=2    ' Raven   Done  Light Kitty
  SetLightColor L96,blue,0:lStates(CurrentPlayer,96)=0
  SetLightColor L97,blue,0:lStates(CurrentPlayer,97)=0

  SetLightColor L78,purple,2:lStates(CurrentPlayer,78)=2    ' Grandpa   Done   AddTime
  SetLightColor L79,purple,0:lStates(CurrentPlayer,79)=0
  SetLightColor L81,purple,0:lStates(CurrentPlayer,81)=0
  SetLightColor L82,purple,0:lStates(CurrentPlayer,82)=0


  L104.state=2:lStates(CurrentPlayer,104)=2   'Add Time ' TODO ADDED for DEBUG
  FlashThem()
  AddScore 450000
  AddMultiball 4
  vpmtimer.addtimer 5000, "StartMMadnessDisplay '"
End Sub

Dim mMadnessTimer:mMadnessTimer=0

Sub StartMadMarilyn  'testm
  Dim p
  Dim eb:eb=sb:If Eddie2x Then eb=qb
  D "StartMadMarilyn"
  MadAreas(Marilyn)=1
  MarilynMode=True:SubLevels(CurrentPlayer,Madness)=1
  StopLilyL:StopGrandpaL:StopRavenL:StopSpotL:StopEddieL:StopHermanL
'Buff for MMadness
    SpecialVideoClip 3500,"","","","","videosjp","Video-0x0047 - marilyn is lit.mp4"  ' is lit video
    ActiveJackpot(Marilyn)=True
    Jackpots=Jackpots+1
    L30.blinkinterval=260-(Jackpots*20):L30.state=2
    p=CalcPoints(Marilyn, 50000):AddScore p

  SetLightColor L13,yellow,2:L13.blinkInterval=qb
  SetLightColor L102,yellow,2:L102.blinkInterval=qb

  SetLightColor L47,yellow,2:L47.blinkInterval=eb
  SetLightColor L51,yellow,2:L51.blinkInterval=eb
  SetLightColor L67,yellow,2:L67.blinkInterval=eb
  SetLightColor L73,yellow,2:L73.blinkInterval=eb
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
  mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
  AwardKitty()
End Sub

Sub StartMadRaven
  D "StartMadRaven"
  MadAreas(Raven)=1
  Dim eb:eb=sb:If Eddie2x Then eb=qb
  RavenMode=True:SubLevels(CurrentPlayer,Madness)=1
  StopLilyL:StopGrandpaL:StopMarilynL:StopSpotL:StopEddieL:StopHermanL
'Buff for MMadness
    ScoreKitty()
  SetLightColor L47,blue,2:L47.blinkInterval=eb
  SetLightColor L51,blue,2:L51.blinkInterval=eb
  SetLightColor L67,blue,2:L67.blinkInterval=eb
  SetLightColor L73,blue,2:L73.blinkInterval=eb
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
  mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
  AwardKitty()
  ScorbitBuildGameModes()
End Sub

Sub StartMadHerman
  D "StartMadHerman"
  MadAreas(Herman)=1
  Dim eb:eb=sb:If Eddie2x Then eb=qb
  HermanMode=True:SubLevels(CurrentPlayer,Madness)=1
  StopLilyL:StopGrandpaL:StopRavenL:StopSpotL:StopEddieL:StopMarilynL
'Buff for MMadness
    EnableBallSaver 20
  SetLightColor L47,green,2:L47.blinkInterval=eb  'Shots
  SetLightColor L51,green,2:L51.blinkInterval=eb
  SetLightColor L67,green,2:L67.blinkInterval=eb
  SetLightColor L73,green,2:L73.blinkInterval=eb
  SetLightColor L56,white,2:L56.blinkInterval=sb
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
  mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
  AwardKitty()
  ScorbitBuildGameModes()
End Sub

Sub StartMadLily
  D "StartMadLily"
  MadAreas(Lily)=1
  Dim eb:eb=sb:If Eddie2x Then eb=qb
  LilyMode=True:SubLevels(CurrentPlayer,Madness)=1
  StopMarilynL:StopGrandpaL:StopRavenL:StopSpotL:StopEddieL:StopHermanL
'Buff for MMadness
'Everything Scores More
  SetLightColor L47,orange,2:L47.blinkInterval=eb
  SetLightColor L51,orange,2:L51.blinkInterval=eb
  SetLightColor L67,orange,2:L67.blinkInterval=eb
  SetLightColor L73,orange,2:L73.blinkInterval=eb
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
  mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
  AwardKitty()
End Sub

Sub StartMadSpot
  D "StartMadSpot"
  MadAreas(Spot)=1
  Dim eb:eb=sb:If Eddie2x Then eb=qb
  SpotMode=True:SubLevels(CurrentPlayer,Madness)=1
  StopLilyL:StopGrandpaL:StopRavenL:StopMarilynL:StopEddieL:StopHermanL
'Buff for MMadness
    Boost(CurrentPlayer,herman)=1
    Boost(CurrentPlayer,Grandpa)=1
    Boost(CurrentPlayer,Lily)=1
    Boost(CurrentPlayer,Raven)=1
    Boost(CurrentPlayer,Spot)=1
    PaintModes()
  SetLightColor L47,red,2:L47.blinkInterval=eb
  SetLightColor L51,red,2:L51.blinkInterval=eb
  SetLightColor L67,red,2:L67.blinkInterval=eb
  SetLightColor L73,red,2:L73.blinkInterval=eb
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
  mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
  AwardKitty()
  ScorbitBuildGameModes()
End Sub

Dim Eddie2x:Eddie2x=False

Sub StartMadEddie
  D "StartMadEddie"
  MadAreas(Eddie)=1
  EddieMode=True:SubLevels(CurrentPlayer,Madness)=1
  StopLilyL:StopGrandpaL:StopRavenL:StopSpotL:StopMarilynL:StopHermanL
' double jackpots
    Eddie2x=True
' start off qb, then go to sb then go out - getting to him them 2x times
  SetLightColor L47,red,2:L47.blinkInterval=qb
  SetLightColor L51,red,2:L51.blinkInterval=qb
  SetLightColor L67,red,2:L67.blinkInterval=qb
  SetLightColor L73,red,2:L73.blinkInterval=qb
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
  mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
  AwardKitty()
  ScorbitBuildGameModes()
End Sub

Sub StartMadGrandpa
  D "StartMadGrandpa"
  MadAreas(Grandpa)=1
  Dim eb:eb=sb:If Eddie2x Then eb=qb
  GrandpaMode=True:SubLevels(CurrentPlayer,Madness)=1
  StopLilyL:StopMarilynL:StopRavenL:StopSpotL:StopEddieL:StopHermanL
'Buff for MMadness
  SetLightColor L104,green,2  'Add Time Light
  SetLightColor L47,purple,2:L47.blinkInterval=eb
  SetLightColor L51,purple,2:L51.blinkInterval=eb
  SetLightColor L67,purple,2:L67.blinkInterval=eb
  SetLightColor L73,purple,2:L73.blinkInterval=eb
  Shots(1)=1:Shots(2)=1:Shots(3)=1:Shots(4)=1
  mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
  AwardKitty()
  ScorbitBuildGameModes()
End Sub

Sub StopShots
  D "StopShots"
  mMadnessTimer=0
  SetLightColor L47,white,0:L47.blinkInterval=sb
  SetLightColor L51,white,0:L51.blinkInterval=sb
  SetLightColor L67,white,0:L67.blinkInterval=sb
  SetLightColor L73,white,0:L73.blinkInterval=sb

  SetLightColor L104, green, 0  'add time

  If MarilynMode Then StopMadMarilynMode
  If LilyMode Then StopMadLilyMode
  If HermanMode Then StopMadHermanMode
  If RavenMode Then StopMadRavenMode
  If EddieMode Then StopMadEddieMode
  If SpotMode Then StopMadSpotMode
  If GrandpaMode Then StopMadGrandpaMode
End Sub

Sub StartMMadnessDisplay
  D "StartMMadnessDisplay"
  pStartBackLoop "videoothers","mmadness.png"
  pSetBackFrame "ball" & CSTR(Balls) & ".png"   'show the dmd frame first
  CurPage=2
  PuPlayer.LabelShowPage pBackglass,2,0,""
  TvText "\r\rMUNSTER MADNESS\r" & CenterText(30,"LEVEL " & CStr(Modes(CurrentPlayer,Madness))) & "\r" & CenterText(26,"COMPLETE") & "\r" & LPad(FormatNumber(450000,0),20," "),"","",""

  SetLightColor L25,orange,0:L25.blinkInterval=sb 'flashing ball save

  SetLightColor L46, red   ,2:lStates(CurrentPlayer,46)=2  ' Eddie
  SetLightColor L72, red   ,2:lStates(CurrentPlayer,72)=2
  SetLightColor L58, green ,2:lStates(CurrentPlayer,58)=2  ' Herman
  SetLightColor L40, orange,2:lStates(CurrentPlayer,40)=2  ' Lily
  SetLightColor L102,yellow,2:lStates(CurrentPlayer,102)=2 ' Marilyn
  SetLightColor L95, purple,2:lStates(CurrentPlayer,95)=2  ' Raven
  SetLightColor L17, white, 2:lStates(CurrentPlayer,17)=2  ' MMadness

  vpmtimer.addtimer 4000, "StartMadMarilyn '"   'for debug
End Sub

Sub StopMMadnessMode()  'testm
  Dim b
  MMadnessMode=False
  ScreenQuickTimer.Enabled=False
  Eddie2x=False
  SetLightColor L17, white, 0:lStates(CurrentPlayer,17)=0  ' MMadness
  StopShots()
  InitLights(CurrentPlayer)
  lStates(CurrentPlayer,58) = 2:lStates(CurrentPlayer,59) = 0:lStates(CurrentPlayer,60) = 0 ' Ignore the initial easy play Lights
  SetLightColor L58,green,2:SetLightColor L59,green,0:SetLightColor L60,green,0
  If ModeTotal(CurrentPlayer,Madness) > 0 Then
    vpmtimer.addtimer 3000, "resetbackglass '"
    TvText "", CenterText(20,"MUNSTER MADNESS\r") & CenterText(20,"TOTAL\r") & CenterText(20,FormatNumber(ModeTotal(CurrentPlayer,Madness),0)),"",""
    RestoreScreen
  Else
    Resetbackglass
  End If

  PuPlayer.LabelSet pBackglass,"rtimertxt","",1,"{'mt':2,'color':" & CStr(fWhite) & ", 'xpos': 75, 'size': 4 }"
  PuPlayer.LabelSet pBackglass,"rtimer",   "",1,"{'mt':2,'color':" & CStr(fWhite) & ", 'xpos': 75, 'size': 8, 'fname':" & jackpotfont & "}"
  PuPlayer.LabelSet pBackglass,"TLine0","",1,"{'mt':2,'color': 16777215, 'fname':" & munsterfont & ", 'size': 6 }"
  PuPlayer.LabelSet pBackglass,"TLine1","",1,"{'mt':2,'color': 16777215, 'fname':" & jnumberfont & ", 'size': 10}"
  PuPlayer.LabelSet pBackglass,"TLine2","",1,"{'mt':2,'color': 16777215, 'fname':" & typefont & ",    'size': 6 }"
' move to next level
  ScorbitBuildGameModes()
End Sub
'
' =======================================
'         Zaps
' =======================================
  Sub ShowZapShots()
    If Not HermanMode and Not GrandpaMode and Not SpotMode and Not RavenMode and Not LilyMode and Not EddieMode and Not MarilynMode then
      If ZapShots(1)=1 and L47.state=0 Then
        SetLightColor L47,lightblue,2  'shots
      End If
      If ZapShots(2)=1 and L51.state=0 Then
        SetLightColor L51,lightblue,2
      End If
      If ZapShots(3)=1 and L67.state=0 Then
        SetLightColor L67,lightblue,2
      End If
      If ZapShots(4)=1 and L73.state=0 Then
        SetLightColor L73,lightblue,2
      End If
    End If
  End Sub

  Dim ZapsCnt
  Sub ScoreZap
    ZapTimer.Enabled=False
    ZapTimer_Timer
    If ZapsCnt < 5 Then ZapsCnt=ZapsCnt+1
    PuPlayer.LabelSet pBackglass,"Zaps",CStr(ZapsCnt),1,""
    If ZapsCnt = 5 Then PUP_audioevents "Sound-0x0719 - zap.mp3"
  End Sub

  Sub AwardZapJackpot
    D "AwardZapJackpot: ScoresZap Count=" & CStr(ModesHeld(CurrentPlayer,Zap)+1)
    Dim tDelay
    ModesHeld(CurrentPlayer,Zap)=ModesHeld(CurrentPlayer,Zap)+1
    ModeTotal(CurrentPlayer,Zap)=ModeTotal(CurrentPlayer,Zap)+1  ' For High Score (Zaps)
    tDelay=100
    If ModesHeld(CurrentPlayer,Zap) mod 4 = 0 Then
      If Not ActiveJackpot(Zap) Then
        DOF 132, DOFPulse
        SpecialVideoClip 3500,"","","","","videosjp","Video-0x000D - zap is lit.mp4"
        AwardKitty()  ' Not sure this is a rule
        ActiveJackpot(Zap)=True
        Pup_audiojp "Sound-0x0645 - zap jp lit.mp3"
        D "Light JackPot"
        If SubLevels(CurrentPlayer,Zap) < 3 Then SubLevels(CurrentPlayer,Zap)=SubLevels(CurrentPlayer,Zap)+1
        tDelay=3600
      End If
      Jackpots=Jackpots+1
      L30.blinkinterval=260-(Jackpots*20):L30.state=2
      vpmtimer.addtimer tDelay, "ShowJackpot Zap, " & Cstr(100000) & ", " & CStr(SubLevels(CurrentPlayer,Zap)+1) & " '"
      p=CalcPoints(Zap, 100000):AddScore p
    End If
  End Sub

  Sub StartZapTimer  ' Hit the magnaflipper for zap awards   zzzzzzzzzzzzz
    I "StartZapTimer"
    If ZapsCnt < 5 and Not ZapTimer.enabled Then
      ZapTimer.interval=3000
      ZapTimer.enabled=True
      Select Case RndNum(1,20)
        Case 1
          PuP_audioevents "Sound-0x07A0 - getazap.mp3"
        Case 2
          PuP_audioevents "Sound-0x07C8 - hit zap button.mp3"
        Case 3
          PUP_audioevents "Sound-0x0637 - hit zap.mp3"
      End Select
      FlashForMs FlasherflashZap, 4000, 250, 1
    End If
  End Sub

  Sub ZapTimer_Timer
    I "Stop ZapTimer"
    ZapTimer.Enabled=False
    FlashForMs FlasherflashZap, 100, 50, 0
  End Sub
'
' =======================================
'         Kitty
' =======================================
  Sub AwardKitty
    Kitty(CurrentPlayer)=Kitty(CurrentPlayer)+1
    If Kitty(CurrentPlayer) > 0 Then
      SetLightColor L80,green,2  'Kitty
      lStates(CurrentPlayer,80)=2
    End If
  End Sub

'
' =======================================
'         Switches
' =======================================



  Sub sw31_Timer
    me.TimerEnabled = False
  End Sub

  Sub sw31_Hit
    Dim p
    If me.TimerEnabled then Exit Sub
    D "Lily"
    me.TimerInterval = 500
        me.TimerEnabled = True
    ResetSkillShot
    PlaySoundAt "fx_sensor", ActiveBall
    If Tilted Then Exit Sub

    p=CalcPoints(Lily, 5000):AddScore p
    PUP_audiocallouts

    If MMadnessMode Then
      LilyCnt=LilyTime
      If L40.state = 2 Then
        L40.state = 1: L41.blinkinterval=250:L41.state = 2
      Elseif L41.state = 2 Then
        L41.state = 1: L42.blinkinterval=250:L42.state = 2
      Elseif L42.state = 2 Then
        L42.state = 1: L43.blinkinterval=250:L43.state = 2
        PUP_audionoise
      Elseif L43.state = 2 Then
        L43.state = 1
        LilyTimer.Enabled=False
        StartMadLily()
      End If
      Exit Sub
    End If

    if not LilyMode Then
      LilyCnt=LilyTime
      If L40.state = 2 Then
        L40.state = 1: L41.blinkinterval=250:L41.state = 2
        SpecialVideoClip 2500,"","","","","videolily",""
        BigTimedText 2000,"","\rSPELL\rL-I-L-Y",""
      Elseif L41.state = 2 Then
        L41.state = 1: L42.blinkinterval=250:L42.state = 2
        SpecialVideoClip 2500,"","","","","videolily",""
        BigTimedText 2000,"","\rComplete","\r    l-i-L-y"
      Elseif L42.state = 2 Then
        L42.state = 1: L43.blinkinterval=250:L43.state = 2
        SpecialVideoClip 2500,"","","","","videolily",""
        BigTimedText 2000,"","","l-i-l-Y"
        PUP_audionoise
      Elseif L43.state = 2 Then
        L43.state = 1
        LilyTimer.Enabled=False
        AwardLily()
      End If
      lStates(CurrentPlayer,40)=L40.state
      lStates(CurrentPlayer,41)=L41.state
      lStates(CurrentPlayer,42)=L42.state
      lStates(CurrentPlayer,43)=L43.state
    End If
    cLilyMode
  End Sub

  Sub sw37_Timer
    sw37.TimerEnabled = False
  End Sub

  Sub sw37_Hit
    Dim p
    If Tilted Then Exit Sub
    If sw37.TimerEnabled then Exit Sub
    D "purple 1"
    DOF 133, DOFPulse
    sw37.TimerInterval = 1000
        sw37.TimerEnabled = True
    StartZapTimer
    PUP_audionoiseshort

    If MMadnessMode Then
      p=CalcPoints(Grandpa, 5000):AddScore p
      If Not MarilynMode and Not EddieMode and Not RavenMode and Not GrandpaMode and Not SpotMode and Not HermanMode and Not LilyMode Then
        If lStates(CurrentPlayer,78)<>2 Then
          lStates(CurrentPlayer,78)=2:L78.state=2
          If lStates(CurrentPlayer,78)=2 and lStates(CurrentPlayer,79)=2 and lStates(CurrentPlayer,81)=2 and lStates(CurrentPlayer,82)=2 Then
            StartMadGrandpa()
          End If
        End If
      End If
      Exit Sub
    End If

    If GrandpaMode Then ' Light one of the shots purple
      D "Turn Shot Purple A"
      p=CalcPoints(Grandpa, 5000):AddScore p
      GrandpaLightShot
      lStates(CurrentPlayer,78) = 1:L78.state=1
      If lStates(CurrentPlayer,78) = 1 Then
          If lStates(CurrentPlayer,79)=1 and lStates(CurrentPlayer,81)=1 and lStates(CurrentPlayer,82)=1 Then
            lStates(CurrentPlayer,104) = 2:L104.state=2
            lStates(CurrentPlayer,78) = 2:L78.state=2
            lStates(CurrentPlayer,79) = 2:L79.state=2
            lStates(CurrentPlayer,81) = 2:L81.state=2
            lStates(CurrentPlayer,82) = 2:L82.state=2
          End If
      End If
'   if all are 1 then relight add timer
    End If
    If Not GrandpaMode and Not RavenMode and Not HermanMode and Not SpotMode Then
      ' If blinking then make solid
      ' if all are solid then light up laboratory
      p=CalcPoints(Grandpa, 500):AddScore p
      If L22.state=0 Then
        If lStates(CurrentPlayer,78) = 2 Then
          If lStates(CurrentPlayer,79)=2 and lStates(CurrentPlayer,81)=2 and lStates(CurrentPlayer,82)=2 Then
            ' Complete Grandpa Targets    test3f
            If Not SkillShotTime.Enabled Then   ' dont overwrite the skillshot screen on an early hit
              TvText "","COMPLETE\rGRANDPA\rTARGETS","",""
            End If
          End If
          L78.state=1:lStates(CurrentPlayer,78)=L78.state
        ElseIf L78.state=1 and L79.state=1 and L81.state=1 and L82.state=1 Then  'After all 4 are hit, the next hit Scores Grandpa
          L78.state=1:lStates(CurrentPlayer,78)=L78.state
          cGrandPa
        End If
      End If
    Else
      p=CalcPoints(Grandpa, 500):AddScore p
    End If
    If RavenMode and RndNum(1,10) < 2 Then
      PUP_audioevents "Sound-0x0885 - shoot spinner.mp3"
    End If
    cLilyMode
  End Sub

  Sub sw38_Timer
    sw38.TimerEnabled = False
  End Sub

  Sub sw38_Hit
    Dim p
    If Tilted Then Exit Sub
    If sw38.TimerEnabled then Exit Sub
    D "purple 2"
    DOF 133, DOFPulse
    sw38.TimerInterval = 1000
        sw38.TimerEnabled = True
    StartZapTimer
    PUP_audionoiseshort

    If MMadnessMode Then
      p=CalcPoints(Grandpa, 5000):AddScore p
      If Not MarilynMode and Not EddieMode and Not RavenMode and Not GrandpaMode and Not SpotMode and Not HermanMode and Not LilyMode Then
        If lStates(CurrentPlayer,79)<>2 Then
          lStates(CurrentPlayer,79)=2:L79.state=2
          If lStates(CurrentPlayer,78)=2 and lStates(CurrentPlayer,79)=2 and lStates(CurrentPlayer,81)=2 and lStates(CurrentPlayer,82)=2 Then
            StartMadGrandpa()
          End If
        End If
      End If
      Exit Sub
    End If

    If GrandpaMode Then ' Light one of the shots purple
      D "Turn Shot Purple B"
      p=CalcPoints(Grandpa, 5000):AddScore p
      GrandpaLightShot
      lStates(CurrentPlayer,79) = 1:L79.state=1
      If lStates(CurrentPlayer,79) = 1 Then
          If lStates(CurrentPlayer,78)=1 and lStates(CurrentPlayer,81)=1 and lStates(CurrentPlayer,82)=1 Then
            lStates(CurrentPlayer,104) = 2:L104.state=2
            lStates(CurrentPlayer,78) = 2:L78.state=2
            lStates(CurrentPlayer,79) = 2:L79.state=2
            lStates(CurrentPlayer,81) = 2:L81.state=2
            lStates(CurrentPlayer,82) = 2:L82.state=2
          End If
      End If
    End If
    If Not GrandpaMode and Not RavenMode and Not HermanMode and Not SpotMode Then
      p=CalcPoints(Grandpa, 500):AddScore p
      If L22.state=0 Then
        If lStates(CurrentPlayer,79) = 2 Then
          If lStates(CurrentPlayer,78)=2 and lStates(CurrentPlayer,81)=2 and lStates(CurrentPlayer,82)=2 Then
            ' Complete Grandpa Targets
            If Not SkillShotTime.Enabled Then   ' dont overwrite the skillshot screen on an early hit
              TvText "","COMPLETE\rGRANDPA\rTARGETS","",""
            End If
          End If
          L79.state=1:lStates(CurrentPlayer,79)=1
        ElseIf L78.state=1 and L79.state=1 and L81.state=1 and L82.state=1 Then  'After all 4 are hit, the next hit Scores Grandpa
          L79.state=1:lStates(CurrentPlayer,79)=1
          cGrandPa
        End If
      End If
    Else
      p=CalcPoints(Grandpa, 500):AddScore p
    End If
    cLilyMode
  End Sub

  Sub sw40_Timer
    sw40.TimerEnabled = False
  End Sub

  Sub sw40_Hit
    Dim p
    If Tilted Then Exit Sub
    If sw40.TimerEnabled then Exit Sub
    D "purple 3"
    sw40.TimerInterval = 1000
        sw40.TimerEnabled = True
    StartZapTimer
    PlaySoundAt SoundFXDOF("fx_sensor",120,DOFPulse,DOFTargets), ActiveBall

    If MMadnessMode Then
      p=CalcPoints(Grandpa, 5000):AddScore p
      If Not MarilynMode and Not EddieMode and Not RavenMode and Not GrandpaMode and Not SpotMode and Not HermanMode and Not LilyMode Then
        If lStates(CurrentPlayer,81)<>2 Then
          lStates(CurrentPlayer,81)=2:L81.state=2
          If lStates(CurrentPlayer,78)=2 and lStates(CurrentPlayer,79)=2 and lStates(CurrentPlayer,81)=2 and lStates(CurrentPlayer,82)=2 Then
            StartMadGrandpa()
          End If
        End If
      End If
      Exit Sub
    End If

    If GrandpaMode Then
      D "Turn Shot Purple C"
      GrandpaLightShot
      lStates(CurrentPlayer,81) = 1:L81.state=1
      If lStates(CurrentPlayer,81) = 1 Then
          If lStates(CurrentPlayer,78)=1 and lStates(CurrentPlayer,79)=1 and lStates(CurrentPlayer,82)=1 Then
            lStates(CurrentPlayer,104) = 2:L104.state=2
            lStates(CurrentPlayer,78) = 2:L78.state=2
            lStates(CurrentPlayer,79) = 2:L79.state=2
            lStates(CurrentPlayer,81) = 2:L81.state=2
            lStates(CurrentPlayer,82) = 2:L82.state=2
          End If
      End If
      p=CalcPoints(Grandpa, 5000):AddScore p
    End If
    If Not GrandpaMode and Not RavenMode and Not HermanMode and Not SpotMode Then
      p=CalcPoints(Grandpa, 500):AddScore p
      If L22.state=0 Then
        If lStates(CurrentPlayer,81) = 2 Then
          ' If others are blinking then its the first one so show some helptime
          If lStates(CurrentPlayer,78)=2 and lStates(CurrentPlayer,79)=2 and lStates(CurrentPlayer,82)=2 Then
            ' Complete Grandpa Targets
            If Not SkillShotTime.Enabled Then   ' dont overwrite the skillshot screen on an early hit
              TvText "","COMPLETE\rGRANDPA\rTARGETS","",""
            End If
          End If
          L81.state=1:lStates(CurrentPlayer,81)=1
        ElseIf L78.state=1 and L79.state=1 and L81.state=1 and L82.state=1 Then  'After all 4 are hit, the next hit Scores Grandpa
          L81.state=1:lStates(CurrentPlayer,81)=1
          cGrandPa
        End If
      End If
    Else
      p=CalcPoints(Grandpa, 500):AddScore p
    End If
    cLilyMode
  End Sub

  Sub sw41_Timer
    sw41.TimerEnabled = False
  End Sub

  Sub sw41_Hit
    Dim p
    If Tilted Then Exit Sub
    If sw41.TimerEnabled then Exit Sub
    D "purple 4"
    sw41.TimerInterval = 1000
        sw41.TimerEnabled = True
    StartZapTimer
    PlaySoundAt SoundFXDOF("fx_sensor",120,DOFPulse,DOFTargets), ActiveBall

    If MMadnessMode Then
      p=CalcPoints(Grandpa, 5000):AddScore p
      If Not MarilynMode and Not EddieMode and Not RavenMode and Not GrandpaMode and Not SpotMode and Not HermanMode and Not LilyMode Then
        If lStates(CurrentPlayer,82)<>2 Then
          lStates(CurrentPlayer,82)=2:L82.state=2
          If lStates(CurrentPlayer,78)=2 and lStates(CurrentPlayer,79)=2 and lStates(CurrentPlayer,81)=2 and lStates(CurrentPlayer,82)=2 Then
            StartMadGrandpa()
          End If
        End If
      End If
      Exit Sub
    End If

    If GrandpaMode Then ' Light one of the shots purple
      D "Turn Shot Purple D"
      GrandpaLightShot
      lStates(CurrentPlayer,82) = 1:L82.state=1
      If lStates(CurrentPlayer,82) = 1 Then
          If lStates(CurrentPlayer,78)=1 and lStates(CurrentPlayer,81)=1 and lStates(CurrentPlayer,79)=1 Then
            lStates(CurrentPlayer,104) = 2:L104.state=2
            lStates(CurrentPlayer,78) = 2:L78.state=2
            lStates(CurrentPlayer,79) = 2:L79.state=2
            lStates(CurrentPlayer,81) = 2:L81.state=2
            lStates(CurrentPlayer,82) = 2:L82.state=2
          End If
      End If
      p=CalcPoints(Grandpa, 5000):AddScore p
    End If
    If Not GrandpaMode and Not RavenMode and Not HermanMode and Not SpotMode Then   ' BUG FIX
      p=CalcPoints(Grandpa, 500):AddScore p
      If L22.state=0 Then
        If lStates(CurrentPlayer,82) = 2 Then
          If lStates(CurrentPlayer,78)=2 and lStates(CurrentPlayer,79)=2 and lStates(CurrentPlayer,81)=2 Then
            ' Complete Grandpa Targets
            If Not SkillShotTime.Enabled Then   ' dont overwrite the skillshot screen on an early hit
              TvText "","COMPLETE\rGRANDPA\rTARGETS","",""
            End If
          End If
          L82.state=1:lStates(CurrentPlayer,82)=1
        ElseIf L79.state=1 and L79.state=1 and L81.state=1 and L82.state=1 Then
          L82.state=1:lStates(CurrentPlayer,82)=1
          cGrandPa
        End If
      End If
    Else
      p=CalcPoints(Grandpa, 500):AddScore p
    End If
    cLilyMode
  End Sub

'LILY letters flash quick as time runs out .. once time runs out you lose a letter
Dim LilyCnt:LilyCnt = 0
Dim DragCnt:DragCnt = 0
Dim HermanHurryCnt:HermanHurryCnt=0
'
' =================================
'        Timers
' =================================
Sub StartTimers
  If Not LilyMode Then
    If LilyCnt = 0 Then
      LilyCnt = LilyTime
      LilyTimer.Interval = 1000
      LilyTimer.Enabled = True
    End If
  End If
  If Not DragTimer.Enabled Then
    DragTimer.Interval = 1000
    DragTimer.Enabled = True
  End If
End Sub

Sub LilyTimer_Timer   'flash the lily lights
  LilyCnt=LilyCnt-1
  If LilyCnt = 10 Then
    If L43.state = 2 Then
      L43.blinkinterval=qb
    Elseif L42.state = 2 Then
      L42.blinkinterval=qb
    Elseif L41.state = 2 Then
      L41.blinkinterval=qb
    End If
  End If
  If LilyCnt < 0 Then
    LilyCnt = LilyTime
    If L43.state = 2 Then
      L42.blinkinterval=sb:L42.state=2:L43.state=0
    Elseif L42.state = 2 Then
      L41.blinkinterval=sb:L41.state=2:L42.state=0
    Elseif L41.state = 2 Then
      L41.blinkinterval=sb:L40.state=2:L41.state=0
    End If
    lStates(CurrentPlayer,40)=L40.state
    lStates(CurrentPlayer,41)=L41.state
    lStates(CurrentPlayer,42)=L42.state
    lStates(CurrentPlayer,43)=L43.state
  End If
End Sub

Sub ScreenTimer_Timer
  If mHMagnet.MagnetOn Then
    I "magnet is on - SL=" & CStr(SubLevels(CurrentPlayer,Herman))
  Else
    I "magnet is off- SL=" & CStr(SubLevels(CurrentPlayer,Herman))
  End If
' If Captured Then
'   I "Is Captured"
' Else
'   I "Not Captured"
' End If
  If MMadnessMode Then
    If mMadnessTimer > 0 Then
      PuPlayer.LabelSet pBackglass,"rtimertxt","SHOOT JACKPOTS",1,"{'mt':2,'color':" & CStr(fWhite) & ", 'xpos': 70, 'size': 3 }"
      PuPlayer.LabelSet pBackglass,"rtimer",CStr(mMadnessTimer),1,"{'mt':2,'color':" & CStr(fWhite) & ", 'xpos': 78, 'size': 8, 'fname':" & jackpotfont & "}"
      mMadnessTimer=mMadnessTimer-1
    Else
      If mMadnessTimer=0 Then
        StopShots()
        mMadnessTimer=mMadnessTimer-1
        PuPlayer.LabelSet pBackglass,"rtimertxt","",1,"{'mt':2,'color':" & CStr(fWhite) & ", 'xpos': 75, 'size': 4 }"
        PuPlayer.LabelSet pBackglass,"rtimer",   "",1,"{'mt':2,'color':" & CStr(fWhite) & ", 'xpos': 75, 'size': 8, 'fname':" & jackpotfont & " }"
      End If
    End If
    Exit Sub
  End If

  If HermanMode Then
    If HermanHurryCnt > 0 Then
      PuPlayer.LabelSet pBackglass, "BottomBox3", "HERMAN HURRYUP\r" & CenterText(22,FormatNumber(HermanHurryCnt*100,0)),1,"{'mt':2,'color': " & CStr(fGreen) & ",'fname':" & numberfont & ", 'size': 3.5 }"
    End If
  End If
  If LilyMode Then
    'D "LilyMode countdown " & CStr(LilySwHits)
    LilyModeTimeRemain=LilyModeTimeRemain-1
    If LilyModeTimeRemain=5 Then
      If RndNum(1,10) < 3 Then PUP_audioevents "Sound-0x0728 - not much time.mp3"
    End If
    If LilyModeTimeRemain=0 Then
      StopLilyMode()
    Else
      PuPlayer.LabelSet pBackglass,"bLine","Switches Remaining " & CStr(LilySwHits),1,"{'mt':2,'size': 5 }"
      PuPlayer.LabelSet pBackglass,"rtimertxt","          LILY",1,"{'mt':2,'size': 4,'fname':" & typefont & ", 'color':" & CStr(fOrange) & ", 'xpos': 70 }"
      PuPlayer.LabelSet pBackglass,"rtimer",CStr(LilyModeTimeRemain),1,"{'mt':2, 'size': 12,'fname':" & jackpotfont & ",'color':" & CStr(fOrange) & ", 'xpos': 77 }"
    End If
  End If
  If GrandpaMode Then
    'D "GrandpaMode countdown "
    GrandpaModeTimeRemain=GrandpaModeTimeRemain-1
    If GrandpaModeTimeRemain=0 Then
      StopGrandpaMode()
    Else
      PuPlayer.LabelSet pBackglass,"ltimertxt","ENLARGING RAY",1,"{'mt':2,'fname':" & typefont & ", 'color':" & CStr(fWhite) & ", 'xpos': 13, 'size': 3 }"
      PuPlayer.LabelSet pBackglass,"ltimer",CStr(GrandpaModeTimeRemain),1,"{'mt':2,'color':" & CStr(fpurple) & ", 'xpos': 15, 'fname':" & jackpotfont & "}"
    End If
  End If
  If SpotMode Then
    'D "SpotMode countdown "
    SpotTimeRemain=SpotTimeRemain-1
    If SpotTimeRemain<= 0 Then
      StopSpotMode()
    Else
      PuPlayer.LabelSet pBackglass,"ltimertxt","SPOT",1,"{'mt':2,'color':" & CStr(fRed) & ", 'xpos': 15}"
      PuPlayer.LabelSet pBackglass,"ltimer",CStr(SpotTimeRemain),1,"{'mt':2,'color':" & CStr(fred) & ", 'xpos': 16, 'fname':" & jackpotfont & "}"
    End If
  End If
  If RavenMode Then
    PuPlayer.LabelSet pBackglass,"Ravens",RavenTime(ModesHeld(CurrentPlayer,Raven)),1,""
  End If
End Sub

Sub ScreenQuickTimer_Timer
  HurryValue=HurryValue-(50000+RndNum(25000,100000))
  If HurryValue > 0 Then
    If ShowHurry Then
      PuPlayer.LabelSet pBackglass,"TLine0",CenterText(20,FormatNumber(HurryValue,0)),1,"{'mt':2,'color':" & CStr(fwhite) & ", 'fname':" & jackpotfont & ",'ypos': 45, 'size': 14}"
      PuPlayer.LabelSet pBackglass,"TLine1","",1,"{'mt':2,'color':" & CStr(fWhite) & "}"
      PuPlayer.LabelSet pBackglass,"TLine2",CenterText(36,"SHOOT THE LEFT ORBIT"),1,"{'mt':2,'color':" & CStr(fred) & ",'fname':" & stencilfont & ", 'ypos': 60, 'size': 6}"
    End If
  Else
    ScreenQuickTimer.Enabled=False
    StopMadnessStage3()
  End If
End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  FLIPPER LANES
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'
  Sub sw1_Hit   'Left Outlane
    Dim p
    PlaySoundAt "fx_sensor", ActiveBall
    If bMultiBallMode = False Then
      PlaySound "lane"
      DOF 144, DOFPulse
      DOF 313, DOFPulse   'DOF MX - Left Outer Lane
      PUP_audiocallouts
    End If
    If Tilted Then Exit Sub
    cLilyMode
    If lStates(CurrentPlayer,11)<>0 Then
      FlashForMs L11, 500, 50, 0:lStates(CurrentPlayer,15)=0:lStates(CurrentPlayer,11)=0
      SpecialVideoClip 3500,"","","","","videospecials","149 - special.mp4"
      p=CalcPoints(Zap, 10000):AddScore p
    Else
      p=CalcPoints(Zap, 5050):AddScore p
    End If
  End Sub

  Sub sw6_Hit     'Right Outlane
    Dim p
    PlaySoundAt "fx_sensor", ActiveBall
    If bMultiBallMode = False Then
      PlaySound "lane"
      DOF 144, DOFPulse
      DOF 313, DOFPulse   'DOF MX - Left Outer Lane
      PUP_audiocallouts
    End If
    If Tilted Then Exit Sub
    cLilyMode
    If lStates(CurrentPlayer,15)<>0 Then
      FlashForMs L15, 500, 50, 0:lStates(CurrentPlayer,15)=0:lStates(CurrentPlayer,11)=0
      SpecialVideoClip 3500,"","","","","videospecials","149 - special.mp4"
      p=CalcPoints(Zap, 10000):AddScore p
    Else
      p=CalcPoints(Zap, 5050):AddScore p
    End If
  End Sub

  Sub sw2_Hit  'Left InLane
    Dim p
    PlaySoundAt "fx_sensor", ActiveBall
    PUP_audionoise
    If Tilted Then Exit Sub
    If Not HermanMode Then
      If lStates(CurrentPlayer,12)=2 Then
        StartEddie
      End If
    End If
    cLilyMode
    p=CalcPoints(Zap, 1000):AddScore p
  End Sub

  Sub sw3_Hit  'Left Inner Lane
    Dim p
    PlaySoundAt "fx_sensor", ActiveBall
    PUP_audionoise
    If Tilted Then Exit Sub
    'If Not HermanMode Then
      If lStates(CurrentPlayer,13)=2 Then
        StartMarilyn
      End If
    'End If
    cLilyMode
    p=CalcPoints(Zap, 1000):AddScore p
  End Sub

  Sub sw5_Hit   'Right Inlane
    Dim p
    PlaySoundAt "fx_sensor", ActiveBall
    PUP_audionoise
    If Tilted Then Exit Sub
    cLilyMode
    If Not HermanMode Then
      If lStates(CurrentPlayer,14)=2 Then
        StartEddie
      End If
    End If
    p=CalcPoints(Zap, 1000):AddScore p
  End Sub

  Sub sw22_Hit ' Plunger Switch
    PlaySoundAt "fx_sensor", ActiveBall
    AddScore 0 'repaint screen
  End Sub

  Sub sw29_unhit()
  End Sub

  Sub sw29_Hit ' dragula
    Dim pts,p,b,toboost
    Dim tline
    if me.timerEnabled Then Exit Sub  ' double call
    PlaySoundAt "fx_sensor", ActiveBall
    D "In Dragula"
        me.TimerInterval = 3000
        me.TimerEnabled = True
    If Tilted Then Exit Sub
    cLilyMode
    tline=""
    If L38.state <> 0 Then
      pts=100000:b=3
    ElseIf L37.state <> 0 Then
      pts=50000:b=3
    ElseIf L36.state <> 0 Then
      pts=25000:b=2
    ElseIf L35.state <> 0 Then
      pts=15000:b=2
    ElseIf L34.state <> 0 Then
      pts=10000:b=2
    ElseIf L33.state <> 0 Then
      pts=5000:b=1
    ElseIf L32.state <> 0 Then
      pts=1000:b=1
    End If
    If L29.state <> 0 Then
      pts=pts*5
      tline="5X DRAGULA: "
      PUP_audioevents "Sound-0x05E6 - collect 5x dragula.mp3"
    Else
      tline="1X DRAGULA: "
    End If
    SetLightColor L29,white,2   ' award 5x for 10s
    vpmtimer.addtimer 10000, "Reset5X '"  '

    If (RavenMode or HermanMode) and BallsOnPlayfield > 1 Then
      If L28.state=2 Then
        lStates(CurrentPlayer,28)=0:SetLightColor L28,orange, 0
        FlashThem()
        AddMultiball 1
        PUP_audioevents "Sound-0x08D4 - shiney balls.mp3"
        bAddABallAwarded=True
      Else
        If bAddABallAwarded=False Then
          lStates(CurrentPlayer,28)=2:SetLightColor L28,orange, 2
        End If
      End If
    End If

    p=CalcPoints(Zap, pts):AddScore p
    tline=tline & FormatNumber(p,0) & "\r5X DRAGULA IS LIT\r+" & CStr(b) & "X BONUS MULTIPLIER\r"
    toBoost=PickRandomBoosted()
    If toBoost > 0 and NOT MMadnessMode Then
      Boost(CurrentPlayer,toBoost)=1
      Select case toBoost
        case Herman
          tline=tline & "HERMAN BOOSTED"
          hBoostTimer.interval=60000:hBoostTimer.Enabled=True
          'PUP_audioevents ""
        case Lily
          tline=tline & "LILY BOOSTED"
          lBoostTimer.interval=60000:lBoostTimer.Enabled=True
          'PUP_audioevents ""
        case Spot
          tline=tline & "SPOT BOOSTED"
          sBoostTimer.interval=60000:sBoostTimer.Enabled=True
          PUP_audioevents "Sound-0x06D9 - spot boosted.mp3"
        case Grandpa
          tline=tline & "GRANDPA BOOSTED"
          gBoostTimer.interval=60000:gBoostTimer.Enabled=True
          PUP_audioevents "Sound-0x07AC - grandpa boosted.mp3"
      End Select
    End If
    BonusMultiplier(CurrentPlayer)=BonusMultiplier(CurrentPlayer)+b
    Page5VideoClip 3000, "", tline, "", "videospecials", "dragula.mp4"
    PaintModes()
    vpmtimer.addtimer 3000, "ScoreJackPots '"  '
  End Sub

    Sub sw29_timer
    me.TimerEnabled = False
    D "Car Plunger"
    PUP_audioevents "Sound-0x006E - drag sounds.mp3"
    CarPlunger.Pullback
    PlaySoundAt "fx_plungerpull", CarPlunger
    CarPlunger.Fire
    DOF 122, DOFPulse
    DOF 115, DOFPulse
    DragCnt=DragTime
    End Sub

  Function PickRandomBoosted()
  Dim a
  a=RndNum(1,4)
  Select Case a
    case 1
      a=herman
      If Boost(CurrentPlayer,a)=1 Then
        a=lily
        If Boost(CurrentPlayer,a)=1 Then
          a=Spot
          If Boost(CurrentPlayer,a)=1 Then
            a=Grandpa
            If Boost(CurrentPlayer,a)=1 Then
              a=0
            End If
          End If
        End If
      End If
    case 2
      a=lily
      If Boost(CurrentPlayer,a)=1 Then
        a=herman
        If Boost(CurrentPlayer,a)=1 Then
          a=Spot
          If Boost(CurrentPlayer,a)=1 Then
            a=Grandpa
            If Boost(CurrentPlayer,a)=1 Then
              a=0
            End If
          End If
        End If
      End If
    case 3
      a=spot
      If Boost(CurrentPlayer,a)=1 Then
        a=lily
        If Boost(CurrentPlayer,a)=1 Then
          a=herman
          If Boost(CurrentPlayer,a)=1 Then
            a=Grandpa
            If Boost(CurrentPlayer,a)=1 Then
              a=0
            End If
          End If
        End If
      End If
    case 4
      a=grandpa
      If Boost(CurrentPlayer,a)=1 Then
        a=lily
        If Boost(CurrentPlayer,a)=1 Then
          a=Spot
          If Boost(CurrentPlayer,a)=1 Then
            a=herman
            If Boost(CurrentPlayer,a)=1 Then
              a=0
            End If
          End If
        End If
      End If
  End Select
  PickRandomBoosted=a
  End Function

  Sub Reset5X
    SetLightColor L29,white,0
  End Sub

  Sub sw32_Hit ' Shooter Lane
    PlaySoundAt "fx_sensor", ActiveBall
    If Tilted Then Exit Sub
    LastSwitchHit="sw32"
  End Sub

  Sub sw53_Hit    'Left Upper Lane
    Dim p
    LastSwitchHit="sw53"
    ballLaunched=False
    PlaySoundAt "fx_sensor", ActiveBall
    DOF 128, DOFPulse
    D "Left Upper Lane"
    If Tilted Then Exit Sub
    CancelSkillShot()
    LastSwitchHit="sw53"
    DropStop.collidable=False
    DropStop.isdropped=True
    cLilyMode
    If  Boost(CurrentPlayer,Herman) +  Boost(CurrentPlayer,Grandpa) +  Boost(CurrentPlayer,Lily)+  Boost(CurrentPlayer,Spot)+  Boost(CurrentPlayer,Raven) > 2 Then
      PUP_audioevents "Sound-0x0730 - boosts.mp3"
    End If
    p=CalcPoints(Zap, 5000):AddScore p
  End Sub

  Sub sw54_Hit  ' Right Upper Lane
    Dim p
    LastSwitchHit="sw54"
    ballLaunched=False
    PlaySoundAt "fx_sensor", ActiveBall
    DOF 129, DOFPulse
    D "Right Upper Lane"
    If Tilted Then Exit Sub
    DropStop.collidable=False
    DropStop.isdropped=True
    LastSwitchHit="sw54"
    cLilyMode
    p=CalcPoints(Zap, 5000):AddScore p
    If bSkillShotReady then
      AwardSkillShot
    End If
  End Sub

  Sub dZaps
    D "ZapShots = " & Cstr(ZapShots(1)) & Cstr(ZapShots(2)) & Cstr(ZapShots(3)) & Cstr(ZapShots(4))
  End Sub

  Sub sw64_Hit
    PlaySoundAt "fx_sensor", ActiveBall
    DOF 130, DOFPulse
    D "sw64, Left Orbit LS:" & LastSwitchHit
    DropStop.collidable=False
    DropStop.isdropped=True
    If Tilted Then Exit Sub
    If ballLaunched Then
      ballLaunched=False
      Exit Sub
    End If
    If LastSwitchHit="sw65LoopingTrigger" Then
      D "Loop..Is Shot lit? " & Cstr(Shots(4))
      D "is ZapShot lit? " & Cstr(ZapShots(4))
      If MMadnessMode Then
        If SubLevels(CurrentPlayer,Madness)=2 Then ' Check if flashing then score Herman Hurry, turnoff light, reset value and move to next ramp
          If L73.state=2 Then
            L73.state=0:L67.state=2
            AddScore 16800000 'TODO HurryUp Value should decline
            ShowHurryUpAward 16800000
          End If
          Exit Sub
        End If
        If Not HermanMode and Not GrandpaMode and Not SpotMode and Not RavenMode and Not LilyMode and Not EddieMode and Not MarilynMode then
          If lStates(CurrentPlayer,72)=2 Then ' Score Eddie
            lStates(CurrentPlayer,72)=0:L46.state=0
            AddScore 500
            If lStates(CurrentPlayer,46)=0 Then
              StartMadEddie()
            End If
          End If
          If ZapShots(4)=1 and L47.state=2 and Not LilyMode and Not GrandpaMode and Not RavenMode and not HermanMode and not SpotMode Then
            SetLightColor L47, white,0
            ZapShots(4)=0
            AwardZapJackpot
          End If
          Exit Sub
        End If
        If Shots(4)=1 Then
          mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
          AwardMadnessJackpot()
          If L73.blinkinterval=qb Then
            L73.blinkinterval=sb
          Else
            Shots(4)=0
            lStates(CurrentPlayer,73)=0:SetLightColor L73,white, 0
          End If
        End If
        If Shots(1)+Shots(2)+Shots(3)+Shots(4)=0 Then
          MMadnessTimer=0
          If ZapsCnt > 0 and ZapShots(4)=0 Then  ' leave a zap jackpot
            ZapsCnt=ZapsCnt-1
            D "Light a Zap Jackpot 4 ZapsCnt=" & CStr(ZapsCnt)
            ZapShots(4)=1
            dZaps()
            PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
          End If
        End If
        Exit Sub
      End If

      If GrandpaMode and Shots(4)=0 Then
        ScoreGrandpa()
        If ZapsCnt > 0 and ZapShots(4)=0 Then
          ZapsCnt=ZapsCnt-1
          D "Light a Zap Jackpot 4 ZapsCnt=" & CStr(ZapsCnt)
          ZapShots(4)=1
          dZaps()
          PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
        End If
      ElseIf GrandpaMode Then ' Light one of the shots purple
        D "Turn Shot Purple A"
        GrandpaLightShot
      End If
      If HermanMode and lStates(CurrentPlayer, 73) <> 0 Then   'test2
        AwardHermanJackpot()
        lStates(CurrentPlayer,73)=0:SetLightColor L73,white,0
      End If
      If Not GrandpaMode and Not HermanMode and Not RavenMode and Not SpotMode and ZapShots(4)=1 Then 'Score the Zap Award
        SetLightColor L73,white,0
        ZapShots(4)=0
        If lStates(CurrentPlayer,72)=2 Then ' Going to Award Eddie so delay the zap award
          vpmtimer.addtimer 2500, "AwardZapJackpot '"
        Else
          AwardZapJackpot
        End If
      End If
      If RavenMode and Shots(4)=1 Then
        Shots(4)=0
        SetLightColor L73,white,0
        AwardRavenJackpot
      End If
      If lStates(CurrentPlayer,72)=2 Then
        ScoreEddie
      End If
    End If
    cLilyMode
    LastSwitchHit="sw64"
  End Sub

  Sub LoopingTrigger_Hit
    LastSwitchHit = LastSwitchHit & "LoopingTrigger"
    PUP_audionoise
    If RavenMode and RndNum(1,10) < 2  Then
      PUP_audioevents "Sound-0x09BC - shoot the ramp.mp3"
    End If
    If LilyMode and BallsOnPlayfield > 2 Then
        If RndNum(1,10) < 2 Then
          PUP_audioevents "Sound-0x09FF - scoring like a monster.mp3"
        End If
    End If
    If GrandpaMode and RndNum(1,10) < 2 Then
      PUP_audioevents "Sound-0x0612 - go grandpa.mp3"
    End If
  End Sub

  Sub sw_shortplunge_Hit ' only used on initial plunge to skip sw65, but allow for skillshot
    if LastSwitchHit = "sw32" Then LastSwitchHit = ""
    DropStop.collidable=False
    DropStop.isdropped=True
    StartTimers
    ballLaunched=False
  End Sub

  Sub sw65_Hit
    PlaySoundAt "fx_sensor", ActiveBall
    DOF 131, DOFPulse
    D "sw65, Right Orbit LS:" & LastSwitchHit
    If Tilted Then Exit Sub
    StartTimers
    If ballLaunched Then Exit Sub
    If not MmadnessMode and  L64.state <> 0 Then
      PUP_audioevents "Sound-0x068 - shoot ballpopper.mp3"
    End If
    If LastSwitchHit <> "sw32" Then 'ignore switch from a plunger pull
      If LastSwitchHit = "sw64LoopingTrigger" Then
        D "Loop!! Is shot lit (0 is yes)? " & Cstr(Shots(1))
        If MMadnessMode Then  'testm69
          If SubLevels(CurrentPlayer,Madness)=2 Then ' Check if flashing then score Herman Hurry, turnoff light, reset value and move to next ramp
            If L47.state=2 Then
              L47.state=0
              ScreenQuickTimer.Enabled=False
              PuPlayer.LabelSet pBackglass,"jLine0","",1,"{'mt':2,'color':" & CStr(fWhite) & "}"
              PuPlayer.LabelSet pBackglass,"jLine1","",1,"{'mt':2,'color':" & CStr(fWhite) & "}"
              PuPlayer.LabelSet pBackglass,"jLine2","",1,"{'mt':2,'color':" & CStr(fWhite) & "}"
              AddScore hurryvalue
              ShowHurryUpAward hurryvalue
              StopMadnessStage3()
            End If
            Exit Sub
          End If
          If Not HermanMode and Not GrandpaMode and Not SpotMode and Not RavenMode and Not LilyMode and Not EddieMode and Not MarilynMode then
            If lStates(CurrentPlayer,46)=2 Then ' Score Eddie
              lStates(CurrentPlayer,46)=0:L46.state=0
              AddScore 500
              If lStates(CurrentPlayer,72)=0 Then
                StartMadEddie()
              End If
            End If
            If ZapShots(1)=1 and L47.state=2 and Not LilyMode and Not GrandpaMode and Not RavenMode and not HermanMode and not SpotMode Then
              SetLightColor L47, white,0
              ZapShots(1)=0
              AwardZapJackpot
            End If
            Exit Sub
          End If
          If Shots(1)=1 Then
            mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
            AwardMadnessJackpot()
            If L47.blinkinterval=qb Then
              L47.blinkinterval=sb
            Else
              Shots(1)=0
              lStates(CurrentPlayer,47)=0:SetLightColor L47,white, 0
            End If
          End If
          If Shots(1)+Shots(2)+Shots(3)+Shots(4)=0 Then
            MMadnessTimer=0
            If ZapsCnt > 0 and ZapShots(1)=0 Then  ' leave a zap jackpot
              ZapsCnt=ZapsCnt-1
              D "Light a Zap Jackpot 4 ZapsCnt=" & CStr(ZapsCnt)
              ZapShots(1)=1
              dZaps()
              PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
            End If
          End If
          Exit Sub
        End If

        D "is ZapShot lit? " & Cstr(ZapShots(1))
        If GrandpaMode and Shots(1)=0 Then   '0 means its read to be scored
          ScoreGrandpa() ' score all purple lights
          If ZapsCnt > 0 and ZapShots(1)=0 Then
            D "Light a Zap Jackpot 1 (b4) ZapsCnt=" & CStr(ZapsCnt)
            ZapsCnt=ZapsCnt-1
            ZapShots(1)=1
            PuPlayer.LabelSet pBackglass,"Zaps",CStr(ZapsCnt),1,""
          End If
        ElseIf GrandpaMode Then ' Light one of the shots purple
          D "Turn Shot Purple A"
          GrandpaLightShot
        End If
        If HermanMode and lStates(CurrentPlayer,47) <> 0 Then   'test2
          AwardHermanJackpot()
          lStates(CurrentPlayer,47)=0:SetLightColor L47, white,0
          If ZapsCnt > 0 and ZapShots(1)=0 Then
            D "Light a Zap Jackpot 1 (b4) ZapsCnt=" & CStr(ZapsCnt)
            ZapsCnt=ZapsCnt-1
            ZapShots(1)=1
            PuPlayer.LabelSet pBackglass,"Zaps",CStr(ZapsCnt),1,""
          End If
        End If
        If Not GrandpaMode and Not HermanMode and Not RavenMode and Not SpotMode and ZapShots(1)=1 Then
          SetLightColor L47, white,0
          ZapShots(1)=0
          If lStates(CurrentPlayer,46)=2 Then ' Going to Award Eddie so delay the zap award
            vpmtimer.addtimer 2500, "AwardZapJackpot '"
          Else
            AwardZapJackpot
          End If
        End If
        If lStates(CurrentPlayer,46)=2 Then
          ScoreEddie
        End If
        If SpotMode Then
          If SpotWall.IsDropped Then RaiseSpot()
        End If
        If RavenMode and Shots(1)=1 Then
          Shots(1)=0
          SetLightColor L47,white,0
          AwardRavenJackpot
        End If
      Else
        If SuperPopsTimer.Enabled Then
          DropStop.collidable=True
          DropStop.isdropped=False
        End If
      End If
      cLilyMode
    End If
    LastSwitchHit="sw65"
  End Sub

  Sub sw68_Timer
    me.TimerEnabled = False
  End Sub

  Sub sw68_Hit
    D "sw68_Hit()"
    If sw68.TimerEnabled then Exit Sub
    sw68.TimerInterval = 500
        sw68.TimerEnabled = True
    D "sw68_hit() - Spot Target when activated"
    If Tilted Then Exit Sub
    If NOT SpotWall.isDropped Then
      D "Spot Hit!!"
      If RndNum(1,10) < 2 Then
        PUP_audioevents "Sound-0x0707 - avoid spot.mp3"
      Else
        Page5VideoClip 2000, "", "", "", "videospot", "Video-0x0146.mp4"
      End If
      AwardSpotLetter()
      cLilyMode
    End If
  End Sub

Sub AwardMadnessJackpot()
  Dim m,points,p, tDelay
  If HermanMode then m=Herman
  If LilyMode then m=Lily
  If MarilynMode then m=Marilyn
  If SpotMode then m=Spot
  If RavenMode then m=Raven
  If GrandpaMode then m=Grandpa
  If EddieMode then m=Eddie

  tDelay=10
  Select case m
    case Herman
      HermanJackpots=HermanJackpots+1
      points=250000+((HermanJackPots-1)*25000)
      vpmtimer.addtimer tDelay, "ShowJackpot herman, " & Cstr(points) & ", SubLevels(CurrentPlayer,Herman) '"
      p=CalcPoints(Herman, points):AddScore p
    case Grandpa
      GrandpaJackpots=GrandpaJackpots+1
      points=250000+((GrandpaJackPots-1)*25000)
      vpmtimer.addtimer tDelay, "ShowJackpot grandpa, " & Cstr(points) & ", SubLevels(CurrentPlayer,Grandpa) '"
      p=CalcPoints(Herman, points):AddScore p
    case Spot
      SpotJackpots=SpotJackpots+1
      points=250000+((SpotJackPots-1)*25000)
      vpmtimer.addtimer tDelay, "ShowJackpot spot, " & Cstr(points) & ", SubLevels(CurrentPlayer,Spot) '"
      p=CalcPoints(Spot, points):AddScore p
    case Raven
      RavenJackpots=RavenJackpots+1
      points=250000+((RavenJackPots-1)*25000)
      vpmtimer.addtimer tDelay, "ShowJackpot raven, " & Cstr(points) & ", SubLevels(CurrentPlayer,Raven) '"
      p=CalcPoints(Raven, points):AddScore p
    case Lily
      LilyJackpots=LilyJackpots+1
      points=250000+((LilyJackPots-1)*25000)
      vpmtimer.addtimer tDelay, "ShowJackpot lily, " & Cstr(points) & ", SubLevels(CurrentPlayer,Lily) '"
      p=CalcPoints(Lily, points):AddScore p
    case Eddie
      EddieJackpots=EddieJackpots+1
      points=250000+((EddieJackPots-1)*25000)
      vpmtimer.addtimer tDelay, "ShowJackpot Eddie, " & Cstr(points) & ", SubLevels(CurrentPlayer,Eddie) '"
      p=CalcPoints(Eddie, points):AddScore p
    case Marilyn
      MarilynJackpots=MarilynJackpots+1
      points=250000+((MarilynJackPots-1)*25000)
      vpmtimer.addtimer tDelay, "ShowJackpot Marilyn, " & Cstr(points) & ", SubLevels(CurrentPlayer,Marilyn) '"
      p=CalcPoints(Marilyn, points):AddScore p
    Case Else
      D "ERROR! Missing mode for jackpot"
  End Select
End Sub

  Sub sw69_Hit  ' back passage
    LastSwitchHit="sw69"
    Dim p
    D "Left ramp completed"
    PlaySoundAt "fx_sensor", ActiveBall
    PlaySound "fx_metalrolling"
    p=CalcPoints(Zap, 50000):AddScore p
    If Tilted Then Exit Sub
    If bSkillShotReady then
      AwardSkillShot
    End If
    If MMadnessMode Then  'testm69
      If SubLevels(CurrentPlayer,Madness)=2 Then ' Check if flashing then score Herman Hurry, turnoff light, reset value and move to next ramp
        If L51.state=2 Then
          L51.state=0:L73.state=2
          AddScore 2400000
          ShowHurryUpAward 2400000
        End If
        Exit Sub
      End If
      If ZapShots(2)=1 and L51.state=2 and Not LilyMode and Not GrandpaMode and Not RavenMode and not HermanMode and not SpotMode Then
        SetLightColor L51, white,0
        ZapShots(2)=0
        AwardZapJackpot
        Exit Sub
      End If
      If Shots(2)=1 Then
        mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
        AwardMadnessJackpot()
        If L51.blinkinterval=qb Then
          L51.blinkinterval=sb
        Else
          Shots(2)=0
          lStates(CurrentPlayer,51)=0:SetLightColor L51,white, 0
        End If
      End If
      If Shots(1)+Shots(2)+Shots(3)+Shots(4)=0 Then
        MMadnessTimer=0
        If ZapsCnt > 0 and ZapShots(2)=0 Then  ' leave a zap jackpot
          ZapsCnt=ZapsCnt-1
          D "Light a Zap Jackpot 4 ZapsCnt=" & CStr(ZapsCnt)
          ZapShots(2)=1
          dZaps()
          PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
        End If
      End If
      Exit Sub
    End If
    If GrandpaMode and Shots(2)=0 Then
      ScoreGrandpa()
      If ZapsCnt > 0 and ZapShots(2)=0 Then
        ZapsCnt=ZapsCnt-1
        ZapShots(2)=1
        dZaps()
        PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
      End If
    ElseIf GrandpaMode Then ' Light one of the shots purple
      D "Turn Shot Purple sw69"
      GrandpaLightShot
    End If
    If HermanMode and lStates(CurrentPlayer, 51) <> 0 Then
      AwardHermanJackpot()
      lStates(CurrentPlayer,51)=0:SetLightColor L51,white,0
      If ZapsCnt > 0 and ZapShots(2)=0 Then
        D "Mark a Zap Jackpot 2 (b4) ZapsCnt=" & CStr(ZapsCnt)
        ZapsCnt=ZapsCnt-1
        ZapShots(2)=1
        PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
      End If
    End If
    If Not GrandpaMode and Not HermanMode and Not RavenMode and Not SpotMode and ZapShots(2)=1 Then
      SetLightColor L51, white,0
      ZapShots(2)=0
      AwardZapJackpot
    End If
    If Not GrandpaMode and Not HermanMode and Not RavenMode and Not SpotMode and lStates(CurrentPlayer,98)=2 and NOT RavenRestartTimer.Enabled Then 'Spot
      lStates(CurrentPlayer,98)=0:SetLightColor L98,red,0
      p=CalcPoints(Spot, 1000):AddScore p
      If lStates(CurrentPlayer,101)=0 Then
        AwardSpotLetter
      Else
        TvText "\r\r\r" & CenterText(32,"SPOT") & "\r" & CenterText(18,"Shoot Another Ramp") & "\r" & CenterText(18,"For S-P-O-T Letters"),"","",""
        Pup_audioevents "Sound-0x06D2 - spell spot.mp3"
        RaiseSpot() ' Have Spot Make an Appearance
        vpmtimer.addtimer 1000, "DropSpot '"
      End If
    End If
    If RavenMode and Shots(2)=1 Then  ' check before you award the raven light
      Shots(2)=0
      SetLightColor L51,white,0
      AwardRavenJackpot
    End If
    If RavenMode Then
      AwardRavenLight() 'for raven boost now  -- could be joined with statement below :-)
    End If
    If Not RavenMode and Not HermanMode and Not SpotMode Then
      AwardRavenLight()
    End If
    If RavenRestartTimer.Enabled Then  'restart ravenmode MB   TODO Reset the Lights etc..
      RavenRestartTimer.Enabled=False
      lStates(CurrentPlayer,51)=0:SetLightColor L51,white,0:L51.blinkinterval=sb
      StartRavenMode()
      rBoostTimer.Enabled=False:Boost(CurrentPlayer,Raven)=0
      PuPlayer.LabelSet pBackglass,"RBoost","",1,""
      lStates(CurrentPlayer,95)=2:SetLightColor L95, blue, 2
      lStates(CurrentPlayer,96)=2:SetLightColor L96, blue, 2
      lStates(CurrentPlayer,97)=2:SetLightColor L97, blue, 2
      PuPlayer.LabelSet pBackglass, "BottomBox3","Raven Mode",1,"{'mt':2,'color': " & CStr(fBlue) & ",'fname':" & numberfont & ", 'size': 5 }"
      FlashForMs L19, 1000, 50, 1
    End If
    cLilyMode
  End Sub

  Sub sw70_Hit
    LastSwitchHit="sw70"
    Dim p
    PlaySound "fx_metalrolling"
    D "Right Ramp"
    p=CalcPoints(Marilyn, 50000):AddScore p
    If Tilted Then Exit Sub
    If bSkillShotReady then
      If lFlipperUp then
        AwardSuperSkillShot
      Else
        AwardSkillShot
      End If
    End If
    If MMadnessMode Then
      If SubLevels(CurrentPlayer,Madness)=2 Then ' Check if flashing then score Herman Hurry, turnoff light, reset value and move to next ramp
        If L67.state=2 Then
          L67.state=0:L47.state=2
          hurryvalue=103600000
          ShowHurry=False
          ScreenQuickTimer.Interval=50
          ScreenQuickTimer.Enabled=True
          AddScore 17200000
          ShowHurryUpAward 17200000
        End If
        Exit Sub
      End If
      If ZapShots(3)=1 and L67.state=2 and Not LilyMode and Not GrandpaMode and Not RavenMode and not HermanMode and not SpotMode Then
        SetLightColor L67, white,0
        ZapShots(3)=0
        AwardZapJackpot
        Exit Sub
      End If
      If Shots(3)=1 Then
        mMadnessTimer=20:If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
        AwardMadnessJackpot()
        If l67.blinkinterval=qb Then
          L67.blinkinterval=sb
        Else
          Shots(3)=0
          lStates(CurrentPlayer,67)=0:SetLightColor L67,white, 0
        End If
      End If
      If Shots(1)+Shots(2)+Shots(3)+Shots(4)=0 Then
        MMadnessTimer=0
        If ZapsCnt > 0 and ZapShots(3)=0 Then  ' leave a zap jackpot
          ZapsCnt=ZapsCnt-1
          D "Light a Zap Jackpot 4 ZapsCnt=" & CStr(ZapsCnt)
          ZapShots(3)=1
          dZaps()
          PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
        End If
      End If
      Exit Sub
    End If
    If GrandpaMode and Shots(3)=0 Then
      PUP_audioevents "Sound-0x0685 - oh grandpa.mp3"
      ScoreGrandpa()
      If ZapsCnt > 0 and ZapShots(3)=0 Then
        ZapsCnt=ZapsCnt-1
        ZapShots(3)=1
        dZaps()
        PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
      End If
    ElseIf GrandpaMode Then ' Light one of the shots purple
      D "Turn Shot Purple A"
      GrandpaLightShot
    End If
    If HermanMode and lStates(CurrentPlayer, 67) <> 0 Then
      AwardHermanJackpot()
      lStates(CurrentPlayer,67)=0:SetLightColor L67,white,0
      If ZapsCnt > 0 and ZapShots(3)=0 Then
        ZapsCnt=ZapsCnt-1
        ZapShots(3)=1
        PuPlayer.LabelSet pBackglass, "Zaps",CStr(ZapsCnt),1,""
      End If
    End If
    If Not GrandpaMode and Not HermanMode and Not RavenMode and Not SpotMode and ZapShots(3)=1 Then 'Score the Zap Award
      SetLightColor L67,white,0
      ZapShots(3)=0
      AwardZapJackpot
    End If
    If lStates(CurrentPlayer,102)=2 Then
      ScoreMarilyn
    End If
    If Not GrandpaMode and Not HermanMode and Not RavenMode and Not SpotMode and lStates(CurrentPlayer,101)=2 Then 'Spot
      lStates(CurrentPlayer,101)=0:SetLightColor L101,red,0
      p=CalcPoints(Spot, 1000):AddScore p
      If lStates(CurrentPlayer,98)=0 Then
        AwardSpotLetter
      Else
        TvText "\r\r\r" & CenterText(32,"SPOT") & "\r" & CenterText(18,"Shoot Another Ramp") & "\r" & CenterText(18,"For S-P-O-T Letters"),"","",""
        ' tease - Have Spot Make an Appearance
        SpotWall.isDropped=False
        SpotRamp.WidthBottom=90:SpotRamp.WidthTop=65
        SpotRamp2.WidthBottom=90:SpotRamp2.WidthTop=90
        SpotLight.state=1
        SpotLight.state=0
        PlaySound SoundFXDOF("fx_target",117,DOFPulse,DOFTargets)
        vpmtimer.addtimer 1000, "DropSpotTease '"
      End If
    End If
    If SpotMode Then
      If SpotWall.IsDropped Then RaiseSpot()
    End If
    If RavenMode and Shots(3)=1 Then
      Shots(3)=0
      SetLightColor L67,white,0
      AwardRavenJackpot
    End If
    cLilyMode
  End Sub

  Sub ScoreMarilyn
    Dim p, tDelay:tDelay=500
    D "ScoresMarilyn Count=" & CStr(ModesHeld(CurrentPlayer,Marilyn)+1)
    MarilynTimer.Enabled=False
    MarilynTimer_Timer
    ModesHeld(CurrentPlayer,Marilyn)=ModesHeld(CurrentPlayer,Marilyn)+1
    If ModesHeld(CurrentPlayer,Marilyn) mod 4 = 0 Then
      If Not ActiveJackpot(Marilyn) Then
        StartSuperPops
        SpecialVideoClip 3500,"","","","","videosjp","Video-0x0047 - marilyn is lit.mp4"  ' is lit video
        AwardKitty() ' TODO Not sure this is a rule
        ActiveJackpot(Marilyn)=True
        If Jackpots > 1 Then Pup_audiojp "Sound-0x08F3 - stack jp.mp3"
        D "Light JackPot"
        tDelay=3000
        Jackpots=Jackpots+1
        L30.blinkinterval=260-(Jackpots*20):L30.state=2
      End If
    End If
    p=CalcPoints(Marilyn, 50000+(jackpots*25000)):AddScore p
    vpmtimer.addtimer tDelay, "ShowJackpot Marilyn, " & Cstr(p) & ", 1 '"
  End Sub

  Sub ClearRandomTxt()
    PuPlayer.LabelSet pBackglass,"randomtxt","",1,""
  End Sub
  Sub ClearRandomTxt2()
    PuPlayer.LabelSet pBackglass,"randomtxt2","",1,""
  End Sub

  Sub SuperPopsTimer_Timer
    SuperPopsTimer.Enabled=False
    StopSuperPops
  End Sub

  Sub StartSuperPops
    D "StartSuperPops"
    ' Raise Top bump
    PuPlayer.playlistplayex pCallouts,"audioevents","Sound-0x0896 - superpops.mp3",100, 1
    SuperPopsTimer.Interval=100000
    SuperPopsTimer.Enabled=True
    spops=0
    FlashForMs f168, 50000, 150, 1
    FlashForMs f169, 50000, 150, 1
    FlashForMs f170, 50000, 150, 1
  End Sub

  Sub StopSuperPops
    ' Lower Top bump
    D "StopSuperPops"
    DropStop.collidable=False
    DropStop.isdropped=True
    SuperPopsTimer.Enabled=False
    FlashForMs f168, 50000, 250, 0
    FlashForMs f169, 50000, 250, 0
    FlashForMs f170, 50000, 250, 0
  End Sub

' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  TARGETS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  Sub sw28_Timer
    me.TimerEnabled = False
  End Sub

  Sub sw28_Hit
    Dim p
    If sw28.TimerEnabled then Exit Sub
    D "Dragula Target"
    sw28.TimerInterval = 500
        sw28.TimerEnabled = True
    If Tilted Then Exit Sub
    PlaySoundAt "fx_sensor", ActiveBall
    DOF 123, DOFPulse
    DragCnt=DragTime
    SetLightColor L29,white,2   '5x
    PUP_audiocallouts
    If L32.state = 2 Then
      L32.state = 1:L33.state = 2:p=CalcPoints(Zap, 1000):AddScore p
    Elseif L33.state = 2 Then
      L33.state = 1:L34.state = 2:p=CalcPoints(Zap, 5000):AddScore p
    Elseif L34.state = 2 Then
      L34.state = 1:L35.state = 2:p=CalcPoints(Zap, 10000):AddScore p
    Elseif L35.state = 2 Then
      L35.state = 1:L36.state = 2:p=CalcPoints(Zap, 15000):AddScore p
    Elseif L36.state = 2 Then
      L36.state = 1:L37.state = 2:p=CalcPoints(Zap, 25000):AddScore p
    Elseif L37.state = 2 Then
      L37.state = 1:L38.state = 2:p=CalcPoints(Zap, 50000):AddScore p
    Elseif L38.state = 2 Then
      p=CalcPoints(Zap, 100000):AddScore p
    End If
    cLilyMode
  End Sub

  Sub KittyTimer_Timer
    D "KittyTimer Expired"
    KittyTimer.Enabled=False
    pfMultiplier=1
    SetLightColor L23,green,0
    SetLightColor L24,green,0
  End Sub

  Sub sw39_Timer
    sw39.TimerEnabled = False
  End Sub

Sub ScoreKitty
  D "Score kitty Cnt=" & CStr(Kitty(CurrentPlayer))
  Dim kline0,kline1,kline2
  kLine0="":kLine1="":kLine2=""
  ' Award Raven Lights
  If lStates(CurrentPlayer,95)=0 or lStates(CurrentPlayer,96)=0 or lStates(CurrentPlayer,97)=0 Then
    kLine2="ADVANCE RAVEN IS LIT"
    AwardRavenBlink()
  End If
  Kitty(CurrentPlayer)=Kitty(CurrentPlayer)-1
  KittyTimer.interval=60000
  KittyTimer.Enabled=True

  If L23.state=0 and L24.state=0 Then  ' Award PF multiplier
    SetLightColor L23,green,2:pfMultiplier=2
    kLine0="ADVANCE PLAYFIELD MULTIPLIER"
    pfMultiplier=2
    PuPlayer.playlistplayex pCallouts,"audioevents","Sound-0x0731 - 2x scoring.mp3",80,1
  ElseIf L23.state=2 and L24.state=0 Then
    SetLightColor L23,green,0
    SetLightColor L24,green,2
    kLine0="ADVANCE PLAYFIELD MULTIPLIER"
    pfMultiplier=3
    PuPlayer.playlistplayex pCallouts,"audioevents","Sound-0x08CB - 3x score.mp3",80,1
  Else
    SetLightColor L23,white,2
    kLine0="ADVANCE PLAYFIELD MULTIPLIER"
    pfMultiplier=6
    PuPlayer.playlistplayex pCallouts,"audioevents","Sound-0x0750 - 6x.mp3",80,1
  End If
  If BonusMultiplier(CurrentPlayer) < 19 Then
    kLine1="+2 BONUS MULTIPLIER"
    BonusMultiplier(CurrentPlayer)=BonusMultiplier(CurrentPlayer)+2
  End If
  Page5VideoClip 2000, kLine0, kLine1, kLine2, "videospecials", "kitty.png"
  If Kitty(CurrentPlayer)> 0 Then ' leave lit
  Else
    SetLightColor L80,green,0:lStates(CurrentPlayer,80)=0
  End If
End Sub

  Sub sw39_Hit
    Dim p
    If sw39.TimerEnabled then Exit Sub
    sw39.TimerInterval = 500
        sw39.TimerEnabled = True
    D "Kitty Cnt=" & Kitty(CurrentPlayer)
    If Tilted Then Exit Sub
    PlaySoundAt "fx_sensor", ActiveBall
    DOF 134, DOFPulse
    If KittyTimer.Enabled Then ' reset the pf multiplier timer regardless
      KittyTimer.interval=60000
      KittyTimer.Enabled=False:KittyTimer.Enabled=True ' Reset Timer
    End If
    If lStates(CurrentPlayer,80) = 2 Then
      ScoreKitty()
    Else
      p=CalcPoints(Zap, 5000):AddScore p
    End If
  End Sub

  Sub MagnetStart:D "Magnet Start":mHMagnet.MagnetOn = true:End Sub
  Sub MagnetStop:D "Magnet Stop":mHMagnet.MagnetOn = 0:DOF 135, DOFOff:End Sub


Sub ShowJackpot( m, p, c )  ' mode, points, color
  D "ShowJackpot " & Cstr(m) & "--" & CStr(p) & "++" & CStr(c)
  Dim cc, l
  Select Case c
    case 1
      cc = fGreen
    case 2
      cc = fWhite
    case 3
      cc = fBlue
    case 4
      cc = fRed
    case else
      cc = fRed
  End Select

  Select Case m
    case herman
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(Modes(CurrentPlayer,m)) ,FormatNumber(p,0),"","videoherman","",cc
    case grandpa
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(Modes(CurrentPlayer,m)), FormatNumber(p,0),"","videograndpa","",fPurple
    case spot
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(Modes(CurrentPlayer,m)), FormatNumber(p,0),"","videospot","",fRed
    case Marilyn
      l=INT(ModesHeld(CurrentPlayer,Marilyn)/4)+1
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(l), FormatNumber(p,0),"","videomarilyn","",fYellow
    case Raven
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(Modes(CurrentPlayer,m)) ,FormatNumber(p,0),"","videoraven","",fBlue
    case Eddie
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(Modes(CurrentPlayer,m)) ,FormatNumber(p,0),"","videoeddie","",fRed
    case Lily
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(Modes(CurrentPlayer,m)) ,FormatNumber(p,0),"","videolily","",fOrange
    case Zap
      JackpotVideoClip 1800,"JACKPOT!","LEVEL " & CStr(c) ,FormatNumber(p,0),"","videojackpot","ZapJackpot.mp4", cc
  End Select
End Sub

Sub ShowHurryUpAward(p)
  D "ShowHurryUpAward p=" & CStr(p)
  JackpotVideoClip 1800,"HURRY-UP AWARD!","LEVEL " & CStr(Modes(CurrentPlayer,Herman)) ,FormatNumber(p,0),"","videoherman","",fWhite
End Sub

  Sub HMagnet_Hit
    mHMagnet.AddBall ActiveBall
    If mHMagnet.MagnetOn=true then
      DOF 135, DOFOn
      GIOff
    End If
  End Sub

  Sub HMagnet_UnHit:mHMagnet.RemoveBall ActiveBall:GIOn:End Sub


  Sub sw45_Timer
    me.TimerEnabled = False
  End Sub

  Sub BallCaptured ' if ball is captured then process it
    Dim p
    If Captured Then
      D "BallCaptured() Captured=True SL=" & CStr(SubLevels(CurrentPlayer,Herman))
    Else
      D "BallCaptured() Captured=False SL=" & CStr(SubLevels(CurrentPlayer,Herman))
    End If
    If Captured Then
      D "BallCaptured() Captured=True"
      If Not HermanMode Then
        D "BallCaptured - not hermanMode"
        HermanHurryCnt=5000
        VideoClip 2000, "","\rHERMAN\rHURRY UP\r\r" & FormatNumber(HermanHurryCnt*100,0),"",""
        HermanTimer.Enabled=False:HermanTimer.Enabled=True
        PUP_audioevents "Sound-0x0550 - herman.mp3"
        vpmtimer.addtimer 2000, "HermanHurryBall '"
        If Not HermanMode Then
          StopRavenL:StopGrandpaL:StopSpotL
          HermanMode=True
          lStates(CurrentPlayer,18)=1:L18.state=2
          PuPlayer.LabelSet pBackglass,"BottomBox3","  Herman MB",1,"{'mt':2,'color': " & CStr(fGreen) & ",'fname':" & numberfont & ", 'size': 3.6 }"
          ScorbitBuildGameModes()
        End If
      End If
    ElseIf SubLevels(CurrentPlayer,Herman)=0 Then
      D "BallCaptured() - Set to Green and Turn On Magnet"
      SubLevels(CurrentPlayer,Herman)=SubLevels(CurrentPlayer,Herman)+1
      lStates(CurrentPlayer,56)=2:SetLightColor L56, lc(SubLevels(currentplayer,Herman)),2
      PUP_audioevents "Sound-0x0599 - herman.mp3"
      vpmtimer.addtimer 2000, "MagnetStart '"
    Else
      D "BallCaptured() - Not captured .. just continue on"
    End If
  End Sub

  Sub sw45_unhit()
    D "sw45_unhit() Herman Hit captured now FALSE"
    Captured=False
  End Sub

  Sub sw45_hit ' Herman Opto    'hhhhhhhhhhhhhhhh
    Dim p
    If me.TimerEnabled then Exit Sub
    me.TimerInterval = 500
    me.TimerEnabled = True
    CancelSkillShot
    If Captured Then
      D "sw45_hit() Herman Hit - Captured Flag"
    Else
      D "sw45_hit() Herman Hit - Not Captured Flag"
    End If
    HermanShake
    PUP_audionoiseshort
    If MMadnessMode Then
      If Not HermanMode and Not GrandpaMode and Not SpotMode and Not RavenMode and Not LilyMode and Not EddieMode and Not MarilynMode then
        If lStates(CurrentPlayer,58)<>2 Then
          D "blink 58"
          AddScore 500
          lStates(CurrentPlayer,58)=2
        ElseIf lStates(CurrentPlayer,59)<>2 Then
          D "blink 59"
          AddScore 500
          lStates(CurrentPlayer,59)=2
        ElseIf lStates(CurrentPlayer,60)<>2 Then
          D "blink 60"
          AddScore 500
          lStates(CurrentPlayer,60)=2
          StartMadHerman()
        End If
      End If
      Exit Sub
    End If
    If Not RavenMode and Not SpotMode and Not GrandpaMode Then
      If lStates(CurrentPlayer,58)=2 and lStates(CurrentPlayer,59)=2 and lStates(CurrentPlayer,60)=2 Then
        If lStates(CurrentPlayer,18)=0 or HermanMode Then
        D "sw45_hit() all_targets lit"
          If Captured  Then '2nd ball
            MagnetStop
            FlashThem()
            AddMultiball 1
            PuPlayer.playlistplayex pCallouts,"audiohermanmultiball","",80,1
          'SubLevels(CurrentPlayer,Herman)=SubLevels(CurrentPlayer,Herman)+1
          'lStates(CurrentPlayer,56)=2:SetLightColor L56, lc(SubLevels(currentplayer,Herman)),2
          'lStates(CurrentPlayer,58)=2:L58.state=2
          'lStates(CurrentPlayer,59)=0:L59.state=0
          'lStates(CurrentPlayer,60)=0:L60.state=0
            p=CalcPoints(Herman, HermanHurryCnt*100):AddScore p 'test2
            PuPlayer.LabelSet pBackglass, "BottomBox3", "",1,"{'mt':2,'color':16777215, 'size': 6 }"
            HermanHurryCnt=-1
            lStates(CurrentPlayer,47)=2:SetLightColor L47,white,2 ' only light jackpots during herman mb
            lStates(CurrentPlayer,51)=2:SetLightColor L51,white,2
            lStates(CurrentPlayer,67)=2:SetLightColor L67,white,2
            lStates(CurrentPlayer,73)=2:SetLightColor L73,white,2
            FlashForMs L18, 3000, 250, 1:lStates(CurrentPlayer,18)=1
            If Modes(CurrentPlayer,Herman)<3 Then Modes(CurrentPlayer,Herman)=Modes(CurrentPlayer,Herman)+1
            PaintModes()
            AwardKitty()
            HermanJackpots=0
            AwardHermanHurry()
          ElseIf SubLevels(Currentplayer, Herman)>1 Then
            D "All lights but no magnet involved"
            If SubLevels(CurrentPlayer,Herman)<4 Then SubLevels(CurrentPlayer,Herman)=SubLevels(CurrentPlayer,Herman)+1
            lStates(CurrentPlayer,56)=2:SetLightColor L56, lc(SubLevels(currentplayer,Herman)),2
            lStates(CurrentPlayer,58)=2:L58.state=2
            lStates(CurrentPlayer,59)=0:L59.state=0
            lStates(CurrentPlayer,60)=0:L60.state=0
          Else
            vpmtimer.addtimer 1000, "BallCaptured '"   ' See if the ball fell off magnet for 1s
          End If
        Else
          lStates(CurrentPlayer,58)=2:L58.state=2
          lStates(CurrentPlayer,59)=0:L59.state=0
          lStates(CurrentPlayer,60)=0:L60.state=0
        End If
      ElseIf lStates(CurrentPlayer,58)<>2 Then
        D "blink 58"
        AddScore 500
        lStates(CurrentPlayer,58)=2
        If HermanMode Then LightRandomHermanJackpot()
      ElseIf lStates(CurrentPlayer,59)<>2 Then
        D "blink 59"
        AddScore 500
        lStates(CurrentPlayer,59)=2
        If HermanMode Then LightRandomHermanJackpot()
      ElseIf lStates(CurrentPlayer,60)<>2 Then
        D "blink 60"
        AddScore 500
        lStates(CurrentPlayer,60)=2
        If HermanMode Then LightRandomHermanJackpot()
      End If
      L58.state=lStates(CurrentPlayer,58)
      L59.state=lStates(CurrentPlayer,59)
      L60.state=lStates(CurrentPlayer,60)
    End If
    Captured=True ' Will turn off if unhit is triggered
    cLilyMode
  End Sub

  Sub LightRandomHermanJackpot 'test2    ' relight jackpots when herman is hit
    D "LightRandomHermanJackpot"
    Dim a
    a=RndNum(1,4)
    Select case a
      case 1
        If lStates(CurrentPlayer,47)=0 Then
          lStates(CurrentPlayer,47)=2:SetLightColor L47,lc(SubLevels(CurrentPlayer,Herman)),2
        ElseIf lStates(CurrentPlayer,51)=0 Then
          lStates(CurrentPlayer,51)=2:SetLightColor L51,lc(SubLevels(CurrentPlayer,Herman)),2
          ElseIf lStates(CurrentPlayer,67)=0 Then
            lStates(CurrentPlayer,67)=2:SetLightColor L67,lc(SubLevels(CurrentPlayer,Herman)),2
            ElseIf lStates(CurrentPlayer,73)=0 Then
              lStates(CurrentPlayer,73)=2:SetLightColor L73,lc(SubLevels(CurrentPlayer,Herman)),2
        End If
      Case 2
        If lStates(CurrentPlayer,51)=0 Then
          lStates(CurrentPlayer,51)=2:SetLightColor L51,lc(SubLevels(CurrentPlayer,Herman)),2
        ElseIf lStates(CurrentPlayer,47)=0 Then
          lStates(CurrentPlayer,47)=2:SetLightColor L47,lc(SubLevels(CurrentPlayer,Herman)),2
          ElseIf lStates(CurrentPlayer,67)=0 Then
            lStates(CurrentPlayer,67)=2:SetLightColor L67,lc(SubLevels(CurrentPlayer,Herman)),2
            ElseIf lStates(CurrentPlayer,73)=0 Then
              lStates(CurrentPlayer,73)=2:SetLightColor L73,lc(SubLevels(CurrentPlayer,Herman)),2
        End If
      Case 3
        If lStates(CurrentPlayer,67)=0 Then
          lStates(CurrentPlayer,67)=2:SetLightColor L67,lc(SubLevels(CurrentPlayer,Herman)),2
        ElseIf lStates(CurrentPlayer,51)=0 Then
          lStates(CurrentPlayer,51)=2:SetLightColor L51,lc(SubLevels(CurrentPlayer,Herman)),2
          ElseIf lStates(CurrentPlayer,47)=0 Then
            lStates(CurrentPlayer,47)=2:SetLightColor L47,lc(SubLevels(CurrentPlayer,Herman)),2
            ElseIf lStates(CurrentPlayer,73)=0 Then
              lStates(CurrentPlayer,73)=2:SetLightColor L73,lc(SubLevels(CurrentPlayer,Herman)),2
        End If
      Case 4
        If lStates(CurrentPlayer,73)=0 Then
          lStates(CurrentPlayer,73)=2:SetLightColor L73,lc(SubLevels(CurrentPlayer,Herman)),2
        ElseIf lStates(CurrentPlayer,51)=0 Then
          lStates(CurrentPlayer,51)=2:SetLightColor L51,lc(SubLevels(CurrentPlayer,Herman)),2
          ElseIf lStates(CurrentPlayer,67)=0 Then
            lStates(CurrentPlayer,67)=2:SetLightColor L67,lc(SubLevels(CurrentPlayer,Herman)),2
            ElseIf lStates(CurrentPlayer,47)=0 Then
              lStates(CurrentPlayer,47)=2:SetLightColor L47,lc(SubLevels(CurrentPlayer,Herman)),2
        End If
    End Select
  End Sub

  Sub AwardHerman()
    D "AwardHerman()"
    DOF 152, DOFPulse
    FlashForMs flasherlight1, 5000, 250, 1
    ' TODO Flash White GI and Ball Save QUICKLY
    'pSetBackFrame "clear.png"
    ModesHeld(CurrentPlayer,Herman)=1
    VideoClip 2000, "","HERMAN IS LATE\rFOR WORK!","","HURRY UP!"
    vpmtimer.addtimer 2500, "HermanHurryDisplay '"  '
'       vpmtimer.addtimer 3000, "RestoreScreen '"
'       vpmtimer.addtimer 3000, "resetbackglass '"
    HermanHurryCnt=2000
    HermanTimer.Interval=100
    HermanTimer.Enabled=True
    L58.blinkinterval=qb
    L59.blinkinterval=qb
    L60.blinkinterval=qb
    lStates(CurrentPlayer,56)=2:SetLightColor L56,green,2
    StopGrandpaL:StopRavenL:StopSpotL
    Dim bulb
    For each bulb in GI
      SetLightColor bulb, green, 1
    Next
    vpmtimer.addtimer 500, "MagnetStart '"  ' Let the ball come down from being hit
  End Sub

  Sub AwardHermanHurry() ' ball knocked off the magnet or released from magnet on sublevel 2&3
    D "AwardHermanHurry()"
    If L18.state=0 Then
      StopRavenL:StopGrandpaL:StopSpotL
      D "AwardHermanHurry() - turn on mode light"
      If Modes(CurrentPlayer,Herman)< 4 Then Modes(CurrentPlayer,Herman)=Modes(CurrentPlayer,Herman)+1
      lStates(CurrentPlayer,18)=2:L18.state=2
      cAwardExtraBallLight()
      AwardKitty()
      PaintModes()
    End If
    If SubLevels(currentplayer,Herman)<3 Then SubLevels(currentplayer,Herman)=SubLevels(currentplayer,Herman)+1
    D "AwardHermanHurry() - sublevels= " & CStr(SubLevels(currentplayer,Herman))
    lStates(CurrentPlayer,56)=2:SetLightColor L56, lc(SubLevels(currentplayer,Herman)),2
    If SubLevels(CurrentPlayer,Herman) > 2 Then
      lStates(CurrentPlayer,58)=0:L58.state=0
    Else
      lStates(CurrentPlayer,58)=2:L58.state=2
    End If
    lStates(CurrentPlayer,59)=0:L59.state=0
    lStates(CurrentPlayer,60)=0:L60.state=0
  End Sub

  Sub ScoreMystery
    SpecialVideoClip 6000, "", "", "", "", "videospecials", "Video-0x0037 - mystery.mp4"
    ScoopDelay=6500
    vpmtimer.addtimer 6500, "AwardMystery '"
    PUP_audioevents "Sound-0x065D - grandpa mystery.mp3"
  End Sub

  Sub AwardMystery
    lStates(CurrentPlayer,103)=0:L103.state=0
    Dim a, p, line0, line1, line2, line3
    a = RndNum(1,14)
    D "ScoreMystery (A)=" & CStr(a)
    line0="":line1="":line2="":line3=""
    If a=1 and lStates(CurrentPlayer,80)<>0 Then a=2
    If a=2 and LilyMode Then a=7
    If a=4 and lStates(CurrentPlayer,18) <> 0 Then a=5
    If a=5 and lStates(CurrentPlayer,22) <> 0 Then a=6
    if a=6 and lStates(CurrentPlayer,21) <> 0 Then a=7
    If a=7 and lStates(CurrentPlayer,62)=2 Then a=8
    If a=8 and l38.state <> 0 Then a=9
    If a=9 and lStates(CurrentPlayer,11)=2 Then a=1
    If a=10 and Not ActiveJackpot(Mystery) Then a=11
    if a=11 and Boost(CurrentPlayer,Herman)=1 then a=12
    if a=12 and Boost(CurrentPlayer,Lily)=1 then a=13
    if a=13 and Boost(CurrentPlayer,Spot)=1 then a=14
    if a=14 and Boost(CurrentPlayer,Grandpa)=1 then a=15
    Select Case a
      case 1
        line0="Light Kitty"
        line3="\r\r\r" & LPad("Shoot Kitty For",40," ") & "\r" & LPad("Playfield Multiplier",40," ")
        AwardKitty()
      case 2
        line0="Award Lily"
        L40.state=1:L41.state=1:L42.state=1:L43.state=1
        lStates(CurrentPlayer,40)=L40.state
        lStates(CurrentPlayer,41)=L41.state
        lStates(CurrentPlayer,42)=L42.state
        lStates(CurrentPlayer,43)=L43.state
        AwardLily()
      case 3
        line0="Award Raven"
        lStates(CurrentPlayer,95)=0:L95.state=0
        lStates(CurrentPlayer,96)=0:L96.state=0
        lStates(CurrentPlayer,97)=0:L97.state=0
        lStates(CurrentPlayer,98)=0:L98.state=0
        lStates(CurrentPlayer,101)=0:L101.state=0
        SetLightColor L19, blue, 1
        If Modes(CurrentPlayer,Raven)<3 Then Modes(CurrentPlayer,Raven)=Modes(CurrentPlayer,Raven)+1
        lStates(CurrentPlayer,19)=1
        p=CalcPoints(Raven, 400000):AddScore p
        AwardKitty()
        PaintModes()
      case 4
        line0="Award Herman"
        lStates(CurrentPlayer,58)=2:L58.state=2
        lStates(CurrentPlayer,59)=0:L59.state=0
        lStates(CurrentPlayer,60)=0:L60.state=0
        SubLevels(CurrentPlayer,Herman)=2
        lStates(CurrentPlayer,56)=1:L56.state=1
        SetLightColor L56, white, 1
        SetLightColor L18, green, 1
        MagnetFlag=False  ' bug fix
        MagnetStop

            lStates(CurrentPlayer,56)=2:SetLightColor L56, lc(SubLevels(currentplayer,Herman)),2
            HermanMode=True
            PuPlayer.LabelSet pBackglass,"BottomBox3","  Herman MB",1,"{'mt':2,'color': " & CStr(fGreen) & ",'fname':" & numberfont & ", 'size': 3.6 }"
            FlashThem()
            AddMultiball 1
            PuPlayer.playlistplayex pCallouts,"audiohermanmultiball","",80,1
            lStates(CurrentPlayer,47)=2:SetLightColor L47,white,2 ' only light jackpots during herman mb
            lStates(CurrentPlayer,51)=2:SetLightColor L51,white,2
            lStates(CurrentPlayer,67)=2:SetLightColor L67,white,2
            lStates(CurrentPlayer,73)=2:SetLightColor L73,white,2
            FlashForMs L18, 3000, 250, 1:lStates(CurrentPlayer,18)=1
            If Modes(CurrentPlayer,Herman)<3 Then Modes(CurrentPlayer,Herman)=Modes(CurrentPlayer,Herman)+1
            PaintModes()
            AwardKitty()
            HermanJackpots=0
            ScorbitBuildGameModes()

        p=CalcPoints(Herman, 400000):AddScore p
      case 5
        line0="Award Grandpa"  'test6
        SetLightColor L22, purple, 1
        If Modes(CurrentPlayer,Grandpa)<3 Then Modes(CurrentPlayer,Grandpa)=Modes(CurrentPlayer,Grandpa)+1
        lStates(CurrentPlayer,22)=1
        'JackPots=JackPots+1
        'L30.blinkinterval=260-(JackPots*20):L30.state=2
        SetLightColor L78,purple,0:SetLightColor L79,purple,0
        SetLightColor L81,purple,0:SetLightColor L82,purple,0
        lStates(CurrentPlayer,78)=0:lStates(CurrentPlayer,79)=0
        lStates(CurrentPlayer,81)=0:lStates(CurrentPlayer,82)=0
        lStates(CurrentPlayer,63)=0:lStates(CurrentPlayer,63)=0
        p=CalcPoints(Grandpa, 400000):AddScore p
        AwardKitty()
        PaintModes()
      case 6
        line0="Award Spot"
        lStates(CurrentPlayer,106)=2:L106.state=2  'spot letters
        lStates(CurrentPlayer,107)=0:L107.state=0
        lStates(CurrentPlayer,108)=0:L108.state=0
        lStates(CurrentPlayer,109)=0:L109.state=0
        lStates(CurrentPlayer,89)=2:L89.state=2
        lStates(CurrentPlayer,90)=0:L90.state=0
        lStates(CurrentPlayer,91)=0:L91.state=0
        lStates(CurrentPlayer,92)=0:L92.state=0
        lStates(CurrentPlayer,98)=0:L98.state=0
        lStates(CurrentPlayer,101)=0:L101.state=0
        SyncSpot()
        SetLightColor L21, red, 1
        If Modes(CurrentPlayer,Spot)<3 Then Modes(CurrentPlayer,Spot)=Modes(CurrentPlayer,Spot)+1
        lStates(CurrentPlayer,21)=1
        'JackPots=JackPots+1
        'L30.blinkinterval=260-(JackPots*20):L30.state=2
        p=CalcPoints(Spot, 400000):AddScore p
        AwardKitty()
        PaintModes()
      case 7
        line0="Extra Ball Is Lit" ' at scoop
        lStates(CurrentPlayer, 62)=2:SetLightColor L62,orange,2
        SpecialVideoClip 3500,"","","","","videospecials","Video-0x006B - extraball is lit.mp4"  ' is lit video
        PUP_audioevents "Sound-0x094A - extraball lit.mp3"
        ScoopDelay=3500
      case 8
        line0="Award Max\r Dragula " ' and 5x   'sw28
        DragCnt=DragTime+10
        SetLightColor L29,white,2   '5x
        L32.state = 1:L33.state = 1:L34.state = 1
        L35.state = 1:L36.state = 1:L37.state = 1
        L38.state = 2:p=CalcPoints(Zap, 100000):AddScore p
      case 9
        line0="Special Is Lit"  ' Both Lanes
        lStates(CurrentPlayer,11)=2:SetLightColor L11,red,2
        lStates(CurrentPlayer,15)=2:SetLightColor L15,red,2
      case 10
        line0=""
        SpecialVideoClip 3500,"","","","","videosjp","Video-0x0013 - mystery is lit.mp4"  ' is lit video
        D "Light JackPot"
        JackPots=JackPots+1
        ActiveJackpot(Mystery)=True
        L30.blinkinterval=260-(JackPots*20):L30.state=2
        p=CalcPoints(Zap, 400000):AddScore p
        ScoopDelay=2500
      case 11
        Boost(CurrentPlayer,Herman)=1:line0="Boost Herman"
        hBoostTimer.interval=60000:hBoostTimer.Enabled=True
        PaintModes()
      case 12
        Boost(CurrentPlayer,Lily)=1:line0="Boost Lily"
        lBoostTimer.interval=60000:lBoostTimer.Enabled=True
        PaintModes()
      case 13
        Boost(CurrentPlayer,Spot)=1:line0="Boost Spot"
        sBoostTimer.interval=60000:sBoostTimer.Enabled=True
        PaintModes()
      case 14
        Boost(CurrentPlayer,Grandpa)=1:line0="Boost Grandpa"
        gBoostTimer.interval=60000:gBoostTimer.Enabled=True
        PaintModes()
      case 15
        line0="Mystery Award"
        p=CalcPoints(Zap, 50000*(RndNum(1,5))):AddScore p
        VideoClip 3000, "","\r\r\r\r" & CenterText(16,"Mystery Award\r") & CenterText(18,FormatNumber(p,0)),"",""
    End Select
    TimedText 3000,"\r\r" & line0 & "\r" & line1,line2, line3, fpurple
  End Sub

  Sub ScoreScoop
    Dim p
    p=CalcPoints(Zap, 500*(RndNum(1,10))):AddScore p
    VideoClip 3000, "",LPAD(FormatNumber(p,0),20," "),"",""
  End Sub

Dim stoptimer

  Dim dBall, dZpos
  Sub ScoopEject_hit
    D "ScoopHit"
    Set dBall = ActiveBall
    PlaySound "fx_kicker_enter"
    ResetSkillShot
    dZpos = dBall.Z
    ' if only one ball in play then stop timer until the ball is ejected.
    stoptimer=False
    ClearVideo()
    If BallsOnPlayfield > 1 Then
      If ScreenTimer.Enabled Then
        ScreenTimer.Enabled=False
        stoptimer=True
      End If
    End If
    If MMadnessMode Then
      If L104.state <> 0 Then
        If mMadnessTimer > 0 Then
          mMadnessTimer=20
          If Modes(CurrentPlayer,Madness) > 1 Then mMadnessTimer=10
        End If
      End If
    Else
      If GrandpaMode Then
        If L104.state <> 0 Then
          GrandpaModeTimeRemain=GrandpaModeTimeRemain+10   'Todo If Purple target gets hit, relight L104
          FlashForMs L104, 1000, 50, 0
          bAddTimeAwarded=True
          PUP_audioevents "Sound-0x08D7 - more time.mp3"
          lStates(CurrentPlayer,104)=0
        End If
      Else
        If lStates(CurrentPlayer,63)=2 and Not RavenMode and Not HermanMode and Not SpotMode Then ' labratory is lit
          If not GrandpaMode Then
            stoptimer=True ' wait till we eject before we start timer
            ScreenTimer.Enabled=False
            AwardGrandpa()
          End If
        Else
          If lStates(CurrentPlayer,103)=2 Then 'mystery is lit
            ScoreMystery()
          Else
            If lStates(CurrentPlayer,62)=2 Then ' Score ExtraBall
              bExtraBallWonThisBall=True
              SpecialVideoClip 3500,"","","","","videosjp","Video-0x002E - extra ball.mp4"  ' is lit video
              ExtraBallsAwards(CurrentPlayer)=ExtraBallsAwards(CurrentPlayer)+1
              lStates(CurrentPlayer,62)=0:L62.state=0
              FlashForMs L25, 500, 50, 1
              lStates(CurrentPlayer,25)=1:L25.state=1 ' shoot again
            ElseIf lStates(CurrentPlayer,64) <> 0 Then 'MMadness
              ScoopDelay=22500
              StartMMadnessMode()
            Else 'Score random value
              ScoopDelay=1000
              ScoreScoop()
            End If
          End If
        End If
      End If
    End If
    ScoopEject.TimerInterval = 15
    ScoopEject.TimerEnabled = True
  End Sub

Dim scoopdelay:scoopdelay=0

  Sub ScoopEject_Timer
    Dim p
    dBall.Z = dZpos
    dZpos = dZpos-2
    If dZpos < -24 then me.timerinterval=1000 'slow down before you eject to buy some time
    If dZpos < -30 Then
      FlashForMs F164, 400, 50, 0
      ScoopEject.TimerEnabled = False
      vpmtimer.addtimer ScoopDelay, "ScoopKickOut '"
    End If
  End Sub

  Sub ScoopKickOut
    D "Scoop - eject ball"
    dBall.Z = 35
    If stoptimer Then
      ScreenTimer.Enabled=True
    End If
    FlashThem()
    ScoopEject.Kick 200 + (5 * Rnd()), 8
    Playsound SoundFXDOF("fx_kicker",116,DOFPulse,DOFContactors)
    DOF 115, DOFPulse
    PuPlayer.playlistplayex pCallouts,"audioevents","Sound-0x068 - shoot ballpopper.mp4",100, 1
  End Sub

' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  Pup Stuff
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  Sub D(msg2text)
    debug.print msg2text
  End Sub

  Sub I(msg2text)
    'debug.print msg2text
  End Sub

  Sub PUP_audiocallouts
    D "PUP_audiocallouts"
    PuPlayer.playlistplayex pCallouts,"audiocallouts","",80,1
  End Sub

  Sub PUP_audionoise
    PuPlayer.playlistplayex pAudio,"audionoise","",80,1
  End Sub

  Sub PUP_audionoiseshort
    PuPlayer.playlistplayex pAudio,"audionoiseshort","",80,1
  End Sub

  Sub PUP_audioevents(e)
    D "PUP_audioevents"
    chilloutthemusic
    PuPlayer.playlistplayex pCallouts,"audioevents",e,80,1
  End Sub

  Sub PUP_audiojp(j)
    D "PUP_audiojp"
    PuPlayer.playlistplayex pAudio,"audiojackpot",j,80,1
  End Sub

  Sub PUP_audioeventsRaven(e)
    D "PUP_audioeventsRaven"
    PuPlayer.playlistplayex pCallouts,"audioevents-raven",e,80,1
  End Sub

  Sub PUP_audiodrain
    D "PUP_audiodrain"
    PuPlayer.playlistplayex pAudio,"audiodrain","",80,1
  End Sub

  Sub PUP_videoclips
    D "PUP_videoclips"
    PuPlayer.playlistplayex pBackglass,"videofiller","",100,1
  End Sub

  sub playclear(chan)
    I "play clear'd " & chan
    if chan = pAudio Then
      PuPlayer.playstop pAudio
    End If

    if chan = pMusic Then
      PuPlayer.SendMSG "{ ""mt"":301, ""SN"": 4, ""FN"":11, ""VL"":0 }"
    End If

    if chan = pBackglass Then
      PuPlayer.playstop pBackglass
    end if
  end Sub

  Sub TvText(line1,line2,line3,line4)
    Dim vid, vc
    curPage=2
    PuPlayer.LabelShowPage pBackglass,2,0,""
    vc=fn(GetFolder("videotvclips"),RndNum(1,fn(GetFolder("videotvclips"),0)))
    'D vc & "::" & CStr(GetTime("videotvclips",vc))
    D "TvText Random clip " & GetFolder("videotvclips") & " " & fn(GetFolder("videotvclips"),RndNum(1,fn(GetFolder("videotvclips"),0)))
    ClearPage2Timer.interval = GetTime("videotvclips",vc)
    ClearPage2Timer.Enabled = 1
    PuPlayer.playlistplayex pBackglass,"videotvclips",vc,100,1
    PuPlayer.LabelSet pBackglass,"tvline1",line1,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':6 , 'fname':" & numberfont  & " }"
    PuPlayer.LabelSet pBackglass,"tvline2",line2,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':6 , 'fname':" & stencilfont & " }"
    PuPlayer.LabelSet pBackglass,"tvline3",line3,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':6 , 'fname':" & numberfont  & " }"
    PuPlayer.LabelSet pBackglass,"tvline4",line4,1,"{'mt':2,'color': " & CStr(fwhite) & ", 'size':6 , 'fname':" & numberfont  & " }"
  End Sub

  Sub MovieText(ByVal a, ByVal b)
      PuPlayer.LabelSet pBackglass,"movietitle", CenterText(20,a) & "\r" & CenterText(20,b),1,"{'mt':2,'color':13668647, 'rotation': 10, 'size': 6, 'xpos': 45, 'xalign': 0, 'ypos': 12, 'yalign': 0}"
  End Sub

  Sub HermanShake
    If BashTimer.Enabled=False Then
      hp=0:hc=0:hd=0
      BashTimer.Interval=35:BashTimer.Enabled=True
    End If
  End Sub

Dim hp,hc,hd:hp=0:hc=0:hd=0

  Sub BashTimer_Timer
    D "hp=" & CStr(hp) & " hd=" & CStr(hd) & " hc=" & CStr(hc) & " objrotx =" & CStr( 10+(hp*((25-10)/10))) & " y= " & CStr(330+(hp*((360-330)/10)))
    If hd=0 then
      hp=hp+1
      if hp > 10 then
        hp=10:hd=1
      End If
    Else
      hp=hp-1
      if hp<0 Then
        hp=0
        hd=0
        hc=hc+1
        If hc > 3 Then
          hc=0 ' stop timer
          BashTimer.Enabled=False
        End If
      End If
    End If
        ' 10 iterations to get from pos 360 to 330
    HermanBashToy.objrotx = 10+(hp*((0-10)/10))
    HermanBashToy.y=403+(hp*((403-373)/10))
  End Sub


  Dim DisplayTimerCnt
  DisplayTimer.Enabled = 0

  Sub EndOfBallBonus  'eob
    Dim i, t
    D "EndOfBallBonus"
    ClearPage3Timer_Timer()
    PuPlayer.LabelShowPage pBackglass,3,0,""   'show page 3 - no text
    t=GetTime("videospecials","Video-0x0001 - endofball.mp4")
    PuPlayer.playlistplayex pBackglass,"videospecials","Video-0x0001 - endofball.mp4",100,100
    AreasComplete=0:BallBonus=50000
    AreasComplete=Modes(CurrentPlayer,Herman) + Modes(CurrentPlayer,Spot) + Modes(CurrentPlayer,Grandpa) + Modes(CurrentPlayer,Lily)+Modes(CurrentPlayer,Raven)+Modes(CurrentPlayer,Madness)
    BallBonus=BallBonus + (10000 * AreasComplete)
    DisplayTimer.Interval = 400
    DisplayTimer.Enabled = 1
    DisplayTimerCnt = 0
    PuPlayer.playlistplayex pAudio,"audioclear","clear.mp3",100,1
    PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100,1
  End Sub

  Dim AreasComplete, BallBonus

  Sub DisplayTimer_Timer
    DisplayTimerCnt = DisplayTimerCnt + 1
    Select Case DisplayTimerCnt
      Case 6
        PUP_audioevents "Sound-0x006E - drag sounds.mp3"
      Case 10
        PuPlayer.playstop pAudio
        PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x0189.mp3",90,10
        MovieText CenterText(24,"BASE BONUS"),CenterText(26,FormatNumber(50000,0))
      Case 12
        If AreasComplete>0 Then
          PuPlayer.playstop pAudio
          PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x0189.mp3",90,20
          MovieText CenterText(22,CStr(AreasComplete) & " AREAS COMPLETE"), CenterText(24,FormatNumber(10000*AreasComplete,0))
        End If
      Case 14
        PuPlayer.playstop pAudio
        PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x018A.mp3",90,30
        MovieText CenterText(24,"SUBTOTAL BONUS"), CenterText(26,FormatNumber(50000+(10000*AreasComplete),0))
      Case 16
        If BonusMultiplier(CurrentPlayer)> 1 Then
          PuPlayer.playstop pAudio
          PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x018A.mp3",90,40
          MovieText CenterText(24,"1X"), CenterText(26,FormatNumber(50000+(10000*AreasComplete)*1,0))
        End If
      Case 17
        If BonusMultiplier(CurrentPlayer)> 2 Then
          PuPlayer.playstop pAudio
          PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x018C.mp3",90,50
          MovieText CenterText(24,"2X"), CenterText(26,FormatNumber(50000+(10000*AreasComplete)*2,0))
        End If
      Case 18
        If BonusMultiplier(CurrentPlayer)> 3 Then
          PuPlayer.playstop pAudio
          PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x018C.mp3",90,60
          MovieText CenterText(24,"3X"), CenterText(26,FormatNumber(50000+(10000*AreasComplete)*3,0))
        End If
      Case 19
        If BonusMultiplier(CurrentPlayer)> 4 Then
          PuPlayer.playstop pAudio
          PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x018A.mp3",90,70
          MovieText CenterText(24,CStr(BonusMultiplier(CurrentPlayer)) & "X"), CenterText(26,FormatNumber((50000+(10000*AreasComplete))*BonusMultiplier(CurrentPlayer),0))
        End If
      Case 20
        D "Case 20"
        PuPlayer.playstop pAudio
        PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x0189.mp3",90,80
        MovieText CenterText(24,"TOTAL BONUS"), CenterText(26,FormatNumber( (50000+(10000*AreasComplete))*BonusMultiplier(CurrentPlayer),0))
      Case 25 ' Skip to here if you hold 2 flippers
        D "Case 25"
        PuPlayer.playstop pAudio
        PuPlayer.playlistplayex pAudio,"audionoise","Sound-0x018A.mp3",90,90
        MovieText CenterText(24,"TOTAL BONUS"), CenterText(26,FormatNumber( (50000+(10000*AreasComplete))*BonusMultiplier(CurrentPlayer),0))
        AddScore (50000+(10000*AreasComplete))*BonusMultiplier(CurrentPlayer)
      Case 26
        ClearPage3Timer.interval = 10
        ClearPage3Timer.Enabled = True
      Case 30
        PuPlayer.playstop pAudio
        pStopBackLoop
      Case 32
        DisplayTimerCnt = 0
        DisplayTimer.enabled = 0
        'StopEndOfBallMode
        vpmtimer.addtimer 500, "EndOfBall '"
    End Select
  End Sub


' ------------------------ Parse Puplayer Videos
Function gnGetFileDetails(fo, fn)
        dim objFolder
    gnGetFileDetails = ""
        set objFolder = objShell2.NameSpace(fo)

        if (not objFolder is nothing) then
            dim objFolderItem

            set objFolderItem = objFolder.ParseName(fn)

            if (not objFolderItem Is Nothing) then
                gnGetFileDetails = objFolder.GetDetailsOf(objFolderItem, 27)   '27 length , 2 is type
      end if

            set objFolderItem = nothing
        end if

        set objFolder = nothing
End Function

Function inseconds(s)
  If len(s) = 8 Then inseconds=(mid(s,4,2)*60)+mid(s,7,2) else inseconds=0
End Function

Sub GetTimes(myfolder)
  Dim file, subfolder
  if instr(myfolder.name,"video") > 0 then
    fo(0)=fo(0)+1  ' tally of number of folders processed
    fo(fo(0))=myfolder.Name
    for each file in myfolder.Files
      If file.type = "MP4 File" Then
        fn(fo(0),0)=fn(fo(0),0)+1
        fn(fo(0),fn(fo(0),0))=file.name
        fs(fo(0),fn(fo(0),0))=InSeconds(gnGetFileDetails(folder & myfolder.Name, file.name))
      End If
    Next
  End If
  If myfolder.name = "audiobg" Then
    for each file in myfolder.Files
      If file.type = "MP3 Format Sound" Then
        MaxSongs=MaxSongs+1
        fn(40,MaxSongs)=file.name
    End If
  Next
  End If
  For Each subfolder in myfolder.Subfolders
    GetTimes(subfolder)
  Next
End Sub

Function GetTime(ifo,ifn)
  Dim  a,f,n
  GetTime=2000:f=0:n=0
  For a=1 to fo(0)
    If fo(a)=ifo then
      f=a
      exit for
    End If
  Next
  For a=1 to fn(f,0)
    If fn(f,a) = ifn Then
      n=a
      Exit For
    End If
  Next
  if f <> 0 and n <> 0 Then
    I "Found a match " & ifo & "::" & ifn & ">>>" & fo(f) & "::" & fn(f,n) & " Times: " & CStr(fs(f,n))
    GetTime=fs(f,n)*1000
  End If
End Function

Function GetFolder(ifo)
  Dim a:a=0
  GetFolder=0
  For a=1 to fo(0)
    If fo(a)=ifo then
      GetFolder=a
      exit for
    End If
  Next
End Function

Sub ShowTimes
Dim a,b,s
  for a = 1 to fo(0)
    s=""
    for b = 1 to fn(a,0)
      s = s & fn(a,b) & " time: " & fs(a,b) & vbCrLf
    Next
    debug.print "Folder=" & fo(a) & " Number of files=" & CStr(fn(a,0)) & vbCrLf & " Files: " & vbCrLf & s
next
End Sub
'=================
Dim CoreV:CoreV=1.0

Sub LoadEM
  LoadController("EM")
End Sub

Sub LoadPROC(VPMver, VBSfile, VBSver)
  LoadVBSFiles VPMver, VBSfile, VBSver
  LoadController("PROC")
End Sub

Sub LoadVPM(VPMver, VBSfile, VBSver)
  LoadVBSFiles VPMver, VBSfile, VBSver
  LoadController("VPM")
End Sub

Sub LoadVPMALT(VPMver, VBSfile, VBSver)
  LoadVBSFiles VPMver, VBSfile, VBSver
  LoadController("VPMALT")
End Sub

Sub LoadVBSFiles(VPMver, VBSfile, VBSver)
  On Error Resume Next
  If ScriptEngineMajorVersion < 5 Then MsgBox "VB Script Engine 5.0 or higher required"
  ExecuteGlobal GetTextFile(VBSfile)
  If Err Then MsgBox "Unable to open " & VBSfile & ". Ensure that it is in the same folder as this table. " & vbNewLine & Err.Description
  InitializeOptions
End Sub

Sub LoadVPinMAME
  Set Controller = CreateObject("VPinMAME.Controller")
  If Err Then MsgBox "Can't load VPinMAME." & vbNewLine & Err.Description
  If VPMver > "" Then If Controller.Version < VPMver Or Err Then MsgBox "VPinMAME ver " & VPMver & " required."
  If VPinMAMEDriverVer < VBSver Or Err Then MsgBox VBSFile & " ver " & VBSver & " or higher required."
  On Error Goto 0
End Sub

Sub LoadController(TableType)
  Dim FileObj
  Dim DOFConfig
  Dim TextStr2
  Dim tempC
  Dim count
  Dim ISDOF
  Dim Answer

  B2SOn = False
  B2SOnALT = False
  tempC = 0
  on error resume next
  Set objShell = CreateObject("WScript.Shell")
  objShell.RegRead(directory & "ForceDisableB2S")
  If Err.number <> 0 Then
    PopupMessage = "This latest version of Controller.vbs stores its settings in the registry. To adjust the values, you must use VP 10.2 (or newer) and setup your configuration in the DOF section of the -Keys, Nudge and DOF- dialog of Visual Pinball."
    objShell.RegWrite directory & "ForceDisableB2S",0, "REG_DWORD"
    objShell.RegWrite directory & "DOFContactors",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFKnocker",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFChimes",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFBell",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFGear",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFShaker",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFFlippers",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFTargets",2, "REG_DWORD"
    objShell.RegWrite directory & "DOFDropTargets",2, "REG_DWORD"
    MsgBox PopupMessage
  End If
  tempC = objShell.RegRead(directory & "ForceDisableB2S")
  DOFeffects(1)=objShell.RegRead(directory & "DOFContactors")
  DOFeffects(2)=objShell.RegRead(directory & "DOFKnocker")
  DOFeffects(3)=objShell.RegRead(directory & "DOFChimes")
  DOFeffects(4)=objShell.RegRead(directory & "DOFBell")
  DOFeffects(5)=objShell.RegRead(directory & "DOFGear")
  DOFeffects(6)=objShell.RegRead(directory & "DOFShaker")
  DOFeffects(7)=objShell.RegRead(directory & "DOFFlippers")
  DOFeffects(8)=objShell.RegRead(directory & "DOFTargets")
  DOFeffects(9)=objShell.RegRead(directory & "DOFDropTargets")
  Set objShell = nothing

  If TableType = "PROC" or TableType = "VPMALT" Then
    If TableType = "PROC" Then
      Set Controller = CreateObject("VPROC.Controller")
      If Err Then MsgBox "Can't load PROC"
    Else
      LoadVPinMAME
    End If
    If tempC = 0 Then
      On Error Resume Next
      If Controller is Nothing Then
        Err.Clear
      Else
        Set B2SController = CreateObject("B2S.Server")
        If B2SController is Nothing Then
          Err.Clear
        Else
          B2SController.B2SName = B2ScGameName
          B2SController.Run()
          On Error Goto 0
          B2SOn = True
          B2SOnALT = True
        End If
      End If
    End If
  Else
    If tempC = 0 Then
      On Error Resume Next
      Set Controller = CreateObject("B2S.Server")
      If Controller is Nothing Then
        Err.Clear
        If TableType = "VPM" Then
          LoadVPinMAME
        End If
      Else
        Controller.B2SName = cGameName
        If TableType = "EM" Then
          Controller.Run()
        End If
        On Error Goto 0
        B2SOn = True
      End If
    Else
      If TableType = "VPM" Then
        LoadVPinMAME
      End If
    End If
    Set DOFConfig=Nothing
    Set FileObj=Nothing
  End If
End sub

Function SoundFX (Sound, Effect)
  If ((Effect = 0 And B2SOn) Or DOFeffects(Effect)=1) Then
    SoundFX = ""
  Else
    SoundFX = Sound
  End If
End Function

Function SoundFXDOF (Sound, DOFevent, State, Effect)
  If DOFeffects(Effect)=1 Then
    SoundFXDOF = ""
    DOF DOFevent, State
  ElseIf DOFeffects(Effect)=2 Then
    SoundFXDOF = Sound
    DOF DOFevent, State
  Else
    SoundFXDOF = Sound
  End If
End Function

Function SoundFXDOFALT (Sound, DOFevent, State, Effect)
  If DOFeffects(Effect)=1 Then
    SoundFXDOFALT = ""
    DOFALT DOFevent, State
  ElseIf DOFeffects(Effect)=2 Then
    SoundFXDOFALT = Sound
    DOFALT DOFevent, State
  Else
    SoundFXDOFALT = Sound
  End If
End Function


Sub DOF(DOFevent, State)
  If B2SOn Then
    If State = 2 Then
      Controller.B2SSetData DOFevent, 1:Controller.B2SSetData DOFevent, 0
    Else
      Controller.B2SSetData DOFevent, State
    End If
  End If
End Sub

Sub DOFALT(DOFevent, State)
  If B2SOnALT Then
    If State = 2 Then
      B2SController.B2SSetData DOFevent, 1:B2SController.B2SSetData DOFevent, 0
    Else
      B2SController.B2SSetData DOFevent, State
    End If
  End If
End Sub


  '********************
  ' MATHS
  '********************

Function RndNum(min,max)
   RndNum = Int(Rnd()*(max-min+1))+min     ' Sets a random number between min AND max
End Function

Function Greatest(a,b)
  If a > b then
    Greatest=a
  Else
    Greatest=b
  End If
End Function

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  MANUAL BALLCONTROL
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
  '

Sub StartControl_Hit()
     Set ControlBall = ActiveBall
     contballinplay = true
End Sub

Sub StopControl_Hit()
     contballinplay = false
End Sub

  Dim bcup, bcdown, bcleft, bcright, contball, contballinplay, ControlBall, bcboost
  Dim bcvel, bcyveloffset, bcboostmulti

  bcboost = 1 'Do Not Change - default setting
  bcvel = 4 'Controls the speed of the ball movement
  bcyveloffset = -0.01 'Offsets the force of gravity to keep the ball from drifting vertically on the table, should be negative
  bcboostmulti = 3 'Boost multiplier to ball veloctiy (toggled with the B key)

Sub BallControl_Timer()
     If Contball and ContBallInPlay then
        If bcright = 1 Then
           ControlBall.velx = bcvel*bcboost
        ElseIf bcleft = 1 Then
           ControlBall.velx = - bcvel*bcboost
        Else
           ControlBall.velx=0
        End If

       If bcup = 1 Then
          ControlBall.vely = -bcvel*bcboost
       ElseIf bcdown = 1 Then
          ControlBall.vely = bcvel*bcboost
       Else
          ControlBall.vely= bcyveloffset
       End If
     End If
End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   SHADOWS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X


  '*****************************************
  ' ninuzzu's FLIPPER SHADOWS
  '*****************************************

  sub FlipperTimer_Timer()
    FlipperLSh.RotZ = LeftFlipper.currentangle
    FlipperRSh.RotZ = RightFlipper.currentangle
  End Sub

  '*****************************************
  ' ninuzzu's BALL SHADOW
  '*****************************************
  Dim BallShadow
  BallShadow = Array (BallShadow1,BallShadow2,BallShadow3,BallShadow4,BallShadow5,BallShadow6,BallShadow7)

  Sub BallShadowUpdate_timer()
    Dim BOT, b
    BOT = GetBalls
    ' hide shadow of deleted balls
    If UBound(BOT)<(tnob-1) Then
      For b = (UBound(BOT) + 1) to (tnob-1)
        BallShadow(b).visible = 0
      Next
    End If
    ' exit the Sub if no balls on the table
    If UBound(BOT) = -1 Then Exit Sub
    ' render the shadow for each ball
    For b = 0 to UBound(BOT)
      If BOT(b).X < Table1.Width/2 Then
        BallShadow(b).X = ((BOT(b).X) - (Ballsize/6) + ((BOT(b).X - (Table1.Width/2))/21)) + 6
      Else
        BallShadow(b).X = ((BOT(b).X) + (Ballsize/6) + ((BOT(b).X - (Table1.Width/2))/21)) - 6
      End If
      ballShadow(b).Y = BOT(b).Y + 4
      If BOT(b).Z > 20 Then
        BallShadow(b).visible = 1
      Else
        BallShadow(b).visible = 0
      End If
    Next
  End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   TILT
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  'NOTE: The TiltDecreaseTimer Subtracts .01 from the "Tilt" variable every round

  Sub CheckTilt                                    'Called when table is nudged
    Tilt = Tilt + TiltSensitivity                'Add to tilt count
    TiltDecreaseTimer.Enabled = True
    If(Tilt> TiltSensitivity) AND(Tilt <15) Then 'show a warning
        'PlaySound "buzz"
      ClearScreen
      PuPlayer.playlistplayex pBackglass,"videospecials","Video-0x008F - danger.mp4",100,4
      PlaySoundAt "fx_plungerpull", Plunger
      PuPlayer.playlistplayex pCallouts,"audioevents","Sound-0x05E2 - danger.mp3",100,1
      vpmtimer.addtimer 3000, "RestoreScreen '"
      vpmtimer.addtimer 3000, "resetbackglass '"
      DOF 131, DOFPulse
      DOF 311, DOFPulse  'DOF MX - Tilt Warning
    End if
    If Tilt> 15 Then 'If more that 15 then TILT the table
      Tilted = True
        'PlaySound "powerdownn"
      ClearScreen
      PuPlayer.playlistplayex pBackglass,"videospecials","Video-0x00AF - tilt.mp4",100,4
      PuPlayer.playlistplayex pCallouts,"audioevents","Sound-0x05E2 - danger.mp3",100,1
      DOF 310, DOFPulse   'DOF MX - TILT
      DOF 127, DOFOff   'DOF - Beacon - OFF
      vpmtimer.addtimer 3000, "RestoreScreen '"
      vpmtimer.addtimer 3000, "resetbackglass '"
      DisableTable True
      tilttableclear.enabled = true
      TiltRecoveryTimer.Interval = 1000 ' length of video
      TiltRecoveryTimer.Enabled = True 'start the Tilt delay to check for all the balls to be drained
    End If
  End Sub

  Dim tilttime:tilttime = 0

  sub tilttableclear_timer
    tilttime = tilttime + 1
    Select Case tilttime
      Case 10
        tableclearing
    End Select
  End Sub

  Sub tableclearing
    CarPlunger.Pullback
    PlaySoundAt "fx_plungerpull", CarPlunger
    CarPlunger.Fire
  End Sub

  Sub posttiltreset

  End Sub

  Sub TiltDecreaseTimer_Timer
    ' DecreaseTilt
    If Tilt> 0 Then
      Tilt = Tilt - 0.1
    Else
      TiltDecreaseTimer.Enabled = False
    End If
  End Sub

  Sub DisableTable(Enabled)
    If Enabled Then
      GiOff
      LightSeqTilt.Play SeqAllOff
      LeftFlipper.RotateToStart
      RightFlipper.RotateToStart
      LeftSlingshot.Disabled = 1
      RightSlingshot.Disabled = 1
      PuPlayer.playresume 4
      PuPlayer.playlistplayex pAudio,"audioclear","clear.mp3",100,1
      PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100,1
    Else
      GiOn
      LightSeqTilt.StopPlay
      LeftSlingshot.Disabled = 0
      RightSlingshot.Disabled = 0
    End If
  End Sub

  Sub TiltRecoveryTimer_Timer()
    CarPlunger.Pullback
    PlaySoundAt "fx_plungerpull", CarPlunger
    CarPlunger.Fire
    If(BallsOnPlayfield = 0) Then
      EndOfBall()
      TiltRecoveryTimer.Enabled = False
    End If
  End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   SOUND FUNCTIONS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X


  '*********************************************************************
  '                 Positional Sound Playback Functions
  '*********************************************************************

  ' Play a sound, depending on the X,Y position of the table element (especially cool for surround speaker setups, otherwise stereo panning only)
  ' parameters (defaults): loopcount (1), volume (1), randompitch (0), pitch (0), useexisting (0), restart (1))
  ' Note that this will not work (currently) for walls/slingshots as these do not feature a simple, single X,Y position
  Sub PlayXYSound(soundname, tableobj, loopcount, volume, randompitch, pitch, useexisting, restart)
    PlaySound soundname, loopcount, volume, AudioPan(tableobj), randompitch, pitch, useexisting, restart, AudioFade(tableobj)
  End Sub

  ' Similar subroutines that are less complicated to use (e.g. simply use standard parameters for the PlaySound call)
  Sub PlaySoundAt(soundname, tableobj)
    PlaySound soundname, 1, 50, AudioPan(tableobj), 0,0,0, 1, AudioFade(tableobj)
  End Sub

  Sub PlaySoundAtBall(soundname)
    PlaySoundAt soundname, ActiveBall
  End Sub


  '*********************************************************************
  '                     Supporting Ball & Sound Functions
  '*********************************************************************

  Function AudioFade(tableobj) ' Fades between front and back of the table (for surround systems or 2x2 speakers, etc), depending on the Y position on the table. "table1" is the name of the table
    Dim tmp
    tmp = tableobj.y * 2 / table1.height-1
    If tmp > 0 Then
      AudioFade = Csng(tmp ^10)
    Else
      AudioFade = Csng(-((- tmp) ^10) )
    End If
  End Function

  Function AudioPan(tableobj) ' Calculates the pan for a tableobj based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = tableobj.x * 2 / table1.width-1
    If tmp > 0 Then
      AudioPan = Csng(tmp ^10)
    Else
      AudioPan = Csng(-((- tmp) ^10) )
    End If
  End Function

Function Pan(ball) ' Calculates the pan for a ball based on the X position on the table. "table1" is the name of the table
    Dim tmp
    tmp = ball.x * 2 / table1.width-1
    If tmp > 0 Then
        Pan = Csng(tmp ^10)
    Else
        Pan = Csng(-((- tmp) ^10))
    End If
End Function

  Function Vol(ball) ' Calculates the Volume of the sound based on the ball speed
    Vol = Csng(BallVel(ball) ^2 / 2000)
  End Function

  Function Pitch(ball) ' Calculates the pitch of the sound based on the ball speed
    Pitch = BallVel(ball) * 20
  End Function

  Function BallVel(ball) 'Calculates the ball speed
    BallVel = INT(SQR((ball.VelX ^2) + (ball.VelY ^2) ) )
  End Function

  Dim leftdrop:leftdrop = 0
  Sub leftdrop1_Hit:leftdrop = 1:End Sub
  Sub leftdrop2_Hit
    If leftdrop = 1 then
      PlaySound "fx_ballrampdrop"
    End If
    StopSound "fx_metalrolling"
    leftdrop = 0
  End Sub

  Dim rightdrop:rightdrop = 0
  Sub rightdrop1_Hit:rightdrop = 1:End Sub
  Sub rightdrop2_Hit
    If rightdrop = 1 then
      PlaySound "fx_ballrampdrop"
    End If
    StopSound "fx_metalrolling"
    rightdrop = 0
  End Sub

  Sub PlaySoundVol(soundname, Volume)
    PlaySound soundname, 1, Volume
  End Sub

  '*****************************************
  '      JP's VP10 Rolling Sounds
  '*****************************************

  Const tnob = 7 ' total number of balls
  ReDim rolling(tnob)
  InitRolling

  Sub InitRolling
    Dim i
    For i = 0 to tnob
      rolling(i) = False
    Next
  End Sub

  Sub RollingTimer_Timer()
    Dim BOT, b, ballpitch, ballvol
    BOT = GetBalls

    ' stop the sound of deleted balls
    For b = UBound(BOT) + 1 to tnob - 1
      rolling(b) = False
      StopSound("fx_ballrolling" & b)
    Next

    ' exit the sub if no balls on the table
    If UBound(BOT) = -1 Then Exit Sub 'there no extra balls on this table

    ' play the rolling sound for each ball
    For b = 0 to UBound(BOT)
      If BallVel(BOT(b) )> 1 Then
        If BOT(b).z <30 Then
          ballpitch = Pitch(BOT(b) )
          ballvol = Vol(BOT(b) )
        Else
          ballpitch = Pitch(BOT(b) ) + 25000 'increase the pitch on a ramp
          ballvol = Vol(BOT(b) ) * 10
        End If
        rolling(b) = True
        PlaySound("fx_ballrolling" & b), -1, ballvol, Pan(BOT(b) ), 0, ballpitch, 1, 0, AudioFade(BOT(b) )
      Else
        If rolling(b) = True Then
          StopSound("fx_ballrolling" & b)
          rolling(b) = False
        End If
      End If
    Next
  End Sub

  '**********************
  ' Ball Collision Sound
  '**********************

  Sub OnBallBallCollision(ball1, ball2, velocity)
    PlaySound("fx_collide"), 0, Csng(velocity) ^2 / 2000, AudioPan(ball1), 0, Pitch(ball1), 0, 0, AudioFade(ball1)
  End Sub

  '**************************************
  ' Explanation of the collision routine
  '**************************************

  ' The collision is built in VP.
  ' You only need to add a Sub OnBallBallCollision(ball1, ball2, velocity) and when two balls collide they
  ' will call this routine. What you add in the sub is up to you. As an example is a simple Playsound with volume and paning
  ' depending of the speed of the collision.


  Sub Pins_Hit (idx)
    PlaySound "pinhit_low", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 0, 0, AudioFade(ActiveBall)
  End Sub

  Sub Targets_Hit (idx)
    PlaySound "target", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 0, 0, AudioFade(ActiveBall)
  End Sub

  Sub Metals_Thin_Hit (idx)
    PlaySound "metalhit_thin", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
  End Sub

  Sub Metals_Medium_Hit (idx)
    PlaySound "metalhit_medium", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
  End Sub

  Sub Metals2_Hit (idx)
    PlaySound "metalhit2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
  End Sub

  Sub Gates_Hit (idx)
    PlaySound "fx_gate4", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
  End Sub

  Sub Spinner_Spin
    Dim a
    PlaySound "fx_spinner", 0, .25, AudioPan(Spinner), 0.25, 0, 0, 1, AudioFade(Spinner)
    DOF 124, DOFPulse
    If Not Tilted Then
      AddScore 2500
      If RavenMode Then
        a=Round(ModesHeld(CurrentPlayer,Raven)/60,0)
        ModesHeld(CurrentPlayer,Raven)=ModesHeld(CurrentPlayer,Raven)+1
        If a <> Round(ModesHeld(CurrentPlayer,Raven)/60,0) Then ' change of hours
          If Modes(CurrentPlayer,Raven)>1 Then ' reset all jackpots on Levels 2 and 3
            Shots(1)=1:lStates(CurrentPlayer,47)=2:SetLightColor L47, white, 2
            Shots(2)=1:lStates(CurrentPlayer,51)=2:SetLightColor L51, white, 2
            Shots(3)=1:lStates(CurrentPlayer,67)=2:SetLightColor L67, white, 2
            Shots(4)=1:lStates(CurrentPlayer,73)=2:SetLightColor L73, white, 2
            RavenJackpots=0
          End If
        End If
      End If
    End If
  End Sub

  Sub Rubbers_Hit(idx)
    'D " Rubbers Hit"
    dim finalspeed
    finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
    If finalspeed > 20 then
      PlaySound "fx_rubber2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
    End if
    If finalspeed >= 6 AND finalspeed <= 20 then
      RandomSoundRubber()
    End If
  End Sub

  Sub Posts_Hit(idx)
    dim finalspeed
    finalspeed=SQR(activeball.velx * activeball.velx + activeball.vely * activeball.vely)
    If finalspeed > 16 then
      PlaySound "fx_rubber2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
    End if
    If finalspeed >= 6 AND finalspeed <= 16 then
      RandomSoundRubber()
    End If
  End Sub

  Sub RandomSoundRubber()
    Select Case Int(Rnd*3)+1
      Case 1 : PlaySound "fx_rubber_hit_1", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
      Case 2 : PlaySound "fx_rubber_hit_2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
      Case 3 : PlaySound "fx_rubber_hit_3", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
    End Select
  End Sub

  Sub LeftFlipper_Collide(parm)
    RandomSoundFlipper()
  End Sub

  Sub RightFlipper_Collide(parm)
    RandomSoundFlipper()
  End Sub

  Sub RandomSoundFlipper()
    Select Case Int(Rnd*3)+1
      Case 1 : PlaySound "fx_flip_hit_1", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
      Case 2 : PlaySound "fx_flip_hit_2", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
      Case 3 : PlaySound "fx_flip_hit_3", 0, Vol(ActiveBall), AudioPan(ActiveBall), 0, Pitch(ActiveBall), 1, 0, AudioFade(ActiveBall)
    End Select
  End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  High Scores
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  ' load em up


  Dim hschecker:hschecker = 0


  Sub Loadhs
    Dim x
Exit Sub
    x = LoadValue(TableName, "HighScore1")
    If(x <> "") Then HighScore(0) = CDbl(x) Else HighScore(0) = 1300000 End If

    x = LoadValue(TableName, "HighScore1Name")
    If(x <> "") Then HighScoreName(0) = x Else HighScoreName(0) = "GS" End If

    x = LoadValue(TableName, "HighScore2")
    If(x <> "") then HighScore(1) = CDbl(x) Else HighScore(1) = 1200000 End If

    x = LoadValue(TableName, "HighScore2Name")
    If(x <> "") then HighScoreName(1) = x Else HighScoreName(1) = "JPL" End If

    x = LoadValue(TableName, "HighScore3")
    If(x <> "") then HighScore(2) = CDbl(x) Else HighScore(2) = 1100000 End If

    x = LoadValue(TableName, "HighScore3Name")
    If(x <> "") then HighScoreName(2) = x Else HighScoreName(2) = "MRE" End If

    x = LoadValue(TableName, "HighScore4")
    If(x <> "") then HighScore(3) = CDbl(x) Else HighScore(3) = 1000000 End If

    x = LoadValue(TableName, "HighScore4Name")
    If(x <> "") then HighScoreName(3) = x Else HighScoreName(3) = "DWE" End If

    x = LoadValue(TableName, "TotalGamesPlayed")
    If(x <> "") then TotalGamesPlayed = CInt(x) Else TotalGamesPlayed = 0 End If

    x = LoadValue(TableName, "LastScore1")
    If(x <> "") then LastScore(1) = CDbl(x) Else LastScore(1) = 100000 End If

    x = LoadValue(TableName, "LastScore2")
    If(x <> "") then LastScore(2) = CDbl(x) Else LastScore(2) = 0 End If

    x = LoadValue(TableName, "LastScore3")
    If(x <> "") then LastScore(3) = CDbl(x) Else LastScore(3) = 0 End If

    x = LoadValue(TableName, "LastScore4")
    If(x <> "") then LastScore(4) = CDbl(x) Else LastScore(4) = 0 End If
' --- Extra High Scores
    x = LoadValue(TableName, "HermanChampion")
    If(x <> "") then Champion(Herman) = x Else Champion(Herman) = "DWE" End If
    x = LoadValue(TableName, "HermanChampionScore")
    If(x <> "") then ChampionScore(Herman) = CDbl(x) Else ChampionScore(Herman) = 0 End If

    x = LoadValue(TableName, "GrandpaChampion")
    If(x <> "") then Champion(Grandpa) = x Else Champion(Grandpa) = "DWE" End If
    x = LoadValue(TableName, "GrandpaChampionScore")
    If(x <> "") then ChampionScore(Grandpa) = CDbl(x) Else ChampionScore(Grandpa) = 0 End If

    x = LoadValue(TableName, "LilyChampion")
    If(x <> "") then Champion(Lily) = x Else Champion(Lily) = "DWE" End If
    x = LoadValue(TableName, "LilyChampionScore")
    If(x <> "") then ChampionScore(Lily) = CDbl(x) Else ChampionScore(Lily) = 0 End If

    x = LoadValue(TableName, "SpotChampion")
    If(x <> "") then Champion(Spot) = x Else Champion(Spot) = "DWE" End If
    x = LoadValue(TableName, "SpotChampionScore")
    If(x <> "") then ChampionScore(Spot) = CDbl(x) Else ChampionScore(Spot) = 0 End If

    x = LoadValue(TableName, "RavenChampion")
    If(x <> "") then Champion(Raven) = x Else Champion(Raven) = "DWE" End If
    x = LoadValue(TableName, "RavenChampionScore")
    If(x <> "") then ChampionScore(Raven) = CDbl(x) Else ChampionScore(Raven) = 0 End If

    x = LoadValue(TableName, "MadnessChampion")
    If(x <> "") then Champion(Madness) = x Else Champion(Madness) = "DWE" End If
    x = LoadValue(TableName, "MadnesshampionScore")
    If(x <> "") then ChampionScore(Madness) = CDbl(x) Else ChampionScore(Madness) = 0 End If

    x = LoadValue(TableName, "ZapChampion")
    If(x <> "") then Champion(Zap) = x Else Champion(Zap) = "DWE" End If
    x = LoadValue(TableName, "ZapChampionScore")
    If(x <> "") then ChampionScore(Zap) = CDbl(x) Else ChampionScore(Zap) = 0 End If

    If hschecker = 0 Then
    checkorder
    End If
  End Sub


  Dim hs3,hs2,hs1,hs0,hsn3,hsn2,hsn1,hsn0

  Sub checkorder
    D "CheckOrder"
    hschecker = 1
    hs3 = HighScore(3)
    hs2 = HighScore(2)
    hs1 = HighScore(1)
    hs0 = HighScore(0)
    hsn3 = HighScoreName(3)
    hsn2 = HighScoreName(2)
    hsn1 = HighScoreName(1)
    hsn0 = HighScoreName(0)
    If hs3 > hs0 Then
      HighScore(0) = hs3
      HighScoreName(0) = hsn3
      HighScore(1) = hs0
      HighScoreName(1) = hsn0
      HighScore(2) = hs1
      HighScoreName(2) = hsn1
      HighScore(3) = hs2
      HighScoreName(3) = hsn2

    ElseIf hs3 > hs1 Then
      HighScore(0) = hs0
      HighScoreName(0) = hsn0
      HighScore(1) = hs3
      HighScoreName(1) = hsn3
      HighScore(2) = hs1
      HighScoreName(2) = hsn1
      HighScore(3) = hs2
      HighScoreName(3) = hsn2
    ElseIf hs3 > hs2 Then
      HighScore(0) = hs0
      HighScoreName(0) = hsn0
      HighScore(1) = hs1
      HighScoreName(1) = hsn1
      HighScore(2) = hs3
      HighScoreName(2) = hsn3
      HighScore(3) = hs2
      HighScoreName(3) = hsn2
    ElseIf hs3 < hs2 Then
      HighScore(0) = hs0
      HighScoreName(0) = hsn0
      HighScore(1) = hs1
      HighScoreName(1) = hsn1
      HighScore(2) = hs2
      HighScoreName(2) = hsn2
      HighScore(3) = hs3
      HighScoreName(3) = hsn3
    End If

    savehs
  End Sub


  Sub Savehs
    D "Savehs"
    SaveValue TableName, "HighScore1", HighScore(0)
    SaveValue TableName, "HighScore1Name", HighScoreName(0)
    SaveValue TableName, "HighScore2", HighScore(1)
    SaveValue TableName, "HighScore2Name", HighScoreName(1)
    SaveValue TableName, "HighScore3", HighScore(2)
    SaveValue TableName, "HighScore3Name", HighScoreName(2)
    SaveValue TableName, "HighScore4", HighScore(3)
    SaveValue TableName, "HighScore4Name", HighScoreName(3)
    SaveValue TableName, "HermanChampion",Champion(Herman)
    SaveValue TableName, "HermanChampionScore",ChampionScore(Herman)
    SaveValue TableName, "GrandpaChampion",Champion(Grandpa)
    SaveValue TableName, "GrandpaChampionScore",ChampionScore(Grandpa)
    SaveValue TableName, "LilyChampion",Champion(Lily)
    SaveValue TableName, "LilyChampionScore",ChampionScore(Lily)
    SaveValue TableName, "SpotChampion",Champion(Spot)
    SaveValue TableName, "SpotChampionScore",ChampionScore(Spot)
    SaveValue TableName, "RavenChampion",Champion(Raven)
    SaveValue TableName, "RavenChampionScore",ChampionScore(Raven)
    SaveValue TableName, "MadnessChampion",Champion(Madness)
    SaveValue TableName, "MadnessChampionScore",ChampionScore(Madness)
    SaveValue TableName, "ZapChampion",Champion(Zap)
    SaveValue TableName, "ZapChampionScore",ChampionScore(Zap)
  End Sub

  Sub Savegp
    SaveValue TableName, "TotalGamesPlayed", TotalGamesPlayed
    vpmtimer.addtimer 1000, "Loadhs'"
  End Sub

  ' Initials

  Dim hsbModeActive:hsbModeActive = False
  Dim hsEnteredName
  Dim hsEnteredDigits(3)
  Dim hsCurrentDigit
  Dim hsValidLetters
  Dim hsCurrentLetter
  Dim hsLetterFlash

  ' Check the scores to see if you got one

  Sub HighScoreEntryInit()
    Dim NameStr
    D "HighScoreEntryInit() - making hsbModeActive=True"
    NameStr=""
    if Scorbit.bSessionActive then
      NameStr=Scorbit.GetName(CurrentPlayer)
debug.print "Name:" & NameStr
    End if

    If NameStr="" then
      hsbModeActive = True
      inhighscore = True
      ClearScreen
      PuPlayer.LabelShowPage pBackglass,1,0,""   'show page 1

      hsEnteredDigits(1) = "A"
      hsEnteredDigits(2) = " "
      hsEnteredDigits(3) = " "

      hsCurrentDigit = 1
      Pup_audioevents "Sound-0x095E - high score.mp3"
      PuPlayer.playlistplayex pBackglass,"videobackground","",100,7
      PuPlayer.SetLoop 2,1
      HighScoreDisplayName()
      HighScoreLabels
    Else
      hsEnteredDigits(1) = NameStr
      hsEnteredDigits(2) = ""
      hsEnteredDigits(3) = ""
      HighScoreCommitName
      Pup_audioevents "Sound-0x095E - high score.mp3"
      PuPlayer.playlistplayex pBackglass,"videobackground","",100,7
      PuPlayer.LabelSet pBackglass,"HighScoreL1",NameStr,1,""
    End If



    D "HighScoreEntryInit() - Done"
  End Sub

  Sub CheckHighscore()
    D "CheckHighScore()"
    Dim tmp
    tmp = Score(CurrentPlayer)

    If tmp > HighScore(3) or _
                        ModeTotal(CurrentPlayer,Herman) > ChampionScore(Herman) or  _
                        ModeTotal(CurrentPlayer,Grandpa) > ChampionScore(Grandpa) or _
                        ModeTotal(CurrentPlayer,Lily) > ChampionScore(Lily) or  _
                    ModeTotal(CurrentPlayer,Spot) > ChampionScore(Spot) or  _
                        ModeTotal(CurrentPlayer,Raven) > ChampionScore(Raven) or _
                        ModeTotal(CurrentPlayer,Madness) > ChampionScore(Madness) or _
                        ModeTotal(CurrentPlayer,Zap) > ChampionScore(Zap) Then
      AwardSpecial
      HighScore(3) = tmp
      'enter player's name
      HighScoreEntryInit()
      DOF 403, DOFPulse   'DOF MX - Hi Score
    Else
      EndOfBallComplete
      hsbModeActive = False
    End If
    D "CheckHighScore() - Done"
  End Sub
  ' flipper moving around the letters

  Sub EnterHighScoreKey(keycode)
    D "EnterHighScoreKey kc=" & keycode
    If keycode = LeftFlipperKey Then
      Playsound "fx_previous"
        If hsletter = 0 Then
          hsletter = 26
        Else
          hsLetter = hsLetter - 1
        End If
        HighScoreDisplayName()
    End If

    If keycode = RightFlipperKey Then
      Playsound "fx_next"
        If hsletter = 26 Then
          hsletter = 0
        Else
          hsLetter = hsLetter + 1
        End If
        HighScoreDisplayName()
    End If

    If keycode = StartGameKey or keycode = PlungerKey Then
      PlaySound "success"
        If hsCurrentDigit = 3 Then
          If hsletter = 0 Then
            hsCurrentDigit = hsCurrentDigit -1
          Else
            assignletter
            vpmtimer.addtimer 700, "HighScoreCommitName()'"
          End If
        End If
        If hsCurrentDigit < 3 Then
          If hsletter = 0 Then
            If hsCurrentDigit = 1 Then
            Else
              hsCurrentDigit = hsCurrentDigit -1
            End If
          Else
            assignletter
            hsCurrentDigit = hsCurrentDigit + 1
            HighScoreDisplayName()

          End If
        End If
    End if
  End Sub

  Dim hsletter
  hsletter = 1

  dim hsdigit:hsdigit = 1

  Sub assignletter
    Dim letters:Letters="ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    if hscurrentdigit = 1 Then hsdigit = 1
    if hscurrentdigit = 2 Then hsdigit = 2
    if hscurrentdigit = 3 Then hsdigit = 3
    hsEnteredDigits(hsdigit)=mid(Letters,hsletter,1)
  End Sub

  Sub HighScorelabels
    PuPlayer.LabelSet pBackglass,"HighScore","YOU GOT A\rHIGH SCORE!",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL1","A",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL2"," ",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL3"," ",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL4",Score(CurrentPlayer),1,""
    hsletter = 1
  End Sub

  Sub HighScoreDisplayName()
    Dim letters:Letters="<ABCDEFGHIJKLMNOPQRSTUVWXYZ"
    if(hsCurrentDigit = 1) then PuPlayer.LabelSet pBackglass,"HighScoreL1",mid(Letters,hsLetter+1,1),1,""
    if(hsCurrentDigit = 2) then PuPlayer.LabelSet pBackglass,"HighScoreL2",mid(Letters,hsLetter+1,1),1,""
    if(hsCurrentDigit = 3) then PuPlayer.LabelSet pBackglass,"HighScoreL3",mid(Letters,hsLetter+1,1),1,""
  End Sub

  ' post the high score letters

  Sub HighScoreCommitName()
    D "HighScoreCommitName"
    If ModeTotal(CurrentPlayer,Madness) > ChampionScore(Madness) Then PUP_audioevents "Sound-0x082F - mm champion.mp3"
    hsbModeActive = False
    hsEnteredName = hsEnteredDigits(1) & hsEnteredDigits(2) & hsEnteredDigits(3)
    If ModeTotal(CurrentPlayer,Herman) > ChampionScore(Herman) Then ChampionScore(Herman) = ModeTotal(CurrentPlayer,Herman):Champion(Herman)=hsEnteredName
    If ModeTotal(CurrentPlayer,Grandpa) > ChampionScore(Grandpa) Then ChampionScore(Grandpa) = ModeTotal(CurrentPlayer,Grandpa):Champion(Grandpa)=hsEnteredName
    If ModeTotal(CurrentPlayer,Lily) > ChampionScore(Lily) Then ChampionScore(Lily) = ModeTotal(CurrentPlayer, Lily):Champion(Lily)=hsEnteredName
    If ModeTotal(CurrentPlayer,Spot) > ChampionScore(Spot) Then ChampionScore(Spot) = ModeTotal(CurrentPlayer, Spot):Champion(Spot)=hsEnteredName
    If ModeTotal(CurrentPlayer,Raven) > ChampionScore(Raven) Then ChampionScore(Raven) = ModeTotal(CurrentPlayer, Raven):Champion(Raven)=hsEnteredName
    If ModeTotal(CurrentPlayer,Madness) > ChampionScore(Madness) Then ChampionScore(Madness) = ModeTotal(CurrentPlayer, Madness):Champion(Madness)=hsEnteredName
    If ModeTotal(CurrentPlayer,Zap) > ChampionScore(Zap) Then ChampionScore(Zap) = ModeTotal(CurrentPlayer, Zap):Champion(Zap)=hsEnteredName
    if Score(CurrentPlayer) = HighScore(3) Then HighScoreName(3) = hsEnteredName
    checkorder
    osbtemp=hsEnteredName
    EndOfBallComplete()
    D "EndofBallComplete has returned..."
    inhighscore = False
    PuPlayer.LabelSet pBackglass,"HighScore","",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL1","",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL2"," ",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL3"," ",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL4"," ",1,""
  End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  BUMPERS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX


  'Sub Bumper003_Timer:BS003.visible = 1:End Sub
  'Sub Bumper002_Timer:BS002.visible = 1:End Sub
  'Sub Bumper001_Timer:BS001.visible = 1:End Sub

  Sub Bumper001_Hit
    Dim p
    If NOT Tilted Then
      BS001.visible = 0:me.timerenabled = 1
      PlaySoundAt SoundFXDOF("fx_bumper", 109, DOFPulse, DOFContactors), ActiveBall
      DOF 112, DOFPulse
      DOF 302, DOFPulse   'DOF MX - Bumper 1
      FlashForMs B1L1, 1000, 50, 1:FlashForMs B1L2, 1000, 50, 1:FlashForMs F169, 1000, 50, 1:FlashForMs F171, 150, 50, 0
      If SuperPopsTimer.Enabled Then
        spops=spops+1
        p=CalcPoints(Zap, 500+(spops*3)):AddScore p
        If CurPage=2 Then
          PuPlayer.LabelSet pBackglass,"randomtxt",FormatNumber(p,0),1,"{'mt':2, 'xpos': " & CStr(15+RndNum(0,50)) & ", 'ypos': " & CStr(20+RndNum(0,60)) & " }" 'rrrrr
          vpmtimer.addtimer 500, "ClearRandomTxt '"
        End If
      Else
        p=CalcPoints(Zap, 100):AddScore p
      End If
    End If
  End Sub

  Sub Bumper002_Hit
    Dim p
    If NOT Tilted Then
      BS002.visible = 0:me.timerenabled = 1
      PlaySoundAt SoundFXDOF("fx_bumper", 107, DOFPulse, DOFContactors), ActiveBall
      PUP_audionoiseshort
      DOF 110, DOFPulse
      DOF 303, DOFPulse   'DOF MX - Bumper 2
      FlashForMs B2L1, 1000, 50, 1:FlashForMs B2L2, 1000, 50, 1:FlashForMs F168, 1000, 50, 1:FlashForMs F171, 150, 50, 0
      If SuperPopsTimer.Enabled Then
        spops=spops+1
        p=CalcPoints(Zap, 500+(spops*3)):AddScore p
        FlashThem
      Else
        p=CalcPoints(Zap, 100):AddScore p
        If CurPage=2 Then
          PuPlayer.LabelSet pBackglass,"randomtxt2",FormatNumber(p,0),1,"{'mt':2, 'xpos': " & CStr(15+RndNum(0,50)) & ", 'ypos': " & CStr(20+RndNum(0,60)) & " }" 'rrrrr
          vpmtimer.addtimer 500, "ClearRandomTxt2 '"
        End If
      End If
    End If
  End Sub

  Sub Bumper003_Hit
    Dim p
    If NOT Tilted Then
      BS003.visible = 0:me.timerenabled = 1
      PlaySoundAt SoundFXDOF("fx_bumper", 108, DOFPulse, DOFContactors), ActiveBall
      DOF 111, DOFPulse
      DOF 304, DOFPulse   'DOF MX - Bumper 3
      FlashForMs B3L1, 1000, 50, 1:FlashForMs B3L2, 1000, 50, 1:FlashForMs F170, 1000, 50, 1:FlashForMs F171, 150, 50, 0
      If SuperPopsTimer.Enabled Then
        spops=spops+1
        p=CalcPoints(Zap, 500+(spops*3)):AddScore p
      Else
        p=CalcPoints(Zap, 100):AddScore p
        If CurPage=2 Then
          PuPlayer.LabelSet pBackglass,"randomtxt",FormatNumber(p,0),1,"{'mt':2, 'xpos': " & CStr(15+RndNum(0,50)) & ", 'ypos': " & CStr(20+RndNum(0,60)) & " }" 'rrrrr
          vpmtimer.addtimer 500, "ClearRandomTxt '"
        End If
      End If
    End If
  End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  CINEMATIC SKIPPING
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X

  Dim ldown:ldown = 0
  Dim rdown:rdown = 0

  Sub checkdown
    'D "checkdown Left:" & ldown & " Right:" & rdown
    If ldown + rdown = 2 Then
      skipscene
    End If
  End Sub

  Sub skipscene
    'D "sub skipscene()"
    ' if showing endballbonus then skip to End
    If DisplayTimerCnt > 3 and DisplayTimerCnt < 25 Then
      'D "skip the bonuses pages"
      DisplayTimerCnt = 24
    End If
  End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  LIGHTING / RAINBOW LIGHTS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'

  Sub FlashThem
    FlashForMs FlasherSpot001, 300, 50, 0
    FlashForMs FlasherSpot002, 300, 50, 0
    FlashForMs FlasherSpot003, 300, 50, 0
    FlashForMs FlasherSpot004, 300, 50, 0
    FlashForMs FlasherSpot005, 300, 50, 0
  End Sub

  '********************************************************************************************
  ' Only for VPX 10.2 and higher.
  ' FlashForMs will blink light or a flasher for TotalPeriod(ms) at rate of BlinkPeriod(ms)
  ' When TotalPeriod done, light or flasher will be set to FinalState value where
  ' Final State values are:   0=Off, 1=On, 2=Return to previous State
  '********************************************************************************************

  Sub FlashForMs(MyLight, TotalPeriod, BlinkPeriod, FinalState) 'thanks gtxjoe for the first version
    I "FlashForMS"
    If TypeName(MyLight) = "Light" Then
      If FinalState = 2 Then
        FinalState = MyLight.State 'Keep the current light state
      End If
      MyLight.IntensityScale=1
      MyLight.BlinkInterval = BlinkPeriod
      MyLight.Duration 2, TotalPeriod, FinalState
    ElseIf TypeName(MyLight) = "Flasher" Then
      Dim steps
      MyLight.IntensityScale=1
      ' Store all blink information
      steps = Int(TotalPeriod / BlinkPeriod + .5) 'Number of ON/OFF steps to perform
      If FinalState = 2 Then                      'Keep the current flasher state
        FinalState = ABS(MyLight.Visible)
      End If
      MyLight.UserValue = steps * 10 + FinalState 'Store # of blinks, and final state
      ' Start blink timer and create timer subroutine
      MyLight.TimerInterval = BlinkPeriod
      MyLight.TimerEnabled = 0
      MyLight.TimerEnabled = 1
      ExecuteGlobal "Sub " & MyLight.Name & "_Timer:" & "Dim tmp, steps, fstate:tmp=me.UserValue:fstate = tmp MOD 10:steps= tmp\10 -1:Me.Visible = steps MOD 2:me.UserValue = steps *10 + fstate:If Steps = 0 then Me.Visible = fstate:Me.TimerEnabled=0:End if:End Sub"
    End If
  End Sub

  '******************************************
  ' Change light color - simulate color leds
  ' changes the light color and state
  ' 10 colors: red, orange, amber, yellow...
  '******************************************
  ' in this table this colors are use to keep track of the progress during the acts and battles

  'colors
  Dim red, orange, amber, yellow, darkgreen, green, blue, lightblue, darkblue, purple, white, base

  red = 10
  orange = 9
  amber = 8
  yellow = 7
  darkgreen = 6
  green = 5
  blue = 4
  darkblue = 3
  purple = 2
  white = 1
  base = 11
  lightblue=12
  Dim lc(4): lc(1)=green:lc(2)=white:lc(3)=darkblue:lc(4)=red

  Sub SetLightColor(n, col, stat)
    Select Case col
      Case red
        n.color = RGB(133, 0, 0)
        n.colorfull = RGB(255, 0, 0)
      Case orange
        n.color = RGB(133, 69, 0)
        n.colorfull = RGB(255, 64, 0)
      Case amber
        n.color = RGB(193, 49, 0)
        n.colorfull = RGB(255, 191, 0)
      Case yellow
        n.color = RGB(18, 18, 0)
        n.colorfull = RGB(255, 255, 0)
      Case darkgreen
        n.color = RGB(0, 8, 0)
        n.colorfull = RGB(0, 64, 0)
      Case green
        n.color = RGB(0, 18, 0)
        n.colorfull = RGB(0, 255, 0)
      Case blue
        n.color = RGB(0, 18, 18)
        n.colorfull = RGB(0, 255, 255)
      Case darkblue
        n.color = RGB(0, 8, 8)
        n.colorfull = RGB(0, 64, 64)
      Case purple
        n.color = RGB(128, 0, 128)
        n.colorfull = RGB(255, 0, 255)
      Case white
        n.color = RGB(255, 252, 224)
        n.colorfull = RGB(193, 91, 0)
      Case base
        n.color = RGB(255, 197, 143)
        n.colorfull = RGB(255, 255, 236)
      Case lightblue
        n.color = RGB(0, 83, 128)
        n.colorfull = RGB(2, 148, 227)
      Case Else
        D "Invalid Color c:" & Cstr(col)
    End Select
    If stat <> -1 Then
      n.State = 0
      n.State = stat
    End If
  End Sub

  Sub ResetAllLightsColor ' Called at a new game
    Dim a
    For each a in draglights
      a.BlinkInterval=sb
    Next
    SetLightColor L12,red,-1
    SetLightColor L14,red,-1
    SetLightColor L47,white,-1  'Shots
    SetLightColor L51,white,-1
    SetLightColor L67,white,-1
    SetLightColor L73,white,-1
    SetLightColor L17,white, -1
    SetLightColor L18,green, -1
    SetLightColor L19,blue, -1
    SetLightColor L20,orange, -1
    SetLightColor L21,red, -1
    SetLightColor L22,purple, -1
    SetLightColor L23,green, -1
    SetLightColor L24,green, -1

    SetLightColor L106,orange, -1
    SetLightColor L107,orange, -1
    SetLightColor L108,orange, -1
    SetLightColor L109,orange, -1

    SetLightColor L58,green, -1
    SetLightColor L59,green, -1
    SetLightColor L60,green, -1
    SetLightColor L63,purple, -1
    SetLightColor L80,green, -1

    SetLightColor L98,red,-1
    SetLightColor L101,red,-1
    SetLightColor L78,purple, -1
    SetLightColor L79,purple, -1
    SetLightColor L81,purple, -1
    SetLightColor L82,purple, -1
    SetLightColor L56, white,-1
    SetLightColor L13,yellow, -1
    SetLightColor L28,orange, -1
    SetLightColor L29,white, -1
    SetLightColor L30,red, -1
    SetLightColor L64,white, -1
    SetLightColor L103,orange, -1
    SetLightColor L104,green, -1
    SetLightColor L81,blue, -1
    SetLightColor L86,yellow, -1
    SetLightColor L87,yellow, -1
    SetLightColor L40,orange,-1
    SetLightColor L41,orange,-1
    SetLightColor L42,orange,-1
    SetLightColor L43,orange,-1
  End Sub

  Sub UpdateBonusColors
  End Sub

  '*************************
  ' Rainbow Changing Lights
  '*************************

  Dim RGBStep, RGBFactor, rRed, rGreen, rBlue, RainbowLights

  Sub StartRainbow(n)
    set RainbowLights = n
    RGBStep = 0
    RGBFactor = 5
    rRed = 255
    rGreen = 0
    rBlue = 0
    RainbowTimer.Enabled = 1
  End Sub

  Dim RGBStep2, RGBFactor2, rRed2, rGreen2, rBlue2, RainbowLights2
  Sub StartRainbow2(n)
    set RainbowLights2 = n
    RGBStep2 = 0
    RGBFactor2 = 5
    rRed2 = 255
    rGreen2 = 0
    rBlue2 = 0
    RainbowTimer1.Enabled = 1
  End Sub

  Sub StopRainbow(n)
    Dim obj
    RainbowTimer.Enabled = 0
    RainbowTimer.Enabled = 0
      For each obj in RainbowLights
        SetLightColor obj, white, 0
      Next
  End Sub

  Sub StopRainbow2(n)
    Dim obj
    RainbowTimer1.Enabled = 0
      For each obj in RainbowLights2
        SetLightColor obj, white, 0
        obj.state = 1
        obj.Intensity = 15
      Next
  End Sub

  Sub RainbowTimer_Timer 'rainbow led light color changing
    Dim obj
    Select Case RGBStep
      Case 0 'Green
        rGreen = rGreen + RGBFactor
        If rGreen > 255 then
          rGreen = 255
          RGBStep = 1
        End If
      Case 1 'Red
        rRed = rRed - RGBFactor
        If rRed < 0 then
          rRed = 0
          RGBStep = 2
        End If
      Case 2 'Blue
        rBlue = rBlue + RGBFactor
        If rBlue > 255 then
          rBlue = 255
          RGBStep = 3
        End If
      Case 3 'Green
        rGreen = rGreen - RGBFactor
        If rGreen < 0 then
          rGreen = 0
          RGBStep = 4
        End If
      Case 4 'Red
        rRed = rRed + RGBFactor
        If rRed > 255 then
          rRed = 255
          RGBStep = 5
        End If
      Case 5 'Blue
        rBlue = rBlue - RGBFactor
        If rBlue < 0 then
          rBlue = 0
          RGBStep = 0
        End If
    End Select
      For each obj in RainbowLights
        obj.color = RGB(rRed \ 10, rGreen \ 10, rBlue \ 10)
        obj.colorfull = RGB(rRed, rGreen, rBlue)
      Next
  End Sub

  Sub RainbowTimer1_Timer 'rainbow led light color changing
    Dim obj
    Select Case RGBStep2
      Case 0 'Green
        rGreen2 = rGreen2 + RGBFactor2
        If rGreen2 > 255 then
          rGreen2 = 255
          RGBStep2 = 1
        End If
      Case 1 'Red
        rRed2 = rRed2 - RGBFactor2
        If rRed2 < 0 then
          rRed2 = 0
          RGBStep2 = 2
        End If
      Case 2 'Blue
        rBlue2 = rBlue2 + RGBFactor2
        If rBlue2 > 255 then
          rBlue2 = 255
          RGBStep2 = 3
        End If
      Case 3 'Green
        rGreen2 = rGreen2 - RGBFactor2
        If rGreen2 < 0 then
          rGreen2 = 0
          RGBStep2 = 4
        End If
      Case 4 'Red
        rRed2 = rRed2 + RGBFactor2
        If rRed2 > 255 then
          rRed2 = 255
          RGBStep2 = 5
        End If
      Case 5 'Blue
        rBlue2 = rBlue2 - RGBFactor2
        If rBlue2 < 0 then
          rBlue2 = 0
          RGBStep2 = 0
        End If
    End Select
'     For each obj in RainbowLights2
'       obj.color = RGB(rRed2 \ 10, rGreen2 \ 10, rBlue2 \ 10)
'       obj.colorfull = RGB(rRed2, rGreen2, rBlue2)
'     Next
  End Sub

  Sub RestoreLights
  End Sub

  Sub StartLightSeq()
    Dim a
    For each a in alights
      a.State = 1
    Next
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqCircleOutOn, 15, 3
    LightSeqAttract.UpdateInterval = 5
    LightSeqAttract.Play SeqRightOn, 50, 1
    LightSeqAttract.UpdateInterval = 5
    LightSeqAttract.Play SeqLeftOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 50, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 40, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 40, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqRightOn, 30, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqLeftOn, 30, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 15, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 15, 1
    LightSeqAttract.UpdateInterval = 10
    LightSeqAttract.Play SeqCircleOutOn, 15, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 5
    LightSeqAttract.Play SeqStripe1VertOn, 50, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe1VertOn, 50, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqCircleOutOn, 15, 2
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqStripe2VertOn, 50, 3
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqRightOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqLeftOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqUpOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    LightSeqAttract.Play SeqDownOn, 25, 1
    LightSeqAttract.UpdateInterval = 8
    For each a in GI
      a.State = 1
      a.Intensity = 80
    Next
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 50, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqCircleOutOn, 15, 2
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 10
    LightSeqAttract2.Play SeqCircleOutOn, 15, 3
    LightSeqAttract2.UpdateInterval = 5
    LightSeqAttract2.Play SeqRightOn, 50, 1
    LightSeqAttract2.UpdateInterval = 5
    LightSeqAttract2.Play SeqLeftOn, 50, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqRightOn, 50, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 50, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqRightOn, 40, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 40, 1
    LightSeqAttract2.UpdateInterval = 10
    LightSeqAttract2.Play SeqRightOn, 30, 1
    LightSeqAttract2.UpdateInterval = 10
    LightSeqAttract2.Play SeqLeftOn, 30, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqRightOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqRightOn, 15, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 15, 1
    LightSeqAttract2.UpdateInterval = 10
    LightSeqAttract2.Play SeqCircleOutOn, 15, 3
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqRightOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 5
    LightSeqAttract2.Play SeqStripe1VertOn, 50, 2
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqCircleOutOn, 15, 2
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqStripe1VertOn, 50, 3
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqRightOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqCircleOutOn, 15, 2
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqStripe2VertOn, 50, 3
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqRightOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqLeftOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqUpOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
    LightSeqAttract2.Play SeqDownOn, 25, 1
    LightSeqAttract2.UpdateInterval = 8
  End Sub

  Sub LightSeqAttract_PlayDone()
    StartLightSeq()
  End Sub

  Sub LightSeqTilt_PlayDone()
    LightSeqTilt.Play SeqAllOff
  End Sub

  Sub LightSeqSkillshot_PlayDone()
    LightSeqSkillshot.Play SeqAllOff
  End Sub



  '**********************
  '     GI effects
  ' independent routine
  ' it turns on the gi
  ' when there is a ball
  ' in play
  '**********************

  Dim OldGiState
  OldGiState = -1   'start witht the Gi off

  Sub ChangeGi(col) 'changes the gi color
    I "ChangeGI" & Cstr(Col)
    Dim bulb
    For each bulb in GI
      SetLightColor bulb, col, -1
    Next
  End Sub

  Sub GIUpdateTimer_Timer
    Dim tmp, obj
    tmp = Getballs
    If UBound(tmp) <> OldGiState Then
      OldGiState = Ubound(tmp)
      If UBound(tmp) = 3 Then 'we have 4 captive balls on the table (-1 means no balls, 0 is the first ball, 1 is the second..)
        'GiOff               ' turn off the gi if no active balls on the table, we could also have used the variable ballsonplayfield.
      Else
        'Gion
      End If
    End If
  End Sub

  Sub GiOn
    DOF 126, DOFOn
    Dim bulb
    For each bulb in GI
      SetLightColor bulb, white, -1
      bulb.State = 1
    Next
    For each bulb in GIGreen
      SetLightColor bulb, green, -1
      bulb.State = 1
    Next
  End Sub

  Sub GiOff
    DOF 126, DOFOff
    Dim bulb
    For each bulb in GI
      bulb.State = 0
    Next
  End Sub

  Sub GiAllOff
    DOF 126, DOFOff
    Dim bulb
    For each bulb in GI
      bulb.State = 0
    Next
    For each bulb in GIGreen
      bulb.State = 0
    Next
  End Sub

  Sub GiAllOn
    DOF 126, DOFOn
    Dim bulb
    For each bulb in GI
      SetLightColor bulb, white, -1
      bulb.State = 1
    Next
    For each bulb in GIGreen
      SetLightColor bulb, green, -1
      bulb.State = 1
    Next
  End Sub

  ' GI & light sequence effects


  Sub GiEffect(n)
    Select Case n
      Case 0 'all off
        'LightSeqGi.Play SeqAlloff
      Case 1 'all blink
        'LightSeqGi.UpdateInterval = 4
        'LightSeqGi.Play SeqBlinking, , 5, 100
      Case 2 'random
        'LightSeqGi.UpdateInterval = 10
        'LightSeqGi.Play SeqRandom, 5, , 1000
      Case 3 'upon
        'LightSeqGi.UpdateInterval = 4
        'LightSeqGi.Play SeqUpOn, 5, 1
      Case 4 ' left-right-left
        'LightSeqGi.UpdateInterval = 5
        'LightSeqGi.Play SeqLeftOn, 10, 1
        'LightSeqGi.UpdateInterval = 5
        'LightSeqGi.Play SeqRightOn, 10, 1
    End Select
  End Sub

  Sub LightEffect(n)
    Select Case n
      Case 0 ' all off
        'LightSeqInserts.Play SeqAlloff
      Case 1 'all blink
        'LightSeqInserts.UpdateInterval = 4
        'LightSeqInserts.Play SeqBlinking, , 5, 100
      Case 2 'random
        'LightSeqInserts.UpdateInterval = 10
        'LightSeqInserts.Play SeqRandom, 5, , 1000
      Case 3 'upon
        'LightSeqInserts.UpdateInterval = 4
        'LightSeqInserts.Play SeqUpOn, 10, 1
      Case 4 ' left-right-left
        'LightSeqInserts.UpdateInterval = 5
        'LightSeqInserts.Play SeqLeftOn, 10, 1
        'LightSeqInserts.UpdateInterval = 5
        'LightSeqInserts.Play SeqRightOn, 10, 1
      Case 5 'random
    '   LightSeqbumper.UpdateInterval = 4
    '   LightSeqbumper.Play SeqBlinking, , 1, 10
      Case 6 'random
        'LightSeqRSling.UpdateInterval = 4
        'LightSeqRSling.Play SeqBlinking, , 5, 6
      Case 7 'random
        'LightSeqLSling.UpdateInterval = 4
        'LightSeqLSling.Play SeqBlinking, , 5, 6
      Case 8 'random
        'LightSeqBack.UpdateInterval = 4
        'LightSeqBack.Play SeqBlinking, , 5, 6
      Case 12 'random
        'LightSeqlr.UpdateInterval = 4
        'LightSeqlr.Play SeqBlinking, , 5, 10
    End Select
  End Sub

  ' Flasher Effects using lights

  Dim FEStep, FEffect
  FEStep = 0
  FEffect = 0

  Sub FlashEffect(n)
    Select case n
      Case 0 ' all off
        LightSeqFlasher.Play SeqAlloff
      Case 1 'all blink
        LightSeqFlasher.UpdateInterval = 4
        LightSeqFlasher.Play SeqBlinking, , 5, 100
      Case 2 'random
        LightSeqFlasher.UpdateInterval = 10
        LightSeqFlasher.Play SeqRandom, 5, , 1000
      Case 3 'upon
        LightSeqFlasher.UpdateInterval = 4
        LightSeqFlasher.Play SeqUpOn, 10, 1
      Case 4 ' left-right-left
        LightSeqFlasher.UpdateInterval = 5
        LightSeqFlasher.Play SeqLeftOn, 10, 1
        LightSeqFlasher.UpdateInterval = 5
        LightSeqFlasher.Play SeqRightOn, 10, 1
      Case 5 ' top flashers blink fast
    End Select
  End Sub

  '****************************
  ' Flashers - Thanks Flupper
  '****************************
  Dim FlashLevel1, FlashLevel2, FlashLevel3, FlashLevel4, FlashLevel5, FlashLevel6

Flasherlight1.IntensityScale = 0
Flasherlight2.IntensityScale = 0
Flasherlight3.IntensityScale = 0
Flasherlight4.IntensityScale = 0
Flasherlight5.IntensityScale = 0

  Sub Flasherflash1_Timer()
    dim flashx1, matdim
    If not Flasherflash1.TimerEnabled Then
      Flasherflash1.TimerEnabled = True
      Flasherflash1.visible = 1
      Flasherlit1.visible = 1
    End If
    flashx1 = FlashLevel1 * FlashLevel1 * FlashLevel1
    Flasherflash1.opacity = 1500 * flashx1
    Flasherlit1.BlendDisableLighting = 10 * flashx1
    Flasherbase1.BlendDisableLighting =  flashx1
    Flasherlight1.IntensityScale = flashx1
    matdim = Round(10 * FlashLevel1)
    Flasherlit1.material = "domelit" & matdim
    FlashLevel1 = FlashLevel1 * 0.9 - 0.01
    If FlashLevel1 < 0.15 Then
      Flasherlit1.visible = 0
    Else
      Flasherlit1.visible = 1
    end If
    If FlashLevel1 < 0 Then
      Flasherflash1.TimerEnabled = False
      Flasherflash1.visible = 0
    End If
  End Sub

  Sub Flasherflash2_Timer()
    dim flashx2, matdim
    If not Flasherflash2.TimerEnabled Then
      Flasherflash2.TimerEnabled = True
      Flasherflash2.visible = 1
      Flasherlit2.visible = 1
    End If
    flashx2 = FlashLevel2 * FlashLevel2 * FlashLevel2
    Flasherflash2.opacity = 1500 * flashx2
    Flasherlit2.BlendDisableLighting = 10 * flashx2
    Flasherbase2.BlendDisableLighting =  flashx2
    Flasherlight2.IntensityScale = flashx2
    matdim = Round(10 * FlashLevel2)
    Flasherlit2.material = "domelit" & matdim
    FlashLevel2 = FlashLevel2 * 0.9 - 0.01
    If FlashLevel2 < 0.15 Then
      Flasherlit2.visible = 0
    Else
      Flasherlit2.visible = 1
    end If
    If FlashLevel2 < 0 Then
      Flasherflash2.TimerEnabled = False
      Flasherflash2.visible = 0
    End If
  End Sub

  Sub Flasherflash3_Timer()
    On Error Resume Next
    dim flashx3, matdim
    If not Flasherflash3.TimerEnabled Then
      Flasherflash3.TimerEnabled = True
      Flasherflash3.visible = 1
      Flasherlit3.visible = 1
    End If
    flashx3 = FlashLevel3 * FlashLevel3 * FlashLevel3
    Flasherflash3.opacity = 1500 * flashx3
    Flasherlit3.BlendDisableLighting = 10 * flashx3
    Flasherbase3.BlendDisableLighting =  flashx3
    Flasherlight3.IntensityScale = flashx3
    matdim = Round(10 * FlashLevel3)
    Flasherlit3.material = "domelit" & matdim
    FlashLevel3 = FlashLevel3 * 0.9 - 0.01
    If FlashLevel3 < 0.15 Then
      Flasherlit3.visible = 0
    Else
      Flasherlit3.visible = 1
    end If
    If FlashLevel3 < 0 Then
      Flasherflash3.TimerEnabled = False
      Flasherflash3.visible = 0
    End If
  End Sub

  Sub Flasherflash4_Timer()
    On Error Resume Next
    dim flashx4, matdim
    If not Flasherflash4.TimerEnabled Then
      Flasherflash4.TimerEnabled = True
      Flasherflash4.visible = 1
      Flasherlit4.visible = 1
    End If
    flashx4 = FlashLevel4 * FlashLevel4 * FlashLevel4
    Flasherflash4.opacity = 1500 * flashx4
    Flasherlit4.BlendDisableLighting = 10 * flashx4
    Flasherbase4.BlendDisableLighting =  flashx4
    Flasherlight4.IntensityScale = flashx4
    matdim = Round(10 * FlashLevel4)
    Flasherlit4.material = "domelit" & matdim
    FlashLevel4 = FlashLevel4 * 0.9 - 0.01
    If FlashLevel4 < 0.15 Then
      Flasherlit4.visible = 0
    Else
      Flasherlit4.visible = 1
    end If
    If FlashLevel4 < 0 Then
      Flasherflash4.TimerEnabled = False
      Flasherflash4.visible = 0
    End If
  End Sub

  Sub Flasherflash5_Timer()
    On Error Resume Next
    dim flashx4, matdim
    If not Flasherflash5.TimerEnabled Then
      Flasherflash5.TimerEnabled = True
      Flasherflash5.visible = 1
      Flasherlit5.visible = 1
    End If
    flashx4 = FlashLevel5 * FlashLevel5 * FlashLevel5
    Flasherflash5.opacity = 1500 * flashx4
    Flasherlit5.BlendDisableLighting = 10 * flashx4
    Flasherbase5.BlendDisableLighting =  flashx4
    Flasherlight5.IntensityScale = flashx4
    matdim = Round(10 * FlashLevel5)
    Flasherlit5.material = "domelit" & matdim
    FlashLevel5 = FlashLevel5 * 0.9 - 0.01
    If FlashLevel5 < 0.15 Then
      Flasherlit5.visible = 0
    Else
      Flasherlit5.visible = 1
    end If
    If FlashLevel5 < 0 Then
      Flasherflash5.TimerEnabled = False
      Flasherflash5.visible = 0
    End If
  End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'   SCORING FUNCTIONS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
  Function CalcPoints(m, points)
  I "CalcPoints mode=" & CStr(m) & " points=" & CStr(points)
    Dim f   '  factor
    CalcPoints = 0
    If Modes(CurrentPlayer,m) = 1 Then
      f=1.1
    ElseIf Modes(CurrentPlayer,m) = 2 Then
      f=1.2
    ElseIf Modes(CurrentPlayer,m) > 2 Then
      f=1.25
    Else
      f=1 ' base points
    End If
    If Boost(CurrentPlayer,m)=1 Then
      f=f*1.2   ' Boost
    End If
    If LilyMode Then f=f*1.05


    I "CalcPoints m=" & CStr(m) & " points=" & CStr(points) & " modes=" & CStr(Modes(CurrentPlayer,m)) & " Results=" & CStr(Int(points*f))
    If points*f > 10000 Then
      CalcPoints=INT(Round((points*f)/100,0))*100
    Else
      CalcPoints=INT(Round(points*f,0))
    End If
  End Function

  Sub AddScore(points)
    'D "AddScore points=" & CStr(points)
    If(Tilted = False) Then
      ' add the points to the current players score variable
      If LilyMode Then ModeTotal(CurrentPlayer,Lily)=ModeTotal(CurrentPlayer,Lily) + points
      If SpotMode Then ModeTotal(CurrentPlayer,Spot)=ModeTotal(CurrentPlayer,Spot) + points
      If HermanMode Then ModeTotal(CurrentPlayer,Herman)=ModeTotal(CurrentPlayer,Herman) + points
      If RavenMode Then ModeTotal(CurrentPlayer,Raven)=ModeTotal(CurrentPlayer,Raven) + points
      If GrandpaMode Then ModeTotal(CurrentPlayer,Grandpa)=ModeTotal(CurrentPlayer,Grandpa) + points
      If MMadnessMode Then ModeTotal(CurrentPlayer,Madness)=ModeTotal(CurrentPlayer,Madness) + points
      Score(CurrentPlayer) = Score(CurrentPlayer) + (points)
      pUpdateScores

      Scorbit.SendUpdate Score(1), Score(2), Score(3), Score(4), Balls, CurrentPlayer, PlayersPlayingGame

    End if
  End Sub

  Sub AwardExtraBall()
    If NOT bExtraBallWonThisBall Then
      LightShootAgain.State = 1
      flashflash.Enabled = True
      LightSeqFlasher.UpdateInterval = 150
      LightSeqFlasher.Play SeqRandom, 10, , 10000
      ExtraBallsAwards(CurrentPlayer) = ExtraBallsAwards(CurrentPlayer) + 1
      bExtraBallWonThisBall = True
      DOF 402, DOFPulse   'DOF MX - Extra Ball
      'extraballready(CurrentPlayer) = 0
      If bMultiBallMode = false Then
        Pup_audioevents "Sound-0x072A - extra ball.mp3"
      End If
    Else
      AddScore 4000000
    END If
  End Sub

  Sub AwardSpecial()
    PlaySound SoundFXDOF("knocker",136,DOFPulse,DOFKnocker)
    DOF 115, DOFPulse
    GiEffect 1
    LightEffect 1
    DOF 400, DOFPulse   'DOF MX - Special
  End Sub

  Sub AwardSkillshot()
    D "awardskillshot"
    Dim i
    DOF 125, DOFPulse
    ResetSkillShot
    AddScore SkillshotValue(CurrentPLayer)
    GiEffect 1
    LightEffect 2
    LightEffect 9
    DOF 401, DOFPulse   'DOF MX - Skillshot
    Pup_audioevents "Sound-0x072C - award skillshot.mp3"
    SkillShotValue(CurrentPLayer) = SkillShotValue(CurrentPLayer) + 1000000
  End Sub

    Sub AwardSuperSkillshot()
    D "awardSuperSkillshot"
    Dim i
    DOF 125, DOFPulse
    ResetSkillShot
    AddScore 20000000
    GiEffect 1
    LightEffect 2
    LightEffect 9
    DOF 401, DOFPulse   'DOF MX - Skillshot
    Pup_audioevents "Sound-0x072C - award skillshot.mp3"
    SkillShotValue(CurrentPLayer) = SkillShotValue(CurrentPLayer) + 1000000
  End Sub


  Sub pSetBackFrame(fname)
    I "pSetBackFrame" & fname
    PuPlayer.playlistplayex pBackglass,"PuPOverlays",fname,100,0  '0 loops until replaced
  end Sub

  Sub pPlayMedia(fPlayList,fname)
    PuPlayer.playlistplayex pBackglass,fPlayList,fname,100,1
  end Sub

  Sub pStartBackLoop(fPlayList,fname)
    D "pStartBackLoop " & fPlayList & " " & fname
    CurPage=2
    PuPlayer.playlistplayex pBackglass,fPlayList,fname,100,1
    PuPlayer.SetBackGround pBackglass,1
  end Sub

  Sub pStopBackLoop
    D "pStopBackLoop"
    PuPlayer.SetBackGround pBackglass,0
    PuPlayer.playstop pBackglass
  end Sub

  Sub ClearVideo
    D "ClearVideo"
    PuPlayer.playlistplayex pBackglass,"videoothers","nothing.mp4",100,7
  End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  ATTRACT MODE
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X


  Sub StartAttractMode()
    DOF 323, DOFOn   'DOF MX - Attract Mode ON
        D "StartAttractMode"
    PuPlayer.playlistplayex pMusic,"audioattract","",40, 1
    bAttractMode = True
    pSetBackFrame "clear.png"
    PuPlayer.LabelShowPage pBackglass,1,0,""
    StartLightSeq
    DMDintroloop
    GIOff  'DEBUG
    StartRainbow alights
    DMDattract.Enabled = 1
    intromover.enabled = true
  End Sub

  Sub StopAttractMode()
    D "stopattractmode"
    DOF 323, DOFOff   'DOF MX - Attract Mode Off
    pSetBackFrame "ball0.png"
    PuPlayer.LabelShowPage pBackglass,2,0,""
    PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100, 1
    bAttractMode = False
    LightSeqAttract.StopPlay
    LightSeqAttract2.StopPlay
    StopRainbow alights
  ' StopRainbow2 GI
    ResetAllLightsColor
    DMDattract.Enabled = 0
    intromover.enabled = false
  End Sub
'

  Dim introposition
  introposition = 0
  Sub table1_Exit
    Scorbit.StopSession2 Score(0), Score(1), Score(2), Score(3), PlayersPlayingGame, True   ' In case you stop mid game
    PuPlayer.playlistplayex pMusic,"audioclear","clear.mp3",100, 1
    Controller.stop
  End Sub

  Sub ClearHSLabels
    PuPlayer.LabelSet pBackglass,"HighScore","",1,""
    PuPlayer.LabelSet pBackglass,"high1name","",1,""
    PuPlayer.LabelSet pBackglass,"high1score","",1,""
    PuPlayer.LabelSet pBackglass,"high2name","",1,"{'mt':2,'xpos': 40 }"
    PuPlayer.LabelSet pBackglass,"high2score","",1,""
    PuPlayer.LabelSet pBackglass,"high3name","",1,""
    PuPlayer.LabelSet pBackglass,"high3score","",1,""
    PuPlayer.LabelSet pBackglass,"high4name","",1,""
    PuPlayer.LabelSet pBackglass,"high4score","",1,""
    PuPlayer.LabelSet pBackglass,"notetitle","",1,""
    PuPlayer.LabelSet pBackglass,"HighScore","",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL1","",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL2","",1,""
    PuPlayer.LabelSet pBackglass,"HighScoreL3","",1,""
    PuPlayer.LabelSet pBackglass,"notecopy","",1,""
    PuPlayer.LabelSet pBackglass,"ScorbitQR","",1,""
    PuPlayer.LabelSet pBackglass,"ScorbitQRIcon","",1,""
  End Sub

  Sub ClearOSBLabels
    PuPlayer.LabelSet pBackglass,"dh1n","",1,""
    PuPlayer.LabelSet pBackglass,"dh1s","",1,""
    PuPlayer.LabelSet pBackglass,"dh2n","",1,""
    PuPlayer.LabelSet pBackglass,"dh2s","",1,""
    PuPlayer.LabelSet pBackglass,"dh3n","",1,""
    PuPlayer.LabelSet pBackglass,"dh3s","",1,""
    PuPlayer.LabelSet pBackglass,"dh4n","",1,""
    PuPlayer.LabelSet pBackglass,"dh4s","",1,""
    PuPlayer.LabelSet pBackglass,"dh5n","",1,""
    PuPlayer.LabelSet pBackglass,"dh5s","",1,""
    PuPlayer.LabelSet pBackglass,"dh6n","",1,""
    PuPlayer.LabelSet pBackglass,"dh6s","",1,""
    PuPlayer.LabelSet pBackglass,"dh7n","",1,""
    PuPlayer.LabelSet pBackglass,"dh7s","",1,""
    PuPlayer.LabelSet pBackglass,"dh8n","",1,""
    PuPlayer.LabelSet pBackglass,"dh8s","",1,""
    PuPlayer.LabelSet pBackglass,"dh9n","",1,""
    PuPlayer.LabelSet pBackglass,"dh9s","",1,""
    PuPlayer.LabelSet pBackglass,"dh10n","",1,""
    PuPlayer.LabelSet pBackglass,"dh10s","",1,""
  End Sub

  Sub DMDintroloop
    PuPlayer.LabelSet pBackglass,"modetitle","",1,"{'mt':2,'color':16777215, 'size': 0, 'xpos': 80.7, 'xalign': 1, 'ypos': 72.6, 'yalign': 0}"
    introtime = 0
    introposition = introposition + 1
        D "DMDintroLoop "
        D introposition
    Select Case introposition
    Case 1
      D "Start of Attract"
      pStopBackLoop
      PuPlayer.SetBackground pBackglass,2
      pStartBackLoop "videoattract","Video-0x00BE.mp4"
      PuPlayer.LabelSet pBackglass,"HighScore","Latest Scores",1,""
      PuPlayer.LabelSet pBackglass,"high1name","Player 1: ",1,""
      PuPlayer.LabelSet pBackglass,"high1score", FormatNumber(LastScore(1),0),1,""
      If LastScore(2) > 0 Then
        PuPlayer.LabelSet pBackglass,"High2name","Player 2: ",1,"{'mt':2,'xpos': 52 }"
        PuPlayer.LabelSet pBackglass,"High2score", FormatNumber(LastScore(2),0),1,""
      End If
      If LastScore(3) > 0 Then
        PuPlayer.LabelSet pBackglass,"High3name", "Player 3: ",1,""
        PuPlayer.LabelSet pBackglass,"High3score", FormatNumber(LastScore(3),0),1,"{'mt':2,'xpos': 40 }"
      End If
      If LastScore(4) > 0 Then
        PuPlayer.LabelSet pBackglass,"High4name", "Player 4: ",1,""
        PuPlayer.LabelSet pBackglass,"High4score", FormatNumber(LastScore(4),0),1,""
      End If
      PuPlayer.LabelSet pBackglass,"notetitle","",1,""
      PuPlayer.LabelSet pBackglass,"notecopy","",1,""
      D "Finished Case 1"
    Case 2
    ' pStartBackLoop "videoattract","Video-0x00BE.mp4"
      if (Scorbit.bNeedsPairing) then
        PlaySoundVol "scorbit_detected_unclaimed", VolSfx
        PuPlayer.LabelSet pBackglass, "ScorbitQR", "PuPOverlays\\QRcode.png",1,"{'mt':2,'width':32, 'height':64,'xalign':0,'yalign':0,'ypos':5,'xpos':5}"
        PuPlayer.LabelSet pBackglass, "ScorbitQRIcon", "PuPOverlays\\QRcodeS.png",1,"{'mt':2,'width':36, 'height':85,'xalign':0,'yalign':0,'ypos':3,'xpos':3,'zback':1}"
      End if

      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(20,"GRAND CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,HighScoreName(0)            ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(HighScore(0),0)),1,""

    Case 3
      ClearHSLabels
      'PuPlayer.playlistplayex pBackglass,"PupVideos","Scorbit.mp4", 1, 1
      PuPlayer.LabelSet pBackglass,"HighScore","High Scores",1,""
      'PuPlayer.playlistplayex pBackglass,"videoattract","184 - attract.mp4",100,1
      PuPlayer.LabelSet pBackglass,"high1name",HighScoreName(0),1,""
      PuPlayer.LabelSet pBackglass,"high1score",FormatNumber(HighScore(0),0),1,""
      PuPlayer.LabelSet pBackglass,"high2name",HighScoreName(1),1,""
      PuPlayer.LabelSet pBackglass,"high2score",FormatNumber(HighScore(1),0),1,""
      PuPlayer.LabelSet pBackglass,"high3name",HighScoreName(2),1,""
      PuPlayer.LabelSet pBackglass,"high3score",FormatNumber(HighScore(2),0),1,""
      PuPlayer.LabelSet pBackglass,"high4name",HighScoreName(3),1,""
      PuPlayer.LabelSet pBackglass,"high4score",FormatNumber(HighScore(3),0),1,""

    Case 4
      if osbkey="" then
        clearhslabels
        clearosblabels
        DMDintroloop
      Else
      ClearHSLabels
      ClearOSBLabels
      PuPlayer.LabelSet pBackglass,"HighScore","DAILY HIGH SCORES",1,""
      PuPlayer.LabelSet pBackglass,"dh1n","1. " & dailyvar(2),1,""
      PuPlayer.LabelSet pBackglass,"dh1s",FormatNumber(dailyvar(3),0),1,""
      PuPlayer.LabelSet pBackglass,"dh2n","2. " & dailyvar(4),1,""
      PuPlayer.LabelSet pBackglass,"dh2s",FormatNumber(dailyvar(5),0),1,""
      PuPlayer.LabelSet pBackglass,"dh3n","3. " & dailyvar(6),1,""
      PuPlayer.LabelSet pBackglass,"dh3s",FormatNumber(dailyvar(7),0),1,""
      PuPlayer.LabelSet pBackglass,"dh4n","4. " & dailyvar(8),1,""
      PuPlayer.LabelSet pBackglass,"dh4s",FormatNumber(dailyvar(9),0),1,""
      PuPlayer.LabelSet pBackglass,"dh5n","5. " & dailyvar(10),1,""
      PuPlayer.LabelSet pBackglass,"dh5s",FormatNumber(dailyvar(11),0),1,""
      PuPlayer.LabelSet pBackglass,"dh6n","6. " & dailyvar(12),1,""
      PuPlayer.LabelSet pBackglass,"dh6s",FormatNumber(dailyvar(13),0),1,""
      PuPlayer.LabelSet pBackglass,"dh7n","7. " & dailyvar(14),1,""
      PuPlayer.LabelSet pBackglass,"dh7s",FormatNumber(dailyvar(15),0),1,""
      PuPlayer.LabelSet pBackglass,"dh8n","8. " & dailyvar(16),1,""
      PuPlayer.LabelSet pBackglass,"dh8s",FormatNumber(dailyvar(17),0),1,""
      PuPlayer.LabelSet pBackglass,"dh9n","9. " & dailyvar(18),1,""
      PuPlayer.LabelSet pBackglass,"dh9s",FormatNumber(dailyvar(19),0),1,""
      PuPlayer.LabelSet pBackglass,"dh10n","10. " & dailyvar(20),1,""
      PuPlayer.LabelSet pBackglass,"dh10s",FormatNumber(dailyvar(21),0),1,""
      End If
    Case 5
      if osbkey="" then
        clearhslabels
        clearosblabels
        DMDintroloop
      Else
      ClearOSBLabels
      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore","WEEKLY HIGH SCORES",1,""
      PuPlayer.LabelSet pBackglass,"dh1n","1. " & weeklyvar(2),1,""
      PuPlayer.LabelSet pBackglass,"dh1s",FormatNumber(weeklyvar(3),0),1,""
      PuPlayer.LabelSet pBackglass,"dh2n","2. " & weeklyvar(4),1,""
      PuPlayer.LabelSet pBackglass,"dh2s",FormatNumber(weeklyvar(5),0),1,""
      PuPlayer.LabelSet pBackglass,"dh3n","3. " & weeklyvar(6),1,""
      PuPlayer.LabelSet pBackglass,"dh3s",FormatNumber(weeklyvar(7),0),1,""
      PuPlayer.LabelSet pBackglass,"dh4n","4. " & weeklyvar(8),1,""
      PuPlayer.LabelSet pBackglass,"dh4s",FormatNumber(weeklyvar(9),0),1,""
      PuPlayer.LabelSet pBackglass,"dh5n","5. " & weeklyvar(10),1,""
      PuPlayer.LabelSet pBackglass,"dh5s",FormatNumber(weeklyvar(11),0),1,""
      PuPlayer.LabelSet pBackglass,"dh6n","6. " & weeklyvar(12),1,""
      PuPlayer.LabelSet pBackglass,"dh6s",FormatNumber(weeklyvar(13),0),1,""
      PuPlayer.LabelSet pBackglass,"dh7n","7. " & weeklyvar(14),1,""
      PuPlayer.LabelSet pBackglass,"dh7s",FormatNumber(weeklyvar(15),0),1,""
      PuPlayer.LabelSet pBackglass,"dh8n","8. " & weeklyvar(16),1,""
      PuPlayer.LabelSet pBackglass,"dh8s",FormatNumber(weeklyvar(17),0),1,""
      PuPlayer.LabelSet pBackglass,"dh9n","9. " & weeklyvar(18),1,""
      PuPlayer.LabelSet pBackglass,"dh9s",FormatNumber(weeklyvar(19),0),1,""
      PuPlayer.LabelSet pBackglass,"dh10n","10. " & weeklyvar(20),1,""
      PuPlayer.LabelSet pBackglass,"dh10s",FormatNumber(weeklyvar(21),0),1,""
      End If
    Case 6
      if osbkey="" then
        clearhslabels
        clearosblabels
        DMDintroloop
      Else
      ClearHSLabels
      ClearOSBLabels
      PuPlayer.LabelSet pBackglass,"HighScore","  ALL TIME TOP 10!!",1,""
      PuPlayer.LabelSet pBackglass,"dh1n","1. " & alltimevar(2),1,""
      PuPlayer.LabelSet pBackglass,"dh1s",FormatNumber(alltimevar(3),0),1,""
      PuPlayer.LabelSet pBackglass,"dh2n","2. " & alltimevar(4),1,""
      PuPlayer.LabelSet pBackglass,"dh2s",FormatNumber(alltimevar(5),0),1,""
      PuPlayer.LabelSet pBackglass,"dh3n","3. " & alltimevar(6),1,""
      PuPlayer.LabelSet pBackglass,"dh3s",FormatNumber(alltimevar(7),0),1,""
      PuPlayer.LabelSet pBackglass,"dh4n","4. " & alltimevar(8),1,""
      PuPlayer.LabelSet pBackglass,"dh4s",FormatNumber(alltimevar(9),0),1,""
      PuPlayer.LabelSet pBackglass,"dh5n","5. " & alltimevar(10),1,""
      PuPlayer.LabelSet pBackglass,"dh5s",FormatNumber(alltimevar(11),0),1,""
      PuPlayer.LabelSet pBackglass,"dh6n","6. " & alltimevar(12),1,""
      PuPlayer.LabelSet pBackglass,"dh6s",FormatNumber(alltimevar(13),0),1,""
      PuPlayer.LabelSet pBackglass,"dh7n","7. " & alltimevar(14),1,""
      PuPlayer.LabelSet pBackglass,"dh7s",FormatNumber(alltimevar(15),0),1,""
      PuPlayer.LabelSet pBackglass,"dh8n","8. " & alltimevar(16),1,""
      PuPlayer.LabelSet pBackglass,"dh8s",FormatNumber(alltimevar(17),0),1,""
      PuPlayer.LabelSet pBackglass,"dh9n","9. " & alltimevar(18),1,""
      PuPlayer.LabelSet pBackglass,"dh9s",FormatNumber(alltimevar(19),0),1,""
      PuPlayer.LabelSet pBackglass,"dh10n","10. " & alltimevar(20),1,""
      PuPlayer.LabelSet pBackglass,"dh10s",FormatNumber(alltimevar(21),0),1,""
      End If
    Case 7
      ClearHSLabels
      clearosblabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(18,"HERMAN CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,Champion(Herman)    ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(ChampionScore(Herman),0)),1,""
    Case 8
      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(18,"GRANDPA CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,Champion(Grandpa)            ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(ChampionScore(Grandpa),0)),1,""
    Case 9
      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(20,"LILY CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,Champion(Lily)           ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(ChampionScore(Lily),0)),1,""
    Case 10
      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(20,"SPOT CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,Champion(Spot)             ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(ChampionScore(Spot),0)),1,""
    Case 11
      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(20,"RAVEN CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,Champion(Raven)           ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(ChampionScore(Raven),0)),1,""
    Case 12
      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(20,"MUNSTER MADNESS\r    CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,Champion(Madness)             ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(ChampionScore(Madness),0)),1,""
    Case 13
      ClearHSLabels
      PuPlayer.LabelSet pBackglass,"HighScore",CenterText(20,"ZAP CHAMPION"),1,""
      PuPlayer.LabelSet pBackglass,"high2name", CenterText(34,Champion(Zap)            ),1,"{'mt':2,'xpos': 40 }"
      PuPlayer.LabelSet pBackglass,"high3score",CenterText(42,FormatNumber(ChampionScore(Zap),0)),1,""
    Case 14
      ClearHSLabels
      pStopBackLoop
      pStartBackLoop "videoattract","Video-0x0077 - long attract.mp4"
    Case 15
      ClearHSLabels
      pStopBackLoop
      pStartBackLoop "videoattract","Video-0x0004 - stern attract.mp4"
    Case 16
      ClearHSLabels
      pStopBackLoop
      pStartBackLoop "videoattract","Video-0x0023 - attract.mp4"
      introposition = 0
  End Select
  End Sub

  Dim introtime
  introtime = 0

  Sub intromover_timer
    introtime = introtime + 1
    'D "DMD Loop pos=" & CStr(introposition) & " time=" & CSTR(introtime)
    If introposition = 1 Then
      If introtime = 5 Then
        DMDintroloop
      End If
    End If
    If introposition > 1 and introposition <= 13 Then
      If introtime = 3 Then
        DMDintroloop
      End If
    End If
    If introposition = 13 Then
      If introtime = 75 Then
        DMDintroloop
      End If
    End If
    If introposition = 14 Then
      If introtime = 80 Then
        DMDintroloop
      End If
    End If
    If introposition = 15 Then
      If introtime = 15 Then
        DMDintroloop
      End If
    End If
    If introposition = 0 Then
      If introtime = 5 Then
        introposition = 0
        DMDintroloop
      End If
    End If
  End Sub


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  SECONDARY HIT EVENTS
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\ /\
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'

  Dim RStep, Lstep

  Sub RightSlingShot_Slingshot
    PlaySoundAt SoundFXDOF("fx_slingshot", 104, DOFPulse, DOFContactors), sw5
    DOF 106, DOFPulse
    PlaySound SoundFX("right_slingshot",DOFContactors), 0,1, 0.05,0.05 '0,1, AudioPan(RightSlingShot), 0.05,0,0,1,AudioFade(RightSlingShot)
    RSling.Visible = 0
    RSling1.Visible = 1
    sling1.TransZ = -20
    RStep = 0
    RightSlingShot.TimerEnabled = 1
    AddScore 30
  End Sub

  Sub RightSlingShot_Timer
    Select Case RStep
      Case 3:RSLing1.Visible = 0:RSLing2.Visible = 1:sling1.TransZ = -10
      Case 4:RSLing2.Visible = 0:RSLing.Visible = 1:sling1.TransZ = 0:RightSlingShot.TimerEnabled = 0
    End Select
    RStep = RStep + 1
  End Sub

  Sub LeftSlingShot_Slingshot
    PlaySoundAt SoundFXDOF("fx_slingshot", 103, DOFPulse, DOFContactors), sw2
    PlaySound SoundFX("left_slingshot",DOFContactors), 0,1, -0.05,0.05 '0,1, AudioPan(LeftSlingShot), 0.05,0,0,1,AudioFade(LeftSlingShot)
    DOF 105, DOFPulse
    LSling.Visible = 0
    LSling1.Visible = 1
    sling2.TransZ = -20
    LStep = 0
    LeftSlingShot.TimerEnabled = 1
    AddScore 30
  End Sub

  Sub LeftSlingShot_Timer
    Select Case LStep
      Case 3:LSLing1.Visible = 0:LSLing2.Visible = 1:sling2.TransZ = -10
      Case 4:LSLing2.Visible = 0:LSLing.Visible = 1:sling2.TransZ = 0:LeftSlingShot.TimerEnabled = 0
    End Select
    LStep = LStep + 1
  End Sub

Sub PaintModes
  If Modes(CurrentPlayer,Herman) mod 2 = 1 Then PuPlayer.LabelSet pBackglass,"HMode1","I",1,""
  If Modes(CurrentPlayer,Herman)=2 Then PuPlayer.LabelSet pBackglass,"HMode2","I  I",1,""
  If Modes(CurrentPlayer,GrandPa) mod 2 = 1 Then PuPlayer.LabelSet pBackglass,"GMode1","I",1,""
  If Modes(CurrentPlayer,GrandPa)=2 Then PuPlayer.LabelSet pBackglass,"GMode2","I  I",1,""
  If Modes(CurrentPlayer,Raven) mod 2 = 1 Then PuPlayer.LabelSet pBackglass,"RMode1","I",1,""
  If Modes(CurrentPlayer,Raven)=2 Then PuPlayer.LabelSet pBackglass,"RMode2","I  I",1,""
  If Modes(CurrentPlayer,Lily) mod 2 = 1 Then PuPlayer.LabelSet pBackglass,"LMode1","I",1,""
  If Modes(CurrentPlayer,Lily)=2 Then PuPlayer.LabelSet pBackglass,"LMode2","I  I",1,""
  If Modes(CurrentPlayer,Spot) mod 2 = 1 Then PuPlayer.LabelSet pBackglass,"SMode1","I",1,""
  If Modes(CurrentPlayer,Spot)=2 Then PuPlayer.LabelSet pBackglass,"SMode2","I  I",1,""

  If Boost(CurrentPlayer,Herman)=1 Then PuPlayer.LabelSet pBackglass,"HBoost","BOOSTED",1,""
  If Boost(CurrentPlayer,Grandpa)=1 Then PuPlayer.LabelSet pBackglass,"GBoost","BOOSTED",1,""
  If Boost(CurrentPlayer,Raven)=1 Then PuPlayer.LabelSet pBackglass,"RBoost","BOOSTED",1,""
  If Boost(CurrentPlayer,Lily)=1 Then PuPlayer.LabelSet pBackglass,"LBoost","BOOSTED",1,""
  If Boost(CurrentPlayer,Spot)=1 Then PuPlayer.LabelSet pBackglass,"SBoost","BOOSTED",1,""

  PuPlayer.LabelSet pBackglass,"Ravens",RavenTime(ModesHeld(CurrentPlayer,Raven)),1,""
  PuPlayer.LabelSet pBackglass,"Jackpots",CStr(Jackpots),1,""
  PuPlayer.LabelSet pBackglass,"Zaps",CStr(ZapsCnt),1,""
End Sub

Sub PaintModesClear
  PuPlayer.LabelSet pBackglass,"HMode1","",1,""
  PuPlayer.LabelSet pBackglass,"HMode2","",1,""
  PuPlayer.LabelSet pBackglass,"GMode1","",1,""
  PuPlayer.LabelSet pBackglass,"GMode2","",1,""
  PuPlayer.LabelSet pBackglass,"RMode1","",1,""
  PuPlayer.LabelSet pBackglass,"RMode2","",1,""
  PuPlayer.LabelSet pBackglass,"LMode1","",1,""
  PuPlayer.LabelSet pBackglass,"LMode2","",1,""
  PuPlayer.LabelSet pBackglass,"SMode1","",1,""
  PuPlayer.LabelSet pBackglass,"SMode2","",1,""
  PuPlayer.LabelSet pBackglass,"HBoost","",1,""
  PuPlayer.LabelSet pBackglass,"GBoost","",1,""
  PuPlayer.LabelSet pBackglass,"RBoost","",1,""
  PuPlayer.LabelSet pBackglass,"LBoost","",1,""
  PuPlayer.LabelSet pBackglass,"SBoost","",1,""
End Sub

'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X  X
'/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/ \/
'  SCORBIT Interface
' To Use:
' 1) Define a timer tmrScorbit
' 2) Call DoInit at the end of PupInit or in Table Init if you are nto using pup with the appropriate parameters
'   if Scorbit.DoInit(389, "PupOverlays", "1.0.0", "GRWvz-MP37P") then
'     tmrScorbit.Interval=2000
'     tmrScorbit.UserValue = 0
'     tmrScorbit.Enabled=True
'   End if
' 3) Customize helper functions below for different events if you want or make your own
' 4) Call
'   StartSession - When a game starts
'   StopSession - When the game is over
'   SendUpdate - When Score Changes
'   SetGameMode - When different game events happen like starting a mode, MB etc.  (ScorbitBuildGameModes helper function shows you how)
' 5) Drop the binaries sQRCode.exe and sToken.exe in your Pup Root so we can create session kets and QRCodes.
' 6) Callbacks
'   Scorbit_Paired      - Called when machine is successfully paired.  Hide QRCode and play a sound
'   Scorbit_PlayerClaimed - Called when player is claimed.  Hide QRCode, play a sound and display name
'
'
'>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
' TABLE CUSTOMIZATION START HERE

Sub Scorbit_Paired()                ' Scorbit callback when new machine is paired
debug.print "Scorbit PAIRED"
  PlaySoundVol "scorbit_login", VolSfx
  PuPlayer.LabelSet pBackglass, "ScorbitQR", "PuPOverlays\\clear.png",0,""
  PuPlayer.LabelSet pBackglass, "ScorbitQRIcon", "PuPOverlays\\clear.png",0,""
End Sub

Sub Scorbit_PlayerClaimed(PlayerNum, PlayerName)  ' Scorbit callback when QR Is Claimed
debug.print "Scorbit LOGIN"
  PlaySoundVol "scorbit_login", VolSfx
  ScorbitClaimQR(False)
  'puPlayer.LabelSet pBackglass,"Player", PlayerName  ,1,""
  pUpdateScores()

Debug.print "Scorbit_PlayerClaimed:" & PlayerNum & " " & PlayerName
End Sub


Sub ScorbitClaimQR(bShow)           '  Show QRCode on first ball for users to claim this position
  if Scorbit.bSessionActive=False then Exit Sub
  if ScorbitShowClaimQR=False then Exit Sub
  if Scorbit.bNeedsPairing then exit sub

  if bShow and balls=1 and bGameInPlay and Scorbit.GetName(CurrentPlayer+1)="" then
    PlaySoundVol "scorbit_detected_claimed", VolSfx
    if ScorbitClaimSmall=0 then ' Desktop Make it Larger
      PuPlayer.LabelSet pBackglass, "ScorbitQR", "PuPOverlays\\QRclaim.png",1,"{'mt':2,'width':20, 'height':40,'xalign':0,'yalign':0,'ypos':40,'xpos':5}"
      PuPlayer.LabelSet pBackglass, "ScorbitQRIcon", "PuPOverlays\\QRcodeB.png",1,"{'mt':2,'width':23, 'height':52,'xalign':0,'yalign':0,'ypos':38,'xpos':3.5,'zback':1}"
    else
      PuPlayer.LabelSet pBackglass, "ScorbitQR", "PuPOverlays\\QRclaim.png",1,"{'mt':2,'width':12, 'height':24,'xalign':0,'yalign':0,'ypos':60,'xpos':5}"
      PuPlayer.LabelSet pBackglass, "ScorbitQRIcon", "PuPOverlays\\QRcodeB.png",1,"{'mt':2,'width':14, 'height':32.5,'xalign':0,'yalign':0,'ypos':58,'xpos':4,'zback':1}"
    End if
  Else
    PuPlayer.LabelSet pBackglass, "ScorbitQR", "PuPOverlays\\clear.png",0,""
    PuPlayer.LabelSet pBackglass, "ScorbitQRIcon", "PuPOverlays\\clear.png",0,""
  End if
End Sub

Sub ScorbitBuildGameModes()   ' Custom function to build the game modes for better stats
  dim GameModeStr
  if Scorbit.bSessionActive=False then Exit Sub
  GameModeStr="NA{black}:"

  If LilyMode then GameModeStr="NA{orange}:Lily Mode"
  If SpotMode then GameModeStr="NA{red}: Spot Mode"
  If HermanMode then GameModeStr="NA{green}: Herman Mode"
  If RavenMode then GameModeStr="NA{blue}: Raven Mode"
  If GrandPaMode then GameModeStr="NA{purple}: GrandPa Mode"
  If MMadnessMode then GameModeStr="NA{white}: MMadness Mode"

  D "ScorbitBuildGameModes " & GameModeStr
  Scorbit.SetGameMode(GameModeStr)

End Sub

Sub Scorbit_LOGUpload(state)  ' Callback during the log creation process.  0=Creating Log, 1=Uploading Log, 2=Done
  Select Case state
    case 0:
      Debug.print "CREATING LOG"
    case 1:
      Debug.print "Uploading LOG"
    case 2:
      Debug.print "LOG Complete"
  End Select
End Sub
'<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
' TABLE CUSTOMIZATION END HERE - NO NEED TO EDIT BELOW THIS LINE


dim Scorbit : Set Scorbit = New ScorbitIF
' Workaround - Call get a reference to Member Function
Sub tmrScorbit_Timer()                ' Timer to send heartbeat
  Scorbit.DoTimer(tmrScorbit.UserValue)
  tmrScorbit.UserValue=tmrScorbit.UserValue+1
  if tmrScorbit.UserValue>5 then tmrScorbit.UserValue=0
End Sub
Function ScorbitIF_Callback()
  Scorbit.Callback()
End Function
Class ScorbitIF

  Public bSessionActive
  Public bNeedsPairing
  Private bUploadLog
  Private bActive
  Private LOGFILE(10000000)
  Private LogIdx

  Private bProduction

  Private TypeLib
  Private MyMac
  Private Serial
  Private MyUUID
  Private TableVersion

  Private SessionUUID
  Private SessionSeq
  Private SessionTimeStart
  Private bRunAsynch
  Private bWaitResp
  Private GameMode
  Private GameModeOrig    ' Non escaped version for log
  Private VenueMachineID
  Private CachedPlayerNames(4)
  Private SaveCurrentPlayer

  Public bEnabled
  Private sToken
  Private machineID
  Private dirQRCode
  Private opdbID
  Private wsh

  Private objXmlHttpMain
  Private objXmlHttpMainAsync
  Private fso
  Private Domain

  Public Sub Class_Initialize()
    bActive="false"
    bSessionActive=False
    bEnabled=False
  End Sub

  Property Let UploadLog(bValue)
    bUploadLog = bValue
  End Property

  Sub DoTimer(bInterval)  ' 2 second interval
    dim holdScores(4)
    dim i
    if bInterval=0 then
      SendHeartbeat()
    elseif bRunAsynch then ' Game in play
      Scorbit.SendUpdate Score(1), Score(2), Score(3), Score(4), Balls, CurrentPlayer, PlayersPlayingGame
    End if
  End Sub

  Function GetName(PlayerNum) ' Return Parsed Players name
    if PlayerNum<1 or PlayerNum>4 then
      GetName=""
    else
      GetName=CachedPlayerNames(PlayerNum-1)
    End if
  End Function

  Function DoInit(MyMachineID, Directory_PupQRCode, Version, opdb)
    dim Nad
    Dim EndPoint
    Dim resultStr
    Dim UUIDParts
    Dim UUIDFile

    bProduction=1
'   bProduction=0
    SaveCurrentPlayer=0
    VenueMachineID=""
    bWaitResp=False
    bRunAsynch=False
    DoInit=False
    opdbID=opdb
    dirQrCode=Directory_PupQRCode
    MachineID=MyMachineID
    TableVersion=version
    bNeedsPairing=False
    if bProduction then
      domain = "api.scorbit.io"
    else
      domain = "staging.scorbit.io"
      domain = "scorbit-api-staging.herokuapp.com"
    End if
    Set fso = CreateObject("Scripting.FileSystemObject")
    dim objLocator:Set objLocator = CreateObject("WbemScripting.SWbemLocator")
    Dim objService:Set objService = objLocator.ConnectServer(".", "root\cimv2")
    Set objXmlHttpMain = CreateObject("Msxml2.ServerXMLHTTP")
    Set objXmlHttpMainAsync = CreateObject("Microsoft.XMLHTTP")
    objXmlHttpMain.onreadystatechange = GetRef("ScorbitIF_Callback")
    Set wsh = CreateObject("WScript.Shell")
    ' Get Mac for Serial Number
    dim Nads: set Nads = objService.ExecQuery("Select * from Win32_NetworkAdapter where physicaladapter=true")
    for each Nad in Nads
      if not isnull(Nad.MACAddress) then
        Debug.print "Using MAC Addresses:" & Nad.MACAddress & " From Adapter:" & Nad.description
        MyMac=replace(Nad.MACAddress, ":", "")
        Exit For
      End if
    Next
    Serial=eval("&H" & mid(MyMac, 5))
        if Serial<0 then Serial=eval("&H" & mid(MyMac, 6))        ' Mac Address Overflow Special Case
        if MyMachineID<>2108 then             ' GOTG did it wrong but MachineID should be added to serial number also
            Serial=Serial+MyMachineID
        End if
'        Serial=123456
        Debug.print "Serial:" & Serial

    ' Get System UUID
    set Nads = objService.ExecQuery("SELECT * FROM Win32_ComputerSystemProduct")
    for each Nad in Nads
      Debug.print "Using UUID:" & Nad.UUID
      MyUUID=Nad.UUID
      Exit For
    Next
    if MyUUID="" then
      debug.print "SCORBIT - Can get UUID, Disabling."
      Exit Function
    elseif MyUUID="03000200-0400-0500-0006-000700080009" or ScorbitAlternateUUID then
      If fso.FolderExists(UserDirectory) then
        If fso.FileExists(UserDirectory & "ScorbitUUID.dat") then
          Set UUIDFile = fso.OpenTextFile(UserDirectory & "ScorbitUUID.dat",1)
          MyUUID = UUIDFile.ReadLine()
          UUIDFile.Close
          Set UUIDFile = Nothing
        Else
          MyUUID=GUID()
          Set UUIDFile=fso.CreateTextFile(UserDirectory & "ScorbitUUID.dat",True)
          UUIDFile.WriteLine MyUUID
          UUIDFile.Close
          Set UUIDFile=Nothing
        End if
      End if
    End if

    ' Clean UUID
    UUIDParts=split(MyUUID, "-")
    MyUUID=LCASE(Hex(eval("&h" & UUIDParts(0))+MyMachineID) & UUIDParts(1) &  UUIDParts(2) &  UUIDParts(3) & UUIDParts(4))         ' Add MachineID to UUID
    MyUUID=LPad(MyUUID, 32, "0")
'   MyUUID=Replace(MyUUID, "-",  "")
'   Debug.print "MyUUID:" & MyUUID


' Debug
'   myUUID="adc12b19a3504453a7414e722f58737f"
'   Serial="123456778"

    ' Authenticate and get our token
    if getStoken() then
      bEnabled=True
'     SendHeartbeat
      DoInit=True
    End if
  End Function

  Sub Callback()
    Dim ResponseStr
    Dim i
    Dim Parts
    Dim Parts2
    Dim Parts3
    if bEnabled=False then Exit Sub

    if bWaitResp and objXmlHttpMain.readystate=4 then
'     Debug.print "CALLBACK: " & objXmlHttpMain.Status & " " & objXmlHttpMain.readystate
      if objXmlHttpMain.Status=200 and objXmlHttpMain.readystate = 4 then
        ResponseStr=objXmlHttpMain.responseText
        Debug.print "RESPONSE: " & ResponseStr

        ' Parse Name
        if CachedPlayerNames(SaveCurrentPlayer-1)="" then  ' Player doesnt have a name
          if instr(1, ResponseStr, "cached_display_name") <> 0 Then ' There are names in the result
            Parts=Split(ResponseStr,",{")             ' split it
            if ubound(Parts)>=SaveCurrentPlayer-1 then        ' Make sure they are enough avail
              if instr(1, Parts(SaveCurrentPlayer-1), "cached_display_name")<>0 then  ' See if mine has a name
                CachedPlayerNames(SaveCurrentPlayer-1)=GetJSONValue(Parts(SaveCurrentPlayer-1), "cached_display_name")    ' Get my name
                CachedPlayerNames(SaveCurrentPlayer-1)=Replace(CachedPlayerNames(SaveCurrentPlayer-1), """", "")
                Scorbit_PlayerClaimed SaveCurrentPlayer, CachedPlayerNames(SaveCurrentPlayer-1)
'               Debug.print "Player Claim:" & SaveCurrentPlayer & " " & CachedPlayerNames(SaveCurrentPlayer-1)
              End if
            End if
          End if
        else                            ' Check for unclaim
          if instr(1, ResponseStr, """player"":null")<>0 Then ' Someone doesnt have a name
            Parts=Split(ResponseStr,"[")            ' split it
'Debug.print "Parts:" & Parts(1)
            Parts2=Split(Parts(1),"}")              ' split it
            for i = 0 to Ubound(Parts2)
'Debug.print "Parts2:" & Parts2(i)
              if instr(1, Parts2(i), """player"":null")<>0 Then
                CachedPlayerNames(i)=""
              End if
            Next
          End if
        End if
      End if
      bWaitResp=False
    End if
  End Sub

  Public Sub StartSession()
    if bEnabled=False then Exit Sub
debug.print "Scorbit Start Session"
    CachedPlayerNames(0)=""
    CachedPlayerNames(1)=""
    CachedPlayerNames(2)=""
    CachedPlayerNames(3)=""
    bRunAsynch=True
    bActive="true"
    bSessionActive=True
    SessionSeq=0
    SessionUUID=GUID()
    SessionTimeStart=GameTime
    LogIdx=0
    SendUpdate 0, 0, 0, 0, 1, 1, 1
  End Sub

  Public Sub StopSession(P1Score, P2Score, P3Score, P4Score, NumberPlayers)
    StopSession2 P1Score, P2Score, P3Score, P4Score, NumberPlayers, False
  End Sub

  Public Sub StopSession2(P1Score, P2Score, P3Score, P4Score, NumberPlayers, bCancel)
    Dim i
    dim objFile
    if bEnabled=False then Exit Sub
    if bSessionActive=False then Exit Sub
debug.print "Scorbit Stop Session"

    bRunAsynch=False
    bActive="false"
    bSessionActive=False
    SendUpdate P1Score, P2Score, P3Score, P4Score, -1, -1, NumberPlayers
'   SendHeartbeat

    if bUploadLog and LogIdx<>0 and bCancel=False then
      debug.print "Creating Scorbit Log: Size" & LogIdx
      Scorbit_LOGUpload(0)
      Set objFile = fso.CreateTextFile(puplayer.getroot&"\" & cGameName & "\sGameLog.csv")
      For i = 0 to LogIdx-1
        objFile.Writeline LOGFILE(i)
      Next
      objFile.Close
      LogIdx=0
      Scorbit_LOGUpload(1)
      pvPostFile "https://" & domain & "/api/session_log/", puplayer.getroot&"\" & cGameName & "\sGameLog.csv", False
      Scorbit_LOGUpload(2)
      on error resume next
      fso.DeleteFile(puplayer.getroot&"\" & cGameName & "\sGameLog.csv")
      on error goto 0
    End if

  End Sub

  Public Sub SetGameMode(GameModeStr)
    GameModeOrig=GameModeStr
    GameMode=GameModeStr
    GameMode=Replace(GameMode, ":", "%3a")
    GameMode=Replace(GameMode, ";", "%3b")
    GameMode=Replace(GameMode, " ", "%20")
    GameMode=Replace(GameMode, "{", "%7B")
    GameMode=Replace(GameMode, "}", "%7D")
  End sub

  Public Sub SendUpdate(P1Score, P2Score, P3Score, P4Score, CurrentBall, CurrentPlayer, NumberPlayers)
    SendUpdateAsynch P1Score, P2Score, P3Score, P4Score, CurrentBall, CurrentPlayer, NumberPlayers, bRunAsynch
  End Sub

  Public Sub SendUpdateAsynch(P1Score, P2Score, P3Score, P4Score, CurrentBall, CurrentPlayer, NumberPlayers, bAsynch)
    dim i
    Dim PostData
    Dim resultStr
    dim LogScores(4)

    if bUploadLog then
      if NumberPlayers>=1 then LogScores(0)=P1Score
      if NumberPlayers>=2 then LogScores(1)=P2Score
      if NumberPlayers>=3 then LogScores(2)=P3Score
      if NumberPlayers>=4 then LogScores(3)=P4Score
      LOGFILE(LogIdx)=DateDiff("S", "1/1/1970", Now()) & "," & LogScores(0) & "," & LogScores(1) & "," & LogScores(2) & "," & LogScores(3) & ",,," &  CurrentPlayer & "," & CurrentBall & ",""" & GameModeOrig & """"
      LogIdx=LogIdx+1
    End if

    if bEnabled=False then Exit Sub
    if bWaitResp then exit sub ' Drop message until we get our next response

    SaveCurrentPlayer=CurrentPlayer
'   PostData = "session_uuid=" & SessionUUID & "&session_time=" & DateDiff("S", "1/1/1970", Now()) & _
'         "&session_sequence=" & SessionSeq & "&active=" & bActive
    PostData = "session_uuid=" & SessionUUID & "&session_time=" & GameTime-SessionTimeStart+1 & _
          "&session_sequence=" & SessionSeq & "&active=" & bActive

    SessionSeq=SessionSeq+1
    if NumberPlayers > 0 then
      for i = 0 to NumberPlayers-1
        PostData = PostData & "&current_p" & i+1 & "_score="
        if i <= NumberPlayers-1 then
          if i = 0 then PostData = PostData & P1Score
          if i = 1 then PostData = PostData & P2Score
          if i = 2 then PostData = PostData & P3Score
          if i = 3 then PostData = PostData & P4Score
        else
          PostData = PostData & "-1"
        End if
      Next

      PostData = PostData & "&current_ball=" & CurrentBall & "&current_player=" & CurrentPlayer
      if GameMode<>"" then PostData=PostData & "&game_modes=" & GameMode
    End if
    resultStr = PostMsg("https://" & domain, "/api/entry/", PostData, bAsynch)
    if resultStr<>"" then debug.print "SendUpdate Resp:" & resultStr
  End Sub

' PRIVATE BELOW
  Private Function LPad(StringToPad, Length, CharacterToPad)
    Dim x : x = 0
    If Length > Len(StringToPad) Then x = Length - len(StringToPad)
    LPad = String(x, CharacterToPad) & StringToPad
  End Function

  Private Function GUID()
    Dim TypeLib
    Set TypeLib = CreateObject("Scriptlet.TypeLib")
    GUID = Mid(TypeLib.Guid, 2, 36)

'   Set wsh = CreateObject("WScript.Shell")
'   Set fso = CreateObject("Scripting.FileSystemObject")
'
'   dim rc
'   dim result
'   dim objFileToRead
'   Dim sessionID:sessionID=puplayer.getroot&"\" & cGameName & "\sessionID.txt"
'
'   on error resume next
'   fso.DeleteFile(sessionID)
'   On error goto 0
'
'   rc = wsh.Run("powershell -Command ""(New-Guid).Guid"" | out-file -encoding ascii " & sessionID, 0, True)
'   if FileExists(sessionID) and rc=0 then
'     Set objFileToRead = fso.OpenTextFile(sessionID,1)
'     result = objFileToRead.ReadLine()
'     objFileToRead.Close
'     GUID=result
'   else
'     MsgBox "Cant Create SessionUUID through powershell. Disabling Scorbit"
'     bEnabled=False
'   End if

  End Function

  Private Function GetJSONValue(JSONStr, key)
    dim i
    Dim tmpStrs,tmpStrs2
    if Instr(1, JSONStr, key)<>0 then
      tmpStrs=split(JSONStr,",")
      for i = 0 to ubound(tmpStrs)
        if instr(1, tmpStrs(i), key)<>0 then
          tmpStrs2=split(tmpStrs(i),":")
          GetJSONValue=tmpStrs2(1)
          exit for
        End if
      Next
    End if
  End Function

  Private Sub SendHeartbeat()
    Dim resultStr
    dim TmpStr
    Dim Command
    Dim rc
    Dim QRFile:QRFile=puplayer.getroot&"\" & cGameName & "\" & dirQrCode
    if bEnabled=False then Exit Sub
    resultStr = GetMsgHdr("https://" & domain, "/api/heartbeat/", "Authorization", "SToken " & sToken)
    debug.print "Heartbeat Resp:" & resultStr
    If VenueMachineID="" then

      if resultStr<>"" and Instr(resultStr, """unpaired"":true")=0 then   ' We Paired
        bNeedsPairing=False
        debug.print "Paired"
        Scorbit_Paired()
      else
        bNeedsPairing=True
      End if

      TmpStr=GetJSONValue(resultStr, "venuemachine_id")
      if TmpStr<>"" then
        VenueMachineID=TmpStr
'debug.print "VenueMachineID=" & VenueMachineID
        Command = puplayer.getroot&"\" & cGameName & "\sQRCode.exe " & VenueMachineID & " " & opdbID & " " & QRFile
        rc = wsh.Run(Command, 0, False)
      End if
    End if
  End Sub

  Private Function getStoken()
    Dim result
    Dim results
'   dim wsh
    Dim tmpUUID:tmpUUID="adc12b19a3504453a7414e722f58736b"
    Dim tmpVendor:tmpVendor="vscorbitron"
    Dim tmpSerial:tmpSerial="999990104"
    Dim QRFile:QRFile=puplayer.getroot&"\" & cGameName & "\" & dirQrCode
    Dim sTokenFile:sTokenFile=puplayer.getroot&"\" & cGameName & "\sToken.dat"

    ' Set everything up
    tmpUUID=MyUUID
    tmpVendor="vpin"
    tmpSerial=Serial

    on error resume next
    fso.DeleteFile(sTokenFile)
    On error goto 0

    ' get sToken and generate QRCode
'   Set wsh = CreateObject("WScript.Shell")
    Dim waitOnReturn: waitOnReturn = True
    Dim windowStyle: windowStyle = 0
    Dim Command
    Dim rc
    Dim objFileToRead

    Command = puplayer.getroot&"\" & cGameName & "\sToken.exe " & tmpUUID & " " & tmpVendor & " " &  tmpSerial & " " & MachineID & " " & QRFile & " " & sTokenFile & " " & domain
debug.print "RUNNING Command:" & Command
    rc = wsh.Run(Command, windowStyle, waitOnReturn)
debug.print "Return:" & rc
    if FileExists(puplayer.getroot&"\" & cGameName & "\sToken.dat") and rc=0 then
      Set objFileToRead = fso.OpenTextFile(puplayer.getroot&"\" & cGameName & "\sToken.dat",1)
      result = objFileToRead.ReadLine()
      objFileToRead.Close
      Set objFileToRead = Nothing
'Debug.print result

      if Instr(1, result, "Invalid timestamp")<> 0 then
        MsgBox "Scorbit Timestamp Error: Please make sure the time on your system is exact"
        getStoken=False
      elseif Instr(1, result, ":")<>0 then
        results=split(result, ":")
        sToken=results(1)
        sToken=mid(sToken, 3, len(sToken)-4)
debug.print "Got TOKEN:" & sToken
        getStoken=True
      Else
debug.print "ERROR:" & result
        getStoken=False
      End if
    else
debug.print "ERROR No File:" & rc
    End if

  End Function

  private Function FileExists(FilePath)
    If fso.FileExists(FilePath) Then
      FileExists=CBool(1)
    Else
      FileExists=CBool(0)
    End If
  End Function

  Private Function GetMsg(URLBase, endpoint)
    GetMsg = GetMsgHdr(URLBase, endpoint, "", "")
  End Function

  Private Function GetMsgHdr(URLBase, endpoint, Hdr1, Hdr1Val)
    Dim Url
    Url = URLBase + endpoint & "?session_active=" & bActive
debug.print "Url:" & Url  & "  Async=" & bRunAsynch
    objXmlHttpMain.open "GET", Url, bRunAsynch
'   objXmlHttpMain.setRequestHeader "Content-Type", "text/xml"
    objXmlHttpMain.setRequestHeader "Cache-Control", "no-cache"
    if Hdr1<> "" then objXmlHttpMain.setRequestHeader Hdr1, Hdr1Val

'   on error resume next
      err.clear
      objXmlHttpMain.send ""
      if err.number=-2147012867 then
        MsgBox "Multiplayer Server is down (" & err.number & ") " & Err.Description
        bEnabled=False
      elseif err.number <> 0 then
        debug.print "Server error: (" & err.number & ") " & Err.Description
      End if
      if bRunAsynch=False then
debug.print "Status: " & objXmlHttpMain.status
        If objXmlHttpMain.status = 200 Then
          GetMsgHdr = objXmlHttpMain.responseText
        Else
          GetMsgHdr=""
        End if
      Else
        bWaitResp=True
        GetMsgHdr=""
      End if
'   On error goto 0

  End Function

  Private Function PostMsg(URLBase, endpoint, PostData, bAsynch)
    Dim Url

    Url = URLBase + endpoint
debug.print "PostMSg:" & Url & " " & PostData

    objXmlHttpMain.open "POST",Url, bAsynch
    objXmlHttpMain.setRequestHeader "Content-Type", "application/x-www-form-urlencoded"
    objXmlHttpMain.setRequestHeader "Content-Length", Len(PostData)
    objXmlHttpMain.setRequestHeader "Cache-Control", "no-cache"
    objXmlHttpMain.setRequestHeader "Authorization", "SToken " & sToken
    if bAsynch then bWaitResp=True

    on error resume next
      objXmlHttpMain.send PostData
      if err.number=-2147012867 then
        MsgBox "Multiplayer Server is down (" & err.number & ") " & Err.Description
        bEnabled=False
      elseif err.number <> 0 then
        'debug.print "Multiplayer Server error (" & err.number & ") " & Err.Description
      End if
      If objXmlHttpMain.status = 200 Then
        PostMsg = objXmlHttpMain.responseText
      else
        PostMsg="ERROR: " & objXmlHttpMain.status & " >" & objXmlHttpMain.responseText & "<"
      End if
    On error goto 0
  End Function

  Private Function pvPostFile(sUrl, sFileName, bAsync)
debug.print "Posting File " & sUrl & " " & sFileName & " " & bAsync & " File:" & Mid(sFileName, InStrRev(sFileName, "\") + 1)
    Dim STR_BOUNDARY:STR_BOUNDARY  = GUID()
    Dim nFile
    Dim baBuffer()
    Dim sPostData
    Dim Response

    '--- read file
    Set nFile = fso.GetFile(sFileName)
    With nFile.OpenAsTextStream()
      sPostData = .Read(nFile.Size)
      .Close
    End With
'   fso.Open sFileName For Binary Access Read As nFile
'   If LOF(nFile) > 0 Then
'     ReDim baBuffer(0 To LOF(nFile) - 1) As Byte
'     Get nFile, , baBuffer
'     sPostData = StrConv(baBuffer, vbUnicode)
'   End If
'   Close nFile

    '--- prepare body
    sPostData = "--" & STR_BOUNDARY & vbCrLf & _
      "Content-Disposition: form-data; name=""uuid""" & vbCrLf & vbCrLf & _
      SessionUUID & vbcrlf & _
      "--" & STR_BOUNDARY & vbCrLf & _
      "Content-Disposition: form-data; name=""log_file""; filename=""" & SessionUUID & ".csv""" & vbCrLf & _
      "Content-Type: application/octet-stream" & vbCrLf & vbCrLf & _
      sPostData & vbCrLf & _
      "--" & STR_BOUNDARY & "--"

'Debug.print "POSTDATA: " & sPostData & vbcrlf

    '--- post
    With objXmlHttpMain
      .Open "POST", sUrl, bAsync
      .SetRequestHeader "Content-Type", "multipart/form-data; boundary=" & STR_BOUNDARY
      .SetRequestHeader "Authorization", "SToken " & sToken
      .Send sPostData ' pvToByteArray(sPostData)
      If Not bAsync Then
        Response= .ResponseText
        pvPostFile = Response
debug.print "Upload Response: " & Response
      End If
    End With

  End Function

  Private Function pvToByteArray(sText)
    pvToByteArray = StrConv(sText, 128)   ' vbFromUnicode
  End Function

End Class
'  END SCORBIT
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX


'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
'      OSB Orbital Score Board  http://www.orbitalscoreboard.com
'XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX

  '****************************
  ' POST SCORES
  '****************************
  Dim osbtemp:osbtemp = osbdefinit
  Dim osbtempscore:osbtempscore = 0
  Sub SubmitOSBScore
    On Error Resume Next
    if osbactive = 1 or osbactive = 2 Then
    Dim objXmlHttpMain, Url, strJSONToSend

    Url = "https://hook.integromat.com/82bu988v9grj31vxjklh2e4s6h97rnu0"

    strJSONToSend = "{""auth"":""" & osbkey &""",""player id"": """ & osbid & """,""player initials"": """ & osbtemp &""",""score"": " & CStr(osbtempscore) & ",""table"":"""& TableName & """,""version"":""" & myVersion & """}"

    Set objXmlHttpMain = CreateObject("Msxml2.ServerXMLHTTP")
    objXmlHttpMain.open "PUT",Url, False
    objXmlHttpMain.setRequestHeader "Content-Type", "application/json"
    objXmlHttpMain.setRequestHeader "application", "application/json"

    objXmlHttpMain.send strJSONToSend
    end if
  End Sub

  '****************************
  ' GET SCORES
  '****************************
  dim worldscores

  Sub GetScores()
    if osbkey="" then exit sub
    On Error Resume Next
    Dim objXmlHttpMain, Url, strJSONToSend

    Url = "https://hook.integromat.com/kj765ojs42ac3w4915elqj5b870jrm5c"

    strJSONToSend = "{""auth"":"""& osbkey &""", ""table"":""" & TableName & """}"  ' TableName

    Set objXmlHttpMain = CreateObject("Msxml2.ServerXMLHTTP")
    objXmlHttpMain.open "PUT",Url, False
    objXmlHttpMain.setRequestHeader "Content-Type", "application/json"
    objXmlHttpMain.setRequestHeader "application", "application/json"

    objXmlHttpMain.send strJSONToSend

    worldscores = objXmlHttpMain.responseText
    vpmtimer.addtimer 3000, "showsuccess '"
    splitscores
  End Sub

  Dim scorevar(23)
  Dim dailyvar(23)
  Dim weeklyvar(23)
  Dim alltimevar(43)

  EmptyScores:GetScores
  sub emptyscores
    dim i
    For i = 0 to 42
      alltimevar(i) = "0"
    Next
    For i = 0 to 22
      weeklyvar(i) = "0"
      dailyvar(i) = "0"
    Next
  End Sub

  Sub splitscores
    On Error Resume Next
    dim a,scoreset,subset,subit,myNum,daily,weekly,alltime,x
    a = Split(worldscores,": {")
    subset = Split(a(1),"[")

'   debug.print subset(1)
'   debug.print subset(2)
'   debug.print subset(3)
' daily scores
    myNum = 0
    daily = Split(subset(1),": ")
    for each x in daily
      myNum = MyNum + 1
      x = Replace(x, vbCr, "")
      x = Replace(x, vbLf, "")
      x = Replace(x, ",", "")
      x = Replace(x, """", "")
      x = Replace(x, "{", "")
      x = Replace(x, "}", "")
      x = Replace(x, "score", "")
      x = Replace(x, "initials", "")
      x = Replace(x, "weekly", "")
      x = Replace(x, "]", "")
      x = Replace(x, "alltime", "")
      dailyvar(MyNum) = x
      if dailyvar(MyNum) = "" Then
        if MyNum = 2 or 4 or 6 or 8 or 10 or 12 or 14 or 16 or 18 or 20 Then
          dailyvar(MyNum) = "OBS"
        Else
          dailyvar(MyNum) = 0
        end if
      end if
      D "dailyvar(" &MyNum & ")=" & x
    Next

' weekly scores
    myNum = 0
    weekly = Split(subset(2),": ")
    for each x in weekly
      myNum = MyNum + 1
      x = Replace(x, vbCr, "")
      x = Replace(x, vbLf, "")
      x = Replace(x, ",", "")
      x = Replace(x, """", "")
      x = Replace(x, "{", "")
      x = Replace(x, "}", "")
      x = Replace(x, "score", "")
      x = Replace(x, "initials", "")
      x = Replace(x, "weekly", "")
      x = Replace(x, "]", "")
      x = Replace(x, "alltime", "")
      weeklyvar(MyNum) = x
      if weeklyvar(MyNum) = "" Then
        if MyNum = 2 or 4 or 6 or 8 or 10 or 12 or 14 or 16 or 18 or 20 Then
          weeklyvar(MyNum) = "OBS"
        Else
          weeklyvar(MyNum) = 0
        end if
      end if
      D "weeklyvar(" &MyNum & ")=" & x
    Next
' alltime scores
    myNum = 0
    alltime = Split(subset(3),": ")
    for each x in alltime
      myNum = MyNum + 1
      x = Replace(x, vbCr, "")
      x = Replace(x, vbLf, "")
      x = Replace(x, ",", "")
      x = Replace(x, """", "")
      x = Replace(x, "{", "")
      x = Replace(x, "}", "")
      x = Replace(x, "score", "")
      x = Replace(x, "initials", "")
      x = Replace(x, "weekly", "")
      x = Replace(x, "]", "")
      x = Replace(x, "alltime", "")
      alltimevar(MyNum) = x
      if alltimevar(MyNum) = "" Then
        if MyNum = 2 or 4 or 6 or 8 or 10 or 12 or 14 or 16 or 18 or 20 or 22 or 24 or 26 or 28 or 30 or 32 or 34 or 36 or 38 or 40 Then
          alltimevar(MyNum) = "OBS"
        Else
          alltimevar(MyNum) = "0"
        end if
      end if
      D "alltimevar(" &MyNum & ")=" & x
    Next
  end Sub

  sub showsuccess
  D "Scoreboard Updated"
  ' 'pupDMDDisplay "-","Scoreboard^Updated",dmdnote,3,0,10
  end sub

' XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
' nFozzy Physics
' XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
dim LF : Set LF = New FlipperPolarity
dim RF : Set RF = New FlipperPolarity

InitPolarity

Sub InitPolarity()
  dim x, a : a = Array(LF, RF)
  for each x in a
    'safety coefficient (diminishes polarity correction only)
    x.AddPoint "Ycoef", 0, RightFlipper.Y-65, 1 'disabled
    x.AddPoint "Ycoef", 1, RightFlipper.Y-11, 1

    x.enabled = True
    x.TimeDelay = 44
  Next

  'rf.report "Velocity"
  addpt "Velocity", 0, 0,   1
  addpt "Velocity", 1, 0.2,   1.07
  addpt "Velocity", 2, 0.41, 1.05
  addpt "Velocity", 3, 0.44, 1
  addpt "Velocity", 4, 0.65,  1.0'0.982
  addpt "Velocity", 5, 0.702, 0.968
  addpt "Velocity", 6, 0.95,  0.968
  addpt "Velocity", 7, 1.03,  0.945

  'rf.report "Polarity"
  AddPt "Polarity", 0, 0, -4.7
  AddPt "Polarity", 1, 0.16, -4.7
  AddPt "Polarity", 2, 0.33, -4.7
  AddPt "Polarity", 3, 0.37, -4.7
  AddPt "Polarity", 4, 0.41, -4.7
  AddPt "Polarity", 5, 0.45, -4.7
  AddPt "Polarity", 6, 0.576,-4.7
  AddPt "Polarity", 7, 0.66, -2.8
  AddPt "Polarity", 8, 0.743, -1.5
  AddPt "Polarity", 9, 0.81, -1.5
  AddPt "Polarity", 10, 0.88, 0

  LF.Object = LeftFlipper
  LF.EndPoint = EndPointLp  'you can use just a coordinate, or an object with a .x property. Using a couple of simple primitive objects
  RF.Object = RightFlipper
  RF.EndPoint = EndPointRp
End Sub

Sub TriggerLF_Hit() : LF.Addball activeball : End Sub
Sub TriggerLF_UnHit() : LF.PolarityCorrect activeball : End Sub
Sub TriggerRF_Hit() : RF.Addball activeball : End Sub
Sub TriggerRF_UnHit() : RF.PolarityCorrect activeball : End Sub

'******************************************************
'   FLIPPER CORRECTION SUPPORTING FUNCTIONS
'******************************************************

Sub AddPt(aStr, idx, aX, aY)  'debugger wrapper for adjusting flipper script in-game
  dim a : a = Array(LF, RF)
  dim x : for each x in a
    x.addpoint aStr, idx, aX, aY
  Next
End Sub

'Methods:
'.TimeDelay - Delay before trigger shuts off automatically. Default = 80 (ms)
'.AddPoint - "Polarity", "Velocity", "Ycoef" coordinate points. Use one of these 3 strings, keep coordinates sequential. x = %position on the flipper, y = output
'.Object - set to flipper reference. Optional.
'.StartPoint - set start point coord. Unnecessary, if .object is used.

'Called with flipper -
'ProcessBalls - catches ball data.
' - OR -
'.Fire - fires flipper.rotatetoend automatically + processballs. Requires .Object to be set to the flipper.

Class FlipperPolarity
  Public DebugOn, Enabled
  Private FlipAt  'Timer variable (IE 'flip at 723,530ms...)
  Public TimeDelay  'delay before trigger turns off and polarity is disabled TODO set time!
  private Flipper, FlipperStart, FlipperEnd, LR, PartialFlipCoef
  Private Balls(20), balldata(20)

  dim PolarityIn, PolarityOut
  dim VelocityIn, VelocityOut
  dim YcoefIn, YcoefOut
  Public Sub Class_Initialize
    redim PolarityIn(0) : redim PolarityOut(0) : redim VelocityIn(0) : redim VelocityOut(0) : redim YcoefIn(0) : redim YcoefOut(0)
    Enabled = True : TimeDelay = 50 : LR = 1:  dim x : for x = 0 to uBound(balls) : balls(x) = Empty : set Balldata(x) = new SpoofBall : next
  End Sub

  Public Property let Object(aInput) : Set Flipper = aInput : StartPoint = Flipper.x : End Property
  Public Property Let StartPoint(aInput) : if IsObject(aInput) then FlipperStart = aInput.x else FlipperStart = aInput : end if : End Property
  Public Property Get StartPoint : StartPoint = FlipperStart : End Property
  Public Property Let EndPoint(aInput) : if IsObject(aInput) then FlipperEnd = aInput.x else FlipperEnd = aInput : end if : End Property
  Public Property Get EndPoint : EndPoint = FlipperEnd : End Property

  Public Sub AddPoint(aChooseArray, aIDX, aX, aY) 'Index #, X position, (in) y Position (out)
    Select Case aChooseArray
      case "Polarity" : ShuffleArrays PolarityIn, PolarityOut, 1 : PolarityIn(aIDX) = aX : PolarityOut(aIDX) = aY : ShuffleArrays PolarityIn, PolarityOut, 0
      Case "Velocity" : ShuffleArrays VelocityIn, VelocityOut, 1 :VelocityIn(aIDX) = aX : VelocityOut(aIDX) = aY : ShuffleArrays VelocityIn, VelocityOut, 0
      Case "Ycoef" : ShuffleArrays YcoefIn, YcoefOut, 1 :YcoefIn(aIDX) = aX : YcoefOut(aIDX) = aY : ShuffleArrays YcoefIn, YcoefOut, 0
    End Select
    if gametime > 100 then Report aChooseArray
  End Sub

  Public Sub Report(aChooseArray)   'debug, reports all coords in tbPL.text
    if not DebugOn then exit sub
    dim a1, a2 : Select Case aChooseArray
      case "Polarity" : a1 = PolarityIn : a2 = PolarityOut
      Case "Velocity" : a1 = VelocityIn : a2 = VelocityOut
      Case "Ycoef" : a1 = YcoefIn : a2 = YcoefOut
      case else :tbpl.text = "wrong string" : exit sub
    End Select
    dim str, x : for x = 0 to uBound(a1) : str = str & aChooseArray & " x: " & round(a1(x),4) & ", " & round(a2(x),4) & vbnewline : next
    tbpl.text = str
  End Sub

  Public Sub AddBall(aBall) : dim x : for x = 0 to uBound(balls) : if IsEmpty(balls(x)) then set balls(x) = aBall : exit sub :end if : Next  : End Sub

  Private Sub RemoveBall(aBall)
    dim x : for x = 0 to uBound(balls)
      if TypeName(balls(x) ) = "IBall" then
        if aBall.ID = Balls(x).ID Then
          balls(x) = Empty
          Balldata(x).Reset
        End If
      End If
    Next
  End Sub

  Public Sub Fire()
    Flipper.RotateToEnd
    processballs
  End Sub

  Public Property Get Pos 'returns % position a ball. For debug stuff.
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        pos = pSlope(Balls(x).x, FlipperStart, 0, FlipperEnd, 1)
      End If
    Next
  End Property

  Public Sub ProcessBalls() 'save data of balls in flipper range
    FlipAt = GameTime
    dim x : for x = 0 to uBound(balls)
      if not IsEmpty(balls(x) ) then
        balldata(x).Data = balls(x)
        if DebugOn then StickL.visible = True : StickL.x = balldata(x).x    'debug TODO
      End If
    Next
    PartialFlipCoef = ((Flipper.StartAngle - Flipper.CurrentAngle) / (Flipper.StartAngle - Flipper.EndAngle))
    PartialFlipCoef = abs(PartialFlipCoef-1)
    if abs(Flipper.currentAngle - Flipper.EndAngle) < 30 Then
      PartialFlipCoef = 0
    End If
  End Sub
  Private Function FlipperOn() : if gameTime < FlipAt+TimeDelay then FlipperOn = True : End If : End Function 'Timer shutoff for polaritycorrect

  Public Sub PolarityCorrect(aBall)
    if FlipperOn() then
      dim tmp, BallPos, x, IDX, Ycoef : Ycoef = 1
      dim teststr : teststr = "Cutoff"
      tmp = PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1)
      if tmp < 0.1 then 'if real ball position is behind flipper, exit Sub to prevent stucks  'Disabled 1.03, I think it's the Mesh that's causing stucks, not this
        if DebugOn then TestStr = "real pos < 0.1 ( " & round(tmp,2) & ")" : tbpl.text = Teststr
        'RemoveBall aBall
        'Exit Sub
      end if

      'y safety Exit
      if aBall.VelY > -8 then 'ball going down
        if DebugOn then teststr = "y velocity: " & round(aBall.vely, 3) & "exit sub" : tbpl.text = teststr
        RemoveBall aBall
        exit Sub
      end if
      'Find balldata. BallPos = % on Flipper
      for x = 0 to uBound(Balls)
        if aBall.id = BallData(x).id AND not isempty(BallData(x).id) then
          idx = x
          BallPos = PSlope(BallData(x).x, FlipperStart, 0, FlipperEnd, 1)
          'TB.TEXT = balldata(x).id & " " & BALLDATA(X).X & VBNEWLINE & FLIPPERSTART & " " & FLIPPEREND
          if ballpos > 0.65 then  Ycoef = LinearEnvelope(BallData(x).Y, YcoefIn, YcoefOut)        'find safety coefficient 'ycoef' data
        end if
      Next

      'Velocity correction
      if not IsEmpty(VelocityIn(0) ) then
        Dim VelCoef
        if DebugOn then set tmp = new spoofball : tmp.data = aBall : End If
        if IsEmpty(BallData(idx).id) and aBall.VelY < -12 then 'if tip hit with no collected data, do vel correction anyway
          if PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1) > 1.1 then 'adjust plz
            VelCoef = LinearEnvelope(5, VelocityIn, VelocityOut)
            if partialflipcoef < 1 then VelCoef = PSlope(partialflipcoef, 0, 1, 1, VelCoef)
            if Enabled then aBall.Velx = aBall.Velx*VelCoef'VelCoef
            if Enabled then aBall.Vely = aBall.Vely*VelCoef'VelCoef
            if DebugOn then teststr = "tip protection" & vbnewline & "velcoef: " & round(velcoef,3) & vbnewline & round(PSlope(aBall.x, FlipperStart, 0, FlipperEnd, 1),3) & vbnewline
            'debug.print teststr
          end if
        Else
     :      VelCoef = LinearEnvelope(BallPos, VelocityIn, VelocityOut)
          if Enabled then aBall.Velx = aBall.Velx*VelCoef
          if Enabled then aBall.Vely = aBall.Vely*VelCoef
        end if
      End If

      'Polarity Correction (optional now)
      if not IsEmpty(PolarityIn(0) ) then
        If StartPoint > EndPoint then LR = -1 'Reverse polarity if left flipper
        dim AddX : AddX = LinearEnvelope(BallPos, PolarityIn, PolarityOut) * LR
        if Enabled then aBall.VelX = aBall.VelX + 1 * (AddX*ycoef*PartialFlipcoef)
      End If
      'debug
      if DebugOn then
        TestStr = teststr & "%pos:" & round(BallPos,2)
        if IsEmpty(PolarityOut(0) ) then
          teststr = teststr & vbnewline & "(Polarity Disabled)" & vbnewline
        else
          teststr = teststr & "+" & round(1 *(AddX*ycoef*PartialFlipcoef),3)
          if BallPos >= PolarityOut(uBound(PolarityOut) ) then teststr = teststr & "(MAX)" & vbnewline else teststr = teststr & vbnewline end if
          if Ycoef < 1 then teststr = teststr &  "ycoef: " & ycoef & vbnewline
          if PartialFlipcoef < 1 then teststr = teststr & "PartialFlipcoef: " & round(PartialFlipcoef,4) & vbnewline
        end if

        teststr = teststr & vbnewline & "Vel: " & round(BallSpeed(tmp),2) & " -> " & round(ballspeed(aBall),2) & vbnewline
        teststr = teststr & "%" & round(ballspeed(aBall) / BallSpeed(tmp),2)
        tbpl.text = TestSTR
      end if
    Else
      'if DebugOn then tbpl.text = "td" & timedelay
    End If
    RemoveBall aBall
  End Sub
End Class

'================================
'Helper Functions


Sub ShuffleArray(ByRef aArray, byVal offset) 'shuffle 1d array
  dim x, aCount : aCount = 0
  redim a(uBound(aArray) )
  for x = 0 to uBound(aArray) 'Shuffle objects in a temp array
    if not IsEmpty(aArray(x) ) Then
      if IsObject(aArray(x)) then
        Set a(aCount) = aArray(x)
      Else
        a(aCount) = aArray(x)
      End If
      aCount = aCount + 1
    End If
  Next
  if offset < 0 then offset = 0
  redim aArray(aCount-1+offset) 'Resize original array
  for x = 0 to aCount-1   'set objects back into original array
    if IsObject(a(x)) then
      Set aArray(x) = a(x)
    Else
      aArray(x) = a(x)
    End If
  Next
End Sub

Sub ShuffleArrays(aArray1, aArray2, offset)
  ShuffleArray aArray1, offset
  ShuffleArray aArray2, offset
End Sub


Function BallSpeed(ball) 'Calculates the ball speed
    BallSpeed = SQR(ball.VelX^2 + ball.VelY^2 + ball.VelZ^2)
End Function

Function PSlope(Input, X1, Y1, X2, Y2)  'Set up line via two points, no clamping. Input X, output Y
  dim x, y, b, m : x = input : m = (Y2 - Y1) / (X2 - X1) : b = Y2 - m*X2
  Y = M*x+b
  PSlope = Y
End Function

Function NullFunctionZ(aEnabled):End Function '1 argument null function placeholder  TODO move me or replac eme

Class spoofball
  Public X, Y, Z, VelX, VelY, VelZ, ID, Mass, Radius
  Public Property Let Data(aBall)
    With aBall
      x = .x : y = .y : z = .z : velx = .velx : vely = .vely : velz = .velz
      id = .ID : mass = .mass : radius = .radius
    end with
  End Property
  Public Sub Reset()
    x = Empty : y = Empty : z = Empty  : velx = Empty : vely = Empty : velz = Empty
    id = Empty : mass = Empty : radius = Empty
  End Sub
End Class


Function LinearEnvelope(xInput, xKeyFrame, yLvl)
  dim y 'Y output
  dim L 'Line
  dim ii : for ii = 1 to uBound(xKeyFrame)  'find active line
    if xInput <= xKeyFrame(ii) then L = ii : exit for : end if
  Next
  if xInput > xKeyFrame(uBound(xKeyFrame) ) then L = uBound(xKeyFrame)  'catch line overrun
  Y = pSlope(xInput, xKeyFrame(L-1), yLvl(L-1), xKeyFrame(L), yLvl(L) )

  'Clamp if on the boundry lines
  'if L=1 and Y < yLvl(LBound(yLvl) ) then Y = yLvl(lBound(yLvl) )
  'if L=uBound(xKeyFrame) and Y > yLvl(uBound(yLvl) ) then Y = yLvl(uBound(yLvl) )
  'clamp 2.0
  if xInput <= xKeyFrame(lBound(xKeyFrame) ) then Y = yLvl(lBound(xKeyFrame) )  'Clamp lower
  if xInput >= xKeyFrame(uBound(xKeyFrame) ) then Y = yLvl(uBound(xKeyFrame) )  'Clamp upper

  LinearEnvelope = Y
End Function
